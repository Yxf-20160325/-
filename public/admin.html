<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; media-src 'self' blob:; connect-src 'self' ws: wss:; font-src 'self' data:;">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>èŠå¤©å®¤ç®¡ç†åå°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .login-container {
            padding: 40px;
            text-align: center;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            width: 100%;
        }

        .login-form input {
            width: 100%;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
            outline: none;
            transition: border-color 0.3s;
        }

        .login-form input:focus {
            border-color: #667eea;
        }

        .login-form button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .admin-panel {
            display: none;
            padding: 20px;
            flex: 1;
            flex-direction: column;
        }
        
        .admin-panel.active {
            display: flex;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-list {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            background: white;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .user-name {
            font-weight: 500;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-kick {
            background: #dc3545;
            color: white;
        }

        .btn-permissions {
            background: #28a745;
            color: white;
        }

        .btn-kick:hover {
            background: #c82333;
        }

        .btn-rename {
            background: #ffc107;
            color: #333;
        }

        .btn-rename:hover {
            background: #e0a800;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }

        .input-group input:focus {
            border-color: #667eea;
        }

        .input-group button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
            flex-shrink: 0;
        }

        #permissionsForm {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            margin-bottom: 20px;
        }

        #permissionsForm::-webkit-scrollbar {
            width: 8px;
        }

        #permissionsForm::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #permissionsForm::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        #permissionsForm::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-shrink: 0;
            margin-top: auto;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 20px;
            outline: none;
        }

        .modal-content input:focus {
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .btn-confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .permission-item {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            background: #f8f9fa;
        }

        .permission-item > label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-weight: normal;
            width: 100%;
        }

        .permission-item input[type="checkbox"] {
            display: none;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 20px;
            outline: none;
            resize: vertical;
            min-height: 80px;
        }

        .input-group textarea:focus {
            border-color: #667eea;
        }

        .input-group input[type="color"] {
            width: 100%;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .file-list {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            background: white;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .file-icon {
            font-size: 24px;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            margin-bottom: 5px;
            word-break: break-all;
        }

        .file-meta {
            font-size: 12px;
            color: #666;
        }

        .file-actions {
            display: flex;
            gap: 8px;
        }

        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e9ecef;
        }

        .files-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            background: white;
        }

        .files-container::-webkit-scrollbar {
            width: 8px;
        }

        .files-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .files-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .files-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .requests-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            background: white;
            margin-top: 15px;
        }

        .requests-container::-webkit-scrollbar {
            width: 8px;
        }

        .requests-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .requests-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .requests-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .request-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            background: white;
        }

        .request-item:last-child {
            border-bottom: none;
        }

        .request-info {
            flex: 1;
        }

        .request-info h4 {
            margin: 0 0 8px 0;
            color: #333;
        }

        .request-reason {
            margin: 0 0 10px 0;
            color: #666;
        }

        .request-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #999;
        }

        .request-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .status-pending {
            color: #ffc107;
            font-weight: bold;
        }

        .status-approved {
            color: #28a745;
            font-weight: bold;
        }

        .status-rejected {
            color: #dc3545;
            font-weight: bold;
        }

        .path-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .current-path {
            flex: 1;
            font-family: 'Courier New', monospace;
            color: #666;
            font-size: 14px;
            word-break: break-all;
        }

        .upload-area input {
            display: none;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #666;
        }

        .messages-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .message-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .message-item.deleted {
            border-left-color: #dc3545;
            opacity: 0.7;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .message-sender {
            font-weight: bold;
            color: #333;
        }

        .message-time {
            font-size: 12px;
            color: #999;
        }

        .message-content {
            color: #666;
            word-break: break-word;
        }

        .message-content img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .message-content audio {
            width: 100%;
            max-width: 300px;
            margin-top: 10px;
        }

        .message-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }

        .message-status.active {
            background: #d4edda;
            color: #155724;
        }

        .message-status.deleted {
            background: #f8d7da;
            color: #721c24;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .tab-content.active {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 0;
                max-height: 100vh;
            }

            .file-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .file-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
        
        /* æ·±è‰²æ¨¡å¼æ ·å¼ */
        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        }
        
        body.dark-mode .container {
            background: #1a1a2e;
            color: #e0e0e0;
        }
        
        body.dark-mode .header {
            background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
        }
        
        body.dark-mode .login-form input {
            background: #16213e;
            border-color: #0f3460;
            color: #e0e0e0;
        }
        
        body.dark-mode .login-form input:focus {
            border-color: #667eea;
        }
        
        body.dark-mode .stat-card {
            background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
        }
        
        body.dark-mode .user-list {
            background: #16213e;
        }
        
        body.dark-mode .user-item {
            background: #1a1a2e;
            border-bottom-color: #0f3460;
        }
        
        body.dark-mode .section h2 {
            color: #e0e0e0;
        }
        
        body.dark-mode .message-item {
            background: #16213e;
            border-left-color: #667eea;
        }
        
        body.dark-mode .message-item.deleted {
            border-left-color: #dc3545;
        }
        
        body.dark-mode .message-sender {
            color: #e0e0e0;
        }
        
        body.dark-mode .message-content {
            color: #b0b0b0;
        }
        
        body.dark-mode .empty-state {
            color: #b0b0b0;
        }
        
        body.dark-mode .modal-content {
            background: #1a1a2e;
            color: #e0e0e0;
        }
        
        body.dark-mode .modal-content h3 {
            color: #e0e0e0;
        }
        
        body.dark-mode #permissionsForm {
            background: #16213e;
        }
        
        body.dark-mode .permission-item {
            background: #1a1a2e;
            border-color: #0f3460;
        }
        
        body.dark-mode .input-group label {
            color: #e0e0e0;
        }
        
        body.dark-mode .input-group input {
            background: #16213e;
            border-color: #0f3460;
            color: #e0e0e0;
        }
        
        body.dark-mode .input-group input:focus {
            border-color: #667eea;
        }
        
        body.dark-mode .input-group textarea {
            background: #16213e;
            border-color: #0f3460;
            color: #e0e0e0;
        }
        
        body.dark-mode .input-group textarea:focus {
            border-color: #667eea;
        }
        
        body.dark-mode .files-container {
            background: #1a1a2e;
            border-color: #0f3460;
        }
        
        body.dark-mode .file-item {
            background: #16213e;
            border-bottom-color: #0f3460;
        }
        
        body.dark-mode .file-details {
            color: #e0e0e0;
        }
        
        body.dark-mode .file-meta {
            color: #b0b0b0;
        }
        
        body.dark-mode .upload-area {
            border-color: #0f3460;
            background: #16213e;
        }
        
        body.dark-mode .upload-area:hover {
            border-color: #667eea;
            background: #1a1a2e;
        }
        
        body.dark-mode .requests-container {
            background: #1a1a2e;
            border-color: #0f3460;
        }
        
        body.dark-mode .request-item {
            background: #16213e;
            border-bottom-color: #0f3460;
        }
        
        body.dark-mode .request-info h4 {
            color: #e0e0e0;
        }
        
        body.dark-mode .request-reason {
            color: #b0b0b0;
        }
        
        body.dark-mode .request-meta {
            color: #909090;
        }
        
        body.dark-mode .path-bar {
            background: #16213e;
            border-color: #0f3460;
        }
        
        body.dark-mode .current-path {
            color: #b0b0b0;
        }
        
        body.dark-mode .messages-container {
            background: #16213e;
        }
        
        body.dark-mode .tab {
            background: #16213e;
            color: #b0b0b0;
        }
        
        body.dark-mode .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        body.dark-mode .tab-content {
            background: #1a1a2e;
        }
        
        body.dark-mode .call-method-info {
            background: #16213e;
            border-left-color: #0f3460;
        }
        
        body.dark-mode .call-method-info h3 {
            color: #667eea;
        }
        
        body.dark-mode #serverInfo {
            background: #16213e;
            color: #e0e0e0;
        }
        
        body.dark-mode #commandOutput {
            background: #121212;
            color: #00ff00;
        }
        
        body.dark-mode .reply-info {
            background: #16213e;
            color: #b0b0b0;
        }
        
        /* æ·±è‰²æ¨¡å¼åˆ‡æ¢æŒ‰é’® */
        .dark-mode-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .dark-mode-toggle:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>èŠå¤©å®¤ç®¡ç†åå°</h1>
            <div class="subtitle">ç®¡ç†å‘˜æ§åˆ¶é¢æ¿</div>
        </div>

        <div class="login-container" id="loginContainer">
            <div class="login-form">
                <form id="loginForm">
                    <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
                    <button type="submit">ç™»å½•</button>
                </form>
            </div>
        </div>

        <div class="admin-panel" id="adminPanel">
            <div class="stats">
                <div class="stat-card">
                    <h3>åœ¨çº¿ç”¨æˆ·</h3>
                    <div class="value" id="userCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>æ¶ˆæ¯æ€»æ•°</h3>
                    <div class="value" id="messageCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>å·²æ’¤å›æ¶ˆæ¯</h3>
                    <div class="value" id="deletedMessageCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>ä¸Šä¼ æ–‡ä»¶</h3>
                    <div class="value" id="fileCount">0</div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('users')">ç”¨æˆ·ç®¡ç†</button>
                <button class="tab" onclick="switchTab('files')">æ–‡ä»¶ç®¡ç†</button>
                <button class="tab" onclick="switchTab('messages')">æ¶ˆæ¯ç®¡ç†</button>
                <button class="tab" onclick="switchTab('rooms')">æˆ¿é—´ç®¡ç†</button>
                <button class="tab" onclick="switchTab('roomDetails')">æˆ¿é—´è¯¦ç»†</button>
                <button class="tab" onclick="switchTab('friends')">å¥½å‹ç®¡ç†</button>
                <button class="tab" onclick="switchTab('requests')">ç”³è¯·ç®¡ç†</button>
                <button class="tab" onclick="switchTab('mutedUsers')">ç¦è¨€ç®¡ç†</button>
                <button class="tab" onclick="switchTab('polls')">æŠ•ç¥¨ç®¡ç†</button>
                <button class="tab" onclick="switchTab('calls')">é€šè¯ç®¡ç†</button>
                <button class="tab" onclick="switchTab('settingsManagement')">ç”¨æˆ·è®¾ç½®ç®¡ç†</button>
                <button class="tab" onclick="switchTab('analytics')">è¡Œä¸ºåˆ†æ</button>
                <button class="tab" onclick="switchTab('logs')">ç³»ç»Ÿæ—¥å¿—</button>
                <button class="tab" onclick="switchTab('monitoring')">ç³»ç»Ÿç›‘æ§</button>
                <button class="tab" onclick="switchTab('updates')">å‘å¸ƒæ›´æ–°</button>
                <button class="tab" onclick="switchTab('chatroomNotifications')">èŠå¤©å®¤æç¤º</button>
                <button class="tab" onclick="switchTab('systemManagement')">ç³»ç»Ÿç®¡ç†</button>
                <button class="tab" onclick="switchTab('globalSettings')">å…¨ä½“è®¾ç½®</button>
                <button class="tab" onclick="switchTab('viruses')">ç—…æ¯’ç®¡ç†</button>
                <button class="tab" onclick="switchTab('console')">JavaScriptæ§åˆ¶å°</button>
            </div>

            <div class="tab-content active" id="usersTab">
                <div class="section">
                    <h2>åœ¨çº¿ç”¨æˆ·ç®¡ç†</h2>
                    <div class="input-group">
                        <button class="btn btn-primary" onclick="openUsersModal()">æ‰“å¼€ç”¨æˆ·åˆ—è¡¨</button>
                        <button class="btn btn-danger" onclick="batchKickUsers()">æ‰¹é‡è¸¢å‡º</button>
                        <button class="btn btn-warning" onclick="batchMuteUsers()">æ‰¹é‡ç¦è¨€</button>
                        <button class="btn btn-info" onclick="batchSetPermissions()">æ‰¹é‡è®¾ç½®æƒé™</button>
                        <button class="btn btn-secondary" onclick="selectAllUsers()">å…¨é€‰</button>
                        <button class="btn btn-secondary" onclick="deselectAllUsers()">å–æ¶ˆå…¨é€‰</button>
                    </div>
                </div>

                <div class="section">
                    <h2>ç³»ç»Ÿæ¶ˆæ¯</h2>
                    <div class="input-group">
                        <form onsubmit="event.preventDefault(); sendSystemMessage();">
                            <input type="text" id="systemMessage" placeholder="è¾“å…¥ç³»ç»Ÿæ¶ˆæ¯å†…å®¹">
                            <button type="submit" class="btn btn-primary">å‘é€</button>
                        </form>
                    </div>
                </div>
                <div class="section">
                    <h2>ä¿®æ”¹ç®¡ç†å‘˜å¯†ç </h2>
                    <form onsubmit="event.preventDefault(); changeAdminPassword();">
                        <div class="input-group">
                            <input type="password" id="oldPassword" placeholder="æ—§å¯†ç " required>
                        </div>
                        <div class="input-group">
                            <input type="password" id="newPassword" placeholder="æ–°å¯†ç " required>
                        </div>
                        <div class="input-group">
                            <button type="submit" class="btn btn-primary">ä¿®æ”¹å¯†ç </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="tab-content" id="filesTab">
                <div class="section">
                    <h2>æ–‡ä»¶ç®¡ç†</h2>
                    <div class="path-bar">
                        <button class="btn btn-secondary" onclick="goBack()" id="backButton" disabled>â† è¿”å›ä¸Šä¸€çº§</button>
                        <span class="current-path" id="currentPath">/</span>
                    </div>
                    <div class="input-group">
                        <button class="btn btn-primary" onclick="loadFiles()">åˆ·æ–°æ–‡ä»¶åˆ—è¡¨</button>
                        <button class="btn btn-success" onclick="openUploadModal()">ä¸Šä¼ æ–‡ä»¶</button>
                        <button class="btn btn-primary" onclick="openCreateFileModal()">åˆ›å»ºæ–‡ä»¶</button>
                        <button class="btn btn-primary" onclick="openCreateDirectoryModal()">åˆ›å»ºç›®å½•</button>
                    </div>
                    <div class="files-container" id="filesContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <div>æš‚æ— æ–‡ä»¶</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="messagesTab">
                <div class="section">
                    <h2>æ¶ˆæ¯ç®¡ç†</h2>
                    <button class="btn btn-danger" onclick="clearMessages()">æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯</button>
                </div>

                <div class="section">
                    <h2>ä¼ªè£…å‘é€æ¶ˆæ¯</h2>
                    <button class="btn btn-primary" onclick="openAdminMessageModal()">ä¼ªè£…å‘é€æ¶ˆæ¯</button>
                </div>

                <div class="section">
                    <h2>æ‰€æœ‰æ¶ˆæ¯</h2>
                    <div class="input-group">
                        <button class="btn btn-primary" onclick="loadMessages()">åˆ·æ–°æ¶ˆæ¯</button>
                        <select id="roomSelect" class="btn btn-primary" style="margin-left: 10px;">
                            <option value="">é€‰æ‹©æˆ¿é—´</option>
                        </select>
                    </div>
                    <div class="messages-container" id="messagesContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ’¬</div>
                            <div>æš‚æ— æ¶ˆæ¯</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="roomsTab">
                <div class="section">
                    <h2>åˆ›å»ºæ–°æˆ¿é—´</h2>
                    <form onsubmit="event.preventDefault(); createRoom();">
                        <div class="input-group">
                            <input type="text" id="roomName" placeholder="æˆ¿é—´å" required>
                            <input type="password" id="roomPassword" placeholder="æˆ¿é—´å¯†ç ï¼ˆå¯é€‰ï¼‰">
                        </div>
                        <div class="input-group">
                            <label>æœ€å¤§ç”¨æˆ·æ•°ï¼š</label>
                            <input type="number" id="roomMaxUsers" placeholder="é»˜è®¤100" min="1" max="1000" value="100">
                        </div>
                        <div class="input-group">
                            <button type="submit" class="btn btn-primary">åˆ›å»ºæˆ¿é—´</button>
                        </div>
                    </form>
                </div>
                
                <div class="section">
                    <h2>æˆ¿é—´åˆ—è¡¨</h2>
                    <div class="input-group" style="margin-bottom: 15px;">
                        <input type="text" id="roomSearch" placeholder="æœç´¢æˆ¿é—´å" oninput="filterRooms()">
                    </div>
                    <div class="user-list" id="roomList">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ </div>
                            <div>æš‚æ— æˆ¿é—´</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="roomDetailsTab">
                <div class="section">
                    <h2 id="roomDetailsTitle">æˆ¿é—´è¯¦ç»†ä¿¡æ¯</h2>
                    <div id="roomDetailsInfo" style="margin-bottom: 20px;">
                        <p>ç‚¹å‡»æˆ¿é—´åˆ—è¡¨ä¸­çš„"æŸ¥çœ‹ç”¨æˆ·"æŒ‰é’®æŸ¥çœ‹æˆ¿é—´è¯¦æƒ…</p>
                    </div>
                </div>
                
                <div class="section">
                    <h2>æˆ¿é—´ç”¨æˆ·ç®¡ç†</h2>
                    <div class="input-group" style="margin-bottom: 15px;">
                        <input type="text" id="roomUserSearch" placeholder="æœç´¢æˆ¿é—´å†…çš„ç”¨æˆ·å" oninput="filterRoomUsers()">
                    </div>
                    <div class="user-list" id="roomUserList">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ‘¥</div>
                            <div>è¯¥æˆ¿é—´æš‚æ— ç”¨æˆ·</div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>æˆ¿é—´æ¶ˆæ¯ç®¡ç†</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <h3>å‘é€ç³»ç»Ÿæ¶ˆæ¯</h3>
                        <div class="input-group">
                            <form onsubmit="event.preventDefault(); sendRoomSystemMessage();">
                                <input type="text" id="roomSystemMessage" placeholder="è¾“å…¥æˆ¿é—´ç³»ç»Ÿæ¶ˆæ¯å†…å®¹">
                                <button type="submit" class="btn btn-primary">å‘é€</button>
                            </form>
                        </div>
                    </div>
                    
                    <div>
                        <h3>ä¼ªè£…å‘é€æ¶ˆæ¯</h3>
                        <button class="btn btn-primary" onclick="openRoomAdminMessageModal()">ä¼ªè£…å‘é€æ¶ˆæ¯</button>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="friendsTab">
                <div class="section">
                    <h2>å¥½å‹ç®¡ç†</h2>
                    <div class="input-group" style="margin-bottom: 15px;">
                        <input type="text" id="friendSearch" placeholder="æœç´¢ç”¨æˆ·å..." oninput="filterFriends()">
                        <button class="btn btn-primary" onclick="openAddFriendModal()">æ·»åŠ å¥½å‹</button>
                    </div>
                    <div class="user-list" id="friendsTabList">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ‘¥</div>
                            <div>æš‚æ— ç”¨æˆ·</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="requestsTab">
                <div class="section">
                    <h2>å¥½å‹æ‰©å®¹ç”³è¯·</h2>
                    <button class="btn btn-primary" onclick="loadFriendLimitRequests()">åˆ·æ–°ç”³è¯·åˆ—è¡¨</button>
                    <div class="requests-container" id="friendLimitRequestsContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <div>æš‚æ— å¥½å‹æ‰©å®¹ç”³è¯·</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="globalSettingsTab">
                <div class="section">
                    <h2>å…¨ä½“æƒé™è®¾ç½®</h2>
                    <p style="margin-bottom: 15px; color: #666;">è®¾ç½®æ‰€æœ‰ç”¨æˆ·çš„é»˜è®¤æƒé™ï¼Œæ–°ç”¨æˆ·å°†ä½¿ç”¨è¿™äº›æƒé™</p>
                    <div id="globalPermissionsForm">
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸å‘é€è¯­éŸ³</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowAudio" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸å‘é€å›¾ç‰‡</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowImage" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸å‘é€æ–‡ä»¶</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowFile" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸å‘é€æ¶ˆæ¯</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowSendMessages" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸æŸ¥çœ‹æ¶ˆæ¯</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowViewMessages" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸é€šè¯</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowCall" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸æ·»åŠ å¥½å‹</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowAddFriends" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowViewUsers" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸ç§èŠ</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowPrivateChat" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸æ‰“å¼€å¥½å‹é¡µé¢</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowOpenFriendsPage" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸æ’¤å›æ¶ˆæ¯</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowRecallMessage" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                    </div>
            
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="applyGlobalPermissions()">åº”ç”¨åˆ°æ‰€æœ‰ç”¨æˆ·</button>
                <button class="btn btn-info" onclick="applyToNewUsers()">ä»…åº”ç”¨åˆ°æ–°ç”¨æˆ·</button>
            </div>
        </div>
    </div>
            <div class="tab-content" id="virusesTab">
                <div class="section">
                <h2>ç—…æ¯’ç®¡ç†</h2>
                <div class="input-group">
                    <button class="btn btn-primary" onclick="loadVirusList()">åˆ·æ–°ç—…æ¯’åˆ—è¡¨</button>
                    <button class="btn btn-danger" onclick="deleteAllViruses()">åˆ é™¤æ‰€æœ‰ç—…æ¯’æ–‡ä»¶</button>
                    <button class="btn btn-info" onclick="exportVirusList()">å¯¼å‡ºç—…æ¯’åˆ—è¡¨</button>
                    <div style="display: flex; align-items: center; margin-left: 20px;">
                        <label style="margin-right: 10px;">ç—…æ¯’æ£€æµ‹:</label>
                        <label class="switch">
                            <input type="checkbox" id="virusScanToggle" onchange="toggleVirusScan()">
                            <span class="slider"></span>
                        </label>
                        <span id="virusScanStatus" style="margin-left: 10px;">å¯ç”¨ä¸­</span>
                    </div>
                </div>
            </div>

                <div class="section">
                    <h2>ç—…æ¯’æ–‡ä»¶åˆ—è¡¨</h2>
                    <div class="files-container" id="virusList">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ¦ </div>
                            <div>æš‚æ— ç—…æ¯’æ–‡ä»¶</div>
                        </div>
                    </div>
                </div>
            </div>

        <div class="tab-content" id="analyticsTab">
            <div class="section">
                <h2>ç”¨æˆ·è¡Œä¸ºåˆ†æ</h2>
                <div class="input-group">
                    <button class="btn btn-primary" onclick="loadUserAnalytics()">åŠ è½½åˆ†ææ•°æ®</button>
                    <button class="btn btn-primary" onclick="exportAnalyticsData()">å¯¼å‡ºåˆ†ææ•°æ®</button>
                    <button class="btn btn-primary" onclick="refreshAnalytics()">åˆ·æ–°æ•°æ®</button>
                    <select id="analyticsTimeRange" class="btn btn-primary" style="margin-left: 10px;">
                        <option value="today">ä»Šæ—¥</option>
                        <option value="week">æœ¬å‘¨</option>
                        <option value="month">æœ¬æœˆ</option>
                        <option value="all">å…¨éƒ¨</option>
                    </select>
                </div>
            </div>

            <div class="section">
                <h2>ç”¨æˆ·æ´»è·ƒåº¦åˆ†æ</h2>
                <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <div id="userActivityChart" style="height: 300px;"></div>
                </div>
            </div>

            <div class="section">
                <h2>æ¶ˆæ¯ç±»å‹åˆ†å¸ƒ</h2>
                <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <div id="messageTypeChart" style="height: 300px;"></div>
                </div>
            </div>

            <div class="section">
                <h2>ç”¨æˆ·ç•™å­˜ç‡åˆ†æ</h2>
                <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <div id="userRetentionChart" style="height: 300px;"></div>
                </div>
            </div>

            <div class="section">
                <h2>æ¶ˆæ¯çƒ­åº¦åˆ†æ</h2>
                <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <div id="messageHeatChart" style="height: 300px;"></div>
                </div>
            </div>

            <div class="section">
                <h2>ç”¨æˆ·æ´»è·ƒæ—¶æ®µåˆ†æ</h2>
                <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <div id="userActiveHourChart" style="height: 300px;"></div>
                </div>
            </div>

            <div class="section">
                <h2>ç”¨æˆ·è¡Œä¸ºç»Ÿè®¡</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div class="stat-card">
                        <h3>æ´»è·ƒç”¨æˆ·æ•°</h3>
                        <div class="value" id="activeUserCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>æ¶ˆæ¯æ€»æ•°</h3>
                        <div class="value" id="totalMessageCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>å¹³å‡æ¶ˆæ¯é•¿åº¦</h3>
                        <div class="value" id="avgMessageLength">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>é«˜å³°æ—¶æ®µ</h3>
                        <div class="value" id="peakHour">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>ç•™å­˜ç‡</h3>
                        <div class="value" id="retentionRate">0%</div>
                    </div>
                    <div class="stat-card">
                        <h3>å¹³å‡åœ¨çº¿æ—¶é•¿</h3>
                        <div class="value" id="avgOnlineTime">0åˆ†é’Ÿ</div>
                    </div>
                    <div class="stat-card">
                        <h3>æ¶ˆæ¯å“åº”ç‡</h3>
                        <div class="value" id="responseRate">0%</div>
                    </div>
                    <div class="stat-card">
                        <h3>ç”¨æˆ·å¢é•¿ç‡</h3>
                        <div class="value" id="userGrowthRate">0%</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>ç”¨æˆ·è¡Œä¸ºè¯¦æƒ…</h2>
                <div class="user-list" id="userBehaviorList">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“Š</div>
                        <div>æš‚æ— è¡Œä¸ºæ•°æ®</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-content" id="pollsTab">
            <div class="section">
                <h2>æŠ•ç¥¨ç®¡ç†</h2>
                <div class="input-group">
                    <button class="btn btn-primary" onclick="loadPolls()">åˆ·æ–°æŠ•ç¥¨åˆ—è¡¨</button>
                    <button class="btn btn-success" onclick="openCreatePollModal()">åˆ›å»ºæ–°æŠ•ç¥¨</button>
                </div>
            </div>

            <div class="section">
                <h2>æ´»è·ƒæŠ•ç¥¨</h2>
                <div class="user-list" id="pollsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“Š</div>
                        <div>æš‚æ— æ´»è·ƒæŠ•ç¥¨</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="logsTab">
            <div class="section">
                <h2>ç³»ç»Ÿæ—¥å¿—ç®¡ç†</h2>
                <div class="input-group">
                    <button class="btn btn-primary" onclick="loadSystemLogs()">åŠ è½½ç³»ç»Ÿæ—¥å¿—</button>
                    <button class="btn btn-primary" onclick="exportSystemLogs()">å¯¼å‡ºç³»ç»Ÿæ—¥å¿—</button>
                    <button class="btn btn-primary" onclick="exportUserData()">å¯¼å‡ºç”¨æˆ·æ•°æ®</button>
                    <button class="btn btn-danger" onclick="clearSystemLogs()">æ¸…ç©ºç³»ç»Ÿæ—¥å¿—</button>
                    <select id="logTypeFilter" class="btn btn-primary" style="margin-left: 10px;">
                        <option value="all">æ‰€æœ‰ç±»å‹</option>
                        <option value="error">é”™è¯¯</option>
                        <option value="warn">è­¦å‘Š</option>
                        <option value="info">ä¿¡æ¯</option>
                        <option value="debug">è°ƒè¯•</option>
                    </select>
                    <input type="text" id="logSearch" placeholder="æœç´¢æ—¥å¿—å†…å®¹" style="flex: 1; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px; margin-left: 10px;">
                </div>
            </div>

            <div class="section">
                <h2>ç³»ç»Ÿæ—¥å¿—</h2>
                <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; max-height: 600px; overflow-y: auto;">
                    <div id="systemLogsContainer" style="font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.5;">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <div>æš‚æ— ç³»ç»Ÿæ—¥å¿—</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>ç³»ç»Ÿäº‹ä»¶ç»Ÿè®¡</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div class="stat-card">
                        <h3>ç”¨æˆ·ç™»å½•</h3>
                        <div class="value" id="loginCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>ç”¨æˆ·é€€å‡º</h3>
                        <div class="value" id="logoutCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>æ¶ˆæ¯å‘é€</h3>
                        <div class="value" id="messageSentCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>æ–‡ä»¶ä¸Šä¼ </h3>
                        <div class="value" id="fileUploadCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>é”™è¯¯äº‹ä»¶</h3>
                        <div class="value" id="errorCount">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>è­¦å‘Šäº‹ä»¶</h3>
                        <div class="value" id="warnCount">0</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-content" id="monitoringTab">
            <div class="section">
                <h2>ç³»ç»Ÿç›‘æ§</h2>
                <div class="input-group">
                    <button class="btn btn-primary" onclick="startSystemMonitoring()">å¼€å§‹ç›‘æ§</button>
                    <button class="btn btn-danger" onclick="stopSystemMonitoring()">åœæ­¢ç›‘æ§</button>
                    <button class="btn btn-primary" onclick="refreshSystemStatus()">åˆ·æ–°çŠ¶æ€</button>
                    <select id="monitoringInterval" class="btn btn-primary" style="margin-left: 10px;">
                        <option value="1000">1ç§’</option>
                        <option value="2000">2ç§’</option>
                        <option value="5000" selected>5ç§’</option>
                        <option value="10000">10ç§’</option>
                    </select>
                </div>
            </div>

            <div class="section">
                <h2>ç³»ç»ŸçŠ¶æ€</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div class="stat-card">
                        <h3>CPUä½¿ç”¨ç‡</h3>
                        <div class="value" id="cpuUsage">0%</div>
                    </div>
                    <div class="stat-card">
                        <h3>å†…å­˜ä½¿ç”¨ç‡</h3>
                        <div class="value" id="memoryUsage">0%</div>
                    </div>
                    <div class="stat-card">
                        <h3>ç£ç›˜ä½¿ç”¨ç‡</h3>
                        <div class="value" id="diskUsage">0%</div>
                    </div>
                    <div class="stat-card">
                        <h3>ç½‘ç»œæµé‡</h3>
                        <div class="value" id="networkTraffic">0 KB/s</div>
                    </div>
                    <div class="stat-card">
                        <h3>åœ¨çº¿ç”¨æˆ·</h3>
                        <div class="value" id="onlineUsers">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>WebSocketè¿æ¥</h3>
                        <div class="value" id="websocketConnections">0</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>ç³»ç»Ÿæ€§èƒ½ç›‘æ§</h2>
                <div style="background: white; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                    <div id="performanceChart" style="height: 300px;"></div>
                </div>
            </div>

            <div class="section">
                <h2>ç³»ç»Ÿäº‹ä»¶</h2>
                <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; max-height: 300px; overflow-y: auto;">
                    <div id="systemEventsContainer" style="font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.5;">
                        <div class="empty-state">
                            <div class="empty-state-icon">âš¡</div>
                            <div>æš‚æ— ç³»ç»Ÿäº‹ä»¶</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-content" id="mutedUsersTab">
            <div class="section">
                <h2>ç¦è¨€ç”¨æˆ·ç®¡ç†</h2>
                <button class="btn btn-primary" onclick="loadMutedUsers()">åˆ·æ–°ç¦è¨€åˆ—è¡¨</button>
                <button class="btn btn-primary" onclick="openMuteUserModal()">ç¦è¨€ç”¨æˆ·</button>
            </div>
            
            <div class="section">
                <h2>å·²ç¦è¨€ç”¨æˆ·</h2>
                <div class="user-list" id="mutedUsersList">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”‡</div>
                        <div>æš‚æ— è¢«ç¦è¨€ç”¨æˆ·</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="callsTab">
            <div class="section">
                <h2>é€šè¯ç®¡ç†</h2>
                <div class="call-method-info" style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #007bff;">
                    <h3 style="margin-top: 0; color: #007bff;">é€šè¯æ–¹å¼è¯´æ˜</h3>
                    <ul style="margin: 10px 0 0 20px; padding: 0;">
                        <li><strong>WebRTC</strong>ï¼šç‚¹å¯¹ç‚¹ç›´æ¥é€šä¿¡ï¼Œå»¶è¿Ÿä½ï¼Œè´¨é‡é«˜ï¼Œä½†åªèƒ½åœ¨å±€åŸŸç½‘å†…ä½¿ç”¨</li>
                        <li><strong>Socket.io</strong>ï¼šä½¿ç”¨æœåŠ¡å™¨è½¬å‘æ•°æ®ï¼Œæ”¯æŒè·¨ç½‘æ®µé€šè¯</li>
                    </ul>
                </div>
                <button class="btn btn-primary" onclick="loadOngoingCalls()">åˆ·æ–°é€šè¯åˆ—è¡¨</button>
            </div>
            
            <div class="section">
                <h2>æ­£åœ¨è¿›è¡Œçš„é€šè¯</h2>
                <div class="user-list" id="ongoingCallsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <div>æš‚æ— æ­£åœ¨è¿›è¡Œçš„é€šè¯</div>
                    </div>
                </div>
            </div>
            
            <!-- é€šè¯è¯¦æƒ…æ¨¡æ€æ¡† -->
            <div class="modal" id="callDetailsModal">
                <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto; overflow-x: hidden;">
                    <h3>é€šè¯è¯¦æƒ…</h3>
                    <div id="callDetailsInfo">
                        <!-- é€šè¯è¯¦æƒ…å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </div>
                    
                    <!-- é€šè¯åŒæ–¹ç”»é¢ -->
                    <div style="margin-top: 20px;">
                        <h3>é€šè¯ç”»é¢ç›‘æ§ <span id="callMethodDisplay" style="font-size: 14px; font-weight: normal; color: #666;"></span></h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                            <div style="background: #000; border-radius: 10px; overflow: hidden; position: relative; min-height: 300px;">
                                <h4 style="position: absolute; top: 10px; left: 10px; color: white; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 5px; margin: 0; z-index: 1;">å‘èµ·æ–¹ç”»é¢</h4>
                                <div id="initiatorVideoContainer" style="width: 100%; height: 300px; display: flex; align-items: center; justify-content: center; color: #666;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“¹</div>
                                        <div id="initiatorVideoStatus">ç­‰å¾…é€šè¯æ•°æ®...</div>
                                    </div>
                                </div>
                                <video id="initiatorVideo" autoplay playsinline style="display: none; width: 100%; height: 300px; object-fit: contain; background: #000;"></video>
                            </div>
                            <div style="background: #000; border-radius: 10px; overflow: hidden; position: relative; min-height: 300px;">
                                <h4 style="position: absolute; top: 10px; left: 10px; color: white; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 5px; margin: 0; z-index: 1;">æ¥æ”¶æ–¹ç”»é¢</h4>
                                <div id="recipientVideoContainer" style="width: 100%; height: 300px; display: flex; align-items: center; justify-content: center; color: #666;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“¹</div>
                                        <div id="recipientVideoStatus">ç­‰å¾…é€šè¯æ•°æ®...</div>
                                    </div>
                                </div>
                                <video id="recipientVideo" autoplay playsinline style="display: none; width: 100%; height: 300px; object-fit: contain; background: #000;"></video>
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-size: 14px; color: #666;">
                            <strong>è¯´æ˜ï¼š</strong> 
                            <span id="videoModeNote">WebRTCä¸ºç‚¹å¯¹ç‚¹é€šè¯ï¼Œç®¡ç†å‘˜æ— æ³•æŸ¥çœ‹ç”»é¢ã€‚è¯·ä½¿ç”¨Socket.ioæ¨¡å¼è¿›è¡Œå¯ç›‘æ§çš„é€šè¯ã€‚</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-danger" onclick="endCall()">ç»“æŸé€šè¯</button>
                        <button class="btn btn-primary" onclick="toggleCallControl('video')">åˆ‡æ¢è§†é¢‘æ§åˆ¶</button>
                        <button class="btn btn-primary" onclick="toggleCallControl('audio')">åˆ‡æ¢éŸ³é¢‘æ§åˆ¶</button>
                        <button class="btn btn-cancel" onclick="closeCallDetailsModal()">å…³é—­</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="settingsManagementTab">
            <h2>ç”¨æˆ·è®¾ç½®ç®¡ç†</h2>
            <div class="section">
                <h3>ç”¨æˆ·åˆ—è¡¨</h3>
                <button class="btn btn-primary" onclick="loadUsersForSettings()">åˆ·æ–°ç”¨æˆ·åˆ—è¡¨</button>
                <div class="user-list" id="settingsUsersList">
                    <div class="empty-state">
                        <div>æš‚æ— ç”¨æˆ·æ•°æ®</div>
                    </div>
                </div>
            </div>
            <div class="section">
                <h3>ç”¨æˆ·è®¾ç½®æ§åˆ¶</h3>
                <div id="userSettingsForm" style="display: none;">
                    <h4>ç¼–è¾‘ç”¨æˆ·è®¾ç½® - <span id="selectedUsername"></span></h4>
                    <div class="input-group">
                        <label>é”å®šç”¨æˆ·è®¾ç½®</label>
                        <input type="checkbox" id="lockUserSettings">
                        <span class="help-text">é”å®šåç”¨æˆ·å°†æ— æ³•ä¿®æ”¹è‡ªå·±çš„è®¾ç½®</span>
                    </div>
                    <div class="input-group">
                        <label>è‡ªå®šä¹‰é”å®šæç¤º</label>
                        <input type="text" id="customLockMessage" placeholder="è®¾ç½®å·²è¢«ç®¡ç†å‘˜é”å®š">
                    </div>
                    
                    <h4 style="margin-top: 20px;">ç›´æ¥ä¿®æ”¹ç”¨æˆ·è®¾ç½®</h4>
                    <div class="input-group">
                        <label>ç¿»è¯‘ç›®æ ‡è¯­è¨€</label>
                        <select id="userTargetLanguage">
                            <option value="zh">ä¸­æ–‡</option>
                            <option value="en">English</option>
                            <option value="ja">æ—¥æœ¬èª</option>
                            <option value="ko">í•œêµ­ì–´</option>
                            <option value="fr">FranÃ§ais</option>
                            <option value="de">Deutsch</option>
                            <option value="es">EspaÃ±ol</option>
                            <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>è‡ªåŠ¨ç¿»è¯‘æ‰€æœ‰æ¶ˆæ¯</label>
                        <input type="checkbox" id="userAutoTranslate">
                    </div>
                    <div class="input-group">
                        <label>å£°éŸ³é€šçŸ¥</label>
                        <input type="checkbox" id="userSoundNotification">
                    </div>
                    <div class="input-group">
                        <label>@æåŠé€šçŸ¥</label>
                        <input type="checkbox" id="userMentionNotification">
                    </div>
                    
                    <h4 style="margin-top: 20px;">è§†é¢‘è®¾ç½®</h4>
                    <div class="input-group">
                        <label>å¼€å‘è€…æ¨¡å¼</label>
                        <input type="checkbox" id="userDeveloperMode">
                    </div>
                    <div class="input-group">
                        <label>æœ¬åœ°è§†é¢‘é•œåƒæ˜¾ç¤º</label>
                        <input type="checkbox" id="userMirrorVideo">
                    </div>
                    <div class="input-group">
                        <label>å¯¹æ–¹è§†é¢‘é•œåƒæ˜¾ç¤º</label>
                        <input type="checkbox" id="userRemoteMirrorVideo">
                    </div>
                    
                    <h4 style="margin-top: 20px;">é€šè¯è®¾ç½®</h4>
                    <div class="input-group">
                        <label>è‡ªåŠ¨è°ƒæ•´éŸ³é‡</label>
                        <input type="checkbox" id="userAutoAdjustVolume">
                    </div>
                    <div class="input-group">
                        <label>å¯ç”¨å®æ—¶å­—å¹•</label>
                        <input type="checkbox" id="userEnableSubtitles">
                    </div>
                    <div class="input-group">
                        <label>è¯´è¯æ£€æµ‹é˜ˆå€¼</label>
                        <input type="range" id="userSpeakingThreshold" min="0" max="100" step="5" value="40">
                        <span id="userSpeakingThresholdValue">40</span>
                    </div>
                    <div class="input-group">
                        <label>éŸ³é‡é™ä½æ¯”ä¾‹</label>
                        <input type="range" id="userVolumeReduction" min="10" max="80" step="5" value="30">
                        <span id="userVolumeReductionValue">30%</span>
                    </div>
                    <div class="input-group">
                        <label>å­—å¹•å­—ä½“å¤§å°</label>
                        <input type="range" id="userSubtitlesFontSize" min="12" max="24" step="1" value="16">
                        <span id="userSubtitlesFontSizeValue">16px</span>
                    </div>
                    
                    <h4 style="margin-top: 20px;">AIèŠå¤©è®¾ç½®</h4>
                    <div class="input-group">
                        <label>å¯ç”¨AIèŠå¤©åŠŸèƒ½</label>
                        <input type="checkbox" id="userEnableAIChat">
                    </div>
                    <div class="input-group">
                        <label>AIæ¨¡å‹</label>
                        <select id="userAiModel">
                            <option value="glm4">GLM-4 Flash</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="siliconflow">ç¡…åŸºæµåŠ¨</option>
                            <option value="custom">è‡ªå®šä¹‰API</option>
                        </select>
                    </div>
                    
                    <div class="input-group" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="saveUserSettings()">ä¿å­˜è®¾ç½®</button>
                        <button class="btn btn-secondary" onclick="closeUserSettingsForm()">å–æ¶ˆ</button>
                    </div>
                    
                    <script>
                        // æ·»åŠ æ»‘åŠ¨æ¡äº‹ä»¶ç›‘å¬å™¨
                        document.addEventListener('DOMContentLoaded', function() {
                            const speakingThreshold = document.getElementById('userSpeakingThreshold');
                            const speakingThresholdValue = document.getElementById('userSpeakingThresholdValue');
                            if (speakingThreshold && speakingThresholdValue) {
                                speakingThreshold.addEventListener('input', function() {
                                    speakingThresholdValue.textContent = this.value;
                                });
                            }
                            
                            const volumeReduction = document.getElementById('userVolumeReduction');
                            const volumeReductionValue = document.getElementById('userVolumeReductionValue');
                            if (volumeReduction && volumeReductionValue) {
                                volumeReduction.addEventListener('input', function() {
                                    volumeReductionValue.textContent = this.value + '%';
                                });
                            }
                            
                            const subtitlesFontSize = document.getElementById('userSubtitlesFontSize');
                            const subtitlesFontSizeValue = document.getElementById('userSubtitlesFontSizeValue');
                            if (subtitlesFontSize && subtitlesFontSizeValue) {
                                subtitlesFontSize.addEventListener('input', function() {
                                    subtitlesFontSizeValue.textContent = this.value + 'px';
                                });
                            }
                        });
                    </script>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="updatesTab">
            <div class="section">
                <h2>å‘å¸ƒæ›´æ–°</h2>
                <div class="input-group">
                    <button class="btn btn-primary" onclick="openUpdateModal()">å‘å¸ƒæ–°ç‰ˆæœ¬</button>
                </div>
                
                <div class="section" style="margin-top: 20px;">
                    <h3>æ›´æ–°å†å²</h3>
                    <div id="updateHistory" style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                        <p>æš‚æ— æ›´æ–°å†å²</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="chatroomNotificationsTab">
            <div class="section">
                <h2>å‘é€èŠå¤©å®¤æç¤º</h2>
                <p style="margin-bottom: 15px; color: #666;">å‘æŒ‡å®šç”¨æˆ·å‘é€èŠå¤©å®¤æç¤ºï¼Œæ”¯æŒè‡ªå®šä¹‰æ ·å¼å’ŒæŒ‰é’®</p>
                <div class="input-group">
                    <button class="btn btn-primary" onclick="openChatroomNotificationModal()">å‘é€æç¤º</button>
                    <button class="btn btn-info" onclick="refreshActiveNotifications()">åˆ·æ–°æ´»è·ƒæç¤º</button>
                </div>
            </div>
            
            <div class="section" style="margin-top: 20px;">
                <h2>æ´»è·ƒæç¤ºç®¡ç†</h2>
                <p style="margin-bottom: 15px; color: #666;">ç®¡ç†å½“å‰æ´»è·ƒçš„èŠå¤©å®¤æç¤ºï¼Œæ”¯æŒç¼–è¾‘ã€åˆ é™¤å’Œæ ·å¼ä¿®æ”¹</p>
                <div id="activeNotificationsList" style="background: #f8f9fa; padding: 15px; border-radius: 10px; max-height: 500px; overflow-y: auto;">
                    <div class="empty-state">
                        <p>æš‚æ— æ´»è·ƒæç¤º</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="consoleTab">
            <div class="section">
                <h2>JavaScriptæ§åˆ¶å°</h2>
                <p style="margin-bottom: 15px; color: #666;">æŸ¥çœ‹ç”¨æˆ·JavaScriptæ§åˆ¶å°ï¼Œæ‰§è¡ŒJavaScriptä»£ç ï¼ŒæŸ¥çœ‹æ‰€æœ‰çº§åˆ«çš„æ—¥å¿—</p>
                
                <div class="input-group" style="margin-bottom: 20px;">
                    <select id="consoleUserSelect" style="flex: 1; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px;">
                        <option value="">é€‰æ‹©ç”¨æˆ·</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadUserConsole()">åŠ è½½æ§åˆ¶å°</button>
                </div>
                
                <div class="section">
                    <h3>æ‰§è¡ŒJavaScriptä»£ç </h3>
                    <div class="input-group">
                        <textarea id="consoleCode" placeholder="è¾“å…¥JavaScriptä»£ç ï¼ŒæŒ‰æ‰§è¡ŒæŒ‰é’®è¿è¡Œ" rows="10" style="flex: 1; padding: 12px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px; font-family: 'Courier New', monospace;"></textarea>
                    </div>
                    <div class="input-group" style="margin-top: 10px;">
                        <button class="btn btn-primary" onclick="executeConsoleCode()">æ‰§è¡Œä»£ç </button>
                        <button class="btn btn-secondary" onclick="clearConsoleCode()">æ¸…ç©ºä»£ç </button>
                        <button class="btn btn-info" onclick="loadSampleCode()">åŠ è½½ç¤ºä¾‹ä»£ç </button>
                    </div>
                </div>
                
                <div class="section" style="margin-top: 20px;">
                    <h3>æ§åˆ¶å°æ—¥å¿—</h3>
                    <div class="input-group" style="margin-bottom: 10px;">
                        <select id="logLevelFilter" style="padding: 8px; border: 2px solid #dee2e6; border-radius: 8px; font-size: 14px;">
                            <option value="all">æ‰€æœ‰çº§åˆ«</option>
                            <option value="error">é”™è¯¯</option>
                            <option value="warn">è­¦å‘Š</option>
                            <option value="info">ä¿¡æ¯</option>
                            <option value="log">æ—¥å¿—</option>
                            <option value="debug">è°ƒè¯•</option>
                        </select>
                        <button class="btn btn-primary" onclick="clearConsoleLogs()">æ¸…ç©ºæ—¥å¿—</button>
                        <button class="btn btn-info" onclick="exportConsoleLogs()">å¯¼å‡ºæ—¥å¿—</button>
                    </div>
                    <div id="consoleLogs" style="background: #f8f9fa; border-radius: 10px; padding: 15px; max-height: 500px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 14px;">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ’»</div>
                            <div>è¯·é€‰æ‹©ç”¨æˆ·å¹¶åŠ è½½æ§åˆ¶å°</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- æ›´æ–°é€šçŸ¥æ¨¡æ€æ¡† -->
        <div class="modal" id="updateModal">
            <div class="modal-content">
                <h3>å‘å¸ƒæ–°ç‰ˆæœ¬</h3>
                <form onsubmit="event.preventDefault(); publishUpdate();">
                    <div class="input-group">
                        <label>ç‰ˆæœ¬å·</label>
                        <input type="text" id="updateVersion" placeholder="è¾“å…¥ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ï¼šv1.0.1" required>
                    </div>
                    <div class="input-group">
                        <label>æ›´æ–°å†…å®¹</label>
                        <textarea id="updateContent" placeholder="è¾“å…¥æ›´æ–°å†…å®¹ï¼Œæ”¯æŒæ¢è¡Œ" rows="5" required></textarea>
                    </div>
                    <div class="input-group">
                        <label>æ›´æ–°ç›®æ ‡</label>
                        <select id="updateTarget" onchange="updateTargetChanged()">
                            <option value="all">å…¨ä½“ç”¨æˆ·</option>
                            <option value="probability">æ¦‚ç‡æ¨é€</option>
                            <option value="specific">ç‰¹å®šç”¨æˆ·</option>
                        </select>
                    </div>
                    <div class="input-group" id="probabilityGroup" style="display: none;">
                        <label>æ¨é€æ¦‚ç‡ (%)</label>
                        <input type="number" id="updateProbability" placeholder="è¾“å…¥0-100ä¹‹é—´çš„æ¦‚ç‡å€¼" min="0" max="100" step="1">
                    </div>
                    <div class="input-group" id="specificUsersGroup" style="display: none;">
                        <label>ç‰¹å®šç”¨æˆ·ID</label>
                        <textarea id="specificUsers" placeholder="è¾“å…¥ç”¨æˆ·IDï¼Œå¤šä¸ªç”¨æˆ·ç”¨é€—å·åˆ†éš”" rows="3"></textarea>
                    </div>
                    <div class="input-group">
                        <label>å¼ºåˆ¶æ›´æ–°</label>
                        <input type="checkbox" id="forceUpdate">
                        <span style="margin-left: 10px; color: #666;">å‹¾é€‰åç”¨æˆ·å¿…é¡»åˆ·æ–°é¡µé¢æ‰èƒ½ç»§ç»­ä½¿ç”¨</span>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="btn btn-cancel" onclick="closeUpdateModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-confirm">å‘å¸ƒæ›´æ–°</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- èŠå¤©å®¤æç¤ºæ¨¡æ€æ¡† -->
        <div class="modal" id="chatroomNotificationModal">
            <div class="modal-content">
                <h3>å‘é€èŠå¤©å®¤æç¤º</h3>
                <form onsubmit="event.preventDefault(); sendChatroomNotification();">
                    <div class="input-group">
                        <label>æç¤ºæ ‡é¢˜</label>
                        <input type="text" id="notificationTitle" placeholder="è¾“å…¥æç¤ºæ ‡é¢˜ï¼Œä¾‹å¦‚ï¼šèŠå¤©å®¤æ´»åŠ¨" required style="height: 40px; padding: 8px 12px;">
                    </div>
                    <div class="input-group">
                        <label>æç¤ºå†…å®¹</label>
                        <textarea id="notificationContent" placeholder="è¾“å…¥æç¤ºå†…å®¹ï¼Œæ”¯æŒæ¢è¡Œ" rows="10" required style="height: 200px; padding: 8px 12px; resize: vertical; overflow-y: auto;"></textarea>
                    </div>
                    <div class="input-group">
                        <label>æŒ‰é’®æ–‡æœ¬</label>
                        <input type="text" id="notificationButtonText" placeholder="è¾“å…¥æŒ‰é’®æ–‡æœ¬ï¼Œä¾‹å¦‚ï¼šç«‹å³å‚ä¸" value="è¿›å…¥èŠå¤©å®¤" style="height: 40px; padding: 8px 12px;">
                    </div>
                    <div class="input-group">
                        <label>æŒ‰é’®é¢œè‰²</label>
                        <input type="color" id="notificationButtonColor" value="#667eea">
                        <input type="text" id="notificationButtonColorText" placeholder="ä¾‹å¦‚ï¼š#667eea" value="#667eea" style="margin-left: 10px; width: 120px;">
                    </div>
                    <div class="input-group">
                        <label>èƒŒæ™¯é¢œè‰²</label>
                        <input type="color" id="notificationBackgroundColor" value="#ffffff">
                        <input type="text" id="notificationBackgroundColorText" placeholder="ä¾‹å¦‚ï¼š#ffffff" value="#ffffff" style="margin-left: 10px; width: 120px;">
                        <button type="button" class="btn btn-sm btn-warning" onclick="selectNotificationStyle()" style="margin-left: 10px; padding: 8px 12px; font-size: 12px;">ğŸ¨ é€‰æ‹©æ ·å¼</button>
                    </div>
                    <div class="input-group">
                        <label>å¼ºåˆ¶æ“ä½œ</label>
                        <input type="checkbox" id="notificationForceAction">
                        <span style="margin-left: 10px; color: #666;">å‹¾é€‰åç”¨æˆ·å¿…é¡»ç‚¹å‡»æŒ‰é’®ï¼Œæ— æ³•å…³é—­</span>
                    </div>
                    <div class="input-group">
                        <label>æ¨é€ç›®æ ‡</label>
                        <select id="notificationTarget" onchange="notificationTargetChanged()">
                            <option value="all">å…¨ä½“ç”¨æˆ·</option>
                            <option value="probability">æ¦‚ç‡æ¨é€</option>
                            <option value="specific">ç‰¹å®šç”¨æˆ·</option>
                        </select>
                    </div>
                    <div class="input-group" id="notificationProbabilityGroup" style="display: none;">
                        <label>æ¨é€æ¦‚ç‡ (%)</label>
                        <input type="number" id="notificationProbability" placeholder="è¾“å…¥0-100ä¹‹é—´çš„æ¦‚ç‡å€¼" min="0" max="100" step="1">
                    </div>
                    <div class="input-group" id="notificationSpecificUsersGroup" style="display: none;">
                        <label>ç‰¹å®šç”¨æˆ·ID</label>
                        <textarea id="notificationSpecificUsers" placeholder="è¾“å…¥ç”¨æˆ·IDï¼Œå¤šä¸ªç”¨æˆ·ç”¨é€—å·åˆ†éš”" rows="3"></textarea>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="btn btn-cancel" onclick="closeChatroomNotificationModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-confirm">å‘é€æç¤º</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="tab-content" id="systemManagementTab">
            <div class="section">
                <h2>æœåŠ¡å™¨ä¿¡æ¯</h2>
                <div id="serverInfo" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <p>ç‚¹å‡»"è·å–æœåŠ¡å™¨ä¿¡æ¯"æŒ‰é’®æŸ¥çœ‹è¯¦æƒ…</p>
                </div>
                <button class="btn btn-primary" onclick="getServerInfo()">è·å–æœåŠ¡å™¨ä¿¡æ¯</button>
            </div>
            
            <div class="section">
                <h2>æœåŠ¡å™¨æ§åˆ¶</h2>
                <button class="btn btn-danger" onclick="shutdownServer()">å…³é—­æœåŠ¡å™¨</button>
            </div>
            
            <div class="section">
                <h2>æ‰§è¡Œå‘½ä»¤</h2>
                <div class="input-group">
                    <input type="text" id="commandInput" placeholder="è¾“å…¥è¦æ‰§è¡Œçš„å‘½ä»¤" style="width: 100%;">
                </div>
                <button class="btn btn-primary" onclick="executeCommand()">æ‰§è¡Œå‘½ä»¤</button>
                <div id="commandOutput" style="margin-top: 15px; background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 10px; max-height: 300px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; word-wrap: break-word;"></div>
            </div>
        </div>
    </div>

    <!-- ç¦è¨€ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal" id="muteUserModal">
        <div class="modal-content">
            <h3>ç¦è¨€ç”¨æˆ·</h3>
            <form onsubmit="event.preventDefault(); confirmMuteUser();">
                <div class="input-group">
                    <label>é€‰æ‹©ç”¨æˆ·</label>
                    <select id="muteUserId" required>
                        <option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>ç¦è¨€æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼Œ-1è¡¨ç¤ºæ°¸ä¹…ï¼‰</label>
                    <input type="number" id="muteDuration" placeholder="è¾“å…¥ç¦è¨€æ—¶é•¿ï¼Œ-1è¡¨ç¤ºæ°¸ä¹…" min="-1" value="5">
                </div>
                <div class="input-group">
                    <label>ç¦è¨€åŸå› </label>
                    <textarea id="muteReason" placeholder="è¾“å…¥ç¦è¨€åŸå› " rows="2" required></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeMuteUserModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">ç¡®è®¤ç¦è¨€</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal" id="usersModal">
        <div class="modal-content" style="max-width: 800px;">
            <h3>åœ¨çº¿ç”¨æˆ·ç®¡ç†</h3>
            <div class="input-group" style="margin-bottom: 15px;">
                <input type="text" id="userSearch" placeholder="æœç´¢ç”¨æˆ·åæˆ–æˆ¿é—´å" oninput="filterUsers()">
            </div>
            <div class="user-list" id="userList">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ‘¥</div>
                    <div>æš‚æ— åœ¨çº¿ç”¨æˆ·</div>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeUsersModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <div class="modal" id="renameModal">
        <div class="modal-content">
            <h3>é‡å‘½åç”¨æˆ·</h3>
            <form onsubmit="event.preventDefault(); confirmRename();">
                <input type="text" id="newUsername" placeholder="è¾“å…¥æ–°ç”¨æˆ·å" maxlength="20">
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeRenameModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">ç¡®è®¤</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="permissionsModal">
        <div class="modal-content">
            <h3>è®¾ç½®ç”¨æˆ·æƒé™</h3>
            <div id="permissionsForm">
                <div class="permission-item">
                    <label>
                        <span>å…è®¸å‘é€è¯­éŸ³</span>
                        <label class="switch">
                            <input type="checkbox" id="allowAudio" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸å‘é€å›¾ç‰‡</span>
                        <label class="switch">
                            <input type="checkbox" id="allowImage" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸å‘é€æ–‡ä»¶</span>
                        <label class="switch">
                            <input type="checkbox" id="allowFile" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸å‘é€æ¶ˆæ¯</span>
                        <label class="switch">
                            <input type="checkbox" id="allowSendMessages" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸æŸ¥çœ‹æ¶ˆæ¯</span>
                        <label class="switch">
                            <input type="checkbox" id="allowViewMessages" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸é€šè¯</span>
                        <label class="switch">
                            <input type="checkbox" id="allowCall" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸AIèŠå¤©</span>
                        <label class="switch">
                            <input type="checkbox" id="allowAIChat" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸æ·»åŠ å¥½å‹</span>
                        <label class="switch">
                            <input type="checkbox" id="allowAddFriends" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨</span>
                        <label class="switch">
                            <input type="checkbox" id="allowViewUsers" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸ç§èŠ</span>
                        <label class="switch">
                            <input type="checkbox" id="allowPrivateChat" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸æ‰“å¼€å¥½å‹é¡µé¢</span>
                        <label class="switch">
                            <input type="checkbox" id="allowOpenFriendsPage" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸æ’¤å›æ¶ˆæ¯</span>
                        <label class="switch">
                            <input type="checkbox" id="allowRecallMessage" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closePermissionsModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-confirm" onclick="confirmPermissions()">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <div class="modal" id="adminMessageModal">
        <div class="modal-content">
            <h3>ä¼ªè£…å‘é€æ¶ˆæ¯</h3>
            <form onsubmit="event.preventDefault(); sendDisguisedMessage();">
                <div class="input-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="disguiseUsername" placeholder="è¾“å…¥è¦ä¼ªè£…çš„ç”¨æˆ·å" required>
                </div>
                <div class="input-group">
                    <label>æ¶ˆæ¯å†…å®¹</label>
                    <textarea id="disguiseMessage" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹" rows="3" required></textarea>
                </div>
                <div class="input-group">
                    <label>æ¶ˆæ¯ç±»å‹</label>
                    <select id="disguiseMessageType">
                        <option value="text">æ™®é€šæ¶ˆæ¯</option>
                        <option value="system">ç³»ç»Ÿæ¶ˆæ¯</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>æ¶ˆæ¯é¢œè‰²</label>
                    <input type="color" id="disguiseColor" value="#667eea">
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeAdminMessageModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">å‘é€</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="createPollModal">
        <div class="modal-content">
            <h3>åˆ›å»ºæ–°æŠ•ç¥¨</h3>
            <form onsubmit="event.preventDefault(); createPoll();">
                <div class="input-group">
                    <label>æŠ•ç¥¨é—®é¢˜</label>
                    <input type="text" id="pollQuestion" placeholder="è¾“å…¥æŠ•ç¥¨é—®é¢˜" required>
                </div>
                <div id="pollOptionsContainer" style="margin: 15px 0;">
                    <div class="input-group" style="margin-bottom: 10px;">
                        <label>é€‰é¡¹ 1</label>
                        <input type="text" class="poll-option" placeholder="è¾“å…¥é€‰é¡¹å†…å®¹" required>
                    </div>
                    <div class="input-group" style="margin-bottom: 10px;">
                        <label>é€‰é¡¹ 2</label>
                        <input type="text" class="poll-option" placeholder="è¾“å…¥é€‰é¡¹å†…å®¹" required>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary" onclick="addPollOption()" style="margin-bottom: 15px;">æ·»åŠ é€‰é¡¹</button>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeCreatePollModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">åˆ›å»º</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="uploadFileModal">
        <div class="modal-content">
            <h3>ä¸Šä¼ æ–‡ä»¶</h3>
            <form onsubmit="event.preventDefault(); uploadFile();">
                <div class="input-group">
                    <label>é€‰æ‹©æ–‡ä»¶</label>
                    <input type="file" id="fileInput" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeUploadModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">ä¸Šä¼ </button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="createFileModal">
        <div class="modal-content">
            <h3>åˆ›å»ºæ–‡ä»¶</h3>
            <form onsubmit="event.preventDefault(); createFile();">
                <div class="input-group">
                    <label>æ–‡ä»¶å</label>
                    <input type="text" id="createFileName" placeholder="ä¾‹å¦‚: test.txt" required>
                </div>
                <div class="input-group">
                    <label>æ–‡ä»¶å†…å®¹</label>
                    <textarea id="createFileContent" placeholder="è¾“å…¥æ–‡ä»¶å†…å®¹" rows="5"></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeCreateFileModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">åˆ›å»º</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="createDirectoryModal">
        <div class="modal-content">
            <h3>åˆ›å»ºç›®å½•</h3>
            <form onsubmit="event.preventDefault(); createDirectory();">
                <div class="input-group">
                    <label>ç›®å½•å</label>
                    <input type="text" id="createDirectoryName" placeholder="ä¾‹å¦‚: images" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeCreateDirectoryModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">åˆ›å»º</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="editFileModal">
        <div class="modal-content">
            <h3>ç¼–è¾‘æ–‡ä»¶</h3>
            <form onsubmit="event.preventDefault(); saveFileEdit();">
                <div class="input-group">
                    <label>æ–‡ä»¶å</label>
                    <input type="text" id="editFileName" readonly>
                </div>
                <div class="input-group">
                    <label>æ–‡ä»¶å†…å®¹</label>
                    <textarea id="editFileContent" rows="10"></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeEditFileModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="setMaxFriendsModal">
        <div class="modal-content">
            <h3>è®¾ç½®å¥½å‹æ•°é‡ä¸Šé™</h3>
            <form onsubmit="event.preventDefault(); saveMaxFriends();">
                <div class="input-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="setMaxFriendsUsername" readonly>
                </div>
                <div class="input-group">
                    <label>å¥½å‹æ•°é‡ä¸Šé™</label>
                    <input type="number" id="setMaxFriendsValue" placeholder="è¾“å…¥-1è¡¨ç¤ºæ— é™" min="-1" value="5">
                    <small style="color: #666; display: block; margin-top: 5px;">è¾“å…¥-1è¡¨ç¤ºæ— é™å¥½å‹æ•°é‡</small>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeSetMaxFriendsModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal" id="editRoomModal">
        <div class="modal-content">
            <h3>ç¼–è¾‘æˆ¿é—´</h3>
            <form onsubmit="event.preventDefault(); confirmEditRoom();">
                <div class="input-group">
                    <label>æˆ¿é—´å</label>
                    <input type="text" id="editRoomName" readonly>
                </div>
                <div class="input-group">
                    <label>æˆ¿é—´å¯†ç </label>
                    <input type="password" id="editRoomPassword" placeholder="ç•™ç©ºè¡¨ç¤ºä¸è®¾ç½®å¯†ç ">
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeEditRoomModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="roomUsersModal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 id="roomUsersTitle">æˆ¿é—´ç”¨æˆ·åˆ—è¡¨</h3>
            <div id="roomUsersList">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ‘¥</div>
                    <div>æš‚æ— ç”¨æˆ·</div>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeRoomUsersModal()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="friendsModal">
        <div class="modal-content" style="max-width: 800px;">
            <h3>å¥½å‹ç®¡ç†</h3>
            <div id="friendsList">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ‘¥</div>
                    <div>æš‚æ— å¥½å‹å…³ç³»</div>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeFriendsModal()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="addFriendModal">
        <div class="modal-content" style="max-width: 600px;">
            <h3>æ·»åŠ å¥½å‹</h3>
            <form onsubmit="event.preventDefault(); confirmAddFriend();">
                <div class="input-group">
                    <label>é€‰æ‹©ç”¨æˆ·A</label>
                    <select id="userA" required>
                        <option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>é€‰æ‹©ç”¨æˆ·B</label>
                    <select id="userB" required>
                        <option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeAddFriendModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">æ·»åŠ </button>
                </div>
            </form>
        </div>
    </div>
    <div class="modal" id="popupModal">
        <div class="modal-content">
            <h3>å‘é€å¼¹çª—æ¶ˆæ¯</h3>
            <form onsubmit="event.preventDefault(); sendPopup();">
                <div class="input-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="popupUsername" readonly>
                </div>
                <div class="input-group">
                    <label>å¼¹çª—å†…å®¹</label>
                    <textarea id="popupMessage" placeholder="è¾“å…¥å¼¹çª—å†…å®¹" rows="3" required></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closePopupModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">å‘é€</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="changeTitleModal">
            <div class="modal-content">
                <h3>æ›´æ”¹é¡µé¢æ ‡é¢˜</h3>
                <form onsubmit="event.preventDefault(); changeTitle();">
                    <div class="input-group">
                        <label>ç”¨æˆ·å</label>
                        <input type="text" id="changeTitleUsername" readonly>
                    </div>
                    <div class="input-group">
                        <label>æ–°æ ‡é¢˜</label>
                        <input type="text" id="changeTitleContent" placeholder="è¾“å…¥æ–°çš„é¡µé¢æ ‡é¢˜" required>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="btn btn-cancel" onclick="closeChangeTitleModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-confirm">æ›´æ”¹</button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- AIè®¾ç½®æ¨¡æ€æ¡† -->
        <div class="modal" id="aiSettingsModal">
            <div class="modal-content">
                <h3>è®¾ç½®ç”¨æˆ·AIèŠå¤©</h3>
                <form onsubmit="event.preventDefault(); saveAiSettings();">
                    <div class="input-group">
                        <label>ç”¨æˆ·å</label>
                        <input type="text" id="aiSettingsUsername" readonly>
                    </div>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="aiEnableCheckbox">
                            å¯ç”¨AIèŠå¤©åŠŸèƒ½
                        </label>
                    </div>
                    <div class="input-group">
                        <label>AIæ¨¡å‹é€‰æ‹©</label>
                        <select id="aiModelSelect">
                            <option value="glm4">GLM-4 Flash</option>
                            <option value="deepseek">DeepSeek</option>
                            <option value="siliconflow">ç¡…åŸºæµåŠ¨</option>
                            <option value="custom">è‡ªå®šä¹‰API</option>
                        </select>
                    </div>
                    
                    <!-- GLM-4 é…ç½® -->
                    <div id="aiGlm4Config" class="input-group">
                        <label>GLM-4 API Key (å¯é€‰)</label>
                        <input type="password" id="aiGlm4ApiKey" placeholder="è¾“å…¥GLM-4 API Key">
                    </div>
                    
                    <!-- DeepSeek é…ç½® -->
                    <div id="aiDeepseekConfig" class="input-group" style="display: none;">
                        <label>DeepSeek æ¨¡å‹åç§°</label>
                        <input type="text" id="aiDeepseekModelName" placeholder="ä¾‹å¦‚: deepseek-chat">
                        <label>DeepSeek API Key</label>
                        <input type="password" id="aiDeepseekApiKey" placeholder="è¾“å…¥DeepSeek API Key">
                    </div>
                    
                    <!-- ç¡…åŸºæµåŠ¨ é…ç½® -->
                    <div id="aiSiliconflowConfig" class="input-group" style="display: none;">
                        <label>ç¡…åŸºæµåŠ¨ æ¨¡å‹åç§°</label>
                        <input type="text" id="aiSiliconflowModelName" placeholder="ä¾‹å¦‚: Qwen/Qwen2.5-72B-Instruct">
                        <label>ç¡…åŸºæµåŠ¨ API Key</label>
                        <input type="password" id="aiSiliconflowApiKey" placeholder="è¾“å…¥ç¡…åŸºæµåŠ¨ API Key">
                    </div>
                    
                    <!-- è‡ªå®šä¹‰API é…ç½® -->
                    <div id="aiCustomConfig" class="input-group" style="display: none;">
                        <label>è‡ªå®šä¹‰API åœ°å€</label>
                        <input type="text" id="aiCustomApiUrl" placeholder="ä¾‹å¦‚: https://api.example.com/v1/chat/completions">
                        <label>è‡ªå®šä¹‰API Key</label>
                        <input type="password" id="aiCustomApiKey" placeholder="è¾“å…¥è‡ªå®šä¹‰API Key">
                        <label>è‡ªå®šä¹‰æ¨¡å‹åç§°</label>
                        <input type="text" id="aiCustomModelName" placeholder="ä¾‹å¦‚: gpt-4o">
                    </div>
                    
                    <div class="modal-buttons">
                        <button type="button" class="btn btn-cancel" onclick="closeAiSettingsModal()">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-confirm">ä¿å­˜è®¾ç½®</button>
                    </div>
                </form>
            </div>
        </div>
    
    <div class="modal" id="setRoleModal">
        <div class="modal-content">
            <h3>è®¾ç½®ç”¨æˆ·è§’è‰²</h3>
            <form onsubmit="event.preventDefault(); confirmSetRole();">
                <div class="input-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="setRoleUsername" readonly>
                </div>
                <div class="input-group">
                    <label>ç”¨æˆ·è§’è‰²</label>
                    <select id="setRoleValue" required>
                        <option value="user">æ™®é€šç”¨æˆ·</option>
                        <option value="superadmin">è¶…çº§ç®¡ç†å‘˜(SU)</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeSetRoleModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- éœ‡åŠ¨æ§åˆ¶æ¨¡æ€æ¡† -->
    <div class="modal" id="vibrateModal" style="display: none;">
        <div class="modal-content">
            <h3>æ§åˆ¶ç”¨æˆ·éœ‡åŠ¨</h3>
            <div id="vibrateSuccess" style="display: none; background-color: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                éœ‡åŠ¨æŒ‡ä»¤å·²å‘é€æˆåŠŸï¼
            </div>
            <div style="margin-bottom: 20px;">
                <p>ç”¨æˆ·: <strong id="vibrateUserName"></strong></p>
                <div style="margin-top: 15px;">
                    <label for="vibrateDuration">éœ‡åŠ¨æ—¶é•¿ (æ¯«ç§’):</label>
                    <input type="number" id="vibrateDuration" min="100" max="5000" value="500" style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div style="margin-top: 15px;">
                    <label for="vibrateIntensity">éœ‡åŠ¨å¼ºåº¦ (1-5):</label>
                    <input type="range" id="vibrateIntensity" min="1" max="5" value="1" style="width: 100%; margin-top: 5px;">
                    <div style="text-align: center; margin-top: 5px;">
                        <span id="vibrateIntensityValue">1</span>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeVibrateModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-confirm" onclick="sendVibrateCommand()">å‘é€éœ‡åŠ¨æŒ‡ä»¤</button>
            </div>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let users = [];
        let originalUsers = []; // å­˜å‚¨åŸå§‹ç”¨æˆ·åˆ—è¡¨ï¼Œç”¨äºæœç´¢è¿‡æ»¤
        let selectedSocketId = null;
        let originalFriendships = []; // å­˜å‚¨åŸå§‹å¥½å‹åˆ—è¡¨ï¼Œç”¨äºæœç´¢è¿‡æ»¤
        
        // é€šè¯ç›‘æ§ç›¸å…³
        let monitoredCalls = new Map(); // å­˜å‚¨æ­£åœ¨ç›‘æ§çš„é€šè¯: Map<callId, { initiator: socketId, recipient: socketId }>
        let callMediaStreams = new Map(); // å­˜å‚¨é€šè¯åª’ä½“æµ: Map<socketId, MediaStream>
        let mediaSourceMap = new Map(); // å­˜å‚¨MediaSource: Map<socketId, { mediaSource: MediaSource, sourceBuffer: SourceBuffer }>

        // å…¨å±€å˜é‡ï¼Œå°†åœ¨DOMåŠ è½½å®Œæˆååˆå§‹åŒ–
        let loginContainer, adminPanel, adminPassword, userList, userCount, messageCount, deletedMessageCount, systemMessage, renameModal, newUsername, messagesContainer, permissionsModal, permissionsForm, allowAudio, allowImage, allowFile, allowSendMessages, allowViewMessages, allowCall, allowAIChat, allowAddFriends, allowViewUsers, allowPrivateChat, allowOpenFriendsPage, allowRecallMessage, adminMessageModal, disguiseUsername, disguiseMessageType, disguiseMessage, disguiseColor, usersModal, selectedPermissionsSocketId;
        
        // è®¾ç½®å¥½å‹ä¸Šé™ç›¸å…³å…ƒç´ 
        const setMaxFriendsModal = document.getElementById('setMaxFriendsModal');
        const setMaxFriendsUsername = document.getElementById('setMaxFriendsUsername');
        const setMaxFriendsValue = document.getElementById('setMaxFriendsValue');
        let selectedMaxFriendsSocketId = null;
        
        // æˆ¿é—´ç®¡ç†ç›¸å…³å…ƒç´ 
        const roomName = document.getElementById('roomName');
        const roomPassword = document.getElementById('roomPassword');
        const roomMaxUsers = document.getElementById('roomMaxUsers');
        const roomList = document.getElementById('roomList');
        
        // ç¼–è¾‘æˆ¿é—´ç›¸å…³å…ƒç´ 
        const editRoomModal = document.getElementById('editRoomModal');
        const editRoomName = document.getElementById('editRoomName');
        const editRoomPassword = document.getElementById('editRoomPassword');
        let selectedEditRoomName = null;
        
        // æˆ¿é—´ç”¨æˆ·ç®¡ç†ç›¸å…³å…ƒç´ 
        const roomUsersModal = document.getElementById('roomUsersModal');
        const roomUsersTitle = document.getElementById('roomUsersTitle');
        const roomUsersList = document.getElementById('roomUsersList');
        let currentRoomName = null;
        let currentRoomUsers = [];
        
        // AIè®¾ç½®ç›¸å…³å…ƒç´ 
        const aiSettingsModal = document.getElementById('aiSettingsModal');
        const aiSettingsUsername = document.getElementById('aiSettingsUsername');
        const aiEnableCheckbox = document.getElementById('aiEnableCheckbox');
        const aiModelSelect = document.getElementById('aiModelSelect');
        const aiGlm4ApiKey = document.getElementById('aiGlm4ApiKey');
        const aiDeepseekModelName = document.getElementById('aiDeepseekModelName');
        const aiDeepseekApiKey = document.getElementById('aiDeepseekApiKey');
        const aiSiliconflowModelName = document.getElementById('aiSiliconflowModelName');
        const aiSiliconflowApiKey = document.getElementById('aiSiliconflowApiKey');
        const aiCustomApiUrl = document.getElementById('aiCustomApiUrl');
        const aiCustomApiKey = document.getElementById('aiCustomApiKey');
        const aiCustomModelName = document.getElementById('aiCustomModelName');
        let selectedAiSettingsSocketId = null;
        
        // æœç´¢ç›¸å…³å…ƒç´ 
        const userSearch = document.getElementById('userSearch');
        const roomSearch = document.getElementById('roomSearch');
        let originalRooms = []; // å­˜å‚¨åŸå§‹æˆ¿é—´åˆ—è¡¨ï¼Œç”¨äºæœç´¢è¿‡æ»¤
        
        // å¥½å‹ç®¡ç†ç›¸å…³å…ƒç´ 
        const friendSearch = document.getElementById('friendSearch');
        const friendsTabList = document.getElementById('friendsTabList');
        const friendsModal = document.getElementById('friendsModal');
        
        // æˆ¿é—´è¯¦ç»†é¡µç›¸å…³å…ƒç´ 
        const roomDetailsTitle = document.getElementById('roomDetailsTitle');
        const roomDetailsInfo = document.getElementById('roomDetailsInfo');
        const roomUserSearch = document.getElementById('roomUserSearch');
        const roomUserListElement = document.getElementById('roomUserList');
        const roomSystemMessage = document.getElementById('roomSystemMessage');
        let currentRoomDetails = null;
        let roomUserList = [];
        let originalRoomUsers = [];
        
        // æˆ¿é—´é€‰æ‹©åŠŸèƒ½
        const roomSelect = document.getElementById('roomSelect');
        roomSelect.addEventListener('change', () => {
            const selectedRoom = roomSelect.value;
            if (selectedRoom) {
                loadRoomMessages(selectedRoom);
            }
        });
        
        let userRefreshInterval = null;
        
        // å…¨å±€ç™»å½•å‡½æ•°
        window.login = function() {
            // ç¡®ä¿adminPasswordå…ƒç´ å·²åŠ è½½
            if (!adminPassword) {
                adminPassword = document.getElementById('adminPassword');
                if (!adminPassword) {
                    console.error('adminPassword å…ƒç´ æœªæ‰¾åˆ°');
                    alert('ç®¡ç†å‘˜å¯†ç è¾“å…¥æ¡†æœªæ‰¾åˆ°ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    return;
                }
            }
            const password = adminPassword.value;
            if (!password) {
                alert('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ');
                return;
            }
            console.log('å‘é€ç™»å½•è¯·æ±‚ï¼Œå¯†ç :', password);
            socket.emit('admin-login', { password: password });
        }





        socket.on('admin-login-success', () => {
            console.log('ç™»å½•æˆåŠŸ');
            loginContainer.classList.add('hidden');
            adminPanel.classList.add('active');
            loadMessages();
            loadRooms();
            loadFiles();
            // ä¸»åŠ¨è¯·æ±‚æœ€æ–°çš„ç”¨æˆ·åˆ—è¡¨
            socket.emit('admin-get-users');
            // ä¸»åŠ¨è¯·æ±‚ç”¨æˆ·è¡Œä¸ºåˆ†ææ•°æ®
            socket.emit('admin-get-user-analytics');
            
            // å¯åŠ¨ç”¨æˆ·åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨ï¼ˆæ¯ç§’ä¸€æ¬¡ï¼‰
            if (userRefreshInterval) {
                clearInterval(userRefreshInterval);
            }
            userRefreshInterval = setInterval(() => {
                socket.emit('admin-get-users');
                // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡ç”¨æˆ·è¡Œä¸ºåˆ†ææ•°æ®
                if (Math.random() < 0.2) { // 20%çš„æ¦‚ç‡ï¼Œå¹³å‡æ¯5ç§’æ‰§è¡Œä¸€æ¬¡
                    socket.emit('admin-get-user-analytics');
                }
            }, 1000);
        });
        
        socket.on('admin-login-error', (data) => {
            console.log('ç™»å½•å¤±è´¥:', data);
            alert('å¯†ç é”™è¯¯ï¼');
            adminPassword.value = '';
        });
        
        // ç›‘å¬æ–°æ¶ˆæ¯å¹¶è‡ªåŠ¨åˆ·æ–°
        socket.on('message', () => {
            const selectedRoom = roomSelect.value || 'main';
            loadRoomMessages(selectedRoom);
        });
        
        // ç›‘å¬æ¶ˆæ¯æ’¤å›å¹¶è‡ªåŠ¨åˆ·æ–°
        socket.on('message-recalled', () => {
            const selectedRoom = roomSelect.value || 'main';
            loadRoomMessages(selectedRoom);
        });

        function updateUsersWithSearch(data) {
            originalUsers = [...data.users]; // ä¿å­˜åŸå§‹æ•°æ®
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒçš„æœç´¢
            const searchTerm = userSearch ? userSearch.value.toLowerCase().trim() : '';
            if (searchTerm) {
                // å¦‚æœæœ‰æœç´¢ï¼Œåº”ç”¨ç›¸åŒçš„æœç´¢æ¡ä»¶è¿‡æ»¤æ–°çš„ç”¨æˆ·åˆ—è¡¨
                users = data.users.filter(user => {
                    const username = user.username.toLowerCase();
                    const roomName = (user.roomName || 'main').toLowerCase();
                    return username.includes(searchTerm) || roomName.includes(searchTerm);
                });
            } else {
                // å¦‚æœæ²¡æœ‰æœç´¢ï¼Œç›´æ¥ä½¿ç”¨å®Œæ•´åˆ—è¡¨
                users = [...data.users];
            }
            
            updateUserList();
        }
        
        socket.on('user-joined', (data) => {
            updateUsersWithSearch(data);
        });

        socket.on('user-left', (data) => {
            updateUsersWithSearch(data);
        });

        socket.on('user-renamed', (data) => {
            updateUsersWithSearch(data);
        });

        socket.on('user-permissions-changed', (data) => {
            updateUsersWithSearch(data);
        });
        
        // ç›‘å¬é€šè¯åª’ä½“æµï¼Œç”¨äºç®¡ç†å‘˜æŸ¥çœ‹åŒæ–¹ç”»é¢
        socket.on('call-media', (data) => {
            if (data.isAdmin && data.type === 'media-data') {
                handleCallMedia(data);
            }
        });

        socket.on('admin-messages', (data) => {
            displayMessages(data);
        });
        
        function updateRoomsWithSearch(rooms) {
            originalRooms = [...rooms]; // ä¿å­˜åŸå§‹æ•°æ®
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒçš„æœç´¢
            const searchTerm = roomSearch ? roomSearch.value.toLowerCase().trim() : '';
            if (searchTerm) {
                // å¦‚æœæœ‰æœç´¢ï¼Œåº”ç”¨ç›¸åŒçš„æœç´¢æ¡ä»¶è¿‡æ»¤æ–°çš„æˆ¿é—´åˆ—è¡¨
                const filteredRooms = rooms.filter(room => {
                    return room.roomName.toLowerCase().includes(searchTerm);
                });
                updateRoomList(filteredRooms);
            } else {
                // å¦‚æœæ²¡æœ‰æœç´¢ï¼Œç›´æ¥ä½¿ç”¨å®Œæ•´åˆ—è¡¨
                updateRoomList(rooms);
            }
        }
        
        // æˆ¿é—´ç®¡ç†ç›¸å…³çš„socketäº‹ä»¶
        socket.on('admin-rooms', (rooms) => {
            updateRoomsWithSearch(rooms);
            updateRoomSelect(rooms);
        });
        
        socket.on('admin-room-error', (data) => {
            alert(data.message);
        });
        
        socket.on('admin-room-messages', (data) => {
            const roomMessages = {
                active: data.messages.filter(m => !m.recalled),
                deleted: data.messages.filter(m => m.recalled)
            };
            displayMessages(roomMessages, true);
        });
        
        socket.on('admin-password-success', (data) => {
            alert(data.message);
        });
        
        socket.on('admin-password-error', (data) => {
            alert(data.message);
        });
        
        socket.on('friends-list', (friends) => {
            updateFriendsList(friends);
        });
        
        socket.on('admin-room-users', (data) => {
            // è·å–å½“å‰æˆ¿é—´çš„è¯¦ç»†ä¿¡æ¯
            const room = originalRooms.find(r => r.roomName === currentRoomName);
            if (room) {
                currentRoomDetails = room;
                
                // æ›´æ–°æˆ¿é—´è¯¦ç»†ä¿¡æ¯
                roomDetailsTitle.textContent = `${escapeHtml(room.roomName)} æˆ¿é—´è¯¦ç»†ä¿¡æ¯`;
                const passwordText = room.password ? 'æœ‰å¯†ç ' : 'æ— å¯†ç ';
                roomDetailsInfo.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>æˆ¿é—´å:</strong> ${escapeHtml(room.roomName)}
                        </div>
                        <div>
                            <strong>å¯†ç :</strong> ${passwordText}
                        </div>
                        <div>
                            <strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(room.createdAt).toLocaleString()}
                        </div>
                        <div>
                            <strong>æ›´æ–°æ—¶é—´:</strong> ${new Date(room.updatedAt).toLocaleString()}
                        </div>
                        <div>
                            <strong>ç”¨æˆ·æ•°é‡:</strong> ${data.users.length}
                        </div>
                        <div>
                            <strong>æœ€å¤§ç”¨æˆ·æ•°:</strong> ${room.settings.maxUsers}
                        </div>
                    </div>
                `;
                
                // æ›´æ–°æˆ¿é—´ç”¨æˆ·åˆ—è¡¨
                roomUserList = data.users;
                originalRoomUsers = [...data.users];
                updateRoomUserList();
            }
        });

        // æˆ¿é—´ç®¡ç†åŠŸèƒ½
        function createRoom() {
            const name = roomName.value.trim();
            const password = roomPassword.value.trim() || null;
            const maxUsers = parseInt(roomMaxUsers.value) || 100;
            
            if (name) {
                socket.emit('admin-create-room', { roomName: name, password: password, settings: { maxUsers: maxUsers } });
                roomName.value = '';
                roomPassword.value = '';
                roomMaxUsers.value = '100';
            }
        }
        
        function loadRooms() {
            socket.emit('admin-get-rooms');
        }
        
        function deleteRoom(roomName) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤æˆ¿é—´ ${roomName} å—ï¼Ÿæˆ¿é—´å†…çš„ç”¨æˆ·å°†è¢«è½¬ç§»åˆ°é»˜è®¤æˆ¿é—´ã€‚`)) {
                socket.emit('admin-delete-room', roomName);
            }
        }
        
        function updateRoom(roomName) {
            selectedEditRoomName = roomName;
            editRoomName.value = roomName;
            editRoomPassword.value = '';
            editRoomModal.classList.add('active');
        }
        
        function closeEditRoomModal() {
            editRoomModal.classList.remove('active');
            selectedEditRoomName = null;
        }
        
        function confirmEditRoom() {
            const password = editRoomPassword.value.trim() || null;
            
            if (selectedEditRoomName) {
                socket.emit('admin-update-room', {
                    roomName: selectedEditRoomName,
                    updates: { password: password }
                });
                closeEditRoomModal();
            }
        }
        
        function updateRoomList(rooms) {
            if (rooms.length === 0) {
                roomList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ </div>
                        <div>æš‚æ— æˆ¿é—´</div>
                    </div>`;
                return;
            }
            
            roomList.innerHTML = rooms.map(room => {
                const passwordText = room.password ? 'æœ‰å¯†ç ' : 'æ— å¯†ç ';
                const userCount = room.users.length;
                const isDefaultRoom = room.roomName === 'main';
                const defaultBadge = isDefaultRoom ? '<span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-left: 5px;">é»˜è®¤</span>' : '';
                
                return `
                    <div class="user-item">
                        <div class="user-info">
                            <div class="user-color" style="background: #667eea;"></div>
                            <div>
                                <div class="user-name">${escapeHtml(room.roomName)}${defaultBadge}</div>
                                <small style="color: #666;">${passwordText} | ${userCount} ä¸ªç”¨æˆ· | åˆ›å»ºäº: ${new Date(room.createdAt).toLocaleString()}</small>
                            </div>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-info btn-sm" onclick="updateRoom('${room.roomName}')">ç¼–è¾‘</button>
                            <button class="btn btn-primary btn-sm" onclick="viewRoomUsers('${room.roomName}')">æŸ¥çœ‹ç”¨æˆ·</button>
                            ${!isDefaultRoom ? `<button class="btn btn-danger btn-sm" onclick="deleteRoom('${room.roomName}')">åˆ é™¤</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateRoomSelect(rooms) {
            roomSelect.innerHTML = '<option value="">é€‰æ‹©æˆ¿é—´</option>';
            rooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room.roomName;
                option.textContent = room.roomName;
                roomSelect.appendChild(option);
            });
            
            roomSelect.value = 'main';
        }
        
        function viewRoomUsers(roomName) {
            currentRoomName = roomName;
            
            // è¯·æ±‚è·å–è¯¥æˆ¿é—´çš„ç”¨æˆ·åˆ—è¡¨
            socket.emit('admin-get-room-users', roomName);
            
            // åˆ‡æ¢åˆ°æˆ¿é—´è¯¦ç»†é¡µæ ‡ç­¾
            switchTab('roomDetails');
        }
        
        function closeRoomUsersModal() {
            roomUsersModal.classList.remove('active');
            currentRoomName = null;
            currentRoomUsers = [];
        }
        
        function updateRoomUsersList(users) {
            // å…¼å®¹åŸæœ‰æ¨¡æ€æ¡†æ˜¾ç¤º
            if (roomUsersModal.classList.contains('active')) {
                currentRoomUsers = users;
                
                if (users.length === 0) {
                    roomUsersList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ‘¥</div>
                            <div>è¯¥æˆ¿é—´æš‚æ— ç”¨æˆ·</div>
                        </div>`;
                    return;
                }
                
                roomUsersList.innerHTML = users.map(user => {
                    return `
                        <div class="user-item">
                            <div class="user-info">
                                <div class="user-color" style="background: ${user.color}"></div>
                                <div class="user-name">${escapeHtml(user.username)}</div>
                            </div>
                            <div class="user-actions">
                                <button class="btn btn-rename" onclick="openRoomUserRenameModal('${user.socketId}', '${user.username}')">é‡å‘½å</button>
                                <button class="btn btn-kick" onclick="roomKickUser('${user.socketId}', '${user.username}')">è¸¢å‡ºæˆ¿é—´</button>
                                <button class="btn btn-permissions" onclick="openRoomUserPermissionsModal('${user.socketId}')">æƒé™</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function updateRoomUserList() {
            if (roomUserList.length === 0) {
                roomUserListElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‘¥</div>
                        <div>è¯¥æˆ¿é—´æš‚æ— ç”¨æˆ·</div>
                    </div>`;
                return;
            }
            
            roomUserListElement.innerHTML = roomUserList.map(user => {
                return `
                    <div class="user-item">
                        <div class="user-info">
                            <div class="user-color" style="background: ${user.color}"></div>
                            <div class="user-name">${escapeHtml(user.username)}</div>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-rename" onclick="openRoomUserRenameModal('${user.socketId}', '${user.username}')">é‡å‘½å</button>
                            <button class="btn btn-kick" onclick="roomKickUser('${user.socketId}', '${user.username}')">è¸¢å‡ºæˆ¿é—´</button>
                            <button class="btn btn-permissions" onclick="openRoomUserPermissionsModal('${user.socketId}')">æƒé™</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function filterRoomUsers() {
            const searchTerm = roomUserSearch.value.toLowerCase().trim();
            
            if (!searchTerm) {
                // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰æˆ¿é—´ç”¨æˆ·
                roomUserList = [...originalRoomUsers];
                updateRoomUserList();
                return;
            }
            
            // æ ¹æ®ç”¨æˆ·åè¿‡æ»¤æˆ¿é—´å†…çš„ç”¨æˆ·
            roomUserList = originalRoomUsers.filter(user => {
                const username = user.username.toLowerCase();
                return username.includes(searchTerm);
            });
            
            updateRoomUserList();
        }
        
        // å‘é€æˆ¿é—´ç³»ç»Ÿæ¶ˆæ¯
        function sendRoomSystemMessage() {
            const message = roomSystemMessage.value.trim();
            if (message && currentRoomName) {
                socket.emit('admin-room-system-message', {
                    roomName: currentRoomName,
                    message: message
                });
                roomSystemMessage.value = '';
                alert('ç³»ç»Ÿæ¶ˆæ¯å·²å‘é€åˆ°æˆ¿é—´ ' + currentRoomName);
            }
        }
        
        // æ‰“å¼€æˆ¿é—´ä¼ªè£…å‘æ¶ˆæ¯æ¨¡æ€æ¡†
        function openRoomAdminMessageModal() {
            if (currentRoomName) {
                openAdminMessageModal();
            } else {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæˆ¿é—´');
            }
        }
        
        function roomKickUser(socketId, username) {
            if (confirm(`ç¡®å®šè¦å°† ${escapeHtml(username)} è¸¢å‡ºæˆ¿é—´ ${escapeHtml(currentRoomName)} å—ï¼Ÿ`)) {
                socket.emit('admin-room-kick-user', {
                    roomName: currentRoomName,
                    socketId: socketId
                });
                
                // é‡æ–°è·å–æˆ¿é—´ç”¨æˆ·åˆ—è¡¨
                socket.emit('admin-get-room-users', currentRoomName);
            }
        }
        
        // ä¸ºæˆ¿é—´è¯¦ç»†é¡µæ·»åŠ è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
        let roomDetailsRefreshInterval = null;
        // ä¸ºç¦è¨€åˆ—è¡¨æ·»åŠ è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
        let mutedUsersRefreshInterval = null;
        
        // åœ¨åˆ‡æ¢åˆ°æˆ¿é—´è¯¦ç»†é¡µæ—¶å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.getAttribute('onclick') === `switchTab('${tabName}')`) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'messages') {
                loadMessages();
            } else if (tabName === 'rooms') {
                loadRooms();
            } else if (tabName === 'roomDetails') {
                // å¯åŠ¨æˆ¿é—´è¯¦ç»†é¡µçš„è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯ç§’ä¸€æ¬¡ï¼‰
                if (roomDetailsRefreshInterval) {
                    clearInterval(roomDetailsRefreshInterval);
                }
                if (currentRoomName) {
                    roomDetailsRefreshInterval = setInterval(() => {
                        socket.emit('admin-get-room-users', currentRoomName);
                    }, 1000);
                }
            } else if (tabName === 'mutedUsers') {
                loadMutedUsers();
                // å¯åŠ¨ç¦è¨€åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯2ç§’ä¸€æ¬¡ï¼‰
                if (mutedUsersRefreshInterval) {
                    clearInterval(mutedUsersRefreshInterval);
                }
                mutedUsersRefreshInterval = setInterval(() => {
                    loadMutedUsers();
                }, 2000);
            } else if (tabName === 'friends') {
                loadFriends();
            } else if (tabName === 'settingsManagement') {
                // åˆ‡æ¢åˆ°ç”¨æˆ·è®¾ç½®ç®¡ç†æ ‡ç­¾é¡µæ—¶ï¼ŒåŠ è½½ç”¨æˆ·åˆ—è¡¨
                loadUsersForSettings();
            } else if (tabName === 'systemManagement') {
                // åˆ‡æ¢åˆ°ç³»ç»Ÿç®¡ç†æ ‡ç­¾é¡µæ—¶ï¼Œå¯åŠ¨è‡ªåŠ¨åˆ·æ–°æœåŠ¡å™¨ä¿¡æ¯ï¼ˆæ¯ç§’ä¸€æ¬¡ï¼‰
                startServerInfoRefresh();
            } else if (tabName === 'globalSettings') {
                // å…¨ä½“è®¾ç½®æ ‡ç­¾é¡µä¸éœ€è¦ç‰¹æ®Šå¤„ç†
            } else if (tabName === 'viruses') {
                // åˆ‡æ¢åˆ°ç—…æ¯’ç®¡ç†æ ‡ç­¾é¡µæ—¶ï¼ŒåŠ è½½ç—…æ¯’åˆ—è¡¨
                loadVirusList();
            } else {
                // å¦‚æœåˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾é¡µï¼Œåœæ­¢æˆ¿é—´è¯¦ç»†é¡µã€ç¦è¨€åˆ—è¡¨å’ŒæœåŠ¡å™¨ä¿¡æ¯çš„è‡ªåŠ¨åˆ·æ–°
                if (roomDetailsRefreshInterval) {
                    clearInterval(roomDetailsRefreshInterval);
                    roomDetailsRefreshInterval = null;
                }
                if (mutedUsersRefreshInterval) {
                    clearInterval(mutedUsersRefreshInterval);
                    mutedUsersRefreshInterval = null;
                }
                // ç¦»å¼€ç³»ç»Ÿç®¡ç†æ ‡ç­¾é¡µæ—¶ï¼Œåœæ­¢è‡ªåŠ¨åˆ·æ–°æœåŠ¡å™¨ä¿¡æ¯
                stopServerInfoRefresh();
            }
        }

        // å­˜å‚¨CSRFä»¤ç‰Œ
        let csrfToken = '';

        // è·å–CSRFä»¤ç‰Œ
        async function getCsrfToken() {
            try {
                const response = await fetch('/api/csrf-token');
                const data = await response.json();
                csrfToken = data.csrfToken;
                return csrfToken;
            } catch (error) {
                console.error('è·å–CSRFä»¤ç‰Œå¤±è´¥:', error);
                alert('è·å–CSRFä»¤ç‰Œå¤±è´¥');
                return null;
            }
        }

        // åŠ è½½ç—…æ¯’æ–‡ä»¶åˆ—è¡¨
        function loadVirusList() {
            fetch('/api/viruses')
                .then(response => response.json())
                .then(data => {
                    const virusList = document.getElementById('virusList');
                    
                    if (data.length === 0) {
                        virusList.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ¦ </div>
                                <div>æš‚æ— ç—…æ¯’æ–‡ä»¶</div>
                            </div>
                        `;
                        return;
                    }
                    
                    virusList.innerHTML = data.map(virus => `
                        <div class="file-item">
                            <div class="file-info">
                                <div class="file-icon">ğŸ¦ </div>
                                <div class="file-details">
                                    <div class="file-name">${virus.filename}</div>
                                    <div class="file-meta">
                                        å¤§å°: ${(virus.size / 1024).toFixed(2)} KB | 
                                        ä¸Šä¼ æ—¶é—´: ${new Date(virus.uploadTime).toLocaleString()} | 
                                        ä¸Šä¼ IP: ${virus.uploaderIp}
                                    </div>
                                    <div class="file-meta">
                                        æ‰«æç»“æœ: ${virus.scanResult.message} | 
                                        æ¶æ„: ${virus.scanResult.stats?.malicious || 0} | 
                                        å¯ç–‘: ${virus.scanResult.stats?.suspicious || 0}
                                    </div>
                                </div>
                            </div>
                            <div class="file-actions">
                                <button class="btn btn-success btn-sm" onclick="allowVirusFile('${virus.id}', '${virus.filename}')">å…è®¸</button>
                                <button class="btn btn-warning btn-sm" onclick="quarantineVirusFile('${virus.id}', '${virus.filename}')">éš”ç¦»</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteVirusFile('${virus.id}', '${virus.filename}')">åˆ é™¤</button>
                                <button class="btn btn-info btn-sm" onclick="banUserByVirus('${virus.id}', '${virus.uploaderIp}')">å°ç¦IP</button>
                            </div>
                        </div>
                    `).join('');
                })
                .catch(error => {
                    console.error('åŠ è½½ç—…æ¯’åˆ—è¡¨å¤±è´¥:', error);
                    alert('åŠ è½½ç—…æ¯’åˆ—è¡¨å¤±è´¥');
                });
        }

        // å…è®¸ç—…æ¯’æ–‡ä»¶
        async function allowVirusFile(id, filename) {
            if (confirm(`ç¡®å®šè¦å…è®¸æ–‡ä»¶ "${filename}" å—ï¼Ÿ`)) {
                // ç¡®ä¿æœ‰CSRFä»¤ç‰Œ
                if (!csrfToken) {
                    await getCsrfToken();
                }
                
                fetch(`/api/viruses/allow/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        loadVirusList();
                    } else {
                        alert('æ“ä½œå¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('å…è®¸ç—…æ¯’æ–‡ä»¶å¤±è´¥:', error);
                    alert('å…è®¸ç—…æ¯’æ–‡ä»¶å¤±è´¥');
                });
            }
        }

        // éš”ç¦»ç—…æ¯’æ–‡ä»¶
        async function quarantineVirusFile(id, filename) {
            if (confirm(`ç¡®å®šè¦éš”ç¦»æ–‡ä»¶ "${filename}" å—ï¼Ÿ`)) {
                // ç¡®ä¿æœ‰CSRFä»¤ç‰Œ
                if (!csrfToken) {
                    await getCsrfToken();
                }
                
                fetch(`/api/viruses/quarantine/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        loadVirusList();
                    } else {
                        alert('æ“ä½œå¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('éš”ç¦»ç—…æ¯’æ–‡ä»¶å¤±è´¥:', error);
                    alert('éš”ç¦»ç—…æ¯’æ–‡ä»¶å¤±è´¥');
                });
            }
        }

        // åˆ é™¤ç—…æ¯’æ–‡ä»¶
        async function deleteVirusFile(id, filename) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${filename}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`)) {
                // ç¡®ä¿æœ‰CSRFä»¤ç‰Œ
                if (!csrfToken) {
                    await getCsrfToken();
                }
                
                fetch(`/api/viruses/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        loadVirusList();
                    } else {
                        alert('æ“ä½œå¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('åˆ é™¤ç—…æ¯’æ–‡ä»¶å¤±è´¥:', error);
                    alert('åˆ é™¤ç—…æ¯’æ–‡ä»¶å¤±è´¥');
                });
            }
        }

        // ä¸€é”®å°ç¦ç”¨æˆ·ï¼ˆé€šè¿‡ç—…æ¯’æ–‡ä»¶ï¼‰
        async function banUserByVirus(id, ip) {
            if (confirm(`ç¡®å®šè¦å°ç¦IP "${ip}" å—ï¼Ÿ`)) {
                // ç¡®ä¿æœ‰CSRFä»¤ç‰Œ
                if (!csrfToken) {
                    await getCsrfToken();
                }
                
                fetch(`/api/viruses/ban/${id}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        loadVirusList();
                    } else {
                        alert('æ“ä½œå¤±è´¥: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('å°ç¦ç”¨æˆ·å¤±è´¥:', error);
                    alert('å°ç¦ç”¨æˆ·å¤±è´¥');
                });
            }
        }

        // åˆ é™¤æ‰€æœ‰ç—…æ¯’æ–‡ä»¶
        async function deleteAllViruses() {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰ç—…æ¯’æ–‡ä»¶å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                // ç¡®ä¿æœ‰CSRFä»¤ç‰Œ
                if (!csrfToken) {
                    await getCsrfToken();
                }
                
                // è¿™é‡Œéœ€è¦å®ç°åˆ é™¤æ‰€æœ‰ç—…æ¯’æ–‡ä»¶çš„é€»è¾‘
                // ç”±äºæˆ‘ä»¬æ²¡æœ‰ä¸“é—¨çš„APIç«¯ç‚¹ï¼Œå¯ä»¥é€šè¿‡éå†åˆ é™¤æ¯ä¸ªæ–‡ä»¶
                fetch('/api/viruses')
                    .then(response => response.json())
                    .then(data => {
                        const deletePromises = data.map(virus => 
                            fetch(`/api/viruses/${virus.id}`, {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRF-Token': csrfToken
                                }
                            })
                        );
                        
                        return Promise.all(deletePromises);
                    })
                    .then(() => {
                        alert('æ‰€æœ‰ç—…æ¯’æ–‡ä»¶å·²åˆ é™¤');
                        loadVirusList();
                    })
                    .catch(error => {
                        console.error('åˆ é™¤æ‰€æœ‰ç—…æ¯’æ–‡ä»¶å¤±è´¥:', error);
                        alert('åˆ é™¤æ‰€æœ‰ç—…æ¯’æ–‡ä»¶å¤±è´¥');
                    });
            }
        }

        // åŠ è½½ç—…æ¯’æ£€æµ‹çŠ¶æ€
        function loadVirusScanStatus() {
            fetch('/api/viruses/status')
                .then(response => response.json())
                .then(data => {
                    const toggle = document.getElementById('virusScanToggle');
                    const status = document.getElementById('virusScanStatus');
                    
                    if (toggle && status) {
                        toggle.checked = data.enabled;
                        status.textContent = data.enabled ? 'å¯ç”¨ä¸­' : 'å·²ç¦ç”¨';
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½ç—…æ¯’æ£€æµ‹çŠ¶æ€å¤±è´¥:', error);
                });
        }

        // åˆ‡æ¢ç—…æ¯’æ£€æµ‹çŠ¶æ€
        async function toggleVirusScan() {
            const toggle = document.getElementById('virusScanToggle');
            const status = document.getElementById('virusScanStatus');
            const enabled = toggle.checked;
            
            // ç¡®ä¿æœ‰CSRFä»¤ç‰Œ
            if (!csrfToken) {
                await getCsrfToken();
            }
            
            fetch('/api/viruses/status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify({ enabled: enabled })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    status.textContent = data.enabled ? 'å¯ç”¨ä¸­' : 'å·²ç¦ç”¨';
                    alert(data.message);
                } else {
                    // æ¢å¤åŸæ¥çš„çŠ¶æ€
                    toggle.checked = !enabled;
                    status.textContent = !enabled ? 'å¯ç”¨ä¸­' : 'å·²ç¦ç”¨';
                    alert('æ“ä½œå¤±è´¥: ' + data.error);
                }
            })
            .catch(error => {
                console.error('åˆ‡æ¢ç—…æ¯’æ£€æµ‹çŠ¶æ€å¤±è´¥:', error);
                // æ¢å¤åŸæ¥çš„çŠ¶æ€
                toggle.checked = !enabled;
                status.textContent = !enabled ? 'å¯ç”¨ä¸­' : 'å·²ç¦ç”¨';
                alert('åˆ‡æ¢ç—…æ¯’æ£€æµ‹çŠ¶æ€å¤±è´¥');
            });
        }

        // é¡µé¢åŠ è½½æ—¶è·å–CSRFä»¤ç‰Œå’Œç—…æ¯’æ£€æµ‹çŠ¶æ€
        document.addEventListener('DOMContentLoaded', function() {
            getCsrfToken();
            loadVirusScanStatus();
        });

        // åˆ‡æ¢åˆ°ç—…æ¯’ç®¡ç†æ ‡ç­¾é¡µæ—¶åŠ è½½ç—…æ¯’åˆ—è¡¨å’ŒçŠ¶æ€
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.getAttribute('onclick') === `switchTab('${tabName}')`) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'viruses') {
                loadVirusList();
                loadVirusScanStatus();
            }
        }

        // å¯¼å‡ºç—…æ¯’åˆ—è¡¨
        function exportVirusList() {
            fetch('/api/viruses')
                .then(response => response.json())
                .then(data => {
                    const csvContent = "data:text/csv;charset=utf-8," +
                        "ID,æ–‡ä»¶å,å¤§å°,ä¸Šä¼ IP,ä¸Šä¼ æ—¶é—´,æ‰«æç»“æœ,æ¶æ„æ•°,å¯ç–‘æ•°\n" +
                        data.map(virus => {
                            return [
                                virus.id,
                                `"${virus.filename}"`,
                                virus.size,
                                virus.uploaderIp,
                                virus.uploadTime,
                                `"${virus.scanResult.message}"`,
                                virus.scanResult.stats?.malicious || 0,
                                virus.scanResult.stats?.suspicious || 0
                            ].join(',');
                        }).join('\n');
                    
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `virus-list-${new Date().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                })
                .catch(error => {
                    console.error('å¯¼å‡ºç—…æ¯’åˆ—è¡¨å¤±è´¥:', error);
                    alert('å¯¼å‡ºç—…æ¯’åˆ—è¡¨å¤±è´¥');
                });
        }
        
        function openRoomUserRenameModal(socketId, currentName) {
            selectedSocketId = socketId;
            newUsername.value = currentName;
            renameModal.classList.add('active');
            newUsername.focus();
        }
        
        function confirmRename() {
            const newName = newUsername.value.trim();
            if (newName && selectedSocketId) {
                if (currentRoomName) {
                    // å¦‚æœåœ¨æˆ¿é—´ç”¨æˆ·åˆ—è¡¨ä¸­é‡å‘½åï¼Œä½¿ç”¨æˆ¿é—´å†…é‡å‘½ååŠŸèƒ½
                    socket.emit('admin-room-rename-user', {
                        roomName: currentRoomName,
                        socketId: selectedSocketId,
                        newName: newName
                    });
                    
                    // é‡æ–°è·å–æˆ¿é—´ç”¨æˆ·åˆ—è¡¨
                    socket.emit('admin-get-room-users', currentRoomName);
                } else {
                    // å¦åˆ™ä½¿ç”¨å…¨å±€é‡å‘½ååŠŸèƒ½
                    socket.emit('admin-rename-user', {
                        socketId: selectedSocketId,
                        newName: newName
                    });
                }
                
                closeRenameModal();
            }
        }
        
        function openRoomUserPermissionsModal(socketId) {
            selectedPermissionsSocketId = socketId;
            const user = currentRoomUsers.find(u => u.socketId === socketId);
            if (user) {
                allowAudio.checked = user.permissions.allowAudio;
                allowImage.checked = user.permissions.allowImage;
                allowFile.checked = user.permissions.allowFile;
                allowSendMessages.checked = user.permissions.allowSendMessages;
                allowViewMessages.checked = user.permissions.allowViewMessages;
                allowCall.checked = user.permissions.allowCall;
                allowAIChat.checked = user.permissions.allowAIChat ?? false;
                allowAddFriends.checked = user.permissions.allowAddFriends ?? true;
                allowViewUsers.checked = user.permissions.allowViewUsers ?? true;
                allowPrivateChat.checked = user.permissions.allowPrivateChat ?? true;
                allowOpenFriendsPage.checked = user.permissions.allowOpenFriendsPage ?? true;
                allowRecallMessage.checked = user.permissions.allowRecallMessage ?? true;
                allowAIChat.checked = user.permissions.allowAIChat ?? false;
            }
            permissionsModal.classList.add('active');
        }
        
        function openPermissionsModal(socketId) {
            selectedPermissionsSocketId = socketId;
            const user = users.find(u => u.socketId === socketId);
            if (user) {
                allowAudio.checked = user.permissions.allowAudio;
                allowImage.checked = user.permissions.allowImage;
                allowFile.checked = user.permissions.allowFile;
                allowSendMessages.checked = user.permissions.allowSendMessages;
                allowViewMessages.checked = user.permissions.allowViewMessages;
                allowCall.checked = user.permissions.allowCall;
                allowAddFriends.checked = user.permissions.allowAddFriends ?? true;
                allowViewUsers.checked = user.permissions.allowViewUsers ?? true;
                allowPrivateChat.checked = user.permissions.allowPrivateChat ?? true;
                allowOpenFriendsPage.checked = user.permissions.allowOpenFriendsPage ?? true;
                allowRecallMessage.checked = user.permissions.allowRecallMessage ?? true;
            }
            permissionsModal.classList.add('active');
        }
        
        function closePermissionsModal() {
            permissionsModal.classList.remove('active');
            selectedPermissionsSocketId = null;
        }
        
        function confirmPermissions() {
            if (selectedPermissionsSocketId) {
                if (currentRoomName) {
                    // å¦‚æœåœ¨æˆ¿é—´ç”¨æˆ·åˆ—è¡¨ä¸­è®¾ç½®æƒé™ï¼Œä½¿ç”¨æˆ¿é—´å†…æƒé™è®¾ç½®åŠŸèƒ½
                    socket.emit('admin-room-set-permissions', {
                        roomName: currentRoomName,
                        socketId: selectedPermissionsSocketId,
                        permissions: {
                            allowAudio: allowAudio.checked,
                            allowImage: allowImage.checked,
                            allowFile: allowFile.checked,
                            allowSendMessages: allowSendMessages.checked,
                            allowViewMessages: allowViewMessages.checked,
                            allowCall: allowCall.checked,
                            allowAIChat: allowAIChat.checked,
                            allowAddFriends: allowAddFriends.checked,
                            allowViewUsers: allowViewUsers.checked,
                            allowPrivateChat: allowPrivateChat.checked,
                            allowOpenFriendsPage: allowOpenFriendsPage.checked,
                            allowRecallMessage: allowRecallMessage.checked
                        }
                    });
                    
                    // é‡æ–°è·å–æˆ¿é—´ç”¨æˆ·åˆ—è¡¨
                    socket.emit('admin-get-room-users', currentRoomName);
                } else {
                    // å¦åˆ™ä½¿ç”¨å…¨å±€æƒé™è®¾ç½®åŠŸèƒ½
                    socket.emit('admin-set-permissions', {
                        socketId: selectedPermissionsSocketId,
                        permissions: {
                            allowAudio: allowAudio.checked,
                            allowImage: allowImage.checked,
                            allowFile: allowFile.checked,
                            allowSendMessages: allowSendMessages.checked,
                            allowViewMessages: allowViewMessages.checked,
                            allowCall: allowCall.checked,
                            allowAIChat: allowAIChat.checked,
                            allowAddFriends: allowAddFriends.checked,
                            allowViewUsers: allowViewUsers.checked,
                            allowPrivateChat: allowPrivateChat.checked,
                            allowOpenFriendsPage: allowOpenFriendsPage.checked,
                            allowRecallMessage: allowRecallMessage.checked
                        }
                    });
                }
                
                closePermissionsModal();
            }
        }

        function updateUserList() {
            userCount.textContent = users.length;
            
            if (users.length === 0) {
                userList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‘¥</div>
                        <div>æš‚æ— åœ¨çº¿ç”¨æˆ·</div>
                    </div>`;
                return;
            }

            userList.innerHTML = users.map(user => `
                <div class="user-item">
                    <div style="margin-right: 15px;">
                        <input type="checkbox" class="user-checkbox" value="${user.socketId}" style="width: 18px; height: 18px;">
                    </div>
                    <div class="user-info">
                        <div class="user-color" style="background: ${user.color}"></div>
                        <div>
                            <div class="user-name">
                                ${escapeHtml(user.username)}
                                ${user.role === 'superadmin' ? '<span style="color: #ff6b6b; margin-left: 5px;">SU</span>' : ''}
                            </div>
                            <small style="color: #666;">æˆ¿é—´: ${escapeHtml(user.roomName || 'main')}</small>
                            <small style="color: #666; margin-left: 10px;">è§’è‰²: ${user.role || 'user'}</small>
                            <small style="color: #666; margin-left: 10px;">AI: ${user.permissions?.allowAIChat ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}</small>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-rename" onclick="openRenameModal('${user.socketId}')">é‡å‘½å</button>
                        <button class="btn btn-kick" onclick="kickUser('${user.socketId}')">è¸¢å‡º</button>
                        <button class="btn btn-permissions" onclick="openPermissionsModal('${user.socketId}')">æƒé™</button>
                        <button class="btn btn-role" onclick="openSetRoleModal('${user.socketId}', '${escapeHtml(user.username)}', '${user.role || 'user'}')">è§’è‰²</button>
                        <button class="btn btn-primary" onclick="openSetMaxFriendsModal('${user.socketId}', '${escapeHtml(user.username)}')">å¥½å‹ä¸Šé™</button>
                        <button class="btn btn-info" onclick="openPopupModal('${user.socketId}', '${escapeHtml(user.username)}')">å¼¹çª—</button>
                        <button class="btn btn-success" onclick="openChangeTitleModal('${user.socketId}', '${escapeHtml(user.username)}')">æ›´æ”¹æ ‡é¢˜</button>
                        <button class="btn btn-secondary" onclick="openAiSettingsModal('${user.socketId}', '${escapeHtml(user.username)}')">AIè®¾ç½®</button>
                        <button class="btn btn-info" onclick="openVibrateModal('${user.socketId}', '${escapeHtml(user.username)}')">éœ‡åŠ¨</button>
                    </div>
                </div>
            `).join('');
            
            // æ·»åŠ å¤é€‰æ¡†ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.user-checkbox').forEach(checkbox => {
                checkbox.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
        }
        
        function kickUser(socketId) {
            if (confirm('ç¡®å®šè¦è¸¢å‡ºè¯¥ç”¨æˆ·å—ï¼Ÿ')) {
                socket.emit('admin-kick-user', socketId);
            }
        }

        function openRenameModal(socketId) {
            selectedSocketId = socketId;
            newUsername.value = '';
            usersModal.classList.remove('active');
            renameModal.classList.add('active');
            newUsername.focus();
        }

        function closeRenameModal() {
            renameModal.classList.remove('active');
            selectedSocketId = null;
        }

        function openAdminMessageModal() {
            adminMessageModal.classList.add('active');
            disguiseUsername.focus();
        }

        function closeAdminMessageModal() {
            adminMessageModal.classList.remove('active');
            disguiseUsername.value = '';
            disguiseMessage.value = '';
        }
        
        function openUsersModal() {
            usersModal.classList.add('active');
        }
        
        function closeUsersModal() {
            usersModal.classList.remove('active');
        }

        // è®¾ç½®å¥½å‹ä¸Šé™ç›¸å…³å‡½æ•°
        function openSetMaxFriendsModal(socketId, username) {
            selectedMaxFriendsSocketId = socketId;
            setMaxFriendsUsername.value = username;
            setMaxFriendsValue.value = '5'; // é»˜è®¤å€¼
            setMaxFriendsModal.classList.add('active');
        }

        function closeSetMaxFriendsModal() {
            setMaxFriendsModal.classList.remove('active');
            selectedMaxFriendsSocketId = null;
        }

        function saveMaxFriends() {
            const maxFriends = parseInt(setMaxFriendsValue.value);
            if (selectedMaxFriendsSocketId && !isNaN(maxFriends)) {
                socket.emit('admin-set-user-max-friends', {
                    userId: selectedMaxFriendsSocketId,
                    maxFriends: maxFriends
                });
                closeSetMaxFriendsModal();
            }
        }

        // å¼¹çª—ç›¸å…³å‡½æ•°
        function openPopupModal(socketId, username) {
            selectedSocketId = socketId;
            document.getElementById('popupUsername').value = username;
            usersModal.classList.remove('active');
            document.getElementById('popupModal').classList.add('active');
            document.getElementById('popupMessage').focus();
        }
        
        function closePopupModal() {
            document.getElementById('popupModal').classList.remove('active');
            selectedSocketId = null;
        }
        
        function sendPopup() {
            const message = document.getElementById('popupMessage').value.trim();
            if (message) {
                socket.emit('admin-popup', {
                    socketId: selectedSocketId,
                    message: message
                });
                closePopupModal();
            }
        }
        
        // æ›´æ”¹æ ‡é¢˜ç›¸å…³å‡½æ•°
        function openChangeTitleModal(socketId, username) {
            selectedSocketId = socketId;
            document.getElementById('changeTitleUsername').value = username;
            usersModal.classList.remove('active');
            document.getElementById('changeTitleModal').classList.add('active');
            document.getElementById('changeTitleContent').focus();
        }
        
        function closeChangeTitleModal() {
            document.getElementById('changeTitleModal').classList.remove('active');
            selectedSocketId = null;
        }
        
        function changeTitle() {
            const title = document.getElementById('changeTitleContent').value.trim();
            if (title) {
                socket.emit('admin-change-title', {
                    socketId: selectedSocketId,
                    title: title
                });
                closeChangeTitleModal();
            }
        }
        
        // AIè®¾ç½®ç›¸å…³å‡½æ•°
        function openAiSettingsModal(socketId, username) {
            selectedAiSettingsSocketId = socketId;
            aiSettingsUsername.value = username;
            aiEnableCheckbox.checked = false;
            aiModelSelect.value = 'glm4';
            aiGlm4ApiKey.value = '';
            aiDeepseekModelName.value = '';
            aiDeepseekApiKey.value = '';
            aiSiliconflowModelName.value = '';
            aiSiliconflowApiKey.value = '';
            aiCustomApiUrl.value = '';
            aiCustomApiKey.value = '';
            aiCustomModelName.value = '';
            
            // æ˜¾ç¤ºGLM-4é…ç½®ï¼Œéšè—å…¶ä»–é…ç½®
            document.getElementById('aiGlm4Config').style.display = 'block';
            document.getElementById('aiDeepseekConfig').style.display = 'none';
            document.getElementById('aiSiliconflowConfig').style.display = 'none';
            document.getElementById('aiCustomConfig').style.display = 'none';
            
            aiSettingsModal.classList.add('active');
        }
        
        function closeAiSettingsModal() {
            aiSettingsModal.classList.remove('active');
            selectedAiSettingsSocketId = null;
        }
        
        function saveAiSettings() {
            if (selectedAiSettingsSocketId) {
                const aiSettings = {
                    enable: aiEnableCheckbox.checked,
                    model: aiModelSelect.value,
                    glm4: {
                        apiKey: aiGlm4ApiKey.value
                    },
                    deepseek: {
                        modelName: aiDeepseekModelName.value,
                        apiKey: aiDeepseekApiKey.value
                    },
                    siliconflow: {
                        modelName: aiSiliconflowModelName.value,
                        apiKey: aiSiliconflowApiKey.value
                    },
                    custom: {
                        apiUrl: aiCustomApiUrl.value,
                        apiKey: aiCustomApiKey.value,
                        modelName: aiCustomModelName.value
                    }
                };
                
                socket.emit('admin-set-ai-settings', {
                    socketId: selectedAiSettingsSocketId,
                    aiSettings: aiSettings
                });
                
                closeAiSettingsModal();
            }
        }
        
        // æ¨¡å‹é€‰æ‹©å˜æ›´æ—¶æ˜¾ç¤º/éšè—å¯¹åº”é…ç½®
        document.getElementById('aiModelSelect').addEventListener('change', function() {
            const model = this.value;
            
            // éšè—æ‰€æœ‰é…ç½®
            document.getElementById('aiGlm4Config').style.display = 'none';
            document.getElementById('aiDeepseekConfig').style.display = 'none';
            document.getElementById('aiSiliconflowConfig').style.display = 'none';
            document.getElementById('aiCustomConfig').style.display = 'none';
            
            // æ˜¾ç¤ºé€‰ä¸­æ¨¡å‹çš„é…ç½®
            if (model === 'glm4') {
                document.getElementById('aiGlm4Config').style.display = 'block';
            } else if (model === 'deepseek') {
                document.getElementById('aiDeepseekConfig').style.display = 'block';
            } else if (model === 'siliconflow') {
                document.getElementById('aiSiliconflowConfig').style.display = 'block';
            } else if (model === 'custom') {
                document.getElementById('aiCustomConfig').style.display = 'block';
            }
        });
        
        // è§’è‰²è®¾ç½®ç›¸å…³å‡½æ•°
        let selectedRoleSocketId = null;
        
        function openSetRoleModal(socketId, username, currentRole) {
            selectedRoleSocketId = socketId;
            document.getElementById('setRoleUsername').value = username;
            document.getElementById('setRoleValue').value = currentRole || 'user';
            usersModal.classList.remove('active');
            document.getElementById('setRoleModal').classList.add('active');
        }
        
        function closeSetRoleModal() {
            document.getElementById('setRoleModal').classList.remove('active');
            selectedRoleSocketId = null;
        }
        
        function confirmSetRole() {
            const role = document.getElementById('setRoleValue').value;
            if (selectedRoleSocketId && role) {
                socket.emit('admin-set-role', {
                    socketId: selectedRoleSocketId,
                    role: role
                });
                closeSetRoleModal();
            }
        }

        function sendDisguisedMessage() {
            const username = disguiseUsername.value.trim();
            const message = disguiseMessage.value.trim();
            const color = disguiseColor.value;
            const type = disguiseMessageType.value;
            
            if (username && message) {
                if (currentRoomName) {
                    // å¦‚æœåœ¨æˆ¿é—´è¯¦ç»†é¡µï¼Œå‘é€åˆ°æŒ‡å®šæˆ¿é—´
                    socket.emit('admin-room-send-message', {
                        roomName: currentRoomName,
                        username: username,
                        message: message,
                        color: color,
                        type: type
                    });
                } else {
                    // å¦åˆ™å‘é€åˆ°æ‰€æœ‰æˆ¿é—´
                    socket.emit('admin-send-message', {
                        username: username,
                        message: message,
                        color: color,
                        type: type
                    });
                }
                closeAdminMessageModal();
            }
        }

        function sendSystemMessage() {
            const message = systemMessage.value.trim();
            if (message) {
                socket.emit('admin-system-message', message);
                systemMessage.value = '';
            }
        }
        
        // å¥½å‹ç®¡ç†åŠŸèƒ½
        function loadFriends() {
            console.log('æ­£åœ¨åŠ è½½å¥½å‹åˆ—è¡¨...');
            socket.emit('admin-get-friends');
        }
        
        socket.on('admin-friends-list', (friendships) => {
            console.log('æ”¶åˆ°å¥½å‹åˆ—è¡¨:', friendships);
            updateFriendsList(friendships);
        });
        
        function filterFriends() {
            const searchTerm = friendSearch.value.trim().toLowerCase();
            if (!searchTerm) {
                updateFriendsList(originalFriendships);
                return;
            }
            
            const filteredFriendships = originalFriendships.filter(friendship => 
                friendship.username.toLowerCase().includes(searchTerm) || 
                friendship.friendUsername.toLowerCase().includes(searchTerm)
            );
            updateFriendsList(filteredFriendships);
        }
        
        function updateFriendsList(friendships) {
            originalFriendships = friendships;
            
            if (friendships.length === 0) {
                friendsTabList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‘¥</div>
                        <div>æš‚æ— å¥½å‹å…³ç³»</div>
                    </div>`;
                return;
            }
            
            friendsTabList.innerHTML = friendships.map(friendship => `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-color" style="background: ${friendship.userColor}"></div>
                        <div>
                            <div class="user-name">${escapeHtml(friendship.username)}</div>
                            <small style="color: #666;">å¥½å‹: ${escapeHtml(friendship.friendUsername)}</small>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-primary btn-sm" onclick="adminPrivateChat('${friendship.userSocketId}', '${friendship.username}')">ç§èŠ</button>
                        <button class="btn btn-info btn-sm" onclick="viewPrivateChat('${friendship.userSocketId}', '${friendship.username}')">æŸ¥çœ‹ç§èŠ</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteFriendship('${friendship.userSocketId}', '${friendship.friendSocketId}')">åˆ é™¤å¥½å‹å…³ç³»</button>
                    </div>
                </div>
            `).join('');
        }
        
        function adminPrivateChat(socketId, username) {
            const message = prompt(`å‘é€ç§èŠæ¶ˆæ¯ç»™ ${username}ï¼š`);
            if (message) {
                socket.emit('admin-private-message', {
                    targetSocketId: socketId,
                    message: message,
                    type: 'text'
                });
            }
        }
        
        function viewPrivateChat(socketId, username) {
            const chatId = [socket.id, socketId].sort().join('-');
            socket.emit('admin-get-private-messages', {
                targetSocketId: socketId
            });
            
            // æ˜¾ç¤ºç§èŠå†å²
            const modalDiv = document.createElement('div');
            modalDiv.className = 'modal active';
            modalDiv.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                    <h3>ä¸ ${username} çš„ç§èŠå†å²</h3>
                    <div id="privateChatHistory" style="max-height: 500px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;"></div>
                    <div class="modal-buttons">
                        <button type="button" class="btn btn-cancel" onclick="this.parentElement.parentElement.parentElement.remove();">å…³é—­</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modalDiv);
            
            // ç›‘å¬ç§èŠå†å²æ¶ˆæ¯
            socket.on('admin-private-messages-history', (data) => {
                const historyDiv = document.getElementById('privateChatHistory');
                if (historyDiv) {
                    historyDiv.innerHTML = data.messages.map(msg => `
                        <div class="message-item">
                            <div class="message-header">
                                <span class="message-sender">${msg.fromUsername}</span>
                                <span class="message-time">${msg.timestamp}</span>
                            </div>
                            <div class="message-content">${escapeHtml(msg.message)}</div>
                        </div>
                    `).join('');
                }
            });
        }
        
        function closeFriendsModal() {
            friendsModal.classList.remove('active');
        }
        
        function openAddFriendModal() {
            const userASelect = document.getElementById('userA');
            const userBSelect = document.getElementById('userB');
            
            // æ¸…ç©ºé€‰é¡¹
            userASelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>';
            userBSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>';
            
            // æ·»åŠ ç”¨æˆ·é€‰é¡¹
            users.forEach(user => {
                userASelect.innerHTML += `<option value="${user.socketId}">${escapeHtml(user.username)}</option>`;
                userBSelect.innerHTML += `<option value="${user.socketId}">${escapeHtml(user.username)}</option>`;
            });
            
            document.getElementById('addFriendModal').classList.add('active');
        }
        
        function closeAddFriendModal() {
            document.getElementById('addFriendModal').classList.remove('active');
        }
        
        function confirmAddFriend() {
            const userA = document.getElementById('userA').value;
            const userB = document.getElementById('userB').value;
            
            if (!userA || !userB) {
                alert('è¯·é€‰æ‹©ä¸¤ä¸ªç”¨æˆ·');
                return;
            }
            
            if (userA === userB) {
                alert('ä¸èƒ½æ·»åŠ è‡ªå·±ä¸ºå¥½å‹');
                return;
            }
            
            const userAName = users.find(u => u.socketId === userA)?.username;
            const userBName = users.find(u => u.socketId === userB)?.username;
            
            if (confirm(`ç¡®å®šè¦è®© ${userAName} å’Œ ${userBName} æˆä¸ºå¥½å‹å—ï¼Ÿ`)) {
                socket.emit('admin-add-friendship', {
                    userSocketId: userA,
                    friendSocketId: userB
                });
                closeAddFriendModal();
            }
        }
        
        function applyGlobalPermissions() {
            if (confirm('ç¡®å®šè¦å°†è¿™äº›æƒé™åº”ç”¨åˆ°æ‰€æœ‰ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œå°†è¦†ç›–æ‰€æœ‰ç”¨æˆ·çš„ç°æœ‰æƒé™ï¼')) {
                const permissions = {
                    allowAudio: document.getElementById('globalAllowAudio').checked,
                    allowImage: document.getElementById('globalAllowImage').checked,
                    allowFile: document.getElementById('globalAllowFile').checked,
                    allowSendMessages: document.getElementById('globalAllowSendMessages').checked,
                    allowViewMessages: document.getElementById('globalAllowViewMessages').checked,
                    allowCall: document.getElementById('globalAllowCall').checked,
                    allowAddFriends: document.getElementById('globalAllowAddFriends').checked,
                    allowViewUsers: document.getElementById('globalAllowViewUsers').checked,
                    allowPrivateChat: document.getElementById('globalAllowPrivateChat').checked,
                    allowOpenFriendsPage: document.getElementById('globalAllowOpenFriendsPage').checked,
                    allowRecallMessage: document.getElementById('globalAllowRecallMessage').checked
                };
                
                socket.emit('admin-set-global-permissions', permissions);
            }
        }
        
        function applyToNewUsers() {
            const permissions = {
                allowAudio: document.getElementById('globalAllowAudio').checked,
                allowImage: document.getElementById('globalAllowImage').checked,
                allowFile: document.getElementById('globalAllowFile').checked,
                allowSendMessages: document.getElementById('globalAllowSendMessages').checked,
                allowViewMessages: document.getElementById('globalAllowViewMessages').checked,
                allowCall: document.getElementById('globalAllowCall').checked,
                allowAddFriends: document.getElementById('globalAllowAddFriends').checked,
                allowViewUsers: document.getElementById('globalAllowViewUsers').checked,
                allowPrivateChat: document.getElementById('globalAllowPrivateChat').checked,
                allowOpenFriendsPage: document.getElementById('globalAllowOpenFriendsPage').checked,
                allowRecallMessage: document.getElementById('globalAllowRecallMessage').checked
            };
            
            socket.emit('admin-set-default-permissions', permissions);
            alert('é»˜è®¤æƒé™å·²è®¾ç½®ï¼Œæ–°ç”¨æˆ·å°†ä½¿ç”¨è¿™äº›æƒé™');
        }
        
        function deleteFriendship(userSocketId, friendSocketId) {
            const usernames = originalFriendships.find(f => 
                f.userSocketId === userSocketId && f.friendSocketId === friendSocketId
            );
            if (usernames && confirm(`ç¡®å®šè¦åˆ é™¤ ${usernames.username} å’Œ ${usernames.friendUsername} çš„å¥½å‹å…³ç³»å—ï¼Ÿ`)) {
                socket.emit('admin-delete-friendship', {
                    userSocketId: userSocketId,
                    friendSocketId: friendSocketId
                });
            }
        }

        // ç¦è¨€ç®¡ç†ç›¸å…³å‡½æ•°
        function loadMutedUsers() {
            console.log('loadMutedUsers called');
            socket.emit('admin-get-muted-users');
        }

        function openMuteUserModal() {
            // åŠ è½½æ‰€æœ‰åœ¨çº¿ç”¨æˆ·åˆ°ä¸‹æ‹‰åˆ—è¡¨
            const muteUserId = document.getElementById('muteUserId');
            muteUserId.innerHTML = '<option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>';
            users.forEach(user => {
                muteUserId.innerHTML += `<option value="${user.socketId}">${escapeHtml(user.username)}</option>`;
            });
            document.getElementById('muteUserModal').classList.add('active');
        }

        function closeMuteUserModal() {
            document.getElementById('muteUserModal').classList.remove('active');
        }

        function confirmMuteUser() {
            const socketId = document.getElementById('muteUserId').value;
            const duration = parseInt(document.getElementById('muteDuration').value);
            const reason = document.getElementById('muteReason').value.trim();
            
            if (socketId && reason) {
                socket.emit('admin-mute-user', {
                    socketId: socketId,
                    duration: duration,
                    reason: reason
                });
                closeMuteUserModal();
                alert('ç”¨æˆ·å·²è¢«ç¦è¨€');
                loadMutedUsers();
            }
        }

        function unmuteUser(socketId, username) {
            if (confirm(`ç¡®å®šè¦è§£é™¤å¯¹ ${escapeHtml(username)} çš„ç¦è¨€å—ï¼Ÿ`)) {
                socket.emit('admin-unmute-user', socketId);
                loadMutedUsers();
            }
        }

        function updateMutedUsersList(mutedUsers) {
            const mutedUsersList = document.getElementById('mutedUsersList');
            
            if (mutedUsers.length === 0) {
                mutedUsersList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”‡</div>
                        <div>æš‚æ— è¢«ç¦è¨€ç”¨æˆ·</div>
                    </div>`;
                return;
            }
            
            mutedUsersList.innerHTML = mutedUsers.map(user => {
                const endTimeText = user.endTime === -1 ? 'æ°¸ä¹…' : new Date(user.endTime).toLocaleString();
                return `
                    <div class="user-item">
                        <div class="user-info">
                            <div class="user-color" style="background: ${user.color}"></div>
                            <div>
                                <div class="user-name">${escapeHtml(user.username)}</div>
                                <small style="color: #666;">ç¦è¨€æˆªæ­¢: ${endTimeText} | åŸå› : ${escapeHtml(user.reason)}</small>
                            </div>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-success btn-sm" onclick="unmuteUser('${user.socketId}', '${escapeHtml(user.username)}')">è§£é™¤ç¦è¨€</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ç›‘å¬ç¦è¨€ç”¨æˆ·åˆ—è¡¨
        socket.on('admin-muted-users', (mutedUsers) => {
            console.log('Received admin-muted-users event:', mutedUsers);
            updateMutedUsersList(mutedUsers);
        });

        // å¥½å‹æ‰©å®¹ç”³è¯·ç›¸å…³å‡½æ•°
        function loadFriendLimitRequests() {
            socket.emit('admin-get-friend-limit-requests');
        }

        function displayFriendLimitRequests(requests) {
            const container = document.getElementById('friendLimitRequestsContainer');
            
            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <div>æš‚æ— å¥½å‹æ‰©å®¹ç”³è¯·</div>
                    </div>`;
                return;
            }

            container.innerHTML = requests.map(request => `
                <div class="request-item">
                    <div class="request-info">
                        <h4>${request.username}</h4>
                        <p class="request-reason">${request.reason}</p>
                        <div class="request-meta">
                            <span>ç”³è¯·æ—¶é—´: ${new Date(request.createdAt).toLocaleString()}</span>
                            <span>çŠ¶æ€: <span class="status-${request.status}">${request.status === 'pending' ? 'å¾…å¤„ç†' : request.status === 'approved' ? 'å·²æ‰¹å‡†' : 'å·²æ‹’ç»'}</span></span>
                        </div>
                    </div>
                    ${request.status === 'pending' ? `
                        <div class="request-actions">
                            <button class="btn btn-success" onclick="approveFriendLimitRequest(${request.id})">æ‰¹å‡†</button>
                            <button class="btn btn-danger" onclick="rejectFriendLimitRequest(${request.id})">æ‹’ç»</button>
                        </div>` : ''}
                </div>
            `).join('');
        }

        function approveFriendLimitRequest(requestId) {
            const newLimit = prompt('è¯·è¾“å…¥æ–°çš„å¥½å‹æ•°é‡ä¸Šé™ï¼ˆè¾“å…¥-1è¡¨ç¤ºæ— é™ï¼‰:', '10');
            const limit = parseInt(newLimit);
            if (newLimit !== null && !isNaN(limit)) {
                socket.emit('admin-approve-friend-limit-request', {
                    requestId: requestId,
                    newLimit: limit
                });
            }
        }

        function rejectFriendLimitRequest(requestId) {
            const reason = prompt('è¯·è¾“å…¥æ‹’ç»ç†ç”±ï¼ˆå¯é€‰ï¼‰:');
            socket.emit('admin-reject-friend-limit-request', {
                requestId: requestId,
                reason: reason
            });
        }

        // ç›‘å¬æ–°çš„å¥½å‹æ‰©å®¹ç”³è¯·
        socket.on('new-friend-limit-request', (request) => {
            loadFriendLimitRequests();
        });

        // ç›‘å¬å¥½å‹æ‰©å®¹ç”³è¯·åˆ—è¡¨
        socket.on('admin-friend-limit-requests', (requests) => {
            displayFriendLimitRequests(requests);
        });

        // ç›‘å¬å¥½å‹æ‰©å®¹ç”³è¯·çŠ¶æ€æ›´æ–°
        socket.on('admin-friend-limit-request-updated', (request) => {
            loadFriendLimitRequests();
        });

        function clearMessages() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                socket.emit('admin-clear-messages');
            }
        }

        function loadMessages() {
            const selectedRoom = roomSelect.value || 'main';
            loadRoomMessages(selectedRoom);
        }

        let currentPath = '';

        function loadFiles() {
            const url = currentPath ? `/api/files?path=${encodeURIComponent(currentPath)}` : '/api/files';
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    displayFiles(data.files);
                    updatePathBar(data.currentPath);
                })
                .catch(error => {
                    console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                    alert('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥');
                });
        }

        function updatePathBar(path) {
            currentPath = path;
            document.getElementById('currentPath').textContent = '/' + (path || '');
            document.getElementById('backButton').disabled = !path;
        }

        function goBack() {
            if (!currentPath) return;
            const pathParts = currentPath.split('/').filter(p => p);
            pathParts.pop();
            currentPath = pathParts.join('/');
            loadFiles();
        }

        function enterDirectory(dirname) {
            currentPath = currentPath ? `${currentPath}/${dirname}` : dirname;
            loadFiles();
        }

        function displayFiles(files) {
            const filesContainer = document.getElementById('filesContainer');
            
            if (files.length === 0) {
                filesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <div>æš‚æ— æ–‡ä»¶</div>
                    </div>`;
                return;
            }

            filesContainer.innerHTML = files.map(file => `
                <div class="file-item">
                    <div class="file-info" onclick="${file.isDirectory ? `enterDirectory('${file.name}')` : `viewFile('${file.name}')`}" style="cursor: ${file.isDirectory ? 'pointer' : 'default'}">
                        <div class="file-icon">${file.isDirectory ? 'ğŸ“' : 'ğŸ“„'}</div>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-meta">
                                <span>${file.isDirectory ? 'ç›®å½•' : formatFileSize(file.size)}</span>
                                <span>${formatDate(file.createdAt)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="file-actions">
                        ${file.isDirectory ? 
                            `<button class="btn btn-danger" onclick="deleteFile('${file.name}')">åˆ é™¤</button>` :
                            `<button class="btn btn-primary" onclick="viewFile('${file.name}')">æŸ¥çœ‹</button>
                             <button class="btn btn-primary" onclick="editFile('${file.name}')">ç¼–è¾‘</button>
                             <button class="btn btn-danger" onclick="deleteFile('${file.name}')">åˆ é™¤</button>`
                        }
                    </div>
                </div>
            `).join('');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatDate(date) {
            const d = new Date(date);
            return d.toLocaleString('zh-CN');
        }

        function openUploadModal() {
            document.getElementById('uploadFileModal').classList.add('active');
        }

        function closeUploadModal() {
            document.getElementById('uploadFileModal').classList.remove('active');
            document.getElementById('fileInput').value = '';
        }

        function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·é€‰æ‹©æ–‡ä»¶');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            fetch('/api/files/upload', {
                method: 'POST',
                headers: {
                    'X-Filename': file.name,
                    'X-Path': currentPath
                },
                body: file
            })
            .then(response => response.json())
            .then(data => {
                alert('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
                closeUploadModal();
                loadFiles();
            })
            .catch(error => {
                console.error('ä¸Šä¼ æ–‡ä»¶å¤±è´¥:', error);
                alert('ä¸Šä¼ æ–‡ä»¶å¤±è´¥');
            });
        }

        function openCreateFileModal() {
            document.getElementById('createFileModal').classList.add('active');
        }

        function closeCreateFileModal() {
            document.getElementById('createFileModal').classList.remove('active');
            document.getElementById('createFileName').value = '';
            document.getElementById('createFileContent').value = '';
        }

        function createFile() {
            const filename = document.getElementById('createFileName').value;
            const content = document.getElementById('createFileContent').value;

            if (!filename) {
                alert('è¯·è¾“å…¥æ–‡ä»¶å');
                return;
            }

            fetch('/api/files/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ filename, content, path: currentPath })
            })
            .then(response => response.json())
            .then(data => {
                alert('æ–‡ä»¶åˆ›å»ºæˆåŠŸ');
                closeCreateFileModal();
                loadFiles();
            })
            .catch(error => {
                console.error('åˆ›å»ºæ–‡ä»¶å¤±è´¥:', error);
                alert('åˆ›å»ºæ–‡ä»¶å¤±è´¥');
            });
        }

        function openCreateDirectoryModal() {
            document.getElementById('createDirectoryModal').classList.add('active');
        }

        function closeCreateDirectoryModal() {
            document.getElementById('createDirectoryModal').classList.remove('active');
            document.getElementById('createDirectoryName').value = '';
        }

        function createDirectory() {
            const dirname = document.getElementById('createDirectoryName').value;

            if (!dirname) {
                alert('è¯·è¾“å…¥ç›®å½•å');
                return;
            }

            fetch('/api/files/create-directory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ dirname, path: currentPath })
            })
            .then(response => response.json())
            .then(data => {
                alert('ç›®å½•åˆ›å»ºæˆåŠŸ');
                closeCreateDirectoryModal();
                loadFiles();
            })
            .catch(error => {
                console.error('åˆ›å»ºç›®å½•å¤±è´¥:', error);
                alert('åˆ›å»ºç›®å½•å¤±è´¥');
            });
        }

        function editFile(filename) {
            const fullPath = currentPath ? `${currentPath}/${filename}` : filename;
            fetch(`/api/files/${encodeURIComponent(fullPath)}/content`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('editFileName').value = filename;
                    document.getElementById('editFileContent').value = data.content;
                    document.getElementById('editFileModal').classList.add('active');
                })
                .catch(error => {
                    console.error('è·å–æ–‡ä»¶å†…å®¹å¤±è´¥:', error);
                    alert('è·å–æ–‡ä»¶å†…å®¹å¤±è´¥');
                });
        }

        function closeEditFileModal() {
            document.getElementById('editFileModal').classList.remove('active');
            document.getElementById('editFileName').value = '';
            document.getElementById('editFileContent').value = '';
        }

        function saveFileEdit() {
            const filename = document.getElementById('editFileName').value;
            const content = document.getElementById('editFileContent').value;
            const fullPath = currentPath ? `${currentPath}/${filename}` : filename;

            fetch(`/api/files/${encodeURIComponent(fullPath)}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content })
            })
            .then(response => response.json())
            .then(data => {
                alert('æ–‡ä»¶ä¿å­˜æˆåŠŸ');
                closeEditFileModal();
                loadFiles();
            })
            .catch(error => {
                console.error('ä¿å­˜æ–‡ä»¶å¤±è´¥:', error);
                alert('ä¿å­˜æ–‡ä»¶å¤±è´¥');
            });
        }

        function viewFile(filename) {
            const fullPath = currentPath ? `${currentPath}/${filename}` : filename;
            window.open(`/uploads/${fullPath}`, '_blank');
        }

        function deleteFile(filename) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤ "${filename}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                const fullPath = currentPath ? `${currentPath}/${filename}` : filename;
                fetch(`/api/files/${encodeURIComponent(fullPath)}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    alert('æ–‡ä»¶åˆ é™¤æˆåŠŸ');
                    loadFiles();
                })
                .catch(error => {
                    console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
                    alert('åˆ é™¤æ–‡ä»¶å¤±è´¥');
                });
            }
        }
        
        function loadRoomMessages(roomName) {
            socket.emit('admin-get-room-messages', roomName);
        }
        
        function changeAdminPassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            
            if (!oldPassword || !newPassword) {
                alert('è¯·è¾“å…¥æ—§å¯†ç å’Œæ–°å¯†ç ');
                return;
            }
            
            if (oldPassword === newPassword) {
                alert('æ–°å¯†ç ä¸èƒ½ä¸æ—§å¯†ç ç›¸åŒ');
                return;
            }
            
            socket.emit('admin-change-password', {
                oldPassword: oldPassword,
                newPassword: newPassword
            });
        }
        
        // ç³»ç»Ÿç®¡ç†å‡½æ•°
        function getServerInfo() {
            socket.emit('admin-get-server-info');
        }
        
        // æ·»åŠ æ¯ç§’è‡ªåŠ¨åˆ·æ–°æœåŠ¡å™¨ä¿¡æ¯çš„å®šæ—¶å™¨
        let serverInfoInterval;
        
        // å½“åˆ‡æ¢åˆ°ç³»ç»Ÿç®¡ç†æ ‡ç­¾é¡µæ—¶ï¼Œå¯åŠ¨è‡ªåŠ¨åˆ·æ–°
        function startServerInfoRefresh() {
            if (!serverInfoInterval) {
                serverInfoInterval = setInterval(getServerInfo, 1000);
                console.log('å¼€å§‹æ¯ç§’è‡ªåŠ¨åˆ·æ–°æœåŠ¡å™¨ä¿¡æ¯');
            }
        }
        
        // å½“ç¦»å¼€ç³»ç»Ÿç®¡ç†æ ‡ç­¾é¡µæ—¶ï¼Œåœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopServerInfoRefresh() {
            if (serverInfoInterval) {
                clearInterval(serverInfoInterval);
                serverInfoInterval = null;
                console.log('åœæ­¢è‡ªåŠ¨åˆ·æ–°æœåŠ¡å™¨ä¿¡æ¯');
            }
        }
        
        function shutdownServer() {
            if (confirm('ç¡®å®šè¦å…³é—­æœåŠ¡å™¨å—ï¼Ÿæ­¤æ“ä½œå°†æ–­å¼€æ‰€æœ‰ç”¨æˆ·çš„è¿æ¥ï¼')) {
                socket.emit('admin-shutdown-server');
                alert('æœåŠ¡å™¨æ­£åœ¨å…³é—­...');
            }
        }
        
        function executeCommand() {
            const command = document.getElementById('commandInput').value.trim();
            if (!command) {
                alert('è¯·è¾“å…¥è¦æ‰§è¡Œçš„å‘½ä»¤');
                return;
            }
            
            const outputDiv = document.getElementById('commandOutput');
            outputDiv.textContent = 'æ­£åœ¨æ‰§è¡Œå‘½ä»¤...\n';
            
            socket.emit('admin-exec-command', { command: command });
        }
        
        // å¤„ç†æœåŠ¡å™¨ä¿¡æ¯å“åº”
        socket.on('admin-server-info', (data) => {
            const infoDiv = document.getElementById('serverInfo');
            const uptime = Math.floor(data.uptime);
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            const seconds = uptime % 60;
            const memoryMB = (data.memoryUsage.heapUsed / 1024 / 1024).toFixed(2);
            const memoryTotalMB = (data.memoryUsage.heapTotal / 1024 / 1024).toFixed(2);
            
            infoDiv.innerHTML = `
                <p><strong>Node.jsç‰ˆæœ¬:</strong> ${data.nodeVersion}</p>
                <p><strong>æ“ä½œç³»ç»Ÿ:</strong> ${data.platform} (${data.arch})</p>
                <p><strong>è¿›ç¨‹ID:</strong> ${data.pid}</p>
                <p><strong>è¿è¡Œæ—¶é—´:</strong> ${hours}å°æ—¶${minutes}åˆ†${seconds}ç§’</p>
                <p><strong>å†…å­˜ä½¿ç”¨:</strong> ${memoryMB} MB / ${memoryTotalMB} MB</p>
                <p><strong>å·¥ä½œç›®å½•:</strong> ${data.cwd}</p>
                <p><strong>æœåŠ¡å™¨çŠ¶æ€:</strong> ${data.isRunning ? '<span style="color: green;">è¿è¡Œä¸­</span>' : '<span style="color: red;">å·²åœæ­¢</span>'}</p>
            `;
        });
        
        // å¤„ç†å‘½ä»¤æ‰§è¡Œç»“æœ
        socket.on('admin-command-result', (data) => {
            const outputDiv = document.getElementById('commandOutput');
            if (data.success) {
                outputDiv.textContent = data.output || 'å‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼ˆæ— è¾“å‡ºï¼‰';
            } else {
                outputDiv.textContent = 'é”™è¯¯: ' + data.error;
            }
        });
        
        // å¤„ç†æœåŠ¡å™¨å…³é—­é€šçŸ¥
        socket.on('server-shutting-down', (data) => {
            alert(data.message);
        });
        
        function displayMessages(data, isRoomMessages = false) {
            messageCount.textContent = data.active.length;
            deletedMessageCount.textContent = data.deleted.length;
            
            const allMessages = [...data.active.map(m => ({ ...m, status: 'active' })), ...data.deleted.map(m => ({ ...m, status: 'deleted' }))];
            
            if (allMessages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ’¬</div>
                        <div>${isRoomMessages ? 'è¯¥æˆ¿é—´æš‚æ— æ¶ˆæ¯' : 'æš‚æ— æ¶ˆæ¯'}</div>
                    </div>`;
                return;
            }

            messagesContainer.innerHTML = allMessages.map(msg => {
                let contentHtml = '';
                if (msg.type === 'image') {
                    contentHtml = `<img src="${msg.message}" alt="å›¾ç‰‡">`;
                } else if (msg.type === 'audio') {
                    contentHtml = `<audio controls><source src="${msg.message}" type="audio/webm">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾</audio>`;
                } else if (msg.type === 'video') {
                    contentHtml = `<video controls width="100%" max-height="300px"><source src="${msg.message}" type="video/webm">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾</video>`;
                } else {
                    contentHtml = escapeHtml(msg.message);
                }

                const statusText = msg.status === 'active' ? 'æ­£å¸¸' : 'å·²æ’¤å›';
                const statusClass = msg.status === 'active' ? 'active' : 'deleted';
                const recallTime = msg.recallTime ? `<br><small>æ’¤å›æ—¶é—´: ${msg.recallTime}</small>` : '';

                return `
                    <div class="message-item ${msg.status}">
                        <div class="message-header">
                            <div>
                                <span class="message-sender" style="color: ${msg.color}">${escapeHtml(msg.username)}</span>
                                <span class="message-status ${statusClass}">${statusText}</span>
                            </div>
                            <span class="message-time">${msg.timestamp}${recallTime}</span>
                        </div>
                        <div class="message-content">${contentHtml}</div>
                    </div>
                `;
            }).join('');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(date) {
            const d = new Date(date);
            return d.toLocaleString('zh-CN');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // è¿‡æ»¤ç”¨æˆ·åˆ—è¡¨
        function filterUsers() {
            const searchTerm = userSearch.value.toLowerCase().trim();
            
            if (!searchTerm) {
                // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·
                users = [...originalUsers];
                updateUserList();
                return;
            }
            
            // æ ¹æ®ç”¨æˆ·åæˆ–æˆ¿é—´åè¿‡æ»¤ç”¨æˆ·
            users = originalUsers.filter(user => {
                const username = user.username.toLowerCase();
                const roomName = (user.roomName || 'main').toLowerCase();
                
                return username.includes(searchTerm) || roomName.includes(searchTerm);
            });
            
            updateUserList();
        }
        
        // åˆ‡æ¢ç”¨æˆ·åˆ—è¡¨æ˜¾ç¤º/éšè—
        function toggleUserList() {
            const userListElement = document.getElementById('userList');
            if (userListElement.style.display === 'none') {
                userListElement.style.display = 'block';
            } else {
                userListElement.style.display = 'none';
            }
        }
        
        // è¿‡æ»¤æˆ¿é—´åˆ—è¡¨
        function filterRooms() {
            const searchTerm = roomSearch.value.toLowerCase().trim();
            
            if (!searchTerm) {
                // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰æˆ¿é—´
                updateRoomList(originalRooms);
                return;
            }
            
            // æ ¹æ®æˆ¿é—´åè¿‡æ»¤æˆ¿é—´
            const filteredRooms = originalRooms.filter(room => {
                return room.roomName.toLowerCase().includes(searchTerm);
            });
            
            updateRoomList(filteredRooms);
        }
        
        // ç”¨æˆ·è¡Œä¸ºåˆ†æç›¸å…³å‡½æ•°
        function loadUserAnalytics() {
            const timeRange = document.getElementById('analyticsTimeRange').value;
            socket.emit('admin-get-user-analytics', { timeRange: timeRange });
        }
        
        function refreshAnalytics() {
            loadUserAnalytics();
        }
        
        function exportAnalyticsData() {
            const timeRange = document.getElementById('analyticsTimeRange').value;
            socket.emit('admin-export-analytics-data', { timeRange: timeRange });
        }
        
        // ç›‘å¬ç”¨æˆ·è¡Œä¸ºåˆ†ææ•°æ®
        socket.on('admin-user-analytics', (data) => {
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            document.getElementById('activeUserCount').textContent = data.stats.activeUsers;
            document.getElementById('totalMessageCount').textContent = data.stats.totalMessages;
            document.getElementById('avgMessageLength').textContent = data.stats.avgMessageLength.toFixed(2);
            document.getElementById('peakHour').textContent = data.stats.peakHour + ':00';
            document.getElementById('retentionRate').textContent = (data.stats.retentionRate * 100).toFixed(2) + '%';
            document.getElementById('avgOnlineTime').textContent = data.stats.avgOnlineTime + 'åˆ†é’Ÿ';
            document.getElementById('responseRate').textContent = (data.stats.responseRate * 100).toFixed(2) + '%';
            document.getElementById('userGrowthRate').textContent = (data.stats.userGrowthRate * 100).toFixed(2) + '%';
            
            // æ›´æ–°ç”¨æˆ·è¡Œä¸ºè¯¦æƒ…
            updateUserBehaviorList(data.behaviorDetails);
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ å›¾è¡¨æ¸²æŸ“ä»£ç ï¼Œä½¿ç”¨Chart.jsæˆ–å…¶ä»–å›¾è¡¨åº“
        });
        
        function updateUserBehaviorList(behaviorDetails) {
            const behaviorList = document.getElementById('userBehaviorList');
            
            if (behaviorDetails.length === 0) {
                behaviorList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“Š</div>
                        <div>æš‚æ— è¡Œä¸ºæ•°æ®</div>
                    </div>`;
                return;
            }
            
            behaviorList.innerHTML = behaviorDetails.map(user => `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-color" style="background: ${user.color}"></div>
                        <div>
                            <div class="user-name">${escapeHtml(user.username)}</div>
                            <small style="color: #666;">æ´»è·ƒåº¦: ${user.activityScore} | æ¶ˆæ¯æ•°: ${user.messageCount} | åœ¨çº¿æ—¶é•¿: ${user.onlineTime}åˆ†é’Ÿ</small>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-sm btn-primary" onclick="viewUserDetailedAnalytics('${user.socketId}')">è¯¦ç»†åˆ†æ</button>
                    </div>
                </div>
            `).join('');
        }
        
        function viewUserDetailedAnalytics(socketId) {
            socket.emit('admin-get-user-detailed-analytics', { socketId: socketId });
        }
        
        // ç›‘å¬ç”¨æˆ·è¯¦ç»†åˆ†ææ•°æ®
        socket.on('admin-user-detailed-analytics', (data) => {
            // è¿™é‡Œå¯ä»¥æ·»åŠ è¯¦ç»†åˆ†ææ•°æ®çš„æ˜¾ç¤ºä»£ç 
            alert(`ç”¨æˆ· ${data.username} çš„è¯¦ç»†åˆ†ææ•°æ®å·²åŠ è½½`);
        });
        
        // ç³»ç»Ÿæ—¥å¿—å’Œæ•°æ®å¯¼å‡ºç›¸å…³å‡½æ•°
        function loadSystemLogs() {
            const logType = document.getElementById('logTypeFilter').value;
            const searchTerm = document.getElementById('logSearch').value;
            
            socket.emit('admin-get-system-logs', {
                type: logType,
                search: searchTerm
            });
        }
        
        function exportSystemLogs() {
            socket.emit('admin-export-data', {
                dataType: 'logs'
            });
        }
        
        function exportUserData() {
            socket.emit('admin-export-data', {
                dataType: 'users'
            });
        }
        
        function exportMessageData() {
            socket.emit('admin-export-data', {
                dataType: 'messages'
            });
        }
        
        function clearSystemLogs() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç³»ç»Ÿæ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                socket.emit('admin-clear-system-logs');
            }
        }
        
        // ç›‘å¬ç³»ç»Ÿæ—¥å¿—æ•°æ®
        socket.on('admin-system-logs', (data) => {
            const logsContainer = document.getElementById('systemLogsContainer');
            
            if (data.logs.length === 0) {
                logsContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <div>æš‚æ— ç³»ç»Ÿæ—¥å¿—</div>
                    </div>`;
                return;
            }
            
            logsContainer.innerHTML = data.logs.map(log => {
                let levelClass = '';
                switch (log.level) {
                    case 'error':
                        levelClass = 'color: #dc3545; font-weight: bold;';
                        break;
                    case 'warn':
                        levelClass = 'color: #ffc107; font-weight: bold;';
                        break;
                    case 'info':
                        levelClass = 'color: #17a2b8;';
                        break;
                    case 'debug':
                        levelClass = 'color: #6c757d;';
                        break;
                }
                
                return `
                    <div style="margin-bottom: 10px; padding: 5px; border-left: 4px solid ${log.level === 'error' ? '#dc3545' : log.level === 'warn' ? '#ffc107' : log.level === 'info' ? '#17a2b8' : '#6c757d'};">
                        <div style="font-size: 12px; color: #666;">${log.timestamp}</div>
                        <div style="${levelClass}">[${log.level.toUpperCase()}] ${log.message}</div>
                        ${log.details ? `<div style="font-size: 12px; color: #666; margin-top: 5px;">${escapeHtml(JSON.stringify(log.details))}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            // æ›´æ–°äº‹ä»¶ç»Ÿè®¡
            document.getElementById('loginCount').textContent = data.stats.loginCount || 0;
            document.getElementById('logoutCount').textContent = data.stats.logoutCount || 0;
            document.getElementById('messageSentCount').textContent = data.stats.messageSentCount || 0;
            document.getElementById('fileUploadCount').textContent = data.stats.fileUploadCount || 0;
            document.getElementById('errorCount').textContent = data.stats.errorCount || 0;
            document.getElementById('warnCount').textContent = data.stats.warnCount || 0;
        });
        
        // ç›‘å¬æ•°æ®å¯¼å‡ºå®Œæˆ
        socket.on('admin-export-complete', (data) => {
            alert(`æ•°æ®å¯¼å‡ºæˆåŠŸï¼Œæ–‡ä»¶å·²ç”Ÿæˆ: ${data.filename}`);
        });
        
        // ç³»ç»Ÿç›‘æ§ç›¸å…³å‡½æ•°
        let monitoringInterval = null;
        
        function startSystemMonitoring() {
            const interval = parseInt(document.getElementById('monitoringInterval').value) || 5000;
            
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
            }
            
            monitoringInterval = setInterval(() => {
                socket.emit('admin-get-system-monitoring');
            }, interval);
            
            // ç«‹å³è·å–ä¸€æ¬¡æ•°æ®
            socket.emit('admin-get-system-monitoring');
            
            alert('ç³»ç»Ÿç›‘æ§å·²å¯åŠ¨');
        }
        
        function stopSystemMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                alert('ç³»ç»Ÿç›‘æ§å·²åœæ­¢');
            }
        }
        
        function refreshSystemStatus() {
            socket.emit('admin-get-system-monitoring');
        }
        
        // ç›‘å¬ç³»ç»Ÿç›‘æ§æ•°æ®
        socket.on('admin-system-monitoring', (data) => {
            // æ›´æ–°ç³»ç»ŸçŠ¶æ€
            document.getElementById('cpuUsage').textContent = data.cpuUsage + '%';
            document.getElementById('memoryUsage').textContent = data.memoryUsage + '%';
            document.getElementById('diskUsage').textContent = data.diskUsage + '%';
            document.getElementById('networkTraffic').textContent = data.networkTraffic;
            document.getElementById('onlineUsers').textContent = data.onlineUsers;
            document.getElementById('websocketConnections').textContent = data.websocketConnections;
            
            // æ›´æ–°ç³»ç»Ÿäº‹ä»¶
            const eventsContainer = document.getElementById('systemEventsContainer');
            if (data.events.length === 0) {
                eventsContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âš¡</div>
                        <div>æš‚æ— ç³»ç»Ÿäº‹ä»¶</div>
                    </div>`;
                return;
            }
            
            eventsContainer.innerHTML = data.events.map(event => `
                <div style="margin-bottom: 10px; padding: 5px; border-left: 4px solid ${event.type === 'error' ? '#dc3545' : event.type === 'warn' ? '#ffc107' : event.type === 'info' ? '#17a2b8' : '#6c757d'};">
                    <div style="font-size: 12px; color: #666;">${event.timestamp}</div>
                    <div style="${event.type === 'error' ? 'color: #dc3545; font-weight: bold;' : event.type === 'warn' ? 'color: #ffc107; font-weight: bold;' : event.type === 'info' ? 'color: #17a2b8;' : 'color: #6c757d;'};">${event.message}</div>
                    ${event.details ? `<div style="font-size: 12px; color: #666; margin-top: 5px;">${escapeHtml(JSON.stringify(event.details))}</div>` : ''}
                </div>
            `).join('');
        });
        
        // è™šæ‹Ÿåˆ—è¡¨ä¼˜åŒ–DOMæ“ä½œ
        class VirtualList {
            constructor(container, options) {
                this.container = container;
                this.options = {
                    itemHeight: 80, // é»˜è®¤é¡¹é«˜åº¦
                    buffer: 5, // ç¼“å†²åŒºå¤§å°
                    ...options
                };
                
                this.items = [];
                this.startIndex = 0;
                this.endIndex = 0;
                this.scrollTop = 0;
                
                this.container.style.position = 'relative';
                this.container.style.overflow = 'auto';
                
                // åˆ›å»ºæ»šåŠ¨å®¹å™¨
                this.scrollContainer = document.createElement('div');
                this.scrollContainer.style.position = 'absolute';
                this.scrollContainer.style.top = '0';
                this.scrollContainer.style.left = '0';
                this.scrollContainer.style.right = '0';
                this.scrollContainer.style.overflow = 'hidden';
                
                // åˆ›å»ºå†…å®¹å®¹å™¨
                this.contentContainer = document.createElement('div');
                this.contentContainer.style.position = 'absolute';
                this.contentContainer.style.top = '0';
                this.contentContainer.style.left = '0';
                this.contentContainer.style.right = '0';
                
                this.container.appendChild(this.scrollContainer);
                this.scrollContainer.appendChild(this.contentContainer);
                
                // ç»‘å®šæ»šåŠ¨äº‹ä»¶
                this.container.addEventListener('scroll', this.handleScroll.bind(this));
            }
            
            setItems(items) {
                this.items = items;
                this.update();
            }
            
            update() {
                const containerHeight = this.container.clientHeight;
                const itemHeight = this.options.itemHeight;
                
                // è®¡ç®—å¯è§é¡¹æ•°é‡
                const visibleCount = Math.ceil(containerHeight / itemHeight) + this.options.buffer * 2;
                
                // è®¡ç®—æ»šåŠ¨ä½ç½®å¯¹åº”çš„èµ·å§‹ç´¢å¼•
                this.startIndex = Math.max(0, Math.floor(this.container.scrollTop / itemHeight) - this.options.buffer);
                this.endIndex = Math.min(this.items.length, this.startIndex + visibleCount);
                
                // è®¡ç®—æ€»é«˜åº¦
                const totalHeight = this.items.length * itemHeight;
                this.scrollContainer.style.height = `${totalHeight}px`;
                
                // è®¡ç®—å†…å®¹å®¹å™¨åç§»
                this.contentContainer.style.transform = `translateY(${this.startIndex * itemHeight}px)`;
                
                // æ¸²æŸ“å¯è§é¡¹
                this.render();
            }
            
            render() {
                if (this.items.length === 0) {
                    this.contentContainer.innerHTML = `
                        <div class="empty-state" style="height: 200px; display: flex; align-items: center; justify-content: center;">
                            <div>
                                <div class="empty-state-icon">${this.options.emptyIcon || 'ğŸ“‹'}</div>
                                <div>${this.options.emptyText || 'æš‚æ— æ•°æ®'}</div>
                            </div>
                        </div>`;
                    return;
                }
                
                const visibleItems = this.items.slice(this.startIndex, this.endIndex);
                this.contentContainer.innerHTML = visibleItems.map((item, index) => {
                    const actualIndex = this.startIndex + index;
                    return this.options.renderItem(item, actualIndex);
                }).join('');
            }
            
            handleScroll() {
                this.update();
            }
            
            refresh() {
                this.update();
            }
        }
        
        // åˆå§‹åŒ–è™šæ‹Ÿåˆ—è¡¨
        function initVirtualLists() {
            // è¿™é‡Œå¯ä»¥åˆå§‹åŒ–å„ç§éœ€è¦è™šæ‹Ÿåˆ—è¡¨çš„å®¹å™¨
            // ä¾‹å¦‚ï¼šç”¨æˆ·åˆ—è¡¨ã€æ¶ˆæ¯åˆ—è¡¨ç­‰
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', initVirtualLists);
        
        // æ¡Œé¢é€šçŸ¥ç³»ç»Ÿ
        class DesktopNotification {
            constructor() {
                this.permission = Notification.permission;
            }
            
            async requestPermission() {
                if (this.permission !== 'granted') {
                    this.permission = await Notification.requestPermission();
                }
                return this.permission === 'granted';
            }
            
            hasPermission() {
                return this.permission === 'granted';
            }
            
            sendNotification(title, options = {}) {
                if (!this.hasPermission()) {
                    console.warn('æ¡Œé¢é€šçŸ¥æƒé™æœªæˆäºˆ');
                    return null;
                }
                
                const notification = new Notification(title, {
                    icon: options.icon || '/favicon.ico',
                    body: options.body || '',
                    badge: options.badge || '/favicon.ico',
                    vibrate: options.vibrate || [200, 100, 200],
                    data: options.data || {},
                    actions: options.actions || [],
                    tag: options.tag || '',
                    renotify: options.renotify || false,
                    requireInteraction: options.requireInteraction || false,
                    silent: options.silent || false
                });
                
                if (options.onClick) {
                    notification.addEventListener('click', options.onClick);
                }
                
                if (options.onClose) {
                    notification.addEventListener('close', options.onClose);
                }
                
                return notification;
            }
        }
        
        // åˆå§‹åŒ–æ¡Œé¢é€šçŸ¥å®ä¾‹
        const desktopNotification = new DesktopNotification();
        
        // å‘é€ç³»ç»Ÿé€šçŸ¥
        function sendSystemNotification(title, message, options = {}) {
            return desktopNotification.sendNotification(title, {
                body: message,
                ...options
            });
        }
        
        // è¯·æ±‚æ¡Œé¢é€šçŸ¥æƒé™
        async function requestNotificationPermission() {
            const granted = await desktopNotification.requestPermission();
            if (granted) {
                alert('æ¡Œé¢é€šçŸ¥æƒé™å·²æˆäºˆ');
            } else {
                alert('æ¡Œé¢é€šçŸ¥æƒé™è¢«æ‹’ç»');
            }
        }
        
        // ç›‘å¬æ–°æ¶ˆæ¯å¹¶å‘é€æ¡Œé¢é€šçŸ¥
        socket.on('message', (data) => {
            if (desktopNotification.hasPermission()) {
                sendSystemNotification(
                    `æ–°æ¶ˆæ¯ - ${data.username}`,
                    data.message,
                    {
                        tag: 'new-message',
                        requireInteraction: false
                    }
                );
            }
        });
        
        // ç›‘å¬ç³»ç»Ÿäº‹ä»¶å¹¶å‘é€æ¡Œé¢é€šçŸ¥
        socket.on('system-event', (data) => {
            if (desktopNotification.hasPermission()) {
                sendSystemNotification(
                    `ç³»ç»Ÿäº‹ä»¶ - ${data.level.toUpperCase()}`,
                    data.message,
                    {
                        tag: 'system-event',
                        requireInteraction: data.level === 'error'
                    }
                );
            }
        });
        
        // æ¶ˆæ¯æœç´¢åŠŸèƒ½
        function searchMessages() {
            const searchTerm = document.getElementById('messageSearch').value.trim();
            const selectedRoom = document.getElementById('roomSelect').value || 'main';
            
            if (!searchTerm) {
                alert('è¯·è¾“å…¥æœç´¢å†…å®¹');
                return;
            }
            
            socket.emit('admin-search-messages', {
                searchTerm: searchTerm,
                roomName: selectedRoom
            });
        }
        
        // ç›‘å¬æ¶ˆæ¯æœç´¢ç»“æœ
        socket.on('admin-search-results', (data) => {
            const messagesContainer = document.getElementById('messagesContainer');
            
            if (data.messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”</div>
                        <div>æœªæ‰¾åˆ°åŒ¹é…çš„æ¶ˆæ¯</div>
                    </div>`;
                return;
            }
            
            // æ˜¾ç¤ºæœç´¢ç»“æœ
            messagesContainer.innerHTML = data.messages.map(msg => {
                let contentHtml = '';
                if (msg.type === 'image') {
                    contentHtml = `<img src="${msg.message}" alt="å›¾ç‰‡">`;
                } else if (msg.type === 'audio') {
                    contentHtml = `<audio controls><source src="${msg.message}" type="audio/webm">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾</audio>`;
                } else if (msg.type === 'video') {
                    contentHtml = `<video controls width="100%" max-height="300px"><source src="${msg.message}" type="video/webm">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾</video>`;
                } else {
                    // é«˜äº®æœç´¢ç»“æœ
                    let highlightedMessage = msg.message;
                    const searchTerm = document.getElementById('messageSearch').value.trim();
                    if (searchTerm) {
                        const regex = new RegExp(`(${searchTerm})`, 'gi');
                        highlightedMessage = msg.message.replace(regex, '<mark>$1</mark>');
                    }
                    contentHtml = highlightedMessage;
                }

                const statusText = msg.status === 'active' ? 'æ­£å¸¸' : 'å·²æ’¤å›';
                const statusClass = msg.status === 'active' ? 'active' : 'deleted';
                const recallTime = msg.recallTime ? `<br><small>æ’¤å›æ—¶é—´: ${msg.recallTime}</small>` : '';

                return `
                    <div class="message-item ${msg.status}">
                        <div class="message-header">
                            <div>
                                <span class="message-sender" style="color: ${msg.color}">${escapeHtml(msg.username)}</span>
                                <span class="message-status ${statusClass}">${statusText}</span>
                            </div>
                            <span class="message-time">${msg.timestamp}${recallTime}</span>
                        </div>
                        <div class="message-content">${contentHtml}</div>
                        ${msg.replyTo ? `<div class="reply-info" style="margin-top: 10px; padding: 10px; background: #f0f8ff; border-radius: 5px; font-size: 12px;">
                            <strong>å›å¤:</strong> ${escapeHtml(msg.replyTo.username)}: ${escapeHtml(msg.replyTo.message)}
                        </div>` : ''}
                    </div>
                `;
            }).join('');
        });
        
        // æ¶ˆæ¯å¼•ç”¨/å›å¤åŠŸèƒ½
        function replyToMessage(messageId, username, message) {
            // è¿™é‡Œå¯ä»¥å®ç°å›å¤æ¶ˆæ¯çš„åŠŸèƒ½
            console.log('å›å¤æ¶ˆæ¯:', messageId, username, message);
            // å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œå¯ä»¥æ‰“å¼€å›å¤æ¨¡æ€æ¡†ï¼Œå¡«å……å›å¤å†…å®¹
        }
        
        function login() {
            const password = adminPassword.value;
            socket.emit('admin-login', password);
        }

        socket.on('admin-login-success', (success) => {
            if (success) {
                loginContainer.classList.add('hidden');
                adminPanel.classList.add('active');
                loadMessages();
                loadRooms();
                loadFiles();
                // ä¸»åŠ¨è¯·æ±‚æœ€æ–°çš„ç”¨æˆ·åˆ—è¡¨
                socket.emit('admin-get-users');
                
                // å¯åŠ¨ç”¨æˆ·åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨ï¼ˆæ¯ç§’ä¸€æ¬¡ï¼‰
                if (userRefreshInterval) {
                    clearInterval(userRefreshInterval);
                }
                userRefreshInterval = setInterval(() => {
                    socket.emit('admin-get-users');
                }, 1000);
            } else {
                alert('å¯†ç é”™è¯¯ï¼');
                adminPassword.value = '';
            }
        })
        // ä¿®å¤ç™»å½•æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–DOMå…ƒç´ å¼•ç”¨
            loginContainer = document.getElementById('loginContainer');
            adminPanel = document.getElementById('adminPanel');
            adminPassword = document.getElementById('adminPassword');
            userList = document.getElementById('userList');
            userCount = document.getElementById('userCount');
            messageCount = document.getElementById('messageCount');
            deletedMessageCount = document.getElementById('deletedMessageCount');
            systemMessage = document.getElementById('systemMessage');
            renameModal = document.getElementById('renameModal');
            newUsername = document.getElementById('newUsername');
            messagesContainer = document.getElementById('messagesContainer');
            permissionsModal = document.getElementById('permissionsModal');
            permissionsForm = document.getElementById('permissionsForm');
            allowAudio = document.getElementById('allowAudio');
            allowImage = document.getElementById('allowImage');
            allowFile = document.getElementById('allowFile');
            allowSendMessages = document.getElementById('allowSendMessages');
            allowViewMessages = document.getElementById('allowViewMessages');
            allowCall = document.getElementById('allowCall');
            allowAIChat = document.getElementById('allowAIChat');
            allowAddFriends = document.getElementById('allowAddFriends');
            allowViewUsers = document.getElementById('allowViewUsers');
            allowPrivateChat = document.getElementById('allowPrivateChat');
            allowOpenFriendsPage = document.getElementById('allowOpenFriendsPage');
            allowRecallMessage = document.getElementById('allowRecallMessage');
            adminMessageModal = document.getElementById('adminMessageModal');
            disguiseUsername = document.getElementById('disguiseUsername');
            disguiseMessageType = document.getElementById('disguiseMessageType');
            disguiseMessage = document.getElementById('disguiseMessage');
            disguiseColor = document.getElementById('disguiseColor');
            usersModal = document.getElementById('usersModal');
            
            // ç¡®ä¿ç™»å½•å®¹å™¨å¯è§ï¼Œç®¡ç†é¢æ¿éšè—
            if (loginContainer) {
                loginContainer.classList.remove('hidden');
                console.log('ç™»å½•å®¹å™¨å·²è®¾ç½®ä¸ºå¯è§');
            }
            if (adminPanel) {
                adminPanel.classList.remove('active');
                console.log('ç®¡ç†é¢æ¿å·²è®¾ç½®ä¸ºéšè—');
            }
            if (adminPassword) {
                adminPassword.focus();
                console.log('ç®¡ç†å‘˜å¯†ç è¾“å…¥æ¡†å·²è·å¾—ç„¦ç‚¹');
            }
            
            // ç¡®ä¿ç™»å½•è¡¨å•æ­£ç¡®ç»‘å®š
            const loginForm = document.querySelector('.login-form form');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    login();
                });
            }
            
            // ç¡®ä¿ç®¡ç†å‘˜å¯†ç è¾“å…¥æ¡†çš„å›è½¦é”®äº‹ä»¶æ­£ç¡®ç»‘å®š
            if (adminPassword) {
                adminPassword.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        login();
                    }
                });
            }
            
            // ç¡®ä¿newUsernameè¾“å…¥æ¡†çš„å›è½¦é”®äº‹ä»¶æ­£ç¡®ç»‘å®š
            if (newUsername) {
                newUsername.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        confirmRename();
                    }
                });
            }
            
            // ç¡®ä¿systemMessageè¾“å…¥æ¡†çš„å›è½¦é”®äº‹ä»¶æ­£ç¡®ç»‘å®š
            if (systemMessage) {
                systemMessage.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendSystemMessage();
                    }
                });
            }
            
            // ç›´æ¥ç»‘å®šç™»å½•æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
            const loginButton = document.querySelector('.login-form button[type="submit"]');
            if (loginButton) {
                loginButton.addEventListener('click', function(e) {
                    e.preventDefault();
                    login();
                });
            }
            
            // åˆ›å»ºæ·±è‰²æ¨¡å¼åˆ‡æ¢æŒ‰é’®
            const darkModeToggle = document.createElement('button');
            darkModeToggle.className = 'dark-mode-toggle';
            darkModeToggle.innerHTML = 'ğŸŒ™';
            darkModeToggle.title = 'åˆ‡æ¢æ·±è‰²æ¨¡å¼';
            document.body.appendChild(darkModeToggle);
            
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­çš„æ·±è‰²æ¨¡å¼è®¾ç½®
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                darkModeToggle.innerHTML = 'â˜€ï¸';
            }
            
            // ç»‘å®šæ·±è‰²æ¨¡å¼åˆ‡æ¢äº‹ä»¶
            darkModeToggle.addEventListener('click', function() {
                const isDarkMode = document.body.classList.toggle('dark-mode');
                localStorage.setItem('darkMode', isDarkMode);
                darkModeToggle.innerHTML = isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™';
            });
        });
        
        // ç”¨æˆ·è®¾ç½®ç®¡ç†ç›¸å…³å‡½æ•°
        let selectedUserIdForSettings = null;
        
        function loadUsersForSettings() {
            socket.emit('admin-get-users');
        }
        
        // ç›‘å¬ç”¨æˆ·åˆ—è¡¨æ›´æ–°
        socket.on('user-joined', (data) => {
            updateSettingsUsersList(data.users);
        });
        
        function updateSettingsUsersList(users) {
            const usersList = document.getElementById('settingsUsersList');
            
            if (users.length === 0) {
                usersList.innerHTML = '<div class="empty-state"><div>æš‚æ— ç”¨æˆ·æ•°æ®</div></div>';
                return;
            }
            
            usersList.innerHTML = users.map(user => `
                    <div class="user-item" onclick="openUserSettingsForm('${user.socketId}', '${escapeHtml(user.username)}')">
                        <div class="user-info">
                            <div class="username">${escapeHtml(user.username)}</div>
                            <div class="socket-id">${user.socketId}</div>
                            <div class="room-name">æˆ¿é—´: ${user.roomName || 'main'}</div>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); openUserSettingsForm('${user.socketId}', '${escapeHtml(user.username)}')">è®¾ç½®</button>
                            <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); openVibrateModal('${user.socketId}', '${escapeHtml(user.username)}')">éœ‡åŠ¨</button>
                        </div>
                    </div>
                `).join('');
        }
        
        function openUserSettingsForm(socketId, username) {
            selectedUserIdForSettings = socketId;
            document.getElementById('selectedUsername').textContent = username;
            
            // åŠ è½½ç”¨æˆ·å½“å‰è®¾ç½®
            socket.emit('admin-get-user-settings', socketId);
            
            document.getElementById('userSettingsForm').style.display = 'block';
        }
        
        function closeUserSettingsForm() {
            document.getElementById('userSettingsForm').style.display = 'none';
            selectedUserIdForSettings = null;
        }
        
        function saveUserSettings() {
            if (!selectedUserIdForSettings) return;
            
            const lockUserSettings = document.getElementById('lockUserSettings').checked;
            const customLockMessage = document.getElementById('customLockMessage').value.trim() || 'è®¾ç½®å·²è¢«ç®¡ç†å‘˜é”å®š';
            
            // è·å–ç”¨æˆ·å…·ä½“è®¾ç½®å€¼
            const userSettings = {
                targetLanguage: document.getElementById('userTargetLanguage').value,
                autoTranslate: document.getElementById('userAutoTranslate').checked,
                soundNotification: document.getElementById('userSoundNotification').checked,
                mentionNotification: document.getElementById('userMentionNotification').checked,
                developerMode: document.getElementById('userDeveloperMode').checked,
                mirrorVideo: document.getElementById('userMirrorVideo').checked,
                remoteMirrorVideo: document.getElementById('userRemoteMirrorVideo').checked,
                autoAdjustVolume: document.getElementById('userAutoAdjustVolume').checked,
                enableSubtitles: document.getElementById('userEnableSubtitles').checked,
                speakingThreshold: parseInt(document.getElementById('userSpeakingThreshold').value),
                volumeReduction: parseInt(document.getElementById('userVolumeReduction').value),
                subtitlesFontSize: parseInt(document.getElementById('userSubtitlesFontSize').value),
                enableAIChat: document.getElementById('userEnableAIChat').checked,
                aiModel: document.getElementById('userAiModel').value
            };
            
            socket.emit('admin-set-user-settings', {
                socketId: selectedUserIdForSettings,
                settings: {
                    locked: lockUserSettings,
                    lockMessage: customLockMessage
                },
                userSettings: userSettings
            });
            
            closeUserSettingsForm();
        }
        
        // éœ‡åŠ¨å¼ºåº¦æ»‘å—äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', function() {
            const vibrateIntensity = document.getElementById('vibrateIntensity');
            const vibrateIntensityValue = document.getElementById('vibrateIntensityValue');
            
            if (vibrateIntensity && vibrateIntensityValue) {
                vibrateIntensity.addEventListener('input', function() {
                    vibrateIntensityValue.textContent = this.value;
                });
            }
        });
        
        // ç›‘å¬ç”¨æˆ·è®¾ç½®å“åº”
        socket.on('admin-user-settings', (data) => {
            document.getElementById('lockUserSettings').checked = data.settings.locked || false;
            document.getElementById('customLockMessage').value = data.settings.lockMessage || 'è®¾ç½®å·²è¢«ç®¡ç†å‘˜é”å®š';
            
            // è®¾ç½®ç”¨æˆ·å…·ä½“è®¾ç½®å€¼
            document.getElementById('userTargetLanguage').value = data.userSettings?.targetLanguage || 'zh';
            document.getElementById('userAutoTranslate').checked = data.userSettings?.autoTranslate || false;
            document.getElementById('userSoundNotification').checked = data.userSettings?.soundNotification !== false;
            document.getElementById('userMentionNotification').checked = data.userSettings?.mentionNotification !== false;
            document.getElementById('userDeveloperMode').checked = data.userSettings?.developerMode || false;
            document.getElementById('userMirrorVideo').checked = data.userSettings?.mirrorVideo !== false;
            document.getElementById('userRemoteMirrorVideo').checked = data.userSettings?.remoteMirrorVideo || false;
            document.getElementById('userAutoAdjustVolume').checked = data.userSettings?.autoAdjustVolume !== false;
            document.getElementById('userEnableSubtitles').checked = data.userSettings?.enableSubtitles || false;
            document.getElementById('userSpeakingThreshold').value = data.userSettings?.speakingThreshold || 40;
            document.getElementById('userSpeakingThresholdValue').textContent = data.userSettings?.speakingThreshold || 40;
            document.getElementById('userVolumeReduction').value = data.userSettings?.volumeReduction || 30;
            document.getElementById('userVolumeReductionValue').textContent = (data.userSettings?.volumeReduction || 30) + '%';
            document.getElementById('userSubtitlesFontSize').value = data.userSettings?.subtitlesFontSize || 16;
            document.getElementById('userSubtitlesFontSizeValue').textContent = (data.userSettings?.subtitlesFontSize || 16) + 'px';
            document.getElementById('userEnableAIChat').checked = data.userSettings?.enableAIChat || false;
            document.getElementById('userAiModel').value = data.userSettings?.aiModel || 'glm4';
        });
        
        // ç”¨æˆ·è®¾ç½®ç®¡ç†ç›¸å…³å‡½æ•° - æ‰©å±•è·å–ç”¨æˆ·è®¾ç½®ï¼ŒåŒ…å«å…·ä½“è®¾ç½®å€¼
        function openUserSettingsForm(socketId, username) {
            selectedUserIdForSettings = socketId;
            document.getElementById('selectedUsername').textContent = username;
            
            // åŠ è½½ç”¨æˆ·å½“å‰è®¾ç½®ï¼ŒåŒ…å«å…·ä½“è®¾ç½®å€¼
            socket.emit('admin-get-user-settings', socketId);
            
            document.getElementById('userSettingsForm').style.display = 'block';
        }
        
        // éœ‡åŠ¨æ§åˆ¶åŠŸèƒ½
        let selectedUserIdForVibrate = null;
        let selectedUserNameForVibrate = '';
        
        function openVibrateModal(socketId, username) {
            selectedUserIdForVibrate = socketId;
            selectedUserNameForVibrate = username;
            document.getElementById('vibrateUserName').textContent = username;
            document.getElementById('vibrateModal').style.display = 'block';
        }
        
        function closeVibrateModal() {
            document.getElementById('vibrateModal').style.display = 'none';
            selectedUserIdForVibrate = null;
            selectedUserNameForVibrate = '';
        }
        
        function sendVibrateCommand() {
            if (!selectedUserIdForVibrate) return;
            
            const duration = parseInt(document.getElementById('vibrateDuration').value) || 500;
            const intensity = parseInt(document.getElementById('vibrateIntensity').value) || 1;
            
            socket.emit('admin-vibrate-user', {
                socketId: selectedUserIdForVibrate,
                duration: duration,
                intensity: intensity
            });
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            document.getElementById('vibrateSuccess').style.display = 'block';
            setTimeout(() => {
                document.getElementById('vibrateSuccess').style.display = 'none';
                closeVibrateModal();
            }, 2000);
        }
        
        // é€šè¯ç®¡ç†åŠŸèƒ½
        let currentCallId = null;
        
        // åŠ è½½æ­£åœ¨è¿›è¡Œçš„é€šè¯åˆ—è¡¨
        async function loadOngoingCalls() {
            try {
                const response = await fetch('/api/admin/calls');
                const data = await response.json();
                
                const callsList = document.getElementById('ongoingCallsList');
                
                if (data.calls.length === 0) {
                    callsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <div>æš‚æ— æ­£åœ¨è¿›è¡Œçš„é€šè¯</div>
                        </div>`;
                    return;
                }
                
                callsList.innerHTML = data.calls.map(call => {
                    const startTime = new Date(call.startTime).toLocaleString('zh-CN');
                    return `
                        <div class="user-item">
                            <div class="user-info">
                                <div class="user-name">${escapeHtml(call.initiatorUsername)} â†’ ${escapeHtml(call.recipientUsername)}</div>
                                <small style="color: #666;">${call.callType}é€šè¯ | å¼€å§‹äº: ${startTime} | é€šè¯ID: ${call.callId}</small>
                            </div>
                            <div class="user-actions">
                                <button class="btn btn-info" onclick="viewCallDetails('${call.callId}')">æŸ¥çœ‹è¯¦æƒ…</button>
                                <button class="btn btn-danger" onclick="endCall('${call.callId}')">ç»“æŸé€šè¯</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½é€šè¯åˆ—è¡¨å¤±è´¥:', error);
                alert('åŠ è½½é€šè¯åˆ—è¡¨å¤±è´¥');
            }
        }
        
        // æŸ¥çœ‹é€šè¯è¯¦æƒ…
        async function viewCallDetails(callId) {
            try {
                const response = await fetch(`/api/admin/calls/${callId}`);
                const data = await response.json();
                
                currentCallId = callId;
                const call = data.call;
                const startTime = new Date(call.startTime).toLocaleString('zh-CN');
                
                // æ›´æ–°é€šè¯ç›‘æ§ä¿¡æ¯
                updateCallMonitoring(callId, call);
                
                // æ˜¾ç¤ºé€šè¯æ–¹å¼
                const callMethodDisplay = document.getElementById('callMethodDisplay');
                const videoModeNote = document.getElementById('videoModeNote');
                if (call.callMethod === 'socket.io') {
                    callMethodDisplay.innerHTML = `ã€Socket.ioæ¨¡å¼ - æ”¯æŒç®¡ç†å‘˜ç›‘æ§ã€‘`;
                    videoModeNote.innerHTML = 'Socket.ioæ¨¡å¼ï¼šæ•°æ®ç»è¿‡æœåŠ¡å™¨è½¬å‘ï¼Œç®¡ç†å‘˜å¯ä»¥å®æ—¶ç›‘æ§é€šè¯ç”»é¢ã€‚';
                    videoModeNote.style.color = '#28a745';
                } else {
                    callMethodDisplay.innerHTML = `ã€WebRTCæ¨¡å¼ - ç‚¹å¯¹ç‚¹é€šä¿¡ã€‘`;
                    videoModeNote.innerHTML = 'WebRTCä¸ºç‚¹å¯¹ç‚¹é€šè¯ï¼Œæ•°æ®ä¸ç»è¿‡æœåŠ¡å™¨ï¼Œç®¡ç†å‘˜æ— æ³•æŸ¥çœ‹ç”»é¢ã€‚è¯·ä½¿ç”¨Socket.ioæ¨¡å¼è¿›è¡Œå¯ç›‘æ§çš„é€šè¯ã€‚';
                    videoModeNote.style.color = '#dc3545';
                }
                
                const callDetailsInfo = document.getElementById('callDetailsInfo');
                callDetailsInfo.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>é€šè¯ID:</strong> ${call.callId}
                        </div>
                        <div>
                            <strong>é€šè¯ç±»å‹:</strong> ${call.callType}
                        </div>
                        <div>
                            <strong>é€šè¯æ–¹å¼:</strong> ${call.callMethod === 'socket.io' ? 'Socket.io' : 'WebRTC'}
                        </div>
                        <div>
                            <strong>å‘èµ·æ–¹:</strong> ${escapeHtml(call.initiatorUsername)}
                        </div>
                        <div>
                            <strong>æ¥æ”¶æ–¹:</strong> ${escapeHtml(call.recipientUsername)}
                        </div>
                        <div>
                            <strong>å¼€å§‹æ—¶é—´:</strong> ${startTime}
                        </div>
                        <div>
                            <strong>çŠ¶æ€:</strong> ${call.status}
                        </div>
                        <div>
                            <strong>è§†é¢‘æ§åˆ¶:</strong> ${call.controls.videoEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
                        </div>
                        <div>
                            <strong>éŸ³é¢‘æ§åˆ¶:</strong> ${call.controls.audioEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <h4>é€šè¯åŒæ–¹</h4>
                        <div style="display: flex; gap: 20px;">
                            <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                                <strong>å‘èµ·æ–¹:</strong> ${escapeHtml(call.initiatorUsername)}
                                <br>
                                <small>Socket ID: ${call.initiator}</small>
                            </div>
                            <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                                <strong>æ¥æ”¶æ–¹:</strong> ${escapeHtml(call.recipientUsername)}
                                <br>
                                <small>Socket ID: ${call.recipient}</small>
                            </div>
                        </div>
                    </div>
                `;
                
                // é‡ç½®è§†é¢‘å…ƒç´ å’ŒçŠ¶æ€
                resetVideoDisplay('initiator');
                resetVideoDisplay('recipient');
                
                document.getElementById('callDetailsModal').classList.add('active');
            } catch (error) {
                console.error('è·å–é€šè¯è¯¦æƒ…å¤±è´¥:', error);
                alert('è·å–é€šè¯è¯¦æƒ…å¤±è´¥');
            }
        }
        
        // é‡ç½®è§†é¢‘æ˜¾ç¤º
        function resetVideoDisplay(side) {
            const video = document.getElementById(`${side}Video`);
            const container = document.getElementById(`${side}VideoContainer`);
            const status = document.getElementById(`${side}VideoStatus`);
            
            if (video) {
                video.style.display = 'none';
                video.src = '';
            }
            if (container) {
                container.style.display = 'flex';
            }
            if (status) {
                status.textContent = 'ç­‰å¾…é€šè¯æ•°æ®...';
            }
            
            // æ¸…ç†MediaSource
            const socketId = side === 'initiator' ? monitoredCalls.get(currentCallId)?.initiator : monitoredCalls.get(currentCallId)?.recipient;
            if (socketId && mediaSourceMap.has(socketId)) {
                try {
                    const msData = mediaSourceMap.get(socketId);
                    if (msData && msData.mediaSource.readyState === 'open') {
                        msData.sourceBuffer.remove(0, Infinity);
                    }
                    mediaSourceMap.delete(socketId);
                } catch (e) {
                    console.error('æ¸…ç†MediaSourceå¤±è´¥:', e);
                }
            }
        }
        
        // å…³é—­é€šè¯è¯¦æƒ…æ¨¡æ€æ¡†
        function closeCallDetailsModal() {
            document.getElementById('callDetailsModal').classList.remove('active');
            
            // æ¸…ç†é€šè¯ç›‘æ§èµ„æº
            if (currentCallId) {
                // æ¸…ç†MediaSourceèµ„æº
                const callInfo = monitoredCalls.get(currentCallId);
                if (callInfo) {
                    [callInfo.initiator, callInfo.recipient].forEach(socketId => {
                        if (mediaSourceMap.has(socketId)) {
                            try {
                                const msData = mediaSourceMap.get(socketId);
                                if (msData) {
                                    const { mediaSource, sourceBuffer } = msData;
                                    if (mediaSource.readyState === 'open') {
                                        try {
                                            sourceBuffer.remove(0, Infinity);
                                        } catch (e) {}
                                    }
                                    mediaSource.removeEventListener('sourceopen', null);
                                }
                            } catch (e) {
                                console.error('æ¸…ç†MediaSourceå¤±è´¥:', e);
                            }
                            mediaSourceMap.delete(socketId);
                        }
                    });
                }
                
                monitoredCalls.delete(currentCallId);
                
                // åœæ­¢å¹¶æ¸…ç†åª’ä½“æµ
                ['initiator', 'recipient'].forEach(side => {
                    const video = document.getElementById(`${side}Video`);
                    const container = document.getElementById(`${side}VideoContainer`);
                    
                    if (video) {
                        video.pause();
                        video.src = '';
                        video.load();
                    }
                    if (container) {
                        container.style.display = 'flex';
                    }
                });
            }
            
            currentCallId = null;
        }
        
        // å¤„ç†é€šè¯åª’ä½“æµ
        function handleCallMedia(data) {
            const callId = data.callId;
            const fromSocketId = data.from;
            
            // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ç›‘æ§è¯¥é€šè¯
            const callInfo = monitoredCalls.get(callId);
            if (!callInfo) return;
            
            // æ ¹æ®å‘é€è€…ç¡®å®šæ˜¾ç¤ºä½ç½®
            let side = null;
            if (fromSocketId === callInfo.initiator) {
                side = 'initiator';
            } else if (fromSocketId === callInfo.recipient) {
                side = 'recipient';
            } else {
                return;
            }
            
            const video = document.getElementById(`${side}Video`);
            const container = document.getElementById(`${side}VideoContainer`);
            const status = document.getElementById(`${side}VideoStatus`);
            
            if (!video || !container || !status) return;
            
            try {
                // æ£€æŸ¥æ˜¯å¦æ”¯æŒMediaSource
                if (MediaSource && MediaSource.isTypeSupported('video/webm')) {
                    // ä½¿ç”¨MediaSourceæ–¹å¼
                    if (!mediaSourceMap.has(fromSocketId)) {
                        // åˆ›å»ºæ–°çš„MediaSource
                        const mediaSource = new MediaSource();
                        video.src = URL.createObjectURL(mediaSource);
                        video.style.display = 'block';
                        container.style.display = 'none';
                        status.textContent = 'æ­£åœ¨åŠ è½½è§†é¢‘...';
                        
                        mediaSource.addEventListener('sourceopen', () => {
                            try {
                                const sourceBuffer = mediaSource.addSourceBuffer('video/webm');
                                sourceBuffer.mode = 'segments';
                                sourceBuffer.addEventListener('updateend', () => {
                                    if (mediaSource.readyState === 'open' && !sourceBuffer.updating) {
                                        // å¯ä»¥ç»§ç»­æ·»åŠ æ›´å¤šæ•°æ®
                                    }
                                });
                                mediaSourceMap.set(fromSocketId, {
                                    mediaSource: mediaSource,
                                    sourceBuffer: sourceBuffer,
                                    video: video
                                });
                                status.textContent = 'æ­£åœ¨æ’­æ”¾è§†é¢‘...';
                            } catch (e) {
                                console.error('åˆ›å»ºSourceBufferå¤±è´¥:', e);
                                status.textContent = 'è§†é¢‘åŠ è½½å¤±è´¥';
                            }
                        });
                    }
                    
                    // æ·»åŠ æ•°æ®åˆ°SourceBuffer
                    const msData = mediaSourceMap.get(fromSocketId);
                    if (msData && msData.sourceBuffer && !msData.sourceBuffer.updating && msData.mediaSource.readyState === 'open') {
                        const chunk = new Uint8Array(data.data);
                        try {
                            msData.sourceBuffer.appendBuffer(chunk);
                            video.style.display = 'block';
                            container.style.display = 'none';
                            status.textContent = 'æ­£åœ¨æ’­æ”¾è§†é¢‘...';
                        } catch (e) {
                            console.error('æ·»åŠ è§†é¢‘æ•°æ®å¤±è´¥:', e);
                        }
                    }
                } else {
                    // å›é€€åˆ°Blobæ–¹å¼ï¼Œä½†ä½¿ç”¨æ›´å¤§çš„ç¼“å†²åŒº
                    if (video.src) {
                        // å¦‚æœå·²æœ‰srcï¼Œä½¿ç”¨ç°æœ‰URL
                    }
                    
                    // å°†æ•°æ®è½¬æ¢ä¸ºBlob
                    const blob = new Blob([data.data], { type: 'video/webm' });
                    
                    // åˆ›å»ºObject URL
                    const url = URL.createObjectURL(blob);
                    video.src = url;
                    video.style.display = 'block';
                    container.style.display = 'none';
                    status.textContent = 'æ­£åœ¨æ’­æ”¾è§†é¢‘...';
                    
                    // å°è¯•æ’­æ”¾
                    video.play().catch(err => {
                        console.log(`${side}è§†é¢‘è‡ªåŠ¨æ’­æ”¾å¤±è´¥:`, err.message);
                    });
                }
            } catch (error) {
                console.error('å¤„ç†é€šè¯åª’ä½“æµå¤±è´¥:', error);
                status.textContent = 'è§†é¢‘å¤„ç†å¤±è´¥';
            }
        }
        
        // æ›´æ–°é€šè¯ç›‘æ§ä¿¡æ¯
        function updateCallMonitoring(callId, callInfo) {
            monitoredCalls.set(callId, {
                initiator: callInfo.initiator,
                recipient: callInfo.recipient
            });
        }
        
        // ç»“æŸé€šè¯
        async function endCall(callId) {
            const id = callId || currentCallId;
            if (!id) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªé€šè¯');
                return;
            }
            
            if (confirm('ç¡®å®šè¦ç»“æŸè¿™ä¸ªé€šè¯å—ï¼Ÿ')) {
                try {
                    const response = await fetch(`/api/admin/calls/${id}/end`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('é€šè¯å·²ç»“æŸ');
                        loadOngoingCalls();
                        closeCallDetailsModal();
                    } else {
                        alert('ç»“æŸé€šè¯å¤±è´¥: ' + data.error);
                    }
                } catch (error) {
                    console.error('ç»“æŸé€šè¯å¤±è´¥:', error);
                    alert('ç»“æŸé€šè¯å¤±è´¥');
                }
            }
        }
        
        // åˆ‡æ¢é€šè¯æ§åˆ¶
        async function toggleCallControl(type) {
            if (!currentCallId) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªé€šè¯');
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/calls/${currentCallId}/control`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: type,
                        enabled: false // åˆ‡æ¢ä¸ºç¦ç”¨ï¼Œç®¡ç†å‘˜å¯ä»¥éšæ—¶åˆ‡æ¢
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(`å·²åˆ‡æ¢${type}æ§åˆ¶`);
                    viewCallDetails(currentCallId); // åˆ·æ–°é€šè¯è¯¦æƒ…
                } else {
                    alert('åˆ‡æ¢æ§åˆ¶å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åˆ‡æ¢é€šè¯æ§åˆ¶å¤±è´¥:', error);
                alert('åˆ‡æ¢é€šè¯æ§åˆ¶å¤±è´¥');
            }
        }
        
        // æ‰¹é‡æ“ä½œç›¸å…³å‡½æ•°
        function selectAllUsers() {
            document.querySelectorAll('.user-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
        }
        
        function deselectAllUsers() {
            document.querySelectorAll('.user-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
        }
        
        function batchKickUsers() {
            const selectedUsers = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(checkbox => checkbox.value);
            if (selectedUsers.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦è¸¢å‡ºçš„ç”¨æˆ·');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦è¸¢å‡ºé€‰ä¸­çš„ ${selectedUsers.length} ä¸ªç”¨æˆ·å—ï¼Ÿ`)) {
                socket.emit('admin-batch-action', {
                    action: 'kick',
                    userIds: selectedUsers
                });
                
                // æ¸…ç©ºé€‰æ‹©
                deselectAllUsers();
                
                // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                socket.emit('admin-get-users');
            }
        }
        
        function batchMuteUsers() {
            const selectedUsers = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(checkbox => checkbox.value);
            if (selectedUsers.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦ç¦è¨€çš„ç”¨æˆ·');
                return;
            }
            
            const duration = prompt('è¯·è¾“å…¥ç¦è¨€æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼Œ-1è¡¨ç¤ºæ°¸ä¹…ï¼‰:', '5');
            const reason = prompt('è¯·è¾“å…¥ç¦è¨€åŸå› :', 'è¿åèŠå¤©å®¤è§„åˆ™');
            
            if (duration !== null && reason !== null) {
                const muteDuration = parseInt(duration);
                if (!isNaN(muteDuration)) {
                    socket.emit('admin-batch-action', {
                        action: 'mute',
                        userIds: selectedUsers,
                        duration: muteDuration,
                        reason: reason
                    });
                    
                    // æ¸…ç©ºé€‰æ‹©
                    deselectAllUsers();
                    
                    // åˆ·æ–°ç”¨æˆ·åˆ—è¡¨
                    socket.emit('admin-get-users');
                } else {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç¦è¨€æ—¶é•¿');
                }
            }
        }
        
        function batchSetPermissions() {
            const selectedUsers = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(checkbox => checkbox.value);
            if (selectedUsers.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦è®¾ç½®æƒé™çš„ç”¨æˆ·');
                return;
            }
            
            // æ‰“å¼€æƒé™è®¾ç½®æ¨¡æ€æ¡†
            permissionsModal.classList.add('active');
            
            // ä¿å­˜é€‰ä¸­çš„ç”¨æˆ·ID
            window.batchSelectedUsers = selectedUsers;
        }
        
        // é‡å†™confirmPermissionså‡½æ•°ä»¥æ”¯æŒæ‰¹é‡æ“ä½œ
        function confirmPermissions() {
            if (window.batchSelectedUsers && window.batchSelectedUsers.length > 0) {
                // æ‰¹é‡è®¾ç½®æƒé™
                const permissions = {
                    allowAudio: allowAudio.checked,
                    allowImage: allowImage.checked,
                    allowFile: allowFile.checked,
                    allowSendMessages: allowSendMessages.checked,
                    allowViewMessages: allowViewMessages.checked,
                    allowCall: allowCall.checked,
                    allowAIChat: allowAIChat.checked,
                    allowAddFriends: allowAddFriends.checked,
                    allowViewUsers: allowViewUsers.checked,
                    allowPrivateChat: allowPrivateChat.checked,
                    allowOpenFriendsPage: allowOpenFriendsPage.checked,
                    allowRecallMessage: allowRecallMessage.checked
                };
                
                socket.emit('admin-batch-action', {
                    action: 'setPermissions',
                    userIds: window.batchSelectedUsers,
                    permissions: permissions
                });
                
                // æ¸…ç©ºé€‰æ‹©
                window.batchSelectedUsers = null;
                deselectAllUsers();
            } else if (selectedPermissionsSocketId) {
                // å•ä¸ªç”¨æˆ·è®¾ç½®æƒé™
                if (currentRoomName) {
                    // å¦‚æœåœ¨æˆ¿é—´ç”¨æˆ·åˆ—è¡¨ä¸­è®¾ç½®æƒé™ï¼Œä½¿ç”¨æˆ¿é—´å†…æƒé™è®¾ç½®åŠŸèƒ½
                    socket.emit('admin-room-set-permissions', {
                        roomName: currentRoomName,
                        socketId: selectedPermissionsSocketId,
                        permissions: {
                            allowAudio: allowAudio.checked,
                            allowImage: allowImage.checked,
                            allowFile: allowFile.checked,
                            allowSendMessages: allowSendMessages.checked,
                            allowViewMessages: allowViewMessages.checked,
                            allowCall: allowCall.checked,
                            allowAIChat: allowAIChat.checked,
                            allowAddFriends: allowAddFriends.checked,
                            allowViewUsers: allowViewUsers.checked,
                            allowPrivateChat: allowPrivateChat.checked,
                            allowOpenFriendsPage: allowOpenFriendsPage.checked,
                            allowRecallMessage: allowRecallMessage.checked
                        }
                    });
                    
                    // é‡æ–°è·å–æˆ¿é—´ç”¨æˆ·åˆ—è¡¨
                    socket.emit('admin-get-room-users', currentRoomName);
                } else {
                    // å¦åˆ™ä½¿ç”¨å…¨å±€æƒé™è®¾ç½®åŠŸèƒ½
                    socket.emit('admin-set-permissions', {
                        socketId: selectedPermissionsSocketId,
                        permissions: {
                            allowAudio: allowAudio.checked,
                            allowImage: allowImage.checked,
                            allowFile: allowFile.checked,
                            allowSendMessages: allowSendMessages.checked,
                            allowViewMessages: allowViewMessages.checked,
                            allowCall: allowCall.checked,
                            allowAIChat: allowAIChat.checked,
                            allowAddFriends: allowAddFriends.checked,
                            allowViewUsers: allowViewUsers.checked,
                            allowPrivateChat: allowPrivateChat.checked,
                            allowOpenFriendsPage: allowOpenFriendsPage.checked,
                            allowRecallMessage: allowRecallMessage.checked
                        }
                    });
                }
            }
            
            closePermissionsModal();
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨
        window.addEventListener('beforeunload', () => {
            if (userRefreshInterval) {
                clearInterval(userRefreshInterval);
            }
            if (roomDetailsRefreshInterval) {
                clearInterval(roomDetailsRefreshInterval);
            }
        });
        
        // æ›´æ–°é€šçŸ¥ç›¸å…³åŠŸèƒ½
        function openUpdateModal() {
            const updateModal = document.getElementById('updateModal');
            updateModal.classList.add('active');
        }
        
        function closeUpdateModal() {
            const updateModal = document.getElementById('updateModal');
            updateModal.classList.remove('active');
            // é‡ç½®è¡¨å•
            document.getElementById('updateVersion').value = '';
            document.getElementById('updateContent').value = '';
            document.getElementById('forceUpdate').checked = false;
            document.getElementById('updateTarget').value = 'all';
            document.getElementById('updateProbability').value = '';
            document.getElementById('specificUsers').value = '';
        }
        
        function loadUpdateHistory() {
            socket.emit('get-update-history');
        }
        
        function displayUpdateHistory(history) {
            const historyContainer = document.getElementById('updateHistory');
            if (history.length === 0) {
                historyContainer.innerHTML = '<p>æš‚æ— æ›´æ–°å†å²</p>';
                return;
            }
            
            const historyHTML = history.map(update => `
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h4 style="margin: 0; color: #667eea;">ç‰ˆæœ¬ ${update.version}</h4>
                        <span style="font-size: 12px; color: #999;">${update.timeString}</span>
                    </div>
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-bottom: 10px; white-space: pre-wrap; font-size: 14px; color: #666;">
                        ${update.content}
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span style="font-size: 12px; padding: 3px 8px; border-radius: 12px; background: ${update.forceUpdate ? '#ff6b6b' : '#4ecdc4'}; color: white;">
                            ${update.forceUpdate ? 'å¼ºåˆ¶æ›´æ–°' : 'å¯é€‰æ›´æ–°'}
                        </span>
                        <span style="font-size: 12px; color: #999;">
                            ${update.target || 'å…¨ä½“ç”¨æˆ·'}
                        </span>
                    </div>
                </div>
            `).join('');
            
            historyContainer.innerHTML = historyHTML;
        }
        
        function publishUpdate() {
            const version = document.getElementById('updateVersion').value;
            const content = document.getElementById('updateContent').value;
            const forceUpdate = document.getElementById('forceUpdate').checked;
            const target = document.getElementById('updateTarget').value;
            const probability = document.getElementById('updateProbability').value;
            const specificUsers = document.getElementById('specificUsers').value;
            
            if (!version || !content) {
                alert('è¯·å¡«å†™ç‰ˆæœ¬å·å’Œæ›´æ–°å†…å®¹');
                return;
            }
            
            // éªŒè¯æ¦‚ç‡å€¼
            if (target === 'probability' && (!probability || isNaN(probability) || probability < 0 || probability > 100)) {
                alert('è¯·è¾“å…¥0-100ä¹‹é—´çš„æœ‰æ•ˆæ¦‚ç‡å€¼');
                return;
            }
            
            // éªŒè¯ç‰¹å®šç”¨æˆ·
            if (target === 'specific' && !specificUsers) {
                alert('è¯·è¾“å…¥ç‰¹å®šç”¨æˆ·IDï¼Œå¤šä¸ªç”¨æˆ·ç”¨é€—å·åˆ†éš”');
                return;
            }
            
            // å‘é€æ›´æ–°é€šçŸ¥åˆ°æœåŠ¡å™¨
            socket.emit('admin-publish-update', {
                version: version,
                content: content,
                forceUpdate: forceUpdate,
                target: target,
                probability: target === 'probability' ? parseFloat(probability) : null,
                specificUsers: target === 'specific' ? specificUsers.split(',').map(id => id.trim()) : null
            });
            
            alert('æ›´æ–°å·²å‘å¸ƒï¼');
            closeUpdateModal();
            loadUpdateHistory(); // é‡æ–°åŠ è½½æ›´æ–°å†å²
        }
        
        // ç›‘å¬æ›´æ–°ç›®æ ‡åˆ‡æ¢
        function updateTargetChanged() {
            const target = document.getElementById('updateTarget').value;
            const probabilityGroup = document.getElementById('probabilityGroup');
            const specificUsersGroup = document.getElementById('specificUsersGroup');
            
            probabilityGroup.style.display = target === 'probability' ? 'block' : 'none';
            specificUsersGroup.style.display = target === 'specific' ? 'block' : 'none';
        }
        
        // èŠå¤©å®¤æç¤ºç›¸å…³åŠŸèƒ½
        function openChatroomNotificationModal() {
            const modal = document.getElementById('chatroomNotificationModal');
            modal.classList.add('active');
        }
        
        function closeChatroomNotificationModal() {
            const modal = document.getElementById('chatroomNotificationModal');
            modal.classList.remove('active');
            // é‡ç½®è¡¨å•
            document.getElementById('notificationTitle').value = '';
            document.getElementById('notificationContent').value = '';
            document.getElementById('notificationButtonText').value = 'è¿›å…¥èŠå¤©å®¤';
            document.getElementById('notificationButtonColor').value = '#667eea';
            document.getElementById('notificationButtonColorText').value = '#667eea';
            document.getElementById('notificationBackgroundColor').value = '#ffffff';
            document.getElementById('notificationBackgroundColorText').value = '#ffffff';
            document.getElementById('notificationForceAction').checked = false;
            document.getElementById('notificationTarget').value = 'all';
            document.getElementById('notificationProbability').value = '';
            document.getElementById('notificationSpecificUsers').value = '';
            notificationTargetChanged();
        }
        
        function notificationTargetChanged() {
            const target = document.getElementById('notificationTarget').value;
            const probabilityGroup = document.getElementById('notificationProbabilityGroup');
            const specificUsersGroup = document.getElementById('notificationSpecificUsersGroup');
            
            probabilityGroup.style.display = target === 'probability' ? 'block' : 'none';
            specificUsersGroup.style.display = target === 'specific' ? 'block' : 'none';
        }
        
        function sendChatroomNotification() {
            const title = document.getElementById('notificationTitle').value;
            const content = document.getElementById('notificationContent').value;
            const buttonText = document.getElementById('notificationButtonText').value;
            const buttonColor = document.getElementById('notificationButtonColorText').value;
            const backgroundColor = document.getElementById('notificationBackgroundColorText').value;
            const forceAction = document.getElementById('notificationForceAction').checked;
            const target = document.getElementById('notificationTarget').value;
            const probability = document.getElementById('notificationProbability').value;
            const specificUsers = document.getElementById('notificationSpecificUsers').value;
            
            if (!title || !content) {
                alert('è¯·å¡«å†™æç¤ºæ ‡é¢˜å’Œå†…å®¹');
                return;
            }
            
            // éªŒè¯æ¦‚ç‡å€¼
            if (target === 'probability' && (!probability || isNaN(probability) || probability < 0 || probability > 100)) {
                alert('è¯·è¾“å…¥0-100ä¹‹é—´çš„æœ‰æ•ˆæ¦‚ç‡å€¼');
                return;
            }
            
            // éªŒè¯ç‰¹å®šç”¨æˆ·
            if (target === 'specific' && !specificUsers) {
                alert('è¯·è¾“å…¥ç‰¹å®šç”¨æˆ·IDï¼Œå¤šä¸ªç”¨æˆ·ç”¨é€—å·åˆ†éš”');
                return;
            }
            
            // å‘é€é€šçŸ¥
            socket.emit('admin-send-chatroom-notification', {
                title: title,
                content: content,
                buttonText: buttonText,
                buttonColor: buttonColor,
                backgroundColor: backgroundColor,
                forceAction: forceAction,
                target: target,
                probability: target === 'probability' ? parseFloat(probability) : null,
                specificUsers: target === 'specific' ? specificUsers.split(',').map(id => id.trim()) : null
            });
            
            closeChatroomNotificationModal();
            
            // ç›´æ¥æ˜¾ç¤ºå¯äº¤äº’çš„æç¤ºæ¡†
            const notificationData = {
                id: 'temp_notification_' + Date.now(),
                title: title,
                content: content,
                buttonText: buttonText,
                buttonColor: buttonColor,
                backgroundColor: backgroundColor,
                forceAction: forceAction,
                timestamp: new Date().toLocaleTimeString()
            };
            
            showAdminChatroomNotification(notificationData);
        }
        
        // ç®¡ç†å‘˜ç•Œé¢æ˜¾ç¤ºå¯äº¤äº’èŠå¤©å®¤æç¤º
        function showAdminChatroomNotification(data) {
            // ç”Ÿæˆå”¯ä¸€ID
            const notificationId = data.id || ('adminNotification_' + Date.now() + '_' + Math.floor(Math.random() * 1000));
            
            // åˆ›å»ºæ‚¬æµ®æç¤ºå…ƒç´ 
            const notification = document.createElement('div');
            notification.id = notificationId;
            notification.className = 'admin-notification';
            notification.dataset.notificationId = notificationId;
            notification.style.cssText = `
                position: fixed;
                top: 100px;
                right: 20px;
                background: ${data.backgroundColor || '#ffffff'};
                border-radius: 10px;
                padding: 20px;
                max-width: 400px;
                width: 320px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
                text-align: center;
                z-index: 10000;
                cursor: move;
                transition: all 0.3s ease;
                border: 2px solid ${data.buttonColor || '#667eea'};
            `;
            
            // è®¾ç½®åˆå§‹ä½ç½®ï¼ˆå³ä¾§å‚ç›´æ’åˆ—ï¼‰
            const existingNotifications = document.querySelectorAll('.admin-notification');
            const topPosition = 100 + (existingNotifications.length * 280);
            notification.style.top = `${topPosition}px`;
            
            const notificationHTML = `
                <div class="notification-header" style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <h3 class="notification-title" style="margin: 0; font-size: 18px; color: #333; cursor: pointer;">
                        ${data.title || 'èŠå¤©å®¤æç¤º'}
                    </h3>
                    <div class="notification-controls" style="display: flex; gap: 8px;">
                        <button class="control-btn edit-btn" style="padding: 4px 8px; background: #ffc107; color: #333; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            âœï¸
                        </button>
                        <button class="control-btn delete-btn" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            ğŸ—‘ï¸
                        </button>
                        <button class="control-btn style-btn" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            ğŸ¨
                        </button>
                    </div>
                </div>
                <div class="notification-content" style="margin-bottom: 20px; text-align: left; padding: 12px; border-radius: 6px; 
                    background: ${data.backgroundColor === '#ffffff' ? '#f8f9fa' : 'rgba(255, 255, 255, 0.1)'};
                    white-space: pre-wrap; font-size: 14px; color: #666; cursor: pointer;
                    max-height: 150px; overflow-y: auto;
                    scrollbar-width: thin; scrollbar-color: ${data.buttonColor || '#667eea'} rgba(0,0,0,0.1);">
                    ${data.content}
                </div>
                <button class="notification-button" style="padding: 10px 25px; background: ${data.buttonColor || '#667eea'};
                    color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;
                    transition: all 0.2s; font-weight: 500;">${data.buttonText || 'è¿›å…¥èŠå¤©å®¤'}</button>
            `;
            
            notification.innerHTML = notificationHTML;
            document.body.appendChild(notification);
            
            // æ‹–æ‹½åŠŸèƒ½
            let isDragging = false;
            let startX, startY, startLeft, startTop;
            
            notification.addEventListener('mousedown', (e) => {
                if (e.target.closest('.control-btn') || e.target.closest('.notification-button')) {
                    return;
                }
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startLeft = parseInt(notification.style.left) || notification.offsetLeft;
                startTop = parseInt(notification.style.top) || notification.offsetTop;
                notification.style.zIndex = '10001';
                notification.style.cursor = 'grabbing';
                
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', stopDrag);
            });
            
            function drag(e) {
                if (!isDragging) return;
                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                notification.style.left = `${startLeft + dx}px`;
                notification.style.top = `${startTop + dy}px`;
            }
            
            function stopDrag() {
                isDragging = false;
                notification.style.cursor = 'move';
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('mouseup', stopDrag);
            }
            
            // ç¼–è¾‘é€šçŸ¥
            notification.querySelector('.edit-btn').addEventListener('click', () => {
                // å¡«å……è¡¨å•è¿›è¡Œç¼–è¾‘
                document.getElementById('notificationTitle').value = data.title;
                document.getElementById('notificationContent').value = data.content;
                document.getElementById('notificationButtonText').value = data.buttonText || 'è¿›å…¥èŠå¤©å®¤';
                document.getElementById('notificationButtonColor').value = data.buttonColor || '#667eea';
                document.getElementById('notificationButtonColorText').value = data.buttonColor || '#667eea';
                document.getElementById('notificationBackgroundColor').value = data.backgroundColor || '#ffffff';
                document.getElementById('notificationBackgroundColorText').value = data.backgroundColor || '#ffffff';
                document.getElementById('notificationForceAction').checked = data.forceAction;
                
                // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
                openChatroomNotificationModal();
                
                // åˆ é™¤ä¸´æ—¶æç¤º
                notification.remove();
            });
            
            // åˆ é™¤é€šçŸ¥
            notification.querySelector('.delete-btn').addEventListener('click', () => {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæç¤ºå—ï¼Ÿ')) {
                    notification.remove();
                    // å¦‚æœæ˜¯æœåŠ¡å™¨å‘é€çš„æç¤ºï¼Œå‘é€åˆ é™¤è¯·æ±‚
                    if (data.id && !data.id.startsWith('temp_')) {
                        socket.emit('delete-chatroom-notification', { notificationId: data.id });
                    }
                }
            });
            
            // æ›´æ”¹æ ·å¼
            notification.querySelector('.style-btn').addEventListener('click', () => {
                const styleOptions = [
                    { name: 'é»˜è®¤æ ·å¼', bg: '#ffffff', border: '#667eea' },
                    { name: 'è“è‰²ä¸»é¢˜', bg: '#e3f2fd', border: '#2196f3' },
                    { name: 'ç»¿è‰²ä¸»é¢˜', bg: '#e8f5e8', border: '#4caf50' },
                    { name: 'æ©™è‰²ä¸»é¢˜', bg: '#fff3e0', border: '#ff9800' },
                    { name: 'ç´«è‰²ä¸»é¢˜', bg: '#f3e5f5', border: '#9c27b0' }
                ];
                
                const style = prompt('è¯·é€‰æ‹©æ ·å¼ï¼š\n1. é»˜è®¤æ ·å¼\n2. è“è‰²ä¸»é¢˜\n3. ç»¿è‰²ä¸»é¢˜\n4. æ©™è‰²ä¸»é¢˜\n5. ç´«è‰²ä¸»é¢˜\n\nè¯·è¾“å…¥æ•°å­—(1-5)ï¼š');
                if (!style || isNaN(style) || style < 1 || style > 5) {
                    return;
                }
                
                const selectedStyle = styleOptions[parseInt(style) - 1];
                
                // åº”ç”¨æ ·å¼
                notification.style.background = selectedStyle.bg;
                notification.style.borderColor = selectedStyle.border;
                notification.querySelector('.notification-content').style.background = selectedStyle.bg === '#ffffff' ? '#f8f9fa' : `rgba(255, 255, 255, 0.1)`;
                const button = notification.querySelector('.notification-button');
                button.style.background = selectedStyle.border;
            });
            
            // é•¿æŒ‰åˆ é™¤
            let longPressTimer;
            notification.addEventListener('mousedown', (e) => {
                if (e.target.closest('.control-btn') || e.target.closest('.notification-button')) {
                    return;
                }
                
                longPressTimer = setTimeout(() => {
                    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæç¤ºå—ï¼Ÿ')) {
                        notification.remove();
                        // å¦‚æœæ˜¯æœåŠ¡å™¨å‘é€çš„æç¤ºï¼Œå‘é€åˆ é™¤è¯·æ±‚
                        if (data.id && !data.id.startsWith('temp_')) {
                            socket.emit('delete-chatroom-notification', { notificationId: data.id });
                        }
                    }
                }, 800);
            });
            
            notification.addEventListener('mouseup', () => {
                clearTimeout(longPressTimer);
            });
            
            notification.addEventListener('mouseleave', () => {
                clearTimeout(longPressTimer);
            });
            
            // å³é”®èœå•
            notification.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                
                const contextMenu = document.createElement('div');
                contextMenu.style.cssText = `
                    position: fixed;
                    background: white;
                    border: 1px solid #ddd;
                    border-radius: 8px;
                    padding: 8px 0;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10002;
                    left: ${e.clientX}px;
                    top: ${e.clientY}px;
                `;
                
                const menuItems = [
                    { text: 'ç¼–è¾‘', icon: 'âœï¸', action: () => {
                        // å¡«å……è¡¨å•è¿›è¡Œç¼–è¾‘
                        document.getElementById('notificationTitle').value = data.title;
                        document.getElementById('notificationContent').value = data.content;
                        document.getElementById('notificationButtonText').value = data.buttonText || 'è¿›å…¥èŠå¤©å®¤';
                        document.getElementById('notificationButtonColor').value = data.buttonColor || '#667eea';
                        document.getElementById('notificationButtonColorText').value = data.buttonColor || '#667eea';
                        document.getElementById('notificationBackgroundColor').value = data.backgroundColor || '#ffffff';
                        document.getElementById('notificationBackgroundColorText').value = data.backgroundColor || '#ffffff';
                        document.getElementById('notificationForceAction').checked = data.forceAction;
                        
                        // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
                        openChatroomNotificationModal();
                        
                        // åˆ é™¤ä¸´æ—¶æç¤º
                        notification.remove();
                        contextMenu.remove();
                    }},
                    { text: 'åˆ é™¤', icon: 'ğŸ—‘ï¸', action: () => {
                        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæç¤ºå—ï¼Ÿ')) {
                            notification.remove();
                            // å¦‚æœæ˜¯æœåŠ¡å™¨å‘é€çš„æç¤ºï¼Œå‘é€åˆ é™¤è¯·æ±‚
                            if (data.id && !data.id.startsWith('temp_')) {
                                socket.emit('delete-chatroom-notification', { notificationId: data.id });
                            }
                        }
                        contextMenu.remove();
                    }},
                    { text: 'æ›´æ”¹æ ·å¼', icon: 'ğŸ¨', action: () => {
                        const styleOptions = [
                            { name: 'é»˜è®¤æ ·å¼', bg: '#ffffff', border: '#667eea' },
                            { name: 'è“è‰²ä¸»é¢˜', bg: '#e3f2fd', border: '#2196f3' },
                            { name: 'ç»¿è‰²ä¸»é¢˜', bg: '#e8f5e8', border: '#4caf50' },
                            { name: 'æ©™è‰²ä¸»é¢˜', bg: '#fff3e0', border: '#ff9800' },
                            { name: 'ç´«è‰²ä¸»é¢˜', bg: '#f3e5f5', border: '#9c27b0' }
                        ];
                        
                        const style = prompt('è¯·é€‰æ‹©æ ·å¼ï¼š\n1. é»˜è®¤æ ·å¼\n2. è“è‰²ä¸»é¢˜\n3. ç»¿è‰²ä¸»é¢˜\n4. æ©™è‰²ä¸»é¢˜\n5. ç´«è‰²ä¸»é¢˜\n\nè¯·è¾“å…¥æ•°å­—(1-5)ï¼š');
                        if (!style || isNaN(style) || style < 1 || style > 5) {
                            contextMenu.remove();
                            return;
                        }
                        
                        const selectedStyle = styleOptions[parseInt(style) - 1];
                        
                        // åº”ç”¨æ ·å¼
                        notification.style.background = selectedStyle.bg;
                        notification.style.borderColor = selectedStyle.border;
                        notification.querySelector('.notification-content').style.background = selectedStyle.bg === '#ffffff' ? '#f8f9fa' : `rgba(255, 255, 255, 0.1)`;
                        const button = notification.querySelector('.notification-button');
                        button.style.background = selectedStyle.border;
                        
                        contextMenu.remove();
                    }}
                ];
                
                menuItems.forEach(item => {
                    const menuItem = document.createElement('div');
                    menuItem.style.cssText = `
                        padding: 10px 15px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        transition: background-color 0.2s;
                    `;
                    
                    menuItem.innerHTML = `
                        <span>${item.icon}</span>
                        <span>${item.text}</span>
                    `;
                    
                    menuItem.addEventListener('mouseenter', () => {
                        menuItem.style.backgroundColor = '#f5f5f5';
                    });
                    
                    menuItem.addEventListener('mouseleave', () => {
                        menuItem.style.backgroundColor = 'transparent';
                    });
                    
                    menuItem.addEventListener('click', item.action);
                    
                    contextMenu.appendChild(menuItem);
                });
                
                document.body.appendChild(contextMenu);
                
                // ç‚¹å‡»å¤–éƒ¨å…³é—­
                setTimeout(() => {
                    document.addEventListener('click', function outsideClickHandler(e) {
                        if (!contextMenu.contains(e.target)) {
                            contextMenu.remove();
                            document.removeEventListener('click', outsideClickHandler);
                        }
                    });
                }, 100);
            });
        }
        
        // æ´»è·ƒæç¤ºç®¡ç†ç›¸å…³åŠŸèƒ½
        let editingNotificationId = null;
        
        // åˆ·æ–°æ´»è·ƒæç¤ºåˆ—è¡¨
        function refreshActiveNotifications() {
            socket.emit('get-active-notifications');
        }
        
        // æ˜¾ç¤ºæ´»è·ƒæç¤ºåˆ—è¡¨
        function displayActiveNotifications(notifications) {
            const container = document.getElementById('activeNotificationsList');
            if (notifications.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>æš‚æ— æ´»è·ƒæç¤º</p></div>';
                return;
            }
            
            const notificationsHTML = notifications.map(notification => `
                <div class="notification-item" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid ${notification.buttonColor || '#667eea'};">
                    <div class="notification-header" style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h4 style="margin: 0; font-size: 16px; color: #333;">${notification.title}</h4>
                            <span style="font-size: 12px; color: #999;">${notification.timeString}</span>
                        </div>
                        <div class="notification-actions" style="display: flex; gap: 8px;">
                            <button class="btn btn-sm btn-info" onclick="editActiveNotification('${notification.id}')" style="padding: 5px 10px; font-size: 12px;">âœï¸ ç¼–è¾‘</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteActiveNotification('${notification.id}')" style="padding: 5px 10px; font-size: 12px;">ğŸ—‘ï¸ åˆ é™¤</button>
                            <button class="btn btn-sm btn-warning" onclick="changeNotificationStyle('${notification.id}')" style="padding: 5px 10px; font-size: 12px;">ğŸ¨ æ ·å¼</button>
                        </div>
                    </div>
                    <div class="notification-content" style="margin-bottom: 12px; background: #f8f9fa; padding: 12px; border-radius: 6px; white-space: pre-wrap; font-size: 13px; color: #666;">
                        ${notification.content}
                    </div>
                    <div class="notification-meta" style="display: flex; gap: 15px; font-size: 12px; color: #999;">
                        <div><strong>ç›®æ ‡ï¼š</strong>${notification.target === 'all' ? 'å…¨ä½“ç”¨æˆ·' : notification.target === 'probability' ? `æ¦‚ç‡æ¨é€(${notification.probability}%)` : `ç‰¹å®šç”¨æˆ·(${notification.specificUsers?.length || 0}ä¸ª)`}</div>
                        <div><strong>æŒ‰é’®ï¼š</strong>${notification.buttonText || 'è¿›å…¥èŠå¤©å®¤'}</div>
                        <div><strong>å¼ºåˆ¶ï¼š</strong>${notification.forceAction ? 'æ˜¯' : 'å¦'}</div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = notificationsHTML;
        }
        
        // ç¼–è¾‘æ´»è·ƒæç¤º
        function editActiveNotification(notificationId) {
            // æŸ¥æ‰¾è¦ç¼–è¾‘çš„æç¤º
            socket.emit('get-active-notifications', (notifications) => {
                const notification = notifications.find(n => n.id === notificationId);
                if (!notification) return;
                
                // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
                const modal = document.getElementById('editNotificationModal');
                if (!modal) {
                    createEditNotificationModal();
                }
                
                // å¡«å……è¡¨å•
                document.getElementById('editNotificationId').value = notification.id;
                document.getElementById('editNotificationTitle').value = notification.title;
                document.getElementById('editNotificationContent').value = notification.content;
                document.getElementById('editNotificationButtonText').value = notification.buttonText || 'è¿›å…¥èŠå¤©å®¤';
                document.getElementById('editNotificationButtonColor').value = notification.buttonColor || '#667eea';
                document.getElementById('editNotificationButtonColorText').value = notification.buttonColor || '#667eea';
                document.getElementById('editNotificationBackgroundColor').value = notification.backgroundColor || '#ffffff';
                document.getElementById('editNotificationBackgroundColorText').value = notification.backgroundColor || '#ffffff';
                document.getElementById('editNotificationForceAction').checked = notification.forceAction;
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                document.getElementById('editNotificationModal').classList.add('active');
            });
        }
        
        // åˆ›å»ºç¼–è¾‘æ¨¡æ€æ¡†
        function createEditNotificationModal() {
            const modalHTML = `
                <div class="modal" id="editNotificationModal">
                    <div class="modal-content">
                        <h3>ç¼–è¾‘èŠå¤©å®¤æç¤º</h3>
                        <form onsubmit="event.preventDefault(); saveEditedNotification();">
                            <input type="hidden" id="editNotificationId">
                            <div class="input-group">
                                <label>æç¤ºæ ‡é¢˜</label>
                                <input type="text" id="editNotificationTitle" required>
                            </div>
                            <div class="input-group">
                                <label>æç¤ºå†…å®¹</label>
                                <textarea id="editNotificationContent" rows="5" required></textarea>
                            </div>
                            <div class="input-group">
                                <label>æŒ‰é’®æ–‡æœ¬</label>
                                <input type="text" id="editNotificationButtonText" value="è¿›å…¥èŠå¤©å®¤">
                            </div>
                            <div class="input-group">
                                <label>æŒ‰é’®é¢œè‰²</label>
                                <input type="color" id="editNotificationButtonColor" value="#667eea">
                                <input type="text" id="editNotificationButtonColorText" placeholder="ä¾‹å¦‚ï¼š#667eea" value="#667eea" style="margin-left: 10px; width: 120px;">
                            </div>
                            <div class="input-group">
                                <label>èƒŒæ™¯é¢œè‰²</label>
                                <input type="color" id="editNotificationBackgroundColor" value="#ffffff">
                                <input type="text" id="editNotificationBackgroundColorText" placeholder="ä¾‹å¦‚ï¼š#ffffff" value="#ffffff" style="margin-left: 10px; width: 120px;">
                            </div>
                            <div class="input-group">
                                <label>å¼ºåˆ¶æ“ä½œ</label>
                                <input type="checkbox" id="editNotificationForceAction">
                                <span style="margin-left: 10px; color: #666;">å‹¾é€‰åç”¨æˆ·å¿…é¡»ç‚¹å‡»æŒ‰é’®ï¼Œæ— æ³•å…³é—­</span>
                            </div>
                            <div class="modal-buttons">
                                <button type="button" class="btn btn-cancel" onclick="closeEditNotificationModal()">å–æ¶ˆ</button>
                                <button type="submit" class="btn btn-confirm">ä¿å­˜ä¿®æ”¹</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // æ·»åŠ é¢œè‰²åŒæ­¥
            const buttonColorPicker = document.getElementById('editNotificationButtonColor');
            const buttonColorText = document.getElementById('editNotificationButtonColorText');
            const bgColorPicker = document.getElementById('editNotificationBackgroundColor');
            const bgColorText = document.getElementById('editNotificationBackgroundColorText');
            
            buttonColorPicker.addEventListener('input', (e) => {
                buttonColorText.value = e.target.value;
            });
            buttonColorText.addEventListener('input', (e) => {
                if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
                    buttonColorPicker.value = e.target.value;
                }
            });
            
            bgColorPicker.addEventListener('input', (e) => {
                bgColorText.value = e.target.value;
            });
            bgColorText.addEventListener('input', (e) => {
                if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
                    bgColorPicker.value = e.target.value;
                }
            });
        }
        
        // ä¿å­˜ç¼–è¾‘
        function saveEditedNotification() {
            const notificationId = document.getElementById('editNotificationId').value;
            const title = document.getElementById('editNotificationTitle').value;
            const content = document.getElementById('editNotificationContent').value;
            const buttonText = document.getElementById('editNotificationButtonText').value;
            const buttonColor = document.getElementById('editNotificationButtonColorText').value;
            const backgroundColor = document.getElementById('editNotificationBackgroundColorText').value;
            const forceAction = document.getElementById('editNotificationForceAction').checked;
            
            socket.emit('update-chatroom-notification', {
                notificationId,
                title,
                content,
                buttonText,
                buttonColor,
                backgroundColor,
                forceAction
            });
            
            closeEditNotificationModal();
            alert('æç¤ºå·²æ›´æ–°ï¼');
        }
        
        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditNotificationModal() {
            const modal = document.getElementById('editNotificationModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        // åˆ é™¤æ´»è·ƒæç¤º
        function deleteActiveNotification(notificationId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæç¤ºå—ï¼Ÿ')) {
                socket.emit('delete-chatroom-notification', { notificationId });
                alert('æç¤ºå·²åˆ é™¤ï¼');
            }
        }
        
        // æ›´æ”¹æç¤ºæ ·å¼
        function changeNotificationStyle(notificationId) {
            const styleOptions = [
                { name: 'é»˜è®¤æ ·å¼', bg: '#ffffff', border: '#667eea' },
                { name: 'è“è‰²ä¸»é¢˜', bg: '#e3f2fd', border: '#2196f3' },
                { name: 'ç»¿è‰²ä¸»é¢˜', bg: '#e8f5e8', border: '#4caf50' },
                { name: 'æ©™è‰²ä¸»é¢˜', bg: '#fff3e0', border: '#ff9800' },
                { name: 'ç´«è‰²ä¸»é¢˜', bg: '#f3e5f5', border: '#9c27b0' }
            ];
            
            const style = prompt('è¯·é€‰æ‹©æ ·å¼ï¼š\n1. é»˜è®¤æ ·å¼\n2. è“è‰²ä¸»é¢˜\n3. ç»¿è‰²ä¸»é¢˜\n4. æ©™è‰²ä¸»é¢˜\n5. ç´«è‰²ä¸»é¢˜\n\nè¯·è¾“å…¥æ•°å­—(1-5)ï¼š');
            if (!style || isNaN(style) || style < 1 || style > 5) {
                return;
            }
            
            const selectedStyle = styleOptions[parseInt(style) - 1];
            
            // æ›´æ–°æç¤ºæ ·å¼
            socket.emit('update-chatroom-notification', {
                notificationId,
                backgroundColor: selectedStyle.bg,
                buttonColor: selectedStyle.border
            });
            
            alert(`æ ·å¼å·²æ›´æ–°ä¸ºï¼š${selectedStyle.name}`);
        }
        
        // é€‰æ‹©æç¤ºæ ·å¼
        function selectNotificationStyle() {
            const styleOptions = [
                { name: 'é»˜è®¤æ ·å¼', bg: '#ffffff', border: '#667eea' },
                { name: 'è“è‰²ä¸»é¢˜', bg: '#e3f2fd', border: '#2196f3' },
                { name: 'ç»¿è‰²ä¸»é¢˜', bg: '#e8f5e8', border: '#4caf50' },
                { name: 'æ©™è‰²ä¸»é¢˜', bg: '#fff3e0', border: '#ff9800' },
                { name: 'ç´«è‰²ä¸»é¢˜', bg: '#f3e5f5', border: '#9c27b0' }
            ];
            
            const style = prompt('è¯·é€‰æ‹©æ ·å¼ï¼š\n1. é»˜è®¤æ ·å¼\n2. è“è‰²ä¸»é¢˜\n3. ç»¿è‰²ä¸»é¢˜\n4. æ©™è‰²ä¸»é¢˜\n5. ç´«è‰²ä¸»é¢˜\n\nè¯·è¾“å…¥æ•°å­—(1-5)ï¼š');
            if (!style || isNaN(style) || style < 1 || style > 5) {
                return;
            }
            
            const selectedStyle = styleOptions[parseInt(style) - 1];
            
            // åº”ç”¨æ ·å¼åˆ°è¡¨å•
            document.getElementById('notificationButtonColor').value = selectedStyle.border;
            document.getElementById('notificationButtonColorText').value = selectedStyle.border;
            document.getElementById('notificationBackgroundColor').value = selectedStyle.bg;
            document.getElementById('notificationBackgroundColorText').value = selectedStyle.bg;
            
            alert(`æ ·å¼å·²è®¾ç½®ä¸ºï¼š${selectedStyle.name}`);
        }
        
        // é¢œè‰²è¾“å…¥æ¡†åŒæ­¥
        document.addEventListener('DOMContentLoaded', () => {
            const buttonColorPicker = document.getElementById('notificationButtonColor');
            const buttonColorText = document.getElementById('notificationButtonColorText');
            const bgColorPicker = document.getElementById('notificationBackgroundColor');
            const bgColorText = document.getElementById('notificationBackgroundColorText');
            
            if (buttonColorPicker && buttonColorText) {
                buttonColorPicker.addEventListener('input', (e) => {
                    buttonColorText.value = e.target.value;
                });
                buttonColorText.addEventListener('input', (e) => {
                    if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
                        buttonColorPicker.value = e.target.value;
                    }
                });
            }
            
            if (bgColorPicker && bgColorText) {
                bgColorPicker.addEventListener('input', (e) => {
                    bgColorText.value = e.target.value;
                });
                bgColorText.addEventListener('input', (e) => {
                    if (/^#[0-9A-Fa-f]{6}$/.test(e.target.value)) {
                        bgColorPicker.value = e.target.value;
                    }
                });
            }
            
            // åŠ è½½æ´»è·ƒæç¤º
            refreshActiveNotifications();
        });
        
        // ç›‘å¬æ´»è·ƒæç¤ºæ›´æ–°
        socket.on('active-notifications', displayActiveNotifications);
        socket.on('active-notifications-update', displayActiveNotifications);
        
        // åŠ è½½æ›´æ–°å†å²
        loadUpdateHistory();
        
        // ç›‘å¬æ›´æ–°å†å²æ•°æ®
        socket.on('update-history', displayUpdateHistory);
        
        // JavaScriptæ§åˆ¶å°ç›¸å…³å‡½æ•°
        function loadUserConsole() {
            const userSelect = document.getElementById('consoleUserSelect');
            const selectedUserId = userSelect.value;
            
            if (!selectedUserId) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªç”¨æˆ·');
                return;
            }
            
            // åŠ è½½ç”¨æˆ·æ§åˆ¶å°
            socket.emit('admin-load-user-console', { socketId: selectedUserId });
            
            // æ¸…ç©ºæ—¥å¿—åŒºåŸŸå¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const consoleLogs = document.getElementById('consoleLogs');
            consoleLogs.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ”„</div>
                    <div>æ­£åœ¨åŠ è½½ç”¨æˆ·æ§åˆ¶å°...</div>
                </div>
            `;
        }
        
        function executeConsoleCode() {
            const userSelect = document.getElementById('consoleUserSelect');
            const selectedUserId = userSelect.value;
            const code = document.getElementById('consoleCode').value.trim();
            
            if (!selectedUserId) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªç”¨æˆ·');
                return;
            }
            
            if (!code) {
                alert('è¯·è¾“å…¥è¦æ‰§è¡Œçš„JavaScriptä»£ç ');
                return;
            }
            
            // æ‰§è¡Œä»£ç 
            socket.emit('admin-execute-console-code', {
                socketId: selectedUserId,
                code: code
            });
        }
        
        function clearConsoleCode() {
            document.getElementById('consoleCode').value = '';
        }
        
        function loadSampleCode() {
            const sampleCode = `// ç¤ºä¾‹ä»£ç ï¼šè·å–ç”¨æˆ·ä¿¡æ¯
console.log('ç”¨æˆ·ä¿¡æ¯:', {
    username: user.username,
    room: user.roomName,
    permissions: user.permissions
});

// ç¤ºä¾‹ä»£ç ï¼šå‘é€æ¶ˆæ¯
if (typeof sendMessage === 'function') {
    sendMessage('è¿™æ˜¯ä¸€æ¡æ¥è‡ªç®¡ç†å‘˜æ§åˆ¶å°çš„æµ‹è¯•æ¶ˆæ¯', 'text');
}

// ç¤ºä¾‹ä»£ç ï¼šä¿®æ”¹ç”¨æˆ·è®¾ç½®
if (typeof userSettings !== 'undefined') {
    console.log('å½“å‰ç”¨æˆ·è®¾ç½®:', userSettings);
}`;
            
            document.getElementById('consoleCode').value = sampleCode;
        }
        
        function clearConsoleLogs() {
            const consoleLogs = document.getElementById('consoleLogs');
            consoleLogs.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ’»</div>
                    <div>æ§åˆ¶å°æ—¥å¿—å·²æ¸…ç©º</div>
                </div>
            `;
        }
        
        function exportConsoleLogs() {
            const consoleLogs = document.getElementById('consoleLogs');
            const logsContent = consoleLogs.textContent;
            
            if (logsContent.includes('è¯·é€‰æ‹©ç”¨æˆ·å¹¶åŠ è½½æ§åˆ¶å°') || logsContent.includes('æ§åˆ¶å°æ—¥å¿—å·²æ¸…ç©º')) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ—¥å¿—');
                return;
            }
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([logsContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `console-logs-${new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-')}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // ç›‘å¬ç”¨æˆ·åˆ—è¡¨æ›´æ–°ï¼Œæ›´æ–°æ§åˆ¶å°ç”¨æˆ·é€‰æ‹©å™¨
        socket.on('user-joined', (data) => {
            updateConsoleUserSelect(data.users);
        });
        
        socket.on('user-left', (data) => {
            updateConsoleUserSelect(data.users);
        });
        
        // æ›´æ–°æ§åˆ¶å°ç”¨æˆ·é€‰æ‹©å™¨
        function updateConsoleUserSelect(users) {
            const consoleUserSelect = document.getElementById('consoleUserSelect');
            if (!consoleUserSelect) return;
            
            // ä¿å­˜å½“å‰é€‰ä¸­çš„å€¼
            const currentValue = consoleUserSelect.value;
            
            // æ¸…ç©ºå¹¶é‡æ–°æ·»åŠ é€‰é¡¹
            consoleUserSelect.innerHTML = '<option value="">é€‰æ‹©ç”¨æˆ·</option>';
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.socketId;
                option.textContent = user.username;
                consoleUserSelect.appendChild(option);
            });
            
            // æ¢å¤ä¹‹å‰çš„é€‰ä¸­å€¼
            if (currentValue) {
                consoleUserSelect.value = currentValue;
            }
        }
        
        // ç›‘å¬æ§åˆ¶å°æ—¥å¿—
        socket.on('admin-console-logs', (data) => {
            const consoleLogs = document.getElementById('consoleLogs');
            const logs = data.logs;
            
            if (!logs || logs.length === 0) {
                consoleLogs.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ’»</div>
                        <div>æš‚æ— æ§åˆ¶å°æ—¥å¿—</div>
                    </div>
                `;
                return;
            }
            
            // ç”Ÿæˆæ—¥å¿—HTML
            const logsHTML = logs.map(log => {
                const levelClass = {
                    error: 'color: #dc3545;',
                    warn: 'color: #ffc107;',
                    info: 'color: #17a2b8;',
                    log: 'color: #333;',
                    debug: 'color: #6c757d;'
                }[log.level] || 'color: #333;';
                
                return `
                    <div style="margin-bottom: 8px; padding: 5px; border-left: 3px solid #667eea;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 2px;">
                            ${new Date(log.timestamp).toLocaleString()} [${log.level.toUpperCase()}]
                        </div>
                        <div style="${levelClass}">
                            ${escapeHtml(log.message)}
                        </div>
                    </div>
                `;
            }).join('');
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°ï¼ˆé¿å…é‡å¤æ›´æ–°å¯¼è‡´çš„é—ªçƒï¼‰
            const currentContent = consoleLogs.innerHTML;
            if (currentContent.includes('æ­£åœ¨åŠ è½½ç”¨æˆ·æ§åˆ¶å°') || currentContent.includes('æš‚æ— æ§åˆ¶å°æ—¥å¿—') || currentContent.includes('æ§åˆ¶å°æ—¥å¿—å·²æ¸…ç©º')) {
                consoleLogs.innerHTML = logsHTML;
            } else {
                // åªæœ‰å½“å†…å®¹ç¡®å®ä¸åŒæ—¶æ‰æ›´æ–°
                const currentText = consoleLogs.textContent;
                const newText = logs.map(log => `${new Date(log.timestamp).toLocaleString()} [${log.level.toUpperCase()}] ${log.message}`).join(' ');
                if (currentText !== newText) {
                    consoleLogs.innerHTML = logsHTML;
                }
            }
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            consoleLogs.scrollTop = consoleLogs.scrollHeight;
        });
        
        // ç›‘å¬ä»£ç æ‰§è¡Œç»“æœ
        socket.on('admin-console-execute-result', (data) => {
            const consoleLogs = document.getElementById('consoleLogs');
            const { success, result, error } = data;
            
            if (success) {
                const resultHTML = `
                    <div style="margin-bottom: 8px; padding: 5px; border-left: 3px solid #28a745;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 2px;">
                            ${new Date().toLocaleString()} [EXECUTE]
                        </div>
                        <div style="color: #28a745;">
                            ä»£ç æ‰§è¡ŒæˆåŠŸ:
                        </div>
                        <div style="margin-top: 5px; color: #333; font-family: monospace;">
                            ${escapeHtml(JSON.stringify(result, null, 2))}
                        </div>
                    </div>
                `;
                consoleLogs.insertAdjacentHTML('beforeend', resultHTML);
            } else {
                const errorHTML = `
                    <div style="margin-bottom: 8px; padding: 5px; border-left: 3px solid #dc3545;">
                        <div style="font-size: 12px; color: #999; margin-bottom: 2px;">
                            ${new Date().toLocaleString()} [EXECUTE ERROR]
                        </div>
                        <div style="color: #dc3545;">
                            ä»£ç æ‰§è¡Œå¤±è´¥:
                        </div>
                        <div style="margin-top: 5px; color: #dc3545; font-family: monospace;">
                            ${escapeHtml(error)}
                        </div>
                    </div>
                `;
                consoleLogs.insertAdjacentHTML('beforeend', errorHTML);
            }
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            consoleLogs.scrollTop = consoleLogs.scrollHeight;
        

            
            // ç”Ÿæˆæ¶ˆæ¯ç±»å‹åˆ†å¸ƒå›¾è¡¨
            generateMessageTypeChart();
            
            // åŠ è½½ç”¨æˆ·è¡Œä¸ºè¯¦æƒ…
            loadUserBehaviorDetails();
        }, 1000);
    
    
    function generateActivityChart() {
        const container = document.getElementById('userActivityChart');
        container.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“ˆ</div>
                    <div style="font-size: 16px; color: #666;">ç”¨æˆ·æ´»è·ƒåº¦è¶‹åŠ¿å›¾</div>
                    <div style="margin-top: 10px; font-size: 14px; color: #999;">
                        <div>00:00 - ${Math.floor(Math.random() * 20) + 5} æ¶ˆæ¯</div>
                        <div>06:00 - ${Math.floor(Math.random() * 10) + 1} æ¶ˆæ¯</div>
                        <div>12:00 - ${Math.floor(Math.random() * 30) + 10} æ¶ˆæ¯</div>
                        <div>18:00 - ${Math.floor(Math.random() * 40) + 20} æ¶ˆæ¯</div>
                        <div>23:00 - ${Math.floor(Math.random() * 15) + 3} æ¶ˆæ¯</div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function generateMessageTypeChart() {
        const container = document.getElementById('messageTypeChart');
        container.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“Š</div>
                    <div style="font-size: 16px; color: #666;">æ¶ˆæ¯ç±»å‹åˆ†å¸ƒ</div>
                    <div style="margin-top: 10px; font-size: 14px; color: #999;">
                        <div>æ–‡æœ¬æ¶ˆæ¯: ${Math.floor(Math.random() * 70) + 30}%</div>
                        <div>å›¾ç‰‡æ¶ˆæ¯: ${Math.floor(Math.random() * 30) + 10}%</div>
                        <div>éŸ³é¢‘æ¶ˆæ¯: ${Math.floor(Math.random() * 20) + 5}%</div>
                        <div>è§†é¢‘æ¶ˆæ¯: ${Math.floor(Math.random() * 10) + 1}%</div>
                        <div>æ–‡ä»¶æ¶ˆæ¯: ${Math.floor(Math.random() * 15) + 3}%</div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function loadUserBehaviorDetails() {
        const container = document.getElementById('userBehaviorList');
        
        const users = [
            { username: 'user1', messages: 120, images: 20, audio: 5, video: 2, files: 3, lastActive: '2024-01-01 10:00' },
            { username: 'user2', messages: 80, images: 15, audio: 3, video: 1, files: 2, lastActive: '2024-01-01 09:30' },
            { username: 'user3', messages: 150, images: 25, audio: 8, video: 4, files: 5, lastActive: '2024-01-01 11:20' },
            { username: 'user4', messages: 60, images: 10, audio: 2, video: 0, files: 1, lastActive: '2024-01-01 08:45' },
            { username: 'user5', messages: 200, images: 30, audio: 12, video: 6, files: 8, lastActive: '2024-01-01 12:10' }
        ];
        
        let html = '';
        users.forEach(user => {
            html += `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-color" style="background: ${getRandomColor()}"></div>
                        <div class="user-name">${user.username}</div>
                    </div>
                    <div style="font-size: 14px; color: #666; text-align: right;">
                        <div>æ¶ˆæ¯: ${user.messages}</div>
                        <div>å›¾ç‰‡: ${user.images}</div>
                        <div>éŸ³é¢‘: ${user.audio}</div>
                        <div>è§†é¢‘: ${user.video}</div>
                        <div>æ–‡ä»¶: ${user.files}</div>
                        <div style="margin-top: 5px; font-size: 12px; color: #999;">æœ€åæ´»è·ƒ: ${user.lastActive}</div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html || '<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><div>æš‚æ— è¡Œä¸ºæ•°æ®</div></div>';
    }
    
    function exportAnalyticsData() {
        showLoading('æ­£åœ¨å¯¼å‡ºåˆ†ææ•°æ®...');
        
        setTimeout(() => {
            hideLoading();
            alert('åˆ†ææ•°æ®å·²å¯¼å‡ºåˆ° analytics_export.json');
        }, 1000);
    }
    
    function getRandomColor() {
        const letters = '0123456789ABCDEF';
        let color = '#';
        for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
    }
    
    function showLoading(message) {
        if (!document.getElementById('loadingOverlay')) {
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                color: white;
                font-size: 18px;
            `;
            overlay.innerHTML = `<div>${message}</div>`;
            document.body.appendChild(overlay);
        }
    }
    
    function hideLoading() {
        const overlay = document.getElementById('loadingOverlay');
        if (overlay) {
            overlay.remove();
        }
    }
    
    // æ‰¹é‡æ“ä½œç›¸å…³å‡½æ•°
    function selectAllUsers() {
        document.querySelectorAll('.user-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
    }
    
    function deselectAllUsers() {
        document.querySelectorAll('.user-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
    }
    
    function getSelectedUsers() {
        const selected = [];
        document.querySelectorAll('.user-checkbox:checked').forEach(checkbox => {
            selected.push(checkbox.value);
        });
        return selected;
    }
    
    function batchKickUsers() {
        const selectedUsers = getSelectedUsers();
        if (selectedUsers.length === 0) {
            alert('è¯·å…ˆé€‰æ‹©è¦è¸¢å‡ºçš„ç”¨æˆ·');
            return;
        }
        
        if (confirm(`ç¡®å®šè¦è¸¢å‡º ${selectedUsers.length} ä¸ªç”¨æˆ·å—ï¼Ÿ`)) {
            selectedUsers.forEach(socketId => {
                socket.emit('admin-kick-user', socketId);
            });
            alert(`å·²æˆåŠŸè¸¢å‡º ${selectedUsers.length} ä¸ªç”¨æˆ·`);
        }
    }
    
    function batchMuteUsers() {
        const selectedUsers = getSelectedUsers();
        if (selectedUsers.length === 0) {
            alert('è¯·å…ˆé€‰æ‹©è¦ç¦è¨€çš„ç”¨æˆ·');
            return;
        }
        
        const duration = prompt('è¯·è¾“å…¥ç¦è¨€æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼Œè¾“å…¥-1è¡¨ç¤ºæ°¸ä¹…ç¦è¨€ï¼‰:', '5');
        const reason = prompt('è¯·è¾“å…¥ç¦è¨€åŸå› :', 'æ‰¹é‡ç¦è¨€');
        
        if (duration !== null && reason !== null) {
            selectedUsers.forEach(socketId => {
                socket.emit('admin-mute-user', {
                    socketId: socketId,
                    duration: parseInt(duration),
                    reason: reason
                });
            });
            alert(`å·²æˆåŠŸç¦è¨€ ${selectedUsers.length} ä¸ªç”¨æˆ·`);
        }
    }
    
    function batchSetPermissions() {
        const selectedUsers = getSelectedUsers();
        if (selectedUsers.length === 0) {
            alert('è¯·å…ˆé€‰æ‹©è¦è®¾ç½®æƒé™çš„ç”¨æˆ·');
            return;
        }
        
        // æ‰“å¼€æƒé™è®¾ç½®æ¨¡æ€æ¡†ï¼Œè®¾ç½®å®Œæˆååº”ç”¨åˆ°æ‰€æœ‰é€‰ä¸­ç”¨æˆ·
        if (confirm(`ç¡®å®šè¦ä¸º ${selectedUsers.length} ä¸ªç”¨æˆ·è®¾ç½®ç›¸åŒçš„æƒé™å—ï¼Ÿ`)) {
            // è¿™é‡Œå¯ä»¥æ‰“å¼€æƒé™è®¾ç½®æ¨¡æ€æ¡†ï¼Œç„¶ååœ¨ç¡®è®¤æ—¶åº”ç”¨åˆ°æ‰€æœ‰é€‰ä¸­ç”¨æˆ·
            alert('æƒé™è®¾ç½®åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…');
        }
    }
    
    // ç³»ç»Ÿæ—¥å¿—ç›¸å…³å‡½æ•°
    function loadSystemLogs() {
        const logType = document.getElementById('logTypeFilter').value;
        const searchTerm = document.getElementById('logSearch').value;
        showLoading('æ­£åœ¨åŠ è½½ç³»ç»Ÿæ—¥å¿—...');
        
        // æ¨¡æ‹Ÿç³»ç»Ÿæ—¥å¿—æ•°æ®
        setTimeout(() => {
            hideLoading();
            
            // ç”Ÿæˆæ¨¡æ‹Ÿæ—¥å¿—æ•°æ®
            const logs = generateMockLogs();
            
            // è¿‡æ»¤æ—¥å¿—
            const filteredLogs = logs.filter(log => {
                const matchesType = logType === 'all' || log.type === logType;
                const matchesSearch = !searchTerm || log.message.toLowerCase().includes(searchTerm.toLowerCase());
                return matchesType && matchesSearch;
            });
            
            // æ›´æ–°æ—¥å¿—æ˜¾ç¤º
            displaySystemLogs(filteredLogs);
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            updateLogStats(logs);
        }, 1000);
    }
    
    function generateMockLogs() {
        const logTypes = ['error', 'warn', 'info', 'debug'];
        const logMessages = [
            'ç”¨æˆ· user1 ç™»å½•æˆåŠŸ',
            'ç”¨æˆ· user2 é€€å‡ºç³»ç»Ÿ',
            'ç”¨æˆ· user3 å‘é€äº†ä¸€æ¡æ¶ˆæ¯',
            'ç”¨æˆ· user4 ä¸Šä¼ äº†ä¸€å¼ å›¾ç‰‡',
            'ç”¨æˆ· user5 è¢«ç®¡ç†å‘˜è¸¢å‡º',
            'ç”¨æˆ· user6 è¢«ç¦è¨€ 5 åˆ†é’Ÿ',
            'ç³»ç»Ÿå¯åŠ¨æˆåŠŸ',
            'WebSocketè¿æ¥å»ºç«‹',
            'æ•°æ®åº“è¿æ¥å¤±è´¥',
            'æ–‡ä»¶ä¸Šä¼ å¤±è´¥',
            'æƒé™éªŒè¯å¤±è´¥',
            'ç³»ç»Ÿé…ç½®æ›´æ–°',
            'æ–°ç”¨æˆ·åŠ å…¥èŠå¤©å®¤',
            'ç”¨æˆ·åˆ›å»ºäº†æ–°æˆ¿é—´',
            'ç³»ç»Ÿå†…å­˜ä½¿ç”¨ç‡è¿‡é«˜'
        ];
        
        const logs = [];
        const now = new Date();
        
        for (let i = 0; i < 50; i++) {
            const timestamp = new Date(now.getTime() - (i * 60000)); // æ¯æ¡æ—¥å¿—é—´éš”1åˆ†é’Ÿ
            const type = logTypes[Math.floor(Math.random() * logTypes.length)];
            const message = logMessages[Math.floor(Math.random() * logMessages.length)];
            
            logs.push({
                id: i + 1,
                timestamp: timestamp.toLocaleString(),
                type: type,
                message: message
            });
        }
        
        return logs;
    }
    
    function displaySystemLogs(logs) {
        const container = document.getElementById('systemLogsContainer');
        
        if (logs.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“‹</div>
                    <div>æš‚æ— ç³»ç»Ÿæ—¥å¿—</div>
                </div>
            `;
            return;
        }
        
        let html = '';
        logs.forEach(log => {
            let typeColor = '#666';
            let typeLabel = 'INFO';
            
            switch (log.type) {
                case 'error':
                    typeColor = '#dc3545';
                    typeLabel = 'ERROR';
                    break;
                case 'warn':
                    typeColor = '#ffc107';
                    typeLabel = 'WARN';
                    break;
                case 'info':
                    typeColor = '#17a2b8';
                    typeLabel = 'INFO';
                    break;
                case 'debug':
                    typeColor = '#28a745';
                    typeLabel = 'DEBUG';
                    break;
            }
            
            html += `
                <div style="margin-bottom: 10px; padding: 8px; border-left: 4px solid ${typeColor}; background: white; border-radius: 4px;">
                    <div style="font-size: 12px; color: #999; margin-bottom: 4px;">
                        <span>${log.timestamp}</span>
                        <span style="margin-left: 10px; font-weight: bold; color: ${typeColor};">[${typeLabel}]</span>
                    </div>
                    <div>${log.message}</div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function updateLogStats(logs) {
        const loginCount = logs.filter(log => log.message.includes('ç™»å½•')).length;
        const logoutCount = logs.filter(log => log.message.includes('é€€å‡º')).length;
        const messageSentCount = logs.filter(log => log.message.includes('å‘é€äº†ä¸€æ¡æ¶ˆæ¯')).length;
        const fileUploadCount = logs.filter(log => log.message.includes('ä¸Šä¼ ')).length;
        const errorCount = logs.filter(log => log.type === 'error').length;
        const warnCount = logs.filter(log => log.type === 'warn').length;
        
        document.getElementById('loginCount').textContent = loginCount;
        document.getElementById('logoutCount').textContent = logoutCount;
        document.getElementById('messageSentCount').textContent = messageSentCount;
        document.getElementById('fileUploadCount').textContent = fileUploadCount;
        document.getElementById('errorCount').textContent = errorCount;
        document.getElementById('warnCount').textContent = warnCount;
    }
    
    function exportSystemLogs() {
        showLoading('æ­£åœ¨å¯¼å‡ºç³»ç»Ÿæ—¥å¿—...');
        
        setTimeout(() => {
            hideLoading();
            alert('ç³»ç»Ÿæ—¥å¿—å·²å¯¼å‡ºåˆ° system_logs.json');
        }, 1000);
    }
    
    function exportUserData() {
        showLoading('æ­£åœ¨å¯¼å‡ºç”¨æˆ·æ•°æ®...');
        
        setTimeout(() => {
            hideLoading();
            alert('ç”¨æˆ·æ•°æ®å·²å¯¼å‡ºåˆ° user_data.json');
        }, 1000);
    }
    
    function clearSystemLogs() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç³»ç»Ÿæ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
            showLoading('æ­£åœ¨æ¸…ç©ºç³»ç»Ÿæ—¥å¿—...');
            
            setTimeout(() => {
                hideLoading();
                document.getElementById('systemLogsContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <div>ç³»ç»Ÿæ—¥å¿—å·²æ¸…ç©º</div>
                    </div>
                `;
                
                // é‡ç½®ç»Ÿè®¡æ•°æ®
                document.getElementById('loginCount').textContent = '0';
                document.getElementById('logoutCount').textContent = '0';
                document.getElementById('messageSentCount').textContent = '0';
                document.getElementById('fileUploadCount').textContent = '0';
                document.getElementById('errorCount').textContent = '0';
                document.getElementById('warnCount').textContent = '0';
            }, 1000);
        }
    }
    
    // ç³»ç»Ÿç›‘æ§ç›¸å…³å‡½æ•°
    let monitoringIntervalId = null;
    
    function startSystemMonitoring() {
        if (monitoringIntervalId) {
            clearInterval(monitoringIntervalId);
        }
        
        const interval = parseInt(document.getElementById('monitoringInterval').value);
        showLoading('æ­£åœ¨å¯åŠ¨ç³»ç»Ÿç›‘æ§...');
        
        setTimeout(() => {
            hideLoading();
            alert('ç³»ç»Ÿç›‘æ§å·²å¯åŠ¨');
            
            // ç«‹å³æ›´æ–°ä¸€æ¬¡ç³»ç»ŸçŠ¶æ€
            updateSystemStatus();
            
            // è®¾ç½®å®šæ—¶æ›´æ–°
            monitoringIntervalId = setInterval(() => {
                updateSystemStatus();
            }, interval);
        }, 1000);
    }
    
    function stopSystemMonitoring() {
        if (monitoringIntervalId) {
            clearInterval(monitoringIntervalId);
            monitoringIntervalId = null;
            alert('ç³»ç»Ÿç›‘æ§å·²åœæ­¢');
        }
    }
    
    function refreshSystemStatus() {
        showLoading('æ­£åœ¨åˆ·æ–°ç³»ç»ŸçŠ¶æ€...');
        
        setTimeout(() => {
            hideLoading();
            updateSystemStatus();
        }, 1000);
    }
    
    function updateSystemStatus() {
        // æ¨¡æ‹Ÿç³»ç»ŸçŠ¶æ€æ•°æ®
        const cpuUsage = Math.floor(Math.random() * 100);
        const memoryUsage = Math.floor(Math.random() * 100);
        const diskUsage = Math.floor(Math.random() * 100);
        const networkTraffic = Math.floor(Math.random() * 1000);
        const onlineUsers = Math.floor(Math.random() * 50);
        const websocketConnections = Math.floor(Math.random() * 100);
        
        // æ›´æ–°ç³»ç»ŸçŠ¶æ€æ˜¾ç¤º
        document.getElementById('cpuUsage').textContent = `${cpuUsage}%`;
        document.getElementById('memoryUsage').textContent = `${memoryUsage}%`;
        document.getElementById('diskUsage').textContent = `${diskUsage}%`;
        document.getElementById('networkTraffic').textContent = `${networkTraffic} KB/s`;
        document.getElementById('onlineUsers').textContent = onlineUsers;
        document.getElementById('websocketConnections').textContent = websocketConnections;
        
        // æ›´æ–°æ€§èƒ½å›¾è¡¨
        updatePerformanceChart(cpuUsage, memoryUsage, diskUsage);
        
        // æ·»åŠ ç³»ç»Ÿäº‹ä»¶
        addSystemEvent(`ç³»ç»ŸçŠ¶æ€æ›´æ–° - CPU: ${cpuUsage}%, å†…å­˜: ${memoryUsage}%, åœ¨çº¿ç”¨æˆ·: ${onlineUsers}`);
    }
    
    function updatePerformanceChart(cpu, memory, disk) {
        const container = document.getElementById('performanceChart');
        container.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%;">
                <div style="text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“Š</div>
                    <div style="font-size: 16px; color: #666; margin-bottom: 20px;">ç³»ç»Ÿæ€§èƒ½ç›‘æ§</div>
                    <div style="display: flex; gap: 20px; justify-content: center;">
                        <div style="text-align: center;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">CPU</div>
                            <div style="width: 100px; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden;">
                                <div style="width: ${cpu}%; height: 100%; background: ${cpu > 80 ? '#dc3545' : cpu > 60 ? '#ffc107' : '#28a745'}; border-radius: 10px; transition: width 0.5s ease;"></div>
                            </div>
                            <div style="margin-top: 5px; font-size: 14px; font-weight: bold;">${cpu}%</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">å†…å­˜</div>
                            <div style="width: 100px; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden;">
                                <div style="width: ${memory}%; height: 100%; background: ${memory > 80 ? '#dc3545' : memory > 60 ? '#ffc107' : '#28a745'}; border-radius: 10px; transition: width 0.5s ease;"></div>
                            </div>
                            <div style="margin-top: 5px; font-size: 14px; font-weight: bold;">${memory}%</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 14px; color: #666; margin-bottom: 5px;">ç£ç›˜</div>
                            <div style="width: 100px; height: 20px; background: #f0f0f0; border-radius: 10px; overflow: hidden;">
                                <div style="width: ${disk}%; height: 100%; background: ${disk > 80 ? '#dc3545' : disk > 60 ? '#ffc107' : '#28a745'}; border-radius: 10px; transition: width 0.5s ease;"></div>
                            </div>
                            <div style="margin-top: 5px; font-size: 14px; font-weight: bold;">${disk}%</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function addSystemEvent(eventMessage) {
        const container = document.getElementById('systemEventsContainer');
        const events = container.innerHTML;
        
        const now = new Date().toLocaleString();
        const newEvent = `
            <div style="margin-bottom: 10px; padding: 8px; border-left: 4px solid #667eea; background: white; border-radius: 4px;">
                <div style="font-size: 12px; color: #999; margin-bottom: 4px;">
                    <span>${now}</span>
                </div>
                <div>${eventMessage}</div>
            </div>
        `;
        
        // é™åˆ¶æ˜¾ç¤ºçš„äº‹ä»¶æ•°é‡
        if (events.includes('empty-state')) {
            container.innerHTML = newEvent;
        } else {
            const eventElements = events.split('</div>').filter(Boolean);
            if (eventElements.length >= 20) {
                eventElements.pop();
            }
            container.innerHTML = newEvent + eventElements.join('</div>') + '</div>';
        }
    }

    // æŠ•ç¥¨ç®¡ç†ç›¸å…³å‡½æ•°
    function loadPolls() {
        socket.emit('get-polls', (polls) => {
            const pollsList = document.getElementById('pollsList');
            if (polls.length === 0) {
                pollsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“Š</div>
                        <div>æš‚æ— æ´»è·ƒæŠ•ç¥¨</div>
                    </div>
                `;
                return;
            }

            pollsList.innerHTML = polls.map(poll => {
                const optionsHTML = poll.options.map((option, index) => {
                    const votes = poll.votes[option] || 0;
                    return `
                        <div style="margin-left: 20px; margin-top: 5px;">
                            ${option}: ${votes} ç¥¨
                        </div>
                    `;
                }).join('');

                return `
                    <div class="user-item">
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${poll.question}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                åˆ›å»ºè€…: ${poll.creator}
                            </div>
                            <div style="font-size: 12px; color: #666; margin-top: 2px;">
                                å¼€å§‹æ—¶é—´: ${new Date(poll.createdAt).toLocaleString()}
                            </div>
                            ${optionsHTML}
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-danger" onclick="endPoll('${poll.id}')">ç»“æŸæŠ•ç¥¨</button>
                        </div>
                    </div>
                `;
            }).join('');
        });
    }

    function openCreatePollModal() {
        const modal = document.getElementById('createPollModal');
        // é‡ç½®è¡¨å•
        document.getElementById('pollQuestion').value = '';
        const optionsContainer = document.getElementById('pollOptionsContainer');
        optionsContainer.innerHTML = `
            <div class="input-group" style="margin-bottom: 10px;">
                <label>é€‰é¡¹ 1</label>
                <input type="text" class="poll-option" placeholder="è¾“å…¥é€‰é¡¹å†…å®¹" required>
            </div>
            <div class="input-group" style="margin-bottom: 10px;">
                <label>é€‰é¡¹ 2</label>
                <input type="text" class="poll-option" placeholder="è¾“å…¥é€‰é¡¹å†…å®¹" required>
            </div>
        `;
        modal.classList.add('active');
    }

    function closeCreatePollModal() {
        const modal = document.getElementById('createPollModal');
        modal.classList.remove('active');
    }

    function addPollOption() {
        const optionsContainer = document.getElementById('pollOptionsContainer');
        const optionCount = optionsContainer.children.length + 1;
        const newOption = `
            <div class="input-group" style="margin-bottom: 10px;">
                <label>é€‰é¡¹ ${optionCount}</label>
                <input type="text" class="poll-option" placeholder="è¾“å…¥é€‰é¡¹å†…å®¹" required>
            </div>
        `;
        optionsContainer.insertAdjacentHTML('beforeend', newOption);
    }

    function createPoll() {
        const question = document.getElementById('pollQuestion').value.trim();
        const optionInputs = document.querySelectorAll('.poll-option');
        const options = Array.from(optionInputs).map(input => input.value.trim()).filter(Boolean);

        if (!question || options.length < 2) {
            alert('è¯·è¾“å…¥æŠ•ç¥¨é—®é¢˜å’Œè‡³å°‘ä¸¤ä¸ªé€‰é¡¹');
            return;
        }

        socket.emit('create-poll', {
            question,
            options
        });
        
        // ç›‘å¬æŠ•ç¥¨åˆ›å»ºç»“æœ
        const createPollHandler = (poll) => {
            closeCreatePollModal();
            loadPolls();
            alert('æŠ•ç¥¨åˆ›å»ºæˆåŠŸ');
            socket.off('poll-created', createPollHandler);
        };
        
        const pollErrorHandler = (error) => {
            alert('åˆ›å»ºæŠ•ç¥¨å¤±è´¥: ' + error.message);
            socket.off('poll-error', pollErrorHandler);
        };
        
        socket.on('poll-created', createPollHandler);
        socket.on('poll-error', pollErrorHandler);
        
        // 30ç§’åè‡ªåŠ¨ç§»é™¤ç›‘å¬å™¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
        setTimeout(() => {
            socket.off('poll-created', createPollHandler);
            socket.off('poll-error', pollErrorHandler);
        }, 30000);
    }

    function endPoll(pollId) {
        if (confirm('ç¡®å®šè¦ç»“æŸè¿™ä¸ªæŠ•ç¥¨å—ï¼Ÿ')) {
            socket.emit('end-poll', { pollId });
            
            // ç›‘å¬æŠ•ç¥¨ç»“æŸç»“æœ
            const endPollHandler = (poll) => {
                loadPolls();
                alert('æŠ•ç¥¨å·²ç»“æŸ');
                socket.off('poll-ended', endPollHandler);
            };
            
            const pollErrorHandler = (error) => {
                alert('ç»“æŸæŠ•ç¥¨å¤±è´¥: ' + error.message);
                socket.off('poll-error', pollErrorHandler);
            };
            
            socket.on('poll-ended', endPollHandler);
            socket.on('poll-error', pollErrorHandler);
            const permissionDeniedHandler = (error) => {
                alert('ç»“æŸæŠ•ç¥¨å¤±è´¥: ' + error.message);
                socket.off('permission-denied', permissionDeniedHandler);
            };
            socket.on('permission-denied', permissionDeniedHandler);
            
            // 30ç§’åè‡ªåŠ¨ç§»é™¤ç›‘å¬å™¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼
            setTimeout(() => {
                socket.off('poll-ended', endPollHandler);
                socket.off('poll-error', pollErrorHandler);
                socket.off('permission-denied', permissionDeniedHandler);
            }, 30000);
        }
    }

    // ç›‘å¬æŠ•ç¥¨ç›¸å…³äº‹ä»¶
    socket.on('poll-created', () => {
        loadPolls();
    });

    socket.on('poll-ended', () => {
        loadPolls();
    });

    socket.on('vote-updated', () => {
        loadPolls();
    });
    </script>
</body>
</html>
