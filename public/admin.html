<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; media-src 'self' blob:; connect-src 'self' ws: wss:; font-src 'self' data:;">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>èŠå¤©å®¤ç®¡ç†åå°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .login-container {
            padding: 40px;
            text-align: center;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-form {
            max-width: 400px;
            margin: 0 auto;
            width: 100%;
        }

        .login-form input {
            width: 100%;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
            outline: none;
            transition: border-color 0.3s;
        }

        .login-form input:focus {
            border-color: #667eea;
        }

        .login-form button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .login-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .admin-panel {
            display: none;
            padding: 20px;
            flex: 1;
            flex-direction: column;
        }
        
        .admin-panel.active {
            display: flex;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 14px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-list {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            background: white;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .user-name {
            font-weight: 500;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn-kick {
            background: #dc3545;
            color: white;
        }

        .btn-permissions {
            background: #28a745;
            color: white;
        }

        .btn-kick:hover {
            background: #c82333;
        }

        .btn-rename {
            background: #ffc107;
            color: #333;
        }

        .btn-rename:hover {
            background: #e0a800;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 12px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-group input {
            flex: 1;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
        }

        .input-group input:focus {
            border-color: #667eea;
        }

        .input-group button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .hidden {
            display: none !important;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
            flex-shrink: 0;
        }

        #permissionsForm {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            margin-bottom: 20px;
        }

        #permissionsForm::-webkit-scrollbar {
            width: 8px;
        }

        #permissionsForm::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #permissionsForm::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        #permissionsForm::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            flex-shrink: 0;
            margin-top: auto;
        }

        .modal-content input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 20px;
            outline: none;
        }

        .modal-content input:focus {
            border-color: #667eea;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
        }

        .btn-confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .permission-item {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            background: #f8f9fa;
        }

        .permission-item > label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-weight: normal;
            width: 100%;
        }

        .permission-item input[type="checkbox"] {
            display: none;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 20px;
            outline: none;
            resize: vertical;
            min-height: 80px;
        }

        .input-group textarea:focus {
            border-color: #667eea;
        }

        .input-group input[type="color"] {
            width: 100%;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .file-list {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            background: white;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .file-icon {
            font-size: 24px;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 500;
            margin-bottom: 5px;
            word-break: break-all;
        }

        .file-meta {
            font-size: 12px;
            color: #666;
        }

        .file-actions {
            display: flex;
            gap: 8px;
        }

        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e9ecef;
        }

        .files-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            background: white;
        }

        .files-container::-webkit-scrollbar {
            width: 8px;
        }

        .files-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .files-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .files-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .requests-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            background: white;
            margin-top: 15px;
        }

        .requests-container::-webkit-scrollbar {
            width: 8px;
        }

        .requests-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .requests-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .requests-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .request-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            background: white;
        }

        .request-item:last-child {
            border-bottom: none;
        }

        .request-info {
            flex: 1;
        }

        .request-info h4 {
            margin: 0 0 8px 0;
            color: #333;
        }

        .request-reason {
            margin: 0 0 10px 0;
            color: #666;
        }

        .request-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #999;
        }

        .request-actions {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .status-pending {
            color: #ffc107;
            font-weight: bold;
        }

        .status-approved {
            color: #28a745;
            font-weight: bold;
        }

        .status-rejected {
            color: #dc3545;
            font-weight: bold;
        }

        .path-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .current-path {
            flex: 1;
            font-family: 'Courier New', monospace;
            color: #666;
            font-size: 14px;
            word-break: break-all;
        }

        .upload-area input {
            display: none;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #666;
        }

        .messages-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .message-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .message-item.deleted {
            border-left-color: #dc3545;
            opacity: 0.7;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .message-sender {
            font-weight: bold;
            color: #333;
        }

        .message-time {
            font-size: 12px;
            color: #999;
        }

        .message-content {
            color: #666;
            word-break: break-word;
        }

        .message-content img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .message-content audio {
            width: 100%;
            max-width: 300px;
            margin-top: 10px;
        }

        .message-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }

        .message-status.active {
            background: #d4edda;
            color: #155724;
        }

        .message-status.deleted {
            background: #f8d7da;
            color: #721c24;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .tab-content.active {
            display: block;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 0;
                max-height: 100vh;
            }

            .file-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .file-actions {
                width: 100%;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>èŠå¤©å®¤ç®¡ç†åå°</h1>
            <div class="subtitle">ç®¡ç†å‘˜æ§åˆ¶é¢æ¿</div>
        </div>

        <div class="login-container" id="loginContainer">
            <div class="login-form">
                <form onsubmit="event.preventDefault(); login();">
                    <input type="password" id="adminPassword" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ">
                    <button type="submit">ç™»å½•</button>
                </form>
            </div>
        </div>

        <div class="admin-panel" id="adminPanel">
            <div class="stats">
                <div class="stat-card">
                    <h3>åœ¨çº¿ç”¨æˆ·</h3>
                    <div class="value" id="userCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>æ¶ˆæ¯æ€»æ•°</h3>
                    <div class="value" id="messageCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>å·²æ’¤å›æ¶ˆæ¯</h3>
                    <div class="value" id="deletedMessageCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>ä¸Šä¼ æ–‡ä»¶</h3>
                    <div class="value" id="fileCount">0</div>
                </div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('users')">ç”¨æˆ·ç®¡ç†</button>
                <button class="tab" onclick="switchTab('files')">æ–‡ä»¶ç®¡ç†</button>
                <button class="tab" onclick="switchTab('messages')">æ¶ˆæ¯ç®¡ç†</button>
                <button class="tab" onclick="switchTab('rooms')">æˆ¿é—´ç®¡ç†</button>
                <button class="tab" onclick="switchTab('roomDetails')">æˆ¿é—´è¯¦ç»†</button>
                <button class="tab" onclick="switchTab('friends')">å¥½å‹ç®¡ç†</button>
                <button class="tab" onclick="switchTab('requests')">ç”³è¯·ç®¡ç†</button>
                <button class="tab" onclick="switchTab('mutedUsers')">ç¦è¨€ç®¡ç†</button>
                <button class="tab" onclick="switchTab('calls')">é€šè¯ç®¡ç†</button>
                <button class="tab" onclick="switchTab('settingsManagement')">ç”¨æˆ·è®¾ç½®ç®¡ç†</button>
                <button class="tab" onclick="switchTab('systemManagement')">ç³»ç»Ÿç®¡ç†</button>
                <button class="tab" onclick="switchTab('globalSettings')">å…¨ä½“è®¾ç½®</button>
            </div>

            <div class="tab-content active" id="usersTab">
                <div class="section">
                    <h2>åœ¨çº¿ç”¨æˆ·ç®¡ç†</h2>
                    <button class="btn btn-primary" onclick="openUsersModal()">æ‰“å¼€ç”¨æˆ·åˆ—è¡¨</button>
                </div>

                <div class="section">
                    <h2>ç³»ç»Ÿæ¶ˆæ¯</h2>
                    <div class="input-group">
                        <form onsubmit="event.preventDefault(); sendSystemMessage();">
                            <input type="text" id="systemMessage" placeholder="è¾“å…¥ç³»ç»Ÿæ¶ˆæ¯å†…å®¹">
                            <button type="submit" class="btn btn-primary">å‘é€</button>
                        </form>
                    </div>
                </div>
                <div class="section">
                    <h2>ä¿®æ”¹ç®¡ç†å‘˜å¯†ç </h2>
                    <form onsubmit="event.preventDefault(); changeAdminPassword();">
                        <div class="input-group">
                            <input type="password" id="oldPassword" placeholder="æ—§å¯†ç " required>
                        </div>
                        <div class="input-group">
                            <input type="password" id="newPassword" placeholder="æ–°å¯†ç " required>
                        </div>
                        <div class="input-group">
                            <button type="submit" class="btn btn-primary">ä¿®æ”¹å¯†ç </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="tab-content" id="filesTab">
                <div class="section">
                    <h2>æ–‡ä»¶ç®¡ç†</h2>
                    <div class="path-bar">
                        <button class="btn btn-secondary" onclick="goBack()" id="backButton" disabled>â† è¿”å›ä¸Šä¸€çº§</button>
                        <span class="current-path" id="currentPath">/</span>
                    </div>
                    <div class="input-group">
                        <button class="btn btn-primary" onclick="loadFiles()">åˆ·æ–°æ–‡ä»¶åˆ—è¡¨</button>
                        <button class="btn btn-success" onclick="openUploadModal()">ä¸Šä¼ æ–‡ä»¶</button>
                        <button class="btn btn-primary" onclick="openCreateFileModal()">åˆ›å»ºæ–‡ä»¶</button>
                        <button class="btn btn-primary" onclick="openCreateDirectoryModal()">åˆ›å»ºç›®å½•</button>
                    </div>
                    <div class="files-container" id="filesContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <div>æš‚æ— æ–‡ä»¶</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="messagesTab">
                <div class="section">
                    <h2>æ¶ˆæ¯ç®¡ç†</h2>
                    <button class="btn btn-danger" onclick="clearMessages()">æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯</button>
                </div>

                <div class="section">
                    <h2>ä¼ªè£…å‘é€æ¶ˆæ¯</h2>
                    <button class="btn btn-primary" onclick="openAdminMessageModal()">ä¼ªè£…å‘é€æ¶ˆæ¯</button>
                </div>

                <div class="section">
                    <h2>æ‰€æœ‰æ¶ˆæ¯</h2>
                    <div class="input-group">
                        <button class="btn btn-primary" onclick="loadMessages()">åˆ·æ–°æ¶ˆæ¯</button>
                        <select id="roomSelect" class="btn btn-primary" style="margin-left: 10px;">
                            <option value="">é€‰æ‹©æˆ¿é—´</option>
                        </select>
                    </div>
                    <div class="messages-container" id="messagesContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ’¬</div>
                            <div>æš‚æ— æ¶ˆæ¯</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="roomsTab">
                <div class="section">
                    <h2>åˆ›å»ºæ–°æˆ¿é—´</h2>
                    <form onsubmit="event.preventDefault(); createRoom();">
                        <div class="input-group">
                            <input type="text" id="roomName" placeholder="æˆ¿é—´å" required>
                            <input type="password" id="roomPassword" placeholder="æˆ¿é—´å¯†ç ï¼ˆå¯é€‰ï¼‰">
                        </div>
                        <div class="input-group">
                            <label>æœ€å¤§ç”¨æˆ·æ•°ï¼š</label>
                            <input type="number" id="roomMaxUsers" placeholder="é»˜è®¤100" min="1" max="1000" value="100">
                        </div>
                        <div class="input-group">
                            <button type="submit" class="btn btn-primary">åˆ›å»ºæˆ¿é—´</button>
                        </div>
                    </form>
                </div>
                
                <div class="section">
                    <h2>æˆ¿é—´åˆ—è¡¨</h2>
                    <div class="input-group" style="margin-bottom: 15px;">
                        <input type="text" id="roomSearch" placeholder="æœç´¢æˆ¿é—´å" oninput="filterRooms()">
                    </div>
                    <div class="user-list" id="roomList">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ </div>
                            <div>æš‚æ— æˆ¿é—´</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="roomDetailsTab">
                <div class="section">
                    <h2 id="roomDetailsTitle">æˆ¿é—´è¯¦ç»†ä¿¡æ¯</h2>
                    <div id="roomDetailsInfo" style="margin-bottom: 20px;">
                        <p>ç‚¹å‡»æˆ¿é—´åˆ—è¡¨ä¸­çš„"æŸ¥çœ‹ç”¨æˆ·"æŒ‰é’®æŸ¥çœ‹æˆ¿é—´è¯¦æƒ…</p>
                    </div>
                </div>
                
                <div class="section">
                    <h2>æˆ¿é—´ç”¨æˆ·ç®¡ç†</h2>
                    <div class="input-group" style="margin-bottom: 15px;">
                        <input type="text" id="roomUserSearch" placeholder="æœç´¢æˆ¿é—´å†…çš„ç”¨æˆ·å" oninput="filterRoomUsers()">
                    </div>
                    <div class="user-list" id="roomUserList">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ‘¥</div>
                            <div>è¯¥æˆ¿é—´æš‚æ— ç”¨æˆ·</div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <h2>æˆ¿é—´æ¶ˆæ¯ç®¡ç†</h2>
                    
                    <div style="margin-bottom: 20px;">
                        <h3>å‘é€ç³»ç»Ÿæ¶ˆæ¯</h3>
                        <div class="input-group">
                            <form onsubmit="event.preventDefault(); sendRoomSystemMessage();">
                                <input type="text" id="roomSystemMessage" placeholder="è¾“å…¥æˆ¿é—´ç³»ç»Ÿæ¶ˆæ¯å†…å®¹">
                                <button type="submit" class="btn btn-primary">å‘é€</button>
                            </form>
                        </div>
                    </div>
                    
                    <div>
                        <h3>ä¼ªè£…å‘é€æ¶ˆæ¯</h3>
                        <button class="btn btn-primary" onclick="openRoomAdminMessageModal()">ä¼ªè£…å‘é€æ¶ˆæ¯</button>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="friendsTab">
                <div class="section">
                    <h2>å¥½å‹ç®¡ç†</h2>
                    <div class="input-group" style="margin-bottom: 15px;">
                        <input type="text" id="friendSearch" placeholder="æœç´¢ç”¨æˆ·å..." oninput="filterFriends()">
                        <button class="btn btn-primary" onclick="openAddFriendModal()">æ·»åŠ å¥½å‹</button>
                    </div>
                    <div class="user-list" id="friendsTabList">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ‘¥</div>
                            <div>æš‚æ— ç”¨æˆ·</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="requestsTab">
                <div class="section">
                    <h2>å¥½å‹æ‰©å®¹ç”³è¯·</h2>
                    <button class="btn btn-primary" onclick="loadFriendLimitRequests()">åˆ·æ–°ç”³è¯·åˆ—è¡¨</button>
                    <div class="requests-container" id="friendLimitRequestsContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“‹</div>
                            <div>æš‚æ— å¥½å‹æ‰©å®¹ç”³è¯·</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="globalSettingsTab">
                <div class="section">
                    <h2>å…¨ä½“æƒé™è®¾ç½®</h2>
                    <p style="margin-bottom: 15px; color: #666;">è®¾ç½®æ‰€æœ‰ç”¨æˆ·çš„é»˜è®¤æƒé™ï¼Œæ–°ç”¨æˆ·å°†ä½¿ç”¨è¿™äº›æƒé™</p>
                    <div id="globalPermissionsForm">
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸å‘é€è¯­éŸ³</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowAudio" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸å‘é€å›¾ç‰‡</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowImage" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸å‘é€æ–‡ä»¶</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowFile" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸å‘é€æ¶ˆæ¯</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowSendMessages" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸æŸ¥çœ‹æ¶ˆæ¯</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowViewMessages" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸é€šè¯</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowCall" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸æ·»åŠ å¥½å‹</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowAddFriends" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowViewUsers" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸ç§èŠ</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowPrivateChat" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸æ‰“å¼€å¥½å‹é¡µé¢</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowOpenFriendsPage" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                        <div class="permission-item">
                            <label>
                                <span>å…è®¸æ’¤å›æ¶ˆæ¯</span>
                                <label class="switch">
                                    <input type="checkbox" id="globalAllowRecallMessage" checked>
                                    <span class="slider"></span>
                                </label>
                            </label>
                        </div>
                    </div>
            
            <div style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="applyGlobalPermissions()">åº”ç”¨åˆ°æ‰€æœ‰ç”¨æˆ·</button>
                <button class="btn btn-info" onclick="applyToNewUsers()">ä»…åº”ç”¨åˆ°æ–°ç”¨æˆ·</button>
            </div>
        </div>
    </div>
        <div class="tab-content" id="mutedUsersTab">
            <div class="section">
                <h2>ç¦è¨€ç”¨æˆ·ç®¡ç†</h2>
                <button class="btn btn-primary" onclick="loadMutedUsers()">åˆ·æ–°ç¦è¨€åˆ—è¡¨</button>
                <button class="btn btn-primary" onclick="openMuteUserModal()">ç¦è¨€ç”¨æˆ·</button>
            </div>
            
            <div class="section">
                <h2>å·²ç¦è¨€ç”¨æˆ·</h2>
                <div class="user-list" id="mutedUsersList">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”‡</div>
                        <div>æš‚æ— è¢«ç¦è¨€ç”¨æˆ·</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="callsTab">
            <div class="section">
                <h2>é€šè¯ç®¡ç†</h2>
                <div class="call-method-info" style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #007bff;">
                    <h3 style="margin-top: 0; color: #007bff;">é€šè¯æ–¹å¼è¯´æ˜</h3>
                    <ul style="margin: 10px 0 0 20px; padding: 0;">
                        <li><strong>WebRTC</strong>ï¼šç‚¹å¯¹ç‚¹ç›´æ¥é€šä¿¡ï¼Œå»¶è¿Ÿä½ï¼Œè´¨é‡é«˜ï¼Œä½†åªèƒ½åœ¨å±€åŸŸç½‘å†…ä½¿ç”¨</li>
                        <li><strong>Socket.io</strong>ï¼šä½¿ç”¨æœåŠ¡å™¨è½¬å‘æ•°æ®ï¼Œæ”¯æŒè·¨ç½‘æ®µé€šè¯</li>
                    </ul>
                </div>
                <button class="btn btn-primary" onclick="loadOngoingCalls()">åˆ·æ–°é€šè¯åˆ—è¡¨</button>
            </div>
            
            <div class="section">
                <h2>æ­£åœ¨è¿›è¡Œçš„é€šè¯</h2>
                <div class="user-list" id="ongoingCallsList">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <div>æš‚æ— æ­£åœ¨è¿›è¡Œçš„é€šè¯</div>
                    </div>
                </div>
            </div>
            
            <!-- é€šè¯è¯¦æƒ…æ¨¡æ€æ¡† -->
            <div class="modal" id="callDetailsModal">
                <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto; overflow-x: hidden;">
                    <h3>é€šè¯è¯¦æƒ…</h3>
                    <div id="callDetailsInfo">
                        <!-- é€šè¯è¯¦æƒ…å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                    </div>
                    
                    <!-- é€šè¯åŒæ–¹ç”»é¢ -->
                    <div style="margin-top: 20px;">
                        <h3>é€šè¯ç”»é¢ç›‘æ§ <span id="callMethodDisplay" style="font-size: 14px; font-weight: normal; color: #666;"></span></h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                            <div style="background: #000; border-radius: 10px; overflow: hidden; position: relative; min-height: 300px;">
                                <h4 style="position: absolute; top: 10px; left: 10px; color: white; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 5px; margin: 0; z-index: 1;">å‘èµ·æ–¹ç”»é¢</h4>
                                <div id="initiatorVideoContainer" style="width: 100%; height: 300px; display: flex; align-items: center; justify-content: center; color: #666;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“¹</div>
                                        <div id="initiatorVideoStatus">ç­‰å¾…é€šè¯æ•°æ®...</div>
                                    </div>
                                </div>
                                <video id="initiatorVideo" autoplay playsinline style="display: none; width: 100%; height: 300px; object-fit: contain; background: #000;"></video>
                            </div>
                            <div style="background: #000; border-radius: 10px; overflow: hidden; position: relative; min-height: 300px;">
                                <h4 style="position: absolute; top: 10px; left: 10px; color: white; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 5px; margin: 0; z-index: 1;">æ¥æ”¶æ–¹ç”»é¢</h4>
                                <div id="recipientVideoContainer" style="width: 100%; height: 300px; display: flex; align-items: center; justify-content: center; color: #666;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“¹</div>
                                        <div id="recipientVideoStatus">ç­‰å¾…é€šè¯æ•°æ®...</div>
                                    </div>
                                </div>
                                <video id="recipientVideo" autoplay playsinline style="display: none; width: 100%; height: 300px; object-fit: contain; background: #000;"></video>
                            </div>
                        </div>
                        <div style="margin-top: 10px; font-size: 14px; color: #666;">
                            <strong>è¯´æ˜ï¼š</strong> 
                            <span id="videoModeNote">WebRTCä¸ºç‚¹å¯¹ç‚¹é€šè¯ï¼Œç®¡ç†å‘˜æ— æ³•æŸ¥çœ‹ç”»é¢ã€‚è¯·ä½¿ç”¨Socket.ioæ¨¡å¼è¿›è¡Œå¯ç›‘æ§çš„é€šè¯ã€‚</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 10px;">
                        <button class="btn btn-danger" onclick="endCall()">ç»“æŸé€šè¯</button>
                        <button class="btn btn-primary" onclick="toggleCallControl('video')">åˆ‡æ¢è§†é¢‘æ§åˆ¶</button>
                        <button class="btn btn-primary" onclick="toggleCallControl('audio')">åˆ‡æ¢éŸ³é¢‘æ§åˆ¶</button>
                        <button class="btn btn-cancel" onclick="closeCallDetailsModal()">å…³é—­</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="settingsManagementTab">
            <h2>ç”¨æˆ·è®¾ç½®ç®¡ç†</h2>
            <div class="section">
                <h3>ç”¨æˆ·åˆ—è¡¨</h3>
                <button class="btn btn-primary" onclick="loadUsersForSettings()">åˆ·æ–°ç”¨æˆ·åˆ—è¡¨</button>
                <div class="user-list" id="settingsUsersList">
                    <div class="empty-state">
                        <div>æš‚æ— ç”¨æˆ·æ•°æ®</div>
                    </div>
                </div>
            </div>
            <div class="section">
                <h3>ç”¨æˆ·è®¾ç½®æ§åˆ¶</h3>
                <div id="userSettingsForm" style="display: none;">
                    <h4>ç¼–è¾‘ç”¨æˆ·è®¾ç½® - <span id="selectedUsername"></span></h4>
                    <div class="input-group">
                        <label>é”å®šç”¨æˆ·è®¾ç½®</label>
                        <input type="checkbox" id="lockUserSettings">
                        <span class="help-text">é”å®šåç”¨æˆ·å°†æ— æ³•ä¿®æ”¹è‡ªå·±çš„è®¾ç½®</span>
                    </div>
                    <div class="input-group">
                        <label>è‡ªå®šä¹‰é”å®šæç¤º</label>
                        <input type="text" id="customLockMessage" placeholder="è®¾ç½®å·²è¢«ç®¡ç†å‘˜é”å®š">
                    </div>
                    
                    <h4 style="margin-top: 20px;">ç›´æ¥ä¿®æ”¹ç”¨æˆ·è®¾ç½®</h4>
                    <div class="input-group">
                        <label>ç¿»è¯‘ç›®æ ‡è¯­è¨€</label>
                        <select id="userTargetLanguage">
                            <option value="zh">ä¸­æ–‡</option>
                            <option value="en">English</option>
                            <option value="ja">æ—¥æœ¬èª</option>
                            <option value="ko">í•œêµ­ì–´</option>
                            <option value="fr">FranÃ§ais</option>
                            <option value="de">Deutsch</option>
                            <option value="es">EspaÃ±ol</option>
                            <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>è‡ªåŠ¨ç¿»è¯‘æ‰€æœ‰æ¶ˆæ¯</label>
                        <input type="checkbox" id="userAutoTranslate">
                    </div>
                    <div class="input-group">
                        <label>å£°éŸ³é€šçŸ¥</label>
                        <input type="checkbox" id="userSoundNotification">
                    </div>
                    <div class="input-group">
                        <label>@æåŠé€šçŸ¥</label>
                        <input type="checkbox" id="userMentionNotification">
                    </div>
                    
                    <div class="input-group" style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="saveUserSettings()">ä¿å­˜è®¾ç½®</button>
                        <button class="btn btn-secondary" onclick="closeUserSettingsForm()">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="systemManagementTab">
            <div class="section">
                <h2>æœåŠ¡å™¨ä¿¡æ¯</h2>
                <div id="serverInfo" style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <p>ç‚¹å‡»"è·å–æœåŠ¡å™¨ä¿¡æ¯"æŒ‰é’®æŸ¥çœ‹è¯¦æƒ…</p>
                </div>
                <button class="btn btn-primary" onclick="getServerInfo()">è·å–æœåŠ¡å™¨ä¿¡æ¯</button>
            </div>
            
            <div class="section">
                <h2>æœåŠ¡å™¨æ§åˆ¶</h2>
                <button class="btn btn-danger" onclick="shutdownServer()">å…³é—­æœåŠ¡å™¨</button>
            </div>
            
            <div class="section">
                <h2>æ‰§è¡Œå‘½ä»¤</h2>
                <div class="input-group">
                    <input type="text" id="commandInput" placeholder="è¾“å…¥è¦æ‰§è¡Œçš„å‘½ä»¤" style="width: 100%;">
                </div>
                <button class="btn btn-primary" onclick="executeCommand()">æ‰§è¡Œå‘½ä»¤</button>
                <div id="commandOutput" style="margin-top: 15px; background: #1e1e1e; color: #00ff00; padding: 15px; border-radius: 10px; max-height: 300px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; word-wrap: break-word;"></div>
            </div>
        </div>
    </div>

    <!-- ç¦è¨€ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal" id="muteUserModal">
        <div class="modal-content">
            <h3>ç¦è¨€ç”¨æˆ·</h3>
            <form onsubmit="event.preventDefault(); confirmMuteUser();">
                <div class="input-group">
                    <label>é€‰æ‹©ç”¨æˆ·</label>
                    <select id="muteUserId" required>
                        <option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>ç¦è¨€æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼Œ-1è¡¨ç¤ºæ°¸ä¹…ï¼‰</label>
                    <input type="number" id="muteDuration" placeholder="è¾“å…¥ç¦è¨€æ—¶é•¿ï¼Œ-1è¡¨ç¤ºæ°¸ä¹…" min="-1" value="5">
                </div>
                <div class="input-group">
                    <label>ç¦è¨€åŸå› </label>
                    <textarea id="muteReason" placeholder="è¾“å…¥ç¦è¨€åŸå› " rows="2" required></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeMuteUserModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">ç¡®è®¤ç¦è¨€</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal" id="usersModal">
        <div class="modal-content" style="max-width: 800px;">
            <h3>åœ¨çº¿ç”¨æˆ·ç®¡ç†</h3>
            <div class="input-group" style="margin-bottom: 15px;">
                <input type="text" id="userSearch" placeholder="æœç´¢ç”¨æˆ·åæˆ–æˆ¿é—´å" oninput="filterUsers()">
            </div>
            <div class="user-list" id="userList">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ‘¥</div>
                    <div>æš‚æ— åœ¨çº¿ç”¨æˆ·</div>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeUsersModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <div class="modal" id="renameModal">
        <div class="modal-content">
            <h3>é‡å‘½åç”¨æˆ·</h3>
            <form onsubmit="event.preventDefault(); confirmRename();">
                <input type="text" id="newUsername" placeholder="è¾“å…¥æ–°ç”¨æˆ·å" maxlength="20">
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeRenameModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">ç¡®è®¤</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="permissionsModal">
        <div class="modal-content">
            <h3>è®¾ç½®ç”¨æˆ·æƒé™</h3>
            <div id="permissionsForm">
                <div class="permission-item">
                    <label>
                        <span>å…è®¸å‘é€è¯­éŸ³</span>
                        <label class="switch">
                            <input type="checkbox" id="allowAudio" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸å‘é€å›¾ç‰‡</span>
                        <label class="switch">
                            <input type="checkbox" id="allowImage" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸å‘é€æ–‡ä»¶</span>
                        <label class="switch">
                            <input type="checkbox" id="allowFile" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸å‘é€æ¶ˆæ¯</span>
                        <label class="switch">
                            <input type="checkbox" id="allowSendMessages" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸æŸ¥çœ‹æ¶ˆæ¯</span>
                        <label class="switch">
                            <input type="checkbox" id="allowViewMessages" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸é€šè¯</span>
                        <label class="switch">
                            <input type="checkbox" id="allowCall" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸æ·»åŠ å¥½å‹</span>
                        <label class="switch">
                            <input type="checkbox" id="allowAddFriends" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨</span>
                        <label class="switch">
                            <input type="checkbox" id="allowViewUsers" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸ç§èŠ</span>
                        <label class="switch">
                            <input type="checkbox" id="allowPrivateChat" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸æ‰“å¼€å¥½å‹é¡µé¢</span>
                        <label class="switch">
                            <input type="checkbox" id="allowOpenFriendsPage" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
                <div class="permission-item">
                    <label>
                        <span>å…è®¸æ’¤å›æ¶ˆæ¯</span>
                        <label class="switch">
                            <input type="checkbox" id="allowRecallMessage" checked>
                            <span class="slider"></span>
                        </label>
                    </label>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closePermissionsModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-confirm" onclick="confirmPermissions()">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <div class="modal" id="adminMessageModal">
        <div class="modal-content">
            <h3>ä¼ªè£…å‘é€æ¶ˆæ¯</h3>
            <form onsubmit="event.preventDefault(); sendDisguisedMessage();">
                <div class="input-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="disguiseUsername" placeholder="è¾“å…¥è¦ä¼ªè£…çš„ç”¨æˆ·å" required>
                </div>
                <div class="input-group">
                    <label>æ¶ˆæ¯å†…å®¹</label>
                    <textarea id="disguiseMessage" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹" rows="3" required></textarea>
                </div>
                <div class="input-group">
                    <label>æ¶ˆæ¯ç±»å‹</label>
                    <select id="disguiseMessageType">
                        <option value="text">æ™®é€šæ¶ˆæ¯</option>
                        <option value="system">ç³»ç»Ÿæ¶ˆæ¯</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>æ¶ˆæ¯é¢œè‰²</label>
                    <input type="color" id="disguiseColor" value="#667eea">
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeAdminMessageModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">å‘é€</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="uploadFileModal">
        <div class="modal-content">
            <h3>ä¸Šä¼ æ–‡ä»¶</h3>
            <form onsubmit="event.preventDefault(); uploadFile();">
                <div class="input-group">
                    <label>é€‰æ‹©æ–‡ä»¶</label>
                    <input type="file" id="fileInput" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeUploadModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">ä¸Šä¼ </button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="createFileModal">
        <div class="modal-content">
            <h3>åˆ›å»ºæ–‡ä»¶</h3>
            <form onsubmit="event.preventDefault(); createFile();">
                <div class="input-group">
                    <label>æ–‡ä»¶å</label>
                    <input type="text" id="createFileName" placeholder="ä¾‹å¦‚: test.txt" required>
                </div>
                <div class="input-group">
                    <label>æ–‡ä»¶å†…å®¹</label>
                    <textarea id="createFileContent" placeholder="è¾“å…¥æ–‡ä»¶å†…å®¹" rows="5"></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeCreateFileModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">åˆ›å»º</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="createDirectoryModal">
        <div class="modal-content">
            <h3>åˆ›å»ºç›®å½•</h3>
            <form onsubmit="event.preventDefault(); createDirectory();">
                <div class="input-group">
                    <label>ç›®å½•å</label>
                    <input type="text" id="createDirectoryName" placeholder="ä¾‹å¦‚: images" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeCreateDirectoryModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">åˆ›å»º</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="editFileModal">
        <div class="modal-content">
            <h3>ç¼–è¾‘æ–‡ä»¶</h3>
            <form onsubmit="event.preventDefault(); saveFileEdit();">
                <div class="input-group">
                    <label>æ–‡ä»¶å</label>
                    <input type="text" id="editFileName" readonly>
                </div>
                <div class="input-group">
                    <label>æ–‡ä»¶å†…å®¹</label>
                    <textarea id="editFileContent" rows="10"></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeEditFileModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="setMaxFriendsModal">
        <div class="modal-content">
            <h3>è®¾ç½®å¥½å‹æ•°é‡ä¸Šé™</h3>
            <form onsubmit="event.preventDefault(); saveMaxFriends();">
                <div class="input-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="setMaxFriendsUsername" readonly>
                </div>
                <div class="input-group">
                    <label>å¥½å‹æ•°é‡ä¸Šé™</label>
                    <input type="number" id="setMaxFriendsValue" placeholder="è¾“å…¥-1è¡¨ç¤ºæ— é™" min="-1" value="5">
                    <small style="color: #666; display: block; margin-top: 5px;">è¾“å…¥-1è¡¨ç¤ºæ— é™å¥½å‹æ•°é‡</small>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeSetMaxFriendsModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="modal" id="editRoomModal">
        <div class="modal-content">
            <h3>ç¼–è¾‘æˆ¿é—´</h3>
            <form onsubmit="event.preventDefault(); confirmEditRoom();">
                <div class="input-group">
                    <label>æˆ¿é—´å</label>
                    <input type="text" id="editRoomName" readonly>
                </div>
                <div class="input-group">
                    <label>æˆ¿é—´å¯†ç </label>
                    <input type="password" id="editRoomPassword" placeholder="ç•™ç©ºè¡¨ç¤ºä¸è®¾ç½®å¯†ç ">
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeEditRoomModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="roomUsersModal">
        <div class="modal-content" style="max-width: 600px;">
            <h3 id="roomUsersTitle">æˆ¿é—´ç”¨æˆ·åˆ—è¡¨</h3>
            <div id="roomUsersList">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ‘¥</div>
                    <div>æš‚æ— ç”¨æˆ·</div>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeRoomUsersModal()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="friendsModal">
        <div class="modal-content" style="max-width: 800px;">
            <h3>å¥½å‹ç®¡ç†</h3>
            <div id="friendsList">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ‘¥</div>
                    <div>æš‚æ— å¥½å‹å…³ç³»</div>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeFriendsModal()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="addFriendModal">
        <div class="modal-content" style="max-width: 600px;">
            <h3>æ·»åŠ å¥½å‹</h3>
            <form onsubmit="event.preventDefault(); confirmAddFriend();">
                <div class="input-group">
                    <label>é€‰æ‹©ç”¨æˆ·A</label>
                    <select id="userA" required>
                        <option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>é€‰æ‹©ç”¨æˆ·B</label>
                    <select id="userB" required>
                        <option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeAddFriendModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">æ·»åŠ </button>
                </div>
            </form>
        </div>
    </div>
    <div class="modal" id="popupModal">
        <div class="modal-content">
            <h3>å‘é€å¼¹çª—æ¶ˆæ¯</h3>
            <form onsubmit="event.preventDefault(); sendPopup();">
                <div class="input-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="popupUsername" readonly>
                </div>
                <div class="input-group">
                    <label>å¼¹çª—å†…å®¹</label>
                    <textarea id="popupMessage" placeholder="è¾“å…¥å¼¹çª—å†…å®¹" rows="3" required></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closePopupModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">å‘é€</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="changeTitleModal">
        <div class="modal-content">
            <h3>æ›´æ”¹é¡µé¢æ ‡é¢˜</h3>
            <form onsubmit="event.preventDefault(); changeTitle();">
                <div class="input-group">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="changeTitleUsername" readonly>
                </div>
                <div class="input-group">
                    <label>æ–°æ ‡é¢˜</label>
                    <input type="text" id="changeTitleContent" placeholder="è¾“å…¥æ–°çš„é¡µé¢æ ‡é¢˜" required>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-cancel" onclick="closeChangeTitleModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-confirm">æ›´æ”¹</button>
                </div>
            </form>
        </div>
    </div>
    
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let users = [];
        let originalUsers = []; // å­˜å‚¨åŸå§‹ç”¨æˆ·åˆ—è¡¨ï¼Œç”¨äºæœç´¢è¿‡æ»¤
        let selectedSocketId = null;
        let originalFriendships = []; // å­˜å‚¨åŸå§‹å¥½å‹åˆ—è¡¨ï¼Œç”¨äºæœç´¢è¿‡æ»¤
        
        // é€šè¯ç›‘æ§ç›¸å…³
        let monitoredCalls = new Map(); // å­˜å‚¨æ­£åœ¨ç›‘æ§çš„é€šè¯: Map<callId, { initiator: socketId, recipient: socketId }>
        let callMediaStreams = new Map(); // å­˜å‚¨é€šè¯åª’ä½“æµ: Map<socketId, MediaStream>
        let mediaSourceMap = new Map(); // å­˜å‚¨MediaSource: Map<socketId, { mediaSource: MediaSource, sourceBuffer: SourceBuffer }>

        const loginContainer = document.getElementById('loginContainer');
        const adminPanel = document.getElementById('adminPanel');
        const adminPassword = document.getElementById('adminPassword');
        const userList = document.getElementById('userList');
        const userCount = document.getElementById('userCount');
        const messageCount = document.getElementById('messageCount');
        const deletedMessageCount = document.getElementById('deletedMessageCount');
        const systemMessage = document.getElementById('systemMessage');
        const renameModal = document.getElementById('renameModal');
        const newUsername = document.getElementById('newUsername');
        const messagesContainer = document.getElementById('messagesContainer');
        const permissionsModal = document.getElementById('permissionsModal');
        const permissionsForm = document.getElementById('permissionsForm');
        const allowAudio = document.getElementById('allowAudio');
        const allowImage = document.getElementById('allowImage');
        const allowFile = document.getElementById('allowFile');
        const allowSendMessages = document.getElementById('allowSendMessages');
        const allowViewMessages = document.getElementById('allowViewMessages');
        const allowCall = document.getElementById('allowCall');
        const allowAddFriends = document.getElementById('allowAddFriends');
        const allowViewUsers = document.getElementById('allowViewUsers');
        const allowPrivateChat = document.getElementById('allowPrivateChat');
        const allowOpenFriendsPage = document.getElementById('allowOpenFriendsPage');
        const allowRecallMessage = document.getElementById('allowRecallMessage');
        const adminMessageModal = document.getElementById('adminMessageModal');
        const disguiseUsername = document.getElementById('disguiseUsername');
        const disguiseMessageType = document.getElementById('disguiseMessageType');
        const disguiseMessage = document.getElementById('disguiseMessage');
        const disguiseColor = document.getElementById('disguiseColor');
        const usersModal = document.getElementById('usersModal');
        let selectedPermissionsSocketId = null;
        
        // è®¾ç½®å¥½å‹ä¸Šé™ç›¸å…³å…ƒç´ 
        const setMaxFriendsModal = document.getElementById('setMaxFriendsModal');
        const setMaxFriendsUsername = document.getElementById('setMaxFriendsUsername');
        const setMaxFriendsValue = document.getElementById('setMaxFriendsValue');
        let selectedMaxFriendsSocketId = null;
        
        // æˆ¿é—´ç®¡ç†ç›¸å…³å…ƒç´ 
        const roomName = document.getElementById('roomName');
        const roomPassword = document.getElementById('roomPassword');
        const roomMaxUsers = document.getElementById('roomMaxUsers');
        const roomList = document.getElementById('roomList');
        
        // ç¼–è¾‘æˆ¿é—´ç›¸å…³å…ƒç´ 
        const editRoomModal = document.getElementById('editRoomModal');
        const editRoomName = document.getElementById('editRoomName');
        const editRoomPassword = document.getElementById('editRoomPassword');
        let selectedEditRoomName = null;
        
        // æˆ¿é—´ç”¨æˆ·ç®¡ç†ç›¸å…³å…ƒç´ 
        const roomUsersModal = document.getElementById('roomUsersModal');
        const roomUsersTitle = document.getElementById('roomUsersTitle');
        const roomUsersList = document.getElementById('roomUsersList');
        let currentRoomName = null;
        let currentRoomUsers = [];
        
        // æœç´¢ç›¸å…³å…ƒç´ 
        const userSearch = document.getElementById('userSearch');
        const roomSearch = document.getElementById('roomSearch');
        let originalRooms = []; // å­˜å‚¨åŸå§‹æˆ¿é—´åˆ—è¡¨ï¼Œç”¨äºæœç´¢è¿‡æ»¤
        
        // å¥½å‹ç®¡ç†ç›¸å…³å…ƒç´ 
        const friendSearch = document.getElementById('friendSearch');
        const friendsTabList = document.getElementById('friendsTabList');
        const friendsModal = document.getElementById('friendsModal');
        
        // æˆ¿é—´è¯¦ç»†é¡µç›¸å…³å…ƒç´ 
        const roomDetailsTitle = document.getElementById('roomDetailsTitle');
        const roomDetailsInfo = document.getElementById('roomDetailsInfo');
        const roomUserSearch = document.getElementById('roomUserSearch');
        const roomUserListElement = document.getElementById('roomUserList');
        const roomSystemMessage = document.getElementById('roomSystemMessage');
        let currentRoomDetails = null;
        let roomUserList = [];
        let originalRoomUsers = [];
        
        // æˆ¿é—´é€‰æ‹©åŠŸèƒ½
        const roomSelect = document.getElementById('roomSelect');
        roomSelect.addEventListener('change', () => {
            const selectedRoom = roomSelect.value;
            if (selectedRoom) {
                loadRoomMessages(selectedRoom);
            }
        });
        
        adminPassword.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                login();
            }
        });

        newUsername.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                confirmRename();
            }
        });

        systemMessage.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendSystemMessage();
            }
        });

        let userRefreshInterval = null;
        
        function login() {
            const password = adminPassword.value;
            socket.emit('admin-login', password);
        }

        socket.on('admin-login-success', (success) => {
            if (success) {
                loginContainer.classList.add('hidden');
                adminPanel.classList.add('active');
                loadMessages();
                loadRooms();
                loadFiles();
                // ä¸»åŠ¨è¯·æ±‚æœ€æ–°çš„ç”¨æˆ·åˆ—è¡¨
                socket.emit('admin-get-users');
                
                // å¯åŠ¨ç”¨æˆ·åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°å®šæ—¶å™¨ï¼ˆæ¯ç§’ä¸€æ¬¡ï¼‰
                if (userRefreshInterval) {
                    clearInterval(userRefreshInterval);
                }
                userRefreshInterval = setInterval(() => {
                    socket.emit('admin-get-users');
                }, 1000);
            } else {
                alert('å¯†ç é”™è¯¯ï¼');
                adminPassword.value = '';
            }
        });
        
        // ç›‘å¬æ–°æ¶ˆæ¯å¹¶è‡ªåŠ¨åˆ·æ–°
        socket.on('message', () => {
            const selectedRoom = roomSelect.value || 'main';
            loadRoomMessages(selectedRoom);
        });
        
        // ç›‘å¬æ¶ˆæ¯æ’¤å›å¹¶è‡ªåŠ¨åˆ·æ–°
        socket.on('message-recalled', () => {
            const selectedRoom = roomSelect.value || 'main';
            loadRoomMessages(selectedRoom);
        });

        newUsername.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                confirmRename();
            }
        });

        systemMessage.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendSystemMessage();
            }
        });

        function updateUsersWithSearch(data) {
            originalUsers = [...data.users]; // ä¿å­˜åŸå§‹æ•°æ®
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒçš„æœç´¢
            const searchTerm = userSearch ? userSearch.value.toLowerCase().trim() : '';
            if (searchTerm) {
                // å¦‚æœæœ‰æœç´¢ï¼Œåº”ç”¨ç›¸åŒçš„æœç´¢æ¡ä»¶è¿‡æ»¤æ–°çš„ç”¨æˆ·åˆ—è¡¨
                users = data.users.filter(user => {
                    const username = user.username.toLowerCase();
                    const roomName = (user.roomName || 'main').toLowerCase();
                    return username.includes(searchTerm) || roomName.includes(searchTerm);
                });
            } else {
                // å¦‚æœæ²¡æœ‰æœç´¢ï¼Œç›´æ¥ä½¿ç”¨å®Œæ•´åˆ—è¡¨
                users = [...data.users];
            }
            
            updateUserList();
        }
        
        socket.on('user-joined', (data) => {
            updateUsersWithSearch(data);
        });

        socket.on('user-left', (data) => {
            updateUsersWithSearch(data);
        });

        socket.on('user-renamed', (data) => {
            updateUsersWithSearch(data);
        });

        socket.on('user-permissions-changed', (data) => {
            updateUsersWithSearch(data);
        });
        
        // ç›‘å¬é€šè¯åª’ä½“æµï¼Œç”¨äºç®¡ç†å‘˜æŸ¥çœ‹åŒæ–¹ç”»é¢
        socket.on('call-media', (data) => {
            if (data.isAdmin && data.type === 'media-data') {
                handleCallMedia(data);
            }
        });

        socket.on('admin-messages', (data) => {
            displayMessages(data);
        });
        
        function updateRoomsWithSearch(rooms) {
            originalRooms = [...rooms]; // ä¿å­˜åŸå§‹æ•°æ®
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒçš„æœç´¢
            const searchTerm = roomSearch ? roomSearch.value.toLowerCase().trim() : '';
            if (searchTerm) {
                // å¦‚æœæœ‰æœç´¢ï¼Œåº”ç”¨ç›¸åŒçš„æœç´¢æ¡ä»¶è¿‡æ»¤æ–°çš„æˆ¿é—´åˆ—è¡¨
                const filteredRooms = rooms.filter(room => {
                    return room.roomName.toLowerCase().includes(searchTerm);
                });
                updateRoomList(filteredRooms);
            } else {
                // å¦‚æœæ²¡æœ‰æœç´¢ï¼Œç›´æ¥ä½¿ç”¨å®Œæ•´åˆ—è¡¨
                updateRoomList(rooms);
            }
        }
        
        // æˆ¿é—´ç®¡ç†ç›¸å…³çš„socketäº‹ä»¶
        socket.on('admin-rooms', (rooms) => {
            updateRoomsWithSearch(rooms);
            updateRoomSelect(rooms);
        });
        
        socket.on('admin-room-error', (data) => {
            alert(data.message);
        });
        
        socket.on('admin-room-messages', (data) => {
            const roomMessages = {
                active: data.messages.filter(m => !m.recalled),
                deleted: data.messages.filter(m => m.recalled)
            };
            displayMessages(roomMessages, true);
        });
        
        socket.on('admin-password-success', (data) => {
            alert(data.message);
        });
        
        socket.on('admin-password-error', (data) => {
            alert(data.message);
        });
        
        socket.on('friends-list', (friends) => {
            updateFriendsList(friends);
        });
        
        socket.on('admin-room-users', (data) => {
            // è·å–å½“å‰æˆ¿é—´çš„è¯¦ç»†ä¿¡æ¯
            const room = originalRooms.find(r => r.roomName === currentRoomName);
            if (room) {
                currentRoomDetails = room;
                
                // æ›´æ–°æˆ¿é—´è¯¦ç»†ä¿¡æ¯
                roomDetailsTitle.textContent = `${escapeHtml(room.roomName)} æˆ¿é—´è¯¦ç»†ä¿¡æ¯`;
                const passwordText = room.password ? 'æœ‰å¯†ç ' : 'æ— å¯†ç ';
                roomDetailsInfo.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>æˆ¿é—´å:</strong> ${escapeHtml(room.roomName)}
                        </div>
                        <div>
                            <strong>å¯†ç :</strong> ${passwordText}
                        </div>
                        <div>
                            <strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(room.createdAt).toLocaleString()}
                        </div>
                        <div>
                            <strong>æ›´æ–°æ—¶é—´:</strong> ${new Date(room.updatedAt).toLocaleString()}
                        </div>
                        <div>
                            <strong>ç”¨æˆ·æ•°é‡:</strong> ${data.users.length}
                        </div>
                        <div>
                            <strong>æœ€å¤§ç”¨æˆ·æ•°:</strong> ${room.settings.maxUsers}
                        </div>
                    </div>
                `;
                
                // æ›´æ–°æˆ¿é—´ç”¨æˆ·åˆ—è¡¨
                roomUserList = data.users;
                originalRoomUsers = [...data.users];
                updateRoomUserList();
            }
        });

        // æˆ¿é—´ç®¡ç†åŠŸèƒ½
        function createRoom() {
            const name = roomName.value.trim();
            const password = roomPassword.value.trim() || null;
            const maxUsers = parseInt(roomMaxUsers.value) || 100;
            
            if (name) {
                socket.emit('admin-create-room', { roomName: name, password: password, settings: { maxUsers: maxUsers } });
                roomName.value = '';
                roomPassword.value = '';
                roomMaxUsers.value = '100';
            }
        }
        
        function loadRooms() {
            socket.emit('admin-get-rooms');
        }
        
        function deleteRoom(roomName) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤æˆ¿é—´ ${roomName} å—ï¼Ÿæˆ¿é—´å†…çš„ç”¨æˆ·å°†è¢«è½¬ç§»åˆ°é»˜è®¤æˆ¿é—´ã€‚`)) {
                socket.emit('admin-delete-room', roomName);
            }
        }
        
        function updateRoom(roomName) {
            selectedEditRoomName = roomName;
            editRoomName.value = roomName;
            editRoomPassword.value = '';
            editRoomModal.classList.add('active');
        }
        
        function closeEditRoomModal() {
            editRoomModal.classList.remove('active');
            selectedEditRoomName = null;
        }
        
        function confirmEditRoom() {
            const password = editRoomPassword.value.trim() || null;
            
            if (selectedEditRoomName) {
                socket.emit('admin-update-room', {
                    roomName: selectedEditRoomName,
                    updates: { password: password }
                });
                closeEditRoomModal();
            }
        }
        
        function updateRoomList(rooms) {
            if (rooms.length === 0) {
                roomList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ </div>
                        <div>æš‚æ— æˆ¿é—´</div>
                    </div>`;
                return;
            }
            
            roomList.innerHTML = rooms.map(room => {
                const passwordText = room.password ? 'æœ‰å¯†ç ' : 'æ— å¯†ç ';
                const userCount = room.users.length;
                const isDefaultRoom = room.roomName === 'main';
                const defaultBadge = isDefaultRoom ? '<span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; margin-left: 5px;">é»˜è®¤</span>' : '';
                
                return `
                    <div class="user-item">
                        <div class="user-info">
                            <div class="user-color" style="background: #667eea;"></div>
                            <div>
                                <div class="user-name">${escapeHtml(room.roomName)}${defaultBadge}</div>
                                <small style="color: #666;">${passwordText} | ${userCount} ä¸ªç”¨æˆ· | åˆ›å»ºäº: ${new Date(room.createdAt).toLocaleString()}</small>
                            </div>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-info btn-sm" onclick="updateRoom('${room.roomName}')">ç¼–è¾‘</button>
                            <button class="btn btn-primary btn-sm" onclick="viewRoomUsers('${room.roomName}')">æŸ¥çœ‹ç”¨æˆ·</button>
                            ${!isDefaultRoom ? `<button class="btn btn-danger btn-sm" onclick="deleteRoom('${room.roomName}')">åˆ é™¤</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function updateRoomSelect(rooms) {
            roomSelect.innerHTML = '<option value="">é€‰æ‹©æˆ¿é—´</option>';
            rooms.forEach(room => {
                const option = document.createElement('option');
                option.value = room.roomName;
                option.textContent = room.roomName;
                roomSelect.appendChild(option);
            });
            
            roomSelect.value = 'main';
        }
        
        function viewRoomUsers(roomName) {
            currentRoomName = roomName;
            
            // è¯·æ±‚è·å–è¯¥æˆ¿é—´çš„ç”¨æˆ·åˆ—è¡¨
            socket.emit('admin-get-room-users', roomName);
            
            // åˆ‡æ¢åˆ°æˆ¿é—´è¯¦ç»†é¡µæ ‡ç­¾
            switchTab('roomDetails');
        }
        
        function closeRoomUsersModal() {
            roomUsersModal.classList.remove('active');
            currentRoomName = null;
            currentRoomUsers = [];
        }
        
        function updateRoomUsersList(users) {
            // å…¼å®¹åŸæœ‰æ¨¡æ€æ¡†æ˜¾ç¤º
            if (roomUsersModal.classList.contains('active')) {
                currentRoomUsers = users;
                
                if (users.length === 0) {
                    roomUsersList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ‘¥</div>
                            <div>è¯¥æˆ¿é—´æš‚æ— ç”¨æˆ·</div>
                        </div>`;
                    return;
                }
                
                roomUsersList.innerHTML = users.map(user => {
                    return `
                        <div class="user-item">
                            <div class="user-info">
                                <div class="user-color" style="background: ${user.color}"></div>
                                <div class="user-name">${escapeHtml(user.username)}</div>
                            </div>
                            <div class="user-actions">
                                <button class="btn btn-rename" onclick="openRoomUserRenameModal('${user.socketId}', '${user.username}')">é‡å‘½å</button>
                                <button class="btn btn-kick" onclick="roomKickUser('${user.socketId}', '${user.username}')">è¸¢å‡ºæˆ¿é—´</button>
                                <button class="btn btn-permissions" onclick="openRoomUserPermissionsModal('${user.socketId}')">æƒé™</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function updateRoomUserList() {
            if (roomUserList.length === 0) {
                roomUserListElement.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‘¥</div>
                        <div>è¯¥æˆ¿é—´æš‚æ— ç”¨æˆ·</div>
                    </div>`;
                return;
            }
            
            roomUserListElement.innerHTML = roomUserList.map(user => {
                return `
                    <div class="user-item">
                        <div class="user-info">
                            <div class="user-color" style="background: ${user.color}"></div>
                            <div class="user-name">${escapeHtml(user.username)}</div>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-rename" onclick="openRoomUserRenameModal('${user.socketId}', '${user.username}')">é‡å‘½å</button>
                            <button class="btn btn-kick" onclick="roomKickUser('${user.socketId}', '${user.username}')">è¸¢å‡ºæˆ¿é—´</button>
                            <button class="btn btn-permissions" onclick="openRoomUserPermissionsModal('${user.socketId}')">æƒé™</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function filterRoomUsers() {
            const searchTerm = roomUserSearch.value.toLowerCase().trim();
            
            if (!searchTerm) {
                // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰æˆ¿é—´ç”¨æˆ·
                roomUserList = [...originalRoomUsers];
                updateRoomUserList();
                return;
            }
            
            // æ ¹æ®ç”¨æˆ·åè¿‡æ»¤æˆ¿é—´å†…çš„ç”¨æˆ·
            roomUserList = originalRoomUsers.filter(user => {
                const username = user.username.toLowerCase();
                return username.includes(searchTerm);
            });
            
            updateRoomUserList();
        }
        
        // å‘é€æˆ¿é—´ç³»ç»Ÿæ¶ˆæ¯
        function sendRoomSystemMessage() {
            const message = roomSystemMessage.value.trim();
            if (message && currentRoomName) {
                socket.emit('admin-room-system-message', {
                    roomName: currentRoomName,
                    message: message
                });
                roomSystemMessage.value = '';
                alert('ç³»ç»Ÿæ¶ˆæ¯å·²å‘é€åˆ°æˆ¿é—´ ' + currentRoomName);
            }
        }
        
        // æ‰“å¼€æˆ¿é—´ä¼ªè£…å‘æ¶ˆæ¯æ¨¡æ€æ¡†
        function openRoomAdminMessageModal() {
            if (currentRoomName) {
                openAdminMessageModal();
            } else {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæˆ¿é—´');
            }
        }
        
        function roomKickUser(socketId, username) {
            if (confirm(`ç¡®å®šè¦å°† ${escapeHtml(username)} è¸¢å‡ºæˆ¿é—´ ${escapeHtml(currentRoomName)} å—ï¼Ÿ`)) {
                socket.emit('admin-room-kick-user', {
                    roomName: currentRoomName,
                    socketId: socketId
                });
                
                // é‡æ–°è·å–æˆ¿é—´ç”¨æˆ·åˆ—è¡¨
                socket.emit('admin-get-room-users', currentRoomName);
            }
        }
        
        // ä¸ºæˆ¿é—´è¯¦ç»†é¡µæ·»åŠ è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
        let roomDetailsRefreshInterval = null;
        // ä¸ºç¦è¨€åˆ—è¡¨æ·»åŠ è‡ªåŠ¨åˆ·æ–°åŠŸèƒ½
        let mutedUsersRefreshInterval = null;
        
        // åœ¨åˆ‡æ¢åˆ°æˆ¿é—´è¯¦ç»†é¡µæ—¶å¯åŠ¨è‡ªåŠ¨åˆ·æ–°
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            if (tabName === 'messages') {
                loadMessages();
            } else if (tabName === 'rooms') {
                loadRooms();
            } else if (tabName === 'roomDetails') {
                // å¯åŠ¨æˆ¿é—´è¯¦ç»†é¡µçš„è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯ç§’ä¸€æ¬¡ï¼‰
                if (roomDetailsRefreshInterval) {
                    clearInterval(roomDetailsRefreshInterval);
                }
                if (currentRoomName) {
                    roomDetailsRefreshInterval = setInterval(() => {
                        socket.emit('admin-get-room-users', currentRoomName);
                    }, 1000);
                }
            } else if (tabName === 'mutedUsers') {
                loadMutedUsers();
                // å¯åŠ¨ç¦è¨€åˆ—è¡¨è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯2ç§’ä¸€æ¬¡ï¼‰
                if (mutedUsersRefreshInterval) {
                    clearInterval(mutedUsersRefreshInterval);
                }
                mutedUsersRefreshInterval = setInterval(() => {
                    loadMutedUsers();
                }, 2000);
            } else if (tabName === 'friends') {
                loadFriends();
            } else if (tabName === 'settingsManagement') {
                // åˆ‡æ¢åˆ°ç”¨æˆ·è®¾ç½®ç®¡ç†æ ‡ç­¾é¡µæ—¶ï¼ŒåŠ è½½ç”¨æˆ·åˆ—è¡¨
                loadUsersForSettings();
            } else if (tabName === 'systemManagement') {
                // åˆ‡æ¢åˆ°ç³»ç»Ÿç®¡ç†æ ‡ç­¾é¡µæ—¶ï¼Œå¯åŠ¨è‡ªåŠ¨åˆ·æ–°æœåŠ¡å™¨ä¿¡æ¯ï¼ˆæ¯ç§’ä¸€æ¬¡ï¼‰
                startServerInfoRefresh();
            } else if (tabName === 'globalSettings') {
                // å…¨ä½“è®¾ç½®æ ‡ç­¾é¡µä¸éœ€è¦ç‰¹æ®Šå¤„ç†
            } else {
                // å¦‚æœåˆ‡æ¢åˆ°å…¶ä»–æ ‡ç­¾é¡µï¼Œåœæ­¢æˆ¿é—´è¯¦ç»†é¡µã€ç¦è¨€åˆ—è¡¨å’ŒæœåŠ¡å™¨ä¿¡æ¯çš„è‡ªåŠ¨åˆ·æ–°
                if (roomDetailsRefreshInterval) {
                    clearInterval(roomDetailsRefreshInterval);
                    roomDetailsRefreshInterval = null;
                }
                if (mutedUsersRefreshInterval) {
                    clearInterval(mutedUsersRefreshInterval);
                    mutedUsersRefreshInterval = null;
                }
                // ç¦»å¼€ç³»ç»Ÿç®¡ç†æ ‡ç­¾é¡µæ—¶ï¼Œåœæ­¢è‡ªåŠ¨åˆ·æ–°æœåŠ¡å™¨ä¿¡æ¯
                stopServerInfoRefresh();
            }
        }
        
        function openRoomUserRenameModal(socketId, currentName) {
            selectedSocketId = socketId;
            newUsername.value = currentName;
            renameModal.classList.add('active');
            newUsername.focus();
        }
        
        function confirmRename() {
            const newName = newUsername.value.trim();
            if (newName && selectedSocketId) {
                if (currentRoomName) {
                    // å¦‚æœåœ¨æˆ¿é—´ç”¨æˆ·åˆ—è¡¨ä¸­é‡å‘½åï¼Œä½¿ç”¨æˆ¿é—´å†…é‡å‘½ååŠŸèƒ½
                    socket.emit('admin-room-rename-user', {
                        roomName: currentRoomName,
                        socketId: selectedSocketId,
                        newName: newName
                    });
                    
                    // é‡æ–°è·å–æˆ¿é—´ç”¨æˆ·åˆ—è¡¨
                    socket.emit('admin-get-room-users', currentRoomName);
                } else {
                    // å¦åˆ™ä½¿ç”¨å…¨å±€é‡å‘½ååŠŸèƒ½
                    socket.emit('admin-rename-user', {
                        socketId: selectedSocketId,
                        newName: newName
                    });
                }
                
                closeRenameModal();
            }
        }
        
        function openRoomUserPermissionsModal(socketId) {
            selectedPermissionsSocketId = socketId;
            const user = currentRoomUsers.find(u => u.socketId === socketId);
            if (user) {
                allowAudio.checked = user.permissions.allowAudio;
                allowImage.checked = user.permissions.allowImage;
                allowFile.checked = user.permissions.allowFile;
                allowSendMessages.checked = user.permissions.allowSendMessages;
                allowViewMessages.checked = user.permissions.allowViewMessages;
                allowCall.checked = user.permissions.allowCall;
                allowAddFriends.checked = user.permissions.allowAddFriends ?? true;
                allowViewUsers.checked = user.permissions.allowViewUsers ?? true;
                allowPrivateChat.checked = user.permissions.allowPrivateChat ?? true;
                allowOpenFriendsPage.checked = user.permissions.allowOpenFriendsPage ?? true;
                allowRecallMessage.checked = user.permissions.allowRecallMessage ?? true;
            }
            permissionsModal.classList.add('active');
        }
        
        function openPermissionsModal(socketId) {
            selectedPermissionsSocketId = socketId;
            const user = users.find(u => u.socketId === socketId);
            if (user) {
                allowAudio.checked = user.permissions.allowAudio;
                allowImage.checked = user.permissions.allowImage;
                allowFile.checked = user.permissions.allowFile;
                allowSendMessages.checked = user.permissions.allowSendMessages;
                allowViewMessages.checked = user.permissions.allowViewMessages;
                allowCall.checked = user.permissions.allowCall;
                allowAddFriends.checked = user.permissions.allowAddFriends ?? true;
                allowViewUsers.checked = user.permissions.allowViewUsers ?? true;
                allowPrivateChat.checked = user.permissions.allowPrivateChat ?? true;
                allowOpenFriendsPage.checked = user.permissions.allowOpenFriendsPage ?? true;
                allowRecallMessage.checked = user.permissions.allowRecallMessage ?? true;
            }
            permissionsModal.classList.add('active');
        }
        
        function closePermissionsModal() {
            permissionsModal.classList.remove('active');
            selectedPermissionsSocketId = null;
        }
        
        function confirmPermissions() {
            if (selectedPermissionsSocketId) {
                if (currentRoomName) {
                    // å¦‚æœåœ¨æˆ¿é—´ç”¨æˆ·åˆ—è¡¨ä¸­è®¾ç½®æƒé™ï¼Œä½¿ç”¨æˆ¿é—´å†…æƒé™è®¾ç½®åŠŸèƒ½
                    socket.emit('admin-room-set-permissions', {
                        roomName: currentRoomName,
                        socketId: selectedPermissionsSocketId,
                        permissions: {
                            allowAudio: allowAudio.checked,
                            allowImage: allowImage.checked,
                            allowFile: allowFile.checked,
                            allowSendMessages: allowSendMessages.checked,
                            allowViewMessages: allowViewMessages.checked,
                            allowCall: allowCall.checked,
                            allowAddFriends: allowAddFriends.checked,
                            allowViewUsers: allowViewUsers.checked,
                            allowPrivateChat: allowPrivateChat.checked,
                            allowOpenFriendsPage: allowOpenFriendsPage.checked,
                            allowRecallMessage: allowRecallMessage.checked
                        }
                    });
                    
                    // é‡æ–°è·å–æˆ¿é—´ç”¨æˆ·åˆ—è¡¨
                    socket.emit('admin-get-room-users', currentRoomName);
                } else {
                    // å¦åˆ™ä½¿ç”¨å…¨å±€æƒé™è®¾ç½®åŠŸèƒ½
                    socket.emit('admin-set-permissions', {
                        socketId: selectedPermissionsSocketId,
                        permissions: {
                            allowAudio: allowAudio.checked,
                            allowImage: allowImage.checked,
                            allowFile: allowFile.checked,
                            allowSendMessages: allowSendMessages.checked,
                            allowViewMessages: allowViewMessages.checked,
                            allowCall: allowCall.checked,
                            allowAddFriends: allowAddFriends.checked,
                            allowViewUsers: allowViewUsers.checked,
                            allowPrivateChat: allowPrivateChat.checked,
                            allowOpenFriendsPage: allowOpenFriendsPage.checked,
                            allowRecallMessage: allowRecallMessage.checked
                        }
                    });
                }
                
                closePermissionsModal();
            }
        }

        function updateUserList() {
            userCount.textContent = users.length;
            
            if (users.length === 0) {
                userList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‘¥</div>
                        <div>æš‚æ— åœ¨çº¿ç”¨æˆ·</div>
                    </div>`;
                return;
            }

            userList.innerHTML = users.map(user => `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-color" style="background: ${user.color}"></div>
                        <div>
                            <div class="user-name">${escapeHtml(user.username)}</div>
                            <small style="color: #666;">æˆ¿é—´: ${escapeHtml(user.roomName || 'main')}</small>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-rename" onclick="openRenameModal('${user.socketId}')">é‡å‘½å</button>
                        <button class="btn btn-kick" onclick="kickUser('${user.socketId}')">è¸¢å‡º</button>
                        <button class="btn btn-permissions" onclick="openPermissionsModal('${user.socketId}')">æƒé™</button>
                        <button class="btn btn-primary" onclick="openSetMaxFriendsModal('${user.socketId}', '${escapeHtml(user.username)}')">å¥½å‹ä¸Šé™</button>
                        <button class="btn btn-info" onclick="openPopupModal('${user.socketId}', '${escapeHtml(user.username)}')">å¼¹çª—</button>
                        <button class="btn btn-success" onclick="openChangeTitleModal('${user.socketId}', '${escapeHtml(user.username)}')">æ›´æ”¹æ ‡é¢˜</button>
                    </div>
                </div>
            `).join('');
        }
        
        function kickUser(socketId) {
            if (confirm('ç¡®å®šè¦è¸¢å‡ºè¯¥ç”¨æˆ·å—ï¼Ÿ')) {
                socket.emit('admin-kick-user', socketId);
            }
        }

        function openRenameModal(socketId) {
            selectedSocketId = socketId;
            newUsername.value = '';
            usersModal.classList.remove('active');
            renameModal.classList.add('active');
            newUsername.focus();
        }

        function closeRenameModal() {
            renameModal.classList.remove('active');
            selectedSocketId = null;
        }

        function openAdminMessageModal() {
            adminMessageModal.classList.add('active');
            disguiseUsername.focus();
        }

        function closeAdminMessageModal() {
            adminMessageModal.classList.remove('active');
            disguiseUsername.value = '';
            disguiseMessage.value = '';
        }
        
        function openUsersModal() {
            usersModal.classList.add('active');
        }
        
        function closeUsersModal() {
            usersModal.classList.remove('active');
        }

        // è®¾ç½®å¥½å‹ä¸Šé™ç›¸å…³å‡½æ•°
        function openSetMaxFriendsModal(socketId, username) {
            selectedMaxFriendsSocketId = socketId;
            setMaxFriendsUsername.value = username;
            setMaxFriendsValue.value = '5'; // é»˜è®¤å€¼
            setMaxFriendsModal.classList.add('active');
        }

        function closeSetMaxFriendsModal() {
            setMaxFriendsModal.classList.remove('active');
            selectedMaxFriendsSocketId = null;
        }

        function saveMaxFriends() {
            const maxFriends = parseInt(setMaxFriendsValue.value);
            if (selectedMaxFriendsSocketId && !isNaN(maxFriends)) {
                socket.emit('admin-set-user-max-friends', {
                    userId: selectedMaxFriendsSocketId,
                    maxFriends: maxFriends
                });
                closeSetMaxFriendsModal();
            }
        }

        // å¼¹çª—ç›¸å…³å‡½æ•°
        function openPopupModal(socketId, username) {
            selectedSocketId = socketId;
            document.getElementById('popupUsername').value = username;
            usersModal.classList.remove('active');
            document.getElementById('popupModal').classList.add('active');
            document.getElementById('popupMessage').focus();
        }
        
        function closePopupModal() {
            document.getElementById('popupModal').classList.remove('active');
            selectedSocketId = null;
        }
        
        function sendPopup() {
            const message = document.getElementById('popupMessage').value.trim();
            if (message) {
                socket.emit('admin-popup', {
                    socketId: selectedSocketId,
                    message: message
                });
                closePopupModal();
            }
        }
        
        // æ›´æ”¹æ ‡é¢˜ç›¸å…³å‡½æ•°
        function openChangeTitleModal(socketId, username) {
            selectedSocketId = socketId;
            document.getElementById('changeTitleUsername').value = username;
            usersModal.classList.remove('active');
            document.getElementById('changeTitleModal').classList.add('active');
            document.getElementById('changeTitleContent').focus();
        }
        
        function closeChangeTitleModal() {
            document.getElementById('changeTitleModal').classList.remove('active');
            selectedSocketId = null;
        }
        
        function changeTitle() {
            const title = document.getElementById('changeTitleContent').value.trim();
            if (title) {
                socket.emit('admin-change-title', {
                    socketId: selectedSocketId,
                    title: title
                });
                closeChangeTitleModal();
            }
        }

        function sendDisguisedMessage() {
            const username = disguiseUsername.value.trim();
            const message = disguiseMessage.value.trim();
            const color = disguiseColor.value;
            const type = disguiseMessageType.value;
            
            if (username && message) {
                if (currentRoomName) {
                    // å¦‚æœåœ¨æˆ¿é—´è¯¦ç»†é¡µï¼Œå‘é€åˆ°æŒ‡å®šæˆ¿é—´
                    socket.emit('admin-room-send-message', {
                        roomName: currentRoomName,
                        username: username,
                        message: message,
                        color: color,
                        type: type
                    });
                } else {
                    // å¦åˆ™å‘é€åˆ°æ‰€æœ‰æˆ¿é—´
                    socket.emit('admin-send-message', {
                        username: username,
                        message: message,
                        color: color,
                        type: type
                    });
                }
                closeAdminMessageModal();
            }
        }

        function sendSystemMessage() {
            const message = systemMessage.value.trim();
            if (message) {
                socket.emit('admin-system-message', message);
                systemMessage.value = '';
            }
        }
        
        // å¥½å‹ç®¡ç†åŠŸèƒ½
        function loadFriends() {
            console.log('æ­£åœ¨åŠ è½½å¥½å‹åˆ—è¡¨...');
            socket.emit('admin-get-friends');
        }
        
        socket.on('admin-friends-list', (friendships) => {
            console.log('æ”¶åˆ°å¥½å‹åˆ—è¡¨:', friendships);
            updateFriendsList(friendships);
        });
        
        function filterFriends() {
            const searchTerm = friendSearch.value.trim().toLowerCase();
            if (!searchTerm) {
                updateFriendsList(originalFriendships);
                return;
            }
            
            const filteredFriendships = originalFriendships.filter(friendship => 
                friendship.username.toLowerCase().includes(searchTerm) || 
                friendship.friendUsername.toLowerCase().includes(searchTerm)
            );
            updateFriendsList(filteredFriendships);
        }
        
        function updateFriendsList(friendships) {
            originalFriendships = friendships;
            
            if (friendships.length === 0) {
                friendsTabList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ‘¥</div>
                        <div>æš‚æ— å¥½å‹å…³ç³»</div>
                    </div>`;
                return;
            }
            
            friendsTabList.innerHTML = friendships.map(friendship => `
                <div class="user-item">
                    <div class="user-info">
                        <div class="user-color" style="background: ${friendship.userColor}"></div>
                        <div>
                            <div class="user-name">${escapeHtml(friendship.username)}</div>
                            <small style="color: #666;">å¥½å‹: ${escapeHtml(friendship.friendUsername)}</small>
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-primary btn-sm" onclick="adminPrivateChat('${friendship.userSocketId}', '${friendship.username}')">ç§èŠ</button>
                        <button class="btn btn-info btn-sm" onclick="viewPrivateChat('${friendship.userSocketId}', '${friendship.username}')">æŸ¥çœ‹ç§èŠ</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteFriendship('${friendship.userSocketId}', '${friendship.friendSocketId}')">åˆ é™¤å¥½å‹å…³ç³»</button>
                    </div>
                </div>
            `).join('');
        }
        
        function adminPrivateChat(socketId, username) {
            const message = prompt(`å‘é€ç§èŠæ¶ˆæ¯ç»™ ${username}ï¼š`);
            if (message) {
                socket.emit('admin-private-message', {
                    targetSocketId: socketId,
                    message: message,
                    type: 'text'
                });
            }
        }
        
        function viewPrivateChat(socketId, username) {
            const chatId = [socket.id, socketId].sort().join('-');
            socket.emit('admin-get-private-messages', {
                targetSocketId: socketId
            });
            
            // æ˜¾ç¤ºç§èŠå†å²
            const modalDiv = document.createElement('div');
            modalDiv.className = 'modal active';
            modalDiv.innerHTML = `
                <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
                    <h3>ä¸ ${username} çš„ç§èŠå†å²</h3>
                    <div id="privateChatHistory" style="max-height: 500px; overflow-y: auto; background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;"></div>
                    <div class="modal-buttons">
                        <button type="button" class="btn btn-cancel" onclick="this.parentElement.parentElement.parentElement.remove();">å…³é—­</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modalDiv);
            
            // ç›‘å¬ç§èŠå†å²æ¶ˆæ¯
            socket.on('admin-private-messages-history', (data) => {
                const historyDiv = document.getElementById('privateChatHistory');
                if (historyDiv) {
                    historyDiv.innerHTML = data.messages.map(msg => `
                        <div class="message-item">
                            <div class="message-header">
                                <span class="message-sender">${msg.fromUsername}</span>
                                <span class="message-time">${msg.timestamp}</span>
                            </div>
                            <div class="message-content">${escapeHtml(msg.message)}</div>
                        </div>
                    `).join('');
                }
            });
        }
        
        function closeFriendsModal() {
            friendsModal.classList.remove('active');
        }
        
        function openAddFriendModal() {
            const userASelect = document.getElementById('userA');
            const userBSelect = document.getElementById('userB');
            
            // æ¸…ç©ºé€‰é¡¹
            userASelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>';
            userBSelect.innerHTML = '<option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>';
            
            // æ·»åŠ ç”¨æˆ·é€‰é¡¹
            users.forEach(user => {
                userASelect.innerHTML += `<option value="${user.socketId}">${escapeHtml(user.username)}</option>`;
                userBSelect.innerHTML += `<option value="${user.socketId}">${escapeHtml(user.username)}</option>`;
            });
            
            document.getElementById('addFriendModal').classList.add('active');
        }
        
        function closeAddFriendModal() {
            document.getElementById('addFriendModal').classList.remove('active');
        }
        
        function confirmAddFriend() {
            const userA = document.getElementById('userA').value;
            const userB = document.getElementById('userB').value;
            
            if (!userA || !userB) {
                alert('è¯·é€‰æ‹©ä¸¤ä¸ªç”¨æˆ·');
                return;
            }
            
            if (userA === userB) {
                alert('ä¸èƒ½æ·»åŠ è‡ªå·±ä¸ºå¥½å‹');
                return;
            }
            
            const userAName = users.find(u => u.socketId === userA)?.username;
            const userBName = users.find(u => u.socketId === userB)?.username;
            
            if (confirm(`ç¡®å®šè¦è®© ${userAName} å’Œ ${userBName} æˆä¸ºå¥½å‹å—ï¼Ÿ`)) {
                socket.emit('admin-add-friendship', {
                    userSocketId: userA,
                    friendSocketId: userB
                });
                closeAddFriendModal();
            }
        }
        
        function applyGlobalPermissions() {
            if (confirm('ç¡®å®šè¦å°†è¿™äº›æƒé™åº”ç”¨åˆ°æ‰€æœ‰ç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œå°†è¦†ç›–æ‰€æœ‰ç”¨æˆ·çš„ç°æœ‰æƒé™ï¼')) {
                const permissions = {
                    allowAudio: document.getElementById('globalAllowAudio').checked,
                    allowImage: document.getElementById('globalAllowImage').checked,
                    allowFile: document.getElementById('globalAllowFile').checked,
                    allowSendMessages: document.getElementById('globalAllowSendMessages').checked,
                    allowViewMessages: document.getElementById('globalAllowViewMessages').checked,
                    allowCall: document.getElementById('globalAllowCall').checked,
                    allowAddFriends: document.getElementById('globalAllowAddFriends').checked,
                    allowViewUsers: document.getElementById('globalAllowViewUsers').checked,
                    allowPrivateChat: document.getElementById('globalAllowPrivateChat').checked,
                    allowOpenFriendsPage: document.getElementById('globalAllowOpenFriendsPage').checked,
                    allowRecallMessage: document.getElementById('globalAllowRecallMessage').checked
                };
                
                socket.emit('admin-set-global-permissions', permissions);
            }
        }
        
        function applyToNewUsers() {
            const permissions = {
                allowAudio: document.getElementById('globalAllowAudio').checked,
                allowImage: document.getElementById('globalAllowImage').checked,
                allowFile: document.getElementById('globalAllowFile').checked,
                allowSendMessages: document.getElementById('globalAllowSendMessages').checked,
                allowViewMessages: document.getElementById('globalAllowViewMessages').checked,
                allowCall: document.getElementById('globalAllowCall').checked,
                allowAddFriends: document.getElementById('globalAllowAddFriends').checked,
                allowViewUsers: document.getElementById('globalAllowViewUsers').checked,
                allowPrivateChat: document.getElementById('globalAllowPrivateChat').checked,
                allowOpenFriendsPage: document.getElementById('globalAllowOpenFriendsPage').checked,
                allowRecallMessage: document.getElementById('globalAllowRecallMessage').checked
            };
            
            socket.emit('admin-set-default-permissions', permissions);
            alert('é»˜è®¤æƒé™å·²è®¾ç½®ï¼Œæ–°ç”¨æˆ·å°†ä½¿ç”¨è¿™äº›æƒé™');
        }
        
        function deleteFriendship(userSocketId, friendSocketId) {
            const usernames = originalFriendships.find(f => 
                f.userSocketId === userSocketId && f.friendSocketId === friendSocketId
            );
            if (usernames && confirm(`ç¡®å®šè¦åˆ é™¤ ${usernames.username} å’Œ ${usernames.friendUsername} çš„å¥½å‹å…³ç³»å—ï¼Ÿ`)) {
                socket.emit('admin-delete-friendship', {
                    userSocketId: userSocketId,
                    friendSocketId: friendSocketId
                });
            }
        }

        // ç¦è¨€ç®¡ç†ç›¸å…³å‡½æ•°
        function loadMutedUsers() {
            console.log('loadMutedUsers called');
            socket.emit('admin-get-muted-users');
        }

        function openMuteUserModal() {
            // åŠ è½½æ‰€æœ‰åœ¨çº¿ç”¨æˆ·åˆ°ä¸‹æ‹‰åˆ—è¡¨
            const muteUserId = document.getElementById('muteUserId');
            muteUserId.innerHTML = '<option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>';
            users.forEach(user => {
                muteUserId.innerHTML += `<option value="${user.socketId}">${escapeHtml(user.username)}</option>`;
            });
            document.getElementById('muteUserModal').classList.add('active');
        }

        function closeMuteUserModal() {
            document.getElementById('muteUserModal').classList.remove('active');
        }

        function confirmMuteUser() {
            const socketId = document.getElementById('muteUserId').value;
            const duration = parseInt(document.getElementById('muteDuration').value);
            const reason = document.getElementById('muteReason').value.trim();
            
            if (socketId && reason) {
                socket.emit('admin-mute-user', {
                    socketId: socketId,
                    duration: duration,
                    reason: reason
                });
                closeMuteUserModal();
                alert('ç”¨æˆ·å·²è¢«ç¦è¨€');
                loadMutedUsers();
            }
        }

        function unmuteUser(socketId, username) {
            if (confirm(`ç¡®å®šè¦è§£é™¤å¯¹ ${escapeHtml(username)} çš„ç¦è¨€å—ï¼Ÿ`)) {
                socket.emit('admin-unmute-user', socketId);
                loadMutedUsers();
            }
        }

        function updateMutedUsersList(mutedUsers) {
            const mutedUsersList = document.getElementById('mutedUsersList');
            
            if (mutedUsers.length === 0) {
                mutedUsersList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ”‡</div>
                        <div>æš‚æ— è¢«ç¦è¨€ç”¨æˆ·</div>
                    </div>`;
                return;
            }
            
            mutedUsersList.innerHTML = mutedUsers.map(user => {
                const endTimeText = user.endTime === -1 ? 'æ°¸ä¹…' : new Date(user.endTime).toLocaleString();
                return `
                    <div class="user-item">
                        <div class="user-info">
                            <div class="user-color" style="background: ${user.color}"></div>
                            <div>
                                <div class="user-name">${escapeHtml(user.username)}</div>
                                <small style="color: #666;">ç¦è¨€æˆªæ­¢: ${endTimeText} | åŸå› : ${escapeHtml(user.reason)}</small>
                            </div>
                        </div>
                        <div class="user-actions">
                            <button class="btn btn-success btn-sm" onclick="unmuteUser('${user.socketId}', '${escapeHtml(user.username)}')">è§£é™¤ç¦è¨€</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ç›‘å¬ç¦è¨€ç”¨æˆ·åˆ—è¡¨
        socket.on('admin-muted-users', (mutedUsers) => {
            console.log('Received admin-muted-users event:', mutedUsers);
            updateMutedUsersList(mutedUsers);
        });

        // å¥½å‹æ‰©å®¹ç”³è¯·ç›¸å…³å‡½æ•°
        function loadFriendLimitRequests() {
            socket.emit('admin-get-friend-limit-requests');
        }

        function displayFriendLimitRequests(requests) {
            const container = document.getElementById('friendLimitRequestsContainer');
            
            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <div>æš‚æ— å¥½å‹æ‰©å®¹ç”³è¯·</div>
                    </div>`;
                return;
            }

            container.innerHTML = requests.map(request => `
                <div class="request-item">
                    <div class="request-info">
                        <h4>${request.username}</h4>
                        <p class="request-reason">${request.reason}</p>
                        <div class="request-meta">
                            <span>ç”³è¯·æ—¶é—´: ${new Date(request.createdAt).toLocaleString()}</span>
                            <span>çŠ¶æ€: <span class="status-${request.status}">${request.status === 'pending' ? 'å¾…å¤„ç†' : request.status === 'approved' ? 'å·²æ‰¹å‡†' : 'å·²æ‹’ç»'}</span></span>
                        </div>
                    </div>
                    ${request.status === 'pending' ? `
                        <div class="request-actions">
                            <button class="btn btn-success" onclick="approveFriendLimitRequest(${request.id})">æ‰¹å‡†</button>
                            <button class="btn btn-danger" onclick="rejectFriendLimitRequest(${request.id})">æ‹’ç»</button>
                        </div>` : ''}
                </div>
            `).join('');
        }

        function approveFriendLimitRequest(requestId) {
            const newLimit = prompt('è¯·è¾“å…¥æ–°çš„å¥½å‹æ•°é‡ä¸Šé™ï¼ˆè¾“å…¥-1è¡¨ç¤ºæ— é™ï¼‰:', '10');
            const limit = parseInt(newLimit);
            if (newLimit !== null && !isNaN(limit)) {
                socket.emit('admin-approve-friend-limit-request', {
                    requestId: requestId,
                    newLimit: limit
                });
            }
        }

        function rejectFriendLimitRequest(requestId) {
            const reason = prompt('è¯·è¾“å…¥æ‹’ç»ç†ç”±ï¼ˆå¯é€‰ï¼‰:');
            socket.emit('admin-reject-friend-limit-request', {
                requestId: requestId,
                reason: reason
            });
        }

        // ç›‘å¬æ–°çš„å¥½å‹æ‰©å®¹ç”³è¯·
        socket.on('new-friend-limit-request', (request) => {
            loadFriendLimitRequests();
        });

        // ç›‘å¬å¥½å‹æ‰©å®¹ç”³è¯·åˆ—è¡¨
        socket.on('admin-friend-limit-requests', (requests) => {
            displayFriendLimitRequests(requests);
        });

        // ç›‘å¬å¥½å‹æ‰©å®¹ç”³è¯·çŠ¶æ€æ›´æ–°
        socket.on('admin-friend-limit-request-updated', (request) => {
            loadFriendLimitRequests();
        });

        function clearMessages() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                socket.emit('admin-clear-messages');
            }
        }

        function loadMessages() {
            const selectedRoom = roomSelect.value || 'main';
            loadRoomMessages(selectedRoom);
        }

        let currentPath = '';

        function loadFiles() {
            const url = currentPath ? `/api/files?path=${encodeURIComponent(currentPath)}` : '/api/files';
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    displayFiles(data.files);
                    updatePathBar(data.currentPath);
                })
                .catch(error => {
                    console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                    alert('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥');
                });
        }

        function updatePathBar(path) {
            currentPath = path;
            document.getElementById('currentPath').textContent = '/' + (path || '');
            document.getElementById('backButton').disabled = !path;
        }

        function goBack() {
            if (!currentPath) return;
            const pathParts = currentPath.split('/').filter(p => p);
            pathParts.pop();
            currentPath = pathParts.join('/');
            loadFiles();
        }

        function enterDirectory(dirname) {
            currentPath = currentPath ? `${currentPath}/${dirname}` : dirname;
            loadFiles();
        }

        function displayFiles(files) {
            const filesContainer = document.getElementById('filesContainer');
            
            if (files.length === 0) {
                filesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“</div>
                        <div>æš‚æ— æ–‡ä»¶</div>
                    </div>`;
                return;
            }

            filesContainer.innerHTML = files.map(file => `
                <div class="file-item">
                    <div class="file-info" onclick="${file.isDirectory ? `enterDirectory('${file.name}')` : `viewFile('${file.name}')`}" style="cursor: ${file.isDirectory ? 'pointer' : 'default'}">
                        <div class="file-icon">${file.isDirectory ? 'ğŸ“' : 'ğŸ“„'}</div>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-meta">
                                <span>${file.isDirectory ? 'ç›®å½•' : formatFileSize(file.size)}</span>
                                <span>${formatDate(file.createdAt)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="file-actions">
                        ${file.isDirectory ? 
                            `<button class="btn btn-danger" onclick="deleteFile('${file.name}')">åˆ é™¤</button>` :
                            `<button class="btn btn-primary" onclick="viewFile('${file.name}')">æŸ¥çœ‹</button>
                             <button class="btn btn-primary" onclick="editFile('${file.name}')">ç¼–è¾‘</button>
                             <button class="btn btn-danger" onclick="deleteFile('${file.name}')">åˆ é™¤</button>`
                        }
                    </div>
                </div>
            `).join('');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatDate(date) {
            const d = new Date(date);
            return d.toLocaleString('zh-CN');
        }

        function openUploadModal() {
            document.getElementById('uploadFileModal').classList.add('active');
        }

        function closeUploadModal() {
            document.getElementById('uploadFileModal').classList.remove('active');
            document.getElementById('fileInput').value = '';
        }

        function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·é€‰æ‹©æ–‡ä»¶');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            fetch('/api/files/upload', {
                method: 'POST',
                headers: {
                    'X-Filename': file.name,
                    'X-Path': currentPath
                },
                body: file
            })
            .then(response => response.json())
            .then(data => {
                alert('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
                closeUploadModal();
                loadFiles();
            })
            .catch(error => {
                console.error('ä¸Šä¼ æ–‡ä»¶å¤±è´¥:', error);
                alert('ä¸Šä¼ æ–‡ä»¶å¤±è´¥');
            });
        }

        function openCreateFileModal() {
            document.getElementById('createFileModal').classList.add('active');
        }

        function closeCreateFileModal() {
            document.getElementById('createFileModal').classList.remove('active');
            document.getElementById('createFileName').value = '';
            document.getElementById('createFileContent').value = '';
        }

        function createFile() {
            const filename = document.getElementById('createFileName').value;
            const content = document.getElementById('createFileContent').value;

            if (!filename) {
                alert('è¯·è¾“å…¥æ–‡ä»¶å');
                return;
            }

            fetch('/api/files/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ filename, content, path: currentPath })
            })
            .then(response => response.json())
            .then(data => {
                alert('æ–‡ä»¶åˆ›å»ºæˆåŠŸ');
                closeCreateFileModal();
                loadFiles();
            })
            .catch(error => {
                console.error('åˆ›å»ºæ–‡ä»¶å¤±è´¥:', error);
                alert('åˆ›å»ºæ–‡ä»¶å¤±è´¥');
            });
        }

        function openCreateDirectoryModal() {
            document.getElementById('createDirectoryModal').classList.add('active');
        }

        function closeCreateDirectoryModal() {
            document.getElementById('createDirectoryModal').classList.remove('active');
            document.getElementById('createDirectoryName').value = '';
        }

        function createDirectory() {
            const dirname = document.getElementById('createDirectoryName').value;

            if (!dirname) {
                alert('è¯·è¾“å…¥ç›®å½•å');
                return;
            }

            fetch('/api/files/create-directory', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ dirname, path: currentPath })
            })
            .then(response => response.json())
            .then(data => {
                alert('ç›®å½•åˆ›å»ºæˆåŠŸ');
                closeCreateDirectoryModal();
                loadFiles();
            })
            .catch(error => {
                console.error('åˆ›å»ºç›®å½•å¤±è´¥:', error);
                alert('åˆ›å»ºç›®å½•å¤±è´¥');
            });
        }

        function editFile(filename) {
            const fullPath = currentPath ? `${currentPath}/${filename}` : filename;
            fetch(`/api/files/${encodeURIComponent(fullPath)}/content`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('editFileName').value = filename;
                    document.getElementById('editFileContent').value = data.content;
                    document.getElementById('editFileModal').classList.add('active');
                })
                .catch(error => {
                    console.error('è·å–æ–‡ä»¶å†…å®¹å¤±è´¥:', error);
                    alert('è·å–æ–‡ä»¶å†…å®¹å¤±è´¥');
                });
        }

        function closeEditFileModal() {
            document.getElementById('editFileModal').classList.remove('active');
            document.getElementById('editFileName').value = '';
            document.getElementById('editFileContent').value = '';
        }

        function saveFileEdit() {
            const filename = document.getElementById('editFileName').value;
            const content = document.getElementById('editFileContent').value;
            const fullPath = currentPath ? `${currentPath}/${filename}` : filename;

            fetch(`/api/files/${encodeURIComponent(fullPath)}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content })
            })
            .then(response => response.json())
            .then(data => {
                alert('æ–‡ä»¶ä¿å­˜æˆåŠŸ');
                closeEditFileModal();
                loadFiles();
            })
            .catch(error => {
                console.error('ä¿å­˜æ–‡ä»¶å¤±è´¥:', error);
                alert('ä¿å­˜æ–‡ä»¶å¤±è´¥');
            });
        }

        function viewFile(filename) {
            const fullPath = currentPath ? `${currentPath}/${filename}` : filename;
            window.open(`/uploads/${fullPath}`, '_blank');
        }

        function deleteFile(filename) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤ "${filename}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                const fullPath = currentPath ? `${currentPath}/${filename}` : filename;
                fetch(`/api/files/${encodeURIComponent(fullPath)}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    alert('æ–‡ä»¶åˆ é™¤æˆåŠŸ');
                    loadFiles();
                })
                .catch(error => {
                    console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
                    alert('åˆ é™¤æ–‡ä»¶å¤±è´¥');
                });
            }
        }
        
        function loadRoomMessages(roomName) {
            socket.emit('admin-get-room-messages', roomName);
        }
        
        function changeAdminPassword() {
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            
            if (!oldPassword || !newPassword) {
                alert('è¯·è¾“å…¥æ—§å¯†ç å’Œæ–°å¯†ç ');
                return;
            }
            
            if (oldPassword === newPassword) {
                alert('æ–°å¯†ç ä¸èƒ½ä¸æ—§å¯†ç ç›¸åŒ');
                return;
            }
            
            socket.emit('admin-change-password', {
                oldPassword: oldPassword,
                newPassword: newPassword
            });
        }
        
        // ç³»ç»Ÿç®¡ç†å‡½æ•°
        function getServerInfo() {
            socket.emit('admin-get-server-info');
        }
        
        // æ·»åŠ æ¯ç§’è‡ªåŠ¨åˆ·æ–°æœåŠ¡å™¨ä¿¡æ¯çš„å®šæ—¶å™¨
        let serverInfoInterval;
        
        // å½“åˆ‡æ¢åˆ°ç³»ç»Ÿç®¡ç†æ ‡ç­¾é¡µæ—¶ï¼Œå¯åŠ¨è‡ªåŠ¨åˆ·æ–°
        function startServerInfoRefresh() {
            if (!serverInfoInterval) {
                serverInfoInterval = setInterval(getServerInfo, 1000);
                console.log('å¼€å§‹æ¯ç§’è‡ªåŠ¨åˆ·æ–°æœåŠ¡å™¨ä¿¡æ¯');
            }
        }
        
        // å½“ç¦»å¼€ç³»ç»Ÿç®¡ç†æ ‡ç­¾é¡µæ—¶ï¼Œåœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopServerInfoRefresh() {
            if (serverInfoInterval) {
                clearInterval(serverInfoInterval);
                serverInfoInterval = null;
                console.log('åœæ­¢è‡ªåŠ¨åˆ·æ–°æœåŠ¡å™¨ä¿¡æ¯');
            }
        }
        
        function shutdownServer() {
            if (confirm('ç¡®å®šè¦å…³é—­æœåŠ¡å™¨å—ï¼Ÿæ­¤æ“ä½œå°†æ–­å¼€æ‰€æœ‰ç”¨æˆ·çš„è¿æ¥ï¼')) {
                socket.emit('admin-shutdown-server');
                alert('æœåŠ¡å™¨æ­£åœ¨å…³é—­...');
            }
        }
        
        function executeCommand() {
            const command = document.getElementById('commandInput').value.trim();
            if (!command) {
                alert('è¯·è¾“å…¥è¦æ‰§è¡Œçš„å‘½ä»¤');
                return;
            }
            
            const outputDiv = document.getElementById('commandOutput');
            outputDiv.textContent = 'æ­£åœ¨æ‰§è¡Œå‘½ä»¤...\n';
            
            socket.emit('admin-exec-command', { command: command });
        }
        
        // å¤„ç†æœåŠ¡å™¨ä¿¡æ¯å“åº”
        socket.on('admin-server-info', (data) => {
            const infoDiv = document.getElementById('serverInfo');
            const uptime = Math.floor(data.uptime);
            const hours = Math.floor(uptime / 3600);
            const minutes = Math.floor((uptime % 3600) / 60);
            const seconds = uptime % 60;
            const memoryMB = (data.memoryUsage.heapUsed / 1024 / 1024).toFixed(2);
            const memoryTotalMB = (data.memoryUsage.heapTotal / 1024 / 1024).toFixed(2);
            
            infoDiv.innerHTML = `
                <p><strong>Node.jsç‰ˆæœ¬:</strong> ${data.nodeVersion}</p>
                <p><strong>æ“ä½œç³»ç»Ÿ:</strong> ${data.platform} (${data.arch})</p>
                <p><strong>è¿›ç¨‹ID:</strong> ${data.pid}</p>
                <p><strong>è¿è¡Œæ—¶é—´:</strong> ${hours}å°æ—¶${minutes}åˆ†${seconds}ç§’</p>
                <p><strong>å†…å­˜ä½¿ç”¨:</strong> ${memoryMB} MB / ${memoryTotalMB} MB</p>
                <p><strong>å·¥ä½œç›®å½•:</strong> ${data.cwd}</p>
                <p><strong>æœåŠ¡å™¨çŠ¶æ€:</strong> ${data.isRunning ? '<span style="color: green;">è¿è¡Œä¸­</span>' : '<span style="color: red;">å·²åœæ­¢</span>'}</p>
            `;
        });
        
        // å¤„ç†å‘½ä»¤æ‰§è¡Œç»“æœ
        socket.on('admin-command-result', (data) => {
            const outputDiv = document.getElementById('commandOutput');
            if (data.success) {
                outputDiv.textContent = data.output || 'å‘½ä»¤æ‰§è¡ŒæˆåŠŸï¼ˆæ— è¾“å‡ºï¼‰';
            } else {
                outputDiv.textContent = 'é”™è¯¯: ' + data.error;
            }
        });
        
        // å¤„ç†æœåŠ¡å™¨å…³é—­é€šçŸ¥
        socket.on('server-shutting-down', (data) => {
            alert(data.message);
        });
        
        function displayMessages(data, isRoomMessages = false) {
            messageCount.textContent = data.active.length;
            deletedMessageCount.textContent = data.deleted.length;
            
            const allMessages = [...data.active.map(m => ({ ...m, status: 'active' })), ...data.deleted.map(m => ({ ...m, status: 'deleted' }))];
            
            if (allMessages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ’¬</div>
                        <div>${isRoomMessages ? 'è¯¥æˆ¿é—´æš‚æ— æ¶ˆæ¯' : 'æš‚æ— æ¶ˆæ¯'}</div>
                    </div>`;
                return;
            }

            messagesContainer.innerHTML = allMessages.map(msg => {
                let contentHtml = '';
                if (msg.type === 'image') {
                    contentHtml = `<img src="${msg.message}" alt="å›¾ç‰‡">`;
                } else if (msg.type === 'audio') {
                    contentHtml = `<audio controls><source src="${msg.message}" type="audio/webm">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾</audio>`;
                } else {
                    contentHtml = escapeHtml(msg.message);
                }

                const statusText = msg.status === 'active' ? 'æ­£å¸¸' : 'å·²æ’¤å›';
                const statusClass = msg.status === 'active' ? 'active' : 'deleted';
                const recallTime = msg.recallTime ? `<br><small>æ’¤å›æ—¶é—´: ${msg.recallTime}</small>` : '';

                return `
                    <div class="message-item ${msg.status}">
                        <div class="message-header">
                            <div>
                                <span class="message-sender" style="color: ${msg.color}">${escapeHtml(msg.username)}</span>
                                <span class="message-status ${statusClass}">${statusText}</span>
                            </div>
                            <span class="message-time">${msg.timestamp}${recallTime}</span>
                        </div>
                        <div class="message-content">${contentHtml}</div>
                    </div>
                `;
            }).join('');
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(date) {
            const d = new Date(date);
            return d.toLocaleString('zh-CN');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // è¿‡æ»¤ç”¨æˆ·åˆ—è¡¨
        function filterUsers() {
            const searchTerm = userSearch.value.toLowerCase().trim();
            
            if (!searchTerm) {
                // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·
                users = [...originalUsers];
                updateUserList();
                return;
            }
            
            // æ ¹æ®ç”¨æˆ·åæˆ–æˆ¿é—´åè¿‡æ»¤ç”¨æˆ·
            users = originalUsers.filter(user => {
                const username = user.username.toLowerCase();
                const roomName = (user.roomName || 'main').toLowerCase();
                
                return username.includes(searchTerm) || roomName.includes(searchTerm);
            });
            
            updateUserList();
        }
        
        // åˆ‡æ¢ç”¨æˆ·åˆ—è¡¨æ˜¾ç¤º/éšè—
        function toggleUserList() {
            const userListElement = document.getElementById('userList');
            if (userListElement.style.display === 'none') {
                userListElement.style.display = 'block';
            } else {
                userListElement.style.display = 'none';
            }
        }
        
        // è¿‡æ»¤æˆ¿é—´åˆ—è¡¨
        function filterRooms() {
            const searchTerm = roomSearch.value.toLowerCase().trim();
            
            if (!searchTerm) {
                // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ˜¾ç¤ºæ‰€æœ‰æˆ¿é—´
                updateRoomList(originalRooms);
                return;
            }
            
            // æ ¹æ®æˆ¿é—´åè¿‡æ»¤æˆ¿é—´
            const filteredRooms = originalRooms.filter(room => {
                return room.roomName.toLowerCase().includes(searchTerm);
            });
            
            updateRoomList(filteredRooms);
        }
        
        // ç”¨æˆ·è®¾ç½®ç®¡ç†ç›¸å…³å‡½æ•°
        let selectedUserIdForSettings = null;
        
        function loadUsersForSettings() {
            socket.emit('admin-get-users');
        }
        
        // ç›‘å¬ç”¨æˆ·åˆ—è¡¨æ›´æ–°
        socket.on('user-joined', (data) => {
            updateSettingsUsersList(data.users);
        });
        
        function updateSettingsUsersList(users) {
            const usersList = document.getElementById('settingsUsersList');
            
            if (users.length === 0) {
                usersList.innerHTML = '<div class="empty-state"><div>æš‚æ— ç”¨æˆ·æ•°æ®</div></div>';
                return;
            }
            
            usersList.innerHTML = users.map(user => `
                <div class="user-item" onclick="openUserSettingsForm('${user.socketId}', '${escapeHtml(user.username)}')">
                    <div class="user-info">
                        <div class="username">${escapeHtml(user.username)}</div>
                        <div class="socket-id">${user.socketId}</div>
                        <div class="room-name">æˆ¿é—´: ${user.roomName || 'main'}</div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); openUserSettingsForm('${user.socketId}', '${escapeHtml(user.username)}')">è®¾ç½®</button>
                    </div>
                </div>
            `).join('');
        }
        
        function openUserSettingsForm(socketId, username) {
            selectedUserIdForSettings = socketId;
            document.getElementById('selectedUsername').textContent = username;
            
            // åŠ è½½ç”¨æˆ·å½“å‰è®¾ç½®
            socket.emit('admin-get-user-settings', socketId);
            
            document.getElementById('userSettingsForm').style.display = 'block';
        }
        
        function closeUserSettingsForm() {
            document.getElementById('userSettingsForm').style.display = 'none';
            selectedUserIdForSettings = null;
        }
        
        function saveUserSettings() {
            if (!selectedUserIdForSettings) return;
            
            const lockUserSettings = document.getElementById('lockUserSettings').checked;
            const customLockMessage = document.getElementById('customLockMessage').value.trim() || 'è®¾ç½®å·²è¢«ç®¡ç†å‘˜é”å®š';
            
            // è·å–ç”¨æˆ·å…·ä½“è®¾ç½®å€¼
            const userSettings = {
                targetLanguage: document.getElementById('userTargetLanguage').value,
                autoTranslate: document.getElementById('userAutoTranslate').checked,
                soundNotification: document.getElementById('userSoundNotification').checked,
                mentionNotification: document.getElementById('userMentionNotification').checked
            };
            
            socket.emit('admin-set-user-settings', {
                socketId: selectedUserIdForSettings,
                settings: {
                    locked: lockUserSettings,
                    lockMessage: customLockMessage
                },
                userSettings: userSettings
            });
            
            closeUserSettingsForm();
        }
        
        // ç›‘å¬ç”¨æˆ·è®¾ç½®å“åº”
        socket.on('admin-user-settings', (data) => {
            document.getElementById('lockUserSettings').checked = data.settings.locked || false;
            document.getElementById('customLockMessage').value = data.settings.lockMessage || 'è®¾ç½®å·²è¢«ç®¡ç†å‘˜é”å®š';
            
            // è®¾ç½®ç”¨æˆ·å…·ä½“è®¾ç½®å€¼
            document.getElementById('userTargetLanguage').value = data.userSettings?.targetLanguage || 'zh';
            document.getElementById('userAutoTranslate').checked = data.userSettings?.autoTranslate || false;
            document.getElementById('userSoundNotification').checked = data.userSettings?.soundNotification !== false;
            document.getElementById('userMentionNotification').checked = data.userSettings?.mentionNotification !== false;
        });
        
        // ç”¨æˆ·è®¾ç½®ç®¡ç†ç›¸å…³å‡½æ•° - æ‰©å±•è·å–ç”¨æˆ·è®¾ç½®ï¼ŒåŒ…å«å…·ä½“è®¾ç½®å€¼
        function openUserSettingsForm(socketId, username) {
            selectedUserIdForSettings = socketId;
            document.getElementById('selectedUsername').textContent = username;
            
            // åŠ è½½ç”¨æˆ·å½“å‰è®¾ç½®ï¼ŒåŒ…å«å…·ä½“è®¾ç½®å€¼
            socket.emit('admin-get-user-settings', socketId);
            
            document.getElementById('userSettingsForm').style.display = 'block';
        }
        
        // é€šè¯ç®¡ç†åŠŸèƒ½
        let currentCallId = null;
        
        // åŠ è½½æ­£åœ¨è¿›è¡Œçš„é€šè¯åˆ—è¡¨
        async function loadOngoingCalls() {
            try {
                const response = await fetch('/api/admin/calls');
                const data = await response.json();
                
                const callsList = document.getElementById('ongoingCallsList');
                
                if (data.calls.length === 0) {
                    callsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“</div>
                            <div>æš‚æ— æ­£åœ¨è¿›è¡Œçš„é€šè¯</div>
                        </div>`;
                    return;
                }
                
                callsList.innerHTML = data.calls.map(call => {
                    const startTime = new Date(call.startTime).toLocaleString('zh-CN');
                    return `
                        <div class="user-item">
                            <div class="user-info">
                                <div class="user-name">${escapeHtml(call.initiatorUsername)} â†’ ${escapeHtml(call.recipientUsername)}</div>
                                <small style="color: #666;">${call.callType}é€šè¯ | å¼€å§‹äº: ${startTime} | é€šè¯ID: ${call.callId}</small>
                            </div>
                            <div class="user-actions">
                                <button class="btn btn-info" onclick="viewCallDetails('${call.callId}')">æŸ¥çœ‹è¯¦æƒ…</button>
                                <button class="btn btn-danger" onclick="endCall('${call.callId}')">ç»“æŸé€šè¯</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('åŠ è½½é€šè¯åˆ—è¡¨å¤±è´¥:', error);
                alert('åŠ è½½é€šè¯åˆ—è¡¨å¤±è´¥');
            }
        }
        
        // æŸ¥çœ‹é€šè¯è¯¦æƒ…
        async function viewCallDetails(callId) {
            try {
                const response = await fetch(`/api/admin/calls/${callId}`);
                const data = await response.json();
                
                currentCallId = callId;
                const call = data.call;
                const startTime = new Date(call.startTime).toLocaleString('zh-CN');
                
                // æ›´æ–°é€šè¯ç›‘æ§ä¿¡æ¯
                updateCallMonitoring(callId, call);
                
                // æ˜¾ç¤ºé€šè¯æ–¹å¼
                const callMethodDisplay = document.getElementById('callMethodDisplay');
                const videoModeNote = document.getElementById('videoModeNote');
                if (call.callMethod === 'socket.io') {
                    callMethodDisplay.innerHTML = `ã€Socket.ioæ¨¡å¼ - æ”¯æŒç®¡ç†å‘˜ç›‘æ§ã€‘`;
                    videoModeNote.innerHTML = 'Socket.ioæ¨¡å¼ï¼šæ•°æ®ç»è¿‡æœåŠ¡å™¨è½¬å‘ï¼Œç®¡ç†å‘˜å¯ä»¥å®æ—¶ç›‘æ§é€šè¯ç”»é¢ã€‚';
                    videoModeNote.style.color = '#28a745';
                } else {
                    callMethodDisplay.innerHTML = `ã€WebRTCæ¨¡å¼ - ç‚¹å¯¹ç‚¹é€šä¿¡ã€‘`;
                    videoModeNote.innerHTML = 'WebRTCä¸ºç‚¹å¯¹ç‚¹é€šè¯ï¼Œæ•°æ®ä¸ç»è¿‡æœåŠ¡å™¨ï¼Œç®¡ç†å‘˜æ— æ³•æŸ¥çœ‹ç”»é¢ã€‚è¯·ä½¿ç”¨Socket.ioæ¨¡å¼è¿›è¡Œå¯ç›‘æ§çš„é€šè¯ã€‚';
                    videoModeNote.style.color = '#dc3545';
                }
                
                const callDetailsInfo = document.getElementById('callDetailsInfo');
                callDetailsInfo.innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <strong>é€šè¯ID:</strong> ${call.callId}
                        </div>
                        <div>
                            <strong>é€šè¯ç±»å‹:</strong> ${call.callType}
                        </div>
                        <div>
                            <strong>é€šè¯æ–¹å¼:</strong> ${call.callMethod === 'socket.io' ? 'Socket.io' : 'WebRTC'}
                        </div>
                        <div>
                            <strong>å‘èµ·æ–¹:</strong> ${escapeHtml(call.initiatorUsername)}
                        </div>
                        <div>
                            <strong>æ¥æ”¶æ–¹:</strong> ${escapeHtml(call.recipientUsername)}
                        </div>
                        <div>
                            <strong>å¼€å§‹æ—¶é—´:</strong> ${startTime}
                        </div>
                        <div>
                            <strong>çŠ¶æ€:</strong> ${call.status}
                        </div>
                        <div>
                            <strong>è§†é¢‘æ§åˆ¶:</strong> ${call.controls.videoEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
                        </div>
                        <div>
                            <strong>éŸ³é¢‘æ§åˆ¶:</strong> ${call.controls.audioEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <h4>é€šè¯åŒæ–¹</h4>
                        <div style="display: flex; gap: 20px;">
                            <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                                <strong>å‘èµ·æ–¹:</strong> ${escapeHtml(call.initiatorUsername)}
                                <br>
                                <small>Socket ID: ${call.initiator}</small>
                            </div>
                            <div style="flex: 1; background: #f8f9fa; padding: 15px; border-radius: 10px;">
                                <strong>æ¥æ”¶æ–¹:</strong> ${escapeHtml(call.recipientUsername)}
                                <br>
                                <small>Socket ID: ${call.recipient}</small>
                            </div>
                        </div>
                    </div>
                `;
                
                // é‡ç½®è§†é¢‘å…ƒç´ å’ŒçŠ¶æ€
                resetVideoDisplay('initiator');
                resetVideoDisplay('recipient');
                
                document.getElementById('callDetailsModal').classList.add('active');
            } catch (error) {
                console.error('è·å–é€šè¯è¯¦æƒ…å¤±è´¥:', error);
                alert('è·å–é€šè¯è¯¦æƒ…å¤±è´¥');
            }
        }
        
        // é‡ç½®è§†é¢‘æ˜¾ç¤º
        function resetVideoDisplay(side) {
            const video = document.getElementById(`${side}Video`);
            const container = document.getElementById(`${side}VideoContainer`);
            const status = document.getElementById(`${side}VideoStatus`);
            
            if (video) {
                video.style.display = 'none';
                video.src = '';
            }
            if (container) {
                container.style.display = 'flex';
            }
            if (status) {
                status.textContent = 'ç­‰å¾…é€šè¯æ•°æ®...';
            }
            
            // æ¸…ç†MediaSource
            const socketId = side === 'initiator' ? monitoredCalls.get(currentCallId)?.initiator : monitoredCalls.get(currentCallId)?.recipient;
            if (socketId && mediaSourceMap.has(socketId)) {
                try {
                    const msData = mediaSourceMap.get(socketId);
                    if (msData && msData.mediaSource.readyState === 'open') {
                        msData.sourceBuffer.remove(0, Infinity);
                    }
                    mediaSourceMap.delete(socketId);
                } catch (e) {
                    console.error('æ¸…ç†MediaSourceå¤±è´¥:', e);
                }
            }
        }
        
        // å…³é—­é€šè¯è¯¦æƒ…æ¨¡æ€æ¡†
        function closeCallDetailsModal() {
            document.getElementById('callDetailsModal').classList.remove('active');
            
            // æ¸…ç†é€šè¯ç›‘æ§èµ„æº
            if (currentCallId) {
                // æ¸…ç†MediaSourceèµ„æº
                const callInfo = monitoredCalls.get(currentCallId);
                if (callInfo) {
                    [callInfo.initiator, callInfo.recipient].forEach(socketId => {
                        if (mediaSourceMap.has(socketId)) {
                            try {
                                const msData = mediaSourceMap.get(socketId);
                                if (msData) {
                                    const { mediaSource, sourceBuffer } = msData;
                                    if (mediaSource.readyState === 'open') {
                                        try {
                                            sourceBuffer.remove(0, Infinity);
                                        } catch (e) {}
                                    }
                                    mediaSource.removeEventListener('sourceopen', null);
                                }
                            } catch (e) {
                                console.error('æ¸…ç†MediaSourceå¤±è´¥:', e);
                            }
                            mediaSourceMap.delete(socketId);
                        }
                    });
                }
                
                monitoredCalls.delete(currentCallId);
                
                // åœæ­¢å¹¶æ¸…ç†åª’ä½“æµ
                ['initiator', 'recipient'].forEach(side => {
                    const video = document.getElementById(`${side}Video`);
                    const container = document.getElementById(`${side}VideoContainer`);
                    
                    if (video) {
                        video.pause();
                        video.src = '';
                        video.load();
                    }
                    if (container) {
                        container.style.display = 'flex';
                    }
                });
            }
            
            currentCallId = null;
        }
        
        // å¤„ç†é€šè¯åª’ä½“æµ
        function handleCallMedia(data) {
            const callId = data.callId;
            const fromSocketId = data.from;
            
            // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ç›‘æ§è¯¥é€šè¯
            const callInfo = monitoredCalls.get(callId);
            if (!callInfo) return;
            
            // æ ¹æ®å‘é€è€…ç¡®å®šæ˜¾ç¤ºä½ç½®
            let side = null;
            if (fromSocketId === callInfo.initiator) {
                side = 'initiator';
            } else if (fromSocketId === callInfo.recipient) {
                side = 'recipient';
            } else {
                return;
            }
            
            const video = document.getElementById(`${side}Video`);
            const container = document.getElementById(`${side}VideoContainer`);
            const status = document.getElementById(`${side}VideoStatus`);
            
            if (!video || !container || !status) return;
            
            try {
                // æ£€æŸ¥æ˜¯å¦æ”¯æŒMediaSource
                if (MediaSource && MediaSource.isTypeSupported('video/webm')) {
                    // ä½¿ç”¨MediaSourceæ–¹å¼
                    if (!mediaSourceMap.has(fromSocketId)) {
                        // åˆ›å»ºæ–°çš„MediaSource
                        const mediaSource = new MediaSource();
                        video.src = URL.createObjectURL(mediaSource);
                        video.style.display = 'block';
                        container.style.display = 'none';
                        status.textContent = 'æ­£åœ¨åŠ è½½è§†é¢‘...';
                        
                        mediaSource.addEventListener('sourceopen', () => {
                            try {
                                const sourceBuffer = mediaSource.addSourceBuffer('video/webm');
                                sourceBuffer.mode = 'segments';
                                sourceBuffer.addEventListener('updateend', () => {
                                    if (mediaSource.readyState === 'open' && !sourceBuffer.updating) {
                                        // å¯ä»¥ç»§ç»­æ·»åŠ æ›´å¤šæ•°æ®
                                    }
                                });
                                mediaSourceMap.set(fromSocketId, {
                                    mediaSource: mediaSource,
                                    sourceBuffer: sourceBuffer,
                                    video: video
                                });
                                status.textContent = 'æ­£åœ¨æ’­æ”¾è§†é¢‘...';
                            } catch (e) {
                                console.error('åˆ›å»ºSourceBufferå¤±è´¥:', e);
                                status.textContent = 'è§†é¢‘åŠ è½½å¤±è´¥';
                            }
                        });
                    }
                    
                    // æ·»åŠ æ•°æ®åˆ°SourceBuffer
                    const msData = mediaSourceMap.get(fromSocketId);
                    if (msData && msData.sourceBuffer && !msData.sourceBuffer.updating && msData.mediaSource.readyState === 'open') {
                        const chunk = new Uint8Array(data.data);
                        try {
                            msData.sourceBuffer.appendBuffer(chunk);
                            video.style.display = 'block';
                            container.style.display = 'none';
                            status.textContent = 'æ­£åœ¨æ’­æ”¾è§†é¢‘...';
                        } catch (e) {
                            console.error('æ·»åŠ è§†é¢‘æ•°æ®å¤±è´¥:', e);
                        }
                    }
                } else {
                    // å›é€€åˆ°Blobæ–¹å¼ï¼Œä½†ä½¿ç”¨æ›´å¤§çš„ç¼“å†²åŒº
                    if (video.src) {
                        // å¦‚æœå·²æœ‰srcï¼Œä½¿ç”¨ç°æœ‰URL
                    }
                    
                    // å°†æ•°æ®è½¬æ¢ä¸ºBlob
                    const blob = new Blob([data.data], { type: 'video/webm' });
                    
                    // åˆ›å»ºObject URL
                    const url = URL.createObjectURL(blob);
                    video.src = url;
                    video.style.display = 'block';
                    container.style.display = 'none';
                    status.textContent = 'æ­£åœ¨æ’­æ”¾è§†é¢‘...';
                    
                    // å°è¯•æ’­æ”¾
                    video.play().catch(err => {
                        console.log(`${side}è§†é¢‘è‡ªåŠ¨æ’­æ”¾å¤±è´¥:`, err.message);
                    });
                }
            } catch (error) {
                console.error('å¤„ç†é€šè¯åª’ä½“æµå¤±è´¥:', error);
                status.textContent = 'è§†é¢‘å¤„ç†å¤±è´¥';
            }
        }
        
        // æ›´æ–°é€šè¯ç›‘æ§ä¿¡æ¯
        function updateCallMonitoring(callId, callInfo) {
            monitoredCalls.set(callId, {
                initiator: callInfo.initiator,
                recipient: callInfo.recipient
            });
        }
        
        // ç»“æŸé€šè¯
        async function endCall(callId) {
            const id = callId || currentCallId;
            if (!id) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªé€šè¯');
                return;
            }
            
            if (confirm('ç¡®å®šè¦ç»“æŸè¿™ä¸ªé€šè¯å—ï¼Ÿ')) {
                try {
                    const response = await fetch(`/api/admin/calls/${id}/end`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('é€šè¯å·²ç»“æŸ');
                        loadOngoingCalls();
                        closeCallDetailsModal();
                    } else {
                        alert('ç»“æŸé€šè¯å¤±è´¥: ' + data.error);
                    }
                } catch (error) {
                    console.error('ç»“æŸé€šè¯å¤±è´¥:', error);
                    alert('ç»“æŸé€šè¯å¤±è´¥');
                }
            }
        }
        
        // åˆ‡æ¢é€šè¯æ§åˆ¶
        async function toggleCallControl(type) {
            if (!currentCallId) {
                alert('è¯·é€‰æ‹©ä¸€ä¸ªé€šè¯');
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/calls/${currentCallId}/control`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        type: type,
                        enabled: false // åˆ‡æ¢ä¸ºç¦ç”¨ï¼Œç®¡ç†å‘˜å¯ä»¥éšæ—¶åˆ‡æ¢
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    alert(`å·²åˆ‡æ¢${type}æ§åˆ¶`);
                    viewCallDetails(currentCallId); // åˆ·æ–°é€šè¯è¯¦æƒ…
                } else {
                    alert('åˆ‡æ¢æ§åˆ¶å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                console.error('åˆ‡æ¢é€šè¯æ§åˆ¶å¤±è´¥:', error);
                alert('åˆ‡æ¢é€šè¯æ§åˆ¶å¤±è´¥');
            }
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…é™¤å®šæ—¶å™¨
        window.addEventListener('beforeunload', () => {
            if (userRefreshInterval) {
                clearInterval(userRefreshInterval);
            }
            if (roomDetailsRefreshInterval) {
                clearInterval(roomDetailsRefreshInterval);
            }
        });
    </script>
</body>
</html>
