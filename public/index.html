<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©å®¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 90%;
            max-width: 800px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .online-count {
            font-size: 14px;
            opacity: 0.9;
        }

        .chat-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 15px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .username {
            font-weight: bold;
            margin-right: 10px;
        }

        .timestamp {
            font-size: 12px;
            color: #999;
        }

        .message-content {
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
        }



        .message-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 5px;
        }

        .recall-btn {
            background: none;
            border: none;
            color: #667eea;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .recall-btn:hover {
            opacity: 1;
        }

        .system-message {
            text-align: center;
            color: #666;
            font-style: italic;
            margin: 10px 0;
            padding: 5px;
            background: #e9ecef;
            border-radius: 5px;
        }

        .system-message.admin {
            background: #fff3cd;
            color: #856404;
            font-weight: bold;
        }

        .users-panel {
            width: 200px;
            background: #f1f3f5;
            padding: 15px;
            border-left: 1px solid #dee2e6;
            overflow-y: auto;
        }

        .users-panel h3 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #495057;
        }

        .user-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .user-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .user-name {
            font-size: 14px;
            color: #495057;
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #dee2e6;
        }

        #usernameInput {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        #usernameInput:focus {
            border-color: #667eea;
        }

        #joinBtn {
            width: 100%;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }

        #joinBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        #chatForm {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #messageInput {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        #messageInput:focus {
            border-color: #667eea;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            background: #f8f9fa;
            color: #667eea;
        }

        .action-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .action-btn.recording {
            background: #dc3545;
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        #sendBtn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #sendBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .hidden {
            display: none !important;
        }



        @media (max-width: 768px) {
            .container {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }

            .users-panel {
                display: none;
            }

            .chat-container {
                flex-direction: column;
            }

            .messages {
                padding: 15px;
                width: 100%;
            }

            .action-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            #chatForm {
                flex-wrap: wrap;
            }

            #messageInput {
                flex-basis: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>èŠå¤©å®¤</h1>
            <div class="online-count">åœ¨çº¿äººæ•°: <span id="userCount">0</span></div>
        </div>

        <div class="chat-container">
            <div class="messages" id="messages">
                <div class="system-message">æ¬¢è¿æ¥åˆ°èŠå¤©å®¤ï¼è¯·è¾“å…¥æ˜µç§°åŠ å…¥ã€‚</div>
            </div>
            <div class="users-panel">
                <h3>åœ¨çº¿ç”¨æˆ·</h3>
                <div id="usersList"></div>
            </div>
        </div>

        <div class="input-area">
            <div id="loginForm">
                <input type="text" id="usernameInput" placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°" maxlength="20">
                <button id="joinBtn">åŠ å…¥èŠå¤©</button>
            </div>
            <div id="chatForm" class="hidden">
                <input type="file" id="imageInput" accept="image/*">
                <div class="action-buttons">
                    <button class="action-btn" id="imageBtn" title="å‘é€å›¾ç‰‡">ğŸ“·</button>
                    <button class="action-btn" id="audioBtn" title="å‘é€è¯­éŸ³">ğŸ¤</button>
                </div>
                <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="500">
                <button id="sendBtn">å‘é€</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let username = '';
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let userPermissions = {
            allowAudio: true,
            allowImage: true,
            allowFile: true,
            allowSendMessages: true,
            allowViewMessages: true,
            allowCall: true
        };

        const messagesDiv = document.getElementById('messages');
        const usersListDiv = document.getElementById('usersList');
        const userCountSpan = document.getElementById('userCount');
        const usernameInput = document.getElementById('usernameInput');
        const messageInput = document.getElementById('messageInput');
        const joinBtn = document.getElementById('joinBtn');
        const sendBtn = document.getElementById('sendBtn');
        const loginForm = document.getElementById('loginForm');
        const chatForm = document.getElementById('chatForm');
        const imageInput = document.getElementById('imageInput');
        const imageBtn = document.getElementById('imageBtn');
        const audioBtn = document.getElementById('audioBtn');

        joinBtn.addEventListener('click', () => {
            username = usernameInput.value.trim();
            if (username) {
                socket.emit('join', username);
                loginForm.classList.add('hidden');
                chatForm.classList.remove('hidden');
                messageInput.focus();
            }
        });

        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                joinBtn.click();
            }
        });

        sendBtn.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (message) {
                if (!userPermissions.allowSendMessages) {
                    alert('æ‚¨æ²¡æœ‰å‘é€æ¶ˆæ¯çš„æƒé™');
                    return;
                }
                socket.emit('message', { message, type: 'text' });
                messageInput.value = '';
            }
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });

        imageBtn.addEventListener('click', () => {
            if (userPermissions.allowImage) {
                imageInput.click();
            } else {
                alert('æ‚¨æ²¡æœ‰å‘é€å›¾ç‰‡çš„æƒé™');
            }
        });

        imageInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                if (!userPermissions.allowImage) {
                    alert('æ‚¨æ²¡æœ‰å‘é€å›¾ç‰‡çš„æƒé™');
                    imageInput.value = '';
                    return;
                }
                try {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const arrayBuffer = event.target.result;
                        const response = await fetch('/upload-image', {
                            method: 'POST',
                            body: arrayBuffer,
                            headers: {
                                'Content-Type': file.type
                            }
                        });
                        const data = await response.json();
                        
                        if (data.imageUrl) {
                            socket.emit('message', { message: data.imageUrl, type: 'image' });
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } catch (error) {
                    console.error('ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', error);
                    alert('ä¸Šä¼ å›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
                
                imageInput.value = '';
            }
        });

        audioBtn.addEventListener('click', async () => {
            if (!userPermissions.allowAudio) {
                alert('æ‚¨æ²¡æœ‰å‘é€è¯­éŸ³çš„æƒé™');
                return;
            }
            
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        
                        try {
                            const arrayBuffer = await audioBlob.arrayBuffer();
                            const response = await fetch('/upload-audio', {
                                method: 'POST',
                                body: arrayBuffer,
                                headers: {
                                    'Content-Type': 'audio/webm'
                                }
                            });
                            const data = await response.json();
                            
                            if (data.audioUrl) {
                                socket.emit('message', { message: data.audioUrl, type: 'audio' });
                            }
                        } catch (error) {
                            console.error('ä¸Šä¼ è¯­éŸ³å¤±è´¥:', error);
                            alert('ä¸Šä¼ è¯­éŸ³å¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                        
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    audioBtn.classList.add('recording');
                    audioBtn.title = 'åœæ­¢å½•åˆ¶';
                } catch (error) {
                    console.error('æ— æ³•è®¿é—®éº¦å…‹é£:', error);
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                audioBtn.classList.remove('recording');
                audioBtn.title = 'å‘é€è¯­éŸ³';
            }
        });

        socket.on('user-joined', (data) => {
            addSystemMessage(`${data.username} åŠ å…¥äº†èŠå¤©å®¤`);
            updateUserList(data.users);
            userCountSpan.textContent = data.userCount;
            
            // æ›´æ–°å½“å‰ç”¨æˆ·çš„æƒé™
            if (data.username === username) {
                const currentUser = data.users.find(u => u.username === username);
                if (currentUser) {
                    userPermissions = currentUser.permissions;
                }
            }
        });
        
        socket.on('user-permissions-changed', (data) => {
            // æ›´æ–°å½“å‰ç”¨æˆ·çš„æƒé™
            const currentUser = data.users.find(u => u.socketId === socket.id);
            if (currentUser) {
                userPermissions = currentUser.permissions;
            }
        });

        socket.on('permission-denied', (data) => {
            alert(data.message);
        });

        socket.on('message', (data) => {
            addMessage(data);
        });

        socket.on('user-left', (data) => {
            addSystemMessage(`${data.username} ç¦»å¼€äº†èŠå¤©å®¤`);
            updateUserList(data.users);
            userCountSpan.textContent = data.userCount;
        });

        socket.on('user-renamed', (data) => {
            addSystemMessage(`${data.oldName} æ”¹åä¸º ${data.newName}`);
            updateUserList(data.users);
            
            // å¦‚æœå½“å‰ç”¨æˆ·è¢«é‡å‘½åï¼Œæ›´æ–°æœ¬åœ°ç”¨æˆ·å
            if (data.oldName === username) {
                username = data.newName;
            }
        });

        socket.on('system-message', (data) => {
            addSystemMessage(data.message, true);
        });

        socket.on('messages-cleared', () => {
            messagesDiv.innerHTML = '<div class="system-message">æ¶ˆæ¯å·²è¢«ç®¡ç†å‘˜æ¸…ç©º</div>';
        });

        socket.on('kicked', (message) => {
            alert(message);
            location.reload();
        });

        socket.on('message-recalled', (messageId) => {
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageDiv) {
                const username = messageDiv.querySelector('.username').textContent;
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="username" style="color: ${messageDiv.querySelector('.username').style.color}">${username}</span>
                        <span class="timestamp">${messageDiv.querySelector('.timestamp').textContent}</span>
                    </div>
                    <div class="message-content">[æ¶ˆæ¯å·²æ’¤å›]</div>
                `;
            }
        });

        function recallMessage(messageId) {
            socket.emit('message-recall', messageId);
        }

        function addMessage(data) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.dataset.messageId = data.id;
            
            let contentHtml;
            if (data.type === 'image') {
                contentHtml = `<img src="${data.message}" alt="å›¾ç‰‡" style="max-width: 100%; max-height: 200px; border-radius: 5px;">`;
            } else if (data.type === 'audio') {
                contentHtml = `<audio controls style="width: 100%; border-radius: 5px;"><source src="${data.message}" type="audio/webm">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾</audio>`;
            } else {
                contentHtml = escapeHtml(data.message);
            }
            
            let actionsHtml = '';
            if (data.username === username) {
                actionsHtml = `<div class="message-actions">
                    <button class="recall-btn" onclick="recallMessage('${data.id}')">æ’¤å›</button>
                </div>`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="username" style="color: ${data.color}">${data.username}</span>
                    <span class="timestamp">${data.timestamp}</span>
                </div>
                <div class="message-content">${contentHtml}</div>
                ${actionsHtml}
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addSystemMessage(text, isAdmin = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'system-message' + (isAdmin ? ' admin' : '');
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateUserList(users) {
            usersListDiv.innerHTML = '';
            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item';
                
                // åªæœ‰å½“å½“å‰ç”¨æˆ·å’Œç›®æ ‡ç”¨æˆ·éƒ½æœ‰é€šè¯æƒé™æ—¶æ‰æ˜¾ç¤ºé€šè¯æŒ‰é’®
                //const showCallButton = userPermissions.allowCall && user.permissions.allowCall;
                
                userDiv.innerHTML = `
                    <div class="user-color" style="background: ${user.color}"></div>
                    <div class="user-name">${escapeHtml(user.username)}</div>
                    
                `;
                
                usersListDiv.appendChild(userDiv);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
