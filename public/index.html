<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; media-src 'self' blob:; connect-src 'self' ws: wss:; font-src 'self' data:;">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>èŠå¤©å®¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 90%;
            max-width: 800px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .online-count {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }
        
        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .users-panel {
            width: 200px;
            background: #f1f3f5;
            padding: 15px;
            border-left: 1px solid #dee2e6;
            overflow-y: auto;
            display: block;
            position: relative;
            z-index: 1;
            transition: all 0.3s;
        }

        .users-panel.hidden {
            display: none;
        }

        .message {
            margin-bottom: 15px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .username {
            font-weight: bold;
            margin-right: 10px;
        }

        .timestamp {
            font-size: 12px;
            color: #999;
        }

        .message-content {
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
            color: #333;
        }



        .message-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 5px;
        }

        .recall-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        .recall-btn:hover {
            background: #c82333;
        }

        .favorite-btn {
            background: transparent;
            color: #ffc107;
            border: none;
            padding: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
        }

        .favorite-btn:hover {
            transform: scale(1.1);
        }

        .favorite-btn.favorited {
            color: #ff9800;
            transform: scale(1.2);
        }

        .read-status {
            color: #6c757d;
            font-size: 12px;
            margin-left: 5px;
            font-weight: bold;
        }

        .translate-btn {
            background: transparent;
            color: #17a2b8;
            border: none;
            padding: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
            margin-left: 5px;
        }

        .translate-btn:hover {
            transform: scale(1.1);
        }

        .call-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }

        .call-btn:hover {
            background: #218838;
        }

        .call-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .video-container.active {
            display: flex;
        }

        .video-content {
            display: flex;
            gap: 20px;
            max-width: 1200px;
            width: 90%;
        }

        .video-box {
            flex: 1;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .video-box video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }

        .video-controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }

        .video-control-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .video-control-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .video-control-btn.end {
            background: #dc3545;
        }

        .video-control-btn.end:hover {
            background: #c82333;
        }

        .call-incoming {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 999;
            max-width: 300px;
        }

        .call-incoming.active {
            display: block;
        }

        .call-incoming h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .call-incoming-buttons {
            display: flex;
            gap: 10px;
        }

        .call-incoming-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .call-accept {
            background: #28a745;
            color: white;
        }

        .call-reject {
            background: #dc3545;
            color: white;
        }

        .system-message {
            text-align: center;
            color: #666;
            font-style: italic;
            margin: 10px 0;
            padding: 5px;
            background: #e9ecef;
            border-radius: 5px;
        }

        .system-message.admin {
            background: #fff3cd;
            color: #856404;
            font-weight: bold;
        }

        .users-panel {
            width: 200px;
            background: #f1f3f5;
            padding: 15px;
            border-left: 1px solid #dee2e6;
            overflow-y: auto;
            display: block;
        }
        
        .search-box {
            margin-bottom: 15px;
        }
        
        #searchInput {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        #searchInput:focus {
            border-color: #667eea;
        }
        
        #userDetailModal .modal-content {
            max-width: 400px;
        }
        
        #userDetailContent {
            margin-bottom: 20px;
        }
        
        #userDetailContent > div {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        #userDetailContent > div > div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        #userDetailContent > div > div:last-child {
            margin-bottom: 0;
        }
        
        #usernameInput, #roomNameInput, #roomPasswordInput {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
            margin-bottom: 10px;
        }

        #usernameInput:focus, #roomNameInput:focus, #roomPasswordInput:focus {
            border-color: #667eea;
        }

        .user-item {
            display: block;
            width: 100%;
            margin-bottom: 10px;
            padding: 10px 15px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            position: relative;
            overflow: hidden;
        }
        
        /* åœ¨çº¿çŠ¶æ€æ ·å¼ */
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .status-online {
            background-color: #28a745;
        }
        
        .status-offline {
            background-color: #6c757d;
        }

        .user-item:hover {
            border-color: #667eea;
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .user-item:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.2);
        }

        .user-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .user-name {
            display: inline-block;
            vertical-align: middle;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: calc(100% - 20px);
        }

        .user-item .btn-info {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 5px 10px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .user-item:hover .btn-info {
            opacity: 1;
        }

        #joinBtn {
            width: 100%;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #joinBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        #chatForm {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #messageInput {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        #messageInput:focus {
            border-color: #667eea;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            background: #f8f9fa;
            color: #667eea;
        }

        .action-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .action-btn.recording {
            background: #dc3545;
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        #sendBtn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #sendBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .hidden {
            display: none !important;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .modal h3 {
            margin-bottom: 15px;
            margin-top: 0;
        }
        
        #deviceSelectContent {
            max-height: 300px;
            overflow-y: auto;
        }
        
        #deviceSelectContent h4 {
            margin-bottom: 10px;
            margin-top: 0;
        }
        
        #deviceSelectContent input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            box-sizing: border-box;
        }
        
        #deviceSelectContent input[type="radio"] {
            margin-right: 10px;
        }
        
        #deviceSelectContent span {
            margin-left: 10px;
        }
        
        #deviceSelectContent div[data-device-type] {
            padding: 10px;
            margin-bottom: 5px;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            cursor: pointer;
        }
        
        #deviceSelectContent div[data-device-type]:hover {
            background: #f8f9fa;
        }
        
        #deviceSelectContent div[data-device-type]:hover input[type="radio"] {
            transform: scale(1.1);
        }
        
        .friend-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
            transition: background 0.2s;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 8px;
            margin: 8px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .friend-item:hover {
            background: #f0f0f0;
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .friend-item:active {
            background: #e9ecef;
            border-color: #0056b3;
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .friend-color {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .friend-info {
            flex: 1;
            min-width: 0;
        }
        
        .friend-name {
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .friend-status {
            font-size: 12px;
            color: #666;
        }
        
        .friend-actions {
            display: none;
            gap: 5px;
        }
        
        .friend-item.expanded .friend-actions {
            display: flex;
        }
        
        .friend-btn {
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .friend-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .friend-btn.danger {
            color: #dc3545;
            border-color: #dc3545;
        }
        
        .friend-btn.danger:hover {
            background: #dc3545;
            color: white;
        }
        
        .private-chat-messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .private-chat-message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 10px;
            background: white;
        }
        
        .private-chat-message.sent {
            background: #667eea;
            color: white;
        }
        
        .private-chat-message-header {
            font-size: 12px;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        
        .private-chat-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        #privateChatInput {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        #privateChatInput:focus {
            border-color: #667eea;
        }
        
        #privateChatSendBtn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        #privateChatSendBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .admin-panel-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }
        
        .admin-tab {
            padding: 10px 20px;
            border: none;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .admin-tab:hover {
            background: #e9ecef;
        }
        
        .admin-tab.active {
            background: #667eea;
            color: white;
        }
        
        .admin-tab-content {
            display: none;
        }
        
        .admin-tab-content.active {
            display: block;
        }
        
        .admin-user-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            transition: background 0.2s;
        }
        
        .admin-user-item:hover {
            background: #f8f9fa;
        }
        
        .admin-user-info {
            flex: 1;
            min-width: 0;
        }
        
        .admin-user-name {
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .admin-user-role {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-right: 5px;
        }
        
        .admin-user-role.user {
            background: #e9ecef;
            color: #666;
        }
        
        .admin-user-role.admin {
            background: #ffc107;
            color: #333;
        }
        
        .admin-user-role.superadmin {
            background: #dc3545;
            color: white;
        }
        
        .admin-user-actions {
            display: flex;
            gap: 5px;
        }
        
        .admin-action-btn {
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .admin-action-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .admin-action-btn.danger {
            color: #dc3545;
            border-color: #dc3545;
        }
        
        .admin-action-btn.danger:hover {
            background: #dc3545;
            color: white;
        }
        
        .admin-select {
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: white;
            font-size: 12px;
            cursor: pointer;
        }
        
        .container {
            width: 100%;
            height: 100vh;
            border-radius: 0;
        }
        .chat-container {
            flex-direction: column;
        }
        .messages {
            padding: 15px;
            width: 100%;
        }
        .action-btn {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }
        #chatForm {
            flex-wrap: wrap;
        }
        #messageInput {
            flex-basis: 100%;
        }
    
            .container {
            width: 100%;
            height: 100vh;
            border-radius: 0;
        }
        .chat-container {
            flex-direction: column;
        }
        .messages {
            padding: 15px;
            width: 100%;
        }
        .action-btn {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }
        #chatForm {
            flex-wrap: wrap;
        }
        #messageInput {
            flex-basis: 100%;
        }
        @media (max-width: 768px) {}

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* è¡¨æƒ…é€‰æ‹©å™¨æ ·å¼ */
        .emoji-panel {
            position: absolute;
            bottom: 70px;
            right: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            width: 320px;
            max-height: 300px;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        .emoji-categories {
            display: flex;
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
            background: #f8f9fa;
            border-radius: 10px 10px 0 0;
        }

        .emoji-category {
            background: none;
            border: none;
            font-size: 20px;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 5px;
            transition: all 0.2s;
        }

        .emoji-category:hover {
            background: #e9ecef;
        }

        .emoji-category.active {
            background: #667eea;
            color: white;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            padding: 10px;
            overflow-y: auto;
            flex: 1;
        }

        .emoji-item {
            background: none;
            border: none;
            font-size: 24px;
            padding: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .emoji-item:hover {
            background: #e9ecef;
            transform: scale(1.2);
        }

        /* è¡¨æƒ…æ¶ˆæ¯æ ·å¼ */
        .emoji-message {
            font-size: 24px;
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>èŠå¤©å®¤</h1>
            <div class="header-actions">
                <div class="online-count">åœ¨çº¿äººæ•°: <span id="userCount">0</span></div>
                <button class="header-btn" id="usersBtn" title="ç”¨æˆ·åˆ—è¡¨">ğŸ‘¥</button>
                <button class="header-btn" id="friendsBtn" title="å¥½å‹åˆ—è¡¨">ğŸ‘¥</button>
                <button class="header-btn" id="adminPanelBtn" title="ç®¡ç†å‘˜é¢æ¿">âš™ï¸</button>
            </div>
        </div>
        
        <!-- æ¶ˆæ¯æœç´¢æ¡† -->
        <div class="search-container" style="padding: 10px; background: white; border-bottom: 1px solid #dee2e6;">
            <input type="text" id="messageSearchInput" placeholder="æœç´¢æ¶ˆæ¯..." style="width: 100%; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 20px; font-size: 14px; outline: none;">
        </div>

        <div class="chat-container">
            <div class="messages" id="messages">
                <div class="system-message">æ¬¢è¿æ¥åˆ°èŠå¤©å®¤ï¼è¯·è¾“å…¥æ˜µç§°åŠ å…¥ã€‚</div>
            </div>
        </div>

        <div class="input-area">
            <div id="loginForm">
                <input type="text" id="usernameInput" placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°" maxlength="20">
                <button id="joinBtn">åŠ å…¥èŠå¤©</button>
            </div>
            <div id="chatForm" class="hidden">
                <input type="file" id="imageInput" accept="image/*">
                <div class="action-buttons">
Â·                    <button class="action-btn" id="emojiBtn" title="å‘é€è¡¨æƒ…">ğŸ˜€</button>
                    <button class="action-btn disabled" id="imageBtn" title="å‘é€å›¾ç‰‡">ğŸ“·</button>
                    <button class="action-btn disabled" id="audioBtn" title="å‘é€è¯­éŸ³">ğŸ¤</button>
                    <button class="action-btn disabled" id="videoCallBtn" title="è§†é¢‘é€šè¯">ğŸ“¹</button>
                    <button class="action-btn disabled" id="audioCallBtn" title="è¯­éŸ³é€šè¯">ğŸ“</button>
                </div>
                <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="500">
                <button id="sendBtn">å‘é€</button>
            </div>
        </div>
        
        <!-- è¡¨æƒ…é€‰æ‹©é¢æ¿ -->
        <div class="emoji-panel" id="emojiPanel" style="display: none;">
            <div class="emoji-categories">
                <button class="emoji-category active" data-category="smileys">ğŸ˜Š</button>
                <button class="emoji-category" data-category="animals">ğŸ¶</button>
                <button class="emoji-category" data-category="food">ğŸ</button>
                <button class="emoji-category" data-category="activities">âš½</button>
                <button class="emoji-category" data-category="travel">âœˆï¸</button>
                <button class="emoji-category" data-category="objects">ğŸ’¡</button>
                <button class="emoji-category" data-category="flags">ğŸ‡¨ğŸ‡³</button>
            </div>
            <div class="emoji-grid" id="emojiGrid">
                <!-- è¡¨æƒ…å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <div class="video-container" id="videoContainer">
        <div class="video-content">
            <div class="video-box">
                <video id="localVideo" autoplay playsinline muted></video>
                <div class="video-label">æˆ‘</div>
            </div>
            <div class="video-box">
                <video id="remoteVideo" autoplay playsinline></video>
                <div class="video-label">å¯¹æ–¹</div>
            </div>
        </div>
        <div class="video-controls">
            <button class="video-control-btn" id="toggleVideoBtn">ğŸ“¹</button>
            <button class="video-control-btn" id="toggleAudioBtn">ğŸ¤</button>
            <button class="video-control-btn end" id="endCallBtn">ğŸ“</button>
        </div>
    </div>

    <div class="call-incoming" id="callIncoming">
        <h3 id="callIncomingText">æ¥ç”µ</h3>
        <div class="call-incoming-buttons">
            <button class="call-accept" onclick="acceptCall()">æ¥å¬</button>
            <button class="call-reject" onclick="rejectCall()">æ‹’ç»</button>
        </div>
    </div>
    
    <div class="modal" id="userDetailModal">
        <div class="modal-content">
            <h3 id="userDetailTitle">ç”¨æˆ·è¯¦æƒ…</h3>
            <div id="userDetailContent"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeUserDetailModal()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="usersModal">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <h3>åœ¨çº¿ç”¨æˆ·</h3>
            <div class="search-box" style="margin-bottom: 15px;">
                <input type="text" id="searchInput" placeholder="æœç´¢ç”¨æˆ·..." maxlength="20">
            </div>
            <div id="usersList"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeUsersModal()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="friendsModal">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <h3>å¥½å‹åˆ—è¡¨</h3>
            <div id="friendsList"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeFriendsModal()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="privateChatModal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <h3 id="privateChatTitle">ç§èŠ</h3>
            <div class="private-chat-messages" id="privateChatMessages"></div>
            <div class="private-chat-input">
                <input type="file" id="privateChatImageInput" accept="image/*" style="display: none;">
                <div class="action-buttons" style="margin-bottom: 10px;">
                    <button class="action-btn" id="privateChatImageBtn" title="å‘é€å›¾ç‰‡">ğŸ“·</button>
                    <button class="action-btn" id="privateChatAudioBtn" title="å‘é€è¯­éŸ³">ğŸ¤</button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="privateChatInput" placeholder="è¾“å…¥ç§èŠæ¶ˆæ¯..." maxlength="500" style="flex: 1;">
                    <button id="privateChatSendBtn">å‘é€</button>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closePrivateChatModal()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="adminPanelModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <h3>ç®¡ç†å‘˜é¢æ¿</h3>
            <div class="admin-panel-tabs">
                <button class="admin-tab active" data-tab="users">ç”¨æˆ·ç®¡ç†</button>
                <button class="admin-tab" data-tab="rooms">æˆ¿é—´ç®¡ç†</button>
                <button class="admin-tab" data-tab="messages">æ¶ˆæ¯ç®¡ç†</button>
                <button class="admin-tab" data-tab="friends">å¥½å‹ç®¡ç†</button>
            </div>
            <div class="admin-panel-content">
                <div class="admin-tab-content active" id="usersTab">
                    <div id="adminUsersList"></div>
                </div>
                <div class="admin-tab-content" id="roomsTab">
                    <div id="adminRoomsList"></div>
                </div>
                <div class="admin-tab-content" id="messagesTab">
                    <div style="margin-bottom: 20px;">
                        <label>
                            <input type="checkbox" id="allowMentionsCheckbox" checked>
                            å…è®¸@åŠŸèƒ½
                        </label>
                    </div>
                    <div id="adminMessagesList"></div>
                </div>
                <div class="admin-tab-content" id="friendsTab">
                    <div id="adminFriendsList"></div>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeAdminPanelModal()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="deviceSelectModal">
        <div class="modal-content" style="max-width: 500px;">
            <h3>é€‰æ‹©è®¾å¤‡</h3>
            <div id="deviceSelectContent"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeDeviceSelectModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-confirm" onclick="confirmDeviceSelect()">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let username = '';
        let currentRoom = '';
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let userPermissions = {
            allowAudio: true,
            allowImage: true,
            allowFile: true,
            allowSendMessages: true,
            allowViewMessages: true,
            allowCall: false
        };

        const messagesDiv = document.getElementById('messages');
        const usersListDiv = document.getElementById('usersList');
        const userCountSpan = document.getElementById('userCount');
        const usernameInput = document.getElementById('usernameInput');
        const messageInput = document.getElementById('messageInput');
        const joinBtn = document.getElementById('joinBtn');
        const sendBtn = document.getElementById('sendBtn');
        const loginForm = document.getElementById('loginForm');
        const chatForm = document.getElementById('chatForm');
        const imageInput = document.getElementById('imageInput');
        const imageBtn = document.getElementById('imageBtn');
        const audioBtn = document.getElementById('audioBtn');
        const videoCallBtn = document.getElementById('videoCallBtn');
        const audioCallBtn = document.getElementById('audioCallBtn');
        const videoContainer = document.getElementById('videoContainer');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const toggleVideoBtn = document.getElementById('toggleVideoBtn');
        const toggleAudioBtn = document.getElementById('toggleAudioBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        const callIncoming = document.getElementById('callIncoming');
        const callIncomingText = document.getElementById('callIncomingText');
        const deviceSelectModal = document.getElementById('deviceSelectModal');
        const deviceSelectContent = document.getElementById('deviceSelectContent');
        const searchInput = document.getElementById('searchInput');
        
        // ç”¨æˆ·åˆ—è¡¨æ¨¡æ€æ¡†
        const usersBtn = document.getElementById('usersBtn');
        const usersModal = document.getElementById('usersModal');
        
        // ç”¨æˆ·è¯¦æƒ…æ¨¡æ€æ¡†
        const userDetailModal = document.getElementById('userDetailModal');
        const userDetailTitle = document.getElementById('userDetailTitle');
        const userDetailContent = document.getElementById('userDetailContent');
        
        // æœç´¢ç›¸å…³å˜é‡
        let allUsers = [];
        let searchResults = [];
        let currentSearchTerm = '';
        
        // å¥½å‹ç³»ç»Ÿç›¸å…³å˜é‡
        const friendsBtn = document.getElementById('friendsBtn');
        const friendsModal = document.getElementById('friendsModal');
        const friendsListDiv = document.getElementById('friendsList');
        const privateChatModal = document.getElementById('privateChatModal');
        const privateChatTitle = document.getElementById('privateChatTitle');
        const privateChatMessagesDiv = document.getElementById('privateChatMessages');
        const privateChatInput = document.getElementById('privateChatInput');
        const privateChatSendBtn = document.getElementById('privateChatSendBtn');
        const privateChatImageInput = document.getElementById('privateChatImageInput');
        const privateChatImageBtn = document.getElementById('privateChatImageBtn');
        const privateChatAudioBtn = document.getElementById('privateChatAudioBtn');
        
        // æ¶ˆæ¯æœç´¢ç›¸å…³å˜é‡
        const messageSearchInput = document.getElementById('messageSearchInput');
        let allMessages = []; // ä¿å­˜æ‰€æœ‰å†å²æ¶ˆæ¯
        let isSearching = false; // æ˜¯å¦æ­£åœ¨æœç´¢çŠ¶æ€
        let searchKeyword = '';
        
        // æ¶ˆæ¯æ”¶è—ç›¸å…³å˜é‡
        let favoritedMessages = JSON.parse(localStorage.getItem('favoritedMessages') || '[]');
        
        // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²æ”¶è—
        function isMessageFavorited(messageId) {
            return favoritedMessages.includes(messageId);
        }
        
        // åˆ‡æ¢æ¶ˆæ¯æ”¶è—çŠ¶æ€
        function toggleFavorite(messageId) {
            const index = favoritedMessages.indexOf(messageId);
            if (index > -1) {
                // å–æ¶ˆæ”¶è—
                favoritedMessages.splice(index, 1);
            } else {
                // æ·»åŠ æ”¶è—
                favoritedMessages.push(messageId);
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('favoritedMessages', JSON.stringify(favoritedMessages));
            
            // æ›´æ–°UI
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageDiv) {
                const favoriteBtn = messageDiv.querySelector('.favorite-btn');
                if (favoriteBtn) {
                    if (favoritedMessages.includes(messageId)) {
                        favoriteBtn.classList.add('favorited');
                        favoriteBtn.title = 'å–æ¶ˆæ”¶è—';
                    } else {
                        favoriteBtn.classList.remove('favorited');
                        favoriteBtn.title = 'æ”¶è—æ¶ˆæ¯';
                    }
                }
            }
        }
        
        // ç®¡ç†å‘˜é¢æ¿ç›¸å…³å˜é‡
        const adminPanelBtn = document.getElementById('adminPanelBtn');
        const adminPanelModal = document.getElementById('adminPanelModal');
        const adminUsersListDiv = document.getElementById('adminUsersList');
        const adminRoomsListDiv = document.getElementById('adminRoomsList');
        const adminMessagesListDiv = document.getElementById('adminMessagesList');
        const adminFriendsListDiv = document.getElementById('adminFriendsList');
        
        let userRole = 'user'; // å½“å‰ç”¨æˆ·çš„è§’è‰²ï¼šuser, admin, superadmin
        
        let friends = [];
        let currentPrivateChatTarget = null;
        
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let currentCallId = null;
        let isVideoCall = false;
        let isVideoEnabled = true;
        let isAudioEnabled = true;
        
        // è®¾å¤‡é€‰æ‹©ç›¸å…³å˜é‡
        let availableVideoDevices = [];
        let availableAudioDevices = [];
        let selectedVideoDeviceId = null;
        let selectedAudioDeviceId = null;
        let pendingCallAction = null;

        // è¡¨æƒ…æ•°æ®
        const emojiData = {
            smileys: ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜š', 'ğŸ˜™', 'ğŸ¥²', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”', 'ğŸ¤', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜’', 'ğŸ™„', 'ğŸ˜¬', 'ğŸ¤¥', 'ğŸ˜Œ', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ¥´', 'ğŸ˜µ', 'ğŸ¤¯', 'ğŸ¤ ', 'ğŸ¥³', 'ğŸ˜', 'ğŸ¤“', 'ğŸ§', 'ğŸ˜•', 'ğŸ˜Ÿ', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜®', 'ğŸ˜¯', 'ğŸ˜²', 'ğŸ˜³', 'ğŸ¥º', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ˜–', 'ğŸ˜£', 'ğŸ˜', 'ğŸ˜“', 'ğŸ˜©', 'ğŸ˜«', 'ğŸ¥±', 'ğŸ˜¤', 'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ’€', 'â˜ ï¸', 'ğŸ’©', 'ğŸ¤¡', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ‘»', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ¤–', 'ğŸ’‹', 'ğŸ‘„', 'ğŸ‘…', 'ğŸ‘‚', 'ğŸ‘ƒ', 'ğŸ§ ', 'ğŸ«€', 'ğŸ«', 'ğŸ¦·', 'ğŸ¦´', 'ğŸ‘€', 'ğŸ‘ï¸', 'ğŸ‘…', 'ğŸ‘„', 'ğŸ«¶', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'ğŸ‘', 'ğŸ¤', 'ğŸ‘', 'ğŸ‘', 'ğŸ‘Œ', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘‹', 'ğŸ¤š', 'ğŸ–ï¸', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤', 'âœŠ', 'ğŸ‘Š', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'ğŸ’ª', 'ğŸ¦¾', 'ğŸ¦¿', 'ğŸ¦µ', 'ğŸ¦¶', 'ğŸ‘‚', 'ğŸ¦»', 'ğŸ‘ƒ', 'ğŸ§ ', 'ğŸ«€', 'ğŸ«', 'ğŸ¦·', 'ğŸ¦´', 'ğŸ‘€', 'ğŸ‘ï¸', 'ğŸ‘…', 'ğŸ‘„', 'ğŸ’‹', 'ğŸ©¸'],
            animals: ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ½', 'ğŸ¸', 'ğŸµ', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸ’', 'ğŸ”', 'ğŸ§', 'ğŸ¦', 'ğŸ¤', 'ğŸ£', 'ğŸ¥', 'ğŸ¦†', 'ğŸ¦…', 'ğŸ¦‰', 'ğŸ¦‡', 'ğŸº', 'ğŸ—', 'ğŸ´', 'ğŸ¦„', 'ğŸ', 'ğŸ›', 'ğŸ¦‹', 'ğŸŒ', 'ğŸ', 'ğŸœ', 'ğŸ¦Ÿ', 'ğŸ¦—', 'ğŸ•·ï¸', 'ğŸ•¸ï¸', 'ğŸ¦‚', 'ğŸ¢', 'ğŸ', 'ğŸ¦', 'ğŸ¦–', 'ğŸ¦•', 'ğŸ™', 'ğŸ¦‘', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦€', 'ğŸ¡', 'ğŸ ', 'ğŸŸ', 'ğŸ¬', 'ğŸ³', 'ğŸ‹', 'ğŸ¦ˆ', 'ğŸŠ', 'ğŸ…', 'ğŸ†', 'ğŸ¦“', 'ğŸ¦', 'ğŸ¦§', 'ğŸ˜', 'ğŸ¦›', 'ğŸ¦', 'ğŸª', 'ğŸ«', 'ğŸ¦’', 'ğŸ¦˜', 'ğŸƒ', 'ğŸ‚', 'ğŸ„', 'ğŸ', 'ğŸ–', 'ğŸ', 'ğŸ‘', 'ğŸ¦™', 'ğŸ', 'ğŸ¦Œ', 'ğŸ•', 'ğŸ©', 'ğŸ¦®', 'ğŸ•â€ğŸ¦º', 'ğŸˆ', 'ğŸ“', 'ğŸ¦ƒ', 'ğŸ¦š', 'ğŸ¦œ', 'ğŸ¦¢', 'ğŸ¦©', 'ğŸ•Šï¸', 'ğŸ‡', 'ğŸ¦', 'ğŸ¦¨', 'ğŸ¦¡', 'ğŸ¦¦', 'ğŸ¦¥', 'ğŸ', 'ğŸ€', 'ğŸ¿ï¸', 'ğŸ¦”', 'ğŸ¾', 'ğŸ‰', 'ğŸ²', 'ğŸŒµ', 'ğŸ„', 'ğŸŒ²', 'ğŸŒ³', 'ğŸŒ´', 'ğŸŒ±', 'ğŸŒ¿', 'â˜˜ï¸', 'ğŸ€', 'ğŸ', 'ğŸ‹', 'ğŸƒ', 'ğŸ‚', 'ğŸ', 'ğŸ„', 'ğŸŒ¾', 'ğŸ’', 'ğŸŒ·', 'ğŸŒ¹', 'ğŸ¥€', 'ğŸŒº', 'ğŸŒ¸', 'ğŸŒ¼', 'ğŸŒ»', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ›', 'ğŸŒœ', 'ğŸŒš', 'ğŸŒ•', 'ğŸŒ–', 'ğŸŒ—', 'ğŸŒ˜', 'ğŸŒ‘', 'ğŸŒ’', 'ğŸŒ“', 'ğŸŒ”', 'ğŸŒ™', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ', 'ğŸ’«', 'â­', 'ğŸŒŸ', 'âœ¨', 'âš¡', 'ğŸ”¥', 'ğŸ’¥', 'ğŸ’¦', 'ğŸ’¨', 'ğŸŒªï¸', 'ğŸŒˆ', 'â˜€ï¸', 'ğŸŒ¤ï¸', 'â›…', 'ğŸŒ¦ï¸', 'ğŸŒ§ï¸', 'â›ˆï¸', 'ğŸŒ¨ï¸', 'â„ï¸', 'â˜ƒï¸', 'â›„', 'ğŸŒŠ', 'ğŸŒ«ï¸', 'ğŸŒ¬ï¸'],
            food: ['ğŸ', 'ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ‰', 'ğŸ‡', 'ğŸ“', 'ğŸ«', 'ğŸˆ', 'ğŸ’', 'ğŸ‘', 'ğŸ¥­', 'ğŸ', 'ğŸ¥¥', 'ğŸ¥', 'ğŸ…', 'ğŸ†', 'ğŸ¥‘', 'ğŸ¥¦', 'ğŸ¥¬', 'ğŸ¥’', 'ğŸŒ¶ï¸', 'ğŸ«‘', 'ğŸŒ½', 'ğŸ¥•', 'ğŸ«’', 'ğŸ§„', 'ğŸ§…', 'ğŸ¥”', 'ğŸ ', 'ğŸ¥', 'ğŸ¥–', 'ğŸ', 'ğŸ¥¨', 'ğŸ¥¯', 'ğŸ§€', 'ğŸ—', 'ğŸ–', 'ğŸ¥©', 'ğŸ¥“', 'ğŸ”', 'ğŸŸ', 'ğŸ•', 'ğŸŒ­', 'ğŸ¥ª', 'ğŸŒ®', 'ğŸŒ¯', 'ğŸ«”', 'ğŸ¥™', 'ğŸ§†', 'ğŸ¥š', 'ğŸ³', 'ğŸ§ˆ', 'ğŸ¥', 'ğŸ§‡', 'ğŸ¥“', 'ğŸ¥©', 'ğŸ—', 'ğŸ–', 'ğŸ¦´', 'ğŸœ', 'ğŸ', 'ğŸ²', 'ğŸ›', 'ğŸ£', 'ğŸ±', 'ğŸ¥Ÿ', 'ğŸ¦ª', 'ğŸ¤', 'ğŸ™', 'ğŸš', 'ğŸ˜', 'ğŸ¥', 'ğŸ¥ ', 'ğŸ¥®', 'ğŸ¢', 'ğŸ¡', 'ğŸ§', 'ğŸ¨', 'ğŸ¦', 'ğŸ¥§', 'ğŸ§', 'ğŸ°', 'ğŸ‚', 'ğŸ®', 'ğŸ­', 'ğŸ¬', 'ğŸ«', 'ğŸ¿', 'ğŸ©', 'ğŸª', 'ğŸŒ°', 'ğŸ¥œ', 'ğŸ¯', 'ğŸ¥›', 'ğŸ¼', 'ğŸ«–', 'â˜•', 'ğŸµ', 'ğŸ¶', 'ğŸº', 'ğŸ»', 'ğŸ¥‚', 'ğŸ·', 'ğŸ¥ƒ', 'ğŸ«—', 'ğŸ§Š', 'ğŸ¥¤', 'ğŸ§‹', 'ğŸ§ƒ', 'ğŸ§‰', 'ğŸ§Š', 'ğŸ¹', 'ğŸ¸', 'ğŸ¾', 'ğŸ¥„', 'ğŸ´', 'ğŸ½ï¸', 'ğŸ¥£', 'ğŸ¥¡', 'ğŸ¦ª', 'ğŸ£', 'ğŸ¤', 'ğŸ±', 'ğŸ¥Ÿ', 'ğŸ™', 'ğŸš', 'ğŸ˜', 'ğŸ¥', 'ğŸ¥ ', 'ğŸ¥®', 'ğŸ¢', 'ğŸ¡'],
            activities: ['âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ¥', 'ğŸ±', 'ğŸª€', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ‘', 'ğŸ¥', 'ğŸ', 'ğŸªƒ', 'ğŸ¥…', 'â›³', 'ğŸª', 'ğŸ¹', 'ğŸ£', 'ğŸ¤¿', 'ğŸ¥Š', 'ğŸ¥‹', 'ğŸ½', 'ğŸ›¹', 'ğŸ›¼', 'ğŸ›·', 'â›¸ï¸', 'ğŸ¥Œ', 'ğŸ¿', 'â›·ï¸', 'ğŸ‚', 'ğŸª‚', 'ğŸ‹ï¸â€â™‚ï¸', 'ğŸ‹ï¸â€â™€ï¸', 'ğŸ¤¼â€â™‚ï¸', 'ğŸ¤¼â€â™€ï¸', 'ğŸ¤¸â€â™‚ï¸', 'ğŸ¤¸â€â™€ï¸', 'ğŸ¤º', 'ğŸ¤¾â€â™‚ï¸', 'ğŸ¤¾â€â™€ï¸', 'ğŸŒï¸â€â™‚ï¸', 'ğŸŒï¸â€â™€ï¸', 'ğŸ‡', 'ğŸ§˜â€â™‚ï¸', 'ğŸ§˜â€â™€ï¸', 'ğŸš´â€â™‚ï¸', 'ğŸš´â€â™€ï¸', 'ğŸšµâ€â™‚ï¸', 'ğŸšµâ€â™€ï¸', 'ğŸ§—â€â™‚ï¸', 'ğŸ§—â€â™€ï¸', 'ğŸš£â€â™‚ï¸', 'ğŸš£â€â™€ï¸', 'ğŸŠâ€â™‚ï¸', 'ğŸŠâ€â™€ï¸', 'ğŸ„â€â™‚ï¸', 'ğŸ„â€â™€ï¸', 'ğŸ†', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ…', 'ğŸ–ï¸', 'ğŸ¥‹', 'ğŸ—ï¸', 'ğŸµï¸', 'ğŸ«', 'ğŸŸï¸', 'ğŸª', 'ğŸ¤¹â€â™‚ï¸', 'ğŸ¤¹â€â™€ï¸', 'ğŸ­', 'ğŸ©°', 'ğŸ¨', 'ğŸ¬', 'ğŸ¤', 'ğŸ§', 'ğŸ¼', 'ğŸµ', 'ğŸ¶', 'ğŸ¥', 'ğŸª˜', 'ğŸ·', 'ğŸª—', 'ğŸ¸', 'ğŸª•', 'ğŸº', 'ğŸª‡', 'ğŸ¹', 'ğŸ»', 'ğŸ²', 'â™ ï¸', 'â™¥ï¸', 'â™¦ï¸', 'â™£ï¸', 'ğŸƒ', 'ğŸ´', 'ğŸ€„', 'ğŸ¯', 'ğŸ®', 'ğŸ°', 'ğŸ³', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ‘', 'ğŸ¥', 'ğŸ', 'ğŸªƒ'],
            travel: ['ğŸš—', 'ğŸš•', 'ğŸš™', 'ğŸšŒ', 'ğŸš', 'ğŸï¸', 'ğŸš“', 'ğŸš‘', 'ğŸš’', 'ğŸš', 'ğŸšš', 'ğŸš›', 'ğŸšœ', 'ğŸï¸', 'ğŸ›µ', 'ğŸš²', 'ğŸ›´', 'ğŸš', 'ğŸ›£ï¸', 'ğŸ›¤ï¸', 'ğŸ›¢ï¸', 'â›½', 'ğŸš¨', 'ğŸš¥', 'ğŸš¦', 'ğŸ›‘', 'ğŸš§', 'âš“', 'ğŸš¢', 'ğŸ›¥ï¸', 'ğŸ›³ï¸', 'â›´ï¸', 'ğŸš¤', 'ğŸ›©ï¸', 'ğŸ›«', 'ğŸ›¬', 'âœˆï¸', 'ğŸ’º', 'ğŸš', 'ğŸšŸ', 'ğŸš ', 'ğŸš¡', 'ğŸ›°ï¸', 'ğŸš€', 'ğŸ›¸', 'ğŸ—ºï¸', 'ğŸ—¾', 'ğŸ—¿', 'ğŸ—½', 'ğŸ°', 'ğŸ¯', 'ğŸŸï¸', 'ğŸ¡', 'ğŸ¢', 'ğŸ ', 'ğŸ–ï¸', 'ğŸï¸', 'ğŸœï¸', 'ğŸ•ï¸', 'â›º', 'ğŸ ', 'ğŸ¡', 'ğŸ˜ï¸', 'ğŸšï¸', 'ğŸ—ï¸', 'ğŸ­', 'ğŸ¬', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ¨', 'ğŸª', 'ğŸ«', 'ğŸ©', 'ğŸ’’', 'â›ª', 'ğŸ•Œ', 'ğŸ•', 'ğŸ•‹', 'â›©ï¸', 'ğŸ›•', 'ğŸ•‰ï¸', 'â›²', 'ğŸŒ', 'ğŸŒ‰', 'ğŸ™ï¸', 'ğŸŒƒ', 'ğŸŒŒ', 'ğŸ“®', 'ğŸ“ª', 'ğŸ“«', 'ğŸ“¬', 'ğŸ“­', 'ğŸ“¦', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ¨', 'ğŸª', 'ğŸ«', 'ğŸ©', 'ğŸ’’', 'â›ª', 'ğŸ•Œ', 'ğŸ•', 'ğŸ•‹', 'â›©ï¸', 'ğŸ›•'],
            objects: ['ğŸ’¡', 'ğŸ”¦', 'ğŸ®', 'ğŸª”', 'ğŸ•¯ï¸', 'ğŸª™', 'ğŸ’°', 'ğŸ’´', 'ğŸ’µ', 'ğŸ’¶', 'ğŸ’·', 'ğŸ’¸', 'ğŸ’³', 'ğŸ§¾', 'ğŸ’', 'âš–ï¸', 'ğŸ”§', 'ğŸ”¨', 'âš’ï¸', 'ğŸ› ï¸', 'ğŸª“', 'ğŸ”©', 'âš™ï¸', 'ğŸ—œï¸', 'ğŸ§°', 'ğŸ”«', 'ğŸ’£', 'ğŸ§¨', 'ğŸš¬', 'ğŸª¤', 'ğŸ”ª', 'ğŸ—¡ï¸', 'âš”ï¸', 'ğŸ›¡ï¸', 'ğŸšª', 'ğŸš¬', 'ğŸ§¯', 'ğŸª’', 'ğŸ§´', 'ğŸ§·', 'ğŸ§¹', 'ğŸª£', 'ğŸ§º', 'ğŸ§»', 'ğŸš¿', 'ğŸ›', 'ğŸª¤', 'ğŸ§½', 'ğŸ§´', 'ğŸš½', 'ğŸª ', 'ğŸ§´', 'ğŸ§·', 'ğŸ§¹', 'ğŸª£', 'ğŸ§º', 'ğŸ§»', 'ğŸš¿', 'ğŸ›', 'ğŸª¤', 'ğŸ§½', 'ğŸ§´', 'ğŸš½', 'ğŸª ', 'ğŸ“±', 'ğŸ“²', 'ğŸ’»', 'âŒ¨ï¸', 'ğŸ–¥ï¸', 'ğŸ–¨ï¸', 'ğŸ–±ï¸', 'ğŸ–²ï¸', 'ğŸ’½', 'ğŸ’¾', 'ğŸ’¿', 'ğŸ“€', 'ğŸ“¼', 'ğŸ“·', 'ğŸ“¸', 'ğŸ“¹', 'ğŸ¥', 'ğŸ“½ï¸', 'ğŸï¸', 'ğŸ“', 'â˜ï¸', 'ğŸ“Ÿ', 'ğŸ“ ', 'ğŸ“º', 'ğŸ“»', 'ğŸ™ï¸', 'ğŸšï¸', 'ğŸ›ï¸', 'ğŸ§­', 'â°', 'â²ï¸', 'â³', 'âŒ›', 'ğŸ“¡', 'ğŸ”‹', 'ğŸ”Œ', 'ğŸ“š', 'ğŸ“–', 'ğŸ“•', 'ğŸ“—', 'ğŸ“˜', 'ğŸ“™', 'ğŸ““', 'ğŸ“”', 'ğŸ“’', 'ğŸ“ƒ', 'ğŸ“œ', 'ğŸ“„', 'ğŸ“°', 'ğŸ—ï¸', 'ğŸ“‘', 'ğŸ“Š', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ“‹', 'ğŸ“Œ', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'âœ‚ï¸', 'ğŸ–‡ï¸', 'ğŸ“', 'ğŸ—‚ï¸', 'ğŸ—ƒï¸', 'ğŸ—„ï¸', 'ğŸ—‘ï¸', 'ğŸ“', 'ğŸ“‚', 'ğŸ—“ï¸', 'ğŸ“…', 'ğŸ“†', 'ğŸ“‡', 'ğŸ—’ï¸', 'ğŸ—“ï¸', 'ğŸ“', 'âœï¸', 'ğŸ–Šï¸', 'ğŸ–‹ï¸', 'ğŸ“', 'ğŸ“„', 'ğŸ“ƒ', 'ğŸ“œ', 'ğŸ“‹', 'ğŸ“Š', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ“Š', 'ğŸ“‹', 'ğŸ“Œ', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'âœ‚ï¸', 'ğŸ–‡ï¸'],
            flags: ['ğŸ‡¨ğŸ‡³', 'ğŸ‡ºğŸ‡¸', 'ğŸ‡¬ğŸ‡§', 'ğŸ‡¯ğŸ‡µ', 'ğŸ‡°ğŸ‡·', 'ğŸ‡«ğŸ‡·', 'ğŸ‡©ğŸ‡ª', 'ğŸ‡ªğŸ‡¸', 'ğŸ‡·ğŸ‡º', 'ğŸ‡®ğŸ‡³', 'ğŸ‡§ğŸ‡·', 'ğŸ‡¨ğŸ‡¦', 'ğŸ‡¦ğŸ‡º', 'ğŸ‡®ğŸ‡¹', 'ğŸ‡³ğŸ‡±', 'ğŸ‡§ğŸ‡ª', 'ğŸ‡§ğŸ‡¹', 'ğŸ‡§ğŸ‡¬', 'ğŸ‡¨ğŸ‡¿', 'ğŸ‡¨ğŸ‡­', 'ğŸ‡©ğŸ‡°', 'ğŸ‡«ğŸ‡®', 'ğŸ‡¬ğŸ‡·', 'ğŸ‡­ğŸ‡º', 'ğŸ‡®ğŸ‡¸', 'ğŸ‡®ğŸ‡ª', 'ğŸ‡±ğŸ‡¹', 'ğŸ‡±ğŸ‡º', 'ğŸ‡±ğŸ‡»', 'ğŸ‡²ğŸ‡¹', 'ğŸ‡³ğŸ‡´', 'ğŸ‡µğŸ‡±', 'ğŸ‡µğŸ‡¹', 'ğŸ‡·ğŸ‡´', 'ğŸ‡¸ğŸ‡ª', 'ğŸ‡¸ğŸ‡®', 'ğŸ‡¸ğŸ‡°', 'ğŸ‡¹ğŸ‡·', 'ğŸ‡¦ğŸ‡¹', 'ğŸ‡¬ğŸ‡·', 'ğŸ‡®ğŸ‡±', 'ğŸ‡¸ğŸ‡¦', 'ğŸ‡¦ğŸ‡ª', 'ğŸ‡§ğŸ‡­', 'ğŸ‡°ğŸ‡¼', 'ğŸ‡´ğŸ‡²', 'ğŸ‡¶ğŸ‡¦', 'ğŸ‡¸ğŸ‡¬', 'ğŸ‡¹ğŸ‡­', 'ğŸ‡»ğŸ‡³', 'ğŸ‡²ğŸ‡¾', 'ğŸ‡®ğŸ‡©', 'ğŸ‡µğŸ‡­', 'ğŸ‡³ğŸ‡¿', 'ğŸ‡¿ğŸ‡¦', 'ğŸ‡ªğŸ‡¬', 'ğŸ‡²ğŸ‡¦', 'ğŸ‡¦ğŸ‡·', 'ğŸ‡¨ğŸ‡±', 'ğŸ‡¨ğŸ‡´', 'ğŸ‡²ğŸ‡½', 'ğŸ‡µğŸ‡ª', 'ğŸ‡¦ğŸ‡º', 'ğŸ‡³ğŸ‡¿', 'ğŸ‡¹ğŸ‡·', 'ğŸ‡¸ğŸ‡¾', 'ğŸ‡®ğŸ‡·', 'ğŸ‡®ğŸ‡·', 'ğŸ‡²ğŸ‡¦', 'ğŸ‡²ğŸ‡±', 'ğŸ‡¹ğŸ‡¬', 'ğŸ‡³ğŸ‡¬', 'ğŸ‡¿ğŸ‡²', 'ğŸ‡¿ğŸ‡¼', 'ğŸ‡¿ğŸ‡¦', 'ğŸ‡§ğŸ‡¼', 'ğŸ‡³ğŸ‡¦', 'ğŸ‡²ğŸ‡¸', 'ğŸ‡§ğŸ‡¹', 'ğŸ‡³ğŸ‡µ', 'ğŸ‡²ğŸ‡³', 'ğŸ‡²ğŸ‡´', 'ğŸ‡­ğŸ‡°', 'ğŸ‡²ğŸ‡¹', 'ğŸ‡¸ğŸ‡²', 'ğŸ‡»ğŸ‡¦', 'ğŸ‡¨ğŸ‡°', 'ğŸ‡¬ğŸ‡®', 'ğŸ‡¯ğŸ‡ª', 'ğŸ‡¬ğŸ‡¬', 'ğŸ‡®ğŸ‡²', 'ğŸ‡²ğŸ‡¨', 'ğŸ‡¸ğŸ‡§', 'ğŸ‡»ğŸ‡º', 'ğŸ‡«ğŸ‡²', 'ğŸ‡¹ğŸ‡´', 'ğŸ‡µğŸ‡¼', 'ğŸ‡°ğŸ‡®', 'ğŸ‡°ğŸ‡²', 'ğŸ‡¹ğŸ‡°', 'ğŸ‡«ğŸ‡°', 'ğŸ‡³ğŸ‡º', 'ğŸ‡«ğŸ‡´', 'ğŸ‡¸ğŸ‡¹', 'ğŸ‡»ğŸ‡¨', 'ğŸ‡¬ğŸ‡©', 'ğŸ‡²ğŸ‡¸', 'ğŸ‡¦ğŸ‡¬', 'ğŸ‡§ğŸ‡§', 'ğŸ‡§ğŸ‡¸', 'ğŸ‡§ğŸ‡¿', 'ğŸ‡¨ğŸ‡±', 'ğŸ‡¨ğŸ‡´', 'ğŸ‡¨ğŸ‡·', 'ğŸ‡©ğŸ‡´', 'ğŸ‡ªğŸ‡¨', 'ğŸ‡¸ğŸ‡»', 'ğŸ‡¬ğŸ‡¹', 'ğŸ‡­ğŸ‡³', 'ğŸ‡²ğŸ‡½', 'ğŸ‡³ğŸ‡®', 'ğŸ‡µğŸ‡¦', 'ğŸ‡µğŸ‡¾', 'ğŸ‡µğŸ‡ª', 'ğŸ‡¹ğŸ‡¹', 'ğŸ‡»ğŸ‡ª', 'ğŸ‡¦ğŸ‡·', 'ğŸ‡§ğŸ‡´', 'ğŸ‡§ğŸ‡·', 'ğŸ‡¨ğŸ‡±', 'ğŸ‡¨ğŸ‡´', 'ğŸ‡ªğŸ‡¨', 'ğŸ‡«ğŸ‡®', 'ğŸ‡¬ğŸ‡«', 'ğŸ‡¬ğŸ‡¶', 'ğŸ‡¬ğŸ‡¾', 'ğŸ‡­ğŸ‡¹', 'ğŸ‡±ğŸ‡¨', 'ğŸ‡²ğŸ‡¶', 'ğŸ‡²ğŸ‡·', 'ğŸ‡²ğŸ‡º', 'ğŸ‡µğŸ‡²', 'ğŸ‡·ğŸ‡ª', 'ğŸ‡·ğŸ‡º', 'ğŸ‡¸ğŸ‡·', 'ğŸ‡¹ğŸ‡¹', 'ğŸ‡ºğŸ‡¾', 'ğŸ‡»ğŸ‡¨', 'ğŸ‡»ğŸ‡®', 'ğŸ‡»ğŸ‡ª']
        };

        // è¡¨æƒ…ç³»ç»Ÿç›¸å…³å˜é‡
        let currentEmojiCategory = 'smileys';

        // åˆå§‹åŒ–è¡¨æƒ…ç³»ç»Ÿ
        function initEmojiSystem() {
            // åŠ è½½é»˜è®¤è¡¨æƒ…
            loadEmojis(currentEmojiCategory);
            
            // è¡¨æƒ…æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            emojiBtn.addEventListener('click', toggleEmojiPanel);
            
            // è·å–è¡¨æƒ…åˆ†ç±»æŒ‰é’®
            const emojiCategories = document.querySelectorAll('.emoji-category');
            
            // è¡¨æƒ…åˆ†ç±»ç‚¹å‡»äº‹ä»¶
            emojiCategories.forEach(category => {
                category.addEventListener('click', () => {
                    const categoryName = category.dataset.category;
                    switchEmojiCategory(categoryName, emojiCategories);
                });
            });
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­è¡¨æƒ…é¢æ¿
            document.addEventListener('click', (e) => {
                if (!emojiPanel.contains(e.target) && e.target !== emojiBtn) {
                    hideEmojiPanel();
                }
            });
        }

        // åˆ‡æ¢è¡¨æƒ…é¢æ¿æ˜¾ç¤º
        function toggleEmojiPanel() {
            emojiPanel.style.display = emojiPanel.style.display === 'none' || emojiPanel.style.display === '' ? 'flex' : 'none';
        }

        // éšè—è¡¨æƒ…é¢æ¿
        function hideEmojiPanel() {
            emojiPanel.style.display = 'none';
        }

        // åˆ‡æ¢è¡¨æƒ…åˆ†ç±»
        function switchEmojiCategory(categoryName, emojiCategories) {
            currentEmojiCategory = categoryName;
            
            // æ›´æ–°åˆ†ç±»æŒ‰é’®çŠ¶æ€
            emojiCategories.forEach(category => {
                category.classList.remove('active');
            });
            document.querySelector(`[data-category="${categoryName}"]`).classList.add('active');
            
            // åŠ è½½å¯¹åº”åˆ†ç±»çš„è¡¨æƒ…
            loadEmojis(categoryName);
        }

        // åŠ è½½è¡¨æƒ…
        function loadEmojis(categoryName) {
            const emojis = emojiData[categoryName] || [];
            emojiGrid.innerHTML = '';
            
            emojis.forEach(emoji => {
                const emojiBtn = document.createElement('button');
                emojiBtn.className = 'emoji-item';
                emojiBtn.textContent = emoji;
                emojiBtn.addEventListener('click', () => {
                    insertEmoji(emoji);
                });
                emojiGrid.appendChild(emojiBtn);
            });
        }

        // æ’å…¥è¡¨æƒ…åˆ°è¾“å…¥æ¡†
        function insertEmoji(emoji) {
            const cursorPosition = messageInput.selectionStart;
            const textBefore = messageInput.value.substring(0, cursorPosition);
            const textAfter = messageInput.value.substring(cursorPosition);
            messageInput.value = textBefore + emoji + textAfter;
            
            // è®¾ç½®å…‰æ ‡ä½ç½®åˆ°è¡¨æƒ…åé¢
            messageInput.selectionStart = messageInput.selectionEnd = cursorPosition + emoji.length;
            messageInput.focus();
            
            hideEmojiPanel();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–è¡¨æƒ…ç³»ç»Ÿ
        document.addEventListener('DOMContentLoaded', initEmojiSystem);

        // ä»URLè·¯å¾„è·å–æˆ¿é—´å
        function getRoomFromUrl() {
            const path = window.location.pathname;
            if (path && path !== '/') {
                return path.substring(1); // ç§»é™¤å¼€å¤´çš„æ–œæ 
            }
            return null;
        }

        // å¤„ç†åŠ å…¥æŒ‰é’®ç‚¹å‡»
        joinBtn.addEventListener('click', () => {
            username = usernameInput.value.trim();
            if (username) {
                // ä»URLè·å–æˆ¿é—´åï¼Œé»˜è®¤ä½¿ç”¨'main'
                const roomName = getRoomFromUrl() || 'main';
                
                // å¦‚æœä¸æ˜¯é»˜è®¤æˆ¿é—´ï¼Œæç¤ºç”¨æˆ·è¾“å…¥å¯†ç ï¼ˆå¦‚æœéœ€è¦ï¼‰
                if (roomName !== 'main') {
                    const password = prompt(`è¯·è¾“å…¥æˆ¿é—´ "${roomName}" çš„å¯†ç ï¼ˆç•™ç©ºè¡¨ç¤ºæ— å¯†ç ï¼‰:`);
                    currentRoom = roomName;
                    socket.emit('join', { username, roomName, password: password || null });
                } else {
                    currentRoom = roomName;
                    socket.emit('join', { username, roomName });
                }
            }
        });

        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                joinBtn.click();
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶ä¸éœ€è¦è®¾ç½®è¾“å…¥æ¡†ï¼Œå› ä¸ºå·²ç»åˆ é™¤äº†æˆ¿é—´åè¾“å…¥æ¡†

        sendBtn.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (message) {
                if (!userPermissions.allowSendMessages) {
                    alert('æ‚¨æ²¡æœ‰å‘é€æ¶ˆæ¯çš„æƒé™');
                    return;
                }
                socket.emit('message', { message, type: 'text' });
                messageInput.value = '';
            }
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });

        imageBtn.addEventListener('click', () => {
            if (userPermissions.allowImage) {
                imageInput.click();
            } else {
                alert('æ‚¨æ²¡æœ‰å‘é€å›¾ç‰‡çš„æƒé™');
            }
        });

        imageInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                if (!userPermissions.allowImage) {
                    alert('æ‚¨æ²¡æœ‰å‘é€å›¾ç‰‡çš„æƒé™');
                    imageInput.value = '';
                    return;
                }
                try {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const arrayBuffer = event.target.result;
                        const response = await fetch('/upload-image', {
                            method: 'POST',
                            body: arrayBuffer,
                            headers: {
                                'Content-Type': file.type
                            }
                        });
                        const data = await response.json();
                        
                        if (data.imageUrl) {
                            socket.emit('message', { message: data.imageUrl, type: 'image' });
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } catch (error) {
                    console.error('ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', error);
                    alert('ä¸Šä¼ å›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
                
                imageInput.value = '';
            }
        });

        audioBtn.addEventListener('click', async () => {
            if (!userPermissions.allowAudio) {
                alert('æ‚¨æ²¡æœ‰å‘é€è¯­éŸ³çš„æƒé™');
                return;
            }
            
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        
                        try {
                            // ç›´æ¥ä½¿ç”¨Blobä¸Šä¼ ï¼Œä¸è½¬æ¢ä¸ºarrayBuffer
                            const response = await fetch('/upload-audio', {
                                method: 'POST',
                                body: audioBlob,
                                headers: {
                                    'Content-Type': 'audio/webm'
                                }
                            });
                            
                            if (!response.ok) {
                                throw new Error(`ç½‘ç»œå“åº”é”™è¯¯: ${response.statusText}`);
                            }
                            
                            const data = await response.json();
                            
                            if (data.audioUrl) {
                                socket.emit('message', { message: data.audioUrl, type: 'audio' });
                            }
                        } catch (error) {
                            console.error('ä¸Šä¼ è¯­éŸ³å¤±è´¥:', error);
                            alert('ä¸Šä¼ è¯­éŸ³å¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                        
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    audioBtn.classList.add('recording');
                    audioBtn.title = 'åœæ­¢å½•åˆ¶';
                } catch (error) {
                    console.error('æ— æ³•è®¿é—®éº¦å…‹é£:', error);
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                audioBtn.classList.remove('recording');
                audioBtn.title = 'å‘é€è¯­éŸ³';
            }
        });

        socket.on('user-joined', (data) => {
            addSystemMessage(`${data.username} åŠ å…¥äº†èŠå¤©å®¤`);
            updateUserList(data.users);
            userCountSpan.textContent = data.userCount;
            
            // æ›´æ–°å½“å‰ç”¨æˆ·çš„æƒé™
            if (data.username === username) {
                const currentUser = data.users.find(u => u.username === username);
                if (currentUser) {
                    userPermissions = currentUser.permissions;
                    // åŠ å…¥æˆ¿é—´æˆåŠŸååˆ‡æ¢åˆ°èŠå¤©ç•Œé¢
                    loginForm.classList.add('hidden');
                    chatForm.classList.remove('hidden');
                    messageInput.focus();
                }
            }
        });
        
        socket.on('user-permissions-changed', (data) => {
            // æ›´æ–°å½“å‰ç”¨æˆ·çš„æƒé™
            const currentUser = data.users.find(u => u.socketId === socket.id);
            if (currentUser) {
                userPermissions = currentUser.permissions;
            }
        });

        socket.on('permission-denied', (data) => {
            alert(data.message);
        });

        socket.on('message', (data) => {
            addMessage(data);
        });

        socket.on('user-left', (data) => {
            addSystemMessage(`${data.username} ç¦»å¼€äº†èŠå¤©å®¤`);
            updateUserList(data.users);
            userCountSpan.textContent = data.userCount;
        });

        socket.on('user-renamed', (data) => {
            addSystemMessage(`${data.oldName} æ”¹åä¸º ${data.newName}`);
            updateUserList(data.users);
            
            // å¦‚æœå½“å‰ç”¨æˆ·è¢«é‡å‘½åï¼Œæ›´æ–°æœ¬åœ°ç”¨æˆ·å
            if (data.oldName === username) {
                username = data.newName;
            }
        });

        socket.on('system-message', (data) => {
            addSystemMessage(data.message, true);
        });

        socket.on('messages-cleared', () => {
            messagesDiv.innerHTML = '<div class="system-message">æ¶ˆæ¯å·²è¢«ç®¡ç†å‘˜æ¸…ç©º</div>';
        });

        socket.on('kicked', (message) => {
            alert(message);
            location.reload();
        });

        socket.on('message-recalled', (messageId) => {
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageDiv) {
                const username = messageDiv.querySelector('.username').textContent;
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="username" style="color: ${messageDiv.querySelector('.username').style.color}">${username}</span>
                        <span class="timestamp">${messageDiv.querySelector('.timestamp').textContent}</span>
                    </div>
                    <div class="message-content">[æ¶ˆæ¯å·²æ’¤å›]</div>
                `;
            }
        });
        
        // æ¶ˆæ¯å·²è¯»é€šçŸ¥ï¼ˆæ™®é€šèŠå¤©ï¼‰
        socket.on('message-read-by-user', (data) => {
            const messageDiv = document.querySelector(`[data-message-id="${data.messageId}"]`);
            if (messageDiv) {
                const readStatusElement = messageDiv.querySelector('.read-status');
                if (readStatusElement) {
                    readStatusElement.textContent = 'âœ“âœ“';
                    readStatusElement.title = 'å·²è¯»';
                }
            }
        });
        
        // æ¶ˆæ¯å·²è¯»é€šçŸ¥ï¼ˆç§èŠï¼‰
        socket.on('private-message-read', (data) => {
            const messageDiv = document.querySelector(`[data-message-id="${data.messageId}"]`);
            if (messageDiv) {
                const readStatusElement = messageDiv.querySelector('.read-status');
                if (readStatusElement) {
                    readStatusElement.textContent = 'âœ“âœ“';
                    readStatusElement.title = 'å·²è¯»';
                }
            }
        });
        
        // å®æ—¶ç¿»è¯‘åŠŸèƒ½
        const supportedLanguages = [
            { code: 'zh-CN', name: 'ä¸­æ–‡' },
            { code: 'en', name: 'English' },
            { code: 'ja', name: 'æ—¥æœ¬èª' },
            { code: 'ko', name: 'í•œêµ­ì–´' },
            { code: 'fr', name: 'FranÃ§ais' },
            { code: 'de', name: 'Deutsch' },
            { code: 'es', name: 'EspaÃ±ol' },
            { code: 'ru', name: 'Ğ ÑƒÑÑĞºĞ¸Ğ¹' }
        ];
        
        let currentTargetLanguage = 'zh-CN'; // é»˜è®¤ç¿»è¯‘ä¸ºä¸­æ–‡
        
        // ç®€å•çš„è¯­è¨€æ£€æµ‹å‡½æ•°ï¼ˆåŸºäºå­—ç¬¦é›†å’Œå¸¸è§è¯æ±‡ï¼‰
        function detectLanguage(text) {
            // æ£€æµ‹ä¸­æ–‡
            if (/[\u4e00-\u9fa5]/.test(text)) {
                return 'zh-CN';
            }
            // æ£€æµ‹æ—¥æ–‡
            if (/[\u3040-\u30ff]/.test(text)) {
                return 'ja';
            }
            // æ£€æµ‹éŸ©æ–‡
            if (/[\uac00-\ud7af]/.test(text)) {
                return 'ko';
            }
            // æ£€æµ‹ä¿„æ–‡
            if (/[\u0400-\u04ff]/.test(text)) {
                return 'ru';
            }
            // æ£€æµ‹æ³•æ–‡
            if (/[Ã Ã¢Ã§Ã©Ã¨ÃªÃ«Ã®Ã¯Ã´Ã¹Ã»Ã¼Ã¿Ã±Ã¦Å“]/.test(text)) {
                return 'fr';
            }
            // æ£€æµ‹å¾·æ–‡
            if (/[Ã¤Ã¶Ã¼ÃŸ]/.test(text)) {
                return 'de';
            }
            // æ£€æµ‹è¥¿ç­ç‰™æ–‡
            if (/[Ã¡Ã©Ã­Ã³ÃºÃ¼Ã±]/.test(text)) {
                return 'es';
            }
            // é»˜è®¤è‹±æ–‡
            return 'en';
        }
        
        // æ¨¡æ‹Ÿç¿»è¯‘å‡½æ•°ï¼ˆå®é™…é¡¹ç›®ä¸­åº”æ›¿æ¢ä¸ºçœŸå®çš„ç¿»è¯‘APIï¼‰
        async function translateText(text, targetLanguage) {
            // è¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿç¿»è¯‘ï¼Œå®é™…é¡¹ç›®ä¸­åº”è°ƒç”¨çœŸå®çš„ç¿»è¯‘API
            // ä¾‹å¦‚ï¼šGoogle Translate API, DeepL API, ç™¾åº¦ç¿»è¯‘APIç­‰
            
            // æ¨¡æ‹Ÿç¿»è¯‘å»¶è¿Ÿ
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // æ£€æµ‹æºè¯­è¨€
            const sourceLanguage = detectLanguage(text);
            
            // å¦‚æœæºè¯­è¨€å’Œç›®æ ‡è¯­è¨€ç›¸åŒï¼Œç›´æ¥è¿”å›åŸæ–‡
            if (sourceLanguage === targetLanguage) {
                return text;
            }
            
            // ç®€å•çš„æ¨¡æ‹Ÿç¿»è¯‘ï¼ˆä»…ç”¨äºæ¼”ç¤ºï¼‰
            const mockTranslations = {
                // ä¸­æ–‡åˆ°å…¶ä»–è¯­è¨€
                'ä½ å¥½': {
                    'en': 'Hello',
                    'ja': 'ã“ã‚“ã«ã¡ã¯',
                    'ko': 'ì•ˆë…•í•˜ì„¸ìš”',
                    'fr': 'Bonjour',
                    'de': 'Hallo',
                    'es': 'Hola',
                    'ru': 'ĞŸÑ€Ğ¸Ğ²ĞµÑ‚'
                },
                'è°¢è°¢': {
                    'en': 'Thank you',
                    'ja': 'ã‚ã‚ŠãŒã¨ã†',
                    'ko': 'ê°ì‚¬í•©ë‹ˆë‹¤',
                    'fr': 'Merci',
                    'de': 'Danke',
                    'es': 'Gracias',
                    'ru': 'Ğ¡Ğ¿Ğ°ÑĞ¸Ğ±Ğ¾'
                },
                'å†è§': {
                    'en': 'Goodbye',
                    'ja': 'ã•ã‚ˆã†ãªã‚‰',
                    'ko': 'ì•ˆë…•íˆ ê°€ì„¸ìš”',
                    'fr': 'Au revoir',
                    'de': 'Auf Wiedersehen',
                    'es': 'AdiÃ³s',
                    'ru': 'Ğ”Ğ¾ ÑĞ²Ğ¸Ğ´Ğ°Ğ½Ğ¸Ñ'
                },
                // è‹±æ–‡åˆ°ä¸­æ–‡
                'Hello': {
                    'zh-CN': 'ä½ å¥½'
                },
                'Thank you': {
                    'zh-CN': 'è°¢è°¢'
                },
                'Goodbye': {
                    'zh-CN': 'å†è§'
                },
                // æ—¥æ–‡åˆ°ä¸­æ–‡
                'ã“ã‚“ã«ã¡ã¯': {
                    'zh-CN': 'ä½ å¥½'
                },
                'ã‚ã‚ŠãŒã¨ã†': {
                    'zh-CN': 'è°¢è°¢'
                },
                'ã•ã‚ˆã†ãªã‚‰': {
                    'zh-CN': 'å†è§'
                },
                // éŸ©æ–‡åˆ°ä¸­æ–‡
                'ì•ˆë…•í•˜ì„¸ìš”': {
                    'zh-CN': 'ä½ å¥½'
                },
                'ê°ì‚¬í•©ë‹ˆë‹¤': {
                    'zh-CN': 'è°¢è°¢'
                },
                'ì•ˆë…•íˆ ê°€ì„¸ìš”': {
                    'zh-CN': 'å†è§'
                }
            };
            
            // å¦‚æœæœ‰åŒ¹é…çš„æ¨¡æ‹Ÿç¿»è¯‘ï¼Œè¿”å›ç¿»è¯‘ç»“æœ
            if (mockTranslations[text] && mockTranslations[text][targetLanguage]) {
                return mockTranslations[text][targetLanguage];
            }
            
            // å¦åˆ™è¿”å›åŸæ–‡åŠ ä¸Šç¿»è¯‘æ ‡è®°ï¼ˆä»…ç”¨äºæ¼”ç¤ºï¼‰
            return `[${sourceLanguage} â†’ ${targetLanguage}]: ${text}`;
        }
        
        // ç¿»è¯‘æ¶ˆæ¯
        async function translateMessage(messageId, targetLanguage = currentTargetLanguage) {
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageDiv) return;
            
            const contentElement = messageDiv.querySelector('.message-content');
            const originalText = contentElement.textContent;
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯ç¿»è¯‘çŠ¶æ€
            if (originalText.startsWith('[')) {
                // æ¢å¤åŸæ–‡ï¼ˆéœ€è¦å­˜å‚¨åŸæ–‡ï¼Œè¿™é‡Œç®€åŒ–å¤„ç†ï¼‰
                contentElement.textContent = originalText.replace(/\[[^\]]+\]: /, '');
                return;
            }
            
            // æ˜¾ç¤ºç¿»è¯‘ä¸­çŠ¶æ€
            contentElement.textContent = 'æ­£åœ¨ç¿»è¯‘...';
            
            try {
                // è°ƒç”¨ç¿»è¯‘å‡½æ•°ï¼Œè‡ªåŠ¨æ£€æµ‹æºè¯­è¨€ï¼Œç¿»è¯‘ä¸ºä¸­æ–‡
                const translatedText = await translateText(originalText, targetLanguage);
                contentElement.textContent = translatedText;
            } catch (error) {
                console.error('ç¿»è¯‘å¤±è´¥:', error);
                contentElement.textContent = originalText;
                alert('ç¿»è¯‘å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // æœç´¢åŠŸèƒ½
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.trim().toLowerCase();
            currentSearchTerm = searchTerm;
            
            if (searchTerm === '') {
                updateUserList(allUsers);
                return;
            }
            
            const filteredUsers = allUsers.filter(user => 
                user.username.toLowerCase().includes(searchTerm)
            );
            
            updateUserList(filteredUsers);
        });
        
        // ç”¨æˆ·åˆ—è¡¨åŠŸèƒ½
        
        // æ‰“å¼€ç”¨æˆ·åˆ—è¡¨
        usersBtn.addEventListener('click', () => {
            usersModal.classList.add('active');
        });
        
        // å…³é—­ç”¨æˆ·åˆ—è¡¨
        function closeUsersModal() {
            usersModal.classList.remove('active');
        }
        
        // å¥½å‹ç³»ç»ŸåŠŸèƒ½
        
        // æ‰“å¼€å¥½å‹åˆ—è¡¨
        friendsBtn.addEventListener('click', () => {
            socket.emit('get-friends');
            friendsModal.classList.add('active');
        });
        
        // å…³é—­å¥½å‹åˆ—è¡¨
        function closeFriendsModal() {
            friendsModal.classList.remove('active');
        }
        
        // å…³é—­ç§èŠæ¨¡æ€æ¡†
        function closePrivateChatModal() {
            privateChatModal.classList.remove('active');
            currentPrivateChatTarget = null;
        }
        
        // å‘é€ç§èŠæ¶ˆæ¯
        privateChatSendBtn.addEventListener('click', () => {
            const message = privateChatInput.value.trim();
            if (message && currentPrivateChatTarget) {
                socket.emit('private-message', {
                    targetSocketId: currentPrivateChatTarget,
                    message: message,
                    type: 'text'
                });
                privateChatInput.value = '';
            }
        });
        
        privateChatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                privateChatSendBtn.click();
            }
        });
        
        // ç§èŠå‘é€å›¾ç‰‡
        privateChatImageBtn.addEventListener('click', () => {
            privateChatImageInput.click();
        });
        
        privateChatImageInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file && currentPrivateChatTarget) {
                if (!userPermissions.allowImage) {
                    alert('æ‚¨æ²¡æœ‰å‘é€å›¾ç‰‡çš„æƒé™');
                    privateChatImageInput.value = '';
                    return;
                }
                try {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const arrayBuffer = event.target.result;
                        const response = await fetch('/upload-image', {
                            method: 'POST',
                            body: arrayBuffer,
                            headers: {
                                'Content-Type': file.type
                            }
                        });
                        const data = await response.json();
                        
                        if (data.imageUrl) {
                            socket.emit('private-message', {
                                targetSocketId: currentPrivateChatTarget,
                                message: data.imageUrl,
                                type: 'image'
                            });
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } catch (error) {
                    console.error('ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', error);
                    alert('ä¸Šä¼ å›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
                
                privateChatImageInput.value = '';
            }
        });
        
        // ç§èŠå‘é€è¯­éŸ³
        let privateChatMediaRecorder = null;
        let privateChatAudioChunks = [];
        let privateChatIsRecording = false;
        
        privateChatAudioBtn.addEventListener('click', async () => {
            if (!userPermissions.allowAudio) {
                alert('æ‚¨æ²¡æœ‰å‘é€è¯­éŸ³çš„æƒé™');
                return;
            }
            
            if (!privateChatIsRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    privateChatMediaRecorder = new MediaRecorder(stream);
                    privateChatAudioChunks = [];
                    
                    privateChatMediaRecorder.ondataavailable = (event) => {
                        privateChatAudioChunks.push(event.data);
                    };
                    
                    privateChatMediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(privateChatAudioChunks, { type: 'audio/webm' });
                        
                        try {
                            const response = await fetch('/upload-audio', {
                                method: 'POST',
                                body: audioBlob,
                                headers: {
                                    'Content-Type': 'audio/webm'
                                }
                            });
                            
                            if (!response.ok) {
                                throw new Error(`ç½‘ç»œå“åº”é”™è¯¯: ${response.statusText}`);
                            }
                            
                            const data = await response.json();
                            
                            if (data.audioUrl) {
                                socket.emit('private-message', {
                                    targetSocketId: currentPrivateChatTarget,
                                    message: data.audioUrl,
                                    type: 'audio'
                                });
                            }
                        } catch (error) {
                            console.error('ä¸Šä¼ è¯­éŸ³å¤±è´¥:', error);
                            alert('ä¸Šä¼ è¯­éŸ³å¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                        
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    privateChatMediaRecorder.start();
                    privateChatIsRecording = true;
                    privateChatAudioBtn.classList.add('recording');
                    privateChatAudioBtn.title = 'åœæ­¢å½•åˆ¶';
                } catch (error) {
                    console.error('æ— æ³•è®¿é—®éº¦å…‹é£:', error);
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                }
            } else {
                privateChatMediaRecorder.stop();
                privateChatIsRecording = false;
                privateChatAudioBtn.classList.remove('recording');
                privateChatAudioBtn.title = 'å‘é€è¯­éŸ³';
            }
        });
        
        // æ‰“å¼€ç§èŠ
        function openPrivateChat(friendSocketId, friendUsername) {
            currentPrivateChatTarget = friendSocketId;
            privateChatTitle.textContent = `ä¸ ${friendUsername} ç§èŠ`;
            privateChatMessagesDiv.innerHTML = '';
            
            // è·å–ç§èŠå†å²æ¶ˆæ¯
            socket.emit('get-private-messages', friendSocketId);
            
            privateChatModal.classList.add('active');
        }
        
        // æ·»åŠ å¥½å‹
        function addFriend(targetSocketId) {
            socket.emit('add-friend', targetSocketId);
        }
        
        // åˆ é™¤å¥½å‹
        function removeFriend(friendSocketId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¥½å‹å—ï¼Ÿ')) {
                socket.emit('remove-friend', friendSocketId);
            }
        }
        
        // Socketäº‹ä»¶å¤„ç† - å¥½å‹ç³»ç»Ÿ
        
        // å¥½å‹åˆ—è¡¨
        socket.on('friends-list', (data) => {
            friends = data;
            updateFriendsList(data);
        });
        
        // å¥½å‹è¯·æ±‚
        socket.on('friend-request', (data) => {
            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'system-message';
            notificationDiv.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>${escapeHtml(data.fromUsername)}</strong> è¯·æ±‚æ·»åŠ ä½ ä¸ºå¥½å‹
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-confirm" onclick="socket.emit('accept-friend', '${data.fromSocketId}'); this.parentElement.parentElement.parentElement.remove();">æ¥å—</button>
                    <button class="btn btn-cancel" onclick="socket.emit('reject-friend', '${data.fromSocketId}'); this.parentElement.parentElement.parentElement.remove();">æ‹’ç»</button>
                </div>
            `;
            messagesDiv.appendChild(notificationDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
        
        // å¥½å‹è¯·æ±‚è¢«æ¥å—
        socket.on('friend-accepted', (data) => {
            alert(`ä½ å·²æˆåŠŸæ·»åŠ  ${data.friendUsername} ä¸ºå¥½å‹`);
            socket.emit('get-friends');
        });
        
        // å¥½å‹è¯·æ±‚è¢«æ‹’ç»
        socket.on('friend-rejected', (data) => {
            alert(`${data.friendUsername} æ‹’ç»äº†ä½ çš„å¥½å‹è¯·æ±‚`);
        });
        
        // å¥½å‹è¢«æ·»åŠ 
        socket.on('friend-added', (data) => {
            alert(`${data.friendUsername} å·²æ·»åŠ ä½ ä¸ºå¥½å‹`);
            socket.emit('get-friends');
        });
        
        // å¥½å‹è¢«åˆ é™¤
        socket.on('friend-removed', (data) => {
            alert(`ä½ å·²åˆ é™¤å¥½å‹ ${data.friendUsername || 'å¯¹æ–¹'}`);
            socket.emit('get-friends');
        });
        
        // ç§èŠæ¶ˆæ¯
        socket.on('private-message', (data) => {
            addPrivateMessage(data);
        });
        
        // ç§èŠå†å²æ¶ˆæ¯
        socket.on('private-messages-history', (data) => {
            data.messages.forEach(message => {
                addPrivateMessage(message);
            });
        });
        
        // å¥½å‹é”™è¯¯
        socket.on('friend-error', (data) => {
            alert(data.message);
        });
        
        // @é€šçŸ¥
        socket.on('mention-notification', (data) => {
            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'system-message mention';
            notificationDiv.innerHTML = `
                <strong>${escapeHtml(data.fromUsername)}</strong> @äº†ä½ ï¼š${escapeHtml(data.message)}
                <div style="font-size: 12px; color: #999; margin-top: 5px;">${data.timestamp}</div>
            `;
            messagesDiv.appendChild(notificationDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // æ’­æ”¾æç¤ºéŸ³
            const audio = new Audio('/notification.mp3');
            audio.play().catch(() => {});
        });
        
        // æ›´æ–°å¥½å‹åˆ—è¡¨
        function updateFriendsList(friends) {
            friendsListDiv.innerHTML = '';
            
            if (friends.length === 0) {
                friendsListDiv.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— å¥½å‹</div>';
                return;
            }
            
            friends.forEach(friend => {
                const friendDiv = document.createElement('div');
                friendDiv.className = 'friend-item';
                friendDiv.onclick = function() {
                    const friendItems = document.querySelectorAll('.friend-item');
                    friendItems.forEach(item => {
                        item.classList.remove('expanded');
                    });
                    this.classList.toggle('expanded');
                };
                
                friendDiv.innerHTML = `
                    <div class="friend-color" style="background: ${friend.color}"></div>
                    <div class="friend-info">
                        <div class="friend-name">${escapeHtml(friend.username)}</div>
                        <div class="friend-status">${friend.online ? 'åœ¨çº¿' : 'ç¦»çº¿'}</div>
                    </div>
                    <div class="friend-actions">
                        <button class="friend-btn" onclick="event.stopPropagation(); openPrivateChat('${friend.socketId}', '${friend.username}')">ğŸ’¬</button>
                        <button class="friend-btn danger" onclick="event.stopPropagation(); removeFriend('${friend.socketId}')">ğŸ—‘ï¸</button>
                    </div>
                `;
                
                friendsListDiv.appendChild(friendDiv);
            });
        }
        
        // æ·»åŠ ç§èŠæ¶ˆæ¯
        function addPrivateMessage(data) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'private-chat-message' + (data.fromSocketId === socket.id ? ' sent' : '');
            messageDiv.dataset.messageId = data.id;
            
            let contentHtml;
            if (data.type === 'image') {
                contentHtml = `<img src="${data.message}" alt="å›¾ç‰‡" style="max-width: 100%; max-height: 200px; border-radius: 5px;">`;
            } else if (data.type === 'audio') {
                contentHtml = `<audio controls style="width: 100%; border-radius: 5px;"><source src="${data.message}" type="audio/webm">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾</audio>`;
            } else {
                contentHtml = escapeHtml(data.message);
            }
            
            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²æ”¶è—
            const isFavorited = isMessageFavorited(data.id);
            
            let actionsHtml = `
                <div class="message-actions">
                    <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" onclick="toggleFavorite('${data.id}')" title="${isFavorited ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—æ¶ˆæ¯'}">â­</button>
                    <button class="translate-btn" onclick="translateMessage('${data.id}', currentTargetLanguage)" title="ç¿»è¯‘æ¶ˆæ¯">ğŸŒ</button>
                </div>
            `;
            
            // æ·»åŠ å·²è¯»çŠ¶æ€æ˜¾ç¤º
            const isRead = data.readBy && data.readBy.length > 1;
            const readStatusHtml = `<span class="read-status" ${isRead ? 'title="å·²è¯»"' : 'title="æœªè¯»"'}>${isRead ? 'âœ“âœ“' : 'âœ“'}</span>`;
            
            messageDiv.innerHTML = `
                <div class="private-chat-message-header">
                    ${data.fromSocketId === socket.id ? 'æˆ‘' : data.fromUsername} - ${data.timestamp}
                    ${data.fromSocketId === socket.id ? readStatusHtml : ''}
                </div>
                <div class="message-content">${contentHtml}</div>
                ${actionsHtml}
            `;
            
            privateChatMessagesDiv.appendChild(messageDiv);
            privateChatMessagesDiv.scrollTop = privateChatMessagesDiv.scrollHeight;
            
            // å‘é€å·²è¯»é€šçŸ¥ï¼ˆéè‡ªå·±å‘é€çš„æ¶ˆæ¯ï¼‰
            if (data.fromSocketId !== socket.id && data.id) {
                socket.emit('message-read', {
                    messageId: data.id,
                    chatId: data.chatId
                });
            }
        }
        
        // ç®¡ç†å‘˜é¢æ¿åŠŸèƒ½
        
        // æ‰“å¼€ç®¡ç†å‘˜é¢æ¿
        adminPanelBtn.addEventListener('click', () => {
            // åªæœ‰adminå’Œsuperadminè§’è‰²æ‰èƒ½æ‰“å¼€ç®¡ç†å‘˜é¢æ¿
            if (userRole === 'user') {
                alert('æ‚¨æ²¡æœ‰æƒé™è®¿é—®ç®¡ç†å‘˜é¢æ¿');
                return;
            }
            
            adminPanelModal.classList.add('active');
            
            // è·å–ç”¨æˆ·åˆ—è¡¨
            socket.emit('admin-get-users');
            
            // è·å–æˆ¿é—´åˆ—è¡¨
            socket.emit('admin-get-rooms');
        });
        
        // å…³é—­ç®¡ç†å‘˜é¢æ¿
        function closeAdminPanelModal() {
            adminPanelModal.classList.remove('active');
        }
        
        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰activeç±»
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
                
                // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾
                tab.classList.add('active');
                const tabName = tab.dataset.tab;
                document.getElementById(tabName + 'Tab').classList.add('active');
                
                // æ ¹æ®æ ‡ç­¾é¡µåŠ è½½ç›¸åº”æ•°æ®
                if (tabName === 'rooms') {
                    socket.emit('admin-get-rooms');
                } else if (tabName === 'messages') {
                    socket.emit('admin-get-messages');
                } else if (tabName === 'friends') {
                    socket.emit('admin-get-users');
                }
            });
        });
        
        // @åŠŸèƒ½å¼€å…³
        document.getElementById('allowMentionsCheckbox').addEventListener('change', (e) => {
            socket.emit('admin-set-mentions', {
                allow: e.target.checked
            });
        });
        
        // Socketäº‹ä»¶å¤„ç† - ç®¡ç†å‘˜é¢æ¿
        
        // ç”¨æˆ·è§’è‰²å˜æ›´
        socket.on('user-role-changed', (data) => {
            if (data.socketId === socket.id) {
                userRole = data.newRole;
                
                // å¦‚æœè§’è‰²å˜ä¸ºuserï¼Œéšè—ç®¡ç†å‘˜é¢æ¿æŒ‰é’®
                if (userRole === 'user') {
                    adminPanelBtn.style.display = 'none';
                } else {
                    adminPanelBtn.style.display = 'block';
                }
            }
            
            // æ›´æ–°ç®¡ç†å‘˜é¢æ¿ä¸­çš„ç”¨æˆ·åˆ—è¡¨
            updateAdminUsersList(data.users);
        });
        
        // è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆç”¨äºç®¡ç†å‘˜é¢æ¿çš„å¥½å‹ç®¡ç†æ ‡ç­¾é¡µï¼‰
        socket.on('admin-get-users', (data) => {
            updateAdminFriendsList(data.users);
        });
        
        // æ›´æ–°ç®¡ç†å‘˜ç”¨æˆ·åˆ—è¡¨
        function updateAdminUsersList(users) {
            adminUsersListDiv.innerHTML = '';
            
            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'admin-user-item';
                
                userDiv.innerHTML = `
                    <div class="admin-user-info">
                        <div class="admin-user-name">${escapeHtml(user.username)}</div>
                        <span class="admin-user-role ${user.role}">${user.role}</span>
                    </div>
                    <div class="admin-user-actions">
                        <select class="admin-select" onchange="changeUserRole('${user.socketId}', this.value)">
                            <option value="user" ${user.role === 'user' ? 'selected' : ''}>user</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>admin</option>
                            <option value="superadmin" ${user.role === 'superadmin' ? 'selected' : ''}>superadmin</option>
                        </select>
                        <button class="admin-action-btn" onclick="adminPrivateChat('${user.socketId}', '${user.username}')">ç§èŠ</button>
                        <button class="admin-action-btn danger" onclick="kickUser('${user.socketId}')">è¸¢å‡º</button>
                    </div>
                `;
                
                adminUsersListDiv.appendChild(userDiv);
            });
        }
        
        // æ›´æ–°ç®¡ç†å‘˜å¥½å‹åˆ—è¡¨ï¼ˆæ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·ï¼‰
        function updateAdminFriendsList(users) {
            adminFriendsListDiv.innerHTML = '';
            
            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'admin-user-item';
                
                userDiv.innerHTML = `
                    <div class="admin-user-info">
                        <div class="admin-user-name">${escapeHtml(user.username)}</div>
                        <span class="admin-user-role ${user.role}">${user.role}</span>
                    </div>
                    <div class="admin-user-actions">
                        <button class="admin-action-btn" onclick="adminPrivateChat('${user.socketId}', '${user.username}')">ç§èŠ</button>
                        <button class="admin-action-btn" onclick="openPrivateChat('${user.socketId}', '${user.username}')">æŸ¥çœ‹ç§èŠ</button>
                    </div>
                `;
                
                adminFriendsListDiv.appendChild(userDiv);
            });
        }
        
        // æ›´æ”¹ç”¨æˆ·è§’è‰²
        function changeUserRole(socketId, newRole) {
            socket.emit('admin-set-role', {
                socketId: socketId,
                role: newRole
            });
        }
        
        // ä¿®æ”¹ç”¨æˆ·æƒé™
        function changeUserPermissions(socketId, permissionKey, value) {
            const user = allUsers.find(u => u.socketId === socketId);
            if (user) {
                const newPermissions = { ...user.permissions };
                newPermissions[permissionKey] = value;
                
                socket.emit('admin-set-permissions', {
                    socketId: socketId,
                    permissions: newPermissions
                });
            }
        }
        
        // è¸¢å‡ºç”¨æˆ·
        function kickUser(socketId) {
            if (confirm('ç¡®å®šè¦è¸¢å‡ºè¿™ä¸ªç”¨æˆ·å—ï¼Ÿ')) {
                socket.emit('admin-kick-user', socketId);
            }
        }
        
        // ç®¡ç†å‘˜ç§èŠ
        function adminPrivateChat(socketId, username) {
            const message = prompt(`å‘é€ç§èŠæ¶ˆæ¯ç»™ ${username}ï¼š`);
            if (message) {
                socket.emit('admin-private-message', {
                    targetSocketId: socketId,
                    message: message,
                    type: 'text'
                });
            }
        }
        
        // æˆ¿é—´åŠ å…¥å¤±è´¥
        socket.on('join-error', (data) => {
            alert(data.message);
        });
        
        // æˆ¿é—´å˜æ›´é€šçŸ¥
        socket.on('room-changed', (data) => {
            currentRoom = data.roomName;
            // æ¸…ç©ºæ¶ˆæ¯åˆ—è¡¨
            messagesDiv.innerHTML = '<div class="system-message">' + data.message + '</div>';
            // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
            updateUserList([]);
        });
        
        // æˆ¿é—´å†å²æ¶ˆæ¯
        socket.on('room-history', (data) => {
            // æ¸…ç©ºå½“å‰æ¶ˆæ¯
            messagesDiv.innerHTML = '';
            // æ·»åŠ å†å²æ¶ˆæ¯
            data.messages.forEach(message => {
                addMessage(message);
            });
        });

        function recallMessage(messageId) {
            socket.emit('message-recall', messageId);
        }

        function addMessage(data) {
            // ä¿å­˜æ¶ˆæ¯åˆ°å†å²è®°å½•æ•°ç»„
            allMessages.push(data);
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.dataset.messageId = data.id;
            
            let contentHtml;
            if (data.type === 'image') {
                contentHtml = `<img src="${data.message}" alt="å›¾ç‰‡" style="max-width: 100%; max-height: 200px; border-radius: 5px;">`;
            } else if (data.type === 'audio') {
                contentHtml = `<audio controls style="width: 100%; border-radius: 5px;"><source src="${data.message}" type="audio/webm">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾</think_never_used_51bce0c785ca2f68081bfa7d91973934>`;
            } else {
                // å¦‚æœæ­£åœ¨æœç´¢ï¼Œé«˜äº®æ˜¾ç¤ºæœç´¢å…³é”®è¯
                contentHtml = escapeHtml(data.message);
                if (isSearching && searchKeyword) {
                    const regex = new RegExp(`(${escapeRegExp(searchKeyword)})`, 'gi');
                    contentHtml = contentHtml.replace(regex, '<span style="background-color: #ffeb3b; font-weight: bold;">$1</span>');
                }
            }
            
            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²æ”¶è—
            const isFavorited = isMessageFavorited(data.id);
            
            let actionsHtml = `
                <div class="message-actions">
                    <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" onclick="toggleFavorite('${data.id}')" title="${isFavorited ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—æ¶ˆæ¯'}">â­</button>
                    <button class="translate-btn" onclick="translateMessage('${data.id}', currentTargetLanguage)" title="ç¿»è¯‘æ¶ˆæ¯">ğŸŒ</button>
                    ${data.username === username ? `<button class="recall-btn" onclick="recallMessage('${data.id}')">æ’¤å›</button>` : ''}
                </div>
            `;
            
            // æ·»åŠ å·²è¯»çŠ¶æ€æ˜¾ç¤º
            const isRead = data.readBy && data.readBy.length > 1;
            const readStatusHtml = `<span class="read-status" ${isRead ? 'title="å·²è¯»"' : 'title="æœªè¯»"'}>${isRead ? 'âœ“âœ“' : 'âœ“'}</span>`;
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="username" style="color: ${data.color}">${data.username}</span>
                    <span class="timestamp">${data.timestamp}</span>
                    ${data.username === username ? readStatusHtml : ''}
                </div>
                <div class="message-content">${contentHtml}</div>
                ${actionsHtml}
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // å‘é€å·²è¯»é€šçŸ¥ï¼ˆéè‡ªå·±å‘é€çš„æ¶ˆæ¯ï¼‰
            if (data.username !== username && data.id) {
                socket.emit('message-read', {
                    messageId: data.id,
                    roomName: currentRoom || 'main'
                });
            }
        }

        function addSystemMessage(text, isAdmin = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'system-message' + (isAdmin ? ' admin' : '');
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateUserList(users) {
            allUsers = users;
            searchResults = users;
            usersListDiv.innerHTML = '';
            
            if (users.length === 0) {
                usersListDiv.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— åœ¨çº¿ç”¨æˆ·</div>';
                return;
            }
            
            users.forEach(user => {
                const status = user.status || 'online'; // é»˜è®¤åœ¨çº¿
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item';
                userDiv.onclick = () => {
                    showUserDetail(user.socketId, user.username, user.color, JSON.stringify(user.permissions).replace(/"/g, '&quot;'));
                };
                
                userDiv.innerHTML = `
                    <div class="status-indicator status-${status}"></div>
                    <div class="user-color" style="background: ${user.color}"></div>
                    <div class="user-name">${escapeHtml(user.username)}</div>
                `;
                
                usersListDiv.appendChild(userDiv);
            });
        }

        // å¤„ç†ç”¨æˆ·çŠ¶æ€å˜åŒ–
        socket.on('user-status-changed', (data) => {
            // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
            if (data.roomName === currentRoom) {
                // å¦‚æœæ˜¯å½“å‰æˆ¿é—´çš„ç”¨æˆ·çŠ¶æ€å˜åŒ–ï¼Œæ›´æ–°ç”¨æˆ·åˆ—è¡¨
                const updatedUser = allUsers.find(user => user.socketId === data.socketId);
                if (updatedUser) {
                    updatedUser.status = data.status;
                    updateUserList(allUsers);
                }
            }
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // è½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // æœç´¢æ¶ˆæ¯
        function searchMessages(keyword) {
            searchKeyword = keyword;
            if (!keyword) {
                isSearching = false;
                // æ¸…ç©ºæœç´¢çŠ¶æ€ï¼Œé‡æ–°æ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯
                messagesDiv.innerHTML = '<div class="system-message">æ¬¢è¿æ¥åˆ°èŠå¤©å®¤ï¼è¯·è¾“å…¥æ˜µç§°åŠ å…¥ã€‚</div>';
                allMessages.forEach(message => {
                    addMessage(message);
                });
                return;
            }
            
            isSearching = true;
            const searchResults = allMessages.filter(message => {
                if (message.type === 'text') {
                    return message.message.toLowerCase().includes(keyword.toLowerCase());
                }
                return false;
            });
            
            // æ¸…ç©ºæ¶ˆæ¯åŒºåŸŸ
            messagesDiv.innerHTML = `<div class="system-message">æœç´¢ç»“æœ: ${searchResults.length} æ¡</div>`;
            
            // æ˜¾ç¤ºæœç´¢ç»“æœ
            searchResults.forEach(message => {
                addMessage(message);
            });
        }
        
        // æ¶ˆæ¯æœç´¢è¾“å…¥äº‹ä»¶ç›‘å¬
        messageSearchInput.addEventListener('input', (e) => {
            searchMessages(e.target.value);
        });

        // åª’ä½“å½•åˆ¶å™¨
        mediaRecorder = null;
        let mediaChunks = [];
        isRecording = false;
        let isDeviceSelectModalOpen = false;
        
        // åª’ä½“æºå’Œç¼“å†²åŒº
        let mediaSource = null;
        let sourceBuffer = null;
        let audioContext = null;
        let audioSource = null;
        let audioBuffer = null;
        let audioElement = null;
        
        // å½“å‰åª’ä½“URL
        let currentMediaUrl = null;
        
        // åª’ä½“æ•°æ®é˜Ÿåˆ—
        let mediaDataQueue = [];
        
        // è¿œç¨‹è§†é¢‘å’ŒéŸ³é¢‘ç¼“å†²åŒº
        remoteVideoBuffer = null;
        let remoteAudioBuffer = null;
        let remoteAudioIsPlaying = false;
        
        // æ¥æ”¶æ•°æ®é˜Ÿåˆ—
        let receiveDataQueue = [];
        let isAppending = false;

        // å¼€å§‹è§†é¢‘é€šè¯
        async function startVideoCall(targetSocketId, targetUsername) {
            if (!userPermissions.allowCall) {
                alert('æ‚¨æ²¡æœ‰é€šè¯æƒé™');
                return;
            }
            
            isVideoCall = true;
            currentCallId = Date.now().toString();
            
            try {
                // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåª’ä½“è®¾å¤‡è®¿é—®');
                }
                
                // è·å–å¯ç”¨è®¾å¤‡
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                const audioDevices = devices.filter(device => device.kind === 'audioinput');
                
                console.log('å¯ç”¨è§†é¢‘è®¾å¤‡:', videoDevices);
                console.log('å¯ç”¨éŸ³é¢‘è®¾å¤‡:', audioDevices);
                
                if (videoDevices.length === 0) {
                    throw new Error('æœªæ£€æµ‹åˆ°æ‘„åƒå¤´è®¾å¤‡');
                }
                
                if (audioDevices.length === 0) {
                    throw new Error('æœªæ£€æµ‹åˆ°éº¦å…‹é£è®¾å¤‡');
                }
                
                // å¦‚æœæœ‰å¤šä¸ªè®¾å¤‡ï¼Œæ˜¾ç¤ºè®¾å¤‡é€‰æ‹©ç•Œé¢
                if (videoDevices.length > 1 || audioDevices.length > 1) {
                    availableVideoDevices = videoDevices;
                    availableAudioDevices = audioDevices;
                    selectedVideoDeviceId = videoDevices[0].deviceId;
                    selectedAudioDeviceId = audioDevices[0].deviceId;
                    pendingCallAction = { type: 'video', targetSocketId, targetUsername };
                    showDeviceSelectModal();
                    return;
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true
                    },
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });
                
                localStream = stream;
                localVideo.srcObject = stream;
                
                // è®¾ç½®ç›®æ ‡Socket ID
                currentTargetSocketId = targetSocketId;
                
                socket.emit('call-request', {
                    targetSocketId: targetSocketId,
                    callId: currentCallId,
                    type: 'video',
                    fromUsername: username
                });
                
                videoContainer.classList.add('active');
                addSystemMessage(`æ­£åœ¨å‘ ${targetUsername} å‘èµ·è§†é¢‘é€šè¯...`);
            } catch (error) {
                console.error('è·å–æ‘„åƒå¤´å¤±è´¥:', error);
                let errorMessage = 'æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage = 'æ‚¨æ‹’ç»äº†æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸è®¿é—®';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'æœªæ‰¾åˆ°æ‘„åƒå¤´æˆ–éº¦å…‹é£è®¾å¤‡';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'æ— æ³•è¯»å–æ‘„åƒå¤´æˆ–éº¦å…‹é£æ•°æ®';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                alert(errorMessage);
            }
        }

        // å¼€å§‹è¯­éŸ³é€šè¯
        async function startAudioCall(targetSocketId, targetUsername) {
            if (!userPermissions.allowCall) {
                alert('æ‚¨æ²¡æœ‰é€šè¯æƒé™');
                return;
            }
            
            isVideoCall = false;
            currentCallId = Date.now().toString();
            currentTargetSocketId = targetSocketId;
            
            try {
                // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåª’ä½“è®¾å¤‡è®¿é—®');
                }
                
                // è·å–å¯ç”¨è®¾å¤‡
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioDevices = devices.filter(device => device.kind === 'audioinput');
                
                console.log('å¯ç”¨éŸ³é¢‘è®¾å¤‡:', audioDevices);
                
                if (audioDevices.length === 0) {
                    throw new Error('æœªæ£€æµ‹åˆ°éº¦å…‹é£è®¾å¤‡');
                }
                
                // å¦‚æœæœ‰å¤šä¸ªè®¾å¤‡ï¼Œæ˜¾ç¤ºè®¾å¤‡é€‰æ‹©ç•Œé¢
                if (audioDevices.length > 1) {
                    availableVideoDevices = [];
                    availableAudioDevices = audioDevices;
                    selectedVideoDeviceId = null;
                    selectedAudioDeviceId = audioDevices[0].deviceId;
                    pendingCallAction = { type: 'audio', targetSocketId, targetUsername };
                    showDeviceSelectModal();
                    return;
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                localStream = stream;
                
                // ä¸è¦ç«‹å³å¼€å§‹å½•åˆ¶ï¼Œç­‰å¾…å¯¹æ–¹æ¥å—é€šè¯åå†å¼€å§‹
                // startMediaRecording(stream);
                
                socket.emit('call-request', {
                    targetSocketId: targetSocketId,
                    callId: currentCallId,
                    type: 'audio',
                    fromUsername: username
                });
                
                videoContainer.classList.add('active');
                addSystemMessage(`æ­£åœ¨å‘ ${targetUsername} å‘èµ·è¯­éŸ³é€šè¯...`);
            } catch (error) {
                console.error('è·å–éº¦å…‹é£å¤±è´¥:', error);
                let errorMessage = 'æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage = 'æ‚¨æ‹’ç»äº†éº¦å…‹é£æƒé™ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸è®¿é—®';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'æ— æ³•è¯»å–éº¦å…‹é£æ•°æ®';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                alert(errorMessage);
            }
        }

        // å¼€å§‹åª’ä½“å½•åˆ¶
        function startMediaRecording(stream) {
            mediaChunks = [];
            
            // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒçš„ MIME ç±»å‹ï¼Œä¼˜å…ˆä½¿ç”¨ mp4 æ ¼å¼
            let mimeType;
            if (isVideoCall) {
                const videoTypes = [
                    'video/mp4',
                    'video/webm',
                    'video/webm;codecs=vp9,opus',
                    'video/webm;codecs=vp8,opus',
                    'video/webm;codecs=h264'
                ];
                mimeType = videoTypes.find(type => MediaRecorder.isTypeSupported(type)) || 'video/webm';
            } else {
                const audioTypes = [
                    'audio/mp4',
                    'audio/webm',
                    'audio/webm;codecs=opus',
                    'audio/ogg;codecs=opus'
                ];
                mimeType = audioTypes.find(type => MediaRecorder.isTypeSupported(type)) || 'audio/webm';
            }
            
            console.log('ä½¿ç”¨çš„ MIME ç±»å‹:', mimeType);
            
            mediaRecorder = new MediaRecorder(stream, { 
                mimeType,
                videoBitsPerSecond: isVideoCall ? 500000 : undefined
            });
            
            mediaRecorder.ondataavailable = async (event) => {
                if (event.data && event.data.size > 0) {
                    try {
                        // å°†Blobè½¬æ¢ä¸ºUint8Array
                        const arrayBuffer = await event.data.arrayBuffer();
                        const uint8Array = new Uint8Array(arrayBuffer);
                        
                        // é€šè¿‡Socket.ioå‘é€åª’ä½“æ•°æ®
                        socket.emit('call-media', {
                            targetSocketId: currentTargetSocketId,
                            callId: currentCallId,
                            type: isVideoCall ? 'video' : 'audio',
                            mimeType: mimeType,
                            data: uint8Array
                        });
                    } catch (error) {
                        console.error('å‘é€åª’ä½“æ•°æ®å¤±è´¥:', error);
                    }
                }
            };
            
            mediaRecorder.start(50); // æ¯50mså‘é€ä¸€æ¬¡æ•°æ®
            isRecording = true;
        }

        // åœæ­¢åª’ä½“å½•åˆ¶
        function stopMediaRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
            }
            
            // æ¸…ç† MediaSource å’Œ SourceBuffer
            if (sourceBuffer) {
                try {
                    sourceBuffer.abort();
                } catch (e) {
                    console.error('ä¸­æ­¢ SourceBuffer å¤±è´¥:', e);
                }
                sourceBuffer = null;
            }
            
            if (mediaSource) {
                try {
                    if (mediaSource.readyState === 'open') {
                        mediaSource.endOfStream();
                    }
                } catch (e) {
                    console.error('ç»“æŸ MediaStream å¤±è´¥:', e);
                }
                
                try {
                    URL.revokeObjectURL(remoteVideo.src);
                    if (audioElement) {
                        URL.revokeObjectURL(audioElement.src);
                    }
                } catch (e) {
                    console.error('é‡Šæ”¾ URL å¤±è´¥:', e);
                }
                mediaSource = null;
            }
            
            if (audioElement) {
                audioElement = null;
            }
            
            // æ¸…ç†å½“å‰çš„åª’ä½“URL
            if (currentMediaUrl) {
                try {
                    URL.revokeObjectURL(currentMediaUrl);
                } catch (e) {
                    console.error('é‡Šæ”¾ URL å¤±è´¥:', e);
                }
                currentMediaUrl = null;
            }
        }

        // æ¥å—é€šè¯
        async function acceptCall() {
            callIncoming.classList.remove('active');
            
            try {
                // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåª’ä½“è®¾å¤‡è®¿é—®');
                }
                
                // è·å–å¯ç”¨è®¾å¤‡
                const devices = await navigator.mediaDevices.enumerateDevices();
                
                if (isVideoCall) {
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    const audioDevices = devices.filter(device => device.kind === 'audioinput');
                    
                    console.log('å¯ç”¨è§†é¢‘è®¾å¤‡:', videoDevices);
                    console.log('å¯ç”¨éŸ³é¢‘è®¾å¤‡:', audioDevices);
                    
                    if (videoDevices.length === 0) {
                        throw new Error('æœªæ£€æµ‹åˆ°æ‘„åƒå¤´è®¾å¤‡');
                    }
                    
                    if (audioDevices.length === 0) {
                        throw new Error('æœªæ£€æµ‹åˆ°éº¦å…‹é£è®¾å¤‡');
                    }
                    
                    // å¦‚æœæœ‰å¤šä¸ªè®¾å¤‡ï¼Œæ˜¾ç¤ºè®¾å¤‡é€‰æ‹©ç•Œé¢
                    if (videoDevices.length > 1 || audioDevices.length > 1) {
                        availableVideoDevices = videoDevices;
                        availableAudioDevices = audioDevices;
                        selectedVideoDeviceId = videoDevices[0].deviceId;
                        selectedAudioDeviceId = audioDevices[0].deviceId;
                        // è®¾ç½®pendingCallActionï¼Œç”¨äºè®¾å¤‡é€‰æ‹©åçš„é€šè¯æµç¨‹
                        pendingCallAction = { 
                            type: 'video', 
                            isAcceptingCall: true,
                            targetSocketId: currentCallerSocketId,
                            targetUsername: 'å¯¹æ–¹'
                        };
                        showDeviceSelectModal();
                        return;
                    }
                    
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true
                        },
                        video: {
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'user'
                        }
                    });
                    
                    localStream = stream;
                    localVideo.srcObject = stream;
                    
                    // æ¥å—é€šè¯æ—¶ç«‹å³å¼€å§‹å½•åˆ¶å¹¶å‘é€æ•°æ®
                    startMediaRecording(stream);
                    
                    // è®¾ç½®ç›®æ ‡Socket IDï¼Œç¡®ä¿èƒ½å‘é€æ•°æ®ç»™å¯¹æ–¹
                    currentTargetSocketId = currentCallerSocketId;
                    
                    socket.emit('call-accept', {
                        callerSocketId: currentCallerSocketId,
                        callId: currentCallId
                    });
                    
                    videoContainer.classList.add('active');
                    addSystemMessage('é€šè¯å·²æ¥é€š');
                } else {
                    const audioDevices = devices.filter(device => device.kind === 'audioinput');
                    
                    console.log('å¯ç”¨éŸ³é¢‘è®¾å¤‡:', audioDevices);
                    
                    if (audioDevices.length === 0) {
                        throw new Error('æœªæ£€æµ‹åˆ°éº¦å…‹é£è®¾å¤‡');
                    }
                    
                    // å¦‚æœæœ‰å¤šä¸ªè®¾å¤‡ï¼Œæ˜¾ç¤ºè®¾å¤‡é€‰æ‹©ç•Œé¢
                    if (audioDevices.length > 1) {
                        availableVideoDevices = [];
                        availableAudioDevices = audioDevices;
                        selectedVideoDeviceId = null;
                        selectedAudioDeviceId = audioDevices[0].deviceId;
                        // è®¾ç½®pendingCallActionï¼Œç”¨äºè®¾å¤‡é€‰æ‹©åçš„é€šè¯æµç¨‹
                        pendingCallAction = { 
                            type: 'audio', 
                            isAcceptingCall: true,
                            targetSocketId: currentCallerSocketId,
                            targetUsername: 'å¯¹æ–¹'
                        };
                        showDeviceSelectModal();
                        return;
                    }
                    
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true
                        }
                    });
                    
                    localStream = stream;
                    
                    // æ¥å—é€šè¯æ—¶ç«‹å³å¼€å§‹å½•åˆ¶å¹¶å‘é€æ•°æ®
                    // startMediaRecording(stream);
                    
                    // è®¾ç½®ç›®æ ‡Socket IDï¼Œç¡®ä¿èƒ½å‘é€æ•°æ®ç»™å¯¹æ–¹
                    currentTargetSocketId = currentCallerSocketId;
                    
                    socket.emit('call-accept', {
                        callerSocketId: currentCallerSocketId,
                        callId: currentCallId
                    });
                    
                    videoContainer.classList.add('active');
                    addSystemMessage('é€šè¯å·²æ¥é€š');
                }
            } catch (error) {
                console.error('è·å–åª’ä½“æµå¤±è´¥:', error);
                let errorMessage = 'æ— æ³•è®¿é—®æ‘„åƒå¤´/éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage = 'æ‚¨æ‹’ç»äº†æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸è®¿é—®';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'æœªæ‰¾åˆ°æ‘„åƒå¤´æˆ–éº¦å…‹é£è®¾å¤‡';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'æ— æ³•è¯»å–æ‘„åƒå¤´æˆ–éº¦å…‹é£æ•°æ®';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                alert(errorMessage);
                // é‡ç½®æ¥ç”µçŠ¶æ€
                callIncoming.classList.remove('active');
                currentCallId = null;
            }
        }

        // æ‹’ç»é€šè¯
        function rejectCall() {
            callIncoming.classList.remove('active');
            
                socket.emit('call-media', {
                    targetSocketId: currentCallerSocketId,
                    callId: currentCallId,
                    type: 'reject'
                });
                
                addSystemMessage('å·²æ‹’ç»é€šè¯');
                currentCallId = null;
            }   
        

        // ç»“æŸé€šè¯
        function endCall() {
            stopMediaRecording();
            
            // æ¸…ç†åª’ä½“URL
            if (currentMediaUrl) {
                URL.revokeObjectURL(currentMediaUrl);
                currentMediaUrl = null;
            }
            
            // æ¸…ç†åª’ä½“æºå’ŒéŸ³é¢‘ä¸Šä¸‹æ–‡
            if (mediaSource) {
                mediaSource.endOfStream();
                remoteVideo.srcObject = null;
                mediaSource = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            videoContainer.classList.remove('active');
            
            if (currentTargetSocketId) {
                socket.emit('call-end', {
                    targetSocketId: currentTargetSocketId,
                    callId: currentCallId
                });
            }
            
            currentCallId = null;
            currentTargetSocketId = null;
            sourceBuffer = [];
            audioBuffer = [];
            mediaDataQueue = [];
            addSystemMessage('é€šè¯å·²ç»“æŸ');
        }

        // åˆ‡æ¢è§†é¢‘
        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    isVideoEnabled = !isVideoEnabled;
                    videoTrack.enabled = isVideoEnabled;
                    toggleVideoBtn.textContent = isVideoEnabled ? 'ğŸ“¹' : 'ğŸš«';
                }
            }
        }

        // åˆ‡æ¢éŸ³é¢‘
        function toggleAudio() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    isAudioEnabled = !isAudioEnabled;
                    audioTrack.enabled = isAudioEnabled;
                    toggleAudioBtn.textContent = isAudioEnabled ? 'ğŸ¤' : 'ğŸ”‡';
                }
            }
        }

        // Socketäº‹ä»¶å¤„ç†
        
        // æ˜¾ç¤ºç”¨æˆ·è¯¦æƒ…
        function showUserDetail(socketId, username, color, permissions) {
            usersModal.classList.remove('active');
            userDetailTitle.textContent = 'ç”¨æˆ·è¯¦æƒ…';
            userDetailContent.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <div class="user-color" style="background: ${color}; width: 50px; height: 50px; border-radius: 50%;"></div>
                        <div>
                            <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">${escapeHtml(username)}</div>
                            <div style="font-size: 12px; color: #666;">Socket ID: ${socketId}</div>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: bold; margin-bottom: 5px;">æƒé™</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <span>å‘é€è¯­éŸ³:</span>
                                <label class="switch">
                                    <input type="checkbox" ${permissions.allowAudio ? 'checked' : ''} onchange="changeUserPermissions('${socketId}', 'allowAudio', this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div>
                                <span>å‘é€å›¾ç‰‡:</span>
                                <label class="switch">
                                    <input type="checkbox" ${permissions.allowImage ? 'checked' : ''} onchange="changeUserPermissions('${socketId}', 'allowImage', this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div>
                                <span>å‘é€æ–‡ä»¶:</span>
                                <label class="switch">
                                    <input type="checkbox" ${permissions.allowFile ? 'checked' : ''} onchange="changeUserPermissions('${socketId}', 'allowFile', this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div>
                                <span>å‘é€æ¶ˆæ¯:</span>
                                <label class="switch">
                                    <input type="checkbox" ${permissions.allowSendMessages ? 'checked' : ''} onchange="changeUserPermissions('${socketId}', 'allowSendMessages', this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div>
                                <span>æŸ¥çœ‹æ¶ˆæ¯:</span>
                                <label class="switch">
                                    <input type="checkbox" ${permissions.allowViewMessages ? 'checked' : ''} onchange="changeUserPermissions('${socketId}', 'allowViewMessages', this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div>
                                <span>é€šè¯:</span>
                                <label class="switch">
                                    <input type="checkbox" ${permissions.allowCall ? 'checked' : ''} onchange="changeUserPermissions('${socketId}', 'allowCall', this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div>
                                <span>æ·»åŠ å¥½å‹:</span>
                                <label class="switch">
                                    <input type="checkbox" ${permissions.allowAddFriends ? 'checked' : ''} onchange="changeUserPermissions('${socketId}', 'allowAddFriends', this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div>
                                <span>æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨:</span>
                                <label class="switch">
                                    <input type="checkbox" ${permissions.allowViewUsers ? 'checked' : ''} onchange="changeUserPermissions('${socketId}', 'allowViewUsers', this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div>
                                <span>å…è®¸ç§èŠ:</span>
                                <label class="switch">
                                    <input type="checkbox" ${permissions.allowPrivateChat ? 'checked' : ''} onchange="changeUserPermissions('${socketId}', 'allowPrivateChat', this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div>
                                <span>å…è®¸æ‰“å¼€å¥½å‹é¡µé¢:</span>
                                <label class="switch">
                                    <input type="checkbox" ${permissions.allowOpenFriendsPage ? 'checked' : ''} onchange="changeUserPermissions('${socketId}', 'allowOpenFriendsPage', this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div>
                                <span>å…è®¸æ’¤å›æ¶ˆæ¯:</span>
                                <label class="switch">
                                    <input type="checkbox" ${permissions.allowRecallMessage ? 'checked' : ''} onchange="changeUserPermissions('${socketId}', 'allowRecallMessage', this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-confirm" onclick="addFriend('${socketId}'); closeUserDetailModal();">æ·»åŠ å¥½å‹</button>
                    </div>
                </div>
            `;
            
            userDetailModal.classList.add('active');
        }
        
        // å…³é—­ç”¨æˆ·è¯¦æƒ…æ¨¡æ€æ¡†
        function closeUserDetailModal() {
            userDetailModal.classList.remove('active');
            usersModal.classList.add('active');
        }
        
        // Socketäº‹ä»¶å¤„ç†
        let currentCallerSocketId = null;
        let currentTargetSocketId = null;
        remoteVideoBuffer = [];

        // æ¥æ”¶é€šè¯è¯·æ±‚
        socket.on('call-request', (data) => {
            if (!userPermissions.allowCall) {
                socket.emit('call-reject', {
                    callerSocketId: data.from,
                    callId: data.callId
                });
                return;
            }
            
            currentCallerSocketId = data.from;
            currentCallId = data.callId;
            // ä»è¯·æ±‚æ•°æ®ä¸­è·å–é€šè¯ç±»å‹
            isVideoCall = data.type === 'video';
            
            callIncomingText.textContent = `${data.fromUsername} è¯·æ±‚${isVideoCall ? 'è§†é¢‘' : 'è¯­éŸ³'}é€šè¯`;
            callIncoming.classList.add('active');
        });

        // é€šè¯è¢«æ¥å—
        socket.on('call-accepted', (data) => {
            addSystemMessage('å¯¹æ–¹å·²æ¥å—é€šè¯');
            // å¯¹æ–¹æ¥å—é€šè¯åï¼Œå¼€å§‹å‘é€åª’ä½“æ•°æ®
            if (localStream && !isRecording) {
                startMediaRecording(localStream);
            }
        });

        // é€šè¯è¢«æ‹’ç»
        socket.on('call-rejected', (data) => {
            stopMediaRecording();
            addSystemMessage('å¯¹æ–¹æ‹’ç»äº†é€šè¯');
            currentCallId = null;
        });

        // é€šè¯ç»“æŸ
        socket.on('call-ended', (data) => {
            stopMediaRecording();
            videoContainer.classList.remove('active');
            currentCallId = null;
            addSystemMessage('é€šè¯å·²ç»“æŸ');
        });

        // æ¥æ”¶åª’ä½“æ•°æ®
        socket.on('call-media', (data) => {
            if (data.callId === currentCallId) {
                try {
                    // å°†Uint8Arrayè½¬æ¢å›Blobï¼Œä½¿ç”¨æ¥æ”¶åˆ°çš„ MIME ç±»å‹
                    const uint8Array = new Uint8Array(data.data);
                    let mimeType = data.mimeType || (isVideoCall ? 'video/webm' : 'audio/webm');
                    
                    // å°†æ•°æ®æ·»åŠ åˆ°é˜Ÿåˆ—
                    receiveDataQueue.push({ uint8Array, mimeType });
                    
                    // å¦‚æœæ²¡æœ‰æ­£åœ¨å¤„ç†æ•°æ®ï¼Œå¼€å§‹å¤„ç†é˜Ÿåˆ—
                    if (!isAppending) {
                        processReceiveQueue();
                    }
                } catch (error) {
                    console.error('æ’­æ”¾åª’ä½“æ•°æ®å¤±è´¥:', error);
                }
            }
        });
        
        // å¤„ç†æ¥æ”¶æ•°æ®é˜Ÿåˆ—
        function processReceiveQueue() {
            if (receiveDataQueue.length === 0) {
                isAppending = false;
                return;
            }
            
            isAppending = true;
            const { uint8Array, mimeType } = receiveDataQueue.shift();
            
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¿™ä¸ª MIME ç±»å‹ç”¨äº SourceBuffer
            if (isVideoCall) {
                // è§†é¢‘æ’­æ”¾ - ä½¿ç”¨ MediaSource API
                if (!mediaSource) {
                    mediaSource = new MediaSource();
                    remoteVideo.src = URL.createObjectURL(mediaSource);
                    
                    mediaSource.addEventListener('sourceopen', () => {
                        console.log('MediaSource å·²æ‰“å¼€ï¼Œå°è¯•ä½¿ç”¨ MIME ç±»å‹:', mimeType);
                        
                        // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒçš„ MIME ç±»å‹
                        const videoTypes = [
                            mimeType,
                            'video/webm;codecs=vp9,opus',
                            'video/webm;codecs=vp8,opus',
                            'video/webm;codecs=vp8',
                            'video/webm',
                            'video/mp4'
                        ];
                        
                        for (const type of videoTypes) {
                            try {
                                if (MediaSource.isTypeSupported(type)) {
                                    console.log('ä½¿ç”¨æ”¯æŒçš„ MIME ç±»å‹:', type);
                                    sourceBuffer = mediaSource.addSourceBuffer(type);
                                    sourceBuffer.addEventListener('updateend', () => {
                                        console.log('ç¼“å†²åŒºæ›´æ–°å®Œæˆ');
                                        // å¤„ç†ä¸‹ä¸€ä¸ªæ•°æ®
                                        processReceiveQueue();
                                    });
                                    break;
                                }
                            } catch (e) {
                                console.log('å°è¯•', type, 'å¤±è´¥:', e.message);
                            }
                        }
                    });
                }
                
                // å°†æ•°æ®æ·»åŠ åˆ°ç¼“å†²åŒº
                if (sourceBuffer && mediaSource.readyState === 'open') {
                    const appendData = () => {
                        if (!sourceBuffer.updating) {
                            try {
                                sourceBuffer.appendBuffer(uint8Array);
                                console.log('æˆåŠŸæ·»åŠ æ•°æ®ï¼Œå¤§å°:', uint8Array.length);
                            } catch (e) {
                                console.error('æ·»åŠ ç¼“å†²åŒºå¤±è´¥:', e);
                            }
                        } else {
                            // å¦‚æœæ­£åœ¨æ›´æ–°ï¼Œç­‰å¾…50msåé‡è¯•
                            setTimeout(appendData, 50);
                        }
                    };
                    appendData();
                }
            } else {
                // éŸ³é¢‘æ’­æ”¾ - ä½¿ç”¨ MediaSource API
                if (!mediaSource) {
                    mediaSource = new MediaSource();
                    if (!audioElement) {
                        audioElement = new Audio();
                        audioElement.autoplay = true;
                    }
                    audioElement.src = URL.createObjectURL(mediaSource);
                    
                    mediaSource.addEventListener('sourceopen', () => {
                        console.log('MediaSource å·²æ‰“å¼€ï¼Œå°è¯•ä½¿ç”¨ MIME ç±»å‹:', mimeType);
                        
                        // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒçš„ MIME ç±»å‹
                        const audioTypes = [
                            mimeType,
                            'audio/webm;codecs=opus',
                            'audio/webm',
                            'audio/ogg;codecs=opus',
                            'audio/mp4'
                        ];
                        
                        for (const type of audioTypes) {
                            try {
                                if (MediaSource.isTypeSupported(type)) {
                                    console.log('ä½¿ç”¨æ”¯æŒçš„ MIME ç±»å‹:', type);
                                    sourceBuffer = mediaSource.addSourceBuffer(type);
                                    sourceBuffer.addEventListener('updateend', () => {
                                        console.log('ç¼“å†²åŒºæ›´æ–°å®Œæˆ');
                                        // å¤„ç†ä¸‹ä¸€ä¸ªæ•°æ®
                                        processReceiveQueue();
                                    });
                                    break;
                                }
                            } catch (e) {
                                console.log('å°è¯•', type, 'å¤±è´¥:', e.message);
                            }
                        }
                    });
                }
                
                // å°†æ•°æ®æ·»åŠ åˆ°ç¼“å†²åŒº
                if (sourceBuffer && mediaSource.readyState === 'open') {
                    const appendData = () => {
                        if (!sourceBuffer.updating) {
                            try {
                                sourceBuffer.appendBuffer(uint8Array);
                                console.log('æˆåŠŸæ·»åŠ æ•°æ®ï¼Œå¤§å°:', uint8Array.length);
                            } catch (e) {
                                console.error('æ·»åŠ ç¼“å†²åŒºå¤±è´¥:', e);
                            }
                        } else {
                            // å¦‚æœæ­£åœ¨æ›´æ–°ï¼Œç­‰å¾…50msåé‡è¯•
                            setTimeout(appendData, 50);
                        }
                    };
                    appendData();
                }
            }
        }

        // è§†é¢‘é€šè¯æŒ‰é’®äº‹ä»¶
        // videoCallBtn.addEventListener('click', () => {
        //     const targetUser = prompt('è¯·è¾“å…¥è¦è§†é¢‘é€šè¯çš„ç”¨æˆ·å:');
        //     if (targetUser) {
        //         const userElements = usersListDiv.querySelectorAll('.user-item');
        //         for (let userElement of userElements) {
        //             const name = userElement.querySelector('.user-name').textContent;
        //             if (name === targetUser) {
        //                 const callBtn = userElement.querySelector('.call-btn');
        //                 if (callBtn && callBtn.textContent === 'ğŸ“¹') {
        //                     const socketId = callBtn.getAttribute('onclick').match(/'([^']+)'/)[1];
        //                     startVideoCall(socketId, targetUser);
        //                     return;
        //                 }
        //         }
        //         alert('æœªæ‰¾åˆ°è¯¥ç”¨æˆ·æˆ–è¯¥ç”¨æˆ·æ²¡æœ‰é€šè¯æƒé™');
        // });
        
        // // è¯­éŸ³é€šè¯æŒ‰é’®äº‹ä»¶
        // audioCallBtn.addEventListener('click', () => {
        //     const targetUser = prompt('è¯·è¾“å…¥è¦è¯­éŸ³é€šè¯çš„ç”¨æˆ·å:');
        //     if (targetUser) {
        //         const userElements = usersListDiv.querySelectorAll('.user-item');
        //         for (let userElement of userElements) {
        //             const name = userElement.querySelector('.user-name').textContent;
        //             if (name === targetUser) {
        //                 const callBtns = userElement.querySelectorAll('.call-btn');
        //                 for (let callBtn of callBtns) {
        //                     if (callBtn.textContent === 'ğŸ“') {
        //                         const socketId = callBtn.getAttribute('onclick').match(/'([^']+)'/)[1];
        //                         startAudioCall(socketId, targetUser);
        //                         return;
        //                     }
        //                 }
        //         }
        //         alert('æœªæ‰¾åˆ°è¯¥ç”¨æˆ·æˆ–è¯¥ç”¨æˆ·æ²¡æœ‰é€šè¯æƒé™');
        // });
        
        // // è§†é¢‘æ§åˆ¶æŒ‰é’®äº‹ä»¶
        // toggleVideoBtn.addEventListener('click', toggleVideo);
        // toggleAudioBtn.addEventListener('click', toggleAudio);
        // endCallBtn.addEventListener('click', endCall);
        
        // æ˜¾ç¤ºè®¾å¤‡é€‰æ‹©æ¨¡æ€æ¡†
        function showDeviceSelectModal() {
            // å¦‚æœæ¨¡æ€æ¡†å·²ç»æ‰“å¼€ï¼Œä¸é‡å¤æ˜¾ç¤º
            if (isDeviceSelectModalOpen) {
                return;
            }
            
            isDeviceSelectModalOpen = true;
            deviceSelectContent.innerHTML = '';
            
            // æ·»åŠ æœç´¢æ¡†
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = 'æœç´¢è®¾å¤‡...';
            searchInput.style.width = '100%';
            searchInput.style.padding = '10px';
            searchInput.style.marginBottom = '15px';
            searchInput.style.border = '1px solid #dee2e6';
            searchInput.style.borderRadius = '5px';
            searchInput.addEventListener('input', (e) => {
                filterDeviceList(e.target.value);
            });
            
            deviceSelectContent.appendChild(searchInput);
            
            // æ·»åŠ è§†é¢‘è®¾å¤‡é€‰æ‹©
            if (availableVideoDevices.length > 0) {
                const videoSection = document.createElement('div');
                videoSection.innerHTML = '<h4 style="margin-bottom: 10px;">é€‰æ‹©æ‘„åƒå¤´:</h4>';
                
                availableVideoDevices.forEach((device, index) => {
                    const deviceDiv = document.createElement('div');
                    deviceDiv.style.display = 'flex';
                    deviceDiv.style.alignItems = 'center';
                    deviceDiv.style.padding = '10px';
                    deviceDiv.style.marginBottom = '5px';
                    deviceDiv.style.border = '1px solid #e9ecef';
                    deviceDiv.style.borderRadius = '5px';
                    deviceDiv.style.cursor = 'pointer';
                    deviceDiv.dataset.deviceId = device.deviceId;
                    deviceDiv.dataset.deviceType = 'video';
                    
                    const deviceLabel = device.label || `æ‘„åƒå¤´ ${index + 1}`;
                    
                    deviceDiv.innerHTML = `
                        <input type="radio" name="videoDevice" value="${device.deviceId}" ${device.deviceId === selectedVideoDeviceId ? 'checked' : ''}>
                        <span style="margin-left: 10px;">${escapeHtml(deviceLabel)}</span>
                    `;
                    
                    deviceDiv.addEventListener('click', () => {
                        selectedVideoDeviceId = device.deviceId;
                        document.querySelectorAll('input[name="videoDevice"]').forEach(input => {
                            input.checked = input.value === device.deviceId;
                        });
                    });
                    
                    videoSection.appendChild(deviceDiv);
                });
                
                deviceSelectContent.appendChild(videoSection);
            }
            
            // æ·»åŠ éŸ³é¢‘è®¾å¤‡é€‰æ‹©
            if (availableAudioDevices.length > 0) {
                const audioSection = document.createElement('div');
                audioSection.innerHTML = '<h4 style="margin-bottom: 10px;">é€‰æ‹©éº¦å…‹é£:</h4>';
                
                availableAudioDevices.forEach((device, index) => {
                    const deviceDiv = document.createElement('div');
                    deviceDiv.style.display = 'flex';
                    deviceDiv.style.alignItems = 'center';
                    deviceDiv.style.padding = '10px';
                    deviceDiv.style.marginBottom = '5px';
                    deviceDiv.style.border = '1px solid #e9ecef';
                    deviceDiv.style.borderRadius = '5px';
                    deviceDiv.style.cursor = 'pointer';
                    deviceDiv.dataset.deviceId = device.deviceId;
                    deviceDiv.dataset.deviceType = 'audio';
                    
                    const deviceLabel = device.label || `éº¦å…‹é£ ${index + 1}`;
                    
                    deviceDiv.innerHTML = `
                        <input type="radio" name="audioDevice" value="${device.deviceId}" ${device.deviceId === selectedAudioDeviceId ? 'checked' : ''}>
                        <span style="margin-left: 10px;">${escapeHtml(deviceLabel)}</span>
                    `;
                    
                    deviceDiv.addEventListener('click', () => {
                        selectedAudioDeviceId = device.deviceId;
                        document.querySelectorAll('input[name="audioDevice"]').forEach(input => {
                            input.checked = input.value === device.deviceId;
                        });
                    });
                    
                    audioSection.appendChild(deviceDiv);
                });
                
                deviceSelectContent.appendChild(audioSection);
            }
            
            deviceSelectModal.classList.add('active');
        }
        
        // è¿‡æ»¤è®¾å¤‡åˆ—è¡¨
        function filterDeviceList(searchTerm) {
            const deviceDivs = deviceSelectContent.querySelectorAll('[data-device-type]');
            
            deviceDivs.forEach(deviceDiv => {
                const deviceName = deviceDiv.querySelector('span').textContent.toLowerCase();
                const isVisible = deviceName.includes(searchTerm.toLowerCase());
                deviceDiv.style.display = isVisible ? 'flex' : 'none';
            });
        }
        
        // å…³é—­è®¾å¤‡é€‰æ‹©æ¨¡æ€æ¡†
        function closeDeviceSelectModal() {
            deviceSelectModal.classList.remove('active');
            isDeviceSelectModalOpen = false;
            pendingCallAction = null;
        }
        
        // ç¡®è®¤è®¾å¤‡é€‰æ‹©
        function confirmDeviceSelect() {
            if (pendingCallAction) {
                deviceSelectModal.classList.remove('active');
                isDeviceSelectModalOpen = false;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ¥å—é€šè¯çš„æƒ…å†µ
                if (pendingCallAction.isAcceptingCall) {
                    // ä½¿ç”¨é€‰æ‹©çš„è®¾å¤‡æ¥å—é€šè¯
                    if (pendingCallAction.type === 'video') {
                        acceptVideoCallWithDevice(selectedVideoDeviceId, selectedAudioDeviceId);
                    } else if (pendingCallAction.type === 'audio') {
                        acceptAudioCallWithDevice(selectedAudioDeviceId);
                    }
                } else {
                    // ä½¿ç”¨é€‰æ‹©çš„è®¾å¤‡å‘èµ·é€šè¯
                    if (pendingCallAction.type === 'video') {
                        startVideoCallWithDevice(pendingCallAction.targetSocketId, pendingCallAction.targetUsername, selectedVideoDeviceId);
                    } else if (pendingCallAction.type === 'audio') {
                        startAudioCallWithDevice(pendingCallAction.targetSocketId, pendingCallAction.targetUsername, selectedAudioDeviceId);
                    }
                }
            }
        }
        
        // ä½¿ç”¨æŒ‡å®šè®¾å¤‡æ¥å—è§†é¢‘é€šè¯
        async function acceptVideoCallWithDevice(videoDeviceId, audioDeviceId) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        deviceId: audioDeviceId,
                        echoCancellation: true,
                        noiseSuppression: true
                    },
                    video: {
                        deviceId: videoDeviceId,
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });
                
                localStream = stream;
                localVideo.srcObject = stream;
                
                // æ¥å—é€šè¯æ—¶ç«‹å³å¼€å§‹å½•åˆ¶å¹¶å‘é€æ•°æ®
                startMediaRecording(stream);
                
                // è®¾ç½®ç›®æ ‡Socket IDï¼Œç¡®ä¿èƒ½å‘é€æ•°æ®ç»™å¯¹æ–¹
                currentTargetSocketId = currentCallerSocketId;
                
                socket.emit('call-accept', {
                    callerSocketId: currentCallerSocketId,
                    callId: currentCallId
                });
                
                videoContainer.classList.add('active');
                addSystemMessage('é€šè¯å·²æ¥é€š');
            } catch (error) {
                console.error('è·å–åª’ä½“æµå¤±è´¥:', error);
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´/éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
            }
        }
        
        // ä½¿ç”¨æŒ‡å®šè®¾å¤‡æ¥å—è¯­éŸ³é€šè¯
        async function acceptAudioCallWithDevice(audioDeviceId) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        deviceId: audioDeviceId,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                localStream = stream;
                
                // ä¸è¦ç«‹å³å¼€å§‹å½•åˆ¶ï¼Œç­‰å¾…å¯¹æ–¹æ¥å—é€šè¯åå†å¼€å§‹
                // startMediaRecording(stream);
                
                // è®¾ç½®ç›®æ ‡Socket IDï¼Œç¡®ä¿èƒ½å‘é€æ•°æ®ç»™å¯¹æ–¹
                currentTargetSocketId = currentCallerSocketId;
                
                socket.emit('call-accept', {
                    callerSocketId: currentCallerSocketId,
                    callId: currentCallId
                });
                
                videoContainer.classList.add('active');
                addSystemMessage('é€šè¯å·²æ¥é€š');
            } catch (error) {
                console.error('è·å–åª’ä½“æµå¤±è´¥:', error);
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
            }
        }
        
        // ä½¿ç”¨æŒ‡å®šè®¾å¤‡å¼€å§‹è§†é¢‘é€šè¯
        async function startVideoCallWithDevice(targetSocketId, targetUsername, deviceId) {
            if (!userPermissions.allowCall) {
                alert('æ‚¨æ²¡æœ‰é€šè¯æƒé™');
                return;
            }
            
            isVideoCall = true;
            currentCallId = Date.now().toString();
            currentTargetSocketId = targetSocketId;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        deviceId: selectedAudioDeviceId,
                        echoCancellation: true,
                        noiseSuppression: true
                    },
                    video: {
                        deviceId: deviceId,
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });
                
                localStream = stream;
                localVideo.srcObject = stream;
                
                // ä¸è¦ç«‹å³å¼€å§‹å½•åˆ¶ï¼Œç­‰å¾…å¯¹æ–¹æ¥å—é€šè¯åå†å¼€å§‹
                // startMediaRecording(stream);
                
                socket.emit('call-request', {
                    targetSocketId: targetSocketId,
                    callId: currentCallId,
                    type: 'video',
                    fromUsername: username
                });
                
                videoContainer.classList.add('active');
                addSystemMessage(`æ­£åœ¨å‘ ${targetUsername} å‘èµ·è§†é¢‘é€šè¯...`);
            } catch (error) {
                console.error('è·å–æ‘„åƒå¤´å¤±è´¥:', error);
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
            }
        }
        
        // ä½¿ç”¨æŒ‡å®šè®¾å¤‡å¼€å§‹è¯­éŸ³é€šè¯
        async function startAudioCallWithDevice(targetSocketId, targetUsername, deviceId) {
            if (!userPermissions.allowCall) {
                alert('æ‚¨æ²¡æœ‰é€šè¯æƒé™');
                return;
            }
            
            isVideoCall = false;
            currentCallId = Date.now().toString();
            currentTargetSocketId = targetSocketId;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        deviceId: deviceId,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                localStream = stream;
                
                // ä¸è¦ç«‹å³å¼€å§‹å½•åˆ¶ï¼Œç­‰å¾…å¯¹æ–¹æ¥å—é€šè¯åå†å¼€å§‹
                // startMediaRecording(stream);
                
                socket.emit('call-request', {
                    targetSocketId: targetSocketId,
                    callId: currentCallId,
                    type: 'audio',
                    fromUsername: username
                });
                
                videoContainer.classList.add('active');
                addSystemMessage(`æ­£åœ¨å‘ ${targetUsername} å‘èµ·è¯­éŸ³é€šè¯...`);
            } catch (error) {
                console.error('è·å–éº¦å…‹é£å¤±è´¥:', error);
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
            }
        }
    </script>
</body>
</html>
