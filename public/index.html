<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; media-src 'self' blob:; connect-src 'self' ws: wss:; font-src 'self' data:;">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>ËÅäÂ§©ÂÆ§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 90%;
            max-width: 800px;
            height: 90vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .online-count {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }
        
        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .users-panel {
            width: 200px;
            background: #f1f3f5;
            padding: 15px;
            border-left: 1px solid #dee2e6;
            overflow-y: auto;
            display: block;
            position: relative;
            z-index: 1;
            transition: all 0.3s;
        }

        .users-panel.hidden {
            display: none;
        }

        .message {
            margin-bottom: 15px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .username {
            font-weight: bold;
            margin-right: 10px;
        }

        .timestamp {
            font-size: 12px;
            color: #999;
        }

        .message-content {
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
            color: #333;
        }



        .message-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 5px;
        }

        .recall-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        .recall-btn:hover {
            background: #c82333;
        }

        .call-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }

        .call-btn:hover {
            background: #218838;
        }

        .call-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .video-container.active {
            display: flex;
        }

        .video-content {
            display: flex;
            gap: 20px;
            max-width: 1200px;
            width: 90%;
        }

        .video-box {
            flex: 1;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .video-box video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }

        .video-controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }

        .video-control-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .video-control-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .video-control-btn.end {
            background: #dc3545;
        }

        .video-control-btn.end:hover {
            background: #c82333;
        }

        .call-incoming {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 999;
            max-width: 300px;
        }

        .call-incoming.active {
            display: block;
        }

        .call-incoming h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .call-incoming-buttons {
            display: flex;
            gap: 10px;
        }

        .call-incoming-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .call-accept {
            background: #28a745;
            color: white;
        }

        .call-reject {
            background: #dc3545;
            color: white;
        }

        .system-message {
            text-align: center;
            color: #666;
            font-style: italic;
            margin: 10px 0;
            padding: 5px;
            background: #e9ecef;
            border-radius: 5px;
        }

        .system-message.admin {
            background: #fff3cd;
            color: #856404;
            font-weight: bold;
        }

        .users-panel {
            width: 200px;
            background: #f1f3f5;
            padding: 15px;
            border-left: 1px solid #dee2e6;
            overflow-y: auto;
            display: block;
        }
        
        .search-box {
            margin-bottom: 15px;
        }
        
        #searchInput {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        #searchInput:focus {
            border-color: #667eea;
        }
        
        #userDetailModal .modal-content {
            max-width: 400px;
        }
        
        #userDetailContent {
            margin-bottom: 20px;
        }
        
        #userDetailContent > div {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        #userDetailContent > div > div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        #userDetailContent > div > div:last-child {
            margin-bottom: 0;
        }
        
        #usernameInput, #roomNameInput, #roomPasswordInput {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
            margin-bottom: 10px;
        }

        #usernameInput:focus, #roomNameInput:focus, #roomPasswordInput:focus {
            border-color: #667eea;
        }

        .user-item {
            display: block;
            width: 100%;
            margin-bottom: 10px;
            padding: 10px 15px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            position: relative;
            overflow: hidden;
        }

        .user-item:hover {
            border-color: #667eea;
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .user-item:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.2);
        }

        .user-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .user-name {
            display: inline-block;
            vertical-align: middle;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: calc(100% - 20px);
        }

        .user-item .btn-info {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 5px 10px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .user-item:hover .btn-info {
            opacity: 1;
        }

        #joinBtn {
            width: 100%;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #joinBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        #chatForm {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #messageInput {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        #messageInput:focus {
            border-color: #667eea;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            background: #f8f9fa;
            color: #667eea;
        }

        .action-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .action-btn.recording {
            background: #dc3545;
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        #sendBtn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #sendBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .hidden {
            display: none !important;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .modal h3 {
            margin-bottom: 15px;
            margin-top: 0;
        }
        
        #deviceSelectContent {
            max-height: 300px;
            overflow-y: auto;
        }
        
        #deviceSelectContent h4 {
            margin-bottom: 10px;
            margin-top: 0;
        }
        
        #deviceSelectContent input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            box-sizing: border-box;
        }
        
        #deviceSelectContent input[type="radio"] {
            margin-right: 10px;
        }
        
        #deviceSelectContent span {
            margin-left: 10px;
        }
        
        #deviceSelectContent div[data-device-type] {
            padding: 10px;
            margin-bottom: 5px;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            cursor: pointer;
        }
        
        #deviceSelectContent div[data-device-type]:hover {
            background: #f8f9fa;
        }
        
        #deviceSelectContent div[data-device-type]:hover input[type="radio"] {
            transform: scale(1.1);
        }
        
        .friend-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
            transition: background 0.2s;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 8px;
            margin: 8px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .friend-item:hover {
            background: #f0f0f0;
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .friend-item:active {
            background: #e9ecef;
            border-color: #0056b3;
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .friend-color {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .friend-info {
            flex: 1;
            min-width: 0;
        }
        
        .friend-name {
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .friend-status {
            font-size: 12px;
            color: #666;
        }
        
        .friend-actions {
            display: none;
            gap: 5px;
        }
        
        .friend-item.expanded .friend-actions {
            display: flex;
        }
        
        .friend-btn {
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .friend-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .friend-btn.danger {
            color: #dc3545;
            border-color: #dc3545;
        }
        
        .friend-btn.danger:hover {
            background: #dc3545;
            color: white;
        }
        
        .private-chat-messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .private-chat-message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 10px;
            background: white;
        }
        
        .private-chat-message.sent {
            background: #667eea;
            color: white;
        }
        
        .private-chat-message-header {
            font-size: 12px;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        
        .private-chat-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        #privateChatInput {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        #privateChatInput:focus {
            border-color: #667eea;
        }
        
        #privateChatSendBtn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        #privateChatSendBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .admin-panel-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }
        
        .admin-tab {
            padding: 10px 20px;
            border: none;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .admin-tab:hover {
            background: #e9ecef;
        }
        
        .admin-tab.active {
            background: #667eea;
            color: white;
        }
        
        .admin-tab-content {
            display: none;
        }
        
        .admin-tab-content.active {
            display: block;
        }
        
        .admin-user-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            transition: background 0.2s;
        }
        
        .admin-user-item:hover {
            background: #f8f9fa;
        }
        
        .admin-user-info {
            flex: 1;
            min-width: 0;
        }
        
        .admin-user-name {
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .admin-user-role {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-right: 5px;
        }
        
        .admin-user-role.user {
            background: #e9ecef;
            color: #666;
        }
        
        .admin-user-role.admin {
            background: #ffc107;
            color: #333;
        }
        
        .admin-user-role.superadmin {
            background: #dc3545;
            color: white;
        }
        
        .admin-user-actions {
            display: flex;
            gap: 5px;
        }
        
        .admin-action-btn {
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .admin-action-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .admin-action-btn.danger {
            color: #dc3545;
            border-color: #dc3545;
        }
        
        .admin-action-btn.danger:hover {
            background: #dc3545;
            color: white;
        }
        
        .admin-select {
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: white;
            font-size: 12px;
            cursor: pointer;
        }
        
        .container {
            width: 100%;
            height: 100vh;
            border-radius: 0;
        }
        .chat-container {
            flex-direction: column;
        }
        .messages {
            padding: 15px;
            width: 100%;
        }
        .action-btn {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }
        #chatForm {
            flex-wrap: wrap;
        }
        #messageInput {
            flex-basis: 100%;
        }
    
            .container {
            width: 100%;
            height: 100vh;
            border-radius: 0;
        }
        .chat-container {
            flex-direction: column;
        }
        .messages {
            padding: 15px;
            width: 100%;
        }
        .action-btn {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }
        #chatForm {
            flex-wrap: wrap;
        }
        #messageInput {
            flex-basis: 100%;
        }
        @media (max-width: 768px) {}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ËÅäÂ§©ÂÆ§</h1>
            <div class="header-actions">
                <div class="online-count">Âú®Á∫ø‰∫∫Êï∞: <span id="userCount">0</span></div>
                <button class="header-btn" id="usersBtn" title="Áî®Êà∑ÂàóË°®">üë•</button>
                <button class="header-btn" id="friendsBtn" title="Â•ΩÂèãÂàóË°®">üë•</button>
                <button class="header-btn" id="adminPanelBtn" title="ÁÆ°ÁêÜÂëòÈù¢Êùø">‚öôÔ∏è</button>
            </div>
        </div>

        <div class="chat-container">
            <div class="messages" id="messages">
                <div class="system-message">Ê¨¢ËøéÊù•Âà∞ËÅäÂ§©ÂÆ§ÔºÅËØ∑ËæìÂÖ•ÊòµÁß∞Âä†ÂÖ•„ÄÇ</div>
            </div>
        </div>

        <div class="input-area">
            <div id="loginForm">
                <input type="text" id="usernameInput" placeholder="ËØ∑ËæìÂÖ•‰Ω†ÁöÑÊòµÁß∞" maxlength="20">
                <button id="joinBtn">Âä†ÂÖ•ËÅäÂ§©</button>
            </div>
            <div id="chatForm" class="hidden">
                <input type="file" id="imageInput" accept="image/*">
                <div class="action-buttons">
                    <button class="action-btn disabled" id="imageBtn" title="ÂèëÈÄÅÂõæÁâá">üì∑</button>
                    <button class="action-btn disabled" id="audioBtn" title="ÂèëÈÄÅËØ≠Èü≥">üé§</button>
                    <button class="action-btn disabled" id="videoCallBtn" title="ËßÜÈ¢ëÈÄöËØù">üìπ</button>
                    <button class="action-btn disabled" id="audioCallBtn" title="ËØ≠Èü≥ÈÄöËØù">üìû</button>
                </div>
                <input type="text" id="messageInput" placeholder="ËæìÂÖ•Ê∂àÊÅØ..." maxlength="500">
                <button id="sendBtn">ÂèëÈÄÅ</button>
            </div>
        </div>
    </div>

    <div class="video-container" id="videoContainer">
        <div class="video-content">
            <div class="video-box">
                <video id="localVideo" autoplay playsinline muted></video>
                <div class="video-label">Êàë</div>
            </div>
            <div class="video-box">
                <video id="remoteVideo" autoplay playsinline></video>
                <div class="video-label">ÂØπÊñπ</div>
            </div>
        </div>
        <div class="video-controls">
            <button class="video-control-btn" id="toggleVideoBtn">üìπ</button>
            <button class="video-control-btn" id="toggleAudioBtn">üé§</button>
            <button class="video-control-btn end" id="endCallBtn">üìû</button>
        </div>
    </div>

    <div class="call-incoming" id="callIncoming">
        <h3 id="callIncomingText">Êù•Áîµ</h3>
        <div class="call-incoming-buttons">
            <button class="call-accept" onclick="acceptCall()">Êé•Âê¨</button>
            <button class="call-reject" onclick="rejectCall()">ÊãíÁªù</button>
        </div>
    </div>
    
    <div class="modal" id="userDetailModal">
        <div class="modal-content">
            <h3 id="userDetailTitle">Áî®Êà∑ËØ¶ÊÉÖ</h3>
            <div id="userDetailContent"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeUserDetailModal()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="usersModal">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <h3>Âú®Á∫øÁî®Êà∑</h3>
            <div class="search-box" style="margin-bottom: 15px;">
                <input type="text" id="searchInput" placeholder="ÊêúÁ¥¢Áî®Êà∑..." maxlength="20">
            </div>
            <div id="usersList"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeUsersModal()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="friendsModal">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <h3>Â•ΩÂèãÂàóË°®</h3>
            <div id="friendsList"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeFriendsModal()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="privateChatModal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <h3 id="privateChatTitle">ÁßÅËÅä</h3>
            <div class="private-chat-messages" id="privateChatMessages"></div>
            <div class="private-chat-input">
                <input type="text" id="privateChatInput" placeholder="ËæìÂÖ•ÁßÅËÅäÊ∂àÊÅØ..." maxlength="500">
                <button id="privateChatSendBtn">ÂèëÈÄÅ</button>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closePrivateChatModal()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="adminPanelModal">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
            <h3>ÁÆ°ÁêÜÂëòÈù¢Êùø</h3>
            <div class="admin-panel-tabs">
                <button class="admin-tab active" data-tab="users">Áî®Êà∑ÁÆ°ÁêÜ</button>
                <button class="admin-tab" data-tab="rooms">ÊàøÈó¥ÁÆ°ÁêÜ</button>
                <button class="admin-tab" data-tab="messages">Ê∂àÊÅØÁÆ°ÁêÜ</button>
                <button class="admin-tab" data-tab="friends">Â•ΩÂèãÁÆ°ÁêÜ</button>
            </div>
            <div class="admin-panel-content">
                <div class="admin-tab-content active" id="usersTab">
                    <div id="adminUsersList"></div>
                </div>
                <div class="admin-tab-content" id="roomsTab">
                    <div id="adminRoomsList"></div>
                </div>
                <div class="admin-tab-content" id="messagesTab">
                    <div style="margin-bottom: 20px;">
                        <label>
                            <input type="checkbox" id="allowMentionsCheckbox" checked>
                            ÂÖÅËÆ∏@ÂäüËÉΩ
                        </label>
                    </div>
                    <div id="adminMessagesList"></div>
                </div>
                <div class="admin-tab-content" id="friendsTab">
                    <div id="adminFriendsList"></div>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeAdminPanelModal()">ÂÖ≥Èó≠</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="deviceSelectModal">
        <div class="modal-content" style="max-width: 500px;">
            <h3>ÈÄâÊã©ËÆæÂ§á</h3>
            <div id="deviceSelectContent"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeDeviceSelectModal()">ÂèñÊ∂à</button>
                <button type="button" class="btn btn-confirm" onclick="confirmDeviceSelect()">Á°ÆÂÆö</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let username = '';
        let currentRoom = '';
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;
        let userPermissions = {
            allowAudio: true,
            allowImage: true,
            allowFile: true,
            allowSendMessages: true,
            allowViewMessages: true,
            allowCall: false
        };

        const messagesDiv = document.getElementById('messages');
        const usersListDiv = document.getElementById('usersList');
        const userCountSpan = document.getElementById('userCount');
        const usernameInput = document.getElementById('usernameInput');
        const messageInput = document.getElementById('messageInput');
        const joinBtn = document.getElementById('joinBtn');
        const sendBtn = document.getElementById('sendBtn');
        const loginForm = document.getElementById('loginForm');
        const chatForm = document.getElementById('chatForm');
        const imageInput = document.getElementById('imageInput');
        const imageBtn = document.getElementById('imageBtn');
        const audioBtn = document.getElementById('audioBtn');
        const videoCallBtn = document.getElementById('videoCallBtn');
        const audioCallBtn = document.getElementById('audioCallBtn');
        const videoContainer = document.getElementById('videoContainer');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const toggleVideoBtn = document.getElementById('toggleVideoBtn');
        const toggleAudioBtn = document.getElementById('toggleAudioBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        const callIncoming = document.getElementById('callIncoming');
        const callIncomingText = document.getElementById('callIncomingText');
        const deviceSelectModal = document.getElementById('deviceSelectModal');
        const deviceSelectContent = document.getElementById('deviceSelectContent');
        const searchInput = document.getElementById('searchInput');
        
        // Áî®Êà∑ÂàóË°®Ê®°ÊÄÅÊ°Ü
        const usersBtn = document.getElementById('usersBtn');
        const usersModal = document.getElementById('usersModal');
        
        // Áî®Êà∑ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
        const userDetailModal = document.getElementById('userDetailModal');
        const userDetailTitle = document.getElementById('userDetailTitle');
        const userDetailContent = document.getElementById('userDetailContent');
        
        // ÊêúÁ¥¢Áõ∏ÂÖ≥ÂèòÈáè
        let allUsers = [];
        let searchResults = [];
        let currentSearchTerm = '';
        
        // Â•ΩÂèãÁ≥ªÁªüÁõ∏ÂÖ≥ÂèòÈáè
        const friendsBtn = document.getElementById('friendsBtn');
        const friendsModal = document.getElementById('friendsModal');
        const friendsListDiv = document.getElementById('friendsList');
        const privateChatModal = document.getElementById('privateChatModal');
        const privateChatTitle = document.getElementById('privateChatTitle');
        const privateChatMessagesDiv = document.getElementById('privateChatMessages');
        const privateChatInput = document.getElementById('privateChatInput');
        const privateChatSendBtn = document.getElementById('privateChatSendBtn');
        
        // ÁÆ°ÁêÜÂëòÈù¢ÊùøÁõ∏ÂÖ≥ÂèòÈáè
        const adminPanelBtn = document.getElementById('adminPanelBtn');
        const adminPanelModal = document.getElementById('adminPanelModal');
        const adminUsersListDiv = document.getElementById('adminUsersList');
        const adminRoomsListDiv = document.getElementById('adminRoomsList');
        const adminMessagesListDiv = document.getElementById('adminMessagesList');
        const adminFriendsListDiv = document.getElementById('adminFriendsList');
        
        let userRole = 'user'; // ÂΩìÂâçÁî®Êà∑ÁöÑËßíËâ≤Ôºöuser, admin, superadmin
        
        let friends = [];
        let currentPrivateChatTarget = null;
        
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let currentCallId = null;
        let isVideoCall = false;
        let isVideoEnabled = true;
        let isAudioEnabled = true;
        
        // ËÆæÂ§áÈÄâÊã©Áõ∏ÂÖ≥ÂèòÈáè
        let availableVideoDevices = [];
        let availableAudioDevices = [];
        let selectedVideoDeviceId = null;
        let selectedAudioDeviceId = null;
        let pendingCallAction = null;

        // ‰ªéURLË∑ØÂæÑËé∑ÂèñÊàøÈó¥Âêç
        function getRoomFromUrl() {
            const path = window.location.pathname;
            if (path && path !== '/') {
                return path.substring(1); // ÁßªÈô§ÂºÄÂ§¥ÁöÑÊñúÊù†
            }
            return null;
        }

        // Â§ÑÁêÜÂä†ÂÖ•ÊåâÈíÆÁÇπÂáª
        joinBtn.addEventListener('click', () => {
            username = usernameInput.value.trim();
            if (username) {
                // ‰ªéURLËé∑ÂèñÊàøÈó¥ÂêçÔºåÈªòËÆ§‰ΩøÁî®'main'
                const roomName = getRoomFromUrl() || 'main';
                
                // Â¶ÇÊûú‰∏çÊòØÈªòËÆ§ÊàøÈó¥ÔºåÊèêÁ§∫Áî®Êà∑ËæìÂÖ•ÂØÜÁ†ÅÔºàÂ¶ÇÊûúÈúÄË¶ÅÔºâ
                if (roomName !== 'main') {
                    const password = prompt(`ËØ∑ËæìÂÖ•ÊàøÈó¥ "${roomName}" ÁöÑÂØÜÁ†ÅÔºàÁïôÁ©∫Ë°®Á§∫Êó†ÂØÜÁ†ÅÔºâ:`);
                    currentRoom = roomName;
                    socket.emit('join', { username, roomName, password: password || null });
                } else {
                    currentRoom = roomName;
                    socket.emit('join', { username, roomName });
                }
            }
        });

        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                joinBtn.click();
            }
        });
        
        // È°µÈù¢Âä†ËΩΩÊó∂‰∏çÈúÄË¶ÅËÆæÁΩÆËæìÂÖ•Ê°ÜÔºåÂõ†‰∏∫Â∑≤ÁªèÂà†Èô§‰∫ÜÊàøÈó¥ÂêçËæìÂÖ•Ê°Ü

        sendBtn.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (message) {
                if (!userPermissions.allowSendMessages) {
                    alert('ÊÇ®Ê≤°ÊúâÂèëÈÄÅÊ∂àÊÅØÁöÑÊùÉÈôê');
                    return;
                }
                socket.emit('message', { message, type: 'text' });
                messageInput.value = '';
            }
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });

        imageBtn.addEventListener('click', () => {
            if (userPermissions.allowImage) {
                imageInput.click();
            } else {
                alert('ÊÇ®Ê≤°ÊúâÂèëÈÄÅÂõæÁâáÁöÑÊùÉÈôê');
            }
        });

        imageInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                if (!userPermissions.allowImage) {
                    alert('ÊÇ®Ê≤°ÊúâÂèëÈÄÅÂõæÁâáÁöÑÊùÉÈôê');
                    imageInput.value = '';
                    return;
                }
                try {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const arrayBuffer = event.target.result;
                        const response = await fetch('/upload-image', {
                            method: 'POST',
                            body: arrayBuffer,
                            headers: {
                                'Content-Type': file.type
                            }
                        });
                        const data = await response.json();
                        
                        if (data.imageUrl) {
                            socket.emit('message', { message: data.imageUrl, type: 'image' });
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } catch (error) {
                    console.error('‰∏ä‰º†ÂõæÁâáÂ§±Ë¥•:', error);
                    alert('‰∏ä‰º†ÂõæÁâáÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                }
                
                imageInput.value = '';
            }
        });

        audioBtn.addEventListener('click', async () => {
            if (!userPermissions.allowAudio) {
                alert('ÊÇ®Ê≤°ÊúâÂèëÈÄÅËØ≠Èü≥ÁöÑÊùÉÈôê');
                return;
            }
            
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        
                        try {
                            // Áõ¥Êé•‰ΩøÁî®Blob‰∏ä‰º†Ôºå‰∏çËΩ¨Êç¢‰∏∫arrayBuffer
                            const response = await fetch('/upload-audio', {
                                method: 'POST',
                                body: audioBlob,
                                headers: {
                                    'Content-Type': 'audio/webm'
                                }
                            });
                            
                            if (!response.ok) {
                                throw new Error(`ÁΩëÁªúÂìçÂ∫îÈîôËØØ: ${response.statusText}`);
                            }
                            
                            const data = await response.json();
                            
                            if (data.audioUrl) {
                                socket.emit('message', { message: data.audioUrl, type: 'audio' });
                            }
                        } catch (error) {
                            console.error('‰∏ä‰º†ËØ≠Èü≥Â§±Ë¥•:', error);
                            alert('‰∏ä‰º†ËØ≠Èü≥Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
                        }
                        
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    audioBtn.classList.add('recording');
                    audioBtn.title = 'ÂÅúÊ≠¢ÂΩïÂà∂';
                } catch (error) {
                    console.error('Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£é:', error);
                    alert('Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£éÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêËÆæÁΩÆ');
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                audioBtn.classList.remove('recording');
                audioBtn.title = 'ÂèëÈÄÅËØ≠Èü≥';
            }
        });

        socket.on('user-joined', (data) => {
            addSystemMessage(`${data.username} Âä†ÂÖ•‰∫ÜËÅäÂ§©ÂÆ§`);
            updateUserList(data.users);
            userCountSpan.textContent = data.userCount;
            
            // Êõ¥Êñ∞ÂΩìÂâçÁî®Êà∑ÁöÑÊùÉÈôê
            if (data.username === username) {
                const currentUser = data.users.find(u => u.username === username);
                if (currentUser) {
                    userPermissions = currentUser.permissions;
                    // Âä†ÂÖ•ÊàøÈó¥ÊàêÂäüÂêéÂàáÊç¢Âà∞ËÅäÂ§©ÁïåÈù¢
                    loginForm.classList.add('hidden');
                    chatForm.classList.remove('hidden');
                    messageInput.focus();
                }
            }
        });
        
        socket.on('user-permissions-changed', (data) => {
            // Êõ¥Êñ∞ÂΩìÂâçÁî®Êà∑ÁöÑÊùÉÈôê
            const currentUser = data.users.find(u => u.socketId === socket.id);
            if (currentUser) {
                userPermissions = currentUser.permissions;
            }
        });

        socket.on('permission-denied', (data) => {
            alert(data.message);
        });

        socket.on('message', (data) => {
            addMessage(data);
        });

        socket.on('user-left', (data) => {
            addSystemMessage(`${data.username} Á¶ªÂºÄ‰∫ÜËÅäÂ§©ÂÆ§`);
            updateUserList(data.users);
            userCountSpan.textContent = data.userCount;
        });

        socket.on('user-renamed', (data) => {
            addSystemMessage(`${data.oldName} ÊîπÂêç‰∏∫ ${data.newName}`);
            updateUserList(data.users);
            
            // Â¶ÇÊûúÂΩìÂâçÁî®Êà∑Ë¢´ÈáçÂëΩÂêçÔºåÊõ¥Êñ∞Êú¨Âú∞Áî®Êà∑Âêç
            if (data.oldName === username) {
                username = data.newName;
            }
        });

        socket.on('system-message', (data) => {
            addSystemMessage(data.message, true);
        });

        socket.on('messages-cleared', () => {
            messagesDiv.innerHTML = '<div class="system-message">Ê∂àÊÅØÂ∑≤Ë¢´ÁÆ°ÁêÜÂëòÊ∏ÖÁ©∫</div>';
        });

        socket.on('kicked', (message) => {
            alert(message);
            location.reload();
        });

        socket.on('message-recalled', (messageId) => {
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageDiv) {
                const username = messageDiv.querySelector('.username').textContent;
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="username" style="color: ${messageDiv.querySelector('.username').style.color}">${username}</span>
                        <span class="timestamp">${messageDiv.querySelector('.timestamp').textContent}</span>
                    </div>
                    <div class="message-content">[Ê∂àÊÅØÂ∑≤Êí§Âõû]</div>
                `;
            }
        });
        
        // ÊêúÁ¥¢ÂäüËÉΩ
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.trim().toLowerCase();
            currentSearchTerm = searchTerm;
            
            if (searchTerm === '') {
                updateUserList(allUsers);
                return;
            }
            
            const filteredUsers = allUsers.filter(user => 
                user.username.toLowerCase().includes(searchTerm)
            );
            
            updateUserList(filteredUsers);
        });
        
        // Áî®Êà∑ÂàóË°®ÂäüËÉΩ
        
        // ÊâìÂºÄÁî®Êà∑ÂàóË°®
        usersBtn.addEventListener('click', () => {
            usersModal.classList.add('active');
        });
        
        // ÂÖ≥Èó≠Áî®Êà∑ÂàóË°®
        function closeUsersModal() {
            usersModal.classList.remove('active');
        }
        
        // Â•ΩÂèãÁ≥ªÁªüÂäüËÉΩ
        
        // ÊâìÂºÄÂ•ΩÂèãÂàóË°®
        friendsBtn.addEventListener('click', () => {
            socket.emit('get-friends');
            friendsModal.classList.add('active');
        });
        
        // ÂÖ≥Èó≠Â•ΩÂèãÂàóË°®
        function closeFriendsModal() {
            friendsModal.classList.remove('active');
        }
        
        // ÂÖ≥Èó≠ÁßÅËÅäÊ®°ÊÄÅÊ°Ü
        function closePrivateChatModal() {
            privateChatModal.classList.remove('active');
            currentPrivateChatTarget = null;
        }
        
        // ÂèëÈÄÅÁßÅËÅäÊ∂àÊÅØ
        privateChatSendBtn.addEventListener('click', () => {
            const message = privateChatInput.value.trim();
            if (message && currentPrivateChatTarget) {
                socket.emit('private-message', {
                    targetSocketId: currentPrivateChatTarget,
                    message: message,
                    type: 'text'
                });
                privateChatInput.value = '';
            }
        });
        
        privateChatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                privateChatSendBtn.click();
            }
        });
        
        // ÊâìÂºÄÁßÅËÅä
        function openPrivateChat(friendSocketId, friendUsername) {
            currentPrivateChatTarget = friendSocketId;
            privateChatTitle.textContent = `‰∏é ${friendUsername} ÁßÅËÅä`;
            privateChatMessagesDiv.innerHTML = '';
            
            // Ëé∑ÂèñÁßÅËÅäÂéÜÂè≤Ê∂àÊÅØ
            socket.emit('get-private-messages', friendSocketId);
            
            privateChatModal.classList.add('active');
        }
        
        // Ê∑ªÂä†Â•ΩÂèã
        function addFriend(targetSocketId) {
            socket.emit('add-friend', targetSocketId);
        }
        
        // Âà†Èô§Â•ΩÂèã
        function removeFriend(friendSocketId) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Â•ΩÂèãÂêóÔºü')) {
                socket.emit('remove-friend', friendSocketId);
            }
        }
        
        // Socket‰∫ã‰ª∂Â§ÑÁêÜ - Â•ΩÂèãÁ≥ªÁªü
        
        // Â•ΩÂèãÂàóË°®
        socket.on('friends-list', (data) => {
            friends = data;
            updateFriendsList(data);
        });
        
        // Â•ΩÂèãËØ∑Ê±Ç
        socket.on('friend-request', (data) => {
            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'system-message';
            notificationDiv.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>${escapeHtml(data.fromUsername)}</strong> ËØ∑Ê±ÇÊ∑ªÂä†‰Ω†‰∏∫Â•ΩÂèã
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-confirm" onclick="socket.emit('accept-friend', '${data.fromSocketId}'); this.parentElement.parentElement.parentElement.remove();">Êé•Âèó</button>
                    <button class="btn btn-cancel" onclick="socket.emit('reject-friend', '${data.fromSocketId}'); this.parentElement.parentElement.parentElement.remove();">ÊãíÁªù</button>
                </div>
            `;
            messagesDiv.appendChild(notificationDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
        
        // Â•ΩÂèãËØ∑Ê±ÇË¢´Êé•Âèó
        socket.on('friend-accepted', (data) => {
            alert(`‰Ω†Â∑≤ÊàêÂäüÊ∑ªÂä† ${data.friendUsername} ‰∏∫Â•ΩÂèã`);
            socket.emit('get-friends');
        });
        
        // Â•ΩÂèãËØ∑Ê±ÇË¢´ÊãíÁªù
        socket.on('friend-rejected', (data) => {
            alert(`${data.friendUsername} ÊãíÁªù‰∫Ü‰Ω†ÁöÑÂ•ΩÂèãËØ∑Ê±Ç`);
        });
        
        // Â•ΩÂèãË¢´Âà†Èô§
        socket.on('friend-removed', (data) => {
            alert(`‰Ω†Â∑≤Âà†Èô§Â•ΩÂèã ${data.friendUsername}`);
            socket.emit('get-friends');
        });
        
        // ÁßÅËÅäÊ∂àÊÅØ
        socket.on('private-message', (data) => {
            addPrivateMessage(data);
        });
        
        // ÁßÅËÅäÂéÜÂè≤Ê∂àÊÅØ
        socket.on('private-messages-history', (data) => {
            data.messages.forEach(message => {
                addPrivateMessage(message);
            });
        });
        
        // Â•ΩÂèãÈîôËØØ
        socket.on('friend-error', (data) => {
            alert(data.message);
        });
        
        // @ÈÄöÁü•
        socket.on('mention-notification', (data) => {
            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'system-message mention';
            notificationDiv.innerHTML = `
                <strong>${escapeHtml(data.fromUsername)}</strong> @‰∫Ü‰Ω†Ôºö${escapeHtml(data.message)}
                <div style="font-size: 12px; color: #999; margin-top: 5px;">${data.timestamp}</div>
            `;
            messagesDiv.appendChild(notificationDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Êí≠ÊîæÊèêÁ§∫Èü≥
            const audio = new Audio('/notification.mp3');
            audio.play().catch(() => {});
        });
        
        // Êõ¥Êñ∞Â•ΩÂèãÂàóË°®
        function updateFriendsList(friends) {
            friendsListDiv.innerHTML = '';
            
            if (friends.length === 0) {
                friendsListDiv.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">ÊöÇÊó†Â•ΩÂèã</div>';
                return;
            }
            
            friends.forEach(friend => {
                const friendDiv = document.createElement('div');
                friendDiv.className = 'friend-item';
                friendDiv.onclick = function() {
                    const friendItems = document.querySelectorAll('.friend-item');
                    friendItems.forEach(item => {
                        item.classList.remove('expanded');
                    });
                    this.classList.toggle('expanded');
                };
                
                friendDiv.innerHTML = `
                    <div class="friend-color" style="background: ${friend.color}"></div>
                    <div class="friend-info">
                        <div class="friend-name">${escapeHtml(friend.username)}</div>
                        <div class="friend-status">${friend.online ? 'Âú®Á∫ø' : 'Á¶ªÁ∫ø'}</div>
                    </div>
                    <div class="friend-actions">
                        <button class="friend-btn" onclick="event.stopPropagation(); openPrivateChat('${friend.socketId}', '${friend.username}')">üí¨</button>
                        <button class="friend-btn danger" onclick="event.stopPropagation(); removeFriend('${friend.socketId}')">üóëÔ∏è</button>
                    </div>
                `;
                
                friendsListDiv.appendChild(friendDiv);
            });
        }
        
        // Ê∑ªÂä†ÁßÅËÅäÊ∂àÊÅØ
        function addPrivateMessage(data) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'private-chat-message' + (data.fromSocketId === socket.id ? ' sent' : '');
            
            messageDiv.innerHTML = `
                <div class="private-chat-message-header">
                    ${data.fromSocketId === socket.id ? 'Êàë' : data.fromUsername} - ${data.timestamp}
                </div>
                <div class="message-content">${escapeHtml(data.message)}</div>
            `;
            
            privateChatMessagesDiv.appendChild(messageDiv);
            privateChatMessagesDiv.scrollTop = privateChatMessagesDiv.scrollHeight;
        }
        
        // ÁÆ°ÁêÜÂëòÈù¢ÊùøÂäüËÉΩ
        
        // ÊâìÂºÄÁÆ°ÁêÜÂëòÈù¢Êùø
        adminPanelBtn.addEventListener('click', () => {
            // Âè™ÊúâadminÂíåsuperadminËßíËâ≤ÊâçËÉΩÊâìÂºÄÁÆ°ÁêÜÂëòÈù¢Êùø
            if (userRole === 'user') {
                alert('ÊÇ®Ê≤°ÊúâÊùÉÈôêËÆøÈóÆÁÆ°ÁêÜÂëòÈù¢Êùø');
                return;
            }
            
            adminPanelModal.classList.add('active');
            
            // Ëé∑ÂèñÁî®Êà∑ÂàóË°®
            socket.emit('admin-get-users');
            
            // Ëé∑ÂèñÊàøÈó¥ÂàóË°®
            socket.emit('admin-get-rooms');
        });
        
        // ÂÖ≥Èó≠ÁÆ°ÁêÜÂëòÈù¢Êùø
        function closeAdminPanelModal() {
            adminPanelModal.classList.remove('active');
        }
        
        // Ê†áÁ≠æÈ°µÂàáÊç¢
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // ÁßªÈô§ÊâÄÊúâactiveÁ±ª
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
                
                // Ê∑ªÂä†activeÁ±ªÂà∞ÂΩìÂâçÊ†áÁ≠æ
                tab.classList.add('active');
                const tabName = tab.dataset.tab;
                document.getElementById(tabName + 'Tab').classList.add('active');
                
                // Ê†πÊçÆÊ†áÁ≠æÈ°µÂä†ËΩΩÁõ∏Â∫îÊï∞ÊçÆ
                if (tabName === 'rooms') {
                    socket.emit('admin-get-rooms');
                } else if (tabName === 'messages') {
                    socket.emit('admin-get-messages');
                } else if (tabName === 'friends') {
                    socket.emit('admin-get-users');
                }
            });
        });
        
        // @ÂäüËÉΩÂºÄÂÖ≥
        document.getElementById('allowMentionsCheckbox').addEventListener('change', (e) => {
            socket.emit('admin-set-mentions', {
                allow: e.target.checked
            });
        });
        
        // Socket‰∫ã‰ª∂Â§ÑÁêÜ - ÁÆ°ÁêÜÂëòÈù¢Êùø
        
        // Áî®Êà∑ËßíËâ≤ÂèòÊõ¥
        socket.on('user-role-changed', (data) => {
            if (data.socketId === socket.id) {
                userRole = data.newRole;
                
                // Â¶ÇÊûúËßíËâ≤Âèò‰∏∫userÔºåÈöêËóèÁÆ°ÁêÜÂëòÈù¢ÊùøÊåâÈíÆ
                if (userRole === 'user') {
                    adminPanelBtn.style.display = 'none';
                } else {
                    adminPanelBtn.style.display = 'block';
                }
            }
            
            // Êõ¥Êñ∞ÁÆ°ÁêÜÂëòÈù¢Êùø‰∏≠ÁöÑÁî®Êà∑ÂàóË°®
            updateAdminUsersList(data.users);
        });
        
        // Ëé∑ÂèñÁî®Êà∑ÂàóË°®ÔºàÁî®‰∫éÁÆ°ÁêÜÂëòÈù¢ÊùøÁöÑÂ•ΩÂèãÁÆ°ÁêÜÊ†áÁ≠æÈ°µÔºâ
        socket.on('admin-get-users', (data) => {
            updateAdminFriendsList(data.users);
        });
        
        // Êõ¥Êñ∞ÁÆ°ÁêÜÂëòÁî®Êà∑ÂàóË°®
        function updateAdminUsersList(users) {
            adminUsersListDiv.innerHTML = '';
            
            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'admin-user-item';
                
                userDiv.innerHTML = `
                    <div class="admin-user-info">
                        <div class="admin-user-name">${escapeHtml(user.username)}</div>
                        <span class="admin-user-role ${user.role}">${user.role}</span>
                    </div>
                    <div class="admin-user-actions">
                        <select class="admin-select" onchange="changeUserRole('${user.socketId}', this.value)">
                            <option value="user" ${user.role === 'user' ? 'selected' : ''}>user</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>admin</option>
                            <option value="superadmin" ${user.role === 'superadmin' ? 'selected' : ''}>superadmin</option>
                        </select>
                        <button class="admin-action-btn" onclick="adminPrivateChat('${user.socketId}', '${user.username}')">ÁßÅËÅä</button>
                        <button class="admin-action-btn danger" onclick="kickUser('${user.socketId}')">Ë∏¢Âá∫</button>
                    </div>
                `;
                
                adminUsersListDiv.appendChild(userDiv);
            });
        }
        
        // Êõ¥Êñ∞ÁÆ°ÁêÜÂëòÂ•ΩÂèãÂàóË°®ÔºàÊòæÁ§∫ÊâÄÊúâÁî®Êà∑Ôºâ
        function updateAdminFriendsList(users) {
            adminFriendsListDiv.innerHTML = '';
            
            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'admin-user-item';
                
                userDiv.innerHTML = `
                    <div class="admin-user-info">
                        <div class="admin-user-name">${escapeHtml(user.username)}</div>
                        <span class="admin-user-role ${user.role}">${user.role}</span>
                    </div>
                    <div class="admin-user-actions">
                        <button class="admin-action-btn" onclick="adminPrivateChat('${user.socketId}', '${user.username}')">ÁßÅËÅä</button>
                        <button class="admin-action-btn" onclick="openPrivateChat('${user.socketId}', '${user.username}')">Êü•ÁúãÁßÅËÅä</button>
                    </div>
                `;
                
                adminFriendsListDiv.appendChild(userDiv);
            });
        }
        
        // Êõ¥ÊîπÁî®Êà∑ËßíËâ≤
        function changeUserRole(socketId, newRole) {
            socket.emit('admin-set-role', {
                socketId: socketId,
                role: newRole
            });
        }
        
        // ‰øÆÊîπÁî®Êà∑ÊùÉÈôê
        function changeUserPermissions(socketId, permissionKey, value) {
            const user = allUsers.find(u => u.socketId === socketId);
            if (user) {
                const newPermissions = { ...user.permissions };
                newPermissions[permissionKey] = value;
                
                socket.emit('admin-set-permissions', {
                    socketId: socketId,
                    permissions: newPermissions
                });
            }
        }
        
        // Ë∏¢Âá∫Áî®Êà∑
        function kickUser(socketId) {
            if (confirm('Á°ÆÂÆöË¶ÅË∏¢Âá∫Ëøô‰∏™Áî®Êà∑ÂêóÔºü')) {
                socket.emit('admin-kick-user', socketId);
            }
        }
        
        // ÁÆ°ÁêÜÂëòÁßÅËÅä
        function adminPrivateChat(socketId, username) {
            const message = prompt(`ÂèëÈÄÅÁßÅËÅäÊ∂àÊÅØÁªô ${username}Ôºö`);
            if (message) {
                socket.emit('admin-private-message', {
                    targetSocketId: socketId,
                    message: message,
                    type: 'text'
                });
            }
        }
        
        // ÊàøÈó¥Âä†ÂÖ•Â§±Ë¥•
        socket.on('join-error', (data) => {
            alert(data.message);
        });
        
        // ÊàøÈó¥ÂèòÊõ¥ÈÄöÁü•
        socket.on('room-changed', (data) => {
            currentRoom = data.roomName;
            // Ê∏ÖÁ©∫Ê∂àÊÅØÂàóË°®
            messagesDiv.innerHTML = '<div class="system-message">' + data.message + '</div>';
            // Êõ¥Êñ∞Áî®Êà∑ÂàóË°®
            updateUserList([]);
        });
        
        // ÊàøÈó¥ÂéÜÂè≤Ê∂àÊÅØ
        socket.on('room-history', (data) => {
            // Ê∏ÖÁ©∫ÂΩìÂâçÊ∂àÊÅØ
            messagesDiv.innerHTML = '';
            // Ê∑ªÂä†ÂéÜÂè≤Ê∂àÊÅØ
            data.messages.forEach(message => {
                addMessage(message);
            });
        });

        function recallMessage(messageId) {
            socket.emit('message-recall', messageId);
        }

        function addMessage(data) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.dataset.messageId = data.id;
            
            let contentHtml;
            if (data.type === 'image') {
                contentHtml = `<img src="${data.message}" alt="ÂõæÁâá" style="max-width: 100%; max-height: 200px; border-radius: 5px;">`;
            } else if (data.type === 'audio') {
                contentHtml = `<audio controls style="width: 100%; border-radius: 5px;"><source src="${data.message}" type="audio/webm">ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÈü≥È¢ëÊí≠Êîæ</audio>`;
            } else {
                contentHtml = escapeHtml(data.message);
            }
            
            let actionsHtml = '';
            if (data.username === username) {
                actionsHtml = `<div class="message-actions">
                    <button class="recall-btn" onclick="recallMessage('${data.id}')">Êí§Âõû</button>
                </div>`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="username" style="color: ${data.color}">${data.username}</span>
                    <span class="timestamp">${data.timestamp}</span>
                </div>
                <div class="message-content">${contentHtml}</div>
                ${actionsHtml}
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function addSystemMessage(text, isAdmin = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'system-message' + (isAdmin ? ' admin' : '');
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateUserList(users) {
            allUsers = users;
            searchResults = users;
            usersListDiv.innerHTML = '';
            
            if (users.length === 0) {
                usersListDiv.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">ÊöÇÊó†Âú®Á∫øÁî®Êà∑</div>';
                return;
            }
            
            users.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item';
                userDiv.onclick = () => {
                    showUserDetail(user.socketId, user.username, user.color, JSON.stringify(user.permissions).replace(/"/g, '&quot;'));
                };
                
                userDiv.innerHTML = `
                    <div class="user-color" style="background: ${user.color}"></div>
                    <div class="user-name">${escapeHtml(user.username)}</div>
                `;
                
                usersListDiv.appendChild(userDiv);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Â™í‰ΩìÂΩïÂà∂Âô®
        mediaRecorder = null;
        let mediaChunks = [];
        isRecording = false;
        let isDeviceSelectModalOpen = false;
        
        // Â™í‰ΩìÊ∫êÂíåÁºìÂÜ≤Âå∫
        let mediaSource = null;
        let sourceBuffer = null;
        let audioContext = null;
        let audioSource = null;
        let audioBuffer = null;
        let audioElement = null;
        
        // ÂΩìÂâçÂ™í‰ΩìURL
        let currentMediaUrl = null;
        
        // Â™í‰ΩìÊï∞ÊçÆÈòüÂàó
        let mediaDataQueue = [];
        
        // ËøúÁ®ãËßÜÈ¢ëÂíåÈü≥È¢ëÁºìÂÜ≤Âå∫
        remoteVideoBuffer = null;
        let remoteAudioBuffer = null;
        let remoteAudioIsPlaying = false;
        
        // Êé•Êî∂Êï∞ÊçÆÈòüÂàó
        let receiveDataQueue = [];
        let isAppending = false;

        // ÂºÄÂßãËßÜÈ¢ëÈÄöËØù
        async function startVideoCall(targetSocketId, targetUsername) {
            if (!userPermissions.allowCall) {
                alert('ÊÇ®Ê≤°ÊúâÈÄöËØùÊùÉÈôê');
                return;
            }
            
            isVideoCall = true;
            currentCallId = Date.now().toString();
            
            try {
                // Ê£ÄÊü•ÊµèËßàÂô®ÊîØÊåÅ
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÂ™í‰ΩìËÆæÂ§áËÆøÈóÆ');
                }
                
                // Ëé∑ÂèñÂèØÁî®ËÆæÂ§á
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                const audioDevices = devices.filter(device => device.kind === 'audioinput');
                
                console.log('ÂèØÁî®ËßÜÈ¢ëËÆæÂ§á:', videoDevices);
                console.log('ÂèØÁî®Èü≥È¢ëËÆæÂ§á:', audioDevices);
                
                if (videoDevices.length === 0) {
                    throw new Error('Êú™Ê£ÄÊµãÂà∞ÊëÑÂÉèÂ§¥ËÆæÂ§á');
                }
                
                if (audioDevices.length === 0) {
                    throw new Error('Êú™Ê£ÄÊµãÂà∞È∫¶ÂÖãÈ£éËÆæÂ§á');
                }
                
                // Â¶ÇÊûúÊúâÂ§ö‰∏™ËÆæÂ§áÔºåÊòæÁ§∫ËÆæÂ§áÈÄâÊã©ÁïåÈù¢
                if (videoDevices.length > 1 || audioDevices.length > 1) {
                    availableVideoDevices = videoDevices;
                    availableAudioDevices = audioDevices;
                    selectedVideoDeviceId = videoDevices[0].deviceId;
                    selectedAudioDeviceId = audioDevices[0].deviceId;
                    pendingCallAction = { type: 'video', targetSocketId, targetUsername };
                    showDeviceSelectModal();
                    return;
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true
                    },
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });
                
                localStream = stream;
                localVideo.srcObject = stream;
                
                // ËÆæÁΩÆÁõÆÊ†áSocket ID
                currentTargetSocketId = targetSocketId;
                
                socket.emit('call-request', {
                    targetSocketId: targetSocketId,
                    callId: currentCallId,
                    type: 'video',
                    fromUsername: username
                });
                
                videoContainer.classList.add('active');
                addSystemMessage(`Ê≠£Âú®Âêë ${targetUsername} ÂèëËµ∑ËßÜÈ¢ëÈÄöËØù...`);
            } catch (error) {
                console.error('Ëé∑ÂèñÊëÑÂÉèÂ§¥Â§±Ë¥•:', error);
                let errorMessage = 'Êó†Ê≥ïËÆøÈóÆÊëÑÂÉèÂ§¥ÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêËÆæÁΩÆ';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage = 'ÊÇ®ÊãíÁªù‰∫ÜÊëÑÂÉèÂ§¥ÂíåÈ∫¶ÂÖãÈ£éÊùÉÈôêÔºåËØ∑Âú®ÊµèËßàÂô®ËÆæÁΩÆ‰∏≠ÂÖÅËÆ∏ËÆøÈóÆ';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'Êú™ÊâæÂà∞ÊëÑÂÉèÂ§¥ÊàñÈ∫¶ÂÖãÈ£éËÆæÂ§á';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'Êó†Ê≥ïËØªÂèñÊëÑÂÉèÂ§¥ÊàñÈ∫¶ÂÖãÈ£éÊï∞ÊçÆ';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                alert(errorMessage);
            }
        }

        // ÂºÄÂßãËØ≠Èü≥ÈÄöËØù
        async function startAudioCall(targetSocketId, targetUsername) {
            if (!userPermissions.allowCall) {
                alert('ÊÇ®Ê≤°ÊúâÈÄöËØùÊùÉÈôê');
                return;
            }
            
            isVideoCall = false;
            currentCallId = Date.now().toString();
            currentTargetSocketId = targetSocketId;
            
            try {
                // Ê£ÄÊü•ÊµèËßàÂô®ÊîØÊåÅ
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÂ™í‰ΩìËÆæÂ§áËÆøÈóÆ');
                }
                
                // Ëé∑ÂèñÂèØÁî®ËÆæÂ§á
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioDevices = devices.filter(device => device.kind === 'audioinput');
                
                console.log('ÂèØÁî®Èü≥È¢ëËÆæÂ§á:', audioDevices);
                
                if (audioDevices.length === 0) {
                    throw new Error('Êú™Ê£ÄÊµãÂà∞È∫¶ÂÖãÈ£éËÆæÂ§á');
                }
                
                // Â¶ÇÊûúÊúâÂ§ö‰∏™ËÆæÂ§áÔºåÊòæÁ§∫ËÆæÂ§áÈÄâÊã©ÁïåÈù¢
                if (audioDevices.length > 1) {
                    availableVideoDevices = [];
                    availableAudioDevices = audioDevices;
                    selectedVideoDeviceId = null;
                    selectedAudioDeviceId = audioDevices[0].deviceId;
                    pendingCallAction = { type: 'audio', targetSocketId, targetUsername };
                    showDeviceSelectModal();
                    return;
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                localStream = stream;
                
                // ‰∏çË¶ÅÁ´ãÂç≥ÂºÄÂßãÂΩïÂà∂ÔºåÁ≠âÂæÖÂØπÊñπÊé•ÂèóÈÄöËØùÂêéÂÜçÂºÄÂßã
                // startMediaRecording(stream);
                
                socket.emit('call-request', {
                    targetSocketId: targetSocketId,
                    callId: currentCallId,
                    type: 'audio',
                    fromUsername: username
                });
                
                videoContainer.classList.add('active');
                addSystemMessage(`Ê≠£Âú®Âêë ${targetUsername} ÂèëËµ∑ËØ≠Èü≥ÈÄöËØù...`);
            } catch (error) {
                console.error('Ëé∑ÂèñÈ∫¶ÂÖãÈ£éÂ§±Ë¥•:', error);
                let errorMessage = 'Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£éÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêËÆæÁΩÆ';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage = 'ÊÇ®ÊãíÁªù‰∫ÜÈ∫¶ÂÖãÈ£éÊùÉÈôêÔºåËØ∑Âú®ÊµèËßàÂô®ËÆæÁΩÆ‰∏≠ÂÖÅËÆ∏ËÆøÈóÆ';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'Êú™ÊâæÂà∞È∫¶ÂÖãÈ£éËÆæÂ§á';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'Êó†Ê≥ïËØªÂèñÈ∫¶ÂÖãÈ£éÊï∞ÊçÆ';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                alert(errorMessage);
            }
        }

        // ÂºÄÂßãÂ™í‰ΩìÂΩïÂà∂
        function startMediaRecording(stream) {
            mediaChunks = [];
            
            // Ê£ÄÊü•ÊµèËßàÂô®ÊîØÊåÅÁöÑ MIME Á±ªÂûãÔºå‰ºòÂÖà‰ΩøÁî® mp4 Ê†ºÂºè
            let mimeType;
            if (isVideoCall) {
                const videoTypes = [
                    'video/mp4',
                    'video/webm',
                    'video/webm;codecs=vp9,opus',
                    'video/webm;codecs=vp8,opus',
                    'video/webm;codecs=h264'
                ];
                mimeType = videoTypes.find(type => MediaRecorder.isTypeSupported(type)) || 'video/webm';
            } else {
                const audioTypes = [
                    'audio/mp4',
                    'audio/webm',
                    'audio/webm;codecs=opus',
                    'audio/ogg;codecs=opus'
                ];
                mimeType = audioTypes.find(type => MediaRecorder.isTypeSupported(type)) || 'audio/webm';
            }
            
            console.log('‰ΩøÁî®ÁöÑ MIME Á±ªÂûã:', mimeType);
            
            mediaRecorder = new MediaRecorder(stream, { 
                mimeType,
                videoBitsPerSecond: isVideoCall ? 500000 : undefined
            });
            
            mediaRecorder.ondataavailable = async (event) => {
                if (event.data && event.data.size > 0) {
                    try {
                        // Â∞ÜBlobËΩ¨Êç¢‰∏∫Uint8Array
                        const arrayBuffer = await event.data.arrayBuffer();
                        const uint8Array = new Uint8Array(arrayBuffer);
                        
                        // ÈÄöËøáSocket.ioÂèëÈÄÅÂ™í‰ΩìÊï∞ÊçÆ
                        socket.emit('call-media', {
                            targetSocketId: currentTargetSocketId,
                            callId: currentCallId,
                            type: isVideoCall ? 'video' : 'audio',
                            mimeType: mimeType,
                            data: uint8Array
                        });
                    } catch (error) {
                        console.error('ÂèëÈÄÅÂ™í‰ΩìÊï∞ÊçÆÂ§±Ë¥•:', error);
                    }
                }
            };
            
            mediaRecorder.start(50); // ÊØè50msÂèëÈÄÅ‰∏ÄÊ¨°Êï∞ÊçÆ
            isRecording = true;
        }

        // ÂÅúÊ≠¢Â™í‰ΩìÂΩïÂà∂
        function stopMediaRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
            }
            
            // Ê∏ÖÁêÜ MediaSource Âíå SourceBuffer
            if (sourceBuffer) {
                try {
                    sourceBuffer.abort();
                } catch (e) {
                    console.error('‰∏≠Ê≠¢ SourceBuffer Â§±Ë¥•:', e);
                }
                sourceBuffer = null;
            }
            
            if (mediaSource) {
                try {
                    if (mediaSource.readyState === 'open') {
                        mediaSource.endOfStream();
                    }
                } catch (e) {
                    console.error('ÁªìÊùü MediaStream Â§±Ë¥•:', e);
                }
                
                try {
                    URL.revokeObjectURL(remoteVideo.src);
                    if (audioElement) {
                        URL.revokeObjectURL(audioElement.src);
                    }
                } catch (e) {
                    console.error('ÈáäÊîæ URL Â§±Ë¥•:', e);
                }
                mediaSource = null;
            }
            
            if (audioElement) {
                audioElement = null;
            }
            
            // Ê∏ÖÁêÜÂΩìÂâçÁöÑÂ™í‰ΩìURL
            if (currentMediaUrl) {
                try {
                    URL.revokeObjectURL(currentMediaUrl);
                } catch (e) {
                    console.error('ÈáäÊîæ URL Â§±Ë¥•:', e);
                }
                currentMediaUrl = null;
            }
        }

        // Êé•ÂèóÈÄöËØù
        async function acceptCall() {
            callIncoming.classList.remove('active');
            
            try {
                // Ê£ÄÊü•ÊµèËßàÂô®ÊîØÊåÅ
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÂ™í‰ΩìËÆæÂ§áËÆøÈóÆ');
                }
                
                // Ëé∑ÂèñÂèØÁî®ËÆæÂ§á
                const devices = await navigator.mediaDevices.enumerateDevices();
                
                if (isVideoCall) {
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    const audioDevices = devices.filter(device => device.kind === 'audioinput');
                    
                    console.log('ÂèØÁî®ËßÜÈ¢ëËÆæÂ§á:', videoDevices);
                    console.log('ÂèØÁî®Èü≥È¢ëËÆæÂ§á:', audioDevices);
                    
                    if (videoDevices.length === 0) {
                        throw new Error('Êú™Ê£ÄÊµãÂà∞ÊëÑÂÉèÂ§¥ËÆæÂ§á');
                    }
                    
                    if (audioDevices.length === 0) {
                        throw new Error('Êú™Ê£ÄÊµãÂà∞È∫¶ÂÖãÈ£éËÆæÂ§á');
                    }
                    
                    // Â¶ÇÊûúÊúâÂ§ö‰∏™ËÆæÂ§áÔºåÊòæÁ§∫ËÆæÂ§áÈÄâÊã©ÁïåÈù¢
                    if (videoDevices.length > 1 || audioDevices.length > 1) {
                        availableVideoDevices = videoDevices;
                        availableAudioDevices = audioDevices;
                        selectedVideoDeviceId = videoDevices[0].deviceId;
                        selectedAudioDeviceId = audioDevices[0].deviceId;
                        // ËÆæÁΩÆpendingCallActionÔºåÁî®‰∫éËÆæÂ§áÈÄâÊã©ÂêéÁöÑÈÄöËØùÊµÅÁ®ã
                        pendingCallAction = { 
                            type: 'video', 
                            isAcceptingCall: true,
                            targetSocketId: currentCallerSocketId,
                            targetUsername: 'ÂØπÊñπ'
                        };
                        showDeviceSelectModal();
                        return;
                    }
                    
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true
                        },
                        video: {
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'user'
                        }
                    });
                    
                    localStream = stream;
                    localVideo.srcObject = stream;
                    
                    // Êé•ÂèóÈÄöËØùÊó∂Á´ãÂç≥ÂºÄÂßãÂΩïÂà∂Âπ∂ÂèëÈÄÅÊï∞ÊçÆ
                    startMediaRecording(stream);
                    
                    // ËÆæÁΩÆÁõÆÊ†áSocket IDÔºåÁ°Æ‰øùËÉΩÂèëÈÄÅÊï∞ÊçÆÁªôÂØπÊñπ
                    currentTargetSocketId = currentCallerSocketId;
                    
                    socket.emit('call-accept', {
                        callerSocketId: currentCallerSocketId,
                        callId: currentCallId
                    });
                    
                    videoContainer.classList.add('active');
                    addSystemMessage('ÈÄöËØùÂ∑≤Êé•ÈÄö');
                } else {
                    const audioDevices = devices.filter(device => device.kind === 'audioinput');
                    
                    console.log('ÂèØÁî®Èü≥È¢ëËÆæÂ§á:', audioDevices);
                    
                    if (audioDevices.length === 0) {
                        throw new Error('Êú™Ê£ÄÊµãÂà∞È∫¶ÂÖãÈ£éËÆæÂ§á');
                    }
                    
                    // Â¶ÇÊûúÊúâÂ§ö‰∏™ËÆæÂ§áÔºåÊòæÁ§∫ËÆæÂ§áÈÄâÊã©ÁïåÈù¢
                    if (audioDevices.length > 1) {
                        availableVideoDevices = [];
                        availableAudioDevices = audioDevices;
                        selectedVideoDeviceId = null;
                        selectedAudioDeviceId = audioDevices[0].deviceId;
                        // ËÆæÁΩÆpendingCallActionÔºåÁî®‰∫éËÆæÂ§áÈÄâÊã©ÂêéÁöÑÈÄöËØùÊµÅÁ®ã
                        pendingCallAction = { 
                            type: 'audio', 
                            isAcceptingCall: true,
                            targetSocketId: currentCallerSocketId,
                            targetUsername: 'ÂØπÊñπ'
                        };
                        showDeviceSelectModal();
                        return;
                    }
                    
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true
                        }
                    });
                    
                    localStream = stream;
                    
                    // Êé•ÂèóÈÄöËØùÊó∂Á´ãÂç≥ÂºÄÂßãÂΩïÂà∂Âπ∂ÂèëÈÄÅÊï∞ÊçÆ
                    // startMediaRecording(stream);
                    
                    // ËÆæÁΩÆÁõÆÊ†áSocket IDÔºåÁ°Æ‰øùËÉΩÂèëÈÄÅÊï∞ÊçÆÁªôÂØπÊñπ
                    currentTargetSocketId = currentCallerSocketId;
                    
                    socket.emit('call-accept', {
                        callerSocketId: currentCallerSocketId,
                        callId: currentCallId
                    });
                    
                    videoContainer.classList.add('active');
                    addSystemMessage('ÈÄöËØùÂ∑≤Êé•ÈÄö');
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÂ™í‰ΩìÊµÅÂ§±Ë¥•:', error);
                let errorMessage = 'Êó†Ê≥ïËÆøÈóÆÊëÑÂÉèÂ§¥/È∫¶ÂÖãÈ£éÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêËÆæÁΩÆ';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage = 'ÊÇ®ÊãíÁªù‰∫ÜÊëÑÂÉèÂ§¥ÂíåÈ∫¶ÂÖãÈ£éÊùÉÈôêÔºåËØ∑Âú®ÊµèËßàÂô®ËÆæÁΩÆ‰∏≠ÂÖÅËÆ∏ËÆøÈóÆ';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'Êú™ÊâæÂà∞ÊëÑÂÉèÂ§¥ÊàñÈ∫¶ÂÖãÈ£éËÆæÂ§á';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'Êó†Ê≥ïËØªÂèñÊëÑÂÉèÂ§¥ÊàñÈ∫¶ÂÖãÈ£éÊï∞ÊçÆ';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                alert(errorMessage);
                // ÈáçÁΩÆÊù•ÁîµÁä∂ÊÄÅ
                callIncoming.classList.remove('active');
                currentCallId = null;
            }
        }

        // ÊãíÁªùÈÄöËØù
        function rejectCall() {
            callIncoming.classList.remove('active');
            
                socket.emit('call-media', {
                    targetSocketId: currentCallerSocketId,
                    callId: currentCallId,
                    type: 'reject'
                });
                
                addSystemMessage('Â∑≤ÊãíÁªùÈÄöËØù');
                currentCallId = null;
            }   
        

        // ÁªìÊùüÈÄöËØù
        function endCall() {
            stopMediaRecording();
            
            // Ê∏ÖÁêÜÂ™í‰ΩìURL
            if (currentMediaUrl) {
                URL.revokeObjectURL(currentMediaUrl);
                currentMediaUrl = null;
            }
            
            // Ê∏ÖÁêÜÂ™í‰ΩìÊ∫êÂíåÈü≥È¢ë‰∏ä‰∏ãÊñá
            if (mediaSource) {
                mediaSource.endOfStream();
                remoteVideo.srcObject = null;
                mediaSource = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            videoContainer.classList.remove('active');
            
            if (currentTargetSocketId) {
                socket.emit('call-end', {
                    targetSocketId: currentTargetSocketId,
                    callId: currentCallId
                });
            }
            
            currentCallId = null;
            currentTargetSocketId = null;
            sourceBuffer = [];
            audioBuffer = [];
            mediaDataQueue = [];
            addSystemMessage('ÈÄöËØùÂ∑≤ÁªìÊùü');
        }

        // ÂàáÊç¢ËßÜÈ¢ë
        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    isVideoEnabled = !isVideoEnabled;
                    videoTrack.enabled = isVideoEnabled;
                    toggleVideoBtn.textContent = isVideoEnabled ? 'üìπ' : 'üö´';
                }
            }
        }

        // ÂàáÊç¢Èü≥È¢ë
        function toggleAudio() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    isAudioEnabled = !isAudioEnabled;
                    audioTrack.enabled = isAudioEnabled;
                    toggleAudioBtn.textContent = isAudioEnabled ? 'üé§' : 'üîá';
                }
            }
        }

        // Socket‰∫ã‰ª∂Â§ÑÁêÜ
        
        // ÊòæÁ§∫Áî®Êà∑ËØ¶ÊÉÖ
        function showUserDetail(socketId, username, color, permissions) {
            usersModal.classList.remove('active');
            userDetailTitle.textContent = 'Áî®Êà∑ËØ¶ÊÉÖ';
            userDetailContent.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <div class="user-color" style="background: ${color}; width: 50px; height: 50px; border-radius: 50%;"></div>
                        <div>
                            <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">${escapeHtml(username)}</div>
                            <div style="font-size: 12px; color: #666;">Socket ID: ${socketId}</div>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: bold; margin-bottom: 5px;">ÊùÉÈôê</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <span>ÂèëÈÄÅËØ≠Èü≥:</span>
                                <input type="checkbox" ${permissions.allowAudio ? 'checked' : ''} onchange="changeUserPermissions('${socketId}', 'allowAudio', this.checked)">
                            </div>
                            <div>
                                <span>ÂèëÈÄÅÂõæÁâá:</span>
                                <input type="checkbox" ${permissions.allowImage ? 'checked' : ''} onchange="changeUserPermissions('${socketId}', 'allowImage', this.checked)">
                            </div>
                            <div>
                                <span>ÂèëÈÄÅÊñá‰ª∂:</span>
                                <input type="checkbox" ${permissions.allowFile ? 'checked' : ''} onchange="changeUserPermissions('${socketId}', 'allowFile', this.checked)">
                            </div>
                            <div>
                                <span>ÂèëÈÄÅÊ∂àÊÅØ:</span>
                                <input type="checkbox" ${permissions.allowSendMessages ? 'checked' : ''} onchange="changeUserPermissions('${socketId}', 'allowSendMessages', this.checked)">
                            </div>
                            <div>
                                <span>Êü•ÁúãÊ∂àÊÅØ:</span>
                                <input type="checkbox" ${permissions.allowViewMessages ? 'checked' : ''} onchange="changeUserPermissions('${socketId}', 'allowViewMessages', this.checked)">
                            </div>
                            <div>
                                <span>ÈÄöËØù:</span>
                                <input type="checkbox" ${permissions.allowCall ? 'checked' : ''} onchange="changeUserPermissions('${socketId}', 'allowCall', this.checked)">
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-confirm" onclick="addFriend('${socketId}'); closeUserDetailModal();">Ê∑ªÂä†Â•ΩÂèã</button>
                    </div>
                </div>
            `;
            
            userDetailModal.classList.add('active');
        }
        
        // ÂÖ≥Èó≠Áî®Êà∑ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
        function closeUserDetailModal() {
            userDetailModal.classList.remove('active');
            usersModal.classList.add('active');
        }
        
        // Socket‰∫ã‰ª∂Â§ÑÁêÜ
        let currentCallerSocketId = null;
        let currentTargetSocketId = null;
        let remoteVideoBuffer = [];

        // Êé•Êî∂ÈÄöËØùËØ∑Ê±Ç
        socket.on('call-request', (data) => {
            if (!userPermissions.allowCall) {
                socket.emit('call-reject', {
                    callerSocketId: data.from,
                    callId: data.callId
                });
                return;
            }
            
            currentCallerSocketId = data.from;
            currentCallId = data.callId;
            // ‰ªéËØ∑Ê±ÇÊï∞ÊçÆ‰∏≠Ëé∑ÂèñÈÄöËØùÁ±ªÂûã
            isVideoCall = data.type === 'video';
            
            callIncomingText.textContent = `${data.fromUsername} ËØ∑Ê±Ç${isVideoCall ? 'ËßÜÈ¢ë' : 'ËØ≠Èü≥'}ÈÄöËØù`;
            callIncoming.classList.add('active');
        });

        // ÈÄöËØùË¢´Êé•Âèó
        socket.on('call-accepted', (data) => {
            addSystemMessage('ÂØπÊñπÂ∑≤Êé•ÂèóÈÄöËØù');
            // ÂØπÊñπÊé•ÂèóÈÄöËØùÂêéÔºåÂºÄÂßãÂèëÈÄÅÂ™í‰ΩìÊï∞ÊçÆ
            if (localStream && !isRecording) {
                startMediaRecording(localStream);
            }
        });

        // ÈÄöËØùË¢´ÊãíÁªù
        socket.on('call-rejected', (data) => {
            stopMediaRecording();
            addSystemMessage('ÂØπÊñπÊãíÁªù‰∫ÜÈÄöËØù');
            currentCallId = null;
        });

        // ÈÄöËØùÁªìÊùü
        socket.on('call-ended', (data) => {
            stopMediaRecording();
            videoContainer.classList.remove('active');
            currentCallId = null;
            addSystemMessage('ÈÄöËØùÂ∑≤ÁªìÊùü');
        });

        // Êé•Êî∂Â™í‰ΩìÊï∞ÊçÆ
        socket.on('call-media', (data) => {
            if (data.callId === currentCallId) {
                try {
                    // Â∞ÜUint8ArrayËΩ¨Êç¢ÂõûBlobÔºå‰ΩøÁî®Êé•Êî∂Âà∞ÁöÑ MIME Á±ªÂûã
                    const uint8Array = new Uint8Array(data.data);
                    let mimeType = data.mimeType || (isVideoCall ? 'video/webm' : 'audio/webm');
                    
                    // Â∞ÜÊï∞ÊçÆÊ∑ªÂä†Âà∞ÈòüÂàó
                    receiveDataQueue.push({ uint8Array, mimeType });
                    
                    // Â¶ÇÊûúÊ≤°ÊúâÊ≠£Âú®Â§ÑÁêÜÊï∞ÊçÆÔºåÂºÄÂßãÂ§ÑÁêÜÈòüÂàó
                    if (!isAppending) {
                        processReceiveQueue();
                    }
                } catch (error) {
                    console.error('Êí≠ÊîæÂ™í‰ΩìÊï∞ÊçÆÂ§±Ë¥•:', error);
                }
            }
        });
        
        // Â§ÑÁêÜÊé•Êî∂Êï∞ÊçÆÈòüÂàó
        function processReceiveQueue() {
            if (receiveDataQueue.length === 0) {
                isAppending = false;
                return;
            }
            
            isAppending = true;
            const { uint8Array, mimeType } = receiveDataQueue.shift();
            
            // Ê£ÄÊü•ÊµèËßàÂô®ÊòØÂê¶ÊîØÊåÅËøô‰∏™ MIME Á±ªÂûãÁî®‰∫é SourceBuffer
            if (isVideoCall) {
                // ËßÜÈ¢ëÊí≠Êîæ - ‰ΩøÁî® MediaSource API
                if (!mediaSource) {
                    mediaSource = new MediaSource();
                    remoteVideo.src = URL.createObjectURL(mediaSource);
                    
                    mediaSource.addEventListener('sourceopen', () => {
                        console.log('MediaSource Â∑≤ÊâìÂºÄÔºåÂ∞ùËØï‰ΩøÁî® MIME Á±ªÂûã:', mimeType);
                        
                        // Ê£ÄÊü•ÊµèËßàÂô®ÊîØÊåÅÁöÑ MIME Á±ªÂûã
                        const videoTypes = [
                            mimeType,
                            'video/webm;codecs=vp9,opus',
                            'video/webm;codecs=vp8,opus',
                            'video/webm;codecs=vp8',
                            'video/webm',
                            'video/mp4'
                        ];
                        
                        for (const type of videoTypes) {
                            try {
                                if (MediaSource.isTypeSupported(type)) {
                                    console.log('‰ΩøÁî®ÊîØÊåÅÁöÑ MIME Á±ªÂûã:', type);
                                    sourceBuffer = mediaSource.addSourceBuffer(type);
                                    sourceBuffer.addEventListener('updateend', () => {
                                        console.log('ÁºìÂÜ≤Âå∫Êõ¥Êñ∞ÂÆåÊàê');
                                        // Â§ÑÁêÜ‰∏ã‰∏Ä‰∏™Êï∞ÊçÆ
                                        processReceiveQueue();
                                    });
                                    break;
                                }
                            } catch (e) {
                                console.log('Â∞ùËØï', type, 'Â§±Ë¥•:', e.message);
                            }
                        }
                    });
                }
                
                // Â∞ÜÊï∞ÊçÆÊ∑ªÂä†Âà∞ÁºìÂÜ≤Âå∫
                if (sourceBuffer && mediaSource.readyState === 'open') {
                    const appendData = () => {
                        if (!sourceBuffer.updating) {
                            try {
                                sourceBuffer.appendBuffer(uint8Array);
                                console.log('ÊàêÂäüÊ∑ªÂä†Êï∞ÊçÆÔºåÂ§ßÂ∞è:', uint8Array.length);
                            } catch (e) {
                                console.error('Ê∑ªÂä†ÁºìÂÜ≤Âå∫Â§±Ë¥•:', e);
                            }
                        } else {
                            // Â¶ÇÊûúÊ≠£Âú®Êõ¥Êñ∞ÔºåÁ≠âÂæÖ50msÂêéÈáçËØï
                            setTimeout(appendData, 50);
                        }
                    };
                    appendData();
                }
            } else {
                // Èü≥È¢ëÊí≠Êîæ - ‰ΩøÁî® MediaSource API
                if (!mediaSource) {
                    mediaSource = new MediaSource();
                    if (!audioElement) {
                        audioElement = new Audio();
                        audioElement.autoplay = true;
                    }
                    audioElement.src = URL.createObjectURL(mediaSource);
                    
                    mediaSource.addEventListener('sourceopen', () => {
                        console.log('MediaSource Â∑≤ÊâìÂºÄÔºåÂ∞ùËØï‰ΩøÁî® MIME Á±ªÂûã:', mimeType);
                        
                        // Ê£ÄÊü•ÊµèËßàÂô®ÊîØÊåÅÁöÑ MIME Á±ªÂûã
                        const audioTypes = [
                            mimeType,
                            'audio/webm;codecs=opus',
                            'audio/webm',
                            'audio/ogg;codecs=opus',
                            'audio/mp4'
                        ];
                        
                        for (const type of audioTypes) {
                            try {
                                if (MediaSource.isTypeSupported(type)) {
                                    console.log('‰ΩøÁî®ÊîØÊåÅÁöÑ MIME Á±ªÂûã:', type);
                                    sourceBuffer = mediaSource.addSourceBuffer(type);
                                    sourceBuffer.addEventListener('updateend', () => {
                                        console.log('ÁºìÂÜ≤Âå∫Êõ¥Êñ∞ÂÆåÊàê');
                                        // Â§ÑÁêÜ‰∏ã‰∏Ä‰∏™Êï∞ÊçÆ
                                        processReceiveQueue();
                                    });
                                    break;
                                }
                            } catch (e) {
                                console.log('Â∞ùËØï', type, 'Â§±Ë¥•:', e.message);
                            }
                        }
                    });
                }
                
                // Â∞ÜÊï∞ÊçÆÊ∑ªÂä†Âà∞ÁºìÂÜ≤Âå∫
                if (sourceBuffer && mediaSource.readyState === 'open') {
                    const appendData = () => {
                        if (!sourceBuffer.updating) {
                            try {
                                sourceBuffer.appendBuffer(uint8Array);
                                console.log('ÊàêÂäüÊ∑ªÂä†Êï∞ÊçÆÔºåÂ§ßÂ∞è:', uint8Array.length);
                            } catch (e) {
                                console.error('Ê∑ªÂä†ÁºìÂÜ≤Âå∫Â§±Ë¥•:', e);
                            }
                        } else {
                            // Â¶ÇÊûúÊ≠£Âú®Êõ¥Êñ∞ÔºåÁ≠âÂæÖ50msÂêéÈáçËØï
                            setTimeout(appendData, 50);
                        }
                    };
                    appendData();
                }
            }
        }

        // ËßÜÈ¢ëÈÄöËØùÊåâÈíÆ‰∫ã‰ª∂
        // videoCallBtn.addEventListener('click', () => {
        //     const targetUser = prompt('ËØ∑ËæìÂÖ•Ë¶ÅËßÜÈ¢ëÈÄöËØùÁöÑÁî®Êà∑Âêç:');
        //     if (targetUser) {
        //         const userElements = usersListDiv.querySelectorAll('.user-item');
        //         for (let userElement of userElements) {
        //             const name = userElement.querySelector('.user-name').textContent;
        //             if (name === targetUser) {
        //                 const callBtn = userElement.querySelector('.call-btn');
        //                 if (callBtn && callBtn.textContent === 'üìπ') {
        //                     const socketId = callBtn.getAttribute('onclick').match(/'([^']+)'/)[1];
        //                     startVideoCall(socketId, targetUser);
        //                     return;
        //                 }
        //         }
        //         alert('Êú™ÊâæÂà∞ËØ•Áî®Êà∑ÊàñËØ•Áî®Êà∑Ê≤°ÊúâÈÄöËØùÊùÉÈôê');
        // });
        
        // // ËØ≠Èü≥ÈÄöËØùÊåâÈíÆ‰∫ã‰ª∂
        // audioCallBtn.addEventListener('click', () => {
        //     const targetUser = prompt('ËØ∑ËæìÂÖ•Ë¶ÅËØ≠Èü≥ÈÄöËØùÁöÑÁî®Êà∑Âêç:');
        //     if (targetUser) {
        //         const userElements = usersListDiv.querySelectorAll('.user-item');
        //         for (let userElement of userElements) {
        //             const name = userElement.querySelector('.user-name').textContent;
        //             if (name === targetUser) {
        //                 const callBtns = userElement.querySelectorAll('.call-btn');
        //                 for (let callBtn of callBtns) {
        //                     if (callBtn.textContent === 'üìû') {
        //                         const socketId = callBtn.getAttribute('onclick').match(/'([^']+)'/)[1];
        //                         startAudioCall(socketId, targetUser);
        //                         return;
        //                     }
        //                 }
        //         }
        //         alert('Êú™ÊâæÂà∞ËØ•Áî®Êà∑ÊàñËØ•Áî®Êà∑Ê≤°ÊúâÈÄöËØùÊùÉÈôê');
        // });
        
        // // ËßÜÈ¢ëÊéßÂà∂ÊåâÈíÆ‰∫ã‰ª∂
        // toggleVideoBtn.addEventListener('click', toggleVideo);
        // toggleAudioBtn.addEventListener('click', toggleAudio);
        // endCallBtn.addEventListener('click', endCall);
        
        // ÊòæÁ§∫ËÆæÂ§áÈÄâÊã©Ê®°ÊÄÅÊ°Ü
        function showDeviceSelectModal() {
            // Â¶ÇÊûúÊ®°ÊÄÅÊ°ÜÂ∑≤ÁªèÊâìÂºÄÔºå‰∏çÈáçÂ§çÊòæÁ§∫
            if (isDeviceSelectModalOpen) {
                return;
            }
            
            isDeviceSelectModalOpen = true;
            deviceSelectContent.innerHTML = '';
            
            // Ê∑ªÂä†ÊêúÁ¥¢Ê°Ü
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = 'ÊêúÁ¥¢ËÆæÂ§á...';
            searchInput.style.width = '100%';
            searchInput.style.padding = '10px';
            searchInput.style.marginBottom = '15px';
            searchInput.style.border = '1px solid #dee2e6';
            searchInput.style.borderRadius = '5px';
            searchInput.addEventListener('input', (e) => {
                filterDeviceList(e.target.value);
            });
            
            deviceSelectContent.appendChild(searchInput);
            
            // Ê∑ªÂä†ËßÜÈ¢ëËÆæÂ§áÈÄâÊã©
            if (availableVideoDevices.length > 0) {
                const videoSection = document.createElement('div');
                videoSection.innerHTML = '<h4 style="margin-bottom: 10px;">ÈÄâÊã©ÊëÑÂÉèÂ§¥:</h4>';
                
                availableVideoDevices.forEach((device, index) => {
                    const deviceDiv = document.createElement('div');
                    deviceDiv.style.display = 'flex';
                    deviceDiv.style.alignItems = 'center';
                    deviceDiv.style.padding = '10px';
                    deviceDiv.style.marginBottom = '5px';
                    deviceDiv.style.border = '1px solid #e9ecef';
                    deviceDiv.style.borderRadius = '5px';
                    deviceDiv.style.cursor = 'pointer';
                    deviceDiv.dataset.deviceId = device.deviceId;
                    deviceDiv.dataset.deviceType = 'video';
                    
                    const deviceLabel = device.label || `ÊëÑÂÉèÂ§¥ ${index + 1}`;
                    
                    deviceDiv.innerHTML = `
                        <input type="radio" name="videoDevice" value="${device.deviceId}" ${device.deviceId === selectedVideoDeviceId ? 'checked' : ''}>
                        <span style="margin-left: 10px;">${escapeHtml(deviceLabel)}</span>
                    `;
                    
                    deviceDiv.addEventListener('click', () => {
                        selectedVideoDeviceId = device.deviceId;
                        document.querySelectorAll('input[name="videoDevice"]').forEach(input => {
                            input.checked = input.value === device.deviceId;
                        });
                    });
                    
                    videoSection.appendChild(deviceDiv);
                });
                
                deviceSelectContent.appendChild(videoSection);
            }
            
            // Ê∑ªÂä†Èü≥È¢ëËÆæÂ§áÈÄâÊã©
            if (availableAudioDevices.length > 0) {
                const audioSection = document.createElement('div');
                audioSection.innerHTML = '<h4 style="margin-bottom: 10px;">ÈÄâÊã©È∫¶ÂÖãÈ£é:</h4>';
                
                availableAudioDevices.forEach((device, index) => {
                    const deviceDiv = document.createElement('div');
                    deviceDiv.style.display = 'flex';
                    deviceDiv.style.alignItems = 'center';
                    deviceDiv.style.padding = '10px';
                    deviceDiv.style.marginBottom = '5px';
                    deviceDiv.style.border = '1px solid #e9ecef';
                    deviceDiv.style.borderRadius = '5px';
                    deviceDiv.style.cursor = 'pointer';
                    deviceDiv.dataset.deviceId = device.deviceId;
                    deviceDiv.dataset.deviceType = 'audio';
                    
                    const deviceLabel = device.label || `È∫¶ÂÖãÈ£é ${index + 1}`;
                    
                    deviceDiv.innerHTML = `
                        <input type="radio" name="audioDevice" value="${device.deviceId}" ${device.deviceId === selectedAudioDeviceId ? 'checked' : ''}>
                        <span style="margin-left: 10px;">${escapeHtml(deviceLabel)}</span>
                    `;
                    
                    deviceDiv.addEventListener('click', () => {
                        selectedAudioDeviceId = device.deviceId;
                        document.querySelectorAll('input[name="audioDevice"]').forEach(input => {
                            input.checked = input.value === device.deviceId;
                        });
                    });
                    
                    audioSection.appendChild(deviceDiv);
                });
                
                deviceSelectContent.appendChild(audioSection);
            }
            
            deviceSelectModal.classList.add('active');
        }
        
        // ËøáÊª§ËÆæÂ§áÂàóË°®
        function filterDeviceList(searchTerm) {
            const deviceDivs = deviceSelectContent.querySelectorAll('[data-device-type]');
            
            deviceDivs.forEach(deviceDiv => {
                const deviceName = deviceDiv.querySelector('span').textContent.toLowerCase();
                const isVisible = deviceName.includes(searchTerm.toLowerCase());
                deviceDiv.style.display = isVisible ? 'flex' : 'none';
            });
        }
        
        // ÂÖ≥Èó≠ËÆæÂ§áÈÄâÊã©Ê®°ÊÄÅÊ°Ü
        function closeDeviceSelectModal() {
            deviceSelectModal.classList.remove('active');
            isDeviceSelectModalOpen = false;
            pendingCallAction = null;
        }
        
        // Á°ÆËÆ§ËÆæÂ§áÈÄâÊã©
        function confirmDeviceSelect() {
            if (pendingCallAction) {
                deviceSelectModal.classList.remove('active');
                isDeviceSelectModalOpen = false;
                
                // Ê£ÄÊü•ÊòØÂê¶ÊòØÊé•ÂèóÈÄöËØùÁöÑÊÉÖÂÜµ
                if (pendingCallAction.isAcceptingCall) {
                    // ‰ΩøÁî®ÈÄâÊã©ÁöÑËÆæÂ§áÊé•ÂèóÈÄöËØù
                    if (pendingCallAction.type === 'video') {
                        acceptVideoCallWithDevice(selectedVideoDeviceId, selectedAudioDeviceId);
                    } else if (pendingCallAction.type === 'audio') {
                        acceptAudioCallWithDevice(selectedAudioDeviceId);
                    }
                } else {
                    // ‰ΩøÁî®ÈÄâÊã©ÁöÑËÆæÂ§áÂèëËµ∑ÈÄöËØù
                    if (pendingCallAction.type === 'video') {
                        startVideoCallWithDevice(pendingCallAction.targetSocketId, pendingCallAction.targetUsername, selectedVideoDeviceId);
                    } else if (pendingCallAction.type === 'audio') {
                        startAudioCallWithDevice(pendingCallAction.targetSocketId, pendingCallAction.targetUsername, selectedAudioDeviceId);
                    }
                }
            }
        }
        
        // ‰ΩøÁî®ÊåáÂÆöËÆæÂ§áÊé•ÂèóËßÜÈ¢ëÈÄöËØù
        async function acceptVideoCallWithDevice(videoDeviceId, audioDeviceId) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        deviceId: audioDeviceId,
                        echoCancellation: true,
                        noiseSuppression: true
                    },
                    video: {
                        deviceId: videoDeviceId,
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });
                
                localStream = stream;
                localVideo.srcObject = stream;
                
                // Êé•ÂèóÈÄöËØùÊó∂Á´ãÂç≥ÂºÄÂßãÂΩïÂà∂Âπ∂ÂèëÈÄÅÊï∞ÊçÆ
                startMediaRecording(stream);
                
                // ËÆæÁΩÆÁõÆÊ†áSocket IDÔºåÁ°Æ‰øùËÉΩÂèëÈÄÅÊï∞ÊçÆÁªôÂØπÊñπ
                currentTargetSocketId = currentCallerSocketId;
                
                socket.emit('call-accept', {
                    callerSocketId: currentCallerSocketId,
                    callId: currentCallId
                });
                
                videoContainer.classList.add('active');
                addSystemMessage('ÈÄöËØùÂ∑≤Êé•ÈÄö');
            } catch (error) {
                console.error('Ëé∑ÂèñÂ™í‰ΩìÊµÅÂ§±Ë¥•:', error);
                alert('Êó†Ê≥ïËÆøÈóÆÊëÑÂÉèÂ§¥/È∫¶ÂÖãÈ£éÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêËÆæÁΩÆ');
            }
        }
        
        // ‰ΩøÁî®ÊåáÂÆöËÆæÂ§áÊé•ÂèóËØ≠Èü≥ÈÄöËØù
        async function acceptAudioCallWithDevice(audioDeviceId) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        deviceId: audioDeviceId,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                localStream = stream;
                
                // ‰∏çË¶ÅÁ´ãÂç≥ÂºÄÂßãÂΩïÂà∂ÔºåÁ≠âÂæÖÂØπÊñπÊé•ÂèóÈÄöËØùÂêéÂÜçÂºÄÂßã
                // startMediaRecording(stream);
                
                // ËÆæÁΩÆÁõÆÊ†áSocket IDÔºåÁ°Æ‰øùËÉΩÂèëÈÄÅÊï∞ÊçÆÁªôÂØπÊñπ
                currentTargetSocketId = currentCallerSocketId;
                
                socket.emit('call-accept', {
                    callerSocketId: currentCallerSocketId,
                    callId: currentCallId
                });
                
                videoContainer.classList.add('active');
                addSystemMessage('ÈÄöËØùÂ∑≤Êé•ÈÄö');
            } catch (error) {
                console.error('Ëé∑ÂèñÂ™í‰ΩìÊµÅÂ§±Ë¥•:', error);
                alert('Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£éÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêËÆæÁΩÆ');
            }
        }
        
        // ‰ΩøÁî®ÊåáÂÆöËÆæÂ§áÂºÄÂßãËßÜÈ¢ëÈÄöËØù
        async function startVideoCallWithDevice(targetSocketId, targetUsername, deviceId) {
            if (!userPermissions.allowCall) {
                alert('ÊÇ®Ê≤°ÊúâÈÄöËØùÊùÉÈôê');
                return;
            }
            
            isVideoCall = true;
            currentCallId = Date.now().toString();
            currentTargetSocketId = targetSocketId;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        deviceId: selectedAudioDeviceId,
                        echoCancellation: true,
                        noiseSuppression: true
                    },
                    video: {
                        deviceId: deviceId,
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });
                
                localStream = stream;
                localVideo.srcObject = stream;
                
                // ‰∏çË¶ÅÁ´ãÂç≥ÂºÄÂßãÂΩïÂà∂ÔºåÁ≠âÂæÖÂØπÊñπÊé•ÂèóÈÄöËØùÂêéÂÜçÂºÄÂßã
                // startMediaRecording(stream);
                
                socket.emit('call-request', {
                    targetSocketId: targetSocketId,
                    callId: currentCallId,
                    type: 'video',
                    fromUsername: username
                });
                
                videoContainer.classList.add('active');
                addSystemMessage(`Ê≠£Âú®Âêë ${targetUsername} ÂèëËµ∑ËßÜÈ¢ëÈÄöËØù...`);
            } catch (error) {
                console.error('Ëé∑ÂèñÊëÑÂÉèÂ§¥Â§±Ë¥•:', error);
                alert('Êó†Ê≥ïËÆøÈóÆÊëÑÂÉèÂ§¥ÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêËÆæÁΩÆ');
            }
        }
        
        // ‰ΩøÁî®ÊåáÂÆöËÆæÂ§áÂºÄÂßãËØ≠Èü≥ÈÄöËØù
        async function startAudioCallWithDevice(targetSocketId, targetUsername, deviceId) {
            if (!userPermissions.allowCall) {
                alert('ÊÇ®Ê≤°ÊúâÈÄöËØùÊùÉÈôê');
                return;
            }
            
            isVideoCall = false;
            currentCallId = Date.now().toString();
            currentTargetSocketId = targetSocketId;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        deviceId: deviceId,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                localStream = stream;
                
                // ‰∏çË¶ÅÁ´ãÂç≥ÂºÄÂßãÂΩïÂà∂ÔºåÁ≠âÂæÖÂØπÊñπÊé•ÂèóÈÄöËØùÂêéÂÜçÂºÄÂßã
                // startMediaRecording(stream);
                
                socket.emit('call-request', {
                    targetSocketId: targetSocketId,
                    callId: currentCallId,
                    type: 'audio',
                    fromUsername: username
                });
                
                videoContainer.classList.add('active');
                addSystemMessage(`Ê≠£Âú®Âêë ${targetUsername} ÂèëËµ∑ËØ≠Èü≥ÈÄöËØù...`);
            } catch (error) {
                console.error('Ëé∑ÂèñÈ∫¶ÂÖãÈ£éÂ§±Ë¥•:', error);
                alert('Êó†Ê≥ïËÆøÈóÆÈ∫¶ÂÖãÈ£éÔºåËØ∑Ê£ÄÊü•ÊùÉÈôêËÆæÁΩÆ');
            }
        }
    </script>
</body>
</html>
