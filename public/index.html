<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; media-src 'self' blob:; connect-src 'self' ws: wss: https://libretranslate.de https://api.mymemory.translated.net; font-src 'self' data:;">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>èŠå¤©å®¤</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 95%;
            max-width: 900px;
            height: 95vh;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .online-count {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
        }
        
        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        
        .users-panel {
            width: 200px;
            background: #f1f3f5;
            padding: 15px;
            border-left: 1px solid #dee2e6;
            overflow-y: auto;
            display: block;
            position: relative;
            z-index: 1;
            transition: all 0.3s;
        }

        .users-panel.hidden {
            display: none;
        }

        .message {
            margin-bottom: 15px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .username {
            font-weight: bold;
            margin-right: 10px;
        }

        .timestamp {
            font-size: 12px;
            color: #999;
        }

        .message-content {
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            word-wrap: break-word;
            color: #333;
        }



        .message-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 5px;
        }

        .recall-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        .recall-btn:hover {
            background: #c82333;
        }

        .favorite-btn {
            background: transparent;
            color: #ffc107;
            border: none;
            padding: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
        }

        .favorite-btn:hover {
            transform: scale(1.1);
        }

        .favorite-btn.favorited {
            color: #ff9800;
            transform: scale(1.2);
        }

        .read-status {
            color: #6c757d;
            font-size: 12px;
            margin-left: 5px;
            font-weight: bold;
        }

        .translate-btn {
            background: transparent;
            color: #17a2b8;
            border: none;
            padding: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: transform 0.2s;
            margin-left: 5px;
        }

        .translate-btn:hover {
            transform: scale(1.1);
        }

        .call-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }

        .call-btn:hover {
            background: #218838;
        }

        .call-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        .video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .video-container.active {
            display: flex;
        }

        .video-content {
            display: flex;
            gap: 20px;
            max-width: 1200px;
            width: 90%;
        }

        .video-box {
            flex: 1;
            background: #000;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .video-box video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* ä¿®å¤æœ¬åœ°è§†é¢‘é•œåƒæ˜¾ç¤ºé—®é¢˜ */
        #localVideo {
            transform: scaleX(-1);
        }
        
        /* è§†é¢‘æ”¾å¤§æ ·å¼ */
        .video-content {
            transition: all 0.3s ease;
        }
        
        .video-box {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .video-box.fullscreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1001;
        }
        
        .video-box:not(.fullscreen) {
            flex: 1;
        }

        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
        }

        .video-controls {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }

        .video-control-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .video-control-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .video-control-btn.end {
            background: #dc3545;
        }

        .video-control-btn.end:hover {
            background: #c82333;
        }
        
        .video-control-btn.disabled {
            background: rgba(108, 117, 125, 0.7);
            color: #6c757d;
        }
        
        .video-control-btn.disabled:hover {
            background: rgba(108, 117, 125, 0.9);
        }

        .call-incoming {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 999;
            max-width: 300px;
        }

        .call-incoming.active {
            display: block;
        }

        .call-incoming h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .call-incoming-buttons {
            display: flex;
            gap: 10px;
        }

        .call-incoming-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .call-accept {
            background: #28a745;
            color: white;
        }

        .call-reject {
            background: #dc3545;
            color: white;
        }

        .system-message {
            text-align: center;
            color: #666;
            font-style: italic;
            margin: 10px 0;
            padding: 5px;
            background: #e9ecef;
            border-radius: 5px;
        }

        .system-message.admin {
            background: #fff3cd;
            color: #856404;
            font-weight: bold;
        }

        .users-panel {
            width: 200px;
            background: #f1f3f5;
            padding: 15px;
            border-left: 1px solid #dee2e6;
            overflow-y: auto;
            display: block;
        }
        
        .search-box {
            margin-bottom: 15px;
        }
        
        #searchInput {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        #searchInput:focus {
            border-color: #667eea;
        }
        
        #userDetailModal .modal-content {
            max-width: 400px;
        }
        
        #userDetailContent {
            margin-bottom: 20px;
        }
        
        #userDetailContent > div {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        #userDetailContent > div > div {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        #userDetailContent > div > div:last-child {
            margin-bottom: 0;
        }
        
        #usernameInput, #roomNameInput, #roomPasswordInput {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
            margin-bottom: 10px;
        }

        #usernameInput:focus, #roomNameInput:focus, #roomPasswordInput:focus {
            border-color: #667eea;
        }

        .user-item {
            display: block;
            width: 100%;
            margin-bottom: 10px;
            padding: 10px 15px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            position: relative;
            overflow: hidden;
        }
        
        /* åœ¨çº¿çŠ¶æ€æ ·å¼ */
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
        
        .status-online {
            background-color: #28a745;
        }
        
        .status-offline {
            background-color: #6c757d;
        }

        .user-item:hover {
            border-color: #667eea;
            background: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .user-item:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.2);
        }

        .user-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }

        .user-name {
            display: inline-block;
            vertical-align: middle;
            font-size: 14px;
            font-weight: 500;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: calc(100% - 20px);
        }

        .user-item .btn-info {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            padding: 5px 10px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .user-item:hover .btn-info {
            opacity: 1;
        }

        #joinBtn {
            width: 100%;
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #joinBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        #chatForm {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #messageInput {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        #messageInput:focus {
            border-color: #667eea;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            background: #f8f9fa;
            color: #667eea;
        }

        .action-btn:hover {
            background: #667eea;
            color: white;
            transform: scale(1.1);
        }

        .action-btn.recording {
            background: #dc3545;
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        #sendBtn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #sendBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .hidden {
            display: none !important;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .modal h3 {
            margin-bottom: 15px;
            margin-top: 0;
        }
        
        #deviceSelectContent {
            max-height: 300px;
            overflow-y: auto;
        }
        
        #deviceSelectContent h4 {
            margin-bottom: 10px;
            margin-top: 0;
        }
        
        #deviceSelectContent input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            box-sizing: border-box;
        }
        
        #deviceSelectContent input[type="radio"] {
            margin-right: 10px;
        }
        
        #deviceSelectContent span {
            margin-left: 10px;
        }
        
        #deviceSelectContent div[data-device-type] {
            padding: 10px;
            margin-bottom: 5px;
            border: 1px solid #e9ecef;
            border-radius: 5px;
            cursor: pointer;
        }
        
        #deviceSelectContent div[data-device-type]:hover {
            background: #f8f9fa;
        }
        
        #deviceSelectContent div[data-device-type]:hover input[type="radio"] {
            transform: scale(1.1);
        }
        
        .friend-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
            transition: background 0.2s;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 8px;
            margin: 8px 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .friend-item:hover {
            background: #f0f0f0;
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .friend-item:active {
            background: #e9ecef;
            border-color: #0056b3;
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .friend-color {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .friend-info {
            flex: 1;
            min-width: 0;
        }
        
        .friend-name {
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .friend-status {
            font-size: 12px;
            color: #666;
        }
        
        .friend-actions {
            display: none;
            gap: 5px;
        }
        
        .friend-item.expanded .friend-actions {
            display: flex;
        }
        
        .friend-btn {
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .friend-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .friend-btn.danger {
            color: #dc3545;
            border-color: #dc3545;
        }
        
        .friend-btn.danger:hover {
            background: #dc3545;
            color: white;
        }
        
        .private-chat-messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .private-chat-message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 10px;
            background: white;
        }
        
        .private-chat-message.sent {
            background: #667eea;
            color: white;
        }
        
        .private-chat-message-header {
            font-size: 12px;
            margin-bottom: 5px;
            opacity: 0.8;
        }
        
        .private-chat-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        #privateChatInput {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }
        
        #privateChatInput:focus {
            border-color: #667eea;
        }
        
        #privateChatSendBtn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        #privateChatSendBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .admin-panel-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 10px;
        }
        
        .admin-tab {
            padding: 10px 20px;
            border: none;
            background: #f8f9fa;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .admin-tab:hover {
            background: #e9ecef;
        }
        
        .admin-tab.active {
            background: #667eea;
            color: white;
        }
        
        .admin-tab-content {
            display: none;
        }
        
        .admin-tab-content.active {
            display: block;
        }
        
        .admin-user-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
            transition: background 0.2s;
        }
        
        .admin-user-item:hover {
            background: #f8f9fa;
        }
        
        .admin-user-info {
            flex: 1;
            min-width: 0;
        }
        
        .admin-user-name {
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .admin-user-role {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-right: 5px;
        }
        
        .admin-user-role.user {
            background: #e9ecef;
            color: #666;
        }
        
        .admin-user-role.admin {
            background: #ffc107;
            color: #333;
        }
        
        .admin-user-role.superadmin {
            background: #dc3545;
            color: white;
        }
        
        .admin-user-actions {
            display: flex;
            gap: 5px;
        }
        
        .admin-action-btn {
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .admin-action-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .admin-action-btn.danger {
            color: #dc3545;
            border-color: #dc3545;
        }
        
        .admin-action-btn.danger:hover {
            background: #dc3545;
            color: white;
        }
        
        .admin-select {
            padding: 5px 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: white;
            font-size: 12px;
            cursor: pointer;
        }
        
        .container {
            width: 100%;
            height: 100vh;
            border-radius: 0;
        }
        .chat-container {
            flex-direction: column;
        }
        .messages {
            padding: 15px;
            width: 100%;
        }
        .action-btn {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }
        #chatForm {
            flex-wrap: wrap;
        }
        #messageInput {
            flex-basis: 100%;
        }
    
            .container {
            width: 100%;
            height: 100vh;
            border-radius: 0;
        }
        .chat-container {
            flex-direction: column;
        }
        .messages {
            padding: 15px;
            width: 100%;
        }
        .action-btn {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }
        #chatForm {
            flex-wrap: wrap;
        }
        #messageInput {
            flex-basis: 100%;
        }
        @media (max-width: 768px) {}

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* è¡¨æƒ…é€‰æ‹©å™¨æ ·å¼ */
        .emoji-panel {
            position: absolute;
            bottom: 70px;
            right: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            width: 320px;
            max-height: 300px;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        .emoji-categories {
            display: flex;
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
            background: #f8f9fa;
            border-radius: 10px 10px 0 0;
        }

        .emoji-category {
            background: none;
            border: none;
            font-size: 20px;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 5px;
            transition: all 0.2s;
        }

        .emoji-category:hover {
            background: #e9ecef;
        }

        .emoji-category.active {
            background: #667eea;
            color: white;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            padding: 10px;
            overflow-y: auto;
            flex: 1;
        }

        .emoji-item {
            background: none;
            border: none;
            font-size: 24px;
            padding: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .emoji-item:hover {
            background: #e9ecef;
            transform: scale(1.2);
        }

        /* è¡¨æƒ…æ¶ˆæ¯æ ·å¼ */
        .emoji-message {
            font-size: 24px;
            margin: 0;
        }
        
        /* å¼€å‘è€…æ¨¡å¼æ—¥å¿—æ ·å¼ */
        .developer-log {
            position: absolute;
            bottom: 80px;
            left: 20px;
            width: 300px;
            max-height: 200px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            border-radius: 5px;
            overflow-y: auto;
            z-index: 1001;
        }
        
        .developer-log .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
            border-bottom: 1px solid rgba(0, 255, 0, 0.2);
        }
        
        .developer-log .log-entry:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>èŠå¤©å®¤</h1>
            <div class="header-actions">
                <div class="online-count">åœ¨çº¿äººæ•°: <span id="userCount">0</span></div>
                <button class="header-btn" id="usersBtn" title="ç”¨æˆ·åˆ—è¡¨">ğŸ‘¥</button>
                <button class="header-btn" id="friendsBtn" title="å¥½å‹åˆ—è¡¨">ğŸ‘¥</button>
                <button class="header-btn" id="settingsBtn" title="è®¾ç½®">âš™ï¸</button>
            </div>
        </div>
        
        <!-- æ¶ˆæ¯æœç´¢æ¡† -->
        <div class="search-container" style="padding: 10px; background: white; border-bottom: 1px solid #dee2e6;">
            <input type="text" id="messageSearchInput" placeholder="æœç´¢æ¶ˆæ¯..." style="width: 100%; padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 20px; font-size: 14px; outline: none;">
        </div>

        <div class="chat-container">
            <div class="messages" id="messages">
                <div class="system-message">æ¬¢è¿æ¥åˆ°èŠå¤©å®¤ï¼è¯·è¾“å…¥æ˜µç§°åŠ å…¥ã€‚</div>
            </div>
        </div>

        <div class="input-area">
            <div id="loginForm">
                <input type="text" id="usernameInput" placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°" maxlength="20">
                <button id="joinBtn">åŠ å…¥èŠå¤©</button>
            </div>
            <div id="chatForm" class="hidden">
                <input type="file" id="imageInput" accept="image/*">
                <div class="action-buttons">
Â·                    <button class="action-btn" id="emojiBtn" title="å‘é€è¡¨æƒ…">ğŸ˜€</button>
                    <button class="action-btn disabled" id="imageBtn" title="å‘é€å›¾ç‰‡">ğŸ“·</button>
                    <button class="action-btn disabled" id="audioBtn" title="å‘é€è¯­éŸ³">ğŸ¤</button>
                    <button class="action-btn" id="videoCallBtn" title="è§†é¢‘é€šè¯">ğŸ“¹</button>
                    <button class="action-btn" id="audioCallBtn" title="è¯­éŸ³é€šè¯">ğŸ“</button>
                </div>
                <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="500">
                <button id="sendBtn">å‘é€</button>
            </div>
        </div>
        
        <!-- è¡¨æƒ…é€‰æ‹©é¢æ¿ -->
        <div class="emoji-panel" id="emojiPanel" style="display: none;">
            <div class="emoji-categories">
                <button class="emoji-category active" data-category="smileys">ğŸ˜Š</button>
                <button class="emoji-category" data-category="animals">ğŸ¶</button>
                <button class="emoji-category" data-category="food">ğŸ</button>
                <button class="emoji-category" data-category="activities">âš½</button>
                <button class="emoji-category" data-category="travel">âœˆï¸</button>
                <button class="emoji-category" data-category="objects">ğŸ’¡</button>
                <button class="emoji-category" data-category="flags">ğŸ‡¨ğŸ‡³</button>
            </div>
            <div class="emoji-grid" id="emojiGrid">
                <!-- è¡¨æƒ…å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
        </div>
    </div>

    <div class="video-container" id="videoContainer">
        <!-- è§†é¢‘å¢å¼ºæç¤º -->
        <div style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(220, 53, 69, 0.95); color: white; padding: 12px 20px; border-radius: 8px; font-size: 14px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); max-width: 80%; text-align: center;">
            âš ï¸ <strong>é‡è¦æç¤º</strong>ï¼šè¯·ä¸è¦æ‰“å¼€æµè§ˆå™¨çš„"è§†é¢‘å¢å¼º"æˆ–"å¢å¼ºè§†é¢‘"å¼€å…³ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´é»‘å±ã€‚
        </div>
        
        <div class="video-content">
            <div class="video-box">
                <video id="localVideo" autoplay playsinline muted></video>
                <div class="video-label">æˆ‘</div>
            </div>
            <div class="video-box">
                <video id="remoteVideo" autoplay playsinline></video>
                <div class="video-label">å¯¹æ–¹</div>
            </div>
        </div>
        <div class="video-controls">
                <button class="video-control-btn" id="toggleVideoBtn">ğŸ“¹</button>
                <button class="video-control-btn" id="toggleAudioBtn">ğŸ¤</button>
                <button class="video-control-btn" id="switchCameraBtn">ğŸ”„</button>
                <button class="video-control-btn" id="toggleScreenShareBtn">ğŸ–¥ï¸</button>
                <button class="video-control-btn" id="callSettingsBtn">âš™ï¸</button>
                <button class="video-control-btn end" id="endCallBtn">ğŸ“</button>
            </div>
        <!-- å¼€å‘è€…æ¨¡å¼æ—¥å¿—æ˜¾ç¤ºåŒºåŸŸ -->
        <div id="developerLog" class="developer-log" style="display: none;"></div>
    </div>

    <div class="call-incoming" id="callIncoming">
        <h3 id="callIncomingText">æ¥ç”µ</h3>
        <div class="call-incoming-buttons">
            <button class="call-accept" onclick="callSystem?.acceptCall()">æ¥å¬</button>
            <button class="call-reject" onclick="callSystem?.rejectCall()">æ‹’ç»</button>
        </div>
    </div>
    
    <div class="modal" id="userDetailModal">
        <div class="modal-content">
            <h3 id="userDetailTitle">ç”¨æˆ·è¯¦æƒ…</h3>
            <div id="userDetailContent"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeUserDetailModal()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="usersModal">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <h3>åœ¨çº¿ç”¨æˆ·</h3>
            <div class="search-box" style="margin-bottom: 15px;">
                <input type="text" id="searchInput" placeholder="æœç´¢ç”¨æˆ·..." maxlength="20">
            </div>
            <div id="usersList"></div>
            <div class="modal-buttons">
                <!-- <button type="button" class="btn btn-warning" onclick="quickAddFriends()">å¿«é€ŸåŠ å¥½å‹</button> -->
                <button type="button" class="btn btn-cancel" onclick="closeUsersModal()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="friendsModal">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <h3>å¥½å‹åˆ—è¡¨</h3>
            <div id="friendsList"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeFriendsModal()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="privateChatModal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <h3 id="privateChatTitle">ç§èŠ</h3>
            <div class="private-chat-messages" id="privateChatMessages"></div>
            <div class="private-chat-input">
                <input type="file" id="privateChatImageInput" accept="image/*" style="display: none;">
                <div class="action-buttons" style="margin-bottom: 10px;">
                    <button class="action-btn" id="privateChatImageBtn" title="å‘é€å›¾ç‰‡">ğŸ“·</button>
                    <button class="action-btn" id="privateChatAudioBtn" title="å‘é€è¯­éŸ³">ğŸ¤</button>
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="privateChatInput" placeholder="è¾“å…¥ç§èŠæ¶ˆæ¯..." maxlength="500" style="flex: 1;">
                    <button id="privateChatSendBtn">å‘é€</button>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closePrivateChatModal()">å…³é—­</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="settingsModal">
        <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <h3>è®¾ç½®</h3>
            <!-- é”å®šæç¤ºåŒºåŸŸ -->
            <div id="settingsLockNotice" style="background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin-bottom: 15px; display: none;">
                <strong>è®¾ç½®å·²é”å®š</strong>: <span id="lockNoticeText"></span>
            </div>
            <div class="admin-panel-tabs">
                <button class="admin-tab active" data-tab="translation">ç¿»è¯‘è®¾ç½®</button>
                <button class="admin-tab" data-tab="notifications">é€šçŸ¥è®¾ç½®</button>
                <button class="admin-tab" data-tab="video">è§†é¢‘è®¾ç½®</button>
                <button class="admin-tab" data-tab="call">é€šè¯è®¾ç½®</button>
            </div>
            <div class="admin-panel-content">
                <div class="admin-tab-content active" id="translationTab">
                    <div style="margin-bottom: 20px;">
                        <h4>ç¿»è¯‘ç›®æ ‡è¯­è¨€</h4>
                        <div style="margin-top: 15px;">
                            <label for="targetLanguageSelect" style="display: block; margin-bottom: 8px;">é€‰æ‹©ç¿»è¯‘ç›®æ ‡è¯­è¨€ï¼š</label>
                            <select id="targetLanguageSelect" style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 5px; font-size: 14px;">
                                <option value="zh">ä¸­æ–‡</option>
                                <option value="en">English</option>
                                <option value="ja">æ—¥æœ¬èª</option>
                                <option value="ko">í•œêµ­ì–´</option>
                                <option value="fr">FranÃ§ais</option>
                                <option value="de">Deutsch</option>
                                <option value="es">EspaÃ±ol</option>
                                <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                            </select>
                        </div>
                        <div style="margin-top: 20px;">
                            <label>
                                <input type="checkbox" id="autoTranslateCheckbox">
                                è‡ªåŠ¨ç¿»è¯‘æ‰€æœ‰æ¶ˆæ¯ï¼ˆä»…ç¿»è¯‘åˆ«äººçš„æ¶ˆæ¯ï¼‰
                            </label>
                        </div>
                    </div>
                </div>
                <div class="admin-tab-content" id="notificationsTab">
                    <div style="margin-bottom: 20px;">
                        <h4>é€šçŸ¥è®¾ç½®</h4>
                        <div style="margin-top: 15px;">
                            <label>
                                <input type="checkbox" id="soundNotificationCheckbox" checked>
                                å£°éŸ³é€šçŸ¥
                            </label>
                        </div>
                        <div style="margin-top: 10px;">
                            <label>
                                <input type="checkbox" id="mentionNotificationCheckbox" checked>
                                @æåŠé€šçŸ¥
                            </label>
                        </div>
                        <div style="margin-top: 10px;">
                            <label>
                                <input type="checkbox" id="developerModeCheckbox">
                                å¼€å‘è€…æ¨¡å¼ï¼ˆé€šè¯æ—¶æ˜¾ç¤ºæ§åˆ¶å°æ—¥å¿—ï¼‰
                            </label>
                        </div>
                    </div>
                </div>
                <div class="admin-tab-content" id="videoTab">
                    <div style="margin-bottom: 20px;">
                        <h4>è§†é¢‘è®¾ç½®</h4>
                        <div style="margin-top: 15px;">
                            <label>
                                <input type="checkbox" id="mirrorVideoCheckbox" checked>
                                æœ¬åœ°è§†é¢‘é•œåƒæ˜¾ç¤º
                            </label>
                            <p style="margin-top: 5px; font-size: 12px; color: #6c757d;">å¯ç”¨åï¼Œæœ¬åœ°è§†é¢‘ç”»é¢å°†æ˜¾ç¤ºä¸ºé•œåƒæ•ˆæœï¼Œç¬¦åˆç…§é•œå­çš„ç›´è§‰ã€‚</p>
                        </div>
                        <div style="margin-top: 15px;">
                            <label>
                                <input type="checkbox" id="remoteMirrorVideoCheckbox">
                                å¯¹æ–¹è§†é¢‘é•œåƒæ˜¾ç¤º
                            </label>
                            <p style="margin-top: 5px; font-size: 12px; color: #6c757d;">å¯ç”¨åï¼Œå¯¹æ–¹è§†é¢‘ç”»é¢å°†æ˜¾ç¤ºä¸ºé•œåƒæ•ˆæœã€‚</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4>è§†é¢‘å‚æ•°è°ƒæ•´ï¼ˆé€šè¯ä¸­å¯è°ƒæ•´ï¼‰</h4>
                        <div style="margin-top: 15px;">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <label for="myVideoBrightness" style="width: 80px; font-size: 14px;">äº®åº¦:</label>
                                <input type="range" id="myVideoBrightness" min="0" max="3" step="0.1" value="1" style="flex: 1; margin: 0 10px;">
                                <span id="myVideoBrightnessValue" style="width: 40px; text-align: right; font-size: 14px;">1.0</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <label for="myVideoContrast" style="width: 80px; font-size: 14px;">å¯¹æ¯”åº¦:</label>
                                <input type="range" id="myVideoContrast" min="0" max="2.5" step="0.1" value="1" style="flex: 1; margin: 0 10px;">
                                <span id="myVideoContrastValue" style="width: 40px; text-align: right; font-size: 14px;">1.0</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <label for="myVideoSaturation" style="width: 80px; font-size: 14px;">é¥±å’Œåº¦:</label>
                                <input type="range" id="myVideoSaturation" min="0" max="2" step="0.1" value="1" style="flex: 1; margin: 0 10px;">
                                <span id="myVideoSaturationValue" style="width: 40px; text-align: right; font-size: 14px;">1.0</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <label for="myVideoExposure" style="width: 80px; font-size: 14px;">æ›å…‰:</label>
                                <input type="range" id="myVideoExposure" min="0" max="2" step="0.05" value="1" style="flex: 1; margin: 0 10px;">
                                <span id="myVideoExposureValue" style="width: 40px; text-align: right; font-size: 14px;">1.0</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="admin-tab-content" id="callTab">
                    <div style="margin-bottom: 20px;">
                        <h4>é€šè¯è®¾ç½®</h4>
                        <div style="margin-top: 15px;">
                            <label>
                                <input type="checkbox" id="autoAdjustVolumeCheckbox" checked>
                                å…±äº«å±å¹•æ—¶è‡ªåŠ¨è°ƒæ•´éŸ³é‡
                            </label>
                            <p style="margin-top: 5px; font-size: 12px; color: #6c757d;">å¯ç”¨åï¼Œåœ¨å…±äº«å±å¹•æ—¶è¯´è¯ä¼šè‡ªåŠ¨é™ä½èƒŒæ™¯éŸ³é‡ï¼Œç¡®ä¿å¯¹æ–¹èƒ½æ¸…æ™°å¬åˆ°ä½ çš„å£°éŸ³ã€‚</p>
                        </div>
                        <div style="margin-top: 15px;">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <label for="speakingThreshold" style="width: 120px; font-size: 14px;">è¯´è¯æ£€æµ‹é˜ˆå€¼:</label>
                                <input type="range" id="speakingThreshold" min="0" max="100" step="5" value="40" style="flex: 1; margin: 0 10px;">
                                <span id="speakingThresholdValue" style="width: 40px; text-align: right; font-size: 14px;">40</span>
                            </div>
                            <p style="margin-top: 5px; font-size: 12px; color: #6c757d;">è°ƒæ•´æ£€æµ‹åˆ°è¯´è¯çš„éŸ³é‡é˜ˆå€¼ï¼Œæ•°å€¼è¶Šé«˜éœ€è¦æ›´å¤§çš„å£°éŸ³æ‰ä¼šè§¦å‘éŸ³é‡è°ƒæ•´ã€‚</p>
                        </div>
                        <div style="margin-top: 15px;">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <label for="volumeReduction" style="width: 120px; font-size: 14px;">éŸ³é‡é™ä½æ¯”ä¾‹:</label>
                                <input type="range" id="volumeReduction" min="10" max="80" step="5" value="30" style="flex: 1; margin: 0 10px;">
                                <span id="volumeReductionValue" style="width: 40px; text-align: right; font-size: 14px;">30%</span>
                            </div>
                            <p style="margin-top: 5px; font-size: 12px; color: #6c757d;">è®¾ç½®è¯´è¯æ—¶èƒŒæ™¯éŸ³é‡é™ä½çš„ç™¾åˆ†æ¯”ï¼Œæ•°å€¼è¶Šé«˜é™ä½å¹…åº¦è¶Šå¤§ã€‚</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4>éŸ³é¢‘è®¾å¤‡è®¾ç½®</h4>
                        <div style="margin-top: 15px;">
                            <button class="friend-btn" onclick="showDeviceSelectModal()" style="width: 100%; padding: 10px; margin-bottom: 10px;">
                                é€‰æ‹©éŸ³é¢‘è®¾å¤‡
                            </button>
                            <p style="font-size: 12px; color: #6c757d;">ç‚¹å‡»æŒ‰é’®é€‰æ‹©éº¦å…‹é£å’Œæ‰¬å£°å™¨è®¾å¤‡ï¼Œä¼˜åŒ–é€šè¯éŸ³è´¨ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeSettingsModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-confirm" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="deviceSelectModal">
        <div class="modal-content" style="max-width: 500px;">
            <h3>é€‰æ‹©è®¾å¤‡</h3>
            <div id="deviceSelectContent"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeDeviceSelectModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-confirm" onclick="confirmDeviceSelect()">ç¡®å®š</button>
            </div>
        </div>
    </div>
    
    <!-- é€‰æ‹©é€šè¯ç”¨æˆ·æ¨¡æ€æ¡† -->
    <div class="modal" id="callUserModal">
        <div class="modal-content" style="max-width: 500px;">
            <h3>é€‰æ‹©é€šè¯ç”¨æˆ·</h3>
            <div id="callUserList"></div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-cancel" onclick="closeCallUserModal()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // ç”¨æˆ·è¯¦æƒ…å®šæ—¶å™¨å˜é‡ - ç§»åˆ°æœ€é¡¶éƒ¨ç¡®ä¿åœ¨ä»»ä½•å‡½æ•°è°ƒç”¨å‰å·²åˆå§‹åŒ–
        var userDetailUpdateInterval = null;
        var currentDetailSocketId = null;
        
        const socket = io();
        let username = '';
        let currentRoom = '';
        let userPermissions = {
            allowAudio: true,
            allowImage: true,
            allowFile: true,
            allowSendMessages: true,
            allowViewMessages: true,
            allowCall: false
        };

        const messagesDiv = document.getElementById('messages');
        const usersListDiv = document.getElementById('usersList');
        const userCountSpan = document.getElementById('userCount');
        const usernameInput = document.getElementById('usernameInput');
        const messageInput = document.getElementById('messageInput');
        const joinBtn = document.getElementById('joinBtn');
        const sendBtn = document.getElementById('sendBtn');
        const loginForm = document.getElementById('loginForm');
        const chatForm = document.getElementById('chatForm');
        const imageInput = document.getElementById('imageInput');
        const imageBtn = document.getElementById('imageBtn');
        const audioBtn = document.getElementById('audioBtn');
        const videoCallBtn = document.getElementById('videoCallBtn');
        const audioCallBtn = document.getElementById('audioCallBtn');
        const videoContainer = document.getElementById('videoContainer');
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const toggleVideoBtn = document.getElementById('toggleVideoBtn');
        const toggleAudioBtn = document.getElementById('toggleAudioBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        const callIncoming = document.getElementById('callIncoming');
        const callIncomingText = document.getElementById('callIncomingText');
        const deviceSelectModal = document.getElementById('deviceSelectModal');
        const deviceSelectContent = document.getElementById('deviceSelectContent');
        const searchInput = document.getElementById('searchInput');
        
        // ç”¨æˆ·åˆ—è¡¨æ¨¡æ€æ¡†
        const usersBtn = document.getElementById('usersBtn');
        const usersModal = document.getElementById('usersModal');
        
        // ç”¨æˆ·è¯¦æƒ…æ¨¡æ€æ¡†
        const userDetailModal = document.getElementById('userDetailModal');
        const userDetailTitle = document.getElementById('userDetailTitle');
        const userDetailContent = document.getElementById('userDetailContent');
        
        // æœç´¢ç›¸å…³å˜é‡
        let allUsers = [];
        let searchResults = [];
        let currentSearchTerm = '';
        
        // å¥½å‹ç³»ç»Ÿç›¸å…³å˜é‡
        const friendsBtn = document.getElementById('friendsBtn');
        const friendsModal = document.getElementById('friendsModal');
        const friendsListDiv = document.getElementById('friendsList');
        const privateChatModal = document.getElementById('privateChatModal');
        const privateChatTitle = document.getElementById('privateChatTitle');
        const privateChatMessagesDiv = document.getElementById('privateChatMessages');
        const privateChatInput = document.getElementById('privateChatInput');
        const privateChatSendBtn = document.getElementById('privateChatSendBtn');
        const privateChatImageInput = document.getElementById('privateChatImageInput');
        const privateChatImageBtn = document.getElementById('privateChatImageBtn');
        const privateChatAudioBtn = document.getElementById('privateChatAudioBtn');
        
        // æ¶ˆæ¯æœç´¢ç›¸å…³å˜é‡
        const messageSearchInput = document.getElementById('messageSearchInput');
        let allMessages = []; // ä¿å­˜æ‰€æœ‰å†å²æ¶ˆæ¯
        let isSearching = false; // æ˜¯å¦æ­£åœ¨æœç´¢çŠ¶æ€
        let searchKeyword = '';
        
        // æ¶ˆæ¯æ”¶è—ç›¸å…³å˜é‡
        let favoritedMessages = JSON.parse(localStorage.getItem('favoritedMessages') || '[]');
        
        // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²æ”¶è—
        function isMessageFavorited(messageId) {
            return favoritedMessages.includes(messageId);
        }
        
        // åˆ‡æ¢æ¶ˆæ¯æ”¶è—çŠ¶æ€
        function toggleFavorite(messageId) {
            const index = favoritedMessages.indexOf(messageId);
            if (index > -1) {
                // å–æ¶ˆæ”¶è—
                favoritedMessages.splice(index, 1);
            } else {
                // æ·»åŠ æ”¶è—
                favoritedMessages.push(messageId);
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('favoritedMessages', JSON.stringify(favoritedMessages));
            
            // æ›´æ–°UI
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageDiv) {
                const favoriteBtn = messageDiv.querySelector('.favorite-btn');
                if (favoriteBtn) {
                    if (favoritedMessages.includes(messageId)) {
                        favoriteBtn.classList.add('favorited');
                        favoriteBtn.title = 'å–æ¶ˆæ”¶è—';
                    } else {
                        favoriteBtn.classList.remove('favorited');
                        favoriteBtn.title = 'æ”¶è—æ¶ˆæ¯';
                    }
                }
            }
        }
        
        // è®¾ç½®é¡µé¢ç›¸å…³å˜é‡
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const targetLanguageSelect = document.getElementById('targetLanguageSelect');
        const autoTranslateCheckbox = document.getElementById('autoTranslateCheckbox');
        
        // ç”¨æˆ·è®¾ç½® - å®šä¹‰åœ¨windowå¯¹è±¡ä¸­ï¼Œç¡®ä¿å…¨å±€å¯è®¿é—®
        window.userSettings = {
            targetLanguage: 'zh', // é»˜è®¤ç¿»è¯‘ä¸ºä¸­æ–‡
            autoTranslate: false,
            developerMode: false, // é»˜è®¤å…³é—­å¼€å‘è€…æ¨¡å¼
            mirrorVideo: true, // é»˜è®¤å¼€å¯æœ¬åœ°è§†é¢‘é•œåƒæ˜¾ç¤º
            remoteMirrorVideo: false, // é»˜è®¤å…³é—­å¯¹æ–¹è§†é¢‘é•œåƒæ˜¾ç¤º
            // è§†é¢‘å‚æ•°è°ƒæ•´
            myVideoBrightness: 1, // äº®åº¦ï¼ŒèŒƒå›´0-3ï¼Œé»˜è®¤1
            myVideoContrast: 1, // å¯¹æ¯”åº¦ï¼ŒèŒƒå›´0-2.5ï¼Œé»˜è®¤1
            myVideoSaturation: 1, // é¥±å’Œåº¦ï¼ŒèŒƒå›´0-2ï¼Œé»˜è®¤1
            myVideoExposure: 1, // æ›å…‰ï¼ŒèŒƒå›´0-2ï¼Œé»˜è®¤1
            // é€šè¯è®¾ç½®
            autoAdjustVolume: true, // é»˜è®¤å¼€å¯å…±äº«å±å¹•æ—¶è‡ªåŠ¨è°ƒæ•´éŸ³é‡
            speakingThreshold: 40, // è¯´è¯æ£€æµ‹é˜ˆå€¼ï¼Œé»˜è®¤40
            volumeReduction: 30 // éŸ³é‡é™ä½æ¯”ä¾‹ï¼Œé»˜è®¤30%
        };
        
        // ç”¨æˆ·è®¾ç½®é”å®šçŠ¶æ€
        let settingsLocked = false;
        let settingsLockMessage = 'è®¾ç½®å·²è¢«ç®¡ç†å‘˜é”å®š';
        
        // åˆå§‹åŒ–è®¾ç½®
        function initSettings() {
            // ä»localStorageåŠ è½½è®¾ç½®
            const savedSettings = localStorage.getItem('userSettings');
            if (savedSettings) {
                window.userSettings = { ...window.userSettings, ...JSON.parse(savedSettings) };
            }
            
            // æ›´æ–°UI
            targetLanguageSelect.value = window.userSettings.targetLanguage;
            autoTranslateCheckbox.checked = window.userSettings.autoTranslate;
            
            // åˆå§‹åŒ–å¼€å‘è€…æ¨¡å¼å¤é€‰æ¡†
            const developerModeCheckbox = document.getElementById('developerModeCheckbox');
            if (developerModeCheckbox) {
                developerModeCheckbox.checked = window.userSettings.developerMode;
            }
            
            // åˆå§‹åŒ–æœ¬åœ°è§†é¢‘é•œåƒè®¾ç½®
            const mirrorVideoCheckbox = document.getElementById('mirrorVideoCheckbox');
            if (mirrorVideoCheckbox) {
                mirrorVideoCheckbox.checked = window.userSettings.mirrorVideo;
                // ç«‹å³åº”ç”¨é•œåƒè®¾ç½®
                updateVideoMirrorSetting();
            }
            
            // åˆå§‹åŒ–å¯¹æ–¹è§†é¢‘é•œåƒè®¾ç½®
            const remoteMirrorVideoCheckbox = document.getElementById('remoteMirrorVideoCheckbox');
            if (remoteMirrorVideoCheckbox) {
                remoteMirrorVideoCheckbox.checked = window.userSettings.remoteMirrorVideo;
                // ç«‹å³åº”ç”¨å¯¹æ–¹è§†é¢‘é•œåƒè®¾ç½®
                updateRemoteVideoMirrorSetting();
            }
            
            // åˆå§‹åŒ–é€šè¯è®¾ç½®
            const autoAdjustVolumeCheckbox = document.getElementById('autoAdjustVolumeCheckbox');
            const speakingThreshold = document.getElementById('speakingThreshold');
            const speakingThresholdValue = document.getElementById('speakingThresholdValue');
            const volumeReduction = document.getElementById('volumeReduction');
            const volumeReductionValue = document.getElementById('volumeReductionValue');
            
            if (autoAdjustVolumeCheckbox) {
                autoAdjustVolumeCheckbox.checked = window.userSettings.autoAdjustVolume;
            }
            
            if (speakingThreshold && speakingThresholdValue) {
                speakingThreshold.value = window.userSettings.speakingThreshold;
                speakingThresholdValue.textContent = window.userSettings.speakingThreshold;
            }
            
            if (volumeReduction && volumeReductionValue) {
                volumeReduction.value = window.userSettings.volumeReduction;
                volumeReductionValue.textContent = `${window.userSettings.volumeReduction}%`;
            }
            
            // ä¸ºé€šè¯è®¾ç½®æ»‘å—æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            if (speakingThreshold && speakingThresholdValue) {
                speakingThreshold.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    speakingThresholdValue.textContent = value;
                    window.userSettings.speakingThreshold = value;
                });
            }
            
            if (volumeReduction && volumeReductionValue) {
                volumeReduction.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    volumeReductionValue.textContent = `${value}%`;
                    window.userSettings.volumeReduction = value;
                });
            }
            
            // æ›´æ–°å½“å‰ç¿»è¯‘ç›®æ ‡è¯­è¨€
            currentTargetLanguage = window.userSettings.targetLanguage;
            
            // åˆå§‹åŒ–è§†é¢‘å‚æ•°æ»‘åŠ¨æ¡
            initVideoParameterSliders();
            // ç«‹å³åº”ç”¨è§†é¢‘å‚æ•°è®¾ç½®
            applyVideoSettings();
        }
        
        // åˆå§‹åŒ–è§†é¢‘å‚æ•°æ»‘åŠ¨æ¡
        function initVideoParameterSliders() {
            // æˆ‘çš„è§†é¢‘å‚æ•°æ»‘åŠ¨æ¡
            const myVideoBrightness = document.getElementById('myVideoBrightness');
            const myVideoContrast = document.getElementById('myVideoContrast');
            const myVideoSaturation = document.getElementById('myVideoSaturation');
            const myVideoExposure = document.getElementById('myVideoExposure');
            
            // æ›´æ–°æ»‘åŠ¨æ¡å€¼å’Œæ˜¾ç¤ºå€¼
            if (myVideoBrightness) {
                myVideoBrightness.value = window.userSettings.myVideoBrightness;
                document.getElementById('myVideoBrightnessValue').textContent = window.userSettings.myVideoBrightness.toFixed(1);
            }
            if (myVideoContrast) {
                myVideoContrast.value = window.userSettings.myVideoContrast;
                document.getElementById('myVideoContrastValue').textContent = window.userSettings.myVideoContrast.toFixed(1);
            }
            if (myVideoSaturation) {
                myVideoSaturation.value = window.userSettings.myVideoSaturation;
                document.getElementById('myVideoSaturationValue').textContent = window.userSettings.myVideoSaturation.toFixed(1);
            }
            if (myVideoExposure) {
                myVideoExposure.value = window.userSettings.myVideoExposure;
                document.getElementById('myVideoExposureValue').textContent = window.userSettings.myVideoExposure.toFixed(2);
            }
            
            // ä¸ºæ»‘åŠ¨æ¡æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const addSliderEvent = (slider, valueElement, settingKey) => {
                if (slider && valueElement) {
                    slider.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        valueElement.textContent = value.toFixed(settingKey.includes('Exposure') ? 2 : 1);
                        // ä¿å­˜è®¾ç½®
                        window.userSettings[settingKey] = value;
                        // ç«‹å³åº”ç”¨è®¾ç½®
                        applyVideoSettings();
                    });
                }
            };
            
            // ç»‘å®šäº‹ä»¶
            addSliderEvent(myVideoBrightness, document.getElementById('myVideoBrightnessValue'), 'myVideoBrightness');
            addSliderEvent(myVideoContrast, document.getElementById('myVideoContrastValue'), 'myVideoContrast');
            addSliderEvent(myVideoSaturation, document.getElementById('myVideoSaturationValue'), 'myVideoSaturation');
            addSliderEvent(myVideoExposure, document.getElementById('myVideoExposureValue'), 'myVideoExposure');
        }
        
        // åº”ç”¨è§†é¢‘å‚æ•°è®¾ç½®
        function applyVideoSettings() {
            // ä½¿ç”¨CSS filterå±æ€§æ¥åº”ç”¨è§†é¢‘å‚æ•°è°ƒæ•´
            const localVideo = document.getElementById('localVideo');
            const remoteVideo = document.getElementById('remoteVideo');
            
            if (localVideo) {
                const brightness = window.userSettings.myVideoBrightness;
                const contrast = window.userSettings.myVideoContrast;
                const saturation = window.userSettings.myVideoSaturation;
                const exposure = window.userSettings.myVideoExposure;
                
                // åº”ç”¨CSS filterï¼ŒåŒ…å«æ›å…‰æ•ˆæœï¼ˆé€šè¿‡äº®åº¦å’Œå¯¹æ¯”åº¦çš„ç»„åˆå®ç°ï¼‰
                localVideo.style.filter = `brightness(${brightness}) contrast(${contrast}) saturate(${saturation}) brightness(${exposure})`;
            }
            
            if (remoteVideo) {
                const brightness = window.userSettings.myVideoBrightness;
                const contrast = window.userSettings.myVideoContrast;
                const saturation = window.userSettings.myVideoSaturation;
                const exposure = window.userSettings.myVideoExposure;
                
                // åº”ç”¨CSS filterï¼ŒåŒ…å«æ›å…‰æ•ˆæœï¼ˆé€šè¿‡äº®åº¦å’Œå¯¹æ¯”åº¦çš„ç»„åˆå®ç°ï¼‰
                remoteVideo.style.filter = `brightness(${brightness}) contrast(${contrast}) saturate(${saturation}) brightness(${exposure})`;
            }
        }
        
        // æ›´æ–°æœ¬åœ°è§†é¢‘é•œåƒè®¾ç½®
        function updateVideoMirrorSetting() {
            const localVideo = document.getElementById('localVideo');
            if (localVideo) {
                if (window.userSettings.mirrorVideo) {
                    localVideo.style.transform = 'scaleX(-1)';
                } else {
                    localVideo.style.transform = '';
                }
            }
        }
        
        // æ›´æ–°å¯¹æ–¹è§†é¢‘é•œåƒè®¾ç½®
        function updateRemoteVideoMirrorSetting() {
            const remoteVideo = document.getElementById('remoteVideo');
            if (remoteVideo) {
                if (window.userSettings.remoteMirrorVideo) {
                    remoteVideo.style.transform = 'scaleX(-1)';
                } else {
                    remoteVideo.style.transform = '';
                }
            }
        }
        
        // æ›´æ–°è®¾ç½®æ¨¡æ€æ¡†çŠ¶æ€
        function updateSettingsModalStatus() {
            // è·å–æ‰€æœ‰éé€šè¯è®¾ç½®ç›¸å…³çš„è¡¨å•å…ƒç´ 
            const generalFormElements = [
                document.getElementById('targetLanguageSelect'),
                document.getElementById('autoTranslateCheckbox'),
                document.getElementById('soundNotificationCheckbox'),
                document.getElementById('mentionNotificationCheckbox'),
                document.getElementById('developerModeCheckbox'),
                document.getElementById('mirrorVideoCheckbox')
            ];
            
            // è·å–è§†é¢‘å‚æ•°è°ƒæ•´ç›¸å…³çš„è¡¨å•å…ƒç´ ï¼ˆé€šè¯ä¸­å¯è°ƒæ•´ï¼‰
            const videoParamElements = [
                document.getElementById('myVideoBrightness'),
                document.getElementById('myVideoContrast'),
                document.getElementById('myVideoSaturation'),
                document.getElementById('myVideoExposure')
            ];
            
            // è·å–ä¿å­˜æŒ‰é’®å’Œé”å®šæç¤ºå…ƒç´ 
            const saveButton = document.querySelector('#settingsModal .btn-confirm');
            const lockNotice = document.getElementById('settingsLockNotice');
            const lockNoticeText = document.getElementById('lockNoticeText');
            
            if (settingsLocked) {
                // é”å®šçŠ¶æ€ï¼šç¦ç”¨é€šç”¨è®¾ç½®è¡¨å•å…ƒç´ ï¼Œæ˜¾ç¤ºé”å®šæç¤º
                generalFormElements.forEach(element => {
                    if (element) {
                        element.disabled = true;
                        element.style.opacity = '0.5';
                        element.style.cursor = 'not-allowed';
                    }
                });
                
                // è§†é¢‘å‚æ•°è°ƒæ•´å…ƒç´ å§‹ç»ˆå¯ç”¨ï¼ˆé€šè¯ä¸­å¯è°ƒæ•´ï¼‰
                videoParamElements.forEach(element => {
                    if (element) {
                        element.disabled = false;
                        element.style.opacity = '1';
                        element.style.cursor = 'pointer';
                    }
                });
                
                // ç¦ç”¨ä¿å­˜æŒ‰é’®
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.style.opacity = '0.5';
                    saveButton.style.cursor = 'not-allowed';
                }
                
                // æ˜¾ç¤ºé”å®šæç¤º
                if (lockNotice) {
                    lockNotice.style.display = 'block';
                    lockNoticeText.textContent = settingsLockMessage;
                }
            } else {
                // æœªé”å®šçŠ¶æ€ï¼šå¯ç”¨æ‰€æœ‰è¡¨å•å…ƒç´ ï¼Œéšè—é”å®šæç¤º
                generalFormElements.forEach(element => {
                    if (element) {
                        element.disabled = false;
                        element.style.opacity = '1';
                        element.style.cursor = 'pointer';
                    }
                });
                
                videoParamElements.forEach(element => {
                    if (element) {
                        element.disabled = false;
                        element.style.opacity = '1';
                        element.style.cursor = 'pointer';
                    }
                });
                
                // å¯ç”¨ä¿å­˜æŒ‰é’®
                if (saveButton) {
                    saveButton.disabled = false;
                    saveButton.style.opacity = '1';
                    saveButton.style.cursor = 'pointer';
                }
                
                // éšè—é”å®šæç¤º
                if (lockNotice) {
                    lockNotice.style.display = 'none';
                }
            }
        }
        
        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            // æ£€æŸ¥è®¾ç½®æ˜¯å¦è¢«é”å®š
            if (settingsLocked) {
                alert(settingsLockMessage);
                return;
            }
            
            window.userSettings.targetLanguage = targetLanguageSelect.value;
            window.userSettings.autoTranslate = autoTranslateCheckbox.checked;
            
            // ä¿å­˜å¼€å‘è€…æ¨¡å¼è®¾ç½®
            const developerModeCheckbox = document.getElementById('developerModeCheckbox');
            if (developerModeCheckbox) {
                window.userSettings.developerMode = developerModeCheckbox.checked;
            }
            
            // ä¿å­˜æœ¬åœ°è§†é¢‘é•œåƒè®¾ç½®
            const mirrorVideoCheckbox = document.getElementById('mirrorVideoCheckbox');
            if (mirrorVideoCheckbox) {
                window.userSettings.mirrorVideo = mirrorVideoCheckbox.checked;
                // ç«‹å³åº”ç”¨æœ¬åœ°é•œåƒè®¾ç½®
                updateVideoMirrorSetting();
            }
            
            // ä¿å­˜å¯¹æ–¹è§†é¢‘é•œåƒè®¾ç½®
            const remoteMirrorVideoCheckbox = document.getElementById('remoteMirrorVideoCheckbox');
            if (remoteMirrorVideoCheckbox) {
                window.userSettings.remoteMirrorVideo = remoteMirrorVideoCheckbox.checked;
                // ç«‹å³åº”ç”¨å¯¹æ–¹è§†é¢‘é•œåƒè®¾ç½®
                updateRemoteVideoMirrorSetting();
            }
            
            // ä¿å­˜é€šè¯è®¾ç½®
            const autoAdjustVolumeCheckbox = document.getElementById('autoAdjustVolumeCheckbox');
            const speakingThreshold = document.getElementById('speakingThreshold');
            const volumeReduction = document.getElementById('volumeReduction');
            
            if (autoAdjustVolumeCheckbox) {
                window.userSettings.autoAdjustVolume = autoAdjustVolumeCheckbox.checked;
            }
            
            if (speakingThreshold) {
                window.userSettings.speakingThreshold = parseInt(speakingThreshold.value);
            }
            
            if (volumeReduction) {
                window.userSettings.volumeReduction = parseInt(volumeReduction.value);
            }
            
            // æ›´æ–°å½“å‰ç¿»è¯‘ç›®æ ‡è¯­è¨€
            currentTargetLanguage = window.userSettings.targetLanguage;
            
            // ä¿å­˜è§†é¢‘å‚æ•°è®¾ç½®ï¼ˆæ»‘åŠ¨æ¡å·²ç»åœ¨inputäº‹ä»¶ä¸­å®æ—¶ä¿å­˜ï¼Œä½†è¿™é‡Œå†æ¬¡ç¡®è®¤ï¼‰
            const myVideoBrightness = document.getElementById('myVideoBrightness');
            const myVideoContrast = document.getElementById('myVideoContrast');
            const myVideoSaturation = document.getElementById('myVideoSaturation');
            const myVideoExposure = document.getElementById('myVideoExposure');
            
            if (myVideoBrightness) window.userSettings.myVideoBrightness = parseFloat(myVideoBrightness.value);
            if (myVideoContrast) window.userSettings.myVideoContrast = parseFloat(myVideoContrast.value);
            if (myVideoSaturation) window.userSettings.myVideoSaturation = parseFloat(myVideoSaturation.value);
            if (myVideoExposure) window.userSettings.myVideoExposure = parseFloat(myVideoExposure.value);
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('userSettings', JSON.stringify(window.userSettings));
            
            // å…³é—­è®¾ç½®æ¨¡æ€æ¡†
            closeSettingsModal();
            
            // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
            alert('è®¾ç½®å·²ä¿å­˜');
        }
        
        // ç›‘å¬è®¾ç½®æ›´æ–°äº‹ä»¶
        socket.on('user-settings-updated', (data) => {
            // æ›´æ–°é”å®šçŠ¶æ€
            settingsLocked = data.locked || false;
            settingsLockMessage = data.lockMessage || 'è®¾ç½®å·²è¢«ç®¡ç†å‘˜é”å®š';
            
            // å¦‚æœåŒ…å«ç”¨æˆ·å…·ä½“è®¾ç½®ï¼Œæ›´æ–°æœ¬åœ°è®¾ç½®
            if (data.userSettings) {
                userSettings = {
                    ...userSettings,
                    ...data.userSettings
                };
                
                // æ›´æ–°UI
                targetLanguageSelect.value = userSettings.targetLanguage;
                autoTranslateCheckbox.checked = userSettings.autoTranslate;
                
                // æ›´æ–°å½“å‰ç¿»è¯‘ç›®æ ‡è¯­è¨€
                currentTargetLanguage = userSettings.targetLanguage;
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('userSettings', JSON.stringify(userSettings));
            }
            
            // æ›´æ–°è®¾ç½®æ¨¡æ€æ¡†çŠ¶æ€
            updateSettingsModalStatus();
            
            // å¦‚æœè®¾ç½®è¢«é”å®šï¼Œæç¤ºç”¨æˆ·
            if (settingsLocked) {
                alert(settingsLockMessage);
            }
        });
        
        // è®¾ç½®è®¾ç½®æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        settingsBtn.addEventListener('click', () => {
            // æ‰“å¼€è®¾ç½®æ¨¡æ€æ¡†
            settingsModal.classList.add('active');
            
            // æ›´æ–°è®¾ç½®æ¨¡æ€æ¡†çŠ¶æ€
            updateSettingsModalStatus();
        });
        
        // å…³é—­è®¾ç½®æ¨¡æ€æ¡†
        function closeSettingsModal() {
            settingsModal.classList.remove('active');
        }
        
        let friends = [];
        let currentPrivateChatTarget = null;
        
        // é€šè¯ç³»ç»Ÿç±» - æ”¯æŒwebrtcå’Œsocket.ioä¸¤ç§é€šè¯æ–¹å¼
        class CallSystem {
            constructor(socket, username) {
                this.socket = socket;
                this.username = username;
                this.isInCall = false;
                this.isCallInitiator = false; // æ ‡å¿—å½“å‰æ˜¯å¦ä¸ºå‘èµ·æ–¹
                this.isSharingScreen = false; // æ ‡å¿—å½“å‰æ˜¯å¦æ­£åœ¨å…±äº«å±å¹•
                this.currentCallId = null;
                this.currentCallType = null; // 'video' or 'audio'
                this.currentCallTargetSocketId = null;
                /* 
                 * é€šè¯æ–¹å¼è¯´æ˜ï¼š
                 * - webrtcï¼šç‚¹å¯¹ç‚¹ç›´æ¥é€šä¿¡ï¼Œå»¶è¿Ÿä½ï¼Œè´¨é‡é«˜ï¼Œä½†åªèƒ½åœ¨å±€åŸŸç½‘å†…ä½¿ç”¨
                 * - socket.ioï¼šä½¿ç”¨æœåŠ¡å™¨è½¬å‘æ•°æ®ï¼Œæ”¯æŒè·¨ç½‘æ®µé€šè¯
                 */
                this.currentCallMethod = 'webrtc'; // é»˜è®¤ä½¿ç”¨webrtcï¼Œå¯é€‰'socket.io'
                this.localStream = null;
                this.remoteStream = null;
                this.peerConnection = null;
                this.iceServers = {
                    iceServers: [
                        // STUNæœåŠ¡å™¨ç”¨äºå‘ç°å…¬ç½‘IPå’Œç«¯å£
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' },
                        { urls: 'stun:stun4.l.google.com:19302' },
                        // TURNæœåŠ¡å™¨ç”¨äºç©¿é€ä¸¥æ ¼NATï¼Œæä¾›ä¸­ç»§æœåŠ¡
                        { 
                            urls: 'turn:turn.l.google.com:19305', 
                            username: 'webrtc', 
                            credential: 'webrtc'
                        },
                        { 
                            urls: 'turn:turnserver.example.com:3478', 
                            username: 'demo', 
                            credential: 'demo123'
                        }
                    ]
                };
                this.socketMediaBuffer = [];
                this.pendingIceCandidates = null;
                this.pendingOffer = null;
                this.currentFacingMode = 'user'; // å½“å‰æ‘„åƒå¤´æ–¹å‘ï¼š'user'ï¼ˆå‰ç½®ï¼‰æˆ–'environment'ï¼ˆåç½®ï¼‰
                this.videoDevices = []; // å­˜å‚¨æ‰€æœ‰è§†é¢‘è®¾å¤‡
                
                // Socket.ioåª’ä½“æµç›¸å…³
                this.mediaSource = null;
                this.sourceBuffer = null;
                this.socketMediaQueue = []; // åª’ä½“æ•°æ®é˜Ÿåˆ—
                this.isMediaSourceOpen = false;
                
                // éŸ³é¢‘éŸ³é‡è‡ªåŠ¨è°ƒæ•´ç›¸å…³
                this.audioContext = null;
                this.analyser = null;
                this.mediaRecorder = null;
                this.audioGainNode = null;
                this.audioLevelDetector = null;
                this.isMonitoringAudio = false;
                this.audioLevel = 0;
                this.originalVolume = 1.0;
                this.adjustedVolume = 1.0;
                
                this.init();
            }
            
            init() {
                this.setupSocketListeners();
            }
            
            setupSocketListeners() {
                // ç›‘å¬é€šè¯è¯·æ±‚
                this.socket.on('call-request', (data) => {
                    this.handleCallRequest(data);
                });
                
                // ç›‘å¬é€šè¯æ¥å—
                this.socket.on('call-accepted', (data) => {
                    this.handleCallAccepted(data);
                });
                
                // ç›‘å¬é€šè¯æ‹’ç»
                this.socket.on('call-rejected', (data) => {
                    this.handleCallRejected(data);
                });
                
                // ç›‘å¬é€šè¯ç»“æŸ
                this.socket.on('call-ended', (data) => {
                    this.handleCallEnded(data);
                });
                
                // ç›‘å¬WebRTCåª’ä½“æ•°æ®ï¼ˆoffer/answer/ICEå€™é€‰ï¼‰
                this.socket.on('call-media', (data) => {
                    this.handleCallMedia(data);
                });
            }
            
            // è®¾ç½®é€šè¯æ–¹å¼
            setCallMethod(method) {
                this.currentCallMethod = method;
            }
            
            // å‘èµ·é€šè¯è¯·æ±‚
            startCall(targetSocketId, callType, callMethod) {
                this.currentCallId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                this.currentCallType = callType;
                this.currentCallTargetSocketId = targetSocketId;
                this.currentCallMethod = callMethod || this.currentCallMethod;
                this.isInCall = true;
                this.isCallInitiator = true; // è®¾ç½®ä¸ºå‘èµ·æ–¹
                
                // æ˜¾ç¤ºè§†é¢‘å®¹å™¨
                const videoContainer = document.getElementById('videoContainer');
                if (videoContainer) {
                    videoContainer.classList.add('active');
                }
                
                // æ˜¾ç¤ºç­‰å¾…æç¤º
                this.showWaitingPrompt();
                
                // å¦‚æœå¼€å‘è€…æ¨¡å¼å¼€å¯ï¼Œæ˜¾ç¤ºæ—¥å¿—åŒºåŸŸ
                if (window.userSettings && window.userSettings.developerMode) {
                    window.DeveloperLogManager.showLog();
                }
                
                // è·å–æœ¬åœ°åª’ä½“æµï¼ˆè¿™æ ·å‘èµ·ç«¯å°±èƒ½çœ‹åˆ°è‡ªå·±çš„ç”»é¢ï¼‰
                this.initLocalMediaStream();
                
                // å‘é€é€šè¯è¯·æ±‚
                this.socket.emit('call-request', {
                    targetSocketId: targetSocketId,
                    callId: this.currentCallId,
                    callType: callType,
                    callMethod: this.currentCallMethod,
                    fromUsername: this.username
                });
            }
            
            // è·å–è§†é¢‘è®¾å¤‡åˆ—è¡¨
            async getVideoDevices() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    this.videoDevices = devices.filter(device => device.kind === 'videoinput');
                    console.log('è§†é¢‘è®¾å¤‡åˆ—è¡¨:', this.videoDevices);
                    return this.videoDevices;
                } catch (error) {
                    console.error('è·å–è§†é¢‘è®¾å¤‡å¤±è´¥:', error);
                    return [];
                }
            }
            
            // åˆå§‹åŒ–æœ¬åœ°åª’ä½“æµï¼ˆåªæ˜¾ç¤ºè‡ªå·±çš„ç”»é¢ï¼Œä¸å¼€å§‹é€šè¯ï¼‰
            initLocalMediaStream() {
                console.log('initLocalMediaStream: isInCall=', this.isInCall);
                
                // å¦‚æœä¸åœ¨é€šè¯ä¸­ï¼Œç›´æ¥è¿”å›ï¼Œé¿å…ç»§ç»­æ‰§è¡Œ
                if (!this.isInCall) {
                    console.log('ä¸åœ¨é€šè¯ä¸­ï¼Œå–æ¶ˆinitLocalMediaStream');
                    return;
                }
                
                // å…ˆè·å–è§†é¢‘è®¾å¤‡åˆ—è¡¨
                this.getVideoDevices();
                
                const constraints = {
                    audio: true,
                    video: this.currentCallType === 'video' ? {
                        facingMode: this.currentFacingMode
                    } : false
                };
                
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(stream => {
                        // æ£€æŸ¥æ˜¯å¦ä»åœ¨é€šè¯ä¸­ï¼Œé¿å…åœ¨é€šè¯ç»“æŸåè®¾ç½®localStream
                        if (!this.isInCall) {
                            console.log('é€šè¯å·²ç»“æŸï¼Œåœæ­¢æ–°è·å–çš„æœ¬åœ°åª’ä½“æµ');
                            stream.getTracks().forEach(track => track.stop());
                            return;
                        }
                        
                        this.localStream = stream;
                        // æ˜¾ç¤ºæœ¬åœ°è§†é¢‘æµ
                        this.showLocalStream(stream);
                    })
                    .catch(error => {
                        console.error('è·å–æœ¬åœ°åª’ä½“æµå¤±è´¥:', error);
                        // åªæœ‰åœ¨é€šè¯ä¸­æ‰æ˜¾ç¤ºé”™è¯¯å’Œç»“æŸé€šè¯
                        if (this.isInCall) {
                            alert('è·å–æœ¬åœ°åª’ä½“æµå¤±è´¥: ' + error.message);
                            this.endCall();
                        }
                    });
            }
            
            // æ˜¾ç¤ºç­‰å¾…æç¤º
            showWaitingPrompt() {
                // åˆ›å»ºç­‰å¾…æç¤ºå…ƒç´ 
                const waitingPrompt = document.createElement('div');
                waitingPrompt.id = 'waitingPrompt';
                waitingPrompt.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 20px 40px;
                    border-radius: 10px;
                    font-size: 18px;
                    z-index: 1001;
                `;
                waitingPrompt.textContent = 'æ­£åœ¨ç­‰å¾…å¯¹æ–¹æ¥å¬...';
                document.body.appendChild(waitingPrompt);
            }
            
            // éšè—ç­‰å¾…æç¤º
            hideWaitingPrompt() {
                const waitingPrompt = document.getElementById('waitingPrompt');
                if (waitingPrompt) {
                    waitingPrompt.remove();
                }
            }
            
            // å¤„ç†é€šè¯è¯·æ±‚
            handleCallRequest(data) {
                // ä¿å­˜é€šè¯ä¿¡æ¯ï¼Œä½†ä¸ç«‹å³è¿›å…¥é€šè¯çŠ¶æ€
                this.currentCallId = data.callId;
                this.currentCallType = data.type;
                this.currentCallTargetSocketId = data.from;
                this.currentCallMethod = data.callMethod;
                this.isCallInitiator = false; // è®¾ç½®ä¸ºæ¥æ”¶æ–¹
                
                // ä¿å­˜offerï¼Œå¦‚æœæœ‰çš„è¯ï¼ˆå¯èƒ½é€šè¿‡WebRTCä¿¡ä»¤å…ˆåˆ°è¾¾ï¼‰
                if (data.offer) {
                    this.pendingOffer = data.offer;
                }
                
                // æ˜¾ç¤ºæ¥ç”µç•Œé¢ï¼Œå…è®¸ç”¨æˆ·é€‰æ‹©æ¥å¬æˆ–æ‹’ç»
                const callIncoming = document.getElementById('callIncoming');
                const callIncomingText = document.getElementById('callIncomingText');
                callIncomingText.textContent = `${data.fromUsername} å‘èµ·äº†${data.type === 'video' ? 'è§†é¢‘' : 'è¯­éŸ³'}é€šè¯`;
                callIncoming.classList.add('active');
            }
            
            // å¤„ç†é€šè¯æ¥å—
            handleCallAccepted(data) {
                // éšè—ç­‰å¾…æç¤º
                this.hideWaitingPrompt();
                
                // ç¡®ä¿è®¾ç½®ä¸ºé€šè¯ä¸­çŠ¶æ€
                this.isInCall = true;
                
                // æ˜¾ç¤ºè§†é¢‘å®¹å™¨ï¼ˆå¦‚æœè¿˜æ²¡æ˜¾ç¤ºï¼‰
                const videoContainer = document.getElementById('videoContainer');
                if (videoContainer) {
                    videoContainer.classList.add('active');
                }
                
                // åˆå§‹åŒ–åª’ä½“æµ
                this.initMediaStream();
            }
            
            // å¤„ç†é€šè¯æ‹’ç»
            handleCallRejected(data) {
                // éšè—ç­‰å¾…æç¤º
                this.hideWaitingPrompt();
                
                // é‡ç½®é€šè¯çŠ¶æ€
                this.resetCallState();
                alert('é€šè¯è¢«æ‹’ç»');
            }
            
            // é‡ç½®é€šè¯çŠ¶æ€
            resetCallState() {
                this.isInCall = false;
                this.isCallInitiator = false;
                this.currentCallId = null;
                this.currentCallType = null;
                this.currentCallTargetSocketId = null;
                this.currentCallMethod = 'webrtc';
                this.pendingOffer = null;
                this.pendingIceCandidates = null;
            }
            
            // å¤„ç†é€šè¯ç»“æŸ
            handleCallEnded(data) {
                this.cleanupMedia();
                this.resetCallState();
                
                // éšè—è§†é¢‘å®¹å™¨
                const videoContainer = document.getElementById('videoContainer');
                if (videoContainer) {
                    videoContainer.classList.remove('active');
                }
                
                // éšè—æ—¥å¿—åŒºåŸŸ
                window.DeveloperLogManager.hideLog();
                
                alert('é€šè¯å·²ç»“æŸ');
            }
            
            // æ¥å—é€šè¯
            acceptCall() {
                if (!this.currentCallId) return;
                
                // å…³é—­æ¥ç”µç•Œé¢
                const callIncoming = document.getElementById('callIncoming');
                callIncoming.classList.remove('active');
                
                // éšè—ç­‰å¾…æç¤ºï¼ˆæ¥æ”¶æ–¹ä¹Ÿå¯èƒ½æœ‰ç­‰å¾…æç¤ºï¼‰
                this.hideWaitingPrompt();
                
                // è®¾ç½®ä¸ºé€šè¯ä¸­çŠ¶æ€
                this.isInCall = true;
                
                // å‘é€é€šè¯æ¥å—
                this.socket.emit('call-accept', {
                    targetSocketId: this.currentCallTargetSocketId,
                    callId: this.currentCallId,
                    callMethod: this.currentCallMethod
                });
                
                // æ˜¾ç¤ºè§†é¢‘å®¹å™¨
                const videoContainer = document.getElementById('videoContainer');
                if (videoContainer) {
                    videoContainer.classList.add('active');
                }
                
                // å¦‚æœå¼€å‘è€…æ¨¡å¼å¼€å¯ï¼Œæ˜¾ç¤ºæ—¥å¿—åŒºåŸŸ
                if (window.userSettings && window.userSettings.developerMode) {
                    window.DeveloperLogManager.showLog();
                }
                
                // åˆå§‹åŒ–åª’ä½“æµ
                this.initMediaStream();
            }
            
            // æ‹’ç»é€šè¯
            rejectCall() {
                if (!this.currentCallId) return;
                
                // å…³é—­æ¥ç”µç•Œé¢
                const callIncoming = document.getElementById('callIncoming');
                callIncoming.classList.remove('active');
                
                // å‘é€é€šè¯æ‹’ç»
                this.socket.emit('call-reject', {
                    targetSocketId: this.currentCallTargetSocketId,
                    callId: this.currentCallId
                });
                
                this.resetCallState();
            }
            
            // ç»“æŸé€šè¯
            endCall() {
                if (!this.currentCallId) return;
                
                // å‘é€é€šè¯ç»“æŸ
                this.socket.emit('call-end', {
                    targetSocketId: this.currentCallTargetSocketId,
                    callId: this.currentCallId
                });
                
                this.cleanupMedia();
                this.resetCallState();
                
                // éšè—è§†é¢‘å®¹å™¨
                const videoContainer = document.getElementById('videoContainer');
                if (videoContainer) {
                    videoContainer.classList.remove('active');
                }
                
                // éšè—æ—¥å¿—åŒºåŸŸ
                window.DeveloperLogManager.hideLog();
            }
            
            // åˆ‡æ¢è§†é¢‘å¼€å…³
            toggleVideo() {
                if (!this.localStream) return;
                
                // åˆ‡æ¢è§†é¢‘è½¨é“çš„enabledçŠ¶æ€
                const videoTracks = this.localStream.getVideoTracks();
                let isEnabled = true;
                videoTracks.forEach(track => {
                    track.enabled = !track.enabled;
                    isEnabled = track.enabled;
                });
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                const toggleVideoBtn = document.getElementById('toggleVideoBtn');
                if (toggleVideoBtn) {
                    // æ ¹æ®è§†é¢‘è½¨é“çŠ¶æ€æ”¹å˜æŒ‰é’®æ ·å¼
                    if (isEnabled) {
                        toggleVideoBtn.classList.remove('disabled');
                        toggleVideoBtn.innerHTML = 'ğŸ“¹';
                    } else {
                        toggleVideoBtn.classList.add('disabled');
                        toggleVideoBtn.innerHTML = 'ğŸ“·';
                    }
                }
            }
            
            // åˆ‡æ¢éŸ³é¢‘å¼€å…³
            toggleAudio() {
                if (!this.localStream) return;
                
                // åˆ‡æ¢éŸ³é¢‘è½¨é“çš„enabledçŠ¶æ€
                const audioTracks = this.localStream.getAudioTracks();
                let isEnabled = true;
                audioTracks.forEach(track => {
                    track.enabled = !track.enabled;
                    isEnabled = track.enabled;
                });
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                const toggleAudioBtn = document.getElementById('toggleAudioBtn');
                if (toggleAudioBtn) {
                    // æ ¹æ®éŸ³é¢‘è½¨é“çŠ¶æ€æ”¹å˜æŒ‰é’®æ ·å¼
                    if (isEnabled) {
                        toggleAudioBtn.classList.remove('disabled');
                        toggleAudioBtn.innerHTML = 'ğŸ¤';
                    } else {
                        toggleAudioBtn.classList.add('disabled');
                        toggleAudioBtn.innerHTML = 'ğŸ”‡';
                    }
                }
            }
            
            // åˆå§‹åŒ–MediaSourceï¼ˆç”¨äºSocket.ioæ–¹å¼çš„åª’ä½“æµæ’­æ”¾ï¼‰
            initMediaSource() {
                console.log('åˆå§‹åŒ–MediaSource...');
                
                // å¦‚æœä¸æ˜¯è§†é¢‘é€šè¯ï¼Œä¸éœ€è¦åˆå§‹åŒ–MediaSource
                if (this.currentCallType !== 'video') {
                    console.log('éè§†é¢‘é€šè¯ï¼Œè·³è¿‡MediaSourceåˆå§‹åŒ–');
                    return;
                }
                
                try {
                    // æ¸…ç†æ—§çš„MediaSourceå’ŒSourceBuffer
                    if (this.mediaSource) {
                        try {
                            if (this.mediaSource.readyState === 'open') {
                                this.mediaSource.endOfStream();
                            }
                            // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                            this.mediaSource.removeEventListener('sourceopen', this.sourceOpenHandler);
                            this.mediaSource.removeEventListener('error', this.mediaSourceErrorHandler);
                            this.mediaSource.removeEventListener('sourceclose', this.mediaSourceCloseHandler);
                        } catch (e) {
                            console.error('æ¸…ç†æ—§MediaSourceæ—¶å‡ºé”™:', e);
                        }
                        this.mediaSource = null;
                    }
                    
                    if (this.sourceBuffer) {
                        try {
                            this.sourceBuffer.removeEventListener('updateend', this.updateEndHandler);
                        } catch (e) {
                            console.error('æ¸…ç†æ—§SourceBufferæ—¶å‡ºé”™:', e);
                        }
                        this.sourceBuffer = null;
                    }
                    
                    // åˆ›å»ºæ–°çš„MediaSource
                    this.mediaSource = new MediaSource();
                    
                    // è·å–è¿œç¨‹è§†é¢‘å…ƒç´ 
                    const remoteVideo = document.getElementById('remoteVideo');
                    if (!remoteVideo) {
                        console.error('è¿œç¨‹è§†é¢‘å…ƒç´ ä¸å­˜åœ¨ï¼Œæ— æ³•åˆå§‹åŒ–MediaSource');
                        return;
                    }
                    
                    // å­˜å‚¨äº‹ä»¶ç›‘å¬å™¨å¼•ç”¨ï¼Œä»¥ä¾¿åç»­ç§»é™¤
                    this.sourceOpenHandler = () => {
                        console.log('MediaSourceå·²æ‰“å¼€');
                        this.isMediaSourceOpen = true;
                        
                        // åˆ›å»ºSourceBufferï¼Œä½¿ç”¨ä¸MediaRecorderç›¸åŒçš„mimeType
                        const mimeType = 'video/webm; codecs=vp8,opus';
                        if (this.mediaSource.isTypeSupported(mimeType)) {
                            this.sourceBuffer = this.mediaSource.addSourceBuffer(mimeType);
                            console.log('SourceBufferå·²åˆ›å»ºï¼ŒmimeType:', mimeType);
                            
                            // ç›‘å¬SourceBufferçš„updateendäº‹ä»¶ï¼Œç”¨äºå¤„ç†é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªåª’ä½“æ•°æ®
                            this.updateEndHandler = () => {
                                this.processMediaQueue();
                            };
                            this.sourceBuffer.addEventListener('updateend', this.updateEndHandler);
                            
                            // å¦‚æœé˜Ÿåˆ—ä¸­æœ‰ç­‰å¾…å¤„ç†çš„åª’ä½“æ•°æ®ï¼Œç«‹å³å¤„ç†
                            this.processMediaQueue();
                        } else {
                            console.error('ä¸æ”¯æŒçš„mimeType:', mimeType);
                            // å°è¯•å…¶ä»–å¯èƒ½çš„mimeType
                            const fallbackMimeType = 'video/webm';
                            if (this.mediaSource.isTypeSupported(fallbackMimeType)) {
                                this.sourceBuffer = this.mediaSource.addSourceBuffer(fallbackMimeType);
                                console.log('ä½¿ç”¨ fallback mimeType åˆ›å»ºSourceBuffer:', fallbackMimeType);
                                
                                // ç›‘å¬SourceBufferçš„updateendäº‹ä»¶
                                this.updateEndHandler = () => {
                                    this.processMediaQueue();
                                };
                                this.sourceBuffer.addEventListener('updateend', this.updateEndHandler);
                                
                                this.processMediaQueue();
                            } else {
                                console.error('ä¸æ”¯æŒä»»ä½•webm mimeType');
                            }
                        }
                    };
                    
                    this.mediaSourceErrorHandler = (e) => {
                        console.error('MediaSourceé”™è¯¯:', e);
                        // é‡æ–°åˆå§‹åŒ–MediaSource
                        setTimeout(() => {
                            this.initMediaSource();
                        }, 1000);
                    };
                    
                    this.mediaSourceCloseHandler = () => {
                        console.log('MediaSourceå·²å…³é—­');
                        this.isMediaSourceOpen = false;
                        this.sourceBuffer = null;
                        // å¦‚æœé€šè¯ä»åœ¨è¿›è¡Œä¸­ï¼Œé‡æ–°åˆå§‹åŒ–MediaSource
                        if (this.isInCall && this.currentCallMethod === 'socket.io') {
                            setTimeout(() => {
                                this.initMediaSource();
                            }, 1000);
                        }
                    };
                    
                    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                    this.mediaSource.addEventListener('sourceopen', this.sourceOpenHandler);
                    this.mediaSource.addEventListener('error', this.mediaSourceErrorHandler);
                    this.mediaSource.addEventListener('sourceclose', this.mediaSourceCloseHandler);
                    
                    // è®¾ç½®è§†é¢‘æºä¸ºMediaSourceçš„URL
                    remoteVideo.src = URL.createObjectURL(this.mediaSource);
                    
                } catch (error) {
                    console.error('åˆå§‹åŒ–MediaSourceå¤±è´¥:', error);
                    // 1ç§’åé‡è¯•åˆå§‹åŒ–
                    setTimeout(() => {
                        this.initMediaSource();
                    }, 1000);
                }
            }
            
            // å¤„ç†åª’ä½“é˜Ÿåˆ—
            processMediaQueue() {
                // æ£€æŸ¥æ¡ä»¶
                if (!this.sourceBuffer || this.sourceBuffer.updating || this.socketMediaQueue.length === 0) {
                    return;
                }
                
                // ä»é˜Ÿåˆ—ä¸­å–å‡ºç¬¬ä¸€ä¸ªåª’ä½“æ•°æ®
                const mediaData = this.socketMediaQueue.shift();
                console.log('å¤„ç†åª’ä½“æ•°æ®ï¼Œé˜Ÿåˆ—å‰©ä½™:', this.socketMediaQueue.length);
                
                try {
                    // æ£€æŸ¥SourceBufferçŠ¶æ€æ˜¯å¦æœ‰æ•ˆ
                    if (this.sourceBuffer.readyState !== 'open') {
                        console.error('SourceBufferçŠ¶æ€æ— æ•ˆï¼Œæ— æ³•æ·»åŠ åª’ä½“æ•°æ®');
                        // å°†æ•°æ®é‡æ–°æ”¾å›é˜Ÿåˆ—ï¼Œç­‰å¾…SourceBufferæ¢å¤
                        this.socketMediaQueue.unshift(mediaData);
                        this.initMediaSource();
                        return;
                    }
                    
                    // æ£€æŸ¥MediaSourceçŠ¶æ€æ˜¯å¦æœ‰æ•ˆ
                    if (this.mediaSource.readyState !== 'open') {
                        console.error('MediaSourceçŠ¶æ€æ— æ•ˆï¼Œæ— æ³•æ·»åŠ åª’ä½“æ•°æ®');
                        // å°†æ•°æ®é‡æ–°æ”¾å›é˜Ÿåˆ—ï¼Œç­‰å¾…MediaSourceæ¢å¤
                        this.socketMediaQueue.unshift(mediaData);
                        this.initMediaSource();
                        return;
                    }
                    
                    // æ£€æŸ¥SourceBufferæ˜¯å¦å·²æ»¡
                    if (this.sourceBuffer.buffered.length > 0) {
                        const lastBufferEnd = this.sourceBuffer.buffered.end(this.sourceBuffer.buffered.length - 1);
                        const currentTime = document.getElementById('remoteVideo').currentTime;
                        // å¦‚æœç¼“å†²æ•°æ®è¶…è¿‡10ç§’ï¼Œæš‚åœå¤„ç†ï¼Œé¿å…è¿‡åº¦ç¼“å†²
                        if (lastBufferEnd - currentTime > 10) {
                            console.log('ç¼“å†²æ•°æ®è¿‡å¤šï¼Œæš‚åœå¤„ç†ï¼Œç­‰å¾…æ’­æ”¾æ¶ˆè€—');
                            // å°†æ•°æ®é‡æ–°æ”¾å›é˜Ÿåˆ—
                            this.socketMediaQueue.unshift(mediaData);
                            // 1ç§’åé‡è¯•
                            setTimeout(() => {
                                this.processMediaQueue();
                            }, 1000);
                            return;
                        }
                    }
                    
                    // å°†åª’ä½“æ•°æ®æ·»åŠ åˆ°SourceBuffer
                    this.sourceBuffer.appendBuffer(mediaData);
                    console.log('åª’ä½“æ•°æ®å·²æ·»åŠ åˆ°SourceBuffer');
                } catch (error) {
                    console.error('æ·»åŠ åª’ä½“æ•°æ®åˆ°SourceBufferå¤±è´¥:', error);
                    
                    // æ ¹æ®é”™è¯¯ç±»å‹é‡‡å–ä¸åŒçš„å¤„ç†æ–¹å¼
                    if (error.name === 'QuotaExceededError') {
                        console.error('SourceBufferé…é¢è¶…å‡ºï¼Œå°è¯•æ¸…ç†æ—§æ•°æ®');
                        // ä¸æ¸…ç©ºé˜Ÿåˆ—ï¼Œè€Œæ˜¯å°è¯•é‡æ–°åˆå§‹åŒ–MediaSource
                        this.initMediaSource();
                        // å°†æ•°æ®é‡æ–°æ”¾å›é˜Ÿåˆ—
                        this.socketMediaQueue.unshift(mediaData);
                    } else if (error.name === 'InvalidStateError') {
                        console.error('SourceBufferçŠ¶æ€æ— æ•ˆï¼Œå¯èƒ½å·²å…³é—­ï¼Œé‡æ–°åˆå§‹åŒ–MediaSource');
                        // å°†æ•°æ®é‡æ–°æ”¾å›é˜Ÿåˆ—
                        this.socketMediaQueue.unshift(mediaData);
                        this.initMediaSource();
                    } else if (error.name === 'TypeError') {
                        console.error('åª’ä½“æ•°æ®ç±»å‹é”™è¯¯ï¼Œè·³è¿‡è¯¥æ•°æ®');
                        // ç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªæ•°æ®
                        this.processMediaQueue();
                    } else {
                        console.error('æœªçŸ¥é”™è¯¯ï¼Œé‡æ–°åˆå§‹åŒ–MediaSource');
                        // å°†æ•°æ®é‡æ–°æ”¾å›é˜Ÿåˆ—
                        this.socketMediaQueue.unshift(mediaData);
                        this.initMediaSource();
                    }
                }
            }
            
            // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡å’Œåˆ†æå™¨
            initAudioContext() {
                if (this.audioContext) return;
                
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = this.audioContext.createAnalyser();
                    this.analyser.fftSize = 256;
                    
                    // åˆ›å»ºå¢ç›ŠèŠ‚ç‚¹ï¼Œç”¨äºæ§åˆ¶éŸ³é‡
                    this.audioGainNode = this.audioContext.createGain();
                    this.audioGainNode.gain.value = 1.0;
                    
                    this.originalVolume = 1.0;
                    this.adjustedVolume = 1.0;
                    
                    console.log('éŸ³é¢‘ä¸Šä¸‹æ–‡å’Œåˆ†æå™¨åˆå§‹åŒ–æˆåŠŸ');
                } catch (error) {
                    console.error('åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡å¤±è´¥:', error);
                }
            }
            
            // å¼€å§‹ç›‘æµ‹éŸ³é¢‘éŸ³é‡
            startMonitoringAudio() {
                if (!this.localStream || this.isMonitoringAudio) return;
                
                this.initAudioContext();
                
                try {
                    const audioTracks = this.localStream.getAudioTracks();
                    if (audioTracks.length === 0) return;
                    
                    // åˆ›å»ºåª’ä½“æµæº
                    const source = this.audioContext.createMediaStreamSource(this.localStream);
                    
                    // è¿æ¥éŸ³é¢‘å¤„ç†é“¾
                    source.connect(this.audioGainNode);
                    this.audioGainNode.connect(this.analyser);
                    this.analyser.connect(this.audioContext.destination);
                    
                    const bufferLength = this.analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);
                    
                    const updateAudioLevel = () => {
                        if (!this.isMonitoringAudio) return;
                        
                        // è·å–éŸ³é¢‘æ•°æ®
                        this.analyser.getByteFrequencyData(dataArray);
                        
                        // è®¡ç®—å¹³å‡éŸ³é‡
                        let sum = 0;
                        for (let i = 0; i < bufferLength; i++) {
                            sum += dataArray[i];
                        }
                        this.audioLevel = sum / bufferLength;
                        
                        // å¦‚æœæ­£åœ¨å…±äº«å±å¹•ï¼Œè‡ªåŠ¨è°ƒæ•´éŸ³é‡
                        if (this.isSharingScreen) {
                            this.adjustVolumeAutomatically();
                        } else {
                            // æ¢å¤åŸå§‹éŸ³é‡
                            this.restoreVolume();
                        }
                        
                        requestAnimationFrame(updateAudioLevel);
                    };
                    
                    this.isMonitoringAudio = true;
                    updateAudioLevel();
                    console.log('éŸ³é¢‘ç›‘æµ‹å·²å¯åŠ¨');
                } catch (error) {
                    console.error('å¯åŠ¨éŸ³é¢‘ç›‘æµ‹å¤±è´¥:', error);
                }
            }
            
            // åœæ­¢ç›‘æµ‹éŸ³é¢‘éŸ³é‡
            stopMonitoringAudio() {
                this.isMonitoringAudio = false;
                this.restoreVolume();
                console.log('éŸ³é¢‘ç›‘æµ‹å·²åœæ­¢');
            }
            
            // è‡ªåŠ¨è°ƒæ•´éŸ³é‡
            adjustVolumeAutomatically() {
                if (!this.audioGainNode) return;
                
                // è®¾ç½®éŸ³é‡è°ƒæ•´é˜ˆå€¼
                const speakingThreshold = 40; // è¯´è¯é˜ˆå€¼
                const quietThreshold = 20; // å®‰é™é˜ˆå€¼
                
                if (this.audioLevel > speakingThreshold) {
                    // æ£€æµ‹åˆ°è¯´è¯ï¼Œé™ä½èƒŒæ™¯éŸ³é‡
                    const volumeReduction = 0.3; // é™ä½30%éŸ³é‡
                    this.adjustedVolume = this.originalVolume * volumeReduction;
                } else if (this.audioLevel < quietThreshold) {
                    // æ²¡æœ‰è¯´è¯ï¼Œæ¢å¤éŸ³é‡
                    this.adjustedVolume = this.originalVolume;
                }
                
                // å¹³æ»‘è¿‡æ¸¡éŸ³é‡
                this.audioGainNode.gain.value = this.adjustedVolume;
            }
            
            // æ¢å¤åŸå§‹éŸ³é‡
            restoreVolume() {
                if (!this.audioGainNode) return;
                
                this.adjustedVolume = this.originalVolume;
                this.audioGainNode.gain.value = this.adjustedVolume;
            }
            
            // åˆå§‹åŒ–åª’ä½“æµ
            initMediaStream() {
                console.log('initMediaStream: isCallInitiator=', this.isCallInitiator, 'currentCallMethod=', this.currentCallMethod, 'isInCall=', this.isInCall);
                
                // å¦‚æœä¸åœ¨é€šè¯ä¸­ï¼Œç›´æ¥è¿”å›ï¼Œé¿å…ç»§ç»­æ‰§è¡Œ
                if (!this.isInCall) {
                    console.log('ä¸åœ¨é€šè¯ä¸­ï¼Œå–æ¶ˆinitMediaStream');
                    return;
                }
                
                // å…ˆè·å–è§†é¢‘è®¾å¤‡åˆ—è¡¨
                this.getVideoDevices();
                
                // å¦‚æœæ˜¯socket.ioæ–¹å¼ï¼Œåˆå§‹åŒ–MediaSource
                if (this.currentCallMethod === 'socket.io') {
                    this.initMediaSource();
                }
                
                // å¦‚æœå·²ç»æœ‰æœ¬åœ°åª’ä½“æµï¼Œç›´æ¥ä½¿ç”¨
                if (this.localStream) {
                    if (this.currentCallMethod === 'webrtc') {
                        // WebRTCæ–¹å¼ï¼šåˆ›å»ºpeer connection
                        this.createPeerConnection();
                        
                        // å¦‚æœæ˜¯å‘èµ·æ–¹ï¼Œåˆ›å»ºå¹¶å‘é€offer
                        if (this.isCallInitiator) {
                            console.log('å‘èµ·æ–¹ï¼šåˆ›å»ºå¹¶å‘é€offer');
                            this.createAndSendOffer();
                        } else {
                            // ä½œä¸ºæ¥æ”¶æ–¹ï¼Œå¦‚æœæœ‰pendingOfferï¼Œç«‹å³å¤„ç†
                            if (this.pendingOffer) {
                                console.log('æ¥æ”¶æ–¹ï¼šå¤„ç†pendingOffer');
                                // å¤„ç†ä¹‹å‰ä¿å­˜çš„offer
                                this.handleWebRTCMedia({ 
                                    type: 'offer', 
                                    data: this.pendingOffer 
                                });
                                this.pendingOffer = null;
                            } else {
                                console.log('æ¥æ”¶æ–¹ï¼šç­‰å¾…offer...');
                                // å³ä½¿æ²¡æœ‰pendingOfferï¼Œä¹Ÿè¦ç¡®ä¿peerConnectionå·²åˆ›å»ºï¼Œä»¥ä¾¿æ¥æ”¶åç»­çš„offer
                                if (!this.peerConnection) {
                                    this.createPeerConnection();
                                }
                            }
                        }
                    } else {
                        // Socket.ioæ–¹å¼ï¼šå¼€å§‹å‘é€åª’ä½“æµ
                        this.startSocketMediaStream();
                    }
                    return;
                }
                
                // æ²¡æœ‰æœ¬åœ°åª’ä½“æµï¼Œè·å–åª’ä½“æµ
                const constraints = {
                    audio: true,
                    video: this.currentCallType === 'video' ? {
                        facingMode: this.currentFacingMode
                    } : false
                };
                
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(stream => {
                        // æ£€æŸ¥æ˜¯å¦ä»åœ¨é€šè¯ä¸­ï¼Œé¿å…åœ¨é€šè¯ç»“æŸåè®¾ç½®localStream
                        if (!this.isInCall) {
                            console.log('é€šè¯å·²ç»“æŸï¼Œåœæ­¢æ–°è·å–çš„åª’ä½“æµ');
                            stream.getTracks().forEach(track => track.stop());
                            return;
                        }
                        
                        console.log('è·å–åª’ä½“æµæˆåŠŸï¼Œè½¨é“:', stream.getTracks().map(track => track.kind));
                        this.localStream = stream;
                        // æ˜¾ç¤ºæœ¬åœ°è§†é¢‘æµ
                        this.showLocalStream(stream);
                        
                        if (this.currentCallMethod === 'webrtc') {
                            // WebRTCæ–¹å¼ï¼šåˆ›å»ºpeer connection
                            this.createPeerConnection();
                            
                            // å¦‚æœæ˜¯å‘èµ·æ–¹ï¼Œåˆ›å»ºå¹¶å‘é€offer
                            if (this.isCallInitiator) {
                                console.log('å‘èµ·æ–¹ï¼šåˆ›å»ºå¹¶å‘é€offer');
                                this.createAndSendOffer();
                            } else {
                                // ä½œä¸ºæ¥æ”¶æ–¹ï¼Œå¦‚æœæœ‰pendingOfferï¼Œç«‹å³å¤„ç†
                                if (this.pendingOffer) {
                                    console.log('æ¥æ”¶æ–¹ï¼šå¤„ç†pendingOffer');
                                    // å¤„ç†ä¹‹å‰ä¿å­˜çš„offer
                                    this.handleWebRTCMedia({ 
                                        type: 'offer', 
                                        data: this.pendingOffer 
                                    });
                                    this.pendingOffer = null;
                                } else {
                                    console.log('æ¥æ”¶æ–¹ï¼šç­‰å¾…offer...');
                                    // å³ä½¿æ²¡æœ‰pendingOfferï¼Œä¹Ÿè¦ç¡®ä¿peerConnectionå·²åˆ›å»ºï¼Œä»¥ä¾¿æ¥æ”¶åç»­çš„offer
                                    if (!this.peerConnection) {
                                        this.createPeerConnection();
                                    }
                                }
                            }
                        } else {
                            // Socket.ioæ–¹å¼ï¼šå¼€å§‹å‘é€åª’ä½“æµ
                            this.startSocketMediaStream();
                        }
                    })
                    .catch(error => {
                        console.error('è·å–åª’ä½“æµå¤±è´¥:', error);
                        // åªæœ‰åœ¨é€šè¯ä¸­æ‰æ˜¾ç¤ºé”™è¯¯å’Œç»“æŸé€šè¯
                        if (this.isInCall) {
                            alert('è·å–åª’ä½“æµå¤±è´¥: ' + error.message);
                            this.endCall();
                        }
                    });
            }
            
            // åˆ‡æ¢æ‘„åƒå¤´
            async switchCamera() {
                if (!this.localStream || this.isSharingScreen) {
                    console.error('æœ¬åœ°åª’ä½“æµä¸å­˜åœ¨æˆ–æ­£åœ¨å…±äº«å±å¹•ï¼Œæ— æ³•åˆ‡æ¢æ‘„åƒå¤´');
                    return;
                }
                
                try {
                    // åˆ‡æ¢æ‘„åƒå¤´æ–¹å‘
                    this.currentFacingMode = this.currentFacingMode === 'user' ? 'environment' : 'user';
                    console.log('åˆ‡æ¢æ‘„åƒå¤´æ–¹å‘:', this.currentFacingMode);
                    
                    // è·å–å½“å‰è§†é¢‘è½¨é“
                    const videoTracks = this.localStream.getVideoTracks();
                    if (videoTracks.length === 0) {
                        console.error('æ²¡æœ‰è§†é¢‘è½¨é“ï¼Œæ— æ³•åˆ‡æ¢æ‘„åƒå¤´');
                        return;
                    }
                    
                    // åœæ­¢å½“å‰è§†é¢‘è½¨é“
                    videoTracks.forEach(track => track.stop());
                    
                    // è·å–æ–°çš„åª’ä½“æµ
                    const constraints = {
                        audio: true,
                        video: this.currentCallType === 'video' ? {
                            facingMode: this.currentFacingMode
                        } : false
                    };
                    
                    const newStream = await navigator.mediaDevices.getUserMedia(constraints);
                    this.localStream = newStream;
                    
                    // æ›´æ–°æœ¬åœ°è§†é¢‘æ˜¾ç¤º
                    this.showLocalStream(newStream);
                    
                    // å¦‚æœå·²ç»åˆ›å»ºäº†peerConnectionï¼Œæ›´æ–°è§†é¢‘è½¨é“
                    if (this.peerConnection) {
                        const senders = this.peerConnection.getSenders();
                        const videoSender = senders.find(sender => sender.track && sender.track.kind === 'video');
                        if (videoSender) {
                            const newVideoTrack = newStream.getVideoTracks()[0];
                            if (newVideoTrack) {
                                videoSender.replaceTrack(newVideoTrack);
                                console.log('å·²æ›´æ–°peerConnectionä¸­çš„è§†é¢‘è½¨é“');
                            }
                        }
                    }
                } catch (error) {
                    console.error('åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥:', error);
                    alert('åˆ‡æ¢æ‘„åƒå¤´å¤±è´¥: ' + error.message);
                }
            }
            
            // å¼€å§‹å…±äº«å±å¹•
            async startScreenSharing() {
                if (!this.isInCall || this.isSharingScreen) {
                    console.error('ä¸åœ¨é€šè¯ä¸­æˆ–å·²ç»åœ¨å…±äº«å±å¹•ï¼Œæ— æ³•å¼€å§‹å…±äº«å±å¹•');
                    return;
                }
                
                // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒgetDisplayMedia API
                if (!navigator.mediaDevices) {
                    console.error('æµè§ˆå™¨ä¸æ”¯æŒåª’ä½“è®¾å¤‡è®¿é—®');
                    alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåª’ä½“è®¾å¤‡è®¿é—®ï¼Œè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨');
                    return;
                }
                
                if (!navigator.mediaDevices.getDisplayMedia) {
                    console.error('æµè§ˆå™¨ä¸æ”¯æŒå±å¹•å…±äº«åŠŸèƒ½');
                    // æä¾›æ›´å‹å¥½çš„é”™è¯¯æç¤ºï¼Œæ ¹æ®æµè§ˆå™¨ç±»å‹ç»™å‡ºå»ºè®®
                    let browserName = 'æ‚¨çš„æµè§ˆå™¨';
                    if (navigator.userAgent.indexOf('Safari') !== -1 && navigator.userAgent.indexOf('Chrome') === -1) {
                        browserName = 'Safariæµè§ˆå™¨';
                        alert(`${browserName}ä¸æ”¯æŒå±å¹•å…±äº«åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeã€Firefoxæˆ–æ–°ç‰ˆEdgeæµè§ˆå™¨ï¼Œæˆ–æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬çš„${browserName}`);
                    } else {
                        alert(`${browserName}ä¸æ”¯æŒå±å¹•å…±äº«åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeã€Firefoxæˆ–æ–°ç‰ˆEdgeæµè§ˆå™¨`);
                    }
                    return;
                }
                
                try {
                    console.log('å¼€å§‹å…±äº«å±å¹•...');
                    
                    // è·å–å±å¹•å…±äº«æµï¼ŒåŒæ—¶å…±äº«ç³»ç»ŸéŸ³é¢‘
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: {
                            cursor: 'always' // å§‹ç»ˆæ˜¾ç¤ºå…‰æ ‡
                        },
                        audio: true // å…±äº«ç³»ç»ŸéŸ³é¢‘
                    });
                    
                    // æ£€æŸ¥æ˜¯å¦ä»åœ¨é€šè¯ä¸­
                    if (!this.isInCall) {
                        console.log('é€šè¯å·²ç»“æŸï¼Œåœæ­¢å±å¹•å…±äº«æµ');
                        screenStream.getTracks().forEach(track => track.stop());
                        return;
                    }
                    
                    // ä¿å­˜å½“å‰çš„éº¦å…‹é£éŸ³é¢‘è½¨é“
                    let microphoneTrack = null;
                    if (this.localStream) {
                        const audioTracks = this.localStream.getAudioTracks();
                        if (audioTracks.length > 0) {
                            microphoneTrack = audioTracks[0];
                        }
                    }
                    
                    // å¦‚æœæ²¡æœ‰éº¦å…‹é£éŸ³é¢‘è½¨é“ï¼Œè·å–æ–°çš„éº¦å…‹é£éŸ³é¢‘è½¨é“
                    if (!microphoneTrack) {
                        try {
                            const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            microphoneTrack = audioStream.getAudioTracks()[0];
                        } catch (audioError) {
                            console.error('è·å–éº¦å…‹é£éŸ³é¢‘è½¨é“å¤±è´¥:', audioError);
                            // ç»§ç»­æ‰§è¡Œï¼Œå³ä½¿æ²¡æœ‰éº¦å…‹é£ä¹Ÿå¯ä»¥å…±äº«å±å¹•
                        }
                    }
                    
                    // åœæ­¢å½“å‰çš„è§†é¢‘è½¨é“
                    if (this.localStream) {
                        const videoTracks = this.localStream.getVideoTracks();
                        videoTracks.forEach(track => track.stop());
                    }
                    
                    // åˆ›å»ºä¸€ä¸ªæ–°çš„åª’ä½“æµï¼ŒåŒ…å«å±å¹•å…±äº«è§†é¢‘å’Œéº¦å…‹é£éŸ³é¢‘
                    const combinedStream = new MediaStream();
                    
                    // æ·»åŠ å±å¹•å…±äº«è§†é¢‘è½¨é“
                    const screenVideoTracks = screenStream.getVideoTracks();
                    screenVideoTracks.forEach(track => combinedStream.addTrack(track));
                    
                    // æ·»åŠ éº¦å…‹é£éŸ³é¢‘è½¨é“
                    if (microphoneTrack) {
                        combinedStream.addTrack(microphoneTrack);
                    } else {
                        // å¦‚æœæ²¡æœ‰éº¦å…‹é£è½¨é“ï¼Œå°è¯•ä½¿ç”¨å±å¹•å…±äº«æµä¸­çš„éŸ³é¢‘è½¨é“
                        const screenAudioTracks = screenStream.getAudioTracks();
                        screenAudioTracks.forEach(track => combinedStream.addTrack(track));
                    }
                    
                    // æ›´æ–°æœ¬åœ°æµ
                    this.localStream = combinedStream;
                    this.isSharingScreen = true;
                    
                    // æ›´æ–°æœ¬åœ°è§†é¢‘æ˜¾ç¤º
                    this.showLocalStream(combinedStream);
                    
                    // ç›‘å¬å±å¹•å…±äº«ç»“æŸäº‹ä»¶
                    screenStream.getVideoTracks()[0].addEventListener('ended', () => {
                        console.log('å±å¹•å…±äº«å·²ç»“æŸï¼Œè‡ªåŠ¨åˆ‡æ¢å›æ‘„åƒå¤´');
                        this.stopScreenSharing();
                    });
                    
                    // å¼€å§‹ç›‘æµ‹éŸ³é¢‘ï¼Œç”¨äºè‡ªåŠ¨è°ƒæ•´éŸ³é‡
                    this.startMonitoringAudio();
                    
                    // å¦‚æœå·²ç»åˆ›å»ºäº†peerConnectionï¼Œæ›´æ–°è§†é¢‘å’ŒéŸ³é¢‘è½¨é“
                    if (this.peerConnection) {
                        const senders = this.peerConnection.getSenders();
                        
                        // æ›´æ–°è§†é¢‘è½¨é“ä¸ºå±å¹•å…±äº«è½¨é“
                        const videoSender = senders.find(sender => sender.track && sender.track.kind === 'video');
                        if (videoSender) {
                            const newVideoTrack = screenStream.getVideoTracks()[0];
                            if (newVideoTrack) {
                                videoSender.replaceTrack(newVideoTrack);
                                console.log('å·²æ›´æ–°peerConnectionä¸­çš„è§†é¢‘è½¨é“ä¸ºå±å¹•å…±äº«è½¨é“');
                            }
                        }
                        
                        // å¤„ç†éŸ³é¢‘è½¨é“ - ç¡®ä¿å§‹ç»ˆä½¿ç”¨éº¦å…‹é£è½¨é“ï¼Œè¿™æ ·å¯¹æ–¹èƒ½å¬åˆ°è¯´è¯å£°éŸ³
                        const audioSender = senders.find(sender => sender.track && sender.track.kind === 'audio');
                        if (audioSender) {
                            if (microphoneTrack) {
                                // ä¼˜å…ˆä½¿ç”¨éº¦å…‹é£è½¨é“ï¼Œç¡®ä¿è¯´è¯å£°éŸ³èƒ½è¢«å¬åˆ°
                                audioSender.replaceTrack(microphoneTrack);
                                console.log('å·²æ›´æ–°peerConnectionä¸­çš„éŸ³é¢‘è½¨é“ä¸ºéº¦å…‹é£è½¨é“');
                            } else {
                                // å¦‚æœæ²¡æœ‰éº¦å…‹é£è½¨é“ï¼Œå°è¯•ä½¿ç”¨å±å¹•å…±äº«æµä¸­çš„éŸ³é¢‘è½¨é“
                                const screenAudioTracks = screenStream.getAudioTracks();
                                if (screenAudioTracks.length > 0) {
                                    audioSender.replaceTrack(screenAudioTracks[0]);
                                    console.log('å·²æ›´æ–°peerConnectionä¸­çš„éŸ³é¢‘è½¨é“ä¸ºå±å¹•å…±äº«æµä¸­çš„éŸ³é¢‘è½¨é“');
                                }
                            }
                        }
                    }
                    
                    console.log('å±å¹•å…±äº«å·²å¼€å§‹ï¼ŒåŒæ—¶å…±äº«ç³»ç»ŸéŸ³é¢‘å’Œéº¦å…‹é£å£°éŸ³');
                } catch (error) {
                    console.error('å¼€å§‹å…±äº«å±å¹•å¤±è´¥:', error);
                    let errorMessage = 'å¼€å§‹å…±äº«å±å¹•å¤±è´¥: ' + error.message;
                    
                    // æ ¹æ®ä¸åŒé”™è¯¯ç±»å‹æä¾›æ›´å‹å¥½çš„é”™è¯¯æç¤º
                    if (error.name === 'NotAllowedError') {
                        errorMessage = 'è¯·å…è®¸æµè§ˆå™¨è®¿é—®å±å¹•å…±äº«æƒé™';
                    } else if (error.name === 'NotFoundError') {
                        errorMessage = 'æœªæ‰¾åˆ°å¯ç”¨çš„å±å¹•å…±äº«æº';
                    } else if (error.name === 'NotReadableError') {
                        errorMessage = 'æ— æ³•è®¿é—®å±å¹•å…±äº«æºï¼Œè¯·æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–åº”ç”¨æ­£åœ¨ä½¿ç”¨';
                    } else if (error.name === 'OverconstrainedError') {
                        errorMessage = 'å±å¹•å…±äº«å‚æ•°ä¸ç¬¦åˆè¦æ±‚';
                    } else if (error.message.includes('is not a function')) {
                        let browserName = 'æ‚¨çš„æµè§ˆå™¨';
                        if (navigator.userAgent.indexOf('Safari') !== -1 && navigator.userAgent.indexOf('Chrome') === -1) {
                            browserName = 'Safariæµè§ˆå™¨';
                            errorMessage = `${browserName}ä¸æ”¯æŒå±å¹•å…±äº«åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeã€Firefoxæˆ–æ–°ç‰ˆEdgeæµè§ˆå™¨ï¼Œæˆ–æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬çš„${browserName}`;
                        } else {
                            errorMessage = 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå±å¹•å…±äº«åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeã€Firefoxæˆ–æ–°ç‰ˆEdgeæµè§ˆå™¨';
                        }
                    } else if (error.name === 'TypeError') {
                        // å¤„ç†ä¸åŒæµè§ˆå™¨çš„TypeError
                        let browserName = 'æ‚¨çš„æµè§ˆå™¨';
                        if (navigator.userAgent.indexOf('Safari') !== -1 && navigator.userAgent.indexOf('Chrome') === -1) {
                            browserName = 'Safariæµè§ˆå™¨';
                            errorMessage = `${browserName}ä¸æ”¯æŒå±å¹•å…±äº«åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeã€Firefoxæˆ–æ–°ç‰ˆEdgeæµè§ˆå™¨ï¼Œæˆ–æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬çš„${browserName}`;
                        } else {
                            errorMessage = 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒå±å¹•å…±äº«åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeã€Firefoxæˆ–æ–°ç‰ˆEdgeæµè§ˆå™¨';
                        }
                    }
                    
                    alert(errorMessage);
                }
            }
            
            // åœæ­¢å…±äº«å±å¹•ï¼Œåˆ‡æ¢å›æ‘„åƒå¤´
            async stopScreenSharing() {
                if (!this.isInCall || !this.isSharingScreen) {
                    console.error('ä¸åœ¨é€šè¯ä¸­æˆ–æ²¡æœ‰åœ¨å…±äº«å±å¹•ï¼Œæ— æ³•åœæ­¢å…±äº«å±å¹•');
                    return;
                }
                
                try {
                    console.log('åœæ­¢å…±äº«å±å¹•ï¼Œåˆ‡æ¢å›æ‘„åƒå¤´...');
                    
                    // åœæ­¢éŸ³é¢‘ç›‘æµ‹
                    this.stopMonitoringAudio();
                    
                    // åœæ­¢å½“å‰çš„å±å¹•å…±äº«æµä¸­çš„æ‰€æœ‰è½¨é“ï¼ˆåŒ…æ‹¬è§†é¢‘å’ŒéŸ³é¢‘è½¨é“ï¼‰
                    if (this.localStream) {
                        this.localStream.getTracks().forEach(track => {
                            track.stop();
                            console.log('å·²åœæ­¢å…±äº«å±å¹•è½¨é“:', track.kind, track.id);
                        });
                    }
                    
                    // è·å–æ–°çš„æ‘„åƒå¤´åª’ä½“æµ
                    const constraints = {
                        audio: true,
                        video: this.currentCallType === 'video' ? {
                            facingMode: this.currentFacingMode
                        } : false
                    };
                    
                    const newStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    // æ£€æŸ¥æ˜¯å¦ä»åœ¨é€šè¯ä¸­
                    if (!this.isInCall) {
                        console.log('é€šè¯å·²ç»“æŸï¼Œåœæ­¢æ–°è·å–çš„åª’ä½“æµ');
                        newStream.getTracks().forEach(track => track.stop());
                        return;
                    }
                    
                    // æ›´æ–°æœ¬åœ°æµ
                    this.localStream = newStream;
                    this.isSharingScreen = false;
                    
                    // æ›´æ–°æœ¬åœ°è§†é¢‘æ˜¾ç¤º
                    this.showLocalStream(newStream);
                    
                    // å¦‚æœå·²ç»åˆ›å»ºäº†peerConnectionï¼Œæ›´æ–°è§†é¢‘å’ŒéŸ³é¢‘è½¨é“
                    if (this.peerConnection) {
                        const senders = this.peerConnection.getSenders();
                        
                        // æ›´æ–°è§†é¢‘è½¨é“ä¸ºæ‘„åƒå¤´è½¨é“
                        const videoSender = senders.find(sender => sender.track && sender.track.kind === 'video');
                        if (videoSender) {
                            const newVideoTrack = newStream.getVideoTracks()[0];
                            if (newVideoTrack) {
                                videoSender.replaceTrack(newVideoTrack);
                                console.log('å·²æ›´æ–°peerConnectionä¸­çš„è§†é¢‘è½¨é“ä¸ºæ‘„åƒå¤´è½¨é“');
                            }
                        }
                        
                        // æ›´æ–°éŸ³é¢‘è½¨é“ä¸ºæ–°çš„éº¦å…‹é£è½¨é“
                        const audioSender = senders.find(sender => sender.track && sender.track.kind === 'audio');
                        if (audioSender) {
                            const newAudioTrack = newStream.getAudioTracks()[0];
                            if (newAudioTrack) {
                                audioSender.replaceTrack(newAudioTrack);
                                console.log('å·²æ›´æ–°peerConnectionä¸­çš„éŸ³é¢‘è½¨é“ä¸ºéº¦å…‹é£è½¨é“');
                            }
                        }
                    }
                    
                    console.log('å±å¹•å…±äº«å·²åœæ­¢ï¼Œå·²åˆ‡æ¢å›æ‘„åƒå¤´');
                } catch (error) {
                    console.error('åœæ­¢å…±äº«å±å¹•å¤±è´¥:', error);
                    alert('åœæ­¢å…±äº«å±å¹•å¤±è´¥: ' + error.message);
                }
            }
            
            // åˆ›å»ºWebRTC PeerConnection
            createPeerConnection() {
                console.log('åˆ›å»ºæ–°çš„PeerConnection');
                this.peerConnection = new RTCPeerConnection(this.iceServers);
                
                // ç«‹å³å°è¯•æ·»åŠ æœ¬åœ°åª’ä½“æµï¼Œå¦‚æœè¿˜æ²¡æœ‰ï¼Œè®¾ç½®å®šæ—¶å™¨é‡è¯•
                this.ensureLocalStreamAdded();
                
                // è®¾ç½®å®šæ—¶å™¨ï¼Œå®šæœŸæ£€æŸ¥å¹¶ç¡®ä¿æœ¬åœ°åª’ä½“æµå·²æ·»åŠ 
                this.streamCheckInterval = setInterval(() => {
                    this.ensureLocalStreamAdded();
                }, 2000);
                
                // ç›‘å¬ICEå€™é€‰
                this.peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        this.socket.emit('call-media', {
                            targetSocketId: this.currentCallTargetSocketId,
                            callId: this.currentCallId,
                            type: 'ice-candidate',
                            data: event.candidate
                        });
                    }
                };
                
                // ç›‘å¬è¿œç¨‹åª’ä½“æµ - è¶…çº§å¢å¼ºç‰ˆontrackäº‹ä»¶å¤„ç†ï¼Œç¡®ä¿æ‹¨é€šæ–¹èƒ½çœ‹åˆ°å¯¹æ–¹
                this.peerConnection.ontrack = (event) => {
                    console.log('æ”¶åˆ°è¿œç¨‹åª’ä½“æµè½¨é“:', event.track.kind, event.track.id, 'æµ:', event.streams.length);
                    
                    // ç«‹å³è·å–è¿œç¨‹è§†é¢‘å…ƒç´ ï¼Œé‡è¯•æœºåˆ¶ç¡®ä¿èƒ½è·å–åˆ°
                    let remoteVideo = document.getElementById('remoteVideo');
                    if (!remoteVideo) {
                        console.error('è¿œç¨‹è§†é¢‘å…ƒç´ ä¸å­˜åœ¨ï¼Œ100msåé‡è¯•');
                        setTimeout(() => {
                            remoteVideo = document.getElementById('remoteVideo');
                            if (remoteVideo) {
                                console.log('é‡è¯•åè·å–åˆ°è¿œç¨‹è§†é¢‘å…ƒç´ ');
                                this.processRemoteTrack(event, remoteVideo);
                            } else {
                                console.error('é‡è¯•åä»æœªè·å–åˆ°è¿œç¨‹è§†é¢‘å…ƒç´ ');
                            }
                        }, 100);
                        return;
                    }
                    
                    // å¤„ç†è¿œç¨‹è½¨é“
                    this.processRemoteTrack(event, remoteVideo);
                };
            }
            
            // ç¡®ä¿æœ¬åœ°åª’ä½“æµå·²æ·»åŠ åˆ°peerConnection
            ensureLocalStreamAdded() {
                // å¦‚æœpeerConnectionä¸å­˜åœ¨ï¼Œç«‹å³æ¸…é™¤å®šæ—¶å™¨å¹¶è¿”å›
                if (!this.peerConnection) {
                    console.log('ensureLocalStreamAdded: peerConnectionä¸å­˜åœ¨ï¼Œæ¸…ç†å®šæ—¶å™¨');
                    if (this.streamCheckInterval) {
                        clearInterval(this.streamCheckInterval);
                        this.streamCheckInterval = null;
                    }
                    return;
                }
                
                if (!this.localStream) {
                    console.log('ensureLocalStreamAdded: æœ¬åœ°åª’ä½“æµä¸å­˜åœ¨ï¼Œç­‰å¾…è·å–');
                    return;
                }
                
                console.log('ç¡®ä¿æœ¬åœ°åª’ä½“æµå·²æ·»åŠ åˆ°peerConnection');
                
                // è·å–æ‰€æœ‰æœ¬åœ°è½¨é“
                const localTracks = this.localStream.getTracks();
                console.log('æœ¬åœ°åª’ä½“æµè½¨é“:', localTracks.map(track => track.kind));
                
                // è·å–å·²æ·»åŠ åˆ°peerConnectionçš„è½¨é“ID
                const addedTrackIds = this.peerConnection.getSenders()
                    .map(sender => sender.track)
                    .filter(track => track)
                    .map(track => track.id);
                console.log('å·²æ·»åŠ åˆ°peerConnectionçš„è½¨é“ID:', addedTrackIds);
                
                // æ·»åŠ æœªæ·»åŠ çš„è½¨é“
                localTracks.forEach(track => {
                    if (!addedTrackIds.includes(track.id)) {
                        console.log('æ·»åŠ æœ¬åœ°è½¨é“åˆ°peerConnection:', track.kind, track.id);
                        this.peerConnection.addTrack(track, this.localStream);
                    } else {
                        console.log('è½¨é“å·²å­˜åœ¨äºpeerConnectionä¸­ï¼Œè·³è¿‡:', track.kind, track.id);
                    }
                });
            }
            
            // åˆ›å»ºå¹¶å‘é€offer
            createAndSendOffer() {
                if (!this.peerConnection) {
                    console.error('peerConnectionæœªåˆ›å»º');
                    return;
                }
                
                this.peerConnection.createOffer()
                    .then(offer => {
                        return this.peerConnection.setLocalDescription(offer);
                    })
                    .then(() => {
                        this.socket.emit('call-media', {
                            targetSocketId: this.currentCallTargetSocketId,
                            callId: this.currentCallId,
                            type: 'offer',
                            data: this.peerConnection.localDescription
                        });
                    })
                    .catch(error => {
                        console.error('åˆ›å»ºofferå¤±è´¥:', error);
                        this.endCall();
                    });
            }
            
            // å¼€å§‹Socket.ioåª’ä½“æµ
            startSocketMediaStream() {
                if (!this.localStream) {
                    console.error('startSocketMediaStream: æœ¬åœ°åª’ä½“æµä¸å­˜åœ¨');
                    return;
                }
                
                // å¦‚æœå·²æœ‰è¿è¡Œä¸­çš„MediaRecorderï¼Œå…ˆåœæ­¢
                if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
                    try {
                        this.mediaRecorder.stop();
                    } catch (e) {
                        console.error('åœæ­¢æ—§MediaRecorderæ—¶å‡ºé”™:', e);
                    }
                }
                
                // æ£€æµ‹æµè§ˆå™¨æ”¯æŒçš„mimeType
                const supportedMimeTypes = [
                    'video/webm; codecs=vp8,opus',
                    'video/webm',
                    'video/mp4; codecs=h264,aac',
                    'video/mp4'
                ];
                
                let selectedMimeType = 'video/webm; codecs=vp8,opus';
                for (const mimeType of supportedMimeTypes) {
                    if (MediaRecorder.isTypeSupported(mimeType)) {
                        selectedMimeType = mimeType;
                        console.log('ä½¿ç”¨æ”¯æŒçš„mimeType:', mimeType);
                        break;
                    }
                }
                
                // ä½¿ç”¨Socket.ioå‘é€åª’ä½“æµæ•°æ®ï¼Œæ”¹è¿›é…ç½®
                const mediaRecorder = new MediaRecorder(this.localStream, {
                    mimeType: selectedMimeType,
                    videoBitsPerSecond: 800000, // 800Kbpsï¼Œå¹³è¡¡è´¨é‡å’Œå¸¦å®½
                    audioBitsPerSecond: 64000, // 64Kbpsï¼Œä¼˜åŒ–éŸ³é¢‘è´¨é‡
                    bitsPerSecond: 864000 // æ€»æ¯”ç‰¹ç‡
                });
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0 && this.isInCall) {
                        // æ£€æŸ¥socketè¿æ¥çŠ¶æ€
                        if (this.socket && this.socket.connected) {
                            // å‘é€åª’ä½“æ•°æ®
                            this.socket.emit('call-media', {
                                targetSocketId: this.currentCallTargetSocketId,
                                callId: this.currentCallId,
                                type: 'media-data',
                                data: event.data
                            });
                        }
                    }
                };
                
                mediaRecorder.onerror = (event) => {
                    console.error('MediaRecorderé”™è¯¯:', event.error);
                    // å°è¯•é‡æ–°å¯åŠ¨MediaRecorder
                    setTimeout(() => {
                        if (this.isInCall) {
                            this.startSocketMediaStream();
                        }
                    }, 1000);
                };
                
                mediaRecorder.onstop = () => {
                    console.log('MediaRecorderå·²åœæ­¢');
                    // å¦‚æœé€šè¯ä»åœ¨è¿›è¡Œä¸­ï¼Œå°è¯•é‡æ–°å¯åŠ¨
                    if (this.isInCall) {
                        setTimeout(() => {
                            this.startSocketMediaStream();
                        }, 500);
                    }
                };
                
                try {
                    mediaRecorder.start(250); // æ¯250mså‘é€ä¸€æ¬¡æ•°æ®ï¼Œå¹³è¡¡å»¶è¿Ÿå’Œå¸¦å®½
                    this.mediaRecorder = mediaRecorder;
                    console.log('MediaRecorderå·²å¯åŠ¨ï¼ŒçŠ¶æ€:', mediaRecorder.state);
                } catch (error) {
                    console.error('å¯åŠ¨MediaRecorderå¤±è´¥:', error);
                    // 1ç§’åé‡è¯•
                    setTimeout(() => {
                        if (this.isInCall) {
                            this.startSocketMediaStream();
                        }
                    }, 1000);
                }
            }
            
            // å¤„ç†åª’ä½“æµæ•°æ®
            handleCallMedia(data) {
                if (this.currentCallMethod === 'webrtc') {
                    // WebRTCæ–¹å¼å¤„ç†åª’ä½“æ•°æ®
                    this.handleWebRTCMedia(data);
                } else {
                    // Socket.ioæ–¹å¼å¤„ç†åª’ä½“æ•°æ®
                    this.handleSocketMedia(data);
                }
            }
            
            // å¤„ç†WebRTCåª’ä½“æ•°æ®
            handleWebRTCMedia(data) {
                console.log('æ”¶åˆ°WebRTCåª’ä½“æ•°æ®:', data.type, 'isInCall:', this.isInCall, 'peerConnection:', !!this.peerConnection);
                
                // ç¡®ä¿peerConnectionå·²åˆ›å»ºï¼Œæ— è®ºæ˜¯å¦åœ¨é€šè¯ä¸­çŠ¶æ€
                if (!this.peerConnection) {
                    console.log('peerConnectionä¸å­˜åœ¨ï¼Œç«‹å³åˆ›å»ºpeerConnection');
                    this.createPeerConnection();
                }
                
                // ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœä¸æ˜¯é€šè¯ä¸­çŠ¶æ€ï¼Œä½†æ”¶åˆ°äº†offerï¼Œä¿å­˜åˆ°pendingOfferä¸­
                if (!this.isInCall) {
                    if (data.type === 'offer') {
                        console.log('æœªåœ¨é€šè¯ä¸­ï¼Œä¿å­˜offeråˆ°pendingOffer');
                        this.pendingOffer = data.data;
                        return;
                    } else if (data.type === 'ice-candidate') {
                        // å³ä½¿æœªåœ¨é€šè¯ä¸­ï¼Œä¹Ÿæš‚å­˜ICEå€™é€‰
                        if (!this.pendingIceCandidates) {
                            this.pendingIceCandidates = [];
                        }
                        this.pendingIceCandidates.push(data.data);
                        console.log('ICEå€™é€‰æš‚å­˜ï¼Œå½“å‰æš‚å­˜æ•°é‡:', this.pendingIceCandidates.length);
                        return;
                    } else {
                        console.log('æœªåœ¨é€šè¯ä¸­ï¼Œå¿½ç•¥åª’ä½“æ•°æ®:', data.type);
                        return;
                    }
                }
                
                // å¤„ç†ICEå€™é€‰ï¼šæ”¹è¿›ICEå€™é€‰å¤„ç†é€»è¾‘ï¼Œç¡®ä¿æ‰€æœ‰å€™é€‰éƒ½èƒ½è¢«æ­£ç¡®å¤„ç†
                if (data.type === 'ice-candidate') {
                    console.log('å¤„ç†ICEå€™é€‰ï¼ŒremoteDescriptionçŠ¶æ€:', this.peerConnection.remoteDescription ? this.peerConnection.remoteDescription.type : 'none');
                    
                    if (!data.data || !data.data.candidate) {
                        console.error('æ— æ•ˆçš„ICEå€™é€‰æ•°æ®:', data.data);
                        return;
                    }
                    
                    try {
                        const candidate = new RTCIceCandidate(data.data);
                        
                        // æ— è®ºremoteDescriptionæ˜¯å¦è®¾ç½®ï¼Œéƒ½å°è¯•æ·»åŠ ICEå€™é€‰
                        if (this.peerConnection.remoteDescription) {
                            console.log('æ·»åŠ ICEå€™é€‰åˆ°peerConnection');
                            this.peerConnection.addIceCandidate(candidate)
                                .then(() => {
                                    console.log('æ·»åŠ ICEå€™é€‰æˆåŠŸ');
                                })
                                .catch(err => {
                                    console.error('æ·»åŠ ICEå€™é€‰å¤±è´¥:', err);
                                    // å¤±è´¥åä¸æ”¾å¼ƒï¼Œç»§ç»­å¤„ç†å…¶ä»–å€™é€‰
                                });
                        } else {
                            // æš‚å­˜ICEå€™é€‰ï¼Œç­‰remoteDescriptionè®¾ç½®åå†å¤„ç†
                            if (!this.pendingIceCandidates) {
                                this.pendingIceCandidates = [];
                            }
                            this.pendingIceCandidates.push(data.data);
                            console.log('ICEå€™é€‰æš‚å­˜ï¼Œç­‰å¾…remoteDescriptionè®¾ç½®ï¼Œå½“å‰æš‚å­˜æ•°é‡:', this.pendingIceCandidates.length);
                        }
                    } catch (error) {
                        console.error('åˆ›å»ºICEå€™é€‰å¯¹è±¡å¤±è´¥:', error);
                    }
                    return;
                }
                
                // ç¡®ä¿åª’ä½“æµå·²åˆ›å»º
                if (!this.localStream) {
                    console.log('æœ¬åœ°åª’ä½“æµä¸å­˜åœ¨ï¼Œæ­£åœ¨è·å–åª’ä½“æµ...');
                    const constraints = {
                        audio: true,
                        video: this.currentCallType === 'video'
                    };
                    
                    navigator.mediaDevices.getUserMedia(constraints)
                        .then(stream => {
                            console.log('è·å–åª’ä½“æµæˆåŠŸ:', stream.getTracks().map(track => track.kind));
                            this.localStream = stream;
                            this.showLocalStream(stream);
                            
                            // ç¡®ä¿peerConnectionå·²åˆ›å»º
                            if (!this.peerConnection) {
                                this.createPeerConnection();
                            } else {
                                // ç¡®ä¿æœ¬åœ°è½¨é“å·²æ·»åŠ åˆ°peerConnection
                                const existingTracks = this.peerConnection.getSenders().map(sender => sender.track.id);
                                stream.getTracks().forEach(track => {
                                    if (!existingTracks.includes(track.id)) {
                                        this.peerConnection.addTrack(track, stream);
                                        console.log('æ·»åŠ æœ¬åœ°è½¨é“åˆ°peerConnection:', track.kind, track.id);
                                    }
                                });
                            }
                            
                            // å†æ¬¡å¤„ç†åª’ä½“æ•°æ®
                            this.handleWebRTCMedia(data);
                        })
                        .catch(error => {
                            console.error('è·å–åª’ä½“æµå¤±è´¥:', error);
                            alert('è·å–åª’ä½“æµå¤±è´¥: ' + error.message);
                            this.endCall();
                        });
                    return;
                }
                
                // ç¡®ä¿æœ¬åœ°åª’ä½“æµå·²æ·»åŠ åˆ°peerConnection
                const existingTracks = this.peerConnection.getSenders().map(sender => sender.track.id);
                this.localStream.getTracks().forEach(track => {
                    if (!existingTracks.includes(track.id)) {
                        this.peerConnection.addTrack(track, this.localStream);
                        console.log('æ·»åŠ æœ¬åœ°åª’ä½“è½¨é“åˆ°peerConnection:', track.kind, track.id);
                    }
                });
                
                if (data.type === 'offer') {
                    // å¤„ç†offer
                    console.log('å¤„ç†offerï¼ŒremoteDescriptionçŠ¶æ€:', this.peerConnection.remoteDescription ? this.peerConnection.remoteDescription.type : 'none');
                    
                    if (!data.data || !data.data.type || !data.data.sdp) {
                        console.error('æ— æ•ˆçš„offeræ•°æ®:', data.data);
                        return;
                    }
                    
                    // ä¿å­˜offerçš„SDPï¼Œç”¨äºè°ƒè¯•
                    console.log('Offer SDP:', data.data.sdp);
                    
                    // ç«‹å³è®¾ç½®remoteDescriptionï¼Œä¸ç­‰å¾…åª’ä½“æµ
                    this.peerConnection.setRemoteDescription(new RTCSessionDescription(data.data))
                        .then(() => {
                            console.log('è®¾ç½®offerçš„remoteDescriptionæˆåŠŸ');
                            
                            // å¤„ç†æ‰€æœ‰æš‚å­˜çš„ICEå€™é€‰
                            if (this.pendingIceCandidates) {
                                console.log('å¤„ç†æš‚å­˜çš„ICEå€™é€‰ï¼Œæ•°é‡:', this.pendingIceCandidates.length);
                                this.pendingIceCandidates.forEach(candidate => {
                                    this.peerConnection.addIceCandidate(candidate)
                                        .catch(err => console.error('å¤„ç†æš‚å­˜ICEå€™é€‰å¤±è´¥:', err));
                                });
                                this.pendingIceCandidates = null;
                            }
                            
                            console.log('æ­£åœ¨åˆ›å»ºanswer...');
                            // åˆ›å»ºansweræ—¶æŒ‡å®šåª’ä½“çº¦æŸ
                            const answerConstraints = {
                                offerToReceiveAudio: true,
                                offerToReceiveVideo: this.currentCallType === 'video'
                            };
                            return this.peerConnection.createAnswer(answerConstraints);
                        })
                        .then(answer => {
                            console.log('åˆ›å»ºansweræˆåŠŸ:', answer.type);
                            return this.peerConnection.setLocalDescription(answer);
                        })
                        .then(() => {
                            console.log('è®¾ç½®answerçš„localDescriptionæˆåŠŸï¼Œå‘é€answer...');
                            this.socket.emit('call-media', {
                                targetSocketId: this.currentCallTargetSocketId,
                                callId: this.currentCallId,
                                type: 'answer',
                                data: this.peerConnection.localDescription
                            });
                        })
                        .catch(error => {
                            console.error('å¤„ç†offerå¤±è´¥:', error);
                            // ä¸ç«‹å³ç»“æŸé€šè¯ï¼Œåªæ˜¾ç¤ºè­¦å‘Š
                            console.warn('å¤„ç†offerå¤±è´¥ï¼Œä½†ç»§ç»­é€šè¯å°è¯•:', error.message);
                        });
                } else if (data.type === 'answer') {
                    // å¤„ç†answer
                    console.log('å¤„ç†answerï¼ŒremoteDescriptionçŠ¶æ€:', this.peerConnection.remoteDescription ? this.peerConnection.remoteDescription.type : 'none');
                    
                    if (!data.data || !data.data.type || !data.data.sdp) {
                        console.error('æ— æ•ˆçš„answeræ•°æ®:', data.data);
                        return;
                    }
                    
                    // ä¿å­˜answerçš„SDPï¼Œç”¨äºè°ƒè¯•
                    console.log('Answer SDP:', data.data.sdp);
                    
                    this.peerConnection.setRemoteDescription(new RTCSessionDescription(data.data))
                        .then(() => {
                            console.log('è®¾ç½®answerçš„remoteDescriptionæˆåŠŸ');
                            
                            // å¤„ç†æ‰€æœ‰æš‚å­˜çš„ICEå€™é€‰
                            if (this.pendingIceCandidates) {
                                console.log('å¤„ç†æš‚å­˜çš„ICEå€™é€‰ï¼Œæ•°é‡:', this.pendingIceCandidates.length);
                                this.pendingIceCandidates.forEach(candidate => {
                                    this.peerConnection.addIceCandidate(candidate)
                                        .catch(err => console.error('å¤„ç†æš‚å­˜ICEå€™é€‰å¤±è´¥:', err));
                                });
                                this.pendingIceCandidates = null;
                            }
                        })
                        .catch(error => {
                            console.error('å¤„ç†answerå¤±è´¥:', error);
                            // ä¸ç«‹å³ç»“æŸé€šè¯ï¼Œåªæ˜¾ç¤ºè­¦å‘Š
                            console.warn('å¤„ç†answerå¤±è´¥ï¼Œä½†ç»§ç»­é€šè¯å°è¯•:', error.message);
                        });
                }
            }
            
            // å¤„ç†Socket.ioåª’ä½“æ•°æ®
            handleSocketMedia(data) {
                if (data.type === 'media-data') {
                    // æ’­æ”¾åª’ä½“æ•°æ®
                    this.playSocketMedia(data.data);
                }
            }
            
            // æ˜¾ç¤ºæœ¬åœ°è§†é¢‘æµ
            showLocalStream(stream) {
                const localVideo = document.getElementById('localVideo');
                if (localVideo) {
                    localVideo.srcObject = stream;
                    
                    // åº”ç”¨è§†é¢‘é•œåƒè®¾ç½®
                    if (window.userSettings && window.userSettings.mirrorVideo) {
                        localVideo.style.transform = 'scaleX(-1)';
                    } else {
                        localVideo.style.transform = '';
                    }
                    
                    // ç¡®ä¿æœ¬åœ°è§†é¢‘æ’­æ”¾ï¼Œæ·»åŠ ç”¨æˆ·äº¤äº’æ£€æŸ¥
                    localVideo.play().catch(err => {
                        console.log('æœ¬åœ°è§†é¢‘è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œå°†åœ¨ç”¨æˆ·äº¤äº’åæ’­æ”¾:', err.message);
                        // æ·»åŠ ç”¨æˆ·äº¤äº’äº‹ä»¶ç›‘å¬å™¨
                        document.body.addEventListener('click', () => {
                            localVideo.play().catch(err => console.error('æœ¬åœ°è§†é¢‘æ’­æ”¾å¤±è´¥:', err));
                        }, { once: true });
                    });
                }
            }
            
            // å¤„ç†è¿œç¨‹åª’ä½“è½¨é“
            processRemoteTrack(event, remoteVideo) {
                console.log('å¤„ç†è¿œç¨‹åª’ä½“è½¨é“:', event.track.kind, event.track.id);
                
                // æ ¹æ®è®¾ç½®å†³å®šæ˜¯å¦æ˜¾ç¤ºå¯¹æ–¹è§†é¢‘çš„é•œåƒæ•ˆæœ
                if (window.userSettings && window.userSettings.remoteMirrorVideo) {
                    remoteVideo.style.transform = 'scaleX(-1)';
                } else {
                    remoteVideo.style.transform = '';
                }
                
                // ä¼˜å…ˆä½¿ç”¨event.streams[0]ï¼Œè¿™æ˜¯WebRTCæ¨èçš„æ–¹å¼
                if (event.streams && event.streams.length > 0) {
                    const stream = event.streams[0];
                    console.log('ä½¿ç”¨event.streams[0]ä½œä¸ºè¿œç¨‹æµï¼Œè½¨é“æ•°é‡:', stream.getTracks().length);
                    
                    // æ›´æ–°remoteStreamå¼•ç”¨
                    this.remoteStream = stream;
                    
                    // ç›´æ¥è®¾ç½®è§†é¢‘æºï¼Œè¿™æ˜¯æœ€å¯é çš„æ–¹å¼
                    remoteVideo.srcObject = stream;
                    console.log('å·²å°†è¿œç¨‹æµè®¾ç½®ä¸ºè§†é¢‘æº');
                    
                    // ç«‹å³å°è¯•æ’­æ”¾è§†é¢‘
                    this.ensureVideoPlays(remoteVideo);
                    
                    return;
                }
                
                // å¤‡ç”¨æ–¹æ¡ˆï¼šæ‰‹åŠ¨ç®¡ç†åª’ä½“æµå’Œè½¨é“
                if (!this.remoteStream) {
                    this.remoteStream = new MediaStream();
                    console.log('åˆ›å»ºæ–°çš„remoteStream');
                    remoteVideo.srcObject = this.remoteStream;
                }
                
                // æ£€æŸ¥è½¨é“æ˜¯å¦å·²ç»å­˜åœ¨äºè¿œç¨‹æµä¸­ï¼Œé¿å…é‡å¤æ·»åŠ 
                const trackExists = this.remoteStream.getTracks().some(track => track.id === event.track.id);
                if (!trackExists) {
                    // å°†è¿œç¨‹trackæ·»åŠ åˆ°è¿œç¨‹æµä¸­
                    this.remoteStream.addTrack(event.track);
                    console.log('æ·»åŠ è¿œç¨‹è½¨é“åˆ°remoteStream:', event.track.kind, event.track.id);
                    
                    // ç«‹å³å°è¯•æ’­æ”¾è§†é¢‘
                    this.ensureVideoPlays(remoteVideo);
                }
                
                // é¢å¤–çš„ç¨³å®šæ€§æ£€æŸ¥ï¼šç¡®ä¿è¿œç¨‹è§†é¢‘å…ƒç´ çš„srcObjectå§‹ç»ˆæŒ‡å‘æ­£ç¡®çš„remoteStream
                if (remoteVideo.srcObject !== this.remoteStream) {
                    console.log('ä¿®å¤è¿œç¨‹è§†é¢‘æºï¼Œé‡æ–°è®¾ç½®ä¸ºremoteStream');
                    remoteVideo.srcObject = this.remoteStream;
                    this.ensureVideoPlays(remoteVideo);
                }
            }
            
            // ç¡®ä¿è§†é¢‘æ’­æ”¾çš„è¾…åŠ©æ–¹æ³•
            ensureVideoPlays(videoElement) {
                if (!videoElement) return;
                
                // ç¡®ä¿è§†é¢‘æ’­æ”¾ï¼Œæ·»åŠ ç”¨æˆ·äº¤äº’æ£€æŸ¥å’Œé‡è¯•æœºåˆ¶
                const playVideo = () => {
                    videoElement.play()
                        .then(() => {
                            console.log('è§†é¢‘æ’­æ”¾æˆåŠŸ');
                        })
                        .catch(err => {
                            console.log('è§†é¢‘è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œå°†åœ¨ç”¨æˆ·äº¤äº’åæ’­æ”¾:', err.message);
                            // æ·»åŠ ç”¨æˆ·äº¤äº’äº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿åªç›‘å¬ä¸€æ¬¡
                            const handleUserInteraction = () => {
                                videoElement.play().catch(e => console.error('ç”¨æˆ·äº¤äº’åæ’­æ”¾å¤±è´¥:', e));
                                // ç§»é™¤æ‰€æœ‰ç”¨æˆ·äº¤äº’ç›‘å¬å™¨
                                document.removeEventListener('click', handleUserInteraction);
                                document.removeEventListener('touchstart', handleUserInteraction);
                                document.removeEventListener('keydown', handleUserInteraction);
                            };
                            
                            // æ·»åŠ å¤šç§ç”¨æˆ·äº¤äº’äº‹ä»¶ç›‘å¬å™¨
                            document.addEventListener('click', handleUserInteraction, { once: true });
                            document.addEventListener('touchstart', handleUserInteraction, { once: true });
                            document.addEventListener('keydown', handleUserInteraction, { once: true });
                        });
                };
                
                // ç«‹å³å°è¯•æ’­æ”¾
                playVideo();
                
                // 1ç§’åé‡è¯•ä¸€æ¬¡ï¼Œç¡®ä¿è§†é¢‘èƒ½æ’­æ”¾
                setTimeout(() => {
                    if (videoElement.paused) {
                        console.log('è§†é¢‘ä»æœªæ’­æ”¾ï¼Œ1ç§’åé‡è¯•');
                        playVideo();
                    }
                }, 1000);
            }
            
            // æ˜¾ç¤ºè¿œç¨‹è§†é¢‘æµ
            showRemoteStream(stream) {
                const remoteVideo = document.getElementById('remoteVideo');
                if (remoteVideo) {
                    remoteVideo.srcObject = stream;
                    // æ ¹æ®è®¾ç½®å†³å®šæ˜¯å¦æ˜¾ç¤ºå¯¹æ–¹è§†é¢‘çš„é•œåƒæ•ˆæœ
                    if (window.userSettings && window.userSettings.remoteMirrorVideo) {
                        remoteVideo.style.transform = 'scaleX(-1)';
                    } else {
                        remoteVideo.style.transform = '';
                    }
                    // ç¡®ä¿è¿œç¨‹è§†é¢‘æ’­æ”¾
                    this.ensureVideoPlays(remoteVideo);
                }
            }
            
            // æ’­æ”¾Socket.ioåª’ä½“æ•°æ®
            playSocketMedia(data) {
                try {
                    console.log('æ’­æ”¾Socket.ioåª’ä½“æ•°æ®ï¼Œç±»å‹:', this.currentCallType);
                    
                    // ç«‹å³è·å–è¿œç¨‹è§†é¢‘å…ƒç´ ï¼Œé‡è¯•æœºåˆ¶ç¡®ä¿èƒ½è·å–åˆ°
                    let remoteVideo = document.getElementById('remoteVideo');
                    if (!remoteVideo) {
                        console.error('playSocketMedia: è¿œç¨‹è§†é¢‘å…ƒç´ ä¸å­˜åœ¨ï¼Œ100msåé‡è¯•');
                        setTimeout(() => {
                            remoteVideo = document.getElementById('remoteVideo');
                            if (remoteVideo) {
                                this.playSocketMedia(data);
                            }
                        }, 100);
                        return;
                    }
                    
                    if (this.currentCallType === 'video' && this.currentCallMethod === 'socket.io') {
                        // æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§
                        if (!data || typeof data !== 'object') {
                            console.error('æ”¶åˆ°æ— æ•ˆçš„socket.ioè§†é¢‘åª’ä½“æ•°æ®:', data);
                            return;
                        }
                        
                        // å®‰å…¨è·å–æ•°æ®å¤§å°
                        const dataSize = data.size !== undefined ? data.size : 'æœªçŸ¥';
                        console.log('æ”¶åˆ°socket.ioè§†é¢‘åª’ä½“æ•°æ®ï¼Œå¤§å°:', dataSize, 'bytes');
                        
                        // æ£€æŸ¥MediaSourceæ˜¯å¦å·²åˆå§‹åŒ–
                        if (!this.mediaSource || !this.isMediaSourceOpen) {
                            console.log('MediaSourceæœªåˆå§‹åŒ–æˆ–æœªæ‰“å¼€ï¼Œé‡æ–°åˆå§‹åŒ–');
                            this.socketMediaQueue.push(data);
                            this.initMediaSource();
                            return;
                        }
                        
                        // å°†åª’ä½“æ•°æ®æ·»åŠ åˆ°é˜Ÿåˆ—
                        this.socketMediaQueue.push(data);
                        console.log('åª’ä½“æ•°æ®å·²æ·»åŠ åˆ°é˜Ÿåˆ—ï¼Œå½“å‰é˜Ÿåˆ—é•¿åº¦:', this.socketMediaQueue.length);
                        
                        // å°è¯•å¤„ç†åª’ä½“é˜Ÿåˆ—
                        this.processMediaQueue();
                    } else if (this.currentCallType === 'audio' && this.currentCallMethod === 'socket.io') {
                        // æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§
                        if (!data || typeof data !== 'object') {
                            console.error('æ”¶åˆ°æ— æ•ˆçš„socket.ioéŸ³é¢‘åª’ä½“æ•°æ®:', data);
                            return;
                        }
                        
                        // å®‰å…¨è·å–æ•°æ®å¤§å°
                        const dataSize = data.size !== undefined ? data.size : 'æœªçŸ¥';
                        console.log('æ”¶åˆ°socket.ioéŸ³é¢‘åª’ä½“æ•°æ®ï¼Œå¤§å°:', dataSize, 'bytes');
                        
                        // éŸ³é¢‘é€šè¯ï¼Œæ­£ç¡®å¤„ç†ï¼šä½¿ç”¨Blob URLå’ŒAudioå¯¹è±¡æ’­æ”¾
                        try {
                            // åˆ›å»ºBlobå¯¹è±¡
                            const blob = new Blob([data], { type: 'audio/webm; codecs=opus' });
                            // åˆ›å»ºBlob URL
                            const url = URL.createObjectURL(blob);
                            
                            // åˆ›å»ºAudioå¯¹è±¡å¹¶æ’­æ”¾
                            const audio = new Audio();
                            audio.src = url;
                            audio.play().catch(err => {
                                console.error('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', err);
                                // é‡Šæ”¾Blob URL
                                URL.revokeObjectURL(url);
                            });
                            
                            // éŸ³é¢‘æ’­æ”¾ç»“æŸåé‡Šæ”¾Blob URL
                            audio.addEventListener('ended', () => {
                                URL.revokeObjectURL(url);
                            });
                        } catch (audioError) {
                            console.error('å¤„ç†éŸ³é¢‘æ•°æ®å¤±è´¥:', audioError);
                        }
                    } else {
                        console.error('æœªçŸ¥çš„é€šè¯ç±»å‹æˆ–æ–¹å¼');
                    }
                    
                    // ç¡®ä¿è§†é¢‘æ’­æ”¾ï¼Œä½¿ç”¨ä¹‹å‰åˆ›å»ºçš„ensureVideoPlaysæ–¹æ³•
                    this.ensureVideoPlays(remoteVideo);
                    
                    // æ ‡è®°è§†é¢‘æ­£åœ¨æ’­æ”¾ï¼Œé¿å…é‡å¤è°ƒç”¨
                    remoteVideo._socketIoPlaying = true;
                } catch (error) {
                    console.error('æ’­æ”¾Socket.ioåª’ä½“æ•°æ®å¤±è´¥:', error);
                }
            }
            
            // æ¸…ç†åª’ä½“èµ„æº
            cleanupMedia() {
                console.log('å¼€å§‹æ¸…ç†åª’ä½“èµ„æº...');
                
                // æ¸…é™¤å®šæ—¶å™¨
                if (this.streamCheckInterval) {
                    clearInterval(this.streamCheckInterval);
                    this.streamCheckInterval = null;
                    console.log('å·²æ¸…é™¤åª’ä½“æµæ£€æŸ¥å®šæ—¶å™¨');
                }
                
                // æ¸…ç†MediaSourceç›¸å…³èµ„æº
                if (this.mediaSource) {
                    try {
                        // å¦‚æœMediaSourceæ˜¯æ‰“å¼€çŠ¶æ€ï¼Œå°è¯•å…³é—­
                        if (this.mediaSource.readyState === 'open') {
                            this.mediaSource.endOfStream();
                        }
                        this.mediaSource = null;
                        console.log('MediaSourceå·²æ¸…ç†');
                    } catch (e) {
                        console.error('æ¸…ç†MediaSourceæ—¶å‡ºé”™:', e);
                    }
                }
                
                // æ¸…ç†SourceBuffer
                this.sourceBuffer = null;
                this.isMediaSourceOpen = false;
                
                // æ¸…ç©ºåª’ä½“é˜Ÿåˆ—
                this.socketMediaQueue = [];
                console.log('åª’ä½“é˜Ÿåˆ—å·²æ¸…ç©º');
                
                // æ¸…ç†æœ¬åœ°åª’ä½“æµ
                if (this.localStream) {
                    console.log('åœæ­¢æœ¬åœ°åª’ä½“æµè½¨é“:', this.localStream.getTracks().length);
                    this.localStream.getTracks().forEach(track => {
                        track.stop();
                        console.log('å·²åœæ­¢è½¨é“:', track.kind, track.id);
                    });
                    this.localStream = null;
                    console.log('æœ¬åœ°åª’ä½“æµå·²ç½®ç©º');
                }
                
                // æ¸…ç†è¿œç¨‹åª’ä½“æµ
                if (this.remoteStream) {
                    console.log('åœæ­¢è¿œç¨‹åª’ä½“æµè½¨é“:', this.remoteStream.getTracks().length);
                    this.remoteStream.getTracks().forEach(track => {
                        track.stop();
                        console.log('å·²åœæ­¢è¿œç¨‹è½¨é“:', track.kind, track.id);
                    });
                    this.remoteStream = null;
                    console.log('è¿œç¨‹åª’ä½“æµå·²ç½®ç©º');
                }
                
                // æ¸…ç†peerConnection
                if (this.peerConnection) {
                    this.peerConnection.close();
                    this.peerConnection = null;
                    console.log('peerConnectionå·²å…³é—­');
                }
                
                // æ¸…ç†mediaRecorder
                if (this.mediaRecorder) {
                    try {
                        this.mediaRecorder.stop();
                    } catch (e) {
                        console.log('mediaRecorderå·²ç»åœæ­¢ï¼Œå¿½ç•¥stopè°ƒç”¨');
                    }
                    this.mediaRecorder = null;
                    console.log('mediaRecorderå·²æ¸…ç†');
                }
                
                // æ¸…ç†è§†é¢‘å…ƒç´ èµ„æº
                const localVideo = document.getElementById('localVideo');
                if (localVideo) {
                    console.log('æ¸…ç†æœ¬åœ°è§†é¢‘å…ƒç´ èµ„æº');
                    if (localVideo.srcObject) {
                        // æ¸…é™¤srcObjectï¼Œç¡®ä¿ä¸ä¿ç•™å¯¹åª’ä½“æµçš„å¼•ç”¨
                        localVideo.srcObject = null;
                        console.log('æœ¬åœ°è§†é¢‘srcObjectå·²æ¸…é™¤');
                    }
                    if (localVideo.src && localVideo.src.startsWith('blob:')) {
                        // é‡Šæ”¾blob URL
                        URL.revokeObjectURL(localVideo.src);
                        localVideo.src = '';
                        console.log('æœ¬åœ°è§†é¢‘blob URLå·²é‡Šæ”¾');
                    }
                    // åœæ­¢è§†é¢‘æ’­æ”¾
                    localVideo.pause();
                    console.log('æœ¬åœ°è§†é¢‘å·²æš‚åœ');
                }
                
                const remoteVideo = document.getElementById('remoteVideo');
                if (remoteVideo) {
                    console.log('æ¸…ç†è¿œç¨‹è§†é¢‘å…ƒç´ èµ„æº');
                    if (remoteVideo.srcObject) {
                        // æ¸…é™¤srcObjectï¼Œç¡®ä¿ä¸ä¿ç•™å¯¹åª’ä½“æµçš„å¼•ç”¨
                        remoteVideo.srcObject = null;
                        console.log('è¿œç¨‹è§†é¢‘srcObjectå·²æ¸…é™¤');
                    }
                    if (remoteVideo.src && remoteVideo.src.startsWith('blob:')) {
                        // é‡Šæ”¾blob URL
                        URL.revokeObjectURL(remoteVideo.src);
                        remoteVideo.src = '';
                        console.log('è¿œç¨‹è§†é¢‘blob URLå·²é‡Šæ”¾');
                    }
                    // åœæ­¢è§†é¢‘æ’­æ”¾
                    remoteVideo.pause();
                    console.log('è¿œç¨‹è§†é¢‘å·²æš‚åœ');
                }
                
                // æ¸…ç†å…¶ä»–å¯èƒ½çš„åª’ä½“ç›¸å…³çŠ¶æ€
                this.socketMediaBuffer = [];
                console.log('åª’ä½“èµ„æºæ¸…ç†å®Œæˆ');
            }
            

        }
        
        // é€šè¯ç›¸å…³å˜é‡
        let callSystem = null;
        let currentCallType = null;
        
        // å¼€å‘è€…æ—¥å¿—ç®¡ç†å™¨ - å®šä¹‰åœ¨windowå¯¹è±¡ä¸­ï¼Œç¡®ä¿å…¨å±€å¯è®¿é—®
        window.DeveloperLogManager = {
            originalConsole: {
                log: console.log,
                warn: console.warn,
                error: console.error,
                info: console.info,
                debug: console.debug
            },
            
            init() {
                // ä¿å­˜åŸå§‹æ§åˆ¶å°æ–¹æ³•
                this.originalConsole = {
                    log: console.log,
                    warn: console.warn,
                    error: console.error,
                    info: console.info,
                    debug: console.debug
                };
                
                // é‡å®šå‘æ§åˆ¶å°æ–¹æ³•
                this.redirectConsole();
            },
            
            redirectConsole() {
                // é‡å†™æ§åˆ¶å°æ–¹æ³•ï¼Œå°†æ—¥å¿—åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°å’Œç•Œé¢
                const self = this;
                
                ['log', 'warn', 'error', 'info', 'debug'].forEach(method => {
                    console[method] = function(...args) {
                        // è°ƒç”¨åŸå§‹æ–¹æ³•
                        self.originalConsole[method].apply(console, args);
                        
                        // å°†æ—¥å¿—æ·»åŠ åˆ°ç•Œé¢
                        self.addLog(method, ...args);
                    };
                });
            },
            
            addLog(level, ...args) {
                // ç¡®ä¿userSettingså­˜åœ¨
                if (typeof window.userSettings === 'undefined' || !window.userSettings.developerMode) return;
                
                const logElement = document.getElementById('developerLog');
                if (!logElement || logElement.style.display === 'none') return;
                
                // æ ¼å¼åŒ–æ—¥å¿—
                const timestamp = new Date().toLocaleTimeString();
                const message = args.map(arg => {
                    if (typeof arg === 'object') {
                        try {
                            return JSON.stringify(arg, null, 2);
                        } catch (e) {
                            return String(arg);
                        }
                    }
                    return String(arg);
                }).join(' ');
                
                // åˆ›å»ºæ—¥å¿—æ¡ç›®
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `<strong>[${timestamp}] ${level.toUpperCase()}:</strong> ${message}`;
                
                // æ·»åŠ åˆ°æ—¥å¿—åŒºåŸŸ
                logElement.appendChild(logEntry);
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                logElement.scrollTop = logElement.scrollHeight;
                
                // é™åˆ¶æ—¥å¿—æ¡ç›®æ•°é‡ï¼Œæœ€å¤šä¿ç•™100æ¡
                const logEntries = logElement.querySelectorAll('.log-entry');
                if (logEntries.length > 100) {
                    logEntries[0].remove();
                }
            },
            
            showLog() {
                const logElement = document.getElementById('developerLog');
                if (logElement) {
                    logElement.style.display = 'block';
                }
            },
            
            hideLog() {
                const logElement = document.getElementById('developerLog');
                if (logElement) {
                    logElement.style.display = 'none';
                    // æ¸…ç©ºæ—¥å¿—
                    logElement.innerHTML = '';
                }
            },
            
            clearLog() {
                const logElement = document.getElementById('developerLog');
                if (logElement) {
                    logElement.innerHTML = '';
                }
            },
            
            restoreConsole() {
                // æ¢å¤åŸå§‹æ§åˆ¶å°æ–¹æ³•
                Object.assign(console, this.originalConsole);
            }
        };
        
        // åˆå§‹åŒ–æ—¥å¿—ç®¡ç†å™¨
        window.DeveloperLogManager.init();
        
        // ä»…ä¿ç•™å¿…è¦çš„DOMå…ƒç´ å¼•ç”¨
        const callUserModal = document.getElementById('callUserModal');
        const callUserList = document.getElementById('callUserList');
        

        // è¡¨æƒ…æ•°æ®
        const emojiData = {
            smileys: ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜š', 'ğŸ˜™', 'ğŸ¥²', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”', 'ğŸ¤', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜’', 'ğŸ™„', 'ğŸ˜¬', 'ğŸ¤¥', 'ğŸ˜Œ', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ¥´', 'ğŸ˜µ', 'ğŸ¤¯', 'ğŸ¤ ', 'ğŸ¥³', 'ğŸ˜', 'ğŸ¤“', 'ğŸ§', 'ğŸ˜•', 'ğŸ˜Ÿ', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜®', 'ğŸ˜¯', 'ğŸ˜²', 'ğŸ˜³', 'ğŸ¥º', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ˜–', 'ğŸ˜£', 'ğŸ˜', 'ğŸ˜“', 'ğŸ˜©', 'ğŸ˜«', 'ğŸ¥±', 'ğŸ˜¤', 'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ’€', 'â˜ ï¸', 'ğŸ’©', 'ğŸ¤¡', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ‘»', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ¤–', 'ğŸ’‹', 'ğŸ‘„', 'ğŸ‘…', 'ğŸ‘‚', 'ğŸ‘ƒ', 'ğŸ§ ', 'ğŸ«€', 'ğŸ«', 'ğŸ¦·', 'ğŸ¦´', 'ğŸ‘€', 'ğŸ‘ï¸', 'ğŸ‘…', 'ğŸ‘„', 'ğŸ«¶', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'ğŸ‘', 'ğŸ¤', 'ğŸ‘', 'ğŸ‘', 'ğŸ‘Œ', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘‹', 'ğŸ¤š', 'ğŸ–ï¸', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤', 'âœŠ', 'ğŸ‘Š', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'ğŸ’ª', 'ğŸ¦¾', 'ğŸ¦¿', 'ğŸ¦µ', 'ğŸ¦¶', 'ğŸ‘‚', 'ğŸ¦»', 'ğŸ‘ƒ', 'ğŸ§ ', 'ğŸ«€', 'ğŸ«', 'ğŸ¦·', 'ğŸ¦´', 'ğŸ‘€', 'ğŸ‘ï¸', 'ğŸ‘…', 'ğŸ‘„', 'ğŸ’‹', 'ğŸ©¸'],
            animals: ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ½', 'ğŸ¸', 'ğŸµ', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸ’', 'ğŸ”', 'ğŸ§', 'ğŸ¦', 'ğŸ¤', 'ğŸ£', 'ğŸ¥', 'ğŸ¦†', 'ğŸ¦…', 'ğŸ¦‰', 'ğŸ¦‡', 'ğŸº', 'ğŸ—', 'ğŸ´', 'ğŸ¦„', 'ğŸ', 'ğŸ›', 'ğŸ¦‹', 'ğŸŒ', 'ğŸ', 'ğŸœ', 'ğŸ¦Ÿ', 'ğŸ¦—', 'ğŸ•·ï¸', 'ğŸ•¸ï¸', 'ğŸ¦‚', 'ğŸ¢', 'ğŸ', 'ğŸ¦', 'ğŸ¦–', 'ğŸ¦•', 'ğŸ™', 'ğŸ¦‘', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦€', 'ğŸ¡', 'ğŸ ', 'ğŸŸ', 'ğŸ¬', 'ğŸ³', 'ğŸ‹', 'ğŸ¦ˆ', 'ğŸŠ', 'ğŸ…', 'ğŸ†', 'ğŸ¦“', 'ğŸ¦', 'ğŸ¦§', 'ğŸ˜', 'ğŸ¦›', 'ğŸ¦', 'ğŸª', 'ğŸ«', 'ğŸ¦’', 'ğŸ¦˜', 'ğŸƒ', 'ğŸ‚', 'ğŸ„', 'ğŸ', 'ğŸ–', 'ğŸ', 'ğŸ‘', 'ğŸ¦™', 'ğŸ', 'ğŸ¦Œ', 'ğŸ•', 'ğŸ©', 'ğŸ¦®', 'ğŸ•â€ğŸ¦º', 'ğŸˆ', 'ğŸ“', 'ğŸ¦ƒ', 'ğŸ¦š', 'ğŸ¦œ', 'ğŸ¦¢', 'ğŸ¦©', 'ğŸ•Šï¸', 'ğŸ‡', 'ğŸ¦', 'ğŸ¦¨', 'ğŸ¦¡', 'ğŸ¦¦', 'ğŸ¦¥', 'ğŸ', 'ğŸ€', 'ğŸ¿ï¸', 'ğŸ¦”', 'ğŸ¾', 'ğŸ‰', 'ğŸ²', 'ğŸŒµ', 'ğŸ„', 'ğŸŒ²', 'ğŸŒ³', 'ğŸŒ´', 'ğŸŒ±', 'ğŸŒ¿', 'â˜˜ï¸', 'ğŸ€', 'ğŸ', 'ğŸ‹', 'ğŸƒ', 'ğŸ‚', 'ğŸ', 'ğŸ„', 'ğŸŒ¾', 'ğŸ’', 'ğŸŒ·', 'ğŸŒ¹', 'ğŸ¥€', 'ğŸŒº', 'ğŸŒ¸', 'ğŸŒ¼', 'ğŸŒ»', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ›', 'ğŸŒœ', 'ğŸŒš', 'ğŸŒ•', 'ğŸŒ–', 'ğŸŒ—', 'ğŸŒ˜', 'ğŸŒ‘', 'ğŸŒ’', 'ğŸŒ“', 'ğŸŒ”', 'ğŸŒ™', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ', 'ğŸ’«', 'â­', 'ğŸŒŸ', 'âœ¨', 'âš¡', 'ğŸ”¥', 'ğŸ’¥', 'ğŸ’¦', 'ğŸ’¨', 'ğŸŒªï¸', 'ğŸŒˆ', 'â˜€ï¸', 'ğŸŒ¤ï¸', 'â›…', 'ğŸŒ¦ï¸', 'ğŸŒ§ï¸', 'â›ˆï¸', 'ğŸŒ¨ï¸', 'â„ï¸', 'â˜ƒï¸', 'â›„', 'ğŸŒŠ', 'ğŸŒ«ï¸', 'ğŸŒ¬ï¸'],
            food: ['ğŸ', 'ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ‰', 'ğŸ‡', 'ğŸ“', 'ğŸ«', 'ğŸˆ', 'ğŸ’', 'ğŸ‘', 'ğŸ¥­', 'ğŸ', 'ğŸ¥¥', 'ğŸ¥', 'ğŸ…', 'ğŸ†', 'ğŸ¥‘', 'ğŸ¥¦', 'ğŸ¥¬', 'ğŸ¥’', 'ğŸŒ¶ï¸', 'ğŸ«‘', 'ğŸŒ½', 'ğŸ¥•', 'ğŸ«’', 'ğŸ§„', 'ğŸ§…', 'ğŸ¥”', 'ğŸ ', 'ğŸ¥', 'ğŸ¥–', 'ğŸ', 'ğŸ¥¨', 'ğŸ¥¯', 'ğŸ§€', 'ğŸ—', 'ğŸ–', 'ğŸ¥©', 'ğŸ¥“', 'ğŸ”', 'ğŸŸ', 'ğŸ•', 'ğŸŒ­', 'ğŸ¥ª', 'ğŸŒ®', 'ğŸŒ¯', 'ğŸ«”', 'ğŸ¥™', 'ğŸ§†', 'ğŸ¥š', 'ğŸ³', 'ğŸ§ˆ', 'ğŸ¥', 'ğŸ§‡', 'ğŸ¥“', 'ğŸ¥©', 'ğŸ—', 'ğŸ–', 'ğŸ¦´', 'ğŸœ', 'ğŸ', 'ğŸ²', 'ğŸ›', 'ğŸ£', 'ğŸ±', 'ğŸ¥Ÿ', 'ğŸ¦ª', 'ğŸ¤', 'ğŸ™', 'ğŸš', 'ğŸ˜', 'ğŸ¥', 'ğŸ¥ ', 'ğŸ¥®', 'ğŸ¢', 'ğŸ¡', 'ğŸ§', 'ğŸ¨', 'ğŸ¦', 'ğŸ¥§', 'ğŸ§', 'ğŸ°', 'ğŸ‚', 'ğŸ®', 'ğŸ­', 'ğŸ¬', 'ğŸ«', 'ğŸ¿', 'ğŸ©', 'ğŸª', 'ğŸŒ°', 'ğŸ¥œ', 'ğŸ¯', 'ğŸ¥›', 'ğŸ¼', 'ğŸ«–', 'â˜•', 'ğŸµ', 'ğŸ¶', 'ğŸº', 'ğŸ»', 'ğŸ¥‚', 'ğŸ·', 'ğŸ¥ƒ', 'ğŸ«—', 'ğŸ§Š', 'ğŸ¥¤', 'ğŸ§‹', 'ğŸ§ƒ', 'ğŸ§‰', 'ğŸ§Š', 'ğŸ¹', 'ğŸ¸', 'ğŸ¾', 'ğŸ¥„', 'ğŸ´', 'ğŸ½ï¸', 'ğŸ¥£', 'ğŸ¥¡', 'ğŸ¦ª', 'ğŸ£', 'ğŸ¤', 'ğŸ±', 'ğŸ¥Ÿ', 'ğŸ™', 'ğŸš', 'ğŸ˜', 'ğŸ¥', 'ğŸ¥ ', 'ğŸ¥®', 'ğŸ¢', 'ğŸ¡'],
            activities: ['âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ¥', 'ğŸ±', 'ğŸª€', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ‘', 'ğŸ¥', 'ğŸ', 'ğŸªƒ', 'ğŸ¥…', 'â›³', 'ğŸª', 'ğŸ¹', 'ğŸ£', 'ğŸ¤¿', 'ğŸ¥Š', 'ğŸ¥‹', 'ğŸ½', 'ğŸ›¹', 'ğŸ›¼', 'ğŸ›·', 'â›¸ï¸', 'ğŸ¥Œ', 'ğŸ¿', 'â›·ï¸', 'ğŸ‚', 'ğŸª‚', 'ğŸ‹ï¸â€â™‚ï¸', 'ğŸ‹ï¸â€â™€ï¸', 'ğŸ¤¼â€â™‚ï¸', 'ğŸ¤¼â€â™€ï¸', 'ğŸ¤¸â€â™‚ï¸', 'ğŸ¤¸â€â™€ï¸', 'ğŸ¤º', 'ğŸ¤¾â€â™‚ï¸', 'ğŸ¤¾â€â™€ï¸', 'ğŸŒï¸â€â™‚ï¸', 'ğŸŒï¸â€â™€ï¸', 'ğŸ‡', 'ğŸ§˜â€â™‚ï¸', 'ğŸ§˜â€â™€ï¸', 'ğŸš´â€â™‚ï¸', 'ğŸš´â€â™€ï¸', 'ğŸšµâ€â™‚ï¸', 'ğŸšµâ€â™€ï¸', 'ğŸ§—â€â™‚ï¸', 'ğŸ§—â€â™€ï¸', 'ğŸš£â€â™‚ï¸', 'ğŸš£â€â™€ï¸', 'ğŸŠâ€â™‚ï¸', 'ğŸŠâ€â™€ï¸', 'ğŸ„â€â™‚ï¸', 'ğŸ„â€â™€ï¸', 'ğŸ†', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ…', 'ğŸ–ï¸', 'ğŸ¥‹', 'ğŸ—ï¸', 'ğŸµï¸', 'ğŸ«', 'ğŸŸï¸', 'ğŸª', 'ğŸ¤¹â€â™‚ï¸', 'ğŸ¤¹â€â™€ï¸', 'ğŸ­', 'ğŸ©°', 'ğŸ¨', 'ğŸ¬', 'ğŸ¤', 'ğŸ§', 'ğŸ¼', 'ğŸµ', 'ğŸ¶', 'ğŸ¥', 'ğŸª˜', 'ğŸ·', 'ğŸª—', 'ğŸ¸', 'ğŸª•', 'ğŸº', 'ğŸª‡', 'ğŸ¹', 'ğŸ»', 'ğŸ²', 'â™ ï¸', 'â™¥ï¸', 'â™¦ï¸', 'â™£ï¸', 'ğŸƒ', 'ğŸ´', 'ğŸ€„', 'ğŸ¯', 'ğŸ®', 'ğŸ°', 'ğŸ³', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ‘', 'ğŸ¥', 'ğŸ', 'ğŸªƒ'],
            travel: ['ğŸš—', 'ğŸš•', 'ğŸš™', 'ğŸšŒ', 'ğŸš', 'ğŸï¸', 'ğŸš“', 'ğŸš‘', 'ğŸš’', 'ğŸš', 'ğŸšš', 'ğŸš›', 'ğŸšœ', 'ğŸï¸', 'ğŸ›µ', 'ğŸš²', 'ğŸ›´', 'ğŸš', 'ğŸ›£ï¸', 'ğŸ›¤ï¸', 'ğŸ›¢ï¸', 'â›½', 'ğŸš¨', 'ğŸš¥', 'ğŸš¦', 'ğŸ›‘', 'ğŸš§', 'âš“', 'ğŸš¢', 'ğŸ›¥ï¸', 'ğŸ›³ï¸', 'â›´ï¸', 'ğŸš¤', 'ğŸ›©ï¸', 'ğŸ›«', 'ğŸ›¬', 'âœˆï¸', 'ğŸ’º', 'ğŸš', 'ğŸšŸ', 'ğŸš ', 'ğŸš¡', 'ğŸ›°ï¸', 'ğŸš€', 'ğŸ›¸', 'ğŸ—ºï¸', 'ğŸ—¾', 'ğŸ—¿', 'ğŸ—½', 'ğŸ°', 'ğŸ¯', 'ğŸŸï¸', 'ğŸ¡', 'ğŸ¢', 'ğŸ ', 'ğŸ–ï¸', 'ğŸï¸', 'ğŸœï¸', 'ğŸ•ï¸', 'â›º', 'ğŸ ', 'ğŸ¡', 'ğŸ˜ï¸', 'ğŸšï¸', 'ğŸ—ï¸', 'ğŸ­', 'ğŸ¬', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ¨', 'ğŸª', 'ğŸ«', 'ğŸ©', 'ğŸ’’', 'â›ª', 'ğŸ•Œ', 'ğŸ•', 'ğŸ•‹', 'â›©ï¸', 'ğŸ›•', 'ğŸ•‰ï¸', 'â›²', 'ğŸŒ', 'ğŸŒ‰', 'ğŸ™ï¸', 'ğŸŒƒ', 'ğŸŒŒ', 'ğŸ“®', 'ğŸ“ª', 'ğŸ“«', 'ğŸ“¬', 'ğŸ“­', 'ğŸ“¦', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ¨', 'ğŸª', 'ğŸ«', 'ğŸ©', 'ğŸ’’', 'â›ª', 'ğŸ•Œ', 'ğŸ•', 'ğŸ•‹', 'â›©ï¸', 'ğŸ›•'],
            objects: ['ğŸ’¡', 'ğŸ”¦', 'ğŸ®', 'ğŸª”', 'ğŸ•¯ï¸', 'ğŸª™', 'ğŸ’°', 'ğŸ’´', 'ğŸ’µ', 'ğŸ’¶', 'ğŸ’·', 'ğŸ’¸', 'ğŸ’³', 'ğŸ§¾', 'ğŸ’', 'âš–ï¸', 'ğŸ”§', 'ğŸ”¨', 'âš’ï¸', 'ğŸ› ï¸', 'ğŸª“', 'ğŸ”©', 'âš™ï¸', 'ğŸ—œï¸', 'ğŸ§°', 'ğŸ”«', 'ğŸ’£', 'ğŸ§¨', 'ğŸš¬', 'ğŸª¤', 'ğŸ”ª', 'ğŸ—¡ï¸', 'âš”ï¸', 'ğŸ›¡ï¸', 'ğŸšª', 'ğŸš¬', 'ğŸ§¯', 'ğŸª’', 'ğŸ§´', 'ğŸ§·', 'ğŸ§¹', 'ğŸª£', 'ğŸ§º', 'ğŸ§»', 'ğŸš¿', 'ğŸ›', 'ğŸª¤', 'ğŸ§½', 'ğŸ§´', 'ğŸš½', 'ğŸª ', 'ğŸ§´', 'ğŸ§·', 'ğŸ§¹', 'ğŸª£', 'ğŸ§º', 'ğŸ§»', 'ğŸš¿', 'ğŸ›', 'ğŸª¤', 'ğŸ§½', 'ğŸ§´', 'ğŸš½', 'ğŸª ', 'ğŸ“±', 'ğŸ“²', 'ğŸ’»', 'âŒ¨ï¸', 'ğŸ–¥ï¸', 'ğŸ–¨ï¸', 'ğŸ–±ï¸', 'ğŸ–²ï¸', 'ğŸ’½', 'ğŸ’¾', 'ğŸ’¿', 'ğŸ“€', 'ğŸ“¼', 'ğŸ“·', 'ğŸ“¸', 'ğŸ“¹', 'ğŸ¥', 'ğŸ“½ï¸', 'ğŸï¸', 'ğŸ“', 'â˜ï¸', 'ğŸ“Ÿ', 'ğŸ“ ', 'ğŸ“º', 'ğŸ“»', 'ğŸ™ï¸', 'ğŸšï¸', 'ğŸ›ï¸', 'ğŸ§­', 'â°', 'â²ï¸', 'â³', 'âŒ›', 'ğŸ“¡', 'ğŸ”‹', 'ğŸ”Œ', 'ğŸ“š', 'ğŸ“–', 'ğŸ“•', 'ğŸ“—', 'ğŸ“˜', 'ğŸ“™', 'ğŸ““', 'ğŸ“”', 'ğŸ“’', 'ğŸ“ƒ', 'ğŸ“œ', 'ğŸ“„', 'ğŸ“°', 'ğŸ—ï¸', 'ğŸ“‘', 'ğŸ“Š', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ“‹', 'ğŸ“Œ', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'âœ‚ï¸', 'ğŸ–‡ï¸', 'ğŸ“', 'ğŸ—‚ï¸', 'ğŸ—ƒï¸', 'ğŸ—„ï¸', 'ğŸ—‘ï¸', 'ğŸ“', 'ğŸ“‚', 'ğŸ—“ï¸', 'ğŸ“…', 'ğŸ“†', 'ğŸ“‡', 'ğŸ—’ï¸', 'ğŸ—“ï¸', 'ğŸ“', 'âœï¸', 'ğŸ–Šï¸', 'ğŸ–‹ï¸', 'ğŸ“', 'ğŸ“„', 'ğŸ“ƒ', 'ğŸ“œ', 'ğŸ“‹', 'ğŸ“Š', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ“Š', 'ğŸ“‹', 'ğŸ“Œ', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'âœ‚ï¸', 'ğŸ–‡ï¸'],
            flags: ['ğŸ‡¨ğŸ‡³', 'ğŸ‡ºğŸ‡¸', 'ğŸ‡¬ğŸ‡§', 'ğŸ‡¯ğŸ‡µ', 'ğŸ‡°ğŸ‡·', 'ğŸ‡«ğŸ‡·', 'ğŸ‡©ğŸ‡ª', 'ğŸ‡ªğŸ‡¸', 'ğŸ‡·ğŸ‡º', 'ğŸ‡®ğŸ‡³', 'ğŸ‡§ğŸ‡·', 'ğŸ‡¨ğŸ‡¦', 'ğŸ‡¦ğŸ‡º', 'ğŸ‡®ğŸ‡¹', 'ğŸ‡³ğŸ‡±', 'ğŸ‡§ğŸ‡ª', 'ğŸ‡§ğŸ‡¹', 'ğŸ‡§ğŸ‡¬', 'ğŸ‡¨ğŸ‡¿', 'ğŸ‡¨ğŸ‡­', 'ğŸ‡©ğŸ‡°', 'ğŸ‡«ğŸ‡®', 'ğŸ‡¬ğŸ‡·', 'ğŸ‡­ğŸ‡º', 'ğŸ‡®ğŸ‡¸', 'ğŸ‡®ğŸ‡ª', 'ğŸ‡±ğŸ‡¹', 'ğŸ‡±ğŸ‡º', 'ğŸ‡±ğŸ‡»', 'ğŸ‡²ğŸ‡¹', 'ğŸ‡³ğŸ‡´', 'ğŸ‡µğŸ‡±', 'ğŸ‡µğŸ‡¹', 'ğŸ‡·ğŸ‡´', 'ğŸ‡¸ğŸ‡ª', 'ğŸ‡¸ğŸ‡®', 'ğŸ‡¸ğŸ‡°', 'ğŸ‡¹ğŸ‡·', 'ğŸ‡¦ğŸ‡¹', 'ğŸ‡¬ğŸ‡·', 'ğŸ‡®ğŸ‡±', 'ğŸ‡¸ğŸ‡¦', 'ğŸ‡¦ğŸ‡ª', 'ğŸ‡§ğŸ‡­', 'ğŸ‡°ğŸ‡¼', 'ğŸ‡´ğŸ‡²', 'ğŸ‡¶ğŸ‡¦', 'ğŸ‡¸ğŸ‡¬', 'ğŸ‡¹ğŸ‡­', 'ğŸ‡»ğŸ‡³', 'ğŸ‡²ğŸ‡¾', 'ğŸ‡®ğŸ‡©', 'ğŸ‡µğŸ‡­', 'ğŸ‡³ğŸ‡¿', 'ğŸ‡¿ğŸ‡¦', 'ğŸ‡ªğŸ‡¬', 'ğŸ‡²ğŸ‡¦', 'ğŸ‡¦ğŸ‡·', 'ğŸ‡¨ğŸ‡±', 'ğŸ‡¨ğŸ‡´', 'ğŸ‡²ğŸ‡½', 'ğŸ‡µğŸ‡ª', 'ğŸ‡¦ğŸ‡º', 'ğŸ‡³ğŸ‡¿', 'ğŸ‡¹ğŸ‡·', 'ğŸ‡¸ğŸ‡¾', 'ğŸ‡®ğŸ‡·', 'ğŸ‡®ğŸ‡·', 'ğŸ‡²ğŸ‡¦', 'ğŸ‡²ğŸ‡±', 'ğŸ‡¹ğŸ‡¬', 'ğŸ‡³ğŸ‡¬', 'ğŸ‡¿ğŸ‡²', 'ğŸ‡¿ğŸ‡¼', 'ğŸ‡¿ğŸ‡¦', 'ğŸ‡§ğŸ‡¼', 'ğŸ‡³ğŸ‡¦', 'ğŸ‡²ğŸ‡¸', 'ğŸ‡§ğŸ‡¹', 'ğŸ‡³ğŸ‡µ', 'ğŸ‡²ğŸ‡³', 'ğŸ‡²ğŸ‡´', 'ğŸ‡­ğŸ‡°', 'ğŸ‡²ğŸ‡¹', 'ğŸ‡¸ğŸ‡²', 'ğŸ‡»ğŸ‡¦', 'ğŸ‡¨ğŸ‡°', 'ğŸ‡¬ğŸ‡®', 'ğŸ‡¯ğŸ‡ª', 'ğŸ‡¬ğŸ‡¬', 'ğŸ‡®ğŸ‡²', 'ğŸ‡²ğŸ‡¨', 'ğŸ‡¸ğŸ‡§', 'ğŸ‡»ğŸ‡º', 'ğŸ‡«ğŸ‡²', 'ğŸ‡¹ğŸ‡´', 'ğŸ‡µğŸ‡¼', 'ğŸ‡°ğŸ‡®', 'ğŸ‡°ğŸ‡²', 'ğŸ‡¹ğŸ‡°', 'ğŸ‡«ğŸ‡°', 'ğŸ‡³ğŸ‡º', 'ğŸ‡«ğŸ‡´', 'ğŸ‡¸ğŸ‡¹', 'ğŸ‡»ğŸ‡¨', 'ğŸ‡¬ğŸ‡©', 'ğŸ‡²ğŸ‡¸', 'ğŸ‡¦ğŸ‡¬', 'ğŸ‡§ğŸ‡§', 'ğŸ‡§ğŸ‡¸', 'ğŸ‡§ğŸ‡¿', 'ğŸ‡¨ğŸ‡±', 'ğŸ‡¨ğŸ‡´', 'ğŸ‡¨ğŸ‡·', 'ğŸ‡©ğŸ‡´', 'ğŸ‡ªğŸ‡¨', 'ğŸ‡¸ğŸ‡»', 'ğŸ‡¬ğŸ‡¹', 'ğŸ‡­ğŸ‡³', 'ğŸ‡²ğŸ‡½', 'ğŸ‡³ğŸ‡®', 'ğŸ‡µğŸ‡¦', 'ğŸ‡µğŸ‡¾', 'ğŸ‡µğŸ‡ª', 'ğŸ‡¹ğŸ‡¹', 'ğŸ‡»ğŸ‡ª', 'ğŸ‡¦ğŸ‡·', 'ğŸ‡§ğŸ‡´', 'ğŸ‡§ğŸ‡·', 'ğŸ‡¨ğŸ‡±', 'ğŸ‡¨ğŸ‡´', 'ğŸ‡ªğŸ‡¨', 'ğŸ‡«ğŸ‡®', 'ğŸ‡¬ğŸ‡«', 'ğŸ‡¬ğŸ‡¶', 'ğŸ‡¬ğŸ‡¾', 'ğŸ‡­ğŸ‡¹', 'ğŸ‡±ğŸ‡¨', 'ğŸ‡²ğŸ‡¶', 'ğŸ‡²ğŸ‡·', 'ğŸ‡²ğŸ‡º', 'ğŸ‡µğŸ‡²', 'ğŸ‡·ğŸ‡ª', 'ğŸ‡·ğŸ‡º', 'ğŸ‡¸ğŸ‡·', 'ğŸ‡¹ğŸ‡¹', 'ğŸ‡ºğŸ‡¾', 'ğŸ‡»ğŸ‡¨', 'ğŸ‡»ğŸ‡®', 'ğŸ‡»ğŸ‡ª']
        };

        // è¡¨æƒ…ç³»ç»Ÿç›¸å…³å˜é‡
        let currentEmojiCategory = 'smileys';

        // åˆå§‹åŒ–è¡¨æƒ…ç³»ç»Ÿ
        function initEmojiSystem() {
            // åŠ è½½é»˜è®¤è¡¨æƒ…
            loadEmojis(currentEmojiCategory);
            
            // è¡¨æƒ…æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            emojiBtn.addEventListener('click', toggleEmojiPanel);
            
            // è·å–è¡¨æƒ…åˆ†ç±»æŒ‰é’®
            const emojiCategories = document.querySelectorAll('.emoji-category');
            
            // è¡¨æƒ…åˆ†ç±»ç‚¹å‡»äº‹ä»¶
            emojiCategories.forEach(category => {
                category.addEventListener('click', () => {
                    const categoryName = category.dataset.category;
                    switchEmojiCategory(categoryName, emojiCategories);
                });
            });
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­è¡¨æƒ…é¢æ¿
            document.addEventListener('click', (e) => {
                if (!emojiPanel.contains(e.target) && e.target !== emojiBtn) {
                    hideEmojiPanel();
                }
            });
        }

        // åˆ‡æ¢è¡¨æƒ…é¢æ¿æ˜¾ç¤º
        function toggleEmojiPanel() {
            emojiPanel.style.display = emojiPanel.style.display === 'none' || emojiPanel.style.display === '' ? 'flex' : 'none';
        }

        // éšè—è¡¨æƒ…é¢æ¿
        function hideEmojiPanel() {
            emojiPanel.style.display = 'none';
        }

        // åˆ‡æ¢è¡¨æƒ…åˆ†ç±»
        function switchEmojiCategory(categoryName, emojiCategories) {
            currentEmojiCategory = categoryName;
            
            // æ›´æ–°åˆ†ç±»æŒ‰é’®çŠ¶æ€
            emojiCategories.forEach(category => {
                category.classList.remove('active');
            });
            document.querySelector(`[data-category="${categoryName}"]`).classList.add('active');
            
            // åŠ è½½å¯¹åº”åˆ†ç±»çš„è¡¨æƒ…
            loadEmojis(categoryName);
        }

        // åŠ è½½è¡¨æƒ…
        function loadEmojis(categoryName) {
            const emojis = emojiData[categoryName] || [];
            emojiGrid.innerHTML = '';
            
            emojis.forEach(emoji => {
                const emojiBtn = document.createElement('button');
                emojiBtn.className = 'emoji-item';
                emojiBtn.textContent = emoji;
                emojiBtn.addEventListener('click', () => {
                    insertEmoji(emoji);
                });
                emojiGrid.appendChild(emojiBtn);
            });
        }

        // æ’å…¥è¡¨æƒ…åˆ°è¾“å…¥æ¡†
        function insertEmoji(emoji) {
            const cursorPosition = messageInput.selectionStart;
            const textBefore = messageInput.value.substring(0, cursorPosition);
            const textAfter = messageInput.value.substring(cursorPosition);
            messageInput.value = textBefore + emoji + textAfter;
            
            // è®¾ç½®å…‰æ ‡ä½ç½®åˆ°è¡¨æƒ…åé¢
            messageInput.selectionStart = messageInput.selectionEnd = cursorPosition + emoji.length;
            messageInput.focus();
            
            hideEmojiPanel();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initEmojiSystem();
            initSettings();
            
            // æ·»åŠ é€šè¯æŒ‰é’®äº‹ä»¶ç›‘å¬
            videoCallBtn.addEventListener('click', () => {
                openCallUserModal('video');
            });
            
            audioCallBtn.addEventListener('click', () => {
                openCallUserModal('audio');
            });
        });

        // æ‰“å¼€é€‰æ‹©é€šè¯ç”¨æˆ·æ¨¡æ€æ¡†
        function openCallUserModal(callType) {
            // æ£€æŸ¥é€šè¯æƒé™
            if (!userPermissions.allowCall) {
                alert('æ‚¨æ²¡æœ‰é€šè¯æƒé™');
                return;
            }
            
            currentCallType = callType;
            
            // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
            updateCallUserList();
            
            callUserModal.classList.add('active');
        }
        
        // å…³é—­é€‰æ‹©é€šè¯ç”¨æˆ·æ¨¡æ€æ¡†
        function closeCallUserModal() {
            callUserModal.classList.remove('active');
            currentCallType = null;
        }
        
        // æ›´æ–°é€šè¯ç”¨æˆ·åˆ—è¡¨
        function updateCallUserList() {
            callUserList.innerHTML = '';
            
            if (allUsers.length === 0) {
                callUserList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— åœ¨çº¿ç”¨æˆ·</div>';
                return;
            }
            
            // è¿‡æ»¤æ‰è‡ªå·±
            const otherUsers = allUsers.filter(user => user.socketId !== socket.id);
            
            if (otherUsers.length === 0) {
                callUserList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— å…¶ä»–åœ¨çº¿ç”¨æˆ·</div>';
                return;
            }
            
            // æ·»åŠ é€šè¯æ–¹å¼é€‰æ‹©
            const callMethodDiv = document.createElement('div');
            callMethodDiv.style.cssText = 'margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px;';
            callMethodDiv.innerHTML = `
                <h4 style="margin-top: 0;">é€‰æ‹©é€šè¯æ–¹å¼</h4>
                <label style="margin-right: 20px;">
                    <input type="radio" name="callMethod" value="webrtc" checked> WebRTC (æ¨èï¼Œæœ‰æ¦‚ç‡æ— æ³•è·¨ç½‘æ®µ)
                </label>
                <label>
                    <input type="radio" name="callMethod" value="socket.io"> Socket.ioï¼ˆä¸æ¨èï¼Œä¸å¤ªå¯èƒ½èƒ½æ¥é€šï¼‰
                </label>
            `;
            callUserList.appendChild(callMethodDiv);
            
            // æ·»åŠ ç”¨æˆ·åˆ—è¡¨
            const userListTitle = document.createElement('h4');
            userListTitle.textContent = 'é€‰æ‹©é€šè¯å¯¹è±¡';
            userListTitle.style.margin = '15px 0';
            callUserList.appendChild(userListTitle);
            
            otherUsers.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'friend-item';
                userDiv.innerHTML = `
                    <div class="friend-color" style="background: ${user.color}"></div>
                    <div class="friend-info">
                        <div class="friend-name">${escapeHtml(user.username)}</div>
                        <div class="friend-status">${user.status || 'åœ¨çº¿'}</div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="friend-btn" onclick="startCall('video', '${user.socketId}', '${user.username}')">ğŸ“¹</button>
                        <button class="friend-btn" onclick="startCall('audio', '${user.socketId}', '${user.username}')">ğŸ“</button>
                    </div>
                `;
                callUserList.appendChild(userDiv);
            });
        }
        
        // å¼€å§‹é€šè¯å‡½æ•°
        function startCall(callType, socketId, username) {
            // è·å–ç”¨æˆ·é€‰æ‹©çš„é€šè¯æ–¹å¼
            const callMethod = document.querySelector('input[name="callMethod"]:checked').value;
            
            // å…³é—­é€šè¯ç”¨æˆ·åˆ—è¡¨
            closeCallUserModal();
            
            // è°ƒç”¨callSystemçš„startCallæ–¹æ³•ï¼Œä¼ é€’é€šè¯æ–¹å¼
            callSystem.startCall(socketId, callType, callMethod);
            
            // æ˜¾ç¤ºé€šè¯ä¸­æç¤º
            alert(`æ­£åœ¨ä¸ ${username} å‘èµ·${callType === 'video' ? 'è§†é¢‘' : 'è¯­éŸ³'}é€šè¯ï¼Œä½¿ç”¨${callMethod === 'webrtc' ? 'WebRTC' : 'Socket.io'}æ–¹å¼`);
        }
 
        // ä»URLè·¯å¾„è·å–æˆ¿é—´å
        function getRoomFromUrl() {
            const path = window.location.pathname;
            if (path && path !== '/') {
                return path.substring(1); // ç§»é™¤å¼€å¤´çš„æ–œæ 
            }
            return null;
        }

        // å¤„ç†åŠ å…¥æŒ‰é’®ç‚¹å‡»
        joinBtn.addEventListener('click', () => {
            username = usernameInput.value.trim();
            if (username) {
                // ä»URLè·å–æˆ¿é—´åï¼Œé»˜è®¤ä½¿ç”¨'main'
                const roomName = getRoomFromUrl() || 'main';
                
                // å¦‚æœä¸æ˜¯é»˜è®¤æˆ¿é—´ï¼Œæç¤ºç”¨æˆ·è¾“å…¥å¯†ç ï¼ˆå¦‚æœéœ€è¦ï¼‰
                if (roomName !== 'main') {
                    const password = prompt(`è¯·è¾“å…¥æˆ¿é—´ "${roomName}" çš„å¯†ç ï¼ˆç•™ç©ºè¡¨ç¤ºæ— å¯†ç ï¼‰:`);
                    currentRoom = roomName;
                    socket.emit('join', { username, roomName, password: password || null });
                } else {
                    currentRoom = roomName;
                    socket.emit('join', { username, roomName });
                }
            }
        });

        usernameInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                joinBtn.click();
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶ä¸éœ€è¦è®¾ç½®è¾“å…¥æ¡†ï¼Œå› ä¸ºå·²ç»åˆ é™¤äº†æˆ¿é—´åè¾“å…¥æ¡†

        sendBtn.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (message) {
                if (!userPermissions.allowSendMessages) {
                    alert('æ‚¨æ²¡æœ‰å‘é€æ¶ˆæ¯çš„æƒé™');
                    return;
                }
                socket.emit('message', { message, type: 'text' });
                messageInput.value = '';
            }
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendBtn.click();
            }
        });

        imageBtn.addEventListener('click', () => {
            if (userPermissions.allowImage) {
                imageInput.click();
            } else {
                alert('æ‚¨æ²¡æœ‰å‘é€å›¾ç‰‡çš„æƒé™');
            }
        });

        imageInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                if (!userPermissions.allowImage) {
                    alert('æ‚¨æ²¡æœ‰å‘é€å›¾ç‰‡çš„æƒé™');
                    imageInput.value = '';
                    return;
                }
                try {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const arrayBuffer = event.target.result;
                        const response = await fetch('/upload-image', {
                            method: 'POST',
                            body: arrayBuffer,
                            headers: {
                                'Content-Type': file.type
                            }
                        });
                        const data = await response.json();
                        
                        if (data.imageUrl) {
                            socket.emit('message', { message: data.imageUrl, type: 'image' });
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } catch (error) {
                    console.error('ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', error);
                    alert('ä¸Šä¼ å›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
                
                imageInput.value = '';
            }
        });

        audioBtn.addEventListener('click', async () => {
            if (!userPermissions.allowAudio) {
                alert('æ‚¨æ²¡æœ‰å‘é€è¯­éŸ³çš„æƒé™');
                return;
            }
            
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        
                        try {
                            // ç›´æ¥ä½¿ç”¨Blobä¸Šä¼ ï¼Œä¸è½¬æ¢ä¸ºarrayBuffer
                            const response = await fetch('/upload-audio', {
                                method: 'POST',
                                body: audioBlob,
                                headers: {
                                    'Content-Type': 'audio/webm'
                                }
                            });
                            
                            if (!response.ok) {
                                throw new Error(`ç½‘ç»œå“åº”é”™è¯¯: ${response.statusText}`);
                            }
                            
                            const data = await response.json();
                            
                            if (data.audioUrl) {
                                socket.emit('message', { message: data.audioUrl, type: 'audio' });
                            }
                        } catch (error) {
                            console.error('ä¸Šä¼ è¯­éŸ³å¤±è´¥:', error);
                            alert('ä¸Šä¼ è¯­éŸ³å¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                        
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    audioBtn.classList.add('recording');
                    audioBtn.title = 'åœæ­¢å½•åˆ¶';
                } catch (error) {
                    console.error('æ— æ³•è®¿é—®éº¦å…‹é£:', error);
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                audioBtn.classList.remove('recording');
                audioBtn.title = 'å‘é€è¯­éŸ³';
            }
        });

        socket.on('user-joined', (data) => {
            addSystemMessage(`${data.username} åŠ å…¥äº†èŠå¤©å®¤`);
            updateUserList(data.users);
            userCountSpan.textContent = data.userCount;
            
            // æ›´æ–°å½“å‰ç”¨æˆ·çš„æƒé™
            if (data.username === username) {
                const currentUser = data.users.find(u => u.username === username);
                if (currentUser) {
                    userPermissions = currentUser.permissions;
                    // åŠ å…¥æˆ¿é—´æˆåŠŸååˆ‡æ¢åˆ°èŠå¤©ç•Œé¢
                    loginForm.classList.add('hidden');
                    chatForm.classList.remove('hidden');
                    messageInput.focus();
                    
                    // åˆå§‹åŒ–é€šè¯ç³»ç»Ÿ
                    callSystem = new CallSystem(socket, username);
                }
            }
        });
        
        socket.on('user-permissions-changed', (data) => {
            // æ›´æ–°allUsersæ•°ç»„ä¸­çš„æ‰€æœ‰ç”¨æˆ·æƒé™
            data.users.forEach(updatedUser => {
                const existingUser = allUsers.find(u => u.socketId === updatedUser.socketId);
                if (existingUser) {
                    existingUser.permissions = updatedUser.permissions;
                }
            });
            
            // æ›´æ–°å½“å‰ç”¨æˆ·çš„æƒé™
            const currentUser = data.users.find(u => u.socketId === socket.id);
            if (currentUser) {
                userPermissions = currentUser.permissions;
            }
        });
        
        // é€šè¯ç›¸å…³socketäº‹ä»¶å¤„ç†å·²ç§»è‡³CallSystemç±»ä¸­ï¼Œä¸å†ç›´æ¥åœ¨é¡µé¢ä¸­å®šä¹‰
        

        socket.on('permission-denied', (data) => {
            alert(data.message);
        });

        // ç¦è¨€ç›¸å…³äº‹ä»¶å¤„ç†
        socket.on('muted-error', (data) => {
            alert(data.message);
        });

        socket.on('muted', (data) => {
            const durationText = data.duration === -1 ? 'æ°¸ä¹…' : `${data.duration}åˆ†é’Ÿ`;
            alert(`æ‚¨å·²è¢«ç¦è¨€${durationText}ï¼ŒåŸå› ï¼š${data.reason}`);
        });

        socket.on('unmuted', () => {
            alert('æ‚¨å·²è¢«è§£é™¤ç¦è¨€');
        });

        socket.on('message', (data) => {
            addMessage(data);
        });

        socket.on('user-left', (data) => {
            addSystemMessage(`${data.username} ç¦»å¼€äº†èŠå¤©å®¤`);
            updateUserList(data.users);
            userCountSpan.textContent = data.userCount;
        });

        socket.on('user-renamed', (data) => {
            addSystemMessage(`${data.oldName} æ”¹åä¸º ${data.newName}`);
            updateUserList(data.users);
            
            // å¦‚æœå½“å‰ç”¨æˆ·è¢«é‡å‘½åï¼Œæ›´æ–°æœ¬åœ°ç”¨æˆ·å
            if (data.oldName === username) {
                username = data.newName;
            }
        });

        socket.on('system-message', (data) => {
            addSystemMessage(data.message, true);
        });

        socket.on('messages-cleared', () => {
            messagesDiv.innerHTML = '<div class="system-message">æ¶ˆæ¯å·²è¢«ç®¡ç†å‘˜æ¸…ç©º</div>';
        });

        socket.on('kicked', (message) => {
            alert(message);
            location.reload();
        });

        socket.on('message-recalled', (messageId) => {
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (messageDiv) {
                const username = messageDiv.querySelector('.username').textContent;
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <span class="username" style="color: ${messageDiv.querySelector('.username').style.color}">${username}</span>
                        <span class="timestamp">${messageDiv.querySelector('.timestamp').textContent}</span>
                    </div>
                    <div class="message-content">[æ¶ˆæ¯å·²æ’¤å›]</div>
                `;
            }
        });
        
        // æ¶ˆæ¯å·²è¯»é€šçŸ¥ï¼ˆæ™®é€šèŠå¤©ï¼‰
        socket.on('message-read-by-user', (data) => {
            const messageDiv = document.querySelector(`[data-message-id="${data.messageId}"]`);
            if (messageDiv) {
                const readStatusElement = messageDiv.querySelector('.read-status');
                if (readStatusElement) {
                    readStatusElement.textContent = 'âœ“âœ“';
                    readStatusElement.title = 'å·²è¯»';
                }
            }
        });
        
        // æ¶ˆæ¯å·²è¯»é€šçŸ¥ï¼ˆç§èŠï¼‰
        socket.on('private-message-read', (data) => {
            const messageDiv = document.querySelector(`[data-message-id="${data.messageId}"]`);
            if (messageDiv) {
                const readStatusElement = messageDiv.querySelector('.read-status');
                if (readStatusElement) {
                    readStatusElement.textContent = 'âœ“âœ“';
                    readStatusElement.title = 'å·²è¯»';
                }
            }
        });
        
        // å®æ—¶ç¿»è¯‘åŠŸèƒ½
        const supportedLanguages = [
            { code: 'zh-CN', name: 'ä¸­æ–‡' },
            { code: 'en', name: 'English' },
            { code: 'ja', name: 'æ—¥æœ¬èª' },
            { code: 'ko', name: 'í•œêµ­ì–´' },
            { code: 'fr', name: 'FranÃ§ais' },
            { code: 'de', name: 'Deutsch' },
            { code: 'es', name: 'EspaÃ±ol' },
            { code: 'ru', name: 'Ğ ÑƒÑÑĞºĞ¸Ğ¹' }
        ];
        
        let currentTargetLanguage = 'zh'; // é»˜è®¤ç¿»è¯‘ä¸ºä¸­æ–‡ï¼ŒLibreTranslateä½¿ç”¨'zh'è€Œä¸æ˜¯'zh-CN'
        
        // ç®€å•çš„è¯­è¨€æ£€æµ‹å‡½æ•°ï¼ˆåŸºäºå­—ç¬¦é›†å’Œå¸¸è§è¯æ±‡ï¼‰
        function detectLanguage(text) {
            // æ£€æµ‹ä¸­æ–‡
            if (/[\u4e00-\u9fa5]/.test(text)) {
                return 'zh'; // LibreTranslateä½¿ç”¨'zh'è€Œä¸æ˜¯'zh-CN'
            }
            // æ£€æµ‹æ—¥æ–‡
            if (/[\u3040-\u30ff]/.test(text)) {
                return 'ja';
            }
            // æ£€æµ‹éŸ©æ–‡
            if (/[\uac00-\ud7af]/.test(text)) {
                return 'ko';
            }
            // æ£€æµ‹ä¿„æ–‡
            if (/[\u0400-\u04ff]/.test(text)) {
                return 'ru';
            }
            // æ£€æµ‹æ³•æ–‡
            if (/[Ã Ã¢Ã§Ã©Ã¨ÃªÃ«Ã®Ã¯Ã´Ã¹Ã»Ã¼Ã¿Ã±Ã¦Å“]/.test(text)) {
                return 'fr';
            }
            // æ£€æµ‹å¾·æ–‡
            if (/[Ã¤Ã¶Ã¼ÃŸ]/.test(text)) {
                return 'de';
            }
            // æ£€æµ‹è¥¿ç­ç‰™æ–‡
            if (/[Ã¡Ã©Ã­Ã³ÃºÃ¼Ã±]/.test(text)) {
                return 'es';
            }
            // é»˜è®¤è‹±æ–‡
            return 'en';
        }
        
        // ä½¿ç”¨å…è´¹ç¿»è¯‘APIçš„ç¿»è¯‘å‡½æ•°
        async function translateText(text, targetLanguage) {
            // æ£€æµ‹æºè¯­è¨€
            const sourceLanguage = detectLanguage(text);
            
            // å¦‚æœæºè¯­è¨€å’Œç›®æ ‡è¯­è¨€ç›¸åŒï¼Œç›´æ¥è¿”å›åŸæ–‡
            if (sourceLanguage === targetLanguage) {
                return text;
            }
            
            // å®šä¹‰å¤‡é€‰ç¿»è¯‘API
            const translationApis = [
                {
                    name: 'LibreTranslate',
                    url: 'https://libretranslate.de/translate',
                    config: {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            q: text,
                            source: sourceLanguage,
                            target: targetLanguage,
                            format: 'text',
                            api_key: ''
                        })
                    }
                },
                {
                    name: 'Alternative API',
                    url: 'https://api.mymemory.translated.net/get',
                    config: {
                        method: 'GET',
                        params: {
                            q: text,
                            langpair: `${sourceLanguage}|${targetLanguage}`
                        }
                    }
                }
            ];
            
            // å°è¯•ä½¿ç”¨å¤‡é€‰API
            for (const api of translationApis) {
                try {
                    console.log(`å°è¯•ä½¿ç”¨${api.name}ç¿»è¯‘...`);
                    
                    let response;
                    if (api.config.method === 'GET') {
                        // å¤„ç†GETè¯·æ±‚ï¼Œæ„å»ºå¸¦å‚æ•°çš„URL
                        const url = new URL(api.url);
                        Object.entries(api.config.params).forEach(([key, value]) => {
                            url.searchParams.append(key, value);
                        });
                        response = await fetch(url, {
                            method: 'GET'
                        });
                    } else {
                        // POSTè¯·æ±‚
                        response = await fetch(api.url, api.config);
                    }
                    
                    if (!response.ok) {
                        throw new Error(`${api.name}è¯·æ±‚å¤±è´¥`);
                    }
                    
                    let data = await response.json();
                    
                    // å¤„ç†ä¸åŒAPIçš„å“åº”æ ¼å¼
                    let translatedText;
                    if (api.name === 'LibreTranslate') {
                        translatedText = data.translatedText;
                    } else if (api.name === 'Alternative API') {
                        translatedText = data.responseData.translatedText;
                    }
                    
                    if (translatedText) {
                        return translatedText;
                    } else {
                        throw new Error(`${api.name}è¿”å›æ— æ•ˆæ•°æ®`);
                    }
                } catch (error) {
                    console.error(`${api.name}ç¿»è¯‘å¤±è´¥:`, error);
                    // ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ªAPI
                }
            }
            
            // å¦‚æœæ‰€æœ‰APIéƒ½å¤±è´¥ï¼Œè¿”å›åŸæ–‡å¹¶æ·»åŠ å‹å¥½çš„é”™è¯¯æç¤º
            return `[æš‚æ—¶æ— æ³•ç¿»è¯‘ï¼Œè¯·ç¨åé‡è¯•] ${text}`;
        }
        
        // ç¿»è¯‘æ¶ˆæ¯
        async function translateMessage(messageId, targetLanguage = currentTargetLanguage, forceTranslate = false) {
            const messageDiv = document.querySelector(`[data-message-id="${messageId}"]`);
            if (!messageDiv) return;
            
            const contentElement = messageDiv.querySelector('.message-content');
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºè¯­éŸ³æ¶ˆæ¯ï¼ˆå¦‚æœå†…å®¹åŒ…å«audioæ ‡ç­¾ï¼Œåˆ™ä¸ºè¯­éŸ³æ¶ˆæ¯ï¼‰
            if (contentElement.innerHTML.includes('<audio')) {
                return;
            }
            
            let originalText = contentElement.textContent;
            
            // æ£€æŸ¥æ˜¯å¦æ­£åœ¨ç¿»è¯‘
            if (originalText === 'æ­£åœ¨ç¿»è¯‘...') {
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»ç¿»è¯‘è¿‡ï¼Œå¦‚æœå·²ç»ç¿»è¯‘è¿‡åˆ™åˆ‡æ¢å›åŸæ–‡
            if (messageDiv.dataset.originalText) {
                // å¦‚æœå½“å‰æ˜¾ç¤ºçš„æ˜¯ç¿»è¯‘æ–‡æœ¬ï¼Œåˆ™åˆ‡æ¢å›åŸæ–‡
                if (contentElement.textContent !== messageDiv.dataset.originalText) {
                    contentElement.textContent = messageDiv.dataset.originalText;
                    return;
                }
            }
            
            // ä¿å­˜åŸæ–‡åˆ°å…ƒç´ å±æ€§ï¼Œä»¥ä¾¿åç»­æ¢å¤
            if (!messageDiv.dataset.originalText) {
                // æ¸…ç†ç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢ç¿»è¯‘ç»“æœå‡ºç°é—®é¢˜
                messageDiv.dataset.originalText = originalText.replace(/&#10;Bella!/g, '').trim();
            }
            
            // è·å–æ¸…ç†åçš„åŸæ–‡
            originalText = messageDiv.dataset.originalText;
            
            // æ˜¾ç¤ºç¿»è¯‘ä¸­çŠ¶æ€
            contentElement.textContent = 'æ­£åœ¨ç¿»è¯‘...';
            
            try {
                // è°ƒç”¨ç¿»è¯‘å‡½æ•°ï¼Œè‡ªåŠ¨æ£€æµ‹æºè¯­è¨€
                const translatedText = await translateText(originalText, targetLanguage);
                // æ¸…ç†ç¿»è¯‘ç»“æœä¸­çš„ç‰¹æ®Šå­—ç¬¦
                const cleanedText = translatedText.replace(/&#10;Bella!/g, '').trim();
                contentElement.textContent = cleanedText;
            } catch (error) {
                console.error('ç¿»è¯‘å¤±è´¥:', error);
                contentElement.textContent = messageDiv.dataset.originalText;
                // ä¸éœ€è¦æ˜¾ç¤ºè­¦æŠ¥ï¼Œå› ä¸ºè‡ªåŠ¨ç¿»è¯‘å¤±è´¥ä¸åº”æ‰“æ‰°ç”¨æˆ·
            }
        }
        
        // æœç´¢åŠŸèƒ½
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.trim().toLowerCase();
            currentSearchTerm = searchTerm;
            
            let displayUsers = allUsers;
            
            if (searchTerm !== '') {
                displayUsers = allUsers.filter(user => 
                    user.username.toLowerCase().includes(searchTerm)
                );
            }
            
            // ç›´æ¥æ›´æ–°ç”¨æˆ·åˆ—è¡¨æ˜¾ç¤ºï¼Œä¸è°ƒç”¨updateUserListï¼Œé¿å…è¦†ç›–allUsers
            usersListDiv.innerHTML = '';
            
            if (displayUsers.length === 0) {
                usersListDiv.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— åœ¨çº¿ç”¨æˆ·</div>';
                return;
            }
            
            displayUsers.forEach(user => {
                const status = user.status || 'online'; // é»˜è®¤åœ¨çº¿
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item';
                userDiv.onclick = () => {
                    showUserDetail(user.socketId, user.username, user.color, JSON.stringify(user.permissions).replace(/"/g, '&quot;'));
                };
                
                userDiv.innerHTML = `
                    <div class="status-indicator status-${status}"></div>
                    <div class="user-color" style="background: ${user.color}"></div>
                    <div class="user-name">${escapeHtml(user.username)}</div>
                `;
                
                usersListDiv.appendChild(userDiv);
            });
        });
        
        // ç”¨æˆ·åˆ—è¡¨åŠŸèƒ½
        
        // æ‰“å¼€ç”¨æˆ·åˆ—è¡¨
        usersBtn.addEventListener('click', () => {
            usersModal.classList.add('active');
        });
        
        // å…³é—­ç”¨æˆ·åˆ—è¡¨
        function closeUsersModal() {
            usersModal.classList.remove('active');
        }
        
        // å¥½å‹ç³»ç»ŸåŠŸèƒ½
        
        // æ‰“å¼€å¥½å‹åˆ—è¡¨
        friendsBtn.addEventListener('click', () => {
            socket.emit('get-friends');
            friendsModal.classList.add('active');
        });
        
        // å…³é—­å¥½å‹åˆ—è¡¨
        function closeFriendsModal() {
            friendsModal.classList.remove('active');
        }
        
        // å…³é—­ç§èŠæ¨¡æ€æ¡†
        function closePrivateChatModal() {
            privateChatModal.classList.remove('active');
            currentPrivateChatTarget = null;
        }
        
        // å‘é€ç§èŠæ¶ˆæ¯
        privateChatSendBtn.addEventListener('click', () => {
            const message = privateChatInput.value.trim();
            if (message && currentPrivateChatTarget) {
                socket.emit('private-message', {
                    targetSocketId: currentPrivateChatTarget,
                    message: message,
                    type: 'text'
                });
                privateChatInput.value = '';
            }
        });
        
        privateChatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                privateChatSendBtn.click();
            }
        });
        
        // ç§èŠå‘é€å›¾ç‰‡
        privateChatImageBtn.addEventListener('click', () => {
            privateChatImageInput.click();
        });
        
        privateChatImageInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file && currentPrivateChatTarget) {
                if (!userPermissions.allowImage) {
                    alert('æ‚¨æ²¡æœ‰å‘é€å›¾ç‰‡çš„æƒé™');
                    privateChatImageInput.value = '';
                    return;
                }
                try {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const arrayBuffer = event.target.result;
                        const response = await fetch('/upload-image', {
                            method: 'POST',
                            body: arrayBuffer,
                            headers: {
                                'Content-Type': file.type
                            }
                        });
                        const data = await response.json();
                        
                        if (data.imageUrl) {
                            socket.emit('private-message', {
                                targetSocketId: currentPrivateChatTarget,
                                message: data.imageUrl,
                                type: 'image'
                            });
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } catch (error) {
                    console.error('ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', error);
                    alert('ä¸Šä¼ å›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
                
                privateChatImageInput.value = '';
            }
        });
        
        // ç§èŠå‘é€è¯­éŸ³
        let privateChatMediaRecorder = null;
        let privateChatAudioChunks = [];
        let privateChatIsRecording = false;
        
        privateChatAudioBtn.addEventListener('click', async () => {
            if (!userPermissions.allowAudio) {
                alert('æ‚¨æ²¡æœ‰å‘é€è¯­éŸ³çš„æƒé™');
                return;
            }
            
            if (!privateChatIsRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    privateChatMediaRecorder = new MediaRecorder(stream);
                    privateChatAudioChunks = [];
                    
                    privateChatMediaRecorder.ondataavailable = (event) => {
                        privateChatAudioChunks.push(event.data);
                    };
                    
                    privateChatMediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(privateChatAudioChunks, { type: 'audio/webm' });
                        
                        try {
                            const response = await fetch('/upload-audio', {
                                method: 'POST',
                                body: audioBlob,
                                headers: {
                                    'Content-Type': 'audio/webm'
                                }
                            });
                            
                            if (!response.ok) {
                                throw new Error(`ç½‘ç»œå“åº”é”™è¯¯: ${response.statusText}`);
                            }
                            
                            const data = await response.json();
                            
                            if (data.audioUrl) {
                                socket.emit('private-message', {
                                    targetSocketId: currentPrivateChatTarget,
                                    message: data.audioUrl,
                                    type: 'audio'
                                });
                            }
                        } catch (error) {
                            console.error('ä¸Šä¼ è¯­éŸ³å¤±è´¥:', error);
                            alert('ä¸Šä¼ è¯­éŸ³å¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                        
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    privateChatMediaRecorder.start();
                    privateChatIsRecording = true;
                    privateChatAudioBtn.classList.add('recording');
                    privateChatAudioBtn.title = 'åœæ­¢å½•åˆ¶';
                } catch (error) {
                    console.error('æ— æ³•è®¿é—®éº¦å…‹é£:', error);
                    alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                }
            } else {
                privateChatMediaRecorder.stop();
                privateChatIsRecording = false;
                privateChatAudioBtn.classList.remove('recording');
                privateChatAudioBtn.title = 'å‘é€è¯­éŸ³';
            }
        });
        
        // æ‰“å¼€ç§èŠ
        function openPrivateChat(friendSocketId, friendUsername) {
            currentPrivateChatTarget = friendSocketId;
            privateChatTitle.textContent = `ä¸ ${friendUsername} ç§èŠ`;
            privateChatMessagesDiv.innerHTML = '';
            
            // è·å–ç§èŠå†å²æ¶ˆæ¯
            socket.emit('get-private-messages', friendSocketId);
            
            privateChatModal.classList.add('active');
        }
        
        // æ·»åŠ å¥½å‹
        function addFriend(targetSocketId) {
            // ä¸å…è®¸æ·»åŠ è‡ªå·±ä¸ºå¥½å‹
            if (targetSocketId === socket.id) {
                alert('ä¸èƒ½æ·»åŠ è‡ªå·±ä¸ºå¥½å‹');
                return;
            }
            socket.emit('add-friend', targetSocketId);
        }

        // å¿«é€Ÿæ·»åŠ 5ä¸ªå¥½å‹ï¼ˆæµ‹è¯•åŠŸèƒ½ï¼‰
        function quickAddFriends() {
            if (confirm('ç¡®å®šè¦å¿«é€Ÿæ·»åŠ 5ä¸ªæµ‹è¯•å¥½å‹å—ï¼Ÿè¿™å°†å‘åœ¨çº¿ç”¨æˆ·éšæœºå‘é€5ä¸ªå¥½å‹è¯·æ±‚ã€‚')) {
                let sent = 0;
                const max = 5;
                const onlineUsers = Array.from(usersSet);
                
                onlineUsers.forEach(user => {
                    if (sent < max && user.socketId !== socket.id) {
                        socket.emit('add-friend', user.socketId);
                        sent++;
                    }
                });
                
                alert(`å·²å‘é€ ${sent} ä¸ªå¥½å‹è¯·æ±‚`);
            }
        }
        
        // åˆ é™¤å¥½å‹
        function removeFriend(friendSocketId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¥½å‹å—ï¼Ÿ')) {
                socket.emit('remove-friend', friendSocketId);
            }
        }
        
        // Socketäº‹ä»¶å¤„ç† - å¥½å‹ç³»ç»Ÿ
        
        // å¥½å‹åˆ—è¡¨
        socket.on('friends-list', (data) => {
            friends = data;
            updateFriendsList(data);
        });
        

        
        // å¥½å‹è¯·æ±‚
        socket.on('friend-request', (data) => {
            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'system-message';
            notificationDiv.innerHTML = `
                <div style="margin-bottom: 10px;">
                    <strong>${escapeHtml(data.fromUsername)}</strong> è¯·æ±‚æ·»åŠ ä½ ä¸ºå¥½å‹
                </div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-confirm" onclick="socket.emit('accept-friend', '${data.fromSocketId}'); this.parentElement.parentElement.remove();">æ¥å—</button>
                    <button class="btn btn-cancel" onclick="socket.emit('reject-friend', '${data.fromSocketId}'); this.parentElement.parentElement.remove();">æ‹’ç»</button>
                </div>
            `;
            messagesDiv.appendChild(notificationDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
        
        // å¥½å‹è¯·æ±‚è¢«æ¥å—
        socket.on('friend-accepted', (data) => {
            alert(`ä½ å·²æˆåŠŸæ·»åŠ  ${data.friendUsername} ä¸ºå¥½å‹`);
            socket.emit('get-friends');
        });
        
        // å¥½å‹è¯·æ±‚è¢«æ‹’ç»
        socket.on('friend-rejected', (data) => {
            alert(`${data.friendUsername} æ‹’ç»äº†ä½ çš„å¥½å‹è¯·æ±‚`);
        });
        
        // å¥½å‹è¢«æ·»åŠ 
        socket.on('friend-added', (data) => {
            alert(`${data.friendUsername} å·²æ·»åŠ ä½ ä¸ºå¥½å‹`);
            socket.emit('get-friends');
        });
        
        // å¥½å‹è¢«åˆ é™¤
        socket.on('friend-removed', (data) => {
            alert(`ä½ å·²åˆ é™¤å¥½å‹ ${data.friendUsername || 'å¯¹æ–¹'}`);
            socket.emit('get-friends');
        });
        
        // ç§èŠæ¶ˆæ¯
        socket.on('private-message', (data) => {
            addPrivateMessage(data);
        });
        
        // ç§èŠå†å²æ¶ˆæ¯
        socket.on('private-messages-history', (data) => {
            data.messages.forEach(message => {
                addPrivateMessage(message);
            });
        });
        
        // å¥½å‹é”™è¯¯
        socket.on('friend-error', (data) => {
            alert(data.message);
        });
        
        // @é€šçŸ¥
        socket.on('mention-notification', (data) => {
            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'system-message mention';
            notificationDiv.innerHTML = `
                <strong>${escapeHtml(data.fromUsername)}</strong> @äº†ä½ ï¼š${escapeHtml(data.message)}
                <div style="font-size: 12px; color: #999; margin-top: 5px;">${data.timestamp}</div>
            `;
            messagesDiv.appendChild(notificationDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // æ’­æ”¾æç¤ºéŸ³
            const audio = new Audio('/notification.mp3');
            audio.play().catch(() => {});
        });
        
        // æ›´æ–°å¥½å‹åˆ—è¡¨
        function updateFriendsList(friends) {
            friendsListDiv.innerHTML = '';
            
            if (friends.length === 0) {
                friendsListDiv.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— å¥½å‹</div>';
                return;
            }
            
            friends.forEach(friend => {
                const friendDiv = document.createElement('div');
                friendDiv.className = 'friend-item';
                friendDiv.onclick = function() {
                    const friendItems = document.querySelectorAll('.friend-item');
                    friendItems.forEach(item => {
                        item.classList.remove('expanded');
                    });
                    this.classList.toggle('expanded');
                };
                
                friendDiv.innerHTML = `
                    <div class="friend-color" style="background: ${friend.color}"></div>
                    <div class="friend-info">
                        <div class="friend-name">${escapeHtml(friend.username)}</div>
                        <div class="friend-status">${friend.online ? 'åœ¨çº¿' : 'ç¦»çº¿'}</div>
                    </div>
                    <div class="friend-actions">
                        <button class="friend-btn" onclick="event.stopPropagation(); openPrivateChat('${friend.socketId}', '${friend.username}')">ğŸ’¬</button>
                        <button class="friend-btn danger" onclick="event.stopPropagation(); removeFriend('${friend.socketId}')">ğŸ—‘ï¸</button>
                    </div>
                `;
                
                friendsListDiv.appendChild(friendDiv);
            });
        }
        
        // æ·»åŠ ç§èŠæ¶ˆæ¯
        function addPrivateMessage(data) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'private-chat-message' + (data.fromSocketId === socket.id ? ' sent' : '');
            messageDiv.dataset.messageId = data.id;
            
            let contentHtml;
            if (data.type === 'image') {
                contentHtml = `<img src="${data.message}" alt="å›¾ç‰‡" style="max-width: 100%; max-height: 200px; border-radius: 5px;">`;
            } else if (data.type === 'audio') {
                contentHtml = `<audio controls style="width: 100%; border-radius: 5px;"><source src="${data.message}" type="audio/webm">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾</audio>`;
            } else {
                // å¤„ç†æ–‡æœ¬æ¶ˆæ¯ï¼Œè¯†åˆ«å¹¶è½¬æ¢é“¾æ¥
                let text = escapeHtml(data.message);
                
                // é“¾æ¥è¯†åˆ«æ­£åˆ™è¡¨è¾¾å¼
                const urlRegex = /(https?:\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?)/g;
                
                // å°†é“¾æ¥è½¬æ¢ä¸ºè¶…é“¾æ¥
                text = text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer" style="color: #667eea; text-decoration: underline;">$1</a>');
                
                contentHtml = text;
            }
            
            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²æ”¶è—
            const isFavorited = isMessageFavorited(data.id);
            
            // åªæœ‰æ–‡æœ¬æ¶ˆæ¯æ‰æ˜¾ç¤ºç¿»è¯‘æŒ‰é’®
            let translateBtnHtml = data.type === 'text' ? `<button class="translate-btn" onclick="translateMessage('${data.id}', currentTargetLanguage)" title="ç¿»è¯‘æ¶ˆæ¯">ğŸŒ</button>` : '';
            
            let actionsHtml = `
                <div class="message-actions">
                    <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" onclick="toggleFavorite('${data.id}')" title="${isFavorited ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—æ¶ˆæ¯'}">â­</button>
                    ${translateBtnHtml}
                </div>
            `;
            
            // æ·»åŠ å·²è¯»çŠ¶æ€æ˜¾ç¤º
            const isRead = data.readBy && data.readBy.length > 1;
            const readStatusHtml = `<span class="read-status" ${isRead ? 'title="å·²è¯»"' : 'title="æœªè¯»"'}>${isRead ? 'âœ“âœ“' : 'âœ“'}</span>`;
            
            messageDiv.innerHTML = `
                <div class="private-chat-message-header">
                    ${data.fromSocketId === socket.id ? 'æˆ‘' : data.fromUsername} - ${data.timestamp}
                    ${data.fromSocketId === socket.id ? readStatusHtml : ''}
                </div>
                <div class="message-content">${contentHtml}</div>
                ${actionsHtml}
            `;
            
            privateChatMessagesDiv.appendChild(messageDiv);
            privateChatMessagesDiv.scrollTop = privateChatMessagesDiv.scrollHeight;
            
            // å‘é€å·²è¯»é€šçŸ¥ï¼ˆéè‡ªå·±å‘é€çš„æ¶ˆæ¯ï¼‰
            if (data.fromSocketId !== socket.id && data.id) {
                socket.emit('message-read', {
                    messageId: data.id,
                    chatId: data.chatId
                });
            }
            
            // è‡ªåŠ¨ç¿»è¯‘æ¶ˆæ¯ï¼ˆä»…æ–‡æœ¬æ¶ˆæ¯ï¼Œä¸”ä¸æ˜¯è‡ªå·±å‘é€çš„æ¶ˆæ¯ï¼‰
            if (userSettings.autoTranslate && data.type === 'text' && data.fromSocketId !== socket.id && data.id) {
                // å»¶è¿Ÿæ‰§è¡Œç¿»è¯‘ï¼Œç¡®ä¿DOMå·²æ¸²æŸ“
                setTimeout(() => {
                    translateMessage(data.id, currentTargetLanguage);
                }, 100);
            }
        }
        
        // ç®¡ç†å‘˜é¢æ¿åŠŸèƒ½
        
        // æ‰“å¼€è®¾ç½®é¡µé¢
        settingsBtn.addEventListener('click', () => {
            settingsModal.classList.add('active');
        });
        
        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.admin-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰activeç±»
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
                
                // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾
                tab.classList.add('active');
                const tabName = tab.dataset.tab;
                document.getElementById(tabName + 'Tab').classList.add('active');
            });
        });
        

        
        // æˆ¿é—´åŠ å…¥å¤±è´¥
        socket.on('join-error', (data) => {
            alert(data.message);
        });
        
        // æˆ¿é—´å˜æ›´é€šçŸ¥
        socket.on('room-changed', (data) => {
            currentRoom = data.roomName;
            // æ¸…ç©ºæ¶ˆæ¯åˆ—è¡¨
            messagesDiv.innerHTML = '<div class="system-message">' + data.message + '</div>';
            // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
            updateUserList([]);
        });
        
        // æˆ¿é—´å†å²æ¶ˆæ¯
        socket.on('room-history', (data) => {
            // æ¸…ç©ºå½“å‰æ¶ˆæ¯
            messagesDiv.innerHTML = '';
            // æ·»åŠ å†å²æ¶ˆæ¯
            data.messages.forEach(message => {
                addMessage(message);
            });
        });
        
        // å¤„ç†ç®¡ç†å‘˜å‘é€çš„å¼¹çª—æ¶ˆæ¯
        socket.on('popup-message', (data) => {
            alert(data.message);
        });
        
        // å¤„ç†ç®¡ç†å‘˜æ›´æ”¹é¡µé¢æ ‡é¢˜
        socket.on('change-title', (data) => {
            document.title = data.title;
        });

        function recallMessage(messageId) {
            socket.emit('message-recall', messageId);
        }

        function addMessage(data) {
            // ä¿å­˜æ¶ˆæ¯åˆ°å†å²è®°å½•æ•°ç»„
            allMessages.push(data);
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.dataset.messageId = data.id;
            
            let contentHtml;
            if (data.type === 'image') {
                contentHtml = `<img src="${data.message}" alt="å›¾ç‰‡" style="max-width: 100%; max-height: 200px; border-radius: 5px;">`;
            } else if (data.type === 'audio') {
                contentHtml = `<audio controls style="width: 100%; border-radius: 5px;"><source src="${data.message}" type="audio/webm">æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾</think_never_used_51bce0c785ca2f68081bfa7d91973934>`;
            } else {
                // å¤„ç†æ–‡æœ¬æ¶ˆæ¯ï¼Œè¯†åˆ«å¹¶è½¬æ¢é“¾æ¥
                let text = escapeHtml(data.message);
                
                // é“¾æ¥è¯†åˆ«æ­£åˆ™è¡¨è¾¾å¼
                const urlRegex = /(https?:\/\/[\w\-_]+(\.[\w\-_]+)+([\w\-\.,@?^=%&:/~\+#]*[\w\-\@?^=%&/~\+#])?)/g;
                
                // å°†é“¾æ¥è½¬æ¢ä¸ºè¶…é“¾æ¥
                text = text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer" style="color: #667eea; text-decoration: underline;">$1</a>');
                
                // å¦‚æœæ­£åœ¨æœç´¢ï¼Œé«˜äº®æ˜¾ç¤ºæœç´¢å…³é”®è¯
                if (isSearching && searchKeyword) {
                    const regex = new RegExp(`(${escapeRegExp(searchKeyword)})`, 'gi');
                    text = text.replace(regex, '<span style="background-color: #ffeb3b; font-weight: bold;">$1</span>');
                }
                
                contentHtml = text;
            }
            
            // æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²æ”¶è—
            const isFavorited = isMessageFavorited(data.id);
            
            // åªæœ‰æ–‡æœ¬æ¶ˆæ¯æ‰æ˜¾ç¤ºç¿»è¯‘æŒ‰é’®
            let translateBtnHtml = data.type === 'text' ? `<button class="translate-btn" onclick="translateMessage('${data.id}', currentTargetLanguage)" title="ç¿»è¯‘æ¶ˆæ¯">ğŸŒ</button>` : '';
            
            let actionsHtml = `
                <div class="message-actions">
                    <button class="favorite-btn ${isFavorited ? 'favorited' : ''}" onclick="toggleFavorite('${data.id}')" title="${isFavorited ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—æ¶ˆæ¯'}">â­</button>
                    ${translateBtnHtml}
                    ${data.username === username ? `<button class="recall-btn" onclick="recallMessage('${data.id}')">æ’¤å›</button>` : ''}
                </div>
            `;
            
            // æ·»åŠ å·²è¯»çŠ¶æ€æ˜¾ç¤º
            const isRead = data.readBy && data.readBy.length > 1;
            const readStatusHtml = `<span class="read-status" ${isRead ? 'title="å·²è¯»"' : 'title="æœªè¯»"'}>${isRead ? 'âœ“âœ“' : 'âœ“'}</span>`;
            
            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="username" style="color: ${data.color}">${data.username}</span>
                    <span class="timestamp">${data.timestamp}</span>
                    ${data.username === username ? readStatusHtml : ''}
                </div>
                <div class="message-content">${contentHtml}</div>
                ${actionsHtml}
            `;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // å‘é€å·²è¯»é€šçŸ¥ï¼ˆéè‡ªå·±å‘é€çš„æ¶ˆæ¯ï¼‰
            if (data.username !== username && data.id) {
                socket.emit('message-read', {
                    messageId: data.id,
                    roomName: currentRoom || 'main'
                });
            }
            
            // è‡ªåŠ¨ç¿»è¯‘æ¶ˆæ¯ï¼ˆä»…æ–‡æœ¬æ¶ˆæ¯ï¼Œä¸”ä¸æ˜¯è‡ªå·±å‘é€çš„æ¶ˆæ¯ï¼‰
            if (userSettings.autoTranslate && data.type === 'text' && data.username !== username && data.id) {
                // å»¶è¿Ÿæ‰§è¡Œç¿»è¯‘ï¼Œç¡®ä¿DOMå·²æ¸²æŸ“
                setTimeout(() => {
                    translateMessage(data.id, currentTargetLanguage);
                }, 100);
            }
        }

        function addSystemMessage(text, isAdmin = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'system-message' + (isAdmin ? ' admin' : '');
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function updateUserList(users) {
            // ä¿å­˜å®Œæ•´çš„ç”¨æˆ·åˆ—è¡¨åˆ°allUsersï¼Œåªåœ¨ä»æœåŠ¡å™¨è·å–å®Œæ•´ç”¨æˆ·åˆ—è¡¨æ—¶æ›´æ–°
            allUsers = users;
            searchResults = users;
            usersListDiv.innerHTML = '';
            
            if (users.length === 0) {
                usersListDiv.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— åœ¨çº¿ç”¨æˆ·</div>';
                return;
            }
            
            users.forEach(user => {
                const status = user.status || 'online'; // é»˜è®¤åœ¨çº¿
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item';
                userDiv.onclick = () => {
                    showUserDetail(user.socketId, user.username, user.color, JSON.stringify(user.permissions).replace(/"/g, '&quot;'));
                };
                
                userDiv.innerHTML = `
                    <div class="status-indicator status-${status}"></div>
                    <div class="user-color" style="background: ${user.color}"></div>
                    <div class="user-name">${escapeHtml(user.username)}</div>
                `;
                
                usersListDiv.appendChild(userDiv);
            });
        }

        // å¤„ç†ç”¨æˆ·çŠ¶æ€å˜åŒ–
        socket.on('user-status-changed', (data) => {
            // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
            if (data.roomName === currentRoom) {
                // å¦‚æœæ˜¯å½“å‰æˆ¿é—´çš„ç”¨æˆ·çŠ¶æ€å˜åŒ–ï¼Œæ›´æ–°ç”¨æˆ·åˆ—è¡¨
                const updatedUser = allUsers.find(user => user.socketId === data.socketId);
                if (updatedUser) {
                    updatedUser.status = data.status;
                    updateUserList(allUsers);
                }
            }
        });

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // è½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        // æœç´¢æ¶ˆæ¯
        function searchMessages(keyword) {
            searchKeyword = keyword;
            if (!keyword) {
                isSearching = false;
                // æ¸…ç©ºæœç´¢çŠ¶æ€ï¼Œé‡æ–°æ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯
                messagesDiv.innerHTML = '<div class="system-message">æ¬¢è¿æ¥åˆ°èŠå¤©å®¤ï¼è¯·è¾“å…¥æ˜µç§°åŠ å…¥ã€‚</div>';
                allMessages.forEach(message => {
                    addMessage(message);
                });
                return;
            }
            
            isSearching = true;
            let searchResults;
            
            // å½“å…³é”®è¯æ˜¯"audio"æ—¶ï¼Œæœç´¢æ‰€æœ‰è¯­éŸ³æ¶ˆæ¯
            if (keyword.toLowerCase() === 'audio') {
                searchResults = allMessages.filter(message => message.type === 'audio');
            } else {
                // å¦åˆ™æœç´¢æ–‡æœ¬æ¶ˆæ¯
                searchResults = allMessages.filter(message => {
                    if (message.type === 'text') {
                        return message.message.toLowerCase().includes(keyword.toLowerCase());
                    }
                    return false;
                });
            }
            
            // æ¸…ç©ºæ¶ˆæ¯åŒºåŸŸ
            messagesDiv.innerHTML = `<div class="system-message">æœç´¢ç»“æœ: ${searchResults.length} æ¡</div>`;
            
            // æ˜¾ç¤ºæœç´¢ç»“æœ
            searchResults.forEach(message => {
                addMessage(message);
            });
        }
        
        // æ¶ˆæ¯æœç´¢è¾“å…¥äº‹ä»¶ç›‘å¬
        messageSearchInput.addEventListener('input', (e) => {
            searchMessages(e.target.value);
        });

        // åª’ä½“å½•åˆ¶å™¨
        mediaRecorder = null;
        let mediaChunks = [];
        isRecording = false;
        let isDeviceSelectModalOpen = false;
        let isVideoCall = false;
        
        // åª’ä½“æºå’Œç¼“å†²åŒº
        let mediaSource = null;
        let sourceBuffer = null;
        let audioSource = null;
        let audioBuffer = null;
        let audioElement = null;
        
        // å½“å‰åª’ä½“URL
        let currentMediaUrl = null;
        
        // åª’ä½“æ•°æ®é˜Ÿåˆ—
        let mediaDataQueue = [];
        
        // è¿œç¨‹è§†é¢‘å’ŒéŸ³é¢‘ç¼“å†²åŒº
        let remoteVideoBuffer = null;
        let remoteAudioBuffer = null;
        let remoteAudioIsPlaying = false;
        
        // æ¥æ”¶æ•°æ®é˜Ÿåˆ—
        let receiveDataQueue = [];
        let isAppending = false;

        // å¼€å§‹è§†é¢‘é€šè¯
        async function startVideoCall(targetSocketId, targetUsername) {
            if (!userPermissions.allowCall) {
                alert('æ‚¨æ²¡æœ‰é€šè¯æƒé™');
                endCall();
                return;
            }
            
            isVideoCall = true;
            currentCallId = Date.now().toString();
            
            try {
                // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåª’ä½“è®¾å¤‡è®¿é—®');
                }
                
                // è·å–å¯ç”¨è®¾å¤‡
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                const audioDevices = devices.filter(device => device.kind === 'audioinput');
                
                console.log('å¯ç”¨è§†é¢‘è®¾å¤‡:', videoDevices);
                console.log('å¯ç”¨éŸ³é¢‘è®¾å¤‡:', audioDevices);
                
                if (videoDevices.length === 0) {
                    throw new Error('æœªæ£€æµ‹åˆ°æ‘„åƒå¤´è®¾å¤‡');
                }
                
                if (audioDevices.length === 0) {
                    throw new Error('æœªæ£€æµ‹åˆ°éº¦å…‹é£è®¾å¤‡');
                }
                
                // å¦‚æœæœ‰å¤šä¸ªè®¾å¤‡ï¼Œæ˜¾ç¤ºè®¾å¤‡é€‰æ‹©ç•Œé¢
                if (videoDevices.length > 1 || audioDevices.length > 1) {
                    availableVideoDevices = videoDevices;
                    availableAudioDevices = audioDevices;
                    selectedVideoDeviceId = videoDevices[0].deviceId;
                    selectedAudioDeviceId = audioDevices[0].deviceId;
                    pendingCallAction = { type: 'video', targetSocketId, targetUsername };
                    showDeviceSelectModal();
                    return;
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true
                    },
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });
                
                localStream = stream;
                localVideo.srcObject = stream;
                
                // è®¾ç½®ç›®æ ‡Socket ID
                currentTargetSocketId = targetSocketId;
                
                socket.emit('call-request', {
                    targetSocketId: targetSocketId,
                    callId: currentCallId,
                    type: 'video',
                    fromUsername: username
                });
                
                videoContainer.classList.add('active');
                addSystemMessage(`æ­£åœ¨å‘ ${targetUsername} å‘èµ·è§†é¢‘é€šè¯...`);
            } catch (error) {
                console.error('è·å–æ‘„åƒå¤´å¤±è´¥:', error);
                let errorMessage = 'æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage = 'æ‚¨æ‹’ç»äº†æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸è®¿é—®';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'æœªæ‰¾åˆ°æ‘„åƒå¤´æˆ–éº¦å…‹é£è®¾å¤‡';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'æ— æ³•è¯»å–æ‘„åƒå¤´æˆ–éº¦å…‹é£æ•°æ®';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                alert(errorMessage);
            }
        }

        // å¼€å§‹è¯­éŸ³é€šè¯
        async function startAudioCall(targetSocketId, targetUsername) {
            if (!userPermissions.allowCall) {
                alert('æ‚¨æ²¡æœ‰é€šè¯æƒé™');
                endCall();
                return;
            }
            
            isVideoCall = false;
            currentCallId = Date.now().toString();
            currentTargetSocketId = targetSocketId;
            
            try {
                // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåª’ä½“è®¾å¤‡è®¿é—®');
                }
                
                // è·å–å¯ç”¨è®¾å¤‡
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioDevices = devices.filter(device => device.kind === 'audioinput');
                
                console.log('å¯ç”¨éŸ³é¢‘è®¾å¤‡:', audioDevices);
                
                if (audioDevices.length === 0) {
                    throw new Error('æœªæ£€æµ‹åˆ°éº¦å…‹é£è®¾å¤‡');
                }
                
                // å¦‚æœæœ‰å¤šä¸ªè®¾å¤‡ï¼Œæ˜¾ç¤ºè®¾å¤‡é€‰æ‹©ç•Œé¢
                if (audioDevices.length > 1) {
                    availableVideoDevices = [];
                    availableAudioDevices = audioDevices;
                    selectedVideoDeviceId = null;
                    selectedAudioDeviceId = audioDevices[0].deviceId;
                    pendingCallAction = { type: 'audio', targetSocketId, targetUsername };
                    showDeviceSelectModal();
                    return;
                }
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                localStream = stream;
                
                // ä¸è¦ç«‹å³å¼€å§‹å½•åˆ¶ï¼Œç­‰å¾…å¯¹æ–¹æ¥å—é€šè¯åå†å¼€å§‹
                // startMediaRecording(stream);
                
                socket.emit('call-request', {
                    targetSocketId: targetSocketId,
                    callId: currentCallId,
                    type: 'audio',
                    fromUsername: username
                });
                
                videoContainer.classList.add('active');
                addSystemMessage(`æ­£åœ¨å‘ ${targetUsername} å‘èµ·è¯­éŸ³é€šè¯...`);
            } catch (error) {
                console.error('è·å–éº¦å…‹é£å¤±è´¥:', error);
                let errorMessage = 'æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage = 'æ‚¨æ‹’ç»äº†éº¦å…‹é£æƒé™ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å…è®¸è®¿é—®';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'æœªæ‰¾åˆ°éº¦å…‹é£è®¾å¤‡';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'æ— æ³•è¯»å–éº¦å…‹é£æ•°æ®';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                alert(errorMessage);
            }
        }

        // å¼€å§‹åª’ä½“å½•åˆ¶
        // æ—§é€šè¯åŠŸèƒ½çš„å½•åˆ¶å‡½æ•°ï¼Œå·²è¢«æ–°åŠŸèƒ½æ›¿ä»£
        function startMediaRecording(stream) {
            console.log('å¿½ç•¥æ—§å½•åˆ¶åŠŸèƒ½ï¼Œä½¿ç”¨æ–°é€šè¯åŠŸèƒ½');
            // ç¦ç”¨æ—§çš„MediaRecorderåŠŸèƒ½ï¼Œé˜²æ­¢å†²çª
            return;
        }

        // åœæ­¢åª’ä½“å½•åˆ¶
        function stopMediaRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
            }
            
            // æ¸…ç† MediaSource å’Œ SourceBuffer
            if (sourceBuffer) {
                try {
                    sourceBuffer.abort();
                } catch (e) {
                    console.error('ä¸­æ­¢ SourceBuffer å¤±è´¥:', e);
                }
                sourceBuffer = null;
            }
            
            if (mediaSource) {
                try {
                    if (mediaSource.readyState === 'open') {
                        mediaSource.endOfStream();
                    }
                } catch (e) {
                    console.error('ç»“æŸ MediaStream å¤±è´¥:', e);
                }
                
                try {
                    URL.revokeObjectURL(remoteVideo.src);
                    if (audioElement) {
                        URL.revokeObjectURL(audioElement.src);
                    }
                } catch (e) {
                    console.error('é‡Šæ”¾ URL å¤±è´¥:', e);
                }
                mediaSource = null;
            }
            
            if (audioElement) {
                audioElement = null;
            }
            
            // æ¸…ç†å½“å‰çš„åª’ä½“URL
            if (currentMediaUrl) {
                try {
                    URL.revokeObjectURL(currentMediaUrl);
                } catch (e) {
                    console.error('é‡Šæ”¾ URL å¤±è´¥:', e);
                }
                currentMediaUrl = null;
            }
        }

        // æ¥å—é€šè¯
        // é€šè¯ç›¸å…³çš„å‡½æ•°å·²ç§»è‡³CallSystemç±»ä¸­å®ç°
        

        // ç»“æŸé€šè¯


        // æ˜¾ç¤ºç”¨æˆ·è¯¦æƒ…å‡½æ•°
        function showUserDetail(socketId, username, color, permissions) {
            // ä¸éœ€è¦currentDetailSocketIdå˜é‡ï¼Œç›´æ¥ä½¿ç”¨socketIdå‚æ•°
            
            // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
            if (userDetailUpdateInterval) {
                clearInterval(userDetailUpdateInterval);
                userDetailUpdateInterval = null;
            }
            
            // å°†æƒé™å­—ç¬¦ä¸²è§£æä¸ºå¯¹è±¡ï¼Œå¤„ç†HTMLå®ä½“ç¼–ç 
            let parsedPermissions = permissions;
            if (typeof permissions === 'string') {
                // å…ˆæ›¿æ¢HTMLå®ä½“ç¼–ç ï¼Œç„¶åè§£æJSON
                const decodedPermissions = permissions.replace(/&quot;/g, '"');
                parsedPermissions = JSON.parse(decodedPermissions);
            }
            
            usersModal.classList.remove('active');
            userDetailTitle.textContent = 'ç”¨æˆ·è¯¦æƒ…';
            userDetailContent.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <div class="user-color" style="background: ${color}; width: 50px; height: 50px; border-radius: 50%;"></div>
                        <div>
                            <div style="font-size: 16px; font-weight: bold; margin-bottom: 5px;">${escapeHtml(username)}</div>
                            <div style="font-size: 12px; color: #666;">Socket ID: ${socketId}</div>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: bold; margin-bottom: 5px;">æƒé™</div>
                        <div class="permissions-container">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <span>å‘é€è¯­éŸ³:</span>
                                    <span style="margin-left: 10px; color: ${parsedPermissions.allowAudio ? '#28a745' : '#dc3545'}">${parsedPermissions.allowAudio ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                                <div>
                                    <span>å‘é€å›¾ç‰‡:</span>
                                    <span style="margin-left: 10px; color: ${parsedPermissions.allowImage ? '#28a745' : '#dc3545'}">${parsedPermissions.allowImage ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                                <div>
                                    <span>å‘é€æ–‡ä»¶:</span>
                                    <span style="margin-left: 10px; color: ${parsedPermissions.allowFile ? '#28a745' : '#dc3545'}">${parsedPermissions.allowFile ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                                <div>
                                    <span>å‘é€æ¶ˆæ¯:</span>
                                    <span style="margin-left: 10px; color: ${parsedPermissions.allowSendMessages ? '#28a745' : '#dc3545'}">${parsedPermissions.allowSendMessages ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                                <div>
                                    <span>æŸ¥çœ‹æ¶ˆæ¯:</span>
                                    <span style="margin-left: 10px; color: ${parsedPermissions.allowViewMessages ? '#28a745' : '#dc3545'}">${parsedPermissions.allowViewMessages ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                                <div>
                                    <span>é€šè¯:</span>
                                    <span style="margin-left: 10px; color: ${parsedPermissions.allowCall ? '#28a745' : '#dc3545'}">${parsedPermissions.allowCall ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                                <div>
                                    <span>æ·»åŠ å¥½å‹:</span>
                                    <span style="margin-left: 10px; color: ${parsedPermissions.allowAddFriends ? '#28a745' : '#dc3545'}">${parsedPermissions.allowAddFriends ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                                <div>
                                    <span>æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨:</span>
                                    <span style="margin-left: 10px; color: ${parsedPermissions.allowViewUsers ? '#28a745' : '#dc3545'}">${parsedPermissions.allowViewUsers ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                                <div>
                                    <span>å…è®¸ç§èŠ:</span>
                                    <span style="margin-left: 10px; color: ${parsedPermissions.allowPrivateChat ? '#28a745' : '#dc3545'}">${parsedPermissions.allowPrivateChat ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                                <div>
                                    <span>å…è®¸æ‰“å¼€å¥½å‹é¡µé¢:</span>
                                    <span style="margin-left: 10px; color: ${parsedPermissions.allowOpenFriendsPage ? '#28a745' : '#dc3545'}">${parsedPermissions.allowOpenFriendsPage ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                                <div>
                                    <span>å…è®¸æ’¤å›æ¶ˆæ¯:</span>
                                    <span style="margin-left: 10px; color: ${parsedPermissions.allowRecallMessage ? '#28a745' : '#dc3545'}">${parsedPermissions.allowRecallMessage ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-confirm" onclick="addFriend('${socketId}'); closeUserDetailModal();">æ·»åŠ å¥½å‹</button>
                    </div>
                </div>
            `;
            
            userDetailModal.classList.add('active');
            
            // å®šä¹‰æ›´æ–°æƒé™æ˜¾ç¤ºçš„å‡½æ•°
            function updatePermissionsDisplay() {
                // ä»allUsersæ•°ç»„ä¸­è·å–æœ€æ–°çš„ç”¨æˆ·æ•°æ®
                const latestUser = allUsers.find(user => user.socketId === socketId);
                if (latestUser) {
                    const permissionsContainer = userDetailContent.querySelector('.permissions-container');
                    if (permissionsContainer) {
                        // æ›´æ–°æƒé™æ˜¾ç¤º
                        permissionsContainer.innerHTML = `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div>
                                    <span>å‘é€è¯­éŸ³:</span>
                                    <span style="margin-left: 10px; color: ${latestUser.permissions.allowAudio ? '#28a745' : '#dc3545'}">${latestUser.permissions.allowAudio ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                                <div>
                                    <span>å‘é€å›¾ç‰‡:</span>
                                    <span style="margin-left: 10px; color: ${latestUser.permissions.allowImage ? '#28a745' : '#dc3545'}">${latestUser.permissions.allowImage ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                                <div>
                                    <span>å‘é€æ–‡ä»¶:</span>
                                    <span style="margin-left: 10px; color: ${latestUser.permissions.allowFile ? '#28a745' : '#dc3545'}">${latestUser.permissions.allowFile ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                                <div>
                                    <span>å‘é€æ¶ˆæ¯:</span>
                                    <span style="margin-left: 10px; color: ${latestUser.permissions.allowSendMessages ? '#28a745' : '#dc3545'}">${latestUser.permissions.allowSendMessages ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                                <div>
                                    <span>æŸ¥çœ‹æ¶ˆæ¯:</span>
                                    <span style="margin-left: 10px; color: ${latestUser.permissions.allowViewMessages ? '#28a745' : '#dc3545'}">${latestUser.permissions.allowViewMessages ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                                <div>
                                    <span>é€šè¯:</span>
                                    <span style="margin-left: 10px; color: ${latestUser.permissions.allowCall ? '#28a745' : '#dc3545'}">${latestUser.permissions.allowCall ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                                <div>
                                    <span>æ·»åŠ å¥½å‹:</span>
                                    <span style="margin-left: 10px; color: ${latestUser.permissions.allowAddFriends ? '#28a745' : '#dc3545'}">${latestUser.permissions.allowAddFriends ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                                <div>
                                    <span>æŸ¥çœ‹ç”¨æˆ·åˆ—è¡¨:</span>
                                    <span style="margin-left: 10px; color: ${latestUser.permissions.allowViewUsers ? '#28a745' : '#dc3545'}">${latestUser.permissions.allowViewUsers ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                                <div>
                                    <span>å…è®¸ç§èŠ:</span>
                                    <span style="margin-left: 10px; color: ${latestUser.permissions.allowPrivateChat ? '#28a745' : '#dc3545'}">${latestUser.permissions.allowPrivateChat ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                                <div>
                                    <span>å…è®¸æ‰“å¼€å¥½å‹é¡µé¢:</span>
                                    <span style="margin-left: 10px; color: ${latestUser.permissions.allowOpenFriendsPage ? '#28a745' : '#dc3545'}">${latestUser.permissions.allowOpenFriendsPage ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                                <div>
                                    <span>å…è®¸æ’¤å›æ¶ˆæ¯:</span>
                                    <span style="margin-left: 10px; color: ${latestUser.permissions.allowRecallMessage ? '#28a745' : '#dc3545'}">${latestUser.permissions.allowRecallMessage ? 'å…è®¸' : 'ç¦æ­¢'}</span>
                                </div>
                            </div>
                        `;
                    }
                }
            }
            
            // å¯åŠ¨æ¯2ç§’æ›´æ–°æƒé™çš„å®šæ—¶å™¨
            userDetailUpdateInterval = setInterval(updatePermissionsDisplay, 2000);
        }
        
        // å…³é—­ç”¨æˆ·è¯¦æƒ…æ¨¡æ€æ¡†
        function closeUserDetailModal() {
            userDetailModal.classList.remove('active');
            usersModal.classList.add('active');
            
            // æ¸…é™¤å®šæ—¶å™¨
            if (userDetailUpdateInterval) {
                clearInterval(userDetailUpdateInterval);
                userDetailUpdateInterval = null;
            }
            // ä¸éœ€è¦è®¾ç½®currentDetailSocketIdï¼Œå› ä¸ºä¸å†ä½¿ç”¨è¯¥å˜é‡
        }
        
        // Socketäº‹ä»¶å¤„ç†ï¼ˆæ—§é€šè¯åŠŸèƒ½ï¼Œå·²è¢«æ–°åŠŸèƒ½æ›¿ä»£ï¼‰

        // æ¥æ”¶é€šè¯è¯·æ±‚ï¼ˆæ—§åŠŸèƒ½ï¼Œå·²è¢«æ–°åŠŸèƒ½æ›¿ä»£ï¼‰
        socket.on('call-request', (data) => {
            // å¿½ç•¥æ—§çš„é€šè¯è¯·æ±‚ï¼Œåªä½¿ç”¨æ–°çš„é€šè¯åŠŸèƒ½
            console.log('å¿½ç•¥æ—§é€šè¯è¯·æ±‚ï¼Œä½¿ç”¨æ–°é€šè¯åŠŸèƒ½');
        });

        // é€šè¯è¢«æ¥å—ï¼ˆæ—§åŠŸèƒ½ï¼Œå·²è¢«æ–°åŠŸèƒ½æ›¿ä»£ï¼‰
        socket.on('call-accepted', (data) => {
            // å¿½ç•¥æ—§çš„é€šè¯æ¥å—ï¼Œåªä½¿ç”¨æ–°çš„é€šè¯åŠŸèƒ½
            console.log('å¿½ç•¥æ—§é€šè¯æ¥å—ï¼Œä½¿ç”¨æ–°é€šè¯åŠŸèƒ½');
        });

        // é€šè¯è¢«æ‹’ç»ï¼ˆæ—§åŠŸèƒ½ï¼Œå·²è¢«æ–°åŠŸèƒ½æ›¿ä»£ï¼‰
        socket.on('call-rejected', (data) => {
            // å¿½ç•¥æ—§çš„é€šè¯æ‹’ç»äº‹ä»¶ï¼Œåªä½¿ç”¨æ–°çš„é€šè¯åŠŸèƒ½
            console.log('å¿½ç•¥æ—§é€šè¯æ‹’ç»äº‹ä»¶ï¼Œä½¿ç”¨æ–°é€šè¯åŠŸèƒ½');
        });

        // é€šè¯ç»“æŸï¼ˆæ—§åŠŸèƒ½ï¼Œå·²è¢«æ–°åŠŸèƒ½æ›¿ä»£ï¼‰
        socket.on('call-ended', (data) => {
            // å¿½ç•¥æ—§çš„é€šè¯ç»“æŸäº‹ä»¶ï¼Œåªä½¿ç”¨æ–°çš„é€šè¯åŠŸèƒ½
            console.log('å¿½ç•¥æ—§é€šè¯ç»“æŸäº‹ä»¶ï¼Œä½¿ç”¨æ–°é€šè¯åŠŸèƒ½');
        });

        // æ¥æ”¶åª’ä½“æ•°æ®ï¼ˆæ—§åŠŸèƒ½ï¼Œå·²è¢«æ–°åŠŸèƒ½æ›¿ä»£ï¼‰
        socket.on('call-media', (data) => {
            // å¿½ç•¥æ—§çš„åª’ä½“æ•°æ®äº‹ä»¶ï¼Œåªä½¿ç”¨æ–°çš„é€šè¯åŠŸèƒ½
            console.log('å¿½ç•¥æ—§åª’ä½“æ•°æ®äº‹ä»¶ï¼Œä½¿ç”¨æ–°é€šè¯åŠŸèƒ½');
        });
        
        // å¤„ç†æ¥æ”¶æ•°æ®é˜Ÿåˆ—
        function processReceiveQueue() {
            if (receiveDataQueue.length === 0) {
                isAppending = false;
                return;
            }
            
            isAppending = true;
            const { uint8Array, mimeType } = receiveDataQueue.shift();
            
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¿™ä¸ª MIME ç±»å‹ç”¨äº SourceBuffer
            if (isVideoCall) {
                // è§†é¢‘æ’­æ”¾ - ä½¿ç”¨ MediaSource API
                if (!mediaSource) {
                    mediaSource = new MediaSource();
                    remoteVideo.src = URL.createObjectURL(mediaSource);
                    
                    mediaSource.addEventListener('sourceopen', () => {
                        console.log('MediaSource å·²æ‰“å¼€ï¼Œå°è¯•ä½¿ç”¨ MIME ç±»å‹:', mimeType);
                        
                        // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒçš„ MIME ç±»å‹
                        const videoTypes = [
                            mimeType,
                            'video/webm;codecs=vp9,opus',
                            'video/webm;codecs=vp8,opus',
                            'video/webm;codecs=vp8',
                            'video/webm',
                            'video/mp4'
                        ];
                        
                        for (const type of videoTypes) {
                            try {
                                if (MediaSource.isTypeSupported(type)) {
                                    console.log('ä½¿ç”¨æ”¯æŒçš„ MIME ç±»å‹:', type);
                                    sourceBuffer = mediaSource.addSourceBuffer(type);
                                    sourceBuffer.addEventListener('updateend', () => {
                                        console.log('ç¼“å†²åŒºæ›´æ–°å®Œæˆ');
                                        // å¤„ç†ä¸‹ä¸€ä¸ªæ•°æ®
                                        processReceiveQueue();
                                    });
                                    break;
                                }
                            } catch (e) {
                                console.log('å°è¯•', type, 'å¤±è´¥:', e.message);
                            }
                        }
                    });
                }
                
                // å°†æ•°æ®æ·»åŠ åˆ°ç¼“å†²åŒº
                if (sourceBuffer && mediaSource.readyState === 'open') {
                    const appendData = () => {
                        if (!sourceBuffer.updating) {
                            try {
                                sourceBuffer.appendBuffer(uint8Array);
                                console.log('æˆåŠŸæ·»åŠ æ•°æ®ï¼Œå¤§å°:', uint8Array.length);
                            } catch (e) {
                                console.error('æ·»åŠ ç¼“å†²åŒºå¤±è´¥:', e);
                            }
                        } else {
                            // å¦‚æœæ­£åœ¨æ›´æ–°ï¼Œç­‰å¾…50msåé‡è¯•
                            setTimeout(appendData, 50);
                        }
                    };
                    appendData();
                }
            } else {
                // éŸ³é¢‘æ’­æ”¾ - ä½¿ç”¨ MediaSource API
                if (!mediaSource) {
                    mediaSource = new MediaSource();
                    if (!audioElement) {
                        audioElement = new Audio();
                        audioElement.autoplay = true;
                    }
                    audioElement.src = URL.createObjectURL(mediaSource);
                    
                    mediaSource.addEventListener('sourceopen', () => {
                        console.log('MediaSource å·²æ‰“å¼€ï¼Œå°è¯•ä½¿ç”¨ MIME ç±»å‹:', mimeType);
                        
                        // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒçš„ MIME ç±»å‹
                        const audioTypes = [
                            mimeType,
                            'audio/webm;codecs=opus',
                            'audio/webm',
                            'audio/ogg;codecs=opus',
                            'audio/mp4'
                        ];
                        
                        for (const type of audioTypes) {
                            try {
                                if (MediaSource.isTypeSupported(type)) {
                                    console.log('ä½¿ç”¨æ”¯æŒçš„ MIME ç±»å‹:', type);
                                    sourceBuffer = mediaSource.addSourceBuffer(type);
                                    sourceBuffer.addEventListener('updateend', () => {
                                        console.log('ç¼“å†²åŒºæ›´æ–°å®Œæˆ');
                                        // å¤„ç†ä¸‹ä¸€ä¸ªæ•°æ®
                                        processReceiveQueue();
                                    });
                                    break;
                                }
                            } catch (e) {
                                console.log('å°è¯•', type, 'å¤±è´¥:', e.message);
                            }
                        }
                    });
                }
                
                // å°†æ•°æ®æ·»åŠ åˆ°ç¼“å†²åŒº
                if (sourceBuffer && mediaSource.readyState === 'open') {
                    const appendData = () => {
                        if (!sourceBuffer.updating) {
                            try {
                                sourceBuffer.appendBuffer(uint8Array);
                                console.log('æˆåŠŸæ·»åŠ æ•°æ®ï¼Œå¤§å°:', uint8Array.length);
                            } catch (e) {
                                console.error('æ·»åŠ ç¼“å†²åŒºå¤±è´¥:', e);
                            }
                        } else {
                            // å¦‚æœæ­£åœ¨æ›´æ–°ï¼Œç­‰å¾…50msåé‡è¯•
                            setTimeout(appendData, 50);
                        }
                    };
                    appendData();
                }
            }
        }

        // è§†é¢‘é€šè¯æŒ‰é’®äº‹ä»¶
        // videoCallBtn.addEventListener('click', () => {
        //     const targetUser = prompt('è¯·è¾“å…¥è¦è§†é¢‘é€šè¯çš„ç”¨æˆ·å:');
        //     if (targetUser) {
        //         const userElements = usersListDiv.querySelectorAll('.user-item');
        //         for (let userElement of userElements) {
        //             const name = userElement.querySelector('.user-name').textContent;
        //             if (name === targetUser) {
        //                 const callBtn = userElement.querySelector('.call-btn');
        //                 if (callBtn && callBtn.textContent === 'ğŸ“¹') {
        //                     const socketId = callBtn.getAttribute('onclick').match(/'([^']+)'/)[1];
        //                     startVideoCall(socketId, targetUser);
        //                     return;
        //                 }
        //         }
        //         alert('æœªæ‰¾åˆ°è¯¥ç”¨æˆ·æˆ–è¯¥ç”¨æˆ·æ²¡æœ‰é€šè¯æƒé™');
        // });
        
        // // è¯­éŸ³é€šè¯æŒ‰é’®äº‹ä»¶
        // audioCallBtn.addEventListener('click', () => {
        //     const targetUser = prompt('è¯·è¾“å…¥è¦è¯­éŸ³é€šè¯çš„ç”¨æˆ·å:');
        //     if (targetUser) {
        //         const userElements = usersListDiv.querySelectorAll('.user-item');
        //         for (let userElement of userElements) {
        //             const name = userElement.querySelector('.user-name').textContent;
        //             if (name === targetUser) {
        //                 const callBtns = userElement.querySelectorAll('.call-btn');
        //                 for (let callBtn of callBtns) {
        //                     if (callBtn.textContent === 'ğŸ“') {
        //                         const socketId = callBtn.getAttribute('onclick').match(/'([^']+)'/)[1];
        //                         startAudioCall(socketId, targetUser);
        //                         return;
        //                     }
        //                 }
        //         }
        //         alert('æœªæ‰¾åˆ°è¯¥ç”¨æˆ·æˆ–è¯¥ç”¨æˆ·æ²¡æœ‰é€šè¯æƒé™');
        // });
        
        // æ£€æŸ¥è®¾å¤‡ç±»å‹
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒå±å¹•å…±äº«
        const isScreenShareSupported = navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia;
        
        // è§†é¢‘æ§åˆ¶æŒ‰é’®äº‹ä»¶ç›‘å¬
        toggleVideoBtn.addEventListener('click', () => {
            if (callSystem) {
                callSystem.toggleVideo();
            }
        });

        toggleAudioBtn.addEventListener('click', () => {
            if (callSystem) {
                callSystem.toggleAudio();
            }
        });

        // åˆ‡æ¢æ‘„åƒå¤´æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
        const switchCameraBtn = document.getElementById('switchCameraBtn');
        switchCameraBtn.addEventListener('click', () => {
            if (callSystem) {
                callSystem.switchCamera();
            }
        });

        // å…±äº«å±å¹•æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
        const toggleScreenShareBtn = document.getElementById('toggleScreenShareBtn');
        
        // æ ¹æ®è®¾å¤‡ç±»å‹å’Œæµè§ˆå™¨æ”¯æŒæƒ…å†µï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºå…±äº«å±å¹•æŒ‰é’®
        if (isMobile && !isScreenShareSupported) {
            console.log('å½“å‰è®¾å¤‡ä¸æ”¯æŒå±å¹•å…±äº«ï¼Œéšè—å…±äº«å±å¹•æŒ‰é’®');
            toggleScreenShareBtn.style.display = 'none';
        } else {
            toggleScreenShareBtn.addEventListener('click', () => {
                if (callSystem) {
                    if (callSystem.isSharingScreen) {
                        callSystem.stopScreenSharing();
                    } else {
                        callSystem.startScreenSharing();
                    }
                }
            });
        }

        endCallBtn.addEventListener('click', () => {
            if (callSystem) {
                callSystem.endCall();
            }
        });
        
        // è®¾ç½®æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
        const callSettingsBtn = document.getElementById('callSettingsBtn');
        callSettingsBtn.addEventListener('click', () => {
            // æ‰“å¼€è®¾ç½®æ¨¡æ€æ¡†
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal) {
                settingsModal.classList.add('active');
                
                // ç¡®ä¿é€šè¯è®¾ç½®æ ‡ç­¾é¡µå­˜åœ¨
                const callSettingsTab = document.querySelector('.admin-tab[data-tab="call"]');
                if (callSettingsTab) {
                    // åˆ‡æ¢åˆ°é€šè¯è®¾ç½®æ ‡ç­¾é¡µ
                    callSettingsTab.click();
                }
            }
        });
        
        // åŒå‡»è§†é¢‘æ”¾å¤§åŠŸèƒ½
        function setupDoubleClickZoom() {
            const videoBoxes = document.querySelectorAll('.video-box');
            
            videoBoxes.forEach(box => {
                // ç›´æ¥åœ¨è§†é¢‘å…ƒç´ ä¸Šæ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼Œé˜²æ­¢æµè§ˆå™¨æ‹¦æˆª
                const video = box.querySelector('video');
                if (video) {
                    video.addEventListener('dblclick', (e) => {
                        // é˜»æ­¢æµè§ˆå™¨é»˜è®¤çš„è§†é¢‘åŒå‡»è¡Œä¸ºï¼ˆå¦‚å…¨å±ï¼‰
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // åˆ‡æ¢å…¨å±çŠ¶æ€
                        box.classList.toggle('fullscreen');
                        
                        // å¦‚æœå½“å‰è§†é¢‘æ¡†è¢«æ”¾å¤§ï¼Œå°†å…¶ä»–è§†é¢‘æ¡†éšè—
                        if (box.classList.contains('fullscreen')) {
                            videoBoxes.forEach(otherBox => {
                                if (otherBox !== box) {
                                    otherBox.style.display = 'none';
                                }
                            });
                        } else {
                            // å¦‚æœå½“å‰è§†é¢‘æ¡†æ¢å¤æ­£å¸¸ï¼Œæ˜¾ç¤ºæ‰€æœ‰è§†é¢‘æ¡†
                            videoBoxes.forEach(otherBox => {
                                otherBox.style.display = 'block';
                            });
                        }
                    });
                }
                
                // åŒæ—¶ä¿ç•™åœ¨video-boxä¸Šçš„äº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿åŒå‡»ç©ºç™½åŒºåŸŸä¹Ÿèƒ½æ”¾å¤§
                box.addEventListener('dblclick', (e) => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯videoå…ƒç´ ï¼Œäº‹ä»¶å·²ç»è¢«å¤„ç†ï¼Œè¿™é‡Œä¸å†å¤„ç†
                    if (e.target.tagName === 'VIDEO') {
                        return;
                    }
                    
                    // åˆ‡æ¢å…¨å±çŠ¶æ€
                    box.classList.toggle('fullscreen');
                    
                    // å¦‚æœå½“å‰è§†é¢‘æ¡†è¢«æ”¾å¤§ï¼Œå°†å…¶ä»–è§†é¢‘æ¡†éšè—
                    if (box.classList.contains('fullscreen')) {
                        videoBoxes.forEach(otherBox => {
                            if (otherBox !== box) {
                                otherBox.style.display = 'none';
                            }
                        });
                    } else {
                        // å¦‚æœå½“å‰è§†é¢‘æ¡†æ¢å¤æ­£å¸¸ï¼Œæ˜¾ç¤ºæ‰€æœ‰è§†é¢‘æ¡†
                        videoBoxes.forEach(otherBox => {
                            otherBox.style.display = 'block';
                        });
                    }
                });
            });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–åŒå‡»æ”¾å¤§åŠŸèƒ½
        document.addEventListener('DOMContentLoaded', () => {
            setupDoubleClickZoom();
        });
        
        // ç›‘å¬è§†é¢‘å®¹å™¨æ˜¾ç¤ºäº‹ä»¶ï¼Œç¡®ä¿åŒå‡»æ”¾å¤§åŠŸèƒ½åœ¨è§†é¢‘æ˜¾ç¤ºæ—¶å¯ç”¨
        const observer = new MutationObserver((mutations) => {
            mutations.forEach(mutation => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    if (videoContainer.classList.contains('active')) {
                        // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿è§†é¢‘å…ƒç´ å·²åŠ è½½
                        setTimeout(setupDoubleClickZoom, 100);
                    }
                }
            });
        });
        
        observer.observe(videoContainer, { attributes: true });
        
        // æ˜¾ç¤ºè®¾å¤‡é€‰æ‹©æ¨¡æ€æ¡†
        async function showDeviceSelectModal() {
            // å¦‚æœæ¨¡æ€æ¡†å·²ç»æ‰“å¼€ï¼Œä¸é‡å¤æ˜¾ç¤º
            if (isDeviceSelectModalOpen) {
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            isDeviceSelectModalOpen = true;
            deviceSelectContent.innerHTML = '<div style="text-align: center; padding: 20px;">æ­£åœ¨è·å–è®¾å¤‡åˆ—è¡¨...</div>';
            deviceSelectModal.classList.add('active');
            
            try {
                // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
                if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                    throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåª’ä½“è®¾å¤‡è®¿é—®');
                }
                
                // è·å–å¯ç”¨è®¾å¤‡åˆ—è¡¨
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');
                const audioDevices = devices.filter(device => device.kind === 'audioinput');
                
                // åˆå§‹åŒ–å…¨å±€å˜é‡
                window.availableVideoDevices = videoDevices;
                window.availableAudioDevices = audioDevices;
                
                // åˆå§‹åŒ–é€‰ä¸­çš„è®¾å¤‡ID
                window.selectedVideoDeviceId = videoDevices.length > 0 ? videoDevices[0].deviceId : null;
                window.selectedAudioDeviceId = audioDevices.length > 0 ? audioDevices[0].deviceId : null;
                
                // æ¸…ç©ºå†…å®¹å¹¶é‡æ–°å¼€å§‹æ„å»ºUI
                deviceSelectContent.innerHTML = '';
                
                // æ·»åŠ æœç´¢æ¡†
                const searchInput = document.createElement('input');
                searchInput.type = 'text';
                searchInput.placeholder = 'æœç´¢è®¾å¤‡...';
                searchInput.style.width = '100%';
                searchInput.style.padding = '10px';
                searchInput.style.marginBottom = '15px';
                searchInput.style.border = '1px solid #dee2e6';
                searchInput.style.borderRadius = '5px';
                searchInput.addEventListener('input', (e) => {
                    filterDeviceList(e.target.value);
                });
                
                deviceSelectContent.appendChild(searchInput);
                
                // æ·»åŠ è§†é¢‘è®¾å¤‡é€‰æ‹©
                if (videoDevices.length > 0) {
                    const videoSection = document.createElement('div');
                    videoSection.innerHTML = '<h4 style="margin-bottom: 10px;">é€‰æ‹©æ‘„åƒå¤´:</h4>';
                    
                    videoDevices.forEach((device, index) => {
                        const deviceDiv = document.createElement('div');
                        deviceDiv.style.display = 'flex';
                        deviceDiv.style.alignItems = 'center';
                        deviceDiv.style.padding = '10px';
                        deviceDiv.style.marginBottom = '5px';
                        deviceDiv.style.border = '1px solid #e9ecef';
                        deviceDiv.style.borderRadius = '5px';
                        deviceDiv.style.cursor = 'pointer';
                        deviceDiv.dataset.deviceId = device.deviceId;
                        deviceDiv.dataset.deviceType = 'video';
                        
                        const deviceLabel = device.label || `æ‘„åƒå¤´ ${index + 1}`;
                        
                        deviceDiv.innerHTML = `
                            <input type="radio" name="videoDevice" value="${device.deviceId}" ${device.deviceId === selectedVideoDeviceId ? 'checked' : ''}>
                            <span style="margin-left: 10px;">${escapeHtml(deviceLabel)}</span>
                        `;
                        
                        deviceDiv.addEventListener('click', () => {
                            selectedVideoDeviceId = device.deviceId;
                            document.querySelectorAll('input[name="videoDevice"]').forEach(input => {
                                input.checked = input.value === device.deviceId;
                            });
                        });
                        
                        videoSection.appendChild(deviceDiv);
                    });
                    
                    deviceSelectContent.appendChild(videoSection);
                } else {
                    const noVideoDevicesDiv = document.createElement('div');
                    noVideoDevicesDiv.innerHTML = '<h4 style="margin-bottom: 10px;">é€‰æ‹©æ‘„åƒå¤´:</h4>';
                    noVideoDevicesDiv.innerHTML += '<div style="color: #6c757d; margin-bottom: 15px;">æœªæ£€æµ‹åˆ°æ‘„åƒå¤´è®¾å¤‡</div>';
                    deviceSelectContent.appendChild(noVideoDevicesDiv);
                }
                
                // æ·»åŠ éŸ³é¢‘è®¾å¤‡é€‰æ‹©
                if (audioDevices.length > 0) {
                    const audioSection = document.createElement('div');
                    audioSection.innerHTML = '<h4 style="margin-bottom: 10px;">é€‰æ‹©éº¦å…‹é£:</h4>';
                    
                    audioDevices.forEach((device, index) => {
                        const deviceDiv = document.createElement('div');
                        deviceDiv.style.display = 'flex';
                        deviceDiv.style.alignItems = 'center';
                        deviceDiv.style.padding = '10px';
                        deviceDiv.style.marginBottom = '5px';
                        deviceDiv.style.border = '1px solid #e9ecef';
                        deviceDiv.style.borderRadius = '5px';
                        deviceDiv.style.cursor = 'pointer';
                        deviceDiv.dataset.deviceId = device.deviceId;
                        deviceDiv.dataset.deviceType = 'audio';
                        
                        const deviceLabel = device.label || `éº¦å…‹é£ ${index + 1}`;
                        
                        deviceDiv.innerHTML = `
                            <input type="radio" name="audioDevice" value="${device.deviceId}" ${device.deviceId === selectedAudioDeviceId ? 'checked' : ''}>
                            <span style="margin-left: 10px;">${escapeHtml(deviceLabel)}</span>
                        `;
                        
                        deviceDiv.addEventListener('click', () => {
                            selectedAudioDeviceId = device.deviceId;
                            document.querySelectorAll('input[name="audioDevice"]').forEach(input => {
                                input.checked = input.value === device.deviceId;
                            });
                        });
                        
                        audioSection.appendChild(deviceDiv);
                    });
                    
                    deviceSelectContent.appendChild(audioSection);
                } else {
                    const noAudioDevicesDiv = document.createElement('div');
                    noAudioDevicesDiv.innerHTML = '<h4 style="margin-bottom: 10px;">é€‰æ‹©éº¦å…‹é£:</h4>';
                    noAudioDevicesDiv.innerHTML += '<div style="color: #6c757d; margin-bottom: 15px;">æœªæ£€æµ‹åˆ°éº¦å…‹é£è®¾å¤‡</div>';
                    deviceSelectContent.appendChild(noAudioDevicesDiv);
                }
            } catch (error) {
                console.error('è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥:', error);
                deviceSelectContent.innerHTML = `<div style="color: #dc3545; text-align: center; padding: 20px;">è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // è¿‡æ»¤è®¾å¤‡åˆ—è¡¨
        function filterDeviceList(searchTerm) {
            const deviceDivs = deviceSelectContent.querySelectorAll('[data-device-type]');
            
            deviceDivs.forEach(deviceDiv => {
                const deviceName = deviceDiv.querySelector('span').textContent.toLowerCase();
                const isVisible = deviceName.includes(searchTerm.toLowerCase());
                deviceDiv.style.display = isVisible ? 'flex' : 'none';
            });
        }
        
        // å…³é—­è®¾å¤‡é€‰æ‹©æ¨¡æ€æ¡†
        function closeDeviceSelectModal() {
            deviceSelectModal.classList.remove('active');
            isDeviceSelectModalOpen = false;
            pendingCallAction = null;
        }
        
        // ç¡®è®¤è®¾å¤‡é€‰æ‹©
        function confirmDeviceSelect() {
            if (pendingCallAction) {
                deviceSelectModal.classList.remove('active');
                isDeviceSelectModalOpen = false;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯æ¥å—é€šè¯çš„æƒ…å†µ
                if (pendingCallAction.isAcceptingCall) {
                    // ä½¿ç”¨é€‰æ‹©çš„è®¾å¤‡æ¥å—é€šè¯
                    if (pendingCallAction.type === 'video') {
                        acceptVideoCallWithDevice(selectedVideoDeviceId, selectedAudioDeviceId);
                    } else if (pendingCallAction.type === 'audio') {
                        acceptAudioCallWithDevice(selectedAudioDeviceId);
                    }
                } else {
                    // ä½¿ç”¨é€‰æ‹©çš„è®¾å¤‡å‘èµ·é€šè¯
                    if (pendingCallAction.type === 'video') {
                        startVideoCallWithDevice(pendingCallAction.targetSocketId, pendingCallAction.targetUsername, selectedVideoDeviceId);
                    } else if (pendingCallAction.type === 'audio') {
                        startAudioCallWithDevice(pendingCallAction.targetSocketId, pendingCallAction.targetUsername, selectedAudioDeviceId);
                    }
                }
            }
        }
        
        // ä½¿ç”¨æŒ‡å®šè®¾å¤‡æ¥å—è§†é¢‘é€šè¯
        async function acceptVideoCallWithDevice(videoDeviceId, audioDeviceId) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        deviceId: audioDeviceId,
                        echoCancellation: true,
                        noiseSuppression: true
                    },
                    video: {
                        deviceId: videoDeviceId,
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });
                
                localStream = stream;
                localVideo.srcObject = stream;
                
                // æ¥å—é€šè¯æ—¶ç«‹å³å¼€å§‹å½•åˆ¶å¹¶å‘é€æ•°æ®
                startMediaRecording(stream);
                
                // è®¾ç½®ç›®æ ‡Socket IDï¼Œç¡®ä¿èƒ½å‘é€æ•°æ®ç»™å¯¹æ–¹
                currentTargetSocketId = currentCallerSocketId;
                
                socket.emit('call-accept', {
                    callerSocketId: currentCallerSocketId,
                    callId: currentCallId
                });
                
                videoContainer.classList.add('active');
                addSystemMessage('é€šè¯å·²æ¥é€š');
            } catch (error) {
                console.error('è·å–åª’ä½“æµå¤±è´¥:', error);
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´/éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
            }
        }
        
        // ä½¿ç”¨æŒ‡å®šè®¾å¤‡æ¥å—è¯­éŸ³é€šè¯
        async function acceptAudioCallWithDevice(audioDeviceId) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        deviceId: audioDeviceId,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                localStream = stream;
                
                // ä¸è¦ç«‹å³å¼€å§‹å½•åˆ¶ï¼Œç­‰å¾…å¯¹æ–¹æ¥å—é€šè¯åå†å¼€å§‹
                // startMediaRecording(stream);
                
                // è®¾ç½®ç›®æ ‡Socket IDï¼Œç¡®ä¿èƒ½å‘é€æ•°æ®ç»™å¯¹æ–¹
                currentTargetSocketId = currentCallerSocketId;
                
                socket.emit('call-accept', {
                    callerSocketId: currentCallerSocketId,
                    callId: currentCallId
                });
                
                videoContainer.classList.add('active');
                addSystemMessage('é€šè¯å·²æ¥é€š');
            } catch (error) {
                console.error('è·å–åª’ä½“æµå¤±è´¥:', error);
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
            }
        }
        
        // ä½¿ç”¨æŒ‡å®šè®¾å¤‡å¼€å§‹è§†é¢‘é€šè¯
        async function startVideoCallWithDevice(targetSocketId, targetUsername, deviceId) {
            if (!userPermissions.allowCall) {
                alert('æ‚¨æ²¡æœ‰é€šè¯æƒé™');
                endCall();
                return;
            }
            
            isVideoCall = true;
            currentCallId = Date.now().toString();
            currentTargetSocketId = targetSocketId;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        deviceId: selectedAudioDeviceId,
                        echoCancellation: true,
                        noiseSuppression: true
                    },
                    video: {
                        deviceId: deviceId,
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    }
                });
                
                localStream = stream;
                localVideo.srcObject = stream;
                
                // ä¸è¦ç«‹å³å¼€å§‹å½•åˆ¶ï¼Œç­‰å¾…å¯¹æ–¹æ¥å—é€šè¯åå†å¼€å§‹
                // startMediaRecording(stream);
                
                socket.emit('call-request', {
                    targetSocketId: targetSocketId,
                    callId: currentCallId,
                    type: 'video',
                    fromUsername: username
                });
                
                videoContainer.classList.add('active');
                addSystemMessage(`æ­£åœ¨å‘ ${targetUsername} å‘èµ·è§†é¢‘é€šè¯...`);
            } catch (error) {
                console.error('è·å–æ‘„åƒå¤´å¤±è´¥:', error);
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
            }
        }
        
        // ä½¿ç”¨æŒ‡å®šè®¾å¤‡å¼€å§‹è¯­éŸ³é€šè¯
        async function startAudioCallWithDevice(targetSocketId, targetUsername, deviceId) {
            if (!userPermissions.allowCall) {
                alert('æ‚¨æ²¡æœ‰é€šè¯æƒé™');
                endCall();
                return;
            }
            
            isVideoCall = false;
            currentCallId = Date.now().toString();
            currentTargetSocketId = targetSocketId;
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        deviceId: deviceId,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                localStream = stream;
                
                // ä¸è¦ç«‹å³å¼€å§‹å½•åˆ¶ï¼Œç­‰å¾…å¯¹æ–¹æ¥å—é€šè¯åå†å¼€å§‹
                // startMediaRecording(stream);
                
                socket.emit('call-request', {
                    targetSocketId: targetSocketId,
                    callId: currentCallId,
                    type: 'audio',
                    fromUsername: username
                });
                
                videoContainer.classList.add('active');
                addSystemMessage(`æ­£åœ¨å‘ ${targetUsername} å‘èµ·è¯­éŸ³é€šè¯...`);
            } catch (error) {
                console.error('è·å–éº¦å…‹é£å¤±è´¥:', error);
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
            }
        }
    </script>
</body>
</html>
